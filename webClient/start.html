<!DOCTYPE HTML>
<html>
	<head>
		<meta charset="utf-8">
		<meta name = "viewport" content = "user-scalable=no, initial-scale=1, maximum-scale=1,  width=device-width" />
		<title>untitled</title>

		<style>
			body, html  {
  margin: 0;
  padding: 0;
}
		
			#app {
				position: absolute;
				left: 0px;
				top: 0px;
				bottom: 32px;
			}

			.draw_panel {
			}
			
			div.nav {
				position: absolute;
				background: black;
				width: 100%;
				bottom: 0px;
			}
			

div.nav{
font-family:Arial, Helvetica, sans-serif;
font-size:12px;
width:100%;
margin-bottom: 0px;
}

div.nav ul{

list-style:none;
background:#2d2d2d;
margin:0;
padding:0;
}

div.nav li{
display:inline-block;
float:left;
}

div.nav li:first-child{
margin-left:5px;
}

div.nav a{
display:block;
padding:10px;
text-decoration:none;
color:#bbbbbb;
border-top:2px solid transparent;
}

div.nav a:hover,
div.nav li.active a{
background:#3d3d3d;
color:#dddddd;
border-top:2px solid #ff4800;
}

.clearFloat{
clear:both;
}


			
		</style>

		<!-- CWT -->
		<script src="../game-engine/main.js" type="text/javascript"></script>
		<script src="../game-engine/sheets.js" type="text/javascript"></script>
		<script src="../game-engine/map.js" type="text/javascript"></script>
		<script src="../game-engine/move.js" type="text/javascript"></script>
		<script src="../game-engine/relationship.js" type="text/javascript"></script>

		<!-- CWT WC -->
		<script src="hammer.js" type="text/javascript"></script>
		<script src="stacktrace.js" type="text/javascript"></script>
		<script src="cwtwc.js" type="text/javascript"></script>

		<script type="text/javascript">
			var touchMove = function(event) {
				// Prevent scrolling on this element
				event.preventDefault();
			}

			window.onerror = function( e ){ alert(e); }

			// SIMPLE TEST MAP
			var testMap = {

				height: 99,
				width: 99,
				filler: "PLAIN",

				players:[
					{ gold:1000 , team:1 },
					{ gold:0    , team:2 }
				],

				data:{
					"0":{ "4":"FOREST",
								"5":"HQ", 
								"6":"FACTORY",
								"7":"MOUNTAINT" },
					"1":{ "4":"FOREST",
								"5":"FACTORY",
								"6":"FOREST",
								"7":"FOREST" },
					"2":{ "3":"FOREST",
								"4":"MOUNTAIN",
								"7":"FOREST" },
					"8":{ "7":"HQ",
								"8":"MOUNTAIN" },
					"9":{ "5":"FACTORY", 
								"6":"FACTORY",
								"7":"MOUNTAIN",
								"8":"FOREST" }
				},

				properties:[
					{ x:0, y:5, capturePoints:20, owner:0 },
					{ x:0, y:6, capturePoints:20, owner:0 },
					{ x:1, y:5, capturePoints:20, owner:0 },
					{ x:8, y:7, capturePoints:20, owner:1 },
					{ x:9, y:5, capturePoints:20, owner:1 },
					{ x:9, y:6, capturePoints:20, owner:1 }
				],

				units:[
					{ x:2, y:2, type:"INFANTRY" , owner:0 },
					{ x:8, y:5, type:"TANK" , owner:0 },
					{ x:7, y:8, type:"INFANTRY" , owner:0 },
					{ x:6, y:9, type:"TANK" , owner:0 },
					{ x:6, y:10, type:"INFANTRY" , owner:0 },
					{ x:3, y:14, type:"INFANTRY" , owner:0 },
					{ x:9, y:7, type:"TANK"      , owner:0 },
					{ x:9, y:9, type:"MECH"     , owner:1 },
					{ x:6, y:6, type:"ARTILLERY", owner:1 }
				]
			};

			var fps = 0, now, lastUpdate = (new Date)*1 - 1;
			// The higher this value, the less the FPS will be affected by quick changes
			// Setting this to 1 will show you the FPS of the last sampled frame only
			var fpsFilter = 50;
			var fpsOut;
			
			function start(){
				fpsOut = document.getElementById('fps');
				cwt.map.loadMap( testMap );
				
				document.getElementById("cwt_maplayer").height = window.innerHeight - 32;
				document.getElementById("cwt_maplayer").width = window.innerWidth;
		// populate some random data
		var keys = ["PLAIN","PLAIN","PLAIN","PLAIN","PLAIN","FOREST","MOUNTAIN"];
		for(var y=0,ye=cwt.map._height; y<=ye; y++){
			for(var x=0,xe=cwt.map._width; x<=xe; x++){

				if( cwt.map._map[x][y] === "PLAIN" ){ 
					var i = parseInt( keys.length*Math.random() , 10);
					cwt.map._map[x][y] = keys[ i ];
				}
			}
		}

				var hammer = new Hammer( document.getElementById("app") , {
					prevent_default: true
				});
				hammer.ondragend = function(ev){ 
					var a = ev.angle;
					var d = 0;
							 if( a >= -135 && a < -45 ) d = 0;
					else if( a >= -45 && a < 45 ) d = 1;
					else if( a >= 45 && a < 135 ) d = 2;
					else if( a >= 135 ||Â a < -135 ) d = 3;

					var dis = parseInt( ev.distance/32, 10 );
					if( dis === 0 ) dis = 1; 
					cwtwc.mapShift( d, dis );
				};

				cwtwc.initialize();

				// call draw
				draw();
			}

	  function keyShift( event ){
		switch( event.keyCode ){

		  case 37:
			cwtwc.mapShift( 3, 1 );
			break;
		  case 38:
			cwtwc.mapShift( 0, 1 );
			break;
		  case 39:
			cwtwc.mapShift( 1, 1 );
			break;
		  case 40:
			cwtwc.mapShift( 2, 1 );
			break;

		}
	  }

			var mDiff = 250;
			var cDiff = 0;
			function draw(){
				if( cwtwc.terrain.complete ){
				cwtwc.drawScreen();

				var diff = ((now=new Date) - lastUpdate);
				var thisFrameFPS = 1000 / diff;
				fps += (thisFrameFPS - fps) / fpsFilter;
				lastUpdate = now * 1 - 1;
				fpsOut.innerHTML = fps.toFixed(1) + "fps";

				cDiff += diff;
				if( cDiff >= mDiff ){
					cDiff = 0;
					cwtwc.animStep++;
					if( cwtwc.animStep >= 3 ) cwtwc.animStep = 0;
				}
				
				}

				// better than intervall because intervall slows down if the draw routine needs
				// longer to finish than the set interval. This can be better controlled later to 
				// get a stable fps.
				setTimeout(draw, 16-diff); //TODO do a better fps management here!
			}
		</script>
	</head>

	<body onLoad="start();" onkeyup="keyShift(event)">
	<div id="app">
		<div id="fps" style="position: absolute;" ></div>
		<canvas id="cwt_maplayer" class="draw_panel" >
			Fallback-Inhalt MAP
		</canvas>
	</div>
	
	<div class="nav">
		<ul>
			<li><a href="#">Map</a></li>
			<li><a href="#">Build</a></li>
			<li><a href="#">Statistics</a></li>
			<div class="clearFloat"></div>
		</ul>
	</div>
	</body>
</html>