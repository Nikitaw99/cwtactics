const CLIENT_DEBUG=!0;controller._soundContext=null,window.addEventListener("load",function(){try{controller.context=new webkitAudioContext}catch(e){util.logWarn("Web Audio API is not supported in this browser")}},!1),controller._sounds={},controller._enabled=!1,controller.enable=function(){controller._enabled===!1&&(controller._enabled=!0)},controller.loadSound=function(e,t){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){controller._soundContext.decodeAudioData(o.response,function(t){controller._sounds[e]=t},null)},util.logInfo("try to load sound");try{o.send()}catch(r){util.logWarn("could not load sound"),controller._enabled=-1}},controller.playMusic=function(){},controller.playSfx=function(e){if(controller._enabled===!0){var t=controller._sounds[e],o=controller._soundContext.createBufferSource();o.buffer=t,o.connect(controller._soundContext.destination),o.noteOn(0)}},controller.mapCursorX=0,controller.mapCursorY=0,controller.menuCursorIndex=-1,controller.resetMenuCursor=function(){controller.menuCursorIndex=0},controller.increaseMenuCursor=function(){controller.menuCursorIndex++},controller.decreaseMenuCursor=function(){controller.menuCursorIndex--,0>controller.menuCursorIndex&&(controller.menuCursorIndex=0)},controller.resetMapCursor=function(){controller.mapCursorX=0,controller.mapCursorY=0},controller.cursorAction=function(e){if(null===controller.currentAnimatedKey){var t=controller.input.state(),o="MOVEPATH_SELECTION"===t||"ACTION_SELECT_TARGET"===t;e?controller.input.event("cancel"):-1!==controller.menuCursorIndex?controller.input.event("action",controller.menuCursorIndex):controller.input.event("action",controller.mapCursorX,controller.mapCursorY);var r=controller.input.state(),n="MOVEPATH_SELECTION"===r||"ACTION_SELECT_TARGET"===r;if((o&&!n||n)&&view.markSelectionMapForRedraw(controller.input.selectionData),"ACTION_MENU"===r||"ACTION_SUBMENU"===r){var i=controller.input.menu;if("unloadUnit"===controller.input.actionData.getAction()){var a=i;i=[];for(var l=0,c=controller.input.menuSize;c>l;l++)i[l]=model.units[a[l]].type}controller.showMenu(i,controller.input.menuSize,controller.mapCursorX,controller.mapCursorY)}else controller.hideMenu()}},controller.cursorActionCancel=function(){controller.cursorAction(!0)},controller.cursorActionClick=function(){controller.cursorAction(!1)},controller.moveCursor=function(e,t){1===arguments.length&&(t=1);var o=controller.mapCursorX,r=controller.mapCursorY;switch(e){case model.MOVE_CODE_UP:r--;break;case model.MOVE_CODE_RIGHT:o++;break;case model.MOVE_CODE_DOWN:r++;break;case model.MOVE_CODE_LEFT:o--}controller.setCursorPosition(o,r)},controller.setCursorPosition=function(e,t,o){if(o&&(e+=controller.screenX,t+=controller.screenY),model.isValidPosition(e,t)&&(e!==controller.mapCursorX||t!==controller.mapCursorY)){view.markForRedraw(controller.mapCursorX,controller.mapCursorY),controller.mapCursorX=e,controller.mapCursorY=t;var r=parseInt(parseInt(window.innerWidth/16,10)/controller.screenScale,10),n=parseInt(parseInt(window.innerHeight/16,10)/controller.screenScale,10),i=-1;1>=e-controller.screenX?i=model.MOVE_CODE_LEFT:e-controller.screenX>=r-1?i=model.MOVE_CODE_RIGHT:1>=t-controller.screenY?i=model.MOVE_CODE_UP:t-controller.screenY>=n-1&&(i=model.MOVE_CODE_DOWN),-1!==i&&controller.shiftScreenPosition(i,5);var a=e+controller.screenX>=r/2;view.updateTileInfo(a),view.updatePlayerInfo(a),util.logInfo("set cursor position to",e,t,"screen node is at",controller.screenX,controller.screenY,"screen size is",r,n),view.markForRedraw(e,t)}},controller.currentAnimatedKey=null,controller.currentAnimatedKeyNext=null,controller.noRendering=!0,controller.lockCommandEvaluation=!1,controller.gameLoop=function(e){var t=0!==controller.moveScreenX||0!==controller.moveScreenY,o=controller.updateTurnTimer(e);if(o){var r=controller.aquireActionDataObject();r.setAction("nextTurn"),controller.pushActionDataIntoBuffer(r)}if(t)controller.solveMapShift();else{if(null===controller.currentAnimatedKey){if(controller.lockCommandEvaluation===!1&&!controller.isBufferEmpty()){var r=controller.evalNextMessageFromBuffer();if(null!==r){var n=r.getAction(),i=r.getMovePath();if(null!==i&&i.length>0){var a=view.getCommandHook("move");controller.currentAnimatedKey=a,a.prepare(r),util.logInfo("preparing command animation for",a.key)}var l=view.getCommandHook(n);null!==l&&(l.prepare(r),controller.currentAnimatedKeyNext=l,util.logInfo("preparing command animation for",l.key)),null===controller.currentAnimatedKey&&null!==controller.currentAnimatedKeyNext&&(controller.currentAnimatedKey=controller.currentAnimatedKeyNext,controller.currentAnimatedKeyNext=null),controller.releaseActionDataObject(r)}}}else controller.currentAnimatedKey.update(e);view.updateSpriteAnimations(e)}!controller.noRendering&&view.drawScreenChanges>0&&view.renderMap(controller.screenScale),controller.noRendering||t||null!==controller.currentAnimatedKey&&(controller.currentAnimatedKey.isDone()?(util.logInfo("completed command animation for",controller.currentAnimatedKey.key),controller.currentAnimatedKey=null,null!==controller.currentAnimatedKeyNext&&(controller.currentAnimatedKey=controller.currentAnimatedKeyNext,controller.currentAnimatedKeyNext=null)):controller.currentAnimatedKey.render())},controller.enterGameLoop=function(){function e(){requestAnimationFrame(e);var i=(new Date).getTime(),a=i-n;n=i;var l=1e3/((i=new Date)-o);isNaN(l)||(t+=(l-t)/r),o=i,controller.gameLoop(a)}util.logInfo("enter game loop");var t=0,o=1*new Date-1,r=50,n=(new Date).getTime(),i=document.getElementById("fps");setInterval(function(){i.innerHTML=CWT_VERSION+" "+t.toFixed(1)+"fps"},1e3),controller.input.event("start"),view.fitScreenToDeviceOrientation(),window.requestAnimationFrame(e)},controller.menuPosX=-1,controller.menuPosY=-1,controller.menuElement=document.getElementById("cwt_menu"),controller.menuEntryListElement=document.getElementById("cwt_menu_entries"),controller._connectMenuListener=function(e,t){e.onclick=function(){util.logInfo("menu element",t,"will be triggered"),controller.menuCursorIndex=t,controller.cursorActionClick()},e.onmouseover=function(){}},controller.showMenu=function(e,t,o,r){util.logInfo("opening GUI menu");var n=TILE_LENGTH*controller.screenScale;if(1===arguments.length&&(o=controller.menuPosX,r=controller.menuPosY),!model.isValidPosition(o,r))throw Error("invalid menu position");for(var i=controller.menuEntryListElement.children,a=0,l=i.length;l>a;a++)i[a].style.display="none";for(var a=0,l=t;l>a;a++){var c;if(i.length>a)c=i[a].children[0];else{c=document.createElement("button"),controller._connectMenuListener(c,a);var u=document.createElement("li");u.appendChild(c),controller.menuEntryListElement.appendChild(u)}c.innerHTML=util.i18n_localized(e[a]),i[a].style.display=""}o-=controller.screenX,r-=controller.screenY;var s=parseInt(150/n,10),m=parseInt(160/n,10);r>controller.screenHeight-s&&(r-=parseInt(160/n,10)),o>controller.screenWidth-m&&(o-=parseInt(150/n,10)),controller.menuPosX=o,controller.menuPosY=r,controller.menuCursorIndex=0;var d=controller.menuElement.style;d.top=r*n+"px",d.left=o*n+"px",d.zIndex=2e3,d.display="block"},controller.hideMenu=function(){util.logInfo("closing GUI menu"),controller.menuElement.style.display="none",controller.menuCursorIndex=-1},controller.generateMovePath=function(){return[]},controller.appendToPath=function(e){return e},controller.screenElement=document.getElementById("cwt_canvas"),controller.screenX=0,controller.screenY=0,controller.screenWidth=-1,controller.screenHeight=-1,controller.screenScale=1,controller.moveScreenX=0,controller.moveScreenY=0,controller._transEndEventNames={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",msTransition:"MSTransitionEnd",transition:"transitionend"},controller.setScreenScale=function(e){1!==e&&2!==e&&3!==e&&util.illegalArgumentError(),controller.screenScale=e,controller.screenElement.className=1===e?"":"scale"+e;var t=TILE_LENGTH*e;controller.screenWidth=parseInt(window.innerWidth/t,10),controller.screenHeight=parseInt(window.innerHeight/t,10),controller.setScreenPosition(controller.screenX,controller.screenY,!1)},controller.setScreenPosition=function(e,t){controller.screenX=e,controller.screenY=t;var o=controller.screenElement.style,r=controller.screenScale,n=-(controller.screenX*TILE_LENGTH*r),i=-(controller.screenY*TILE_LENGTH*r);switch(r){case 2:n+=controller.screenElement.width/2,i+=controller.screenElement.height/2;break;case 3:n+=controller.screenElement.width,i+=controller.screenElement.height}o.position="absolute",o.left=n+"px",o.top=i+"px"},controller.shiftScreenPosition=function(e,t){1===arguments.length&&(t=1);var o=controller.screenX,r=controller.screenY;switch(e){case model.MOVE_CODE_DOWN:r+=t;break;case model.MOVE_CODE_RIGHT:o+=t;break;case model.MOVE_CODE_UP:r-=t;break;case model.MOVE_CODE_LEFT:o-=t}0>o&&(o=0),0>r&&(r=0),o>=model.mapWidth&&(o=model.mapWidth-1),r>=model.mapHeight&&(r=model.mapHeight-1),controller.setScreenPosition(o,r,!1)};const STORAGE_SIZE=25;controller.storage={get:function(e){var t=localStorage.getItem(e);return null!==t?JSON.parse(t):null},has:function(e){return null!==localStorage.getItem(e)},clear:function(){localStorage.clear()},remove:function(e){localStorage.removeItem(e)},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))}},controller._turnTimerTime=0,controller.resetTurnTimer=function(){controller._turnTimerTime=0},controller.updateTurnTimer=function(e){return controller._turnTimerTime>=0&&model.rules.turnTimeLimit>0&&(controller._turnTimerTime+=e,controller._turnTimerTime>model.rules.turnTimeLimit)?(controller._turnTimerTime=-1,!0):!1},controller.updateUnitStats=function(e){var t=model.sheets.unitSheets[e.type],o=e.fuel,r=t.maxFuel;e._clientData_.lowFuel=parseInt(.25*r,10)>o?!0:!1;var n=e.ammo,i=t.maxAmmo;e._clientData_.lowAmmo=parseInt(.25*i,10)>=n?!0:!1,0===i&&(e._clientData_.lowAmmo=!1);var a=null;if(90>=e.hp&&(a=e.hp>80?view.getInfoImageForType("HP_9"):e.hp>70?view.getInfoImageForType("HP_8"):e.hp>60?view.getInfoImageForType("HP_7"):e.hp>50?view.getInfoImageForType("HP_6"):e.hp>40?view.getInfoImageForType("HP_5"):e.hp>30?view.getInfoImageForType("HP_4"):e.hp>20?view.getInfoImageForType("HP_3"):e.hp>10?view.getInfoImageForType("HP_2"):view.getInfoImageForType("HP_1")),e._clientData_.hpPic=a,e._clientData_.hasLoads=model.hasLoadedIds(model.extractUnitId(e))?!0:!1,e.x>-1){var l=model.propertyPosMap[e.x][e.y];null!==l&&t.captures>0&&(e._clientData_.captures=20>l.capturePoints?!0:!1)}},view._animCommands={},view.registerCommandHook=function(e){view._animCommands[e.key]=e,e.isEnabled=!0},view.getCommandHook=function(e){var t=view._animCommands[e];return void 0!==t?t:null},view.IMAGE_CODE_IDLE="IDLE",view.IMAGE_CODE_IDLE_INVERTED="IDLE_R",view.IMAGE_CODE_RIGHT="RIGHT",view.IMAGE_CODE_LEFT="LEFT",view.IMAGE_CODE_UP="UP",view.IMAGE_CODE_DOWN="DOWN",view.IMAGE_CODE_STATELESS="STATELESS",view.COLOR_RED="RED",view.COLOR_GREEN="GREEN",view.COLOR_BLUE="BLUE",view.COLOR_YELLOW="YELLOW",view.COLOR_BLACK_MASK="BLACK_MASK",view.COLOR_NEUTRAL="GRAY",view.COLOR_NONE="NONE",view.IMG_COLOR_MAP_PROPERTIES_ID="IMG_MAP_PROPERTY",view.IMG_COLOR_MAP_UNITS_ID="IMG_MAP_UNIT",view.CodeStatelessview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{},NONE:{},GRAY:{}},view.CodeIdleview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeIdleInvertedview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeRightview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeLeftview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeUpview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeDownview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.setImageForType=function(e,t,o,r){switch(util.logInfo("registering image for type",t,"\n","state",o,"\n","color",r),void 0===o&&(o=view.IMAGE_CODE_STATELESS),void 0===r&&(r=view.COLOR_NONE),o){case view.IMAGE_CODE_IDLE:view.CodeIdleview[r][t]=e;break;case view.IMAGE_CODE_STATELESS:view.CodeStatelessview[r][t]=e;break;case view.IMAGE_CODE_IDLE_INVERTED:view.CodeIdleInvertedview[r][t]=e;break;case view.IMAGE_CODE_LEFT:view.CodeLeftview[r][t]=e;break;case view.IMAGE_CODE_RIGHT:view.CodeRightview[r][t]=e;break;case view.IMAGE_CODE_DOWN:view.CodeDownview[r][t]=e;break;case view.IMAGE_CODE_UP:view.CodeUpview[r][t]=e;break;default:util.logError("unknown image state code ",o)}},view.setUnitImageForType=view.setImageForType,view.setPropertyImageForType=function(e,t,o){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,o)},view.setTileImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.setInfoImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getImageForType=function(e,t,o){switch(t){case view.IMAGE_CODE_IDLE:return view.CodeIdleview[o][e];case view.IMAGE_CODE_IDLE_INVERTED:return view.CodeIdleInvertedview[o][e];case view.IMAGE_CODE_LEFT:return view.CodeLeftview[o][e];case view.IMAGE_CODE_RIGHT:return view.CodeRightview[o][e];case view.IMAGE_CODE_DOWN:return view.CodeDownview[o][e];case view.IMAGE_CODE_UP:return view.CodeUpview[o][e];case view.IMAGE_CODE_STATELESS:return view.CodeStatelessview[o][e];default:util.logError("unknown image state code ",t)}},view.getUnitImageForType=view.getImageForType,view.getPropertyImageForType=function(e,t){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,t)},view.getTileImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getInfoImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.ID_DIV_CWTWC_CURSORINFO="cwt_tile_inf",view.ID_CWTWC_CURSORINFO_IMG="tile_inf_pic",view.ID_CWTWC_CURSORINFO_TNAME="tile_inf_name",view.ID_CWTWC_CURSORINFO_TDEF="tile_inf_def",view.ID_CWTWC_CURSORINFO_UNAME="tile_inf_unitname",view.ID_CWTWC_CURSORINFO_HP="tile_inf_hp",view.ID_CWTWC_CURSORINFO_AMMO="tile_inf_ammo",view.ID_CWTWC_CURSORINFO_FUEL="tile_inf_fuel",view.ID_CWTWC_CURSORINFO_HP_DESC="tile_inf_hpDesc",view.ID_CWTWC_CURSORINFO_AMMO_DESC="tile_inf_ammoDesc",view.ID_CWTWC_CURSORINFO_FUEL_DESC="tile_inf_fuelDesc",view.ID_DIV_CWTWC_PLAYERINFO="cwt_player_inf",view.ID_CWTWC_PLAYERINFO_NAME="player_inf_name",view.ID_CWTWC_PLAYERINFO_GOLD="player_inf_gold",view.ID_CWTWC_PLAYERINFO_COS="player_inf_power",view.ID_CWTWC_PLAYERINFO_NUMPRO="player_inf_props",view.ID_CWTWC_PLAYERINFO_NUMUNI="player_inf_units",view.ID_DIV_CWTWC_MSG_PANEL="cwt_info_box",view.ID_DIV_CWTWC_MSG_PANEL_CONTENT="cwt_info_box_content",view.showInfoBlocks=function(){document.getElementById(view.ID_DIV_CWTWC_CURSORINFO).className="tooltip active",document.getElementById(view.ID_DIV_CWTWC_PLAYERINFO).className="tooltip active"},view.hideInfoBlocks=function(){document.getElementById(view.ID_DIV_CWTWC_CURSORINFO).className="tooltip out",document.getElementById(view.ID_DIV_CWTWC_PLAYERINFO).className="tooltip out"},view.updateTileInfo=function(e){var t=controller.mapCursorX,o=controller.mapCursorY;document.getElementById(view.ID_CWTWC_CURSORINFO_TNAME).innerHTML=model.map[t][o]+" V:"+model.fogData[t][o],document.getElementById(view.ID_CWTWC_CURSORINFO_TDEF).innerHTML=0;var r=model.unitPosMap[t][o];null!==r?(document.getElementById(view.ID_CWTWC_CURSORINFO_UNAME).innerHTML=r.type,document.getElementById(view.ID_CWTWC_CURSORINFO_HP).innerHTML=r.hp,document.getElementById(view.ID_CWTWC_CURSORINFO_AMMO).innerHTML=r.ammo,document.getElementById(view.ID_CWTWC_CURSORINFO_FUEL).innerHTML=r.fuel,document.getElementById(view.ID_CWTWC_CURSORINFO_HP_DESC).innerHTML="HP",document.getElementById(view.ID_CWTWC_CURSORINFO_AMMO_DESC).innerHTML="Ammo",document.getElementById(view.ID_CWTWC_CURSORINFO_FUEL_DESC).innerHTML="Fuel"):(document.getElementById(view.ID_CWTWC_CURSORINFO_UNAME).innerHTML="",document.getElementById(view.ID_CWTWC_CURSORINFO_HP).innerHTML="",document.getElementById(view.ID_CWTWC_CURSORINFO_AMMO).innerHTML="",document.getElementById(view.ID_CWTWC_CURSORINFO_FUEL).innerHTML="",document.getElementById(view.ID_CWTWC_CURSORINFO_HP_DESC).innerHTML="",document.getElementById(view.ID_CWTWC_CURSORINFO_AMMO_DESC).innerHTML="",document.getElementById(view.ID_CWTWC_CURSORINFO_FUEL_DESC).innerHTML="");var n=document.getElementById(view.ID_DIV_CWTWC_CURSORINFO);n.style.top=window.innerHeight-n.offsetHeight-15+"px",n.style.left=e?"10px":window.innerWidth-n.offsetWidth-10+"px"},view.updatePlayerInfo=function(e){var t=model.players[model.turnOwner];document.getElementById(view.ID_CWTWC_PLAYERINFO_NAME).innerHTML=t.name,document.getElementById(view.ID_CWTWC_PLAYERINFO_GOLD).innerHTML=t.gold,document.getElementById(view.ID_CWTWC_PLAYERINFO_COS).innerHTML=0,document.getElementById(view.ID_CWTWC_PLAYERINFO_NUMPRO).innerHTML=0,document.getElementById(view.ID_CWTWC_PLAYERINFO_NUMUNI).innerHTML=0;var o=document.getElementById(view.ID_DIV_CWTWC_PLAYERINFO);o.style.top="10px",o.style.left=e?"10px":window.innerWidth-o.offsetWidth-10+"px"},view.DEFAULT_MESSAGE_TIME=1e3,view._hideInfoMessage=function(){var e=document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL);e.className="tooltip out"},view.hasInfoMessage=function(){return"tooltip out"!==document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL).className},view.showInfoMessage=function(e,t){1===arguments.length&&(t=view.DEFAULT_MESSAGE_TIME);var o=document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL);document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL_CONTENT).innerHTML=e,o.className="tooltip active",o.style.position="absolute",o.style.left=parseInt(window.innerWidth/2-o.offsetWidth/2,10)+"px",o.style.top=parseInt(window.innerHeight/2-o.offsetHeight/2,10)+"px",setTimeout(view._hideInfoMessage,t)};const TILE_LENGTH=16;controller.baseSize=CWT_MOD_DEFAULT.graphic.baseSize,view.preventRenderUnit=null,view.canvasCtx=controller.screenElement.getContext("2d"),view.colorArray=[view.COLOR_RED,view.COLOR_BLUE,view.COLOR_GREEN,view.COLOR_YELLOW],view.renderMap=function(){var e=TILE_LENGTH,t=view.canvasCtx;controller.screenX,controller.screenY;for(var o,r,n,i,a,l,c,u,s,m,d,p=view.getSpriteStep("SELECTION"),_=view.getSpriteStep("UNIT"),E=view.getSpriteStep("PROPERTY"),g=view.getSpriteStep("STATUS"),f=controller.baseSize,I="MOVEPATH_SELECTION"===controller.input.state()||"ACTION_SELECT_TARGET"===controller.input.state(),v=model.mapHeight-1,h=0;v>=h;h++)for(var T=model.mapWidth-1,A=0;T>=A;A++)if(d=0===model.fogData[A][h],view.drawScreen[A][h]===!0){o=model.map[A][h],r=view.getTileImageForType(o),n=0,i=0,a=f,l=2*f,c=A*e,u=h*e-e,s=e,m=2*e,0>u&&(i+=f,l-=f,u+=e,m-=e),void 0!==r?t.drawImage(r,n,i,a,l,c,u,s,m):(t.fillStyle="rgb(0,0,255)",t.fillRect(c,u,e,e));var O=model.propertyPosMap[A][h];if(null!==O){var w;w=-1===O.owner?view.COLOR_NEUTRAL:view.colorArray[O.owner],d&&(w=view.COLOR_NEUTRAL),r=view.getPropertyImageForType(O.type,w),n=0+f*E,i=0,a=f,l=2*f,c=A*e,u=h*e-e,s=e,m=2*e,0>u&&(i+=f,l-=f,u+=e,m-=e),void 0!==r?(t.drawImage(r,n,i,a,l,c,u,s,m),d&&m>16&&null!==O&&(r=view.getPropertyImageForType(O.type,view.COLOR_BLACK_MASK),t.globalAlpha=.35,t.drawImage(r,n,i,a,l/2,c,u,s,m/2),t.globalAlpha=1)):(c=A*e,u=h*e,s=e,m=e,t.fillStyle="rgb(0,255,0)",t.fillRect(c,u,s,m))}if(d&&(c=A*e,u=h*e,s=e,m=e,t.globalAlpha=.2,t.fillStyle="black",t.fillRect(c,u,s,m),t.globalAlpha=1),I){r=view.getInfoImageForType("MOVEPATH_SELECTION"===controller.input.state()?"MOVE_FOC":"ATK_FOC");var C=controller.input.selectionData.getPositionValue(A,h);C>0&&(n=f*p,i=0,a=f,l=f,c=A*e,u=h*e,s=e,m=e,t.globalAlpha=.65,t.drawImage(r,n,i,a,l,c,u,s,m),t.globalAlpha=1)}var S=model.unitPosMap[A][h];if(!d&&null!==S&&S!==view.preventRenderUnit){var w;w=-1===S.owner?view.COLOR_NEUTRAL:view.colorArray[S.owner];var y=1===S.owner%2?view.IMAGE_CODE_IDLE:view.IMAGE_CODE_IDLE_INVERTED;if(r=view.getUnitImageForType(S.type,y,w),n=2*f*_,i=0,a=2*f,l=2*f,c=A*e-e/2,u=h*e-e/2,s=e+e,m=e+e,void 0!==r?(t.drawImage(r,n,i,a,l,c,u,s,m),S.owner!==model.turnOwner||model.canAct(model.extractUnitId(S))||(t.globalAlpha=.5,t.drawImage(view.getUnitImageForType(S.type,y,view.COLOR_BLACK_MASK),n,i,a,l,c,u,s,m),t.globalAlpha=1)):(c=A*e,u=h*e,s=e,m=e,t.fillStyle="rgb(255,0,0)",t.fillRect(c,u,s,m)),r=S._clientData_.hpPic,null!==r&&t.drawImage(r,c+e,u+e),0!==g&&1!==g&&4!==g&&5!==g&&8!==g&&9!==g&&12!==g&&13!==g){var D=parseInt(g/4,10);r=null;var R=D;do{if(0===R&&S._clientData_.lowAmmo?r=view.getInfoImageForType("SYM_AMMO"):1===R&&S._clientData_.lowFuel?r=view.getInfoImageForType("SYM_FUEL"):2===R&&S._clientData_.captures?r=view.getInfoImageForType("SYM_CAPTURE"):3===R&&S._clientData_.hasLoads&&(r=view.getInfoImageForType("SYM_LOAD")),null!==r)break;R++,4===R&&(R=0)}while(R!==D);null!==r&&t.drawImage(r,c+e/2,u+e)}}view.drawScreen[A][h]=!1}if("MOVEPATH_SELECTION"===controller.input.state())for(var N,P,M,L,U=controller.input.actionData,W=U.getMovePath(),F=U.getSourceX(),b=U.getSourceY(),k=0,H=W.length;H>k&&null!==W[k];k++){switch(N=F,P=b,W[k]){case model.MOVE_CODE_UP:b--;break;case model.MOVE_CODE_RIGHT:F++;break;case model.MOVE_CODE_DOWN:b++;break;case model.MOVE_CODE_LEFT:F--}if(k===H-1||null===W[k+1])M=-1,L=-1;else switch(W[k+1]){case model.MOVE_CODE_UP:M=F,L=b-1;break;case model.MOVE_CODE_RIGHT:M=F+1,L=b;break;case model.MOVE_CODE_DOWN:M=F,L=b+1;break;case model.MOVE_CODE_LEFT:M=F-1,L=b}if(-1==M)switch(W[k]){case model.MOVE_CODE_UP:r=view.getTileImageForType("ARROW_N");break;case model.MOVE_CODE_RIGHT:r=view.getTileImageForType("ARROW_E");break;case model.MOVE_CODE_DOWN:r=view.getTileImageForType("ARROW_S");break;case model.MOVE_CODE_LEFT:r=view.getTileImageForType("ARROW_W")}else{var Y=Math.abs(M-N),V=Math.abs(L-P);if(2===Y)r=view.getTileImageForType("ARROW_WE");else if(2===V)r=view.getTileImageForType("ARROW_NS");else if(F>M&&P>b||F>N&&L>b)r=view.getTileImageForType("ARROW_SW");else if(F>M&&b>P||F>N&&b>L)r=view.getTileImageForType("ARROW_WN");else if(M>F&&b>P||N>F&&b>L)r=view.getTileImageForType("ARROW_NE");else{if(!(M>F&&P>b||N>F&&L>b)){util.logError("illegal move arrow state","old (",N,",",P,")","current (",F,",",b,")","next (",M,",",L,")","path (",W,")");continue}r=view.getTileImageForType("ARROW_ES")}}F>=0&&b>=0&&controller.screenWidth>F&&controller.screenHeight>b&&t.drawImage(r,F*e,b*e)}t.lineWidth=2,t.strokeStyle="#f00",t.strokeRect(e*controller.mapCursorX+1,e*controller.mapCursorY+1,e-2,e-2),view.drawScreenChanges=0},view.fitScreenToDeviceOrientation=function(){var e=controller.screenElement;e.width=TILE_LENGTH*model.mapWidth,e.height=TILE_LENGTH*model.mapHeight,controller.screenWidth=parseInt(window.innerWidth/TILE_LENGTH,10),controller.screenHeight=parseInt(window.innerHeight/TILE_LENGTH,10)},view.OVERLAYER={MNTN:!0,FRST:!0},view.drawScreenChanges=0,view.drawScreen=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,!1),view.markForRedraw=function(e,t){if(e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t){if(view.drawScreen[e][t]===!0)return;view.drawScreen[e][t]=!0,view.drawScreenChanges++,t++,model.mapHeight>t&&(null!==model.propertyPosMap[e][t]?view.markForRedraw(e,t):view.OVERLAYER[model.map[e][t]]===!0&&view.markForRedraw(e,t))}else util.logError("illegal arguments ",e,",",t," -> out of view bounds")},view.markForRedrawRange=function(e,t,o){var r,n,i=t-o,a=t+o;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(r=e-o+l,n=e+o-l,0>r&&(r=0),n>=model.mapWidth&&(n=model.mapWidth-1);n>=r;r++)view.markForRedraw(r,i)}},view.markForRedrawWithNeighbours=function(e,t){t>0&&view.markForRedraw(e,t-1),e>0&&view.markForRedraw(e-1,t),view.markForRedraw(e,t),model.mapHeight-1>t&&view.markForRedraw(e,t+1),model.mapWidth-1>e&&view.markForRedraw(e+1,t)},view.markForRedrawWithNeighboursRing=function(e,t){var o=model.mapWidth,r=model.mapHeight;e>0&&(t>0&&view.markForRedraw(e-1,t-1),view.markForRedraw(e-1,t),r-1>t&&view.markForRedraw(e-1,t+1)),t>0&&view.markForRedraw(e,t-1),view.markForRedraw(e,t),r-1>t&&view.markForRedraw(e,t+1),o-1>e&&(t>0&&view.markForRedraw(e+1,t-1),view.markForRedraw(e+1,t),r-1>t&&view.markForRedraw(e+1,t+1))},view.completeRedraw=function(){view.drawScreenChanges=1;for(var e=0,t=model.mapWidth;t>e;e++)for(var o=0,r=model.mapHeight;r>o;o++)view.drawScreen[e][o]=!0},view.markSelectionMapForRedraw=function(e){for(var t=e.getCenterX(),o=e.getCenterY(),r=e.getDataMatrix(),n=0;r.length>n;n++)for(var i=r[n],a=0;i.length>a;a++)-1!==i[a]&&view.markForRedraw(t+n,o+a)},view.spriteAnimation={},view._spriteAnimators=[],view.registerSpriteAnimator=function(e,t,o,r){var n={};n._stps=t,n._tps=o,n._upt=r,n.step=0,n.time=0,view.spriteAnimation[e]=n,view._spriteAnimators.push(n)},view.getSpriteStep=function(e){return view.spriteAnimation[e].step},view.updateSpriteAnimations=function(e){for(var t=view._spriteAnimators,o=0,r=t.length;r>o;o++){var n=t[o];n.time+=e,n.time>=n._tps&&(n.time=0,n.step++,n.step>=n._stps&&(n.step=0),n._upt())}},view.registerSpriteAnimator("SELECTION",7,150,function(){if("MOVEPATH_SELECTION"===controller.input.state()||"ACTION_SELECT_TARGET"===controller.input.state())for(var e=0,t=0,o=model.mapWidth,r=model.mapHeight,n=controller.input.selectionData;o>e;e++)for(var i=t;r>i;i++)n.getPositionValue(e,i)>-1&&view.markForRedraw(e,i)}),view.registerSpriteAnimator("STATUS",16,375,function(){}),view.registerSpriteAnimator("UNIT",3,250,function(){for(var e=0,t=0,o=model.mapWidth,r=model.mapHeight;o>e;e++)for(var n=t;r>n;n++)null!==model.unitPosMap[e][n]&&view.markForRedrawWithNeighbours(e,n)}),view.registerSpriteAnimator("PROPERTY",4,400,function(){for(var e=0,t=0,o=model.mapWidth,r=model.mapHeight;o>e;e++)for(var n=t;r>n;n++)null!==model.propertyPosMap[e][n]&&view.markForRedrawWithNeighbours(e,n)}),view.registerCommandHook({key:"addVisioner",prepare:function(e){var t,o,r=e.getSourceX(),n=e.getSourceY(),i=e.getSubAction(),a=n-i,l=n+i;for(0>a&&(a=0),l>=model.mapHeight&&(l=model.mapHeight-1);l>=a;a++){var c=Math.abs(a-n);for(t=r-i+c,o=r+i-c,0>t&&(t=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=t;t++)view.markForRedraw(t,a)}},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"attack",prepare:function(e){controller.updateUnitStats(e.getSourceUnit()),controller.updateUnitStats(e.getTargetUnit())},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"buildUnit",prepare:function(e){var t=e.getSourceX(),o=e.getSourceY(),r=model.unitPosMap[t][o];controller.updateUnitStats(r)},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"captureProperty",prepare:function(e){var t=e.getTargetProperty();20===t.capturePoints?view.showInfoMessage(util.i18n_localized("propertyCaptured")):view.showInfoMessage(util.i18n_localized("propertyPointsLeft")+" "+t.capturePoints)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerCommandHook({key:"endGame",prepare:function(){view.showInfoMessage(util.i18n_localized("gameHasEnded"),36e5)},render:function(){},update:function(){},isDone:function(){return!1}}),view.registerCommandHook({key:"invokeMultiStepAction",prepare:function(){var e=controller.input.state();if("ACTION_MENU"===e||"ACTION_SUBMENU"===e){var t=controller.input.menu;if("unloadUnit"===controller.input.actionData.getAction()){var o=t;t=[];for(var r=0,n=controller.input.menuSize-1;n>r;r++)t[r]=model.units[o[r]].type;t[controller.input.menuSize-1]=o[controller.input.menuSize-1]}controller.showMenu(t,controller.input.menuSize,controller.mapCursorX,controller.mapCursorY)}},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"join",prepare:function(e){controller.updateUnitStats(e.getTargetUnit())},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"loadUnit",prepare:function(e){controller.updateUnitStats(e.getTargetUnit())},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"move",prepare:function(e){this.moveAnimationX=e.getSourceX(),this.moveAnimationY=e.getSourceY(),this.moveAnimationIndex=0,this.moveAnimationPath=e.getMovePath(),this.moveAnimationUid=e.getSourceUnitId(),this.moveAnimationShift=0,view.preventRenderUnit=e.getSourceUnit(),util.logInfo("drawing move from","(",this.moveAnimationX,",",this.moveAnimationY,")","with path","(",this.moveAnimationPath,")"),controller.updateUnitStats(e.getSourceUnit())},update:function(e){var t=TILE_LENGTH;if(this.moveAnimationShift+=e/1e3*12*t,view.markForRedrawWithNeighboursRing(this.moveAnimationX,this.moveAnimationY),this.moveAnimationShift>t){switch(this.moveAnimationPath[this.moveAnimationIndex]){case model.MOVE_CODE_UP:this.moveAnimationY--;break;case model.MOVE_CODE_RIGHT:this.moveAnimationX++;break;case model.MOVE_CODE_DOWN:this.moveAnimationY++;break;case model.MOVE_CODE_LEFT:this.moveAnimationX--}this.moveAnimationIndex++,this.moveAnimationShift-=t,this.moveAnimationIndex===this.moveAnimationPath.length&&(this.moveAnimationX=0,this.moveAnimationY=0,this.moveAnimationIndex=0,this.moveAnimationPath=null,this.moveAnimationUid=-1,this.moveAnimationShift=0,view.preventRenderUnit=null)}},render:function(){var e,t=this.moveAnimationUid,o=this.moveAnimationX,r=this.moveAnimationY,n=this.moveAnimationShift,i=this.moveAnimationPath[this.moveAnimationIndex],a=model.units[t],l=view.colorArray[a.owner],c=a.type;switch(i){case model.MOVE_CODE_UP:e=view.IMAGE_CODE_UP;break;case model.MOVE_CODE_RIGHT:e=view.IMAGE_CODE_RIGHT;break;case model.MOVE_CODE_DOWN:e=view.IMAGE_CODE_DOWN;break;case model.MOVE_CODE_LEFT:e=view.IMAGE_CODE_LEFT}var u=view.getUnitImageForType(c,e,l),s=TILE_LENGTH,m=controller.baseSize,d=2*m*view.getSpriteStep("UNIT"),p=0,_=2*m,E=2*m,g=o*s-s/2,f=r*s-s/2,I=s+s,v=s+s;switch(i){case model.MOVE_CODE_UP:f-=n;break;case model.MOVE_CODE_LEFT:g-=n;break;case model.MOVE_CODE_RIGHT:g+=n;break;case model.MOVE_CODE_DOWN:f+=n}if(void 0!==u)view.canvasCtx.drawImage(u,d,p,_,E,g,f,I,I);else{switch(g=o*s,f=r*s,I=s,v=s,i){case model.MOVE_CODE_UP:f-=n;break;case model.MOVE_CODE_LEFT:g-=n;break;case model.MOVE_CODE_RIGHT:g+=n;break;case model.MOVE_CODE_DOWN:f+=n}view.canvasCtx.fillStyle="rgb(255,0,0)",view.canvasCtx.fillRect(g,f,I,v)}},isDone:function(){return-1===this.moveAnimationUid}}),view.registerCommandHook({key:"nextTurn",prepare:function(){model.fogOn&&view.completeRedraw(),controller.resetTurnTimer(),view.updatePlayerInfo(),view.showInfoMessage(util.i18n_localized("day")+": "+model.day)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerCommandHook({key:"remVisioner",prepare:function(e){var t,o,r=e.getSourceX(),n=e.getSourceY(),i=e.getSubAction(),a=n-i,l=n+i;for(0>a&&(a=0),l>=model.mapHeight&&(l=model.mapHeight-1);l>=a;a++){var c=Math.abs(a-n);for(t=r-i+c,o=r+i-c,0>t&&(t=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=t;t++)view.markForRedraw(t,a)}},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"silofire",_check:function(e,t){var o=model.unitPosMap[e][t];null!==o&&controller.updateUnitStats(o)},_render:function(e,t,o,r){if(!(0>o||o>=10)){var n=TILE_LENGTH,i=48*o,a=0,l=48,c=48,u=e*n,s=t*n,m=n,d=n;view.canvasCtx.drawImage(r,i,a,l,c,u,s,m,d),view.markForRedraw(e,t)}},prepare:function(e){var t=e.getActionTargetX(),o=e.getActionTargetY();this.x=t,this.y=o;var r=this._check;r(t,o-2),r(t-1,o-1),r(t,o-1),r(t+1,o-1),r(t-2,o),r(t-1,o),r(t,o),r(t+1,o),r(t+2,o),r(t-1,o+1),r(t,o+1),r(t+1,o+1),r(t,o+2),this.step=0,this.time=0},render:function(){var e=view.getInfoImageForType("EXPLOSION_GROUND"),t=this.step,o=this._render,r=this.x,n=this.y;o(r,n,t,e),t-=1,o(r,n-1,t,e),o(r-1,n,t,e),o(r+1,n,t,e),o(r,n+1,t,e),t-=3,o(r-1,n+1,t,e),o(r+1,n+1,t,e),o(r-1,n-1,t,e),o(r+1,n-1,t,e),o(r,n-2,t,e),o(r,n+2,t,e),o(r-2,n,t,e),o(r+2,n,t,e)},update:function(e){this.time+=e,this.time>50&&(this.step++,this.time=0)},isDone:function(){return 13===this.step}}),view.registerCommandHook({key:"trapWait",prepare:function(e){this.time=0,this.xp=e.getTargetX(),this.yp=e.getTargetY(),this.x=e.getTargetX()*TILE_LENGTH,this.y=e.getTargetY()*TILE_LENGTH
},render:function(){var e=view.getInfoImageForType("TRAPPED");view.canvasCtx.drawImage(e,this.x,this.y)},update:function(e){this.time+=e},isDone:function(){var e=this.time>1e3;if(e)for(var t=view.getInfoImageForType("TRAPPED"),o=this.yp,r=this.xp,n=r+parseInt(t.width/TILE_LENGTH,10);n>=r;r++)view.markForRedraw(r,o);return e}}),view.registerCommandHook({key:"unloadUnit",prepare:function(e){controller.updateUnitStats(e.getSourceUnit())},render:function(){},update:function(){},isDone:function(){return!0}}),controller.registerCommand({key:"colorizeImages",UNIT_INDEXES:{BLACK_MASK:8,RED:0,BLUE:3,GREEN:4,colors:6},PROPERTY_INDEXES:{RED:0,GRAY:1,BLUE:3,GREEN:4,YELLOW:5,BLACK_MASK:8,colors:4},condition:util.FUNCTION_FALSE_RETURNER,action:function(){function e(e){var t=document.createElement("canvas"),o=t.getContext("2d"),r=e.width,n=e.height;return t.width=r,t.height=n,o.drawImage(e,0,0),o.getImageData(0,0,r,n).data}function t(e,t,o,r,n,i){var a=document.createElement("canvas"),l=a.getContext("2d"),c=e.width,u=e.height;a.width=c,a.height=u,l.drawImage(e,0,0);for(var s=l.getImageData(0,0,c,u),m=4*r*o,d=4*n*o,p=0,_=0;s.height>_;_++)for(var E=0;s.width>E;E++)for(var g=4*_*s.width+4*E,f=s.data[g],I=s.data[g+1],v=s.data[g+2],h=0,T=4*o;T>h;h+=4){var A=t[m+h],O=t[m+h+1],w=t[m+h+2];if(A===f&&O===I&&w===v){var C=d+h,S=t[C],y=t[C+1],D=t[C+2];s.data[g]=S,s.data[g+1]=y,s.data[g+2]=D,p++}}return util.logInfo("replaced",p,"pixels for the type",i),l.putImageData(s,0,0),a}for(var o=[view.IMAGE_CODE_IDLE,view.IMAGE_CODE_IDLE_INVERTED,view.IMAGE_CODE_DOWN,view.IMAGE_CODE_UP,view.IMAGE_CODE_RIGHT,view.IMAGE_CODE_LEFT],r=e(view.getInfoImageForType(view.IMG_COLOR_MAP_PROPERTIES_ID)),n=e(view.getInfoImageForType(view.IMG_COLOR_MAP_UNITS_ID)),i=CWT_MOD_DEFAULT.graphic.units,a=0,l=i.length;l>a;a++)for(var c=i[a][0],u=0,s=o.length;s>u;u++){var m=o[u],d=view.getUnitImageForType(c,m,view.COLOR_RED);view.setUnitImageForType(t(d,n,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.BLUE,c),c,m,view.COLOR_BLUE),view.setUnitImageForType(t(d,n,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.GREEN,c),c,m,view.COLOR_GREEN),view.setUnitImageForType(t(d,n,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.BLACK_MASK,c),c,m,view.COLOR_BLACK_MASK)}for(var p=CWT_MOD_DEFAULT.graphic.properties,a=0,l=p.length;l>a;a++){var c=p[a][0],d=view.getPropertyImageForType(c,view.COLOR_RED);view.setPropertyImageForType(t(d,r,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.BLUE),c,view.COLOR_BLUE),view.setPropertyImageForType(t(d,r,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.GREEN),c,view.COLOR_GREEN),view.setPropertyImageForType(t(d,r,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.GRAY),c,view.COLOR_NEUTRAL),view.setPropertyImageForType(t(d,r,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.BLACK_MASK),c,view.COLOR_BLACK_MASK)}}}),controller.registerCommand({key:"cutImages",condition:util.FUNCTION_FALSE_RETURNER,action:function(){function e(e,t,o){var r=t?-1:1,n=o?-1:1,i=t?-1*e.width:0,a=o?-1*e.height:0,l=document.createElement("canvas");l.height=e.height,l.width=e.width;var c=l.getContext("2d");return c.save(),c.scale(r,n),c.drawImage(e,i,a,e.width,e.height),c.restore(),l}CWT_MOD_DEFAULT.graphic.baseSize,DEBUG&&util.logInfo("cutting unit commands into single types");for(var t=CWT_MOD_DEFAULT.graphic.units,o=0,r=t.length;r>o;o++){var n,i,a=view.COLOR_RED,l=t[o][0],c=view.getUnitImageForType(l,view.IMAGE_CODE_IDLE,a);n=document.createElement("canvas"),n.height=32,n.width=96,i=n.getContext("2d"),i.drawImage(c,0,0,96,32,0,0,96,32),view.setUnitImageForType(n,l,view.IMAGE_CODE_IDLE,a),n=document.createElement("canvas"),n.height=32,n.width=96,i=n.getContext("2d"),i.drawImage(c,0,0,96,32,0,0,96,32),view.setUnitImageForType(e(n,!0,!1),l,view.IMAGE_CODE_IDLE_INVERTED,a),n=document.createElement("canvas"),n.height=32,n.width=96,i=n.getContext("2d"),i.drawImage(c,288,0,96,32,0,0,96,32),view.setUnitImageForType(n,l,view.IMAGE_CODE_LEFT,a),n=document.createElement("canvas"),n.height=32,n.width=96,i=n.getContext("2d"),i.drawImage(c,288,0,96,32,0,0,96,32),view.setUnitImageForType(e(n,!0,!1),l,view.IMAGE_CODE_RIGHT,a),n=document.createElement("canvas"),n.height=32,n.width=96,i=n.getContext("2d"),i.drawImage(c,96,0,96,32,0,0,96,32),view.setUnitImageForType(n,l,view.IMAGE_CODE_UP,a),n=document.createElement("canvas"),n.height=32,n.width=96,i=n.getContext("2d"),i.drawImage(c,192,0,96,32,0,0,96,32),view.setUnitImageForType(n,l,view.IMAGE_CODE_DOWN,a)}DEBUG&&util.logInfo("cutting unit commands into single types done"),DEBUG&&util.logInfo("cutting misc into single types");for(var u=CWT_MOD_DEFAULT.graphic.misc,o=0,r=u.length;r>o;o++){var s=u[o];if(s.length>2){var c=view.getInfoImageForType(s[0]);n=document.createElement("canvas"),n.height=16,n.width=16,i=n.getContext("2d"),s.length>6&&(i.save(),i.translate(8,8),i.rotate(s[6]*Math.PI/180),i.translate(-8,-8)),i.drawImage(c,s[2],s[3],s[4],s[5],0,0,16,16),s.length>6&&i.restore(),view.setInfoImageForType(n,s[0])}}DEBUG&&util.logInfo("cutting misc into single types done")}}),controller.registerCommand({key:"loadConfig",localAction:!0,condition:util.FUNCTION_FALSE_RETURNER,action:function(){var e=controller.storage.get("CWT_CONFIG");null===e&&(util.logInfo("creating fresh configuration object"),e={lastUpdate:new Date},controller.storage.set("CWT_CONFIG",e)),util.logInfo("loaded configuration object (timestamp:",e.lastUpdate,")")}}),controller.registerCommand({key:"loadImages",localAction:!0,condition:util.FUNCTION_FALSE_RETURNER,action:function(){util.logInfo("loading images... place lock"),controller.lockCommandEvaluation=!0;var e="../../../image/",t=function(e){for(var t=0,o=e.length;o>t;t++)if(e[t].complete!==!0)return!1;return!0},o=function(o,r){for(var n,i=[],a=[],l=0,c=o.length;c>l;l++)n=new Image,n.src=e+o[l][1],i[l]=n,a[l]=o[l][0];var u=function(){t(i)?r(a,i):setTimeout(u,250)};u()},r=4;util.logInfo("loading unit commands"),o(CWT_MOD_DEFAULT.graphic.units,function(e,t){for(var o=0,n=e.length;n>o;o++)view.setUnitImageForType(t[o],e[o],view.IMAGE_CODE_IDLE,view.COLOR_RED);util.logInfo("unit commands loaded"),r--}),util.logInfo("loading property commands"),o(CWT_MOD_DEFAULT.graphic.properties,function(e,t){for(var o=0,n=e.length;n>o;o++)view.setPropertyImageForType(t[o],e[o],view.COLOR_RED);util.logInfo("property commands loaded"),r--}),util.logInfo("loading tile commands"),o(CWT_MOD_DEFAULT.graphic.tiles,function(e,t){for(var o=0,n=e.length;n>o;o++)view.setTileImageForType(t[o],e[o]);util.logInfo("tile commands loaded"),r--}),util.logInfo("loading other commands"),o(CWT_MOD_DEFAULT.graphic.misc,function(e,t){for(var o=0,n=e.length;n>o;o++)view.setInfoImageForType(t[o],e[o]);util.logInfo("other commands loaded"),r--}),util.logInfo("waiting for commands");var n=function(){0===r?(util.logInfo("all images are loaded.. releasing lock"),controller.lockCommandEvaluation=!1):setTimeout(n,250)};n()}}),controller.INPUT_KEYBOARD_CODE_LEFT=37,controller.INPUT_KEYBOARD_CODE_UP=38,controller.INPUT_KEYBOARD_CODE_RIGHT=39,controller.INPUT_KEYBOARD_CODE_DOWN=40,controller.INPUT_KEYBOARD_CODE_BACKSPACE=8,controller.INPUT_KEYBOARD_CODE_ENTER=13,controller.INPUT_KEYBOARD_CODE_M=77,controller.INPUT_KEYBOARD_CODE_N=78,controller.registerCommand({key:"loadInputDevices",condition:util.FUNCTION_FALSE_RETURNER,action:function(){var e=new DeviceDetection(navigator.userAgent);if(e.isDesktop()&&(document.onkeydown=function(e){util.logInfo("got key code",e.keyCode);var t=e.keyCode;switch(t){case controller.INPUT_KEYBOARD_CODE_LEFT:controller.moveCursor(model.MOVE_CODE_LEFT,1);break;case controller.INPUT_KEYBOARD_CODE_UP:controller.moveCursor(model.MOVE_CODE_UP,1);break;case controller.INPUT_KEYBOARD_CODE_RIGHT:controller.moveCursor(model.MOVE_CODE_RIGHT,1);break;case controller.INPUT_KEYBOARD_CODE_DOWN:controller.moveCursor(model.MOVE_CODE_DOWN,1);break;case controller.INPUT_KEYBOARD_CODE_BACKSPACE:controller.cursorActionCancel();break;case controller.INPUT_KEYBOARD_CODE_ENTER:controller.cursorActionClick();break;case controller.INPUT_KEYBOARD_CODE_M:3>controller.screenScale&&controller.setScreenScale(controller.screenScale+1);break;case controller.INPUT_KEYBOARD_CODE_N:controller.screenScale>1&&controller.setScreenScale(controller.screenScale-1)}switch(t){case controller.INPUT_KEYBOARD_CODE_LEFT:case controller.INPUT_KEYBOARD_CODE_UP:case controller.INPUT_KEYBOARD_CODE_RIGHT:case controller.INPUT_KEYBOARD_CODE_DOWN:case controller.INPUT_KEYBOARD_CODE_BACKSPACE:case controller.INPUT_KEYBOARD_CODE_ENTER:case controller.INPUT_KEYBOARD_CODE_M:case controller.INPUT_KEYBOARD_CODE_N:return!1}}),e.isDesktop()){var t=document.getElementById("cwt_canvas");t.onmousemove=function(e){var t,o;"number"==typeof e.offsetX?(t=e.offsetX,o=e.offsetY):(t=e.layerX,o=e.layerY);var t=parseInt(t/16,10),o=parseInt(o/16,10);controller.setCursorPosition(t,o)},t.onmousedown=function(e){switch(e.which){case 1:controller.cursorActionClick();break;case 2:break;case 3:controller.cursorActionCancel()}}}if(e.isAndroid()||e.isTouchDevice()){var o=document.getElementById("cwt_canvas"),r=new Hammer(o,{prevent_default:!0});r.ontap=function(e){var t=e.position[0].x,o=e.position[0].y,r=controller.screenScale*TILE_LENGTH,t=parseInt(t/r,10),o=parseInt(o/r,10);t+=controller.screenX,o+=controller.screenY,controller.setCursorPosition(t,o),controller.cursorActionClick()},r.onhold=function(){controller.cursorActionCancel()},r.onrelease=function(){},r.ondrag=function(){},r.ondragend=function(e){var t=TILE_LENGTH*controller.screenScale,o=e.angle,r=0;o>=-135&&-45>o?r=model.MOVE_CODE_UP:o>=-45&&45>o?r=model.MOVE_CODE_RIGHT:o>=45&&135>o?r=model.MOVE_CODE_DOWN:(o>=135||-135>o)&&(r=model.MOVE_CODE_LEFT);var n=parseInt(e.distance/t,10);0===n&&(n=1),controller.shiftScreenPosition(r,n)},r.ontransformend=function(e){return e.scale>1?3>controller.screenScale&&controller.setScreenScale(controller.screenScale+1):controller.screenScale>1&&controller.setScreenScale(controller.screenScale-1),!1}}}}),controller.registerCommand({key:"loadSounds",localAction:!0,condition:util.FUNCTION_FALSE_RETURNER,action:function(){}}),controller.registerCommand({key:"startRendering",localAction:!0,condition:util.FUNCTION_FALSE_RETURNER,action:function(){view.showInfoBlocks(),controller.noRendering=!1,view.fitScreenToDeviceOrientation(),view.completeRedraw(),view.updateTileInfo(),view.updatePlayerInfo();for(var e=0,t=model.units.length;t>e;e++)model.units[e].owner!==CWT_INACTIVE_ID&&controller.updateUnitStats(model.units[e]);model.generateFogMap(0)}}),function(){function e(e){var t=controller.aquireActionDataObject();t.setAction(e),controller.pushActionDataIntoBuffer(t)}for(var t=[["chrome",18,19,20,21,22,23,24],["mozilla",17,18,19],["safari",5,6]],o=!1,r=0,n=t.length;n>r;r++){var i=t[r];if(BrowserDetection[i[0]]===!0){o=!0;for(var a=!1,l=1,c=i.length;c>l;l++)0===BrowserDetection.version.indexOf(i[l])&&(a=!0);o||alert("Attention!\nThe version of your browser is not supported!")}}o||alert("Attention!\nYour browser is not supported!"),e("loadMod"),e("loadImages"),e("cutImages"),e("colorizeImages"),e("loadInputDevices"),e("loadSounds");var u=controller.aquireActionDataObject();u.setAction("loadGame"),u.setSubAction(testMap),controller.pushActionDataIntoBuffer(u),util.i18n_setLanguage("en"),e("loadConfig"),e("startRendering")}();