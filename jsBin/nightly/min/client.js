const CLIENT_DEBUG=!1;createjs.Sound.registerPlugin(createjs.WebAudioPlugin),createjs.Sound.addEventListener("loadComplete",function(){}),createjs.Sound.registerManifest([{src:"sound/ok.wav",id:"ACTION"},{src:"sound/cancel.wav",id:"CANCEL"}]),controller.playSfx=function(e){createjs.Sound.play(e)},controller.mapCursorX=0,controller.mapCursorY=0,controller.menuCursorIndex=-1,controller.resetMenuCursor=function(){controller.menuCursorIndex=0},controller.setMenuIndex=function(e){controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuCursorIndex=e,controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton"},controller.increaseMenuCursor=function(){controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuCursorIndex++,controller.menuCursorIndex===controller.stateMachine.data.menuSize&&controller.menuCursorIndex--,controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton",controller.menuEntryListElement.children[controller.menuCursorIndex].children[0].focus()},controller.decreaseMenuCursor=function(){controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuCursorIndex--,0>controller.menuCursorIndex&&(controller.menuCursorIndex=0),controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton",controller.menuEntryListElement.children[controller.menuCursorIndex].children[0].focus()},controller.resetMapCursor=function(){controller.mapCursorX=0,controller.mapCursorY=0},controller.cursorAction=function(e){if(null===controller.currentAnimatedKey){var t=controller.stateMachine.state,r="MOVEPATH_SELECTION"===t||"IDLE_R"===t||"ACTION_SELECT_TARGET_A"===t||"ACTION_SELECT_TARGET_B"===t;e?controller.stateMachine.event("cancel",controller.mapCursorX,controller.mapCursorY):-1!==controller.menuCursorIndex?controller.stateMachine.event("action",controller.menuCursorIndex):controller.stateMachine.event("action",controller.mapCursorX,controller.mapCursorY);var n=controller.stateMachine.state,o="MOVEPATH_SELECTION"===n||"IDLE_R"===n||"ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n;if((r&&!o||o)&&view.markSelectionMapForRedraw(controller.stateMachine.data),"ACTION_MENU"===n||"ACTION_SUBMENU"===n){var i=controller.stateMachine.data.menu;controller.showMenu(i,controller.stateMachine.data.menuSize,controller.mapCursorX,controller.mapCursorY)}else("ACTION_MENU"===t||"ACTION_SUBMENU"===t)&&controller.hideMenu()}},controller.cursorActionCancel=function(){controller.cursorAction(!0),controller.playSfx("CANCEL")},controller.cursorActionClick=function(){controller.cursorAction(!1),controller.playSfx("ACTION")},controller.moveCursor=function(e,t){1===arguments.length&&(t=1);var r=controller.mapCursorX,n=controller.mapCursorY;switch(e){case model.MOVE_CODE_UP:n--;break;case model.MOVE_CODE_RIGHT:r++;break;case model.MOVE_CODE_DOWN:n++;break;case model.MOVE_CODE_LEFT:r--}controller.setCursorPosition(r,n)},controller.setCursorPosition=function(e,t,r){if("block"!==controller.menuElement.style.display&&(r&&(e+=controller.screenX,t+=controller.screenY),model.isValidPosition(e,t)&&(e!==controller.mapCursorX||t!==controller.mapCursorY))){view.markForRedraw(controller.mapCursorX,controller.mapCursorY),controller.mapCursorX=e,controller.mapCursorY=t;var n=parseInt(parseInt(window.innerWidth/16,10)/controller.screenScale,10),o=parseInt(parseInt(window.innerHeight/16,10)/controller.screenScale,10),i=-1;1>=e-controller.screenX?i=model.MOVE_CODE_LEFT:e-controller.screenX>=n-1?i=model.MOVE_CODE_RIGHT:1>=t-controller.screenY?i=model.MOVE_CODE_UP:t-controller.screenY>=o-1&&(i=model.MOVE_CODE_DOWN),-1!==i&&controller.shiftScreenPosition(i,5),view.markForRedraw(e,t)}},controller.currentAnimatedKey=null,controller.noRendering=!0,controller.lockCommandEvaluation=!1,controller.gameLoop=function(e){controller.updateTurnTimer(e);var t=0!==controller.moveScreenX||0!==controller.moveScreenY;if(t)controller.solveMapShift();else{if(null===controller.currentAnimatedKey){if(controller.lockCommandEvaluation===!1&&!controller.noNextActions()){var r=controller.doNextAction();if(null!==r){var n=r[r.length-1];view.invokeCommandListener(n,r);var o=view.getCommandHook(n);null!==o&&(o.prepare.apply(o,r),controller.currentAnimatedKey=o)}}}else controller.currentAnimatedKey.update(e);view.updateSpriteAnimations(e)}!controller.noRendering&&view.drawScreenChanges>0&&view.renderMap(controller.screenScale),controller.noRendering||t||null!==controller.currentAnimatedKey&&(controller.currentAnimatedKey.isDone()?controller.currentAnimatedKey=null:controller.currentAnimatedKey.render())},controller.enterGameLoop=function(){function e(){requestAnimationFrame(e);var i=(new Date).getTime(),a=i-o;o=i;var l=1e3/((i=new Date)-r);isNaN(l)||(t+=(l-t)/n),r=i,controller.gameLoop(a)}var t=0,r=1*new Date-1,n=50,o=(new Date).getTime(),i=document.getElementById("fps");setInterval(function(){i.innerHTML=CWT_VERSION+" "+t.toFixed(1)+"fps"},1e3),controller.stateMachine.event("start"),view.fitScreenToDeviceOrientation(),window.requestAnimationFrame(e)},controller.menuPosX=-1,controller.menuPosY=-1,controller.menuElement=document.getElementById("cwt_menu"),controller.menuHeaderElement=document.getElementById("cwt_menu_header"),controller.menuEntryContentElement=document.getElementById("cwt_menu_content"),controller.menuEntryListElement=document.getElementById("cwt_menu_entries"),controller._connectMenuListener=function(e,t){e.onclick=function(){controller.cursorActionClick()},e.onmouseover=function(){controller.setMenuIndex(t)}},controller.showMenu=function(e,t,r,n){var o=TILE_LENGTH*controller.screenScale,i=controller.menuRenderer_.__mainMenu__;if("ACTION_SUBMENU"===controller.stateMachine.state){var a=controller.menuRenderer_[controller.stateMachine.data.action];a&&(i=a)}1===arguments.length&&(r=controller.menuPosX,n=controller.menuPosY);var l=controller.menuEntryListElement.children;controller.menuRenderer_.__infoPanel__(r,n,controller.menuHeaderElement);for(var s=0,u=l.length;u>s;s++)l[s].style.display="none";for(var s=0,u=t;u>s;s++){var c;if(l.length>s)c=l[s].children[0];else{c=document.createElement("button"),controller._connectMenuListener(c,s);var d=document.createElement("li");d.appendChild(c),controller.menuEntryListElement.appendChild(d)}i(e[s],c,s),l[s].style.display=""}r-=controller.screenX,n-=controller.screenY;var m=parseInt(150/o,10),p=parseInt(160/o,10);n>controller.screenHeight-m&&(n-=parseInt(160/o,10)),r>controller.screenWidth-p&&(r-=parseInt(150/o,10)),controller.menuPosX=r,controller.menuPosY=n,controller.menuCursorIndex=0,controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton",controller.menuEntryListElement.children[controller.menuCursorIndex].children[0].focus();var h=controller.menuElement.style;h.top=n*o+10+"px",h.left=r*o-10+"px",h.zIndex=2e3,h.display="block",controller.setMenuIndex(0)},controller.hideMenu=function(){controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuElement.style.display="none",controller.menuCursorIndex=-1},controller.menuRenderer_={},controller.registerMenuRenderer=function(e,t){controller.menuRenderer_.hasOwnProperty(e)&&util.raiseError("renderer for",e,"is already registered"),controller.menuRenderer_[e]=t},controller.statusMap_=util.list(CWT_MAX_UNITS_PER_PLAYER*CWT_MAX_PLAYER,function(){return{HP_PIC:null,LOW_AMMO:!1,LOW_FUEL:!1,HAS_LOADS:!1,CAPTURES:!1}}),controller.getUnitStatusForUnit=function(e){var t=model.extractUnitId(e);return controller.statusMap_[t]},controller.updateUnitStatus=function(e){var t=model.units[e],r=controller.statusMap_[e],n=model.sheets.unitSheets[t.type],o=t.ammo,i=n.maxAmmo;r.LOW_AMMO=parseInt(.25*i,10)>=o?!0:!1,0===i&&(r.LOW_AMMO=!1);var a=t.fuel,l=n.maxFuel;r.LOW_FUEL=parseInt(.25*l,10)>a?!0:!1;var s=-1;switch(90>=t.hp&&(s=parseInt(t.hp/10,10)+1),s){case 1:r.HP_PIC=view.getInfoImageForType("HP_1");break;case 2:r.HP_PIC=view.getInfoImageForType("HP_2");break;case 3:r.HP_PIC=view.getInfoImageForType("HP_3");break;case 4:r.HP_PIC=view.getInfoImageForType("HP_4");break;case 5:r.HP_PIC=view.getInfoImageForType("HP_5");break;case 6:r.HP_PIC=view.getInfoImageForType("HP_6");break;case 7:r.HP_PIC=view.getInfoImageForType("HP_7");break;case 8:r.HP_PIC=view.getInfoImageForType("HP_8");break;case 9:r.HP_PIC=view.getInfoImageForType("HP_9");break;default:r.HP_PIC=null}if(n.transport&&(r.HAS_LOADS=model.hasLoadedIds(e)?!1:!1),-1!==t.x){var u=model.propertyPosMap[t.x][t.y];r.CAPTURES=null!==u&&20>u.capturePoints?!0:!1}},controller.screenElement=document.getElementById("cwt_canvas"),controller.screenX=0,controller.screenY=0,controller.screenWidth=-1,controller.screenHeight=-1,controller.screenScale=1,controller.moveScreenX=0,controller.moveScreenY=0,controller._transEndEventNames={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",msTransition:"MSTransitionEnd",transition:"transitionend"},controller.setScreenScale=function(e){1!==e&&2!==e&&3!==e&&util.illegalArgumentError(),controller.screenScale=e,controller.screenElement.className=1===e?"":"scale"+e;var t=TILE_LENGTH*e;controller.screenWidth=parseInt(window.innerWidth/t,10),controller.screenHeight=parseInt(window.innerHeight/t,10),controller.setScreenPosition(controller.screenX,controller.screenY,!1)},controller.setScreenPosition=function(e,t){controller.screenX=e,controller.screenY=t;var r=controller.screenElement.style,n=controller.screenScale,o=-(controller.screenX*TILE_LENGTH*n),i=-(controller.screenY*TILE_LENGTH*n);switch(n){case 2:o+=controller.screenElement.width/2,i+=controller.screenElement.height/2;break;case 3:o+=controller.screenElement.width,i+=controller.screenElement.height}r.position="absolute",r.left=o+"px",r.top=i+"px"},controller.shiftScreenPosition=function(e,t){1===arguments.length&&(t=1);var r=controller.screenX,n=controller.screenY;switch(e){case model.MOVE_CODE_DOWN:n+=t;break;case model.MOVE_CODE_RIGHT:r+=t;break;case model.MOVE_CODE_UP:n-=t;break;case model.MOVE_CODE_LEFT:r-=t}0>r&&(r=0),0>n&&(n=0),r>=model.mapWidth&&(r=model.mapWidth-1),n>=model.mapHeight&&(n=model.mapHeight-1),controller.setScreenPosition(r,n,!1)},controller.storage={get:function(e){var t=localStorage.getItem(e);return null!==t?JSON.parse(t):null},has:function(e){return null!==localStorage.getItem(e)},clear:function(){localStorage.clear()},remove:function(e){localStorage.removeItem(e)},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))}},view._animCommands={},view.registerCommandHook=function(e){view._animCommands[e.key]=e,e.isEnabled=!0},view.getCommandHook=function(e){var t=view._animCommands[e];return void 0!==t?t:null},view._commandListeners={},view.registerCommandListener=function(e,t){view._commandListeners.hasOwnProperty(e)||(view._commandListeners[e]=[]),view._commandListeners[e].push(t)},view.invokeCommandListener=function(e,t){var r=view._commandListeners[e];if(r)for(var n=0,o=r.length;o>n;n++)r[n].apply(null,t)},view.IMAGE_CODE_IDLE="IDLE",view.IMAGE_CODE_IDLE_INVERTED="IDLE_R",view.IMAGE_CODE_RIGHT="RIGHT",view.IMAGE_CODE_LEFT="LEFT",view.IMAGE_CODE_UP="UP",view.IMAGE_CODE_DOWN="DOWN",view.IMAGE_CODE_STATELESS="STATELESS",view.COLOR_RED="RED",view.COLOR_GREEN="GREEN",view.COLOR_BLUE="BLUE",view.COLOR_YELLOW="YELLOW",view.COLOR_BLACK_MASK="BLACK_MASK",view.COLOR_NEUTRAL="GRAY",view.COLOR_NONE="NONE",view.IMG_COLOR_MAP_PROPERTIES_ID="IMG_MAP_PROPERTY",view.IMG_COLOR_MAP_UNITS_ID="IMG_MAP_UNIT",view.CodeStatelessview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{},NONE:{},GRAY:{}},view.CodeIdleview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeIdleInvertedview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeRightview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeLeftview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeUpview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeDownview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.setImageForType=function(e,t,r,n){switch(void 0===r&&(r=view.IMAGE_CODE_STATELESS),void 0===n&&(n=view.COLOR_NONE),r){case view.IMAGE_CODE_IDLE:view.CodeIdleview[n][t]=e;break;case view.IMAGE_CODE_STATELESS:view.CodeStatelessview[n][t]=e;break;case view.IMAGE_CODE_IDLE_INVERTED:view.CodeIdleInvertedview[n][t]=e;break;case view.IMAGE_CODE_LEFT:view.CodeLeftview[n][t]=e;break;case view.IMAGE_CODE_RIGHT:view.CodeRightview[n][t]=e;break;case view.IMAGE_CODE_DOWN:view.CodeDownview[n][t]=e;break;case view.IMAGE_CODE_UP:view.CodeUpview[n][t]=e;break;default:util.raiseError("unknown image state code ",r)}},view.setUnitImageForType=view.setImageForType,view.setPropertyImageForType=function(e,t,r){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,r)},view.setTileImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.setInfoImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getImageForType=function(e,t,r){switch(t){case view.IMAGE_CODE_IDLE:return view.CodeIdleview[r][e];case view.IMAGE_CODE_IDLE_INVERTED:return view.CodeIdleInvertedview[r][e];case view.IMAGE_CODE_LEFT:return view.CodeLeftview[r][e];case view.IMAGE_CODE_RIGHT:return view.CodeRightview[r][e];case view.IMAGE_CODE_DOWN:return view.CodeDownview[r][e];case view.IMAGE_CODE_UP:return view.CodeUpview[r][e];case view.IMAGE_CODE_STATELESS:return view.CodeStatelessview[r][e];default:util.raiseError("unknown image state code ",t)}},view.getUnitImageForType=view.getImageForType,view.getPropertyImageForType=function(e,t){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,t)},view.getTileImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getInfoImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)};var TILE_LENGTH=16;controller.baseSize=CWT_MOD_DEFAULT.graphic.baseSize,view.preventRenderUnit=null,view.canvasCtx=controller.screenElement.getContext("2d"),view.colorArray=[view.COLOR_RED,view.COLOR_BLUE,view.COLOR_GREEN,view.COLOR_YELLOW],view.renderMap=function(){var e=TILE_LENGTH,t=view.canvasCtx;controller.screenX,controller.screenY;for(var r,n,o,i,a,l,s,u,c,d,m,p=view.getSpriteStep("SELECTION"),h=view.getSpriteStep("UNIT"),E=view.getSpriteStep("PROPERTY"),_=view.getSpriteStep("STATUS"),f=controller.baseSize,v="MOVEPATH_SELECTION"===controller.stateMachine.state||"IDLE_R"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state,T=model.mapHeight-1,g=0;T>=g;g++)for(var A=model.mapWidth-1,y=0;A>=y;y++)if(m=0===model.fogData[y][g],view.drawScreen[y][g]===!0){r=model.map[y][g],n=view.getTileImageForType(r),o=0,i=0,a=f,l=2*f,s=y*e,u=g*e-e,c=e,d=2*e,0>u&&(i+=f,l-=f,u+=e,d-=e),void 0!==n?t.drawImage(n,o,i,a,l,s,u,c,d):(t.fillStyle="rgb(0,0,255)",t.fillRect(s,u,e,e));var I=model.propertyPosMap[y][g];if(null!==I){var O;O=-1===I.owner?view.COLOR_NEUTRAL:view.colorArray[I.owner],m&&(O=view.COLOR_NEUTRAL),n=view.getPropertyImageForType(I.type,O),o=0+f*E,i=0,a=f,l=2*f,s=y*e,u=g*e-e,c=e,d=2*e,0>u&&(i+=f,l-=f,u+=e,d-=e),void 0!==n?(t.drawImage(n,o,i,a,l,s,u,c,d),m&&d>16&&null!==I&&(n=view.getPropertyImageForType(I.type,view.COLOR_BLACK_MASK),t.globalAlpha=.35,t.drawImage(n,o,i,a,l/2,s,u,c,d/2),t.globalAlpha=1)):(s=y*e,u=g*e,c=e,d=e,t.fillStyle="rgb(0,255,0)",t.fillRect(s,u,c,d))}if(m&&(s=y*e,u=g*e,c=e,d=e,t.globalAlpha=.2,t.fillStyle="black",t.fillRect(s,u,c,d),t.globalAlpha=1),v){n=view.getInfoImageForType("MOVEPATH_SELECTION"===controller.stateMachine.state?"MOVE_FOC":"ATK_FOC");var S=controller.stateMachine.data.getSelectionValueAt(y,g);S>0&&(o=f*p,i=0,a=f,l=f,s=y*e,u=g*e,c=e,d=e,t.globalAlpha=.65,t.drawImage(n,o,i,a,l,s,u,c,d),t.globalAlpha=1)}var C=model.unitPosMap[y][g];if(!m&&null!==C&&C!==view.preventRenderUnit){var O;O=-1===C.owner?view.COLOR_NEUTRAL:view.colorArray[C.owner];var w=1===C.owner%2?view.IMAGE_CODE_IDLE:view.IMAGE_CODE_IDLE_INVERTED;n=view.getUnitImageForType(C.type,w,O),o=2*f*h,i=0,a=2*f,l=2*f,s=y*e-e/2,u=g*e-e/2,c=e+e,d=e+e,void 0!==n?(t.drawImage(n,o,i,a,l,s,u,c,d),C.owner!==model.turnOwner||model.canAct(model.extractUnitId(C))||(t.globalAlpha=.5,t.drawImage(view.getUnitImageForType(C.type,w,view.COLOR_BLACK_MASK),o,i,a,l,s,u,c,d),t.globalAlpha=1)):(s=y*e,u=g*e,c=e,d=e,t.fillStyle="rgb(255,0,0)",t.fillRect(s,u,c,d));var P=controller.getUnitStatusForUnit(C);if(n=P.HP_PIC,null!==n&&t.drawImage(n,s+e,u+e),0!==_&&1!==_&&4!==_&&5!==_&&8!==_&&9!==_&&12!==_&&13!==_){var M=parseInt(_/4,10);n=null;var D=M;do{if(0===D&&P.LOW_AMMO?n=view.getInfoImageForType("SYM_AMMO"):1===D&&P.LOW_FUEL?n=view.getInfoImageForType("SYM_FUEL"):2===D&&P.CAPTURES?n=view.getInfoImageForType("SYM_CAPTURE"):3===D&&P.HAS_LOADS&&(n=view.getInfoImageForType("SYM_LOAD")),null!==n)break;D++,4===D&&(D=0)}while(D!==M);null!==n&&t.drawImage(n,s+e/2,u+e)}}view.drawScreen[y][g]=!1}if("MOVEPATH_SELECTION"===controller.stateMachine.state)for(var R,U,N,L,b=controller.stateMachine.data,W=b.movePath,V=b.sourceX,k=b.sourceY,H=0,x=W.length;x>H&&null!==W[H];H++){switch(R=V,U=k,W[H]){case model.MOVE_CODE_UP:k--;break;case model.MOVE_CODE_RIGHT:V++;break;case model.MOVE_CODE_DOWN:k++;break;case model.MOVE_CODE_LEFT:V--}if(H===x-1||null===W[H+1])N=-1,L=-1;else switch(W[H+1]){case model.MOVE_CODE_UP:N=V,L=k-1;break;case model.MOVE_CODE_RIGHT:N=V+1,L=k;break;case model.MOVE_CODE_DOWN:N=V,L=k+1;break;case model.MOVE_CODE_LEFT:N=V-1,L=k}if(-1==N)switch(W[H]){case model.MOVE_CODE_UP:n=view.getTileImageForType("ARROW_N");break;case model.MOVE_CODE_RIGHT:n=view.getTileImageForType("ARROW_E");break;case model.MOVE_CODE_DOWN:n=view.getTileImageForType("ARROW_S");break;case model.MOVE_CODE_LEFT:n=view.getTileImageForType("ARROW_W")}else{var G=Math.abs(N-R),Y=Math.abs(L-U);if(2===G)n=view.getTileImageForType("ARROW_WE");else if(2===Y)n=view.getTileImageForType("ARROW_NS");else if(V>N&&U>k||V>R&&L>k)n=view.getTileImageForType("ARROW_SW");else if(V>N&&k>U||V>R&&k>L)n=view.getTileImageForType("ARROW_WN");else if(N>V&&k>U||R>V&&k>L)n=view.getTileImageForType("ARROW_NE");else{if(!(N>V&&U>k||R>V&&L>k)){util.logError("illegal move arrow state","old (",R,",",U,")","current (",V,",",k,")","next (",N,",",L,")","path (",W,")");continue}n=view.getTileImageForType("ARROW_ES")}}V>=0&&k>=0&&controller.screenWidth>V&&controller.screenHeight>k&&t.drawImage(n,V*e,k*e)}t.lineWidth=2,t.strokeStyle="#f00",t.strokeRect(e*controller.mapCursorX+1,e*controller.mapCursorY+1,e-2,e-2),view.drawScreenChanges=0},view.fitScreenToDeviceOrientation=function(){var e=controller.screenElement;e.width=TILE_LENGTH*model.mapWidth,e.height=TILE_LENGTH*model.mapHeight,controller.screenWidth=parseInt(window.innerWidth/TILE_LENGTH,10),controller.screenHeight=parseInt(window.innerHeight/TILE_LENGTH,10)},view.ID_DIV_CWTWC_MSG_PANEL="cwt_info_box",view.ID_DIV_CWTWC_MSG_PANEL_CONTENT="cwt_info_box_content",view.DEFAULT_MESSAGE_TIME=1e3,view._hideInfoMessage=function(){var e=document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL);e.className="tooltip out"},view.hasInfoMessage=function(){return"tooltip out"!==document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL).className},view.showInfoMessage=function(e,t){1===arguments.length&&(t=view.DEFAULT_MESSAGE_TIME);var r=document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL);document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL_CONTENT).innerHTML=e,r.className="tooltip active",r.style.position="absolute",r.style.left=parseInt(window.innerWidth/2-r.offsetWidth/2,10)+"px",r.style.top=parseInt(window.innerHeight/2-r.offsetHeight/2,10)+"px",setTimeout(view._hideInfoMessage,t)},view.OVERLAYER={MNTN:!0,FRST:!0},view.drawScreenChanges=0,view.drawScreen=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,!1),view.markForRedraw=function(e,t){if(e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t){if(view.drawScreen[e][t]===!0)return;view.drawScreen[e][t]=!0,view.drawScreenChanges++,t++,model.mapHeight>t&&(null!==model.propertyPosMap[e][t]?view.markForRedraw(e,t):view.OVERLAYER[model.map[e][t]]===!0&&view.markForRedraw(e,t))}else util.logError("illegal arguments ",e,",",t," -> out of view bounds")},view.markForRedrawRange=function(e,t,r){var n,o,i=t-r,a=t+r;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-r+l,o=e+r-l,0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=n;n++)view.markForRedraw(n,i)}},view.markForRedrawWithNeighbours=function(e,t){t>0&&view.markForRedraw(e,t-1),e>0&&view.markForRedraw(e-1,t),view.markForRedraw(e,t),model.mapHeight-1>t&&view.markForRedraw(e,t+1),model.mapWidth-1>e&&view.markForRedraw(e+1,t)},view.markForRedrawWithNeighboursRing=function(e,t){var r=model.mapWidth,n=model.mapHeight;e>0&&(t>0&&view.markForRedraw(e-1,t-1),view.markForRedraw(e-1,t),n-1>t&&view.markForRedraw(e-1,t+1)),t>0&&view.markForRedraw(e,t-1),view.markForRedraw(e,t),n-1>t&&view.markForRedraw(e,t+1),r-1>e&&(t>0&&view.markForRedraw(e+1,t-1),view.markForRedraw(e+1,t),n-1>t&&view.markForRedraw(e+1,t+1))},view.completeRedraw=function(){view.drawScreenChanges=1;for(var e=0,t=model.mapWidth;t>e;e++)for(var r=0,n=model.mapHeight;n>r;r++)view.drawScreen[e][r]=!0},view.markSelectionMapForRedraw=function(e){for(var t=e.selectionCX,r=e.selectionCY,n=e.selectionData,o=0;n.length>o;o++)for(var i=n[o],a=0;i.length>a;a++)-1!==i[a]&&view.markForRedraw(t+o,r+a)},view.spriteAnimation={},view._spriteAnimators=[],view.registerSpriteAnimator=function(e,t,r,n){var o={};o._stps=t,o._tps=r,o._upt=n,o.step=0,o.time=0,view.spriteAnimation[e]=o,view._spriteAnimators.push(o)},view.getSpriteStep=function(e){return view.spriteAnimation[e].step},view.updateSpriteAnimations=function(e){for(var t=view._spriteAnimators,r=0,n=t.length;n>r;r++){var o=t[r];o.time+=e,o.time>=o._tps&&(o.time=0,o.step++,o.step>=o._stps&&(o.step=0),o._upt())}},view.registerSpriteAnimator("SELECTION",7,150,function(){if("MOVEPATH_SELECTION"===controller.stateMachine.state||"IDLE_R"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state)for(var e=0,t=0,r=model.mapWidth,n=model.mapHeight;r>e;e++)for(var o=t;n>o;o++)controller.stateMachine.data.getSelectionValueAt(e,o)>-1&&view.markForRedraw(e,o)}),view.registerSpriteAnimator("STATUS",16,375,function(){}),view.registerSpriteAnimator("UNIT",3,250,function(){for(var e=0,t=0,r=model.mapWidth,n=model.mapHeight;r>e;e++)for(var o=t;n>o;o++)null!==model.unitPosMap[e][o]&&view.markForRedrawWithNeighbours(e,o)}),view.registerSpriteAnimator("PROPERTY",4,400,function(){for(var e=0,t=0,r=model.mapWidth,n=model.mapHeight;r>e;e++)for(var o=t;n>o;o++)null!==model.propertyPosMap[e][o]&&view.markForRedrawWithNeighbours(e,o)}),view.registerCommandHook({key:"AVIS",prepare:function(e,t,r){var n,o,i=t-r,a=t+r;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-r+l,o=e+r-l,0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=n;n++)view.markForRedraw(n,i)}},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"ATUN",prepare:function(e,t,r,n){var o=model.units[e],i=model.units[n];this.step=0,this.time=0,0>=o.hp?(this.x=o.x,this.y=o.y):0>=i.hp?(this.x=i.x,this.y=i.y):this.step=-1},render:function(){var e=this.step;if(-1!==e){var t=view.getInfoImageForType("EXPLOSION_GROUND"),r=this.x,n=this.y,o=TILE_LENGTH,i=48*e,a=0,l=48,s=48,u=r*o,c=n*o,d=o,m=o;view.canvasCtx.drawImage(t,i,a,l,s,u,c,d,m),view.markForRedraw(r,n)}},update:function(e){this.time+=e,this.time>50&&(this.step++,this.time=0)},isDone:function(){return-1===this.step||10===this.step}}),view.registerCommandHook({key:"BDUN",prepare:function(){view.completeRedraw()},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"CTPR",prepare:function(e,t){var r=model.properties[t];20===r.capturePoints?view.showInfoMessage(util.i18n_localized("propertyCaptured")):view.showInfoMessage(util.i18n_localized("propertyPointsLeft")+" "+r.capturePoints)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerCommandHook({key:"EDGM",prepare:function(){view.showInfoMessage(util.i18n_localized("gameHasEnded"),36e5)},render:function(){},update:function(){},isDone:function(){return!1}}),view.registerCommandHook({key:"IVMS",prepare:function(){var e=controller.stateMachine.state,t=controller.stateMachine.data;("ACTION_MENU"===e||"ACTION_SUBMENU"===e)&&controller.showMenu(t.menu,t.menuSize,controller.mapCursorX,controller.mapCursorY)},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"MOVE",prepare:function(e,t,r,n){this.moveAnimationX=r,this.moveAnimationY=n,this.moveAnimationIndex=0,this.moveAnimationPath=e,this.moveAnimationUid=t,this.moveAnimationShift=0,this.moveAnimationDustX=-1,this.moveAnimationDustY=-1,this.moveAnimationDustTime=-1,this.moveAnimationDustStep=-1,this.moveAnimationDustPic=null,view.preventRenderUnit=model.units[t]},update:function(e){var t=TILE_LENGTH;if(this.moveAnimationShift+=e/1e3*8*t,view.markForRedrawWithNeighboursRing(this.moveAnimationX,this.moveAnimationY),-1!==this.moveAnimationDustStep&&(this.moveAnimationDustTime+=e,this.moveAnimationDustTime>30&&(this.moveAnimationDustStep++,this.moveAnimationDustTime=0,3===this.moveAnimationDustStep&&(this.moveAnimationDustStep=-1))),this.moveAnimationShift>t){switch(this.moveAnimationDustX=this.moveAnimationX,this.moveAnimationDustY=this.moveAnimationY,this.moveAnimationDustTime=0,this.moveAnimationDustStep=0,this.moveAnimationPath[this.moveAnimationIndex]){case model.MOVE_CODE_UP:this.moveAnimationY--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_U");break;case model.MOVE_CODE_RIGHT:this.moveAnimationX++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_R");break;case model.MOVE_CODE_DOWN:this.moveAnimationY++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_D");break;case model.MOVE_CODE_LEFT:this.moveAnimationX--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_L")}this.moveAnimationIndex++,this.moveAnimationShift-=t,this.moveAnimationIndex===this.moveAnimationPath.length&&(this.moveAnimationX=0,this.moveAnimationY=0,this.moveAnimationIndex=0,this.moveAnimationPath=null,this.moveAnimationUid=-1,this.moveAnimationShift=0,view.preventRenderUnit=null)}},render:function(){var e,t=this.moveAnimationUid,r=this.moveAnimationX,n=this.moveAnimationY,o=this.moveAnimationShift,i=this.moveAnimationPath[this.moveAnimationIndex],a=model.units[t],l=view.colorArray[a.owner],s=a.type;switch(i){case model.MOVE_CODE_UP:e=view.IMAGE_CODE_UP;break;case model.MOVE_CODE_RIGHT:e=view.IMAGE_CODE_RIGHT;break;case model.MOVE_CODE_DOWN:e=view.IMAGE_CODE_DOWN;break;case model.MOVE_CODE_LEFT:e=view.IMAGE_CODE_LEFT}var u=view.getUnitImageForType(s,e,l),c=TILE_LENGTH,d=controller.baseSize,m=2*d*view.getSpriteStep("UNIT"),p=0,h=2*d,E=2*d,_=r*c-c/2,f=n*c-c/2,v=c+c,T=c+c;switch(i){case model.MOVE_CODE_UP:f-=o;break;case model.MOVE_CODE_LEFT:_-=o;break;case model.MOVE_CODE_RIGHT:_+=o;break;case model.MOVE_CODE_DOWN:f+=o}if(void 0!==u)view.canvasCtx.drawImage(u,m,p,h,E,_,f,v,v);else{switch(_=r*c,f=n*c,v=c,T=c,i){case model.MOVE_CODE_UP:f-=o;break;case model.MOVE_CODE_LEFT:_-=o;break;case model.MOVE_CODE_RIGHT:_+=o;break;case model.MOVE_CODE_DOWN:f+=o}view.canvasCtx.fillStyle="rgb(255,0,0)",view.canvasCtx.fillRect(_,f,v,T)}if(-1!==this.moveAnimationDustStep){var c=TILE_LENGTH;m=2*d*this.moveAnimationDustStep,p=0,h=2*d,E=2*d,_=this.moveAnimationDustX*c-c/2,f=this.moveAnimationDustY*c-c/2,v=c+c,T=c+c,view.canvasCtx.drawImage(this.moveAnimationDustPic,m,p,h,E,_,f,v,T)}},isDone:function(){return-1===this.moveAnimationUid}}),view.registerCommandHook({key:"NXTR",prepare:function(){model.rules.fogEnabled&&view.completeRedraw(),view.showInfoMessage(util.i18n_localized("day")+": "+model.day)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerCommandHook({key:"RVIS",prepare:function(e,t,r){var n,o,i=t-r,a=t+r;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-r+l,o=e+r-l,0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=n;n++)view.markForRedraw(n,i)}},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"SLFR",_check:function(){},_render:function(e,t,r,n){if(!(0>r||r>=10)){var o=TILE_LENGTH,i=48*r,a=0,l=48,s=48,u=e*o,c=t*o,d=o,m=o;view.canvasCtx.drawImage(n,i,a,l,s,u,c,d,m),view.markForRedraw(e,t)}},prepare:function(e,t,r,n,o,i){var a=o,l=i;this.x=a,this.y=l;var s=this._check;s(a,l-2),s(a-1,l-1),s(a,l-1),s(a+1,l-1),s(a-2,l),s(a-1,l),s(a,l),s(a+1,l),s(a+2,l),s(a-1,l+1),s(a,l+1),s(a+1,l+1),s(a,l+2),this.step=0,this.time=0},render:function(){var e=view.getInfoImageForType("EXPLOSION_GROUND"),t=this.step,r=this._render,n=this.x,o=this.y;r(n,o,t,e),t-=1,r(n,o-1,t,e),r(n-1,o,t,e),r(n+1,o,t,e),r(n,o+1,t,e),t-=3,r(n-1,o+1,t,e),r(n+1,o+1,t,e),r(n-1,o-1,t,e),r(n+1,o-1,t,e),r(n,o-2,t,e),r(n,o+2,t,e),r(n-2,o,t,e),r(n+2,o,t,e)},update:function(e){this.time+=e,this.time>50&&(this.step++,this.time=0)},isDone:function(){return 13===this.step}}),view.registerCommandHook({key:"TRWT",prepare:function(e,t){this.time=0,this.xp=e,this.yp=t,this.x=e*TILE_LENGTH,this.y=t*TILE_LENGTH},render:function(){var e=view.getInfoImageForType("TRAPPED");view.canvasCtx.drawImage(e,this.x,this.y)},update:function(e){this.time+=e},isDone:function(){var e=this.time>1e3;if(e)for(var t=view.getInfoImageForType("TRAPPED"),r=this.yp,n=this.xp,o=n+parseInt(t.width/TILE_LENGTH,10);o>=n;n++)view.markForRedraw(n,r);return e}}),view.registerCommandListener("ATUN",function(e,t,r,n){controller.updateUnitStatus(e),controller.updateUnitStatus(n)}),view.registerCommandListener("CTPR",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("CRUN",function(e,t){controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[e][t]))}),view.registerCommandListener("DMUN",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("HEUN",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("GUTP",function(e){var t=model.units[e];controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[t.x][t.y]))}),view.registerCommandListener("LODU",function(e,t){controller.updateUnitStatus(t)}),view.registerCommandListener("JNUN",function(e,t){controller.updateUnitStatus(t)}),view.registerCommandListener("MOVE",function(e,t){controller.updateUnitStatus(t)}),function(){function e(e,t){if(model.isValidPosition(e,t)){var r=model.unitPosMap[e][t];null!==r&&controller.updateUnitStatus(model.extractUnitId(r))}}view.registerCommandListener("SLFR",function(t,r,n,o,i,a){var l=i,s=a;e(l,s-2),e(l-1,s-1),e(l,s-1),e(l+1,s-1),e(l-2,s),e(l-1,s),e(l,s),e(l+1,s),e(l+2,s),e(l-1,s+1),e(l,s+1),e(l+1,s+1),e(l,s+2)}),view.registerCommandListener("SPPL",function(t,r,n){e(r,n-1),e(r-1,n),e(r,n),e(r+1,n),e(r,n+1)})}(),view.registerCommandListener("UNUN",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("LDGM",function(){for(var e=0,t=model.units.length;t>e;e++)model.units[e].owner!==CWT_INACTIVE_ID&&controller.updateUnitStatus(e)}),view.registerCommandListener("AVIS",function(e,t,r){view.markForRedrawRange(e,t,r)}),view.registerCommandListener("RVIS",function(e,t,r){view.markForRedrawRange(e,t,r)}),controller.registerMenuRenderer("BDUN",function(e,t){var r=model.sheets.unitSheets[e].cost;t.innerHTML=util.i18n_localized(e)+" ("+r+"$)"}),controller.registerMenuRenderer("GMTP",function(e,t){t.innerHTML=e+"$"}),controller.infoPanelRender_={tile:function(e,t,r,n,o,i){i.innerHTML=util.i18n_localized(model.map[e][t])},defense:function(e,t,r,n,o,i,a){i.innerHTML=util.i18n_localized("defense"),a.innerHTML=model.sheets.tileSheets[model.map[e][t]].defense
},property:function(e,t,r,n,o,i){o.style.display=null!==n?"table-row":"none",null!==n&&(i.innerHTML=util.i18n_localized(n.type))},capturePoints:function(e,t,r,n,o,i,a){o.style.display=null!==n?"table-row":"none",null!==n&&(i.innerHTML=util.i18n_localized("capturePoints"),a.innerHTML=n.capturePoints)},unit:function(e,t,r,n,o,i){o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized(r.type))},hp:function(e,t,r,n,o,i,a){o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized("health"),a.innerHTML=parseInt(r.hp/10,10)+1)},ammo:function(e,t,r,n,o,i,a){o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized("ammo"),a.innerHTML=r.ammo)},fuel:function(e,t,r,n,o,i,a){o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized("fuel"),a.innerHTML=r.fuel)}},controller.infoPanelRenderComponents_={empty:!0},controller.registerMenuRenderer("__infoPanel__",function(e,t){if(controller.infoPanelRenderComponents_.empty){for(var r=document.getElementsByName("cwt_menu_header_table")[0],n=r.getElementsByTagName("tr"),o=0,i=n.length;i>o;o++){var a=n[o],l=a.getElementsByTagName("td");2!==l.length&&util.raiseError(),controller.infoPanelRenderComponents_[a.attributes.name.value]=[a,l[0],l[1]]}delete controller.infoPanelRenderComponents_.empty}for(var s=Object.keys(controller.infoPanelRenderComponents_),o=0,i=s.length;i>o;o++){var u=s[o],c=controller.infoPanelRender_[u],d=controller.infoPanelRenderComponents_[u],m=model.unitPosMap[e][t],p=model.propertyPosMap[e][t];void 0!==c&&c(e,t,m,p,d[0],d[1],d[2])}}),controller.registerMenuRenderer("__mainMenu__",function(e,t){t.innerHTML=util.i18n_localized(e)}),controller.registerMenuRenderer("UNUN",function(e,t){t.innerHTML=model.units[e].type}),controller.engineAction({name:"colorizeImages",key:"COLI",UNIT_INDEXES:{BLACK_MASK:8,RED:0,BLUE:3,GREEN:4,colors:6},PROPERTY_INDEXES:{RED:0,GRAY:1,BLUE:3,GREEN:4,YELLOW:5,BLACK_MASK:8,colors:4},action:function(){function e(e){var t=document.createElement("canvas"),r=t.getContext("2d"),n=e.width,o=e.height;return t.width=n,t.height=o,r.drawImage(e,0,0),r.getImageData(0,0,n,o).data}function t(e,t,r,n,o,i){var a=document.createElement("canvas"),l=a.getContext("2d"),s=e.width,u=e.height;a.width=s,a.height=u,l.drawImage(e,0,0);for(var c=l.getImageData(0,0,s,u),d=4*n*r,m=4*o*r,p=0,h=0;c.height>h;h++)for(var E=0;c.width>E;E++)for(var _=4*h*c.width+4*E,f=c.data[_],v=c.data[_+1],T=c.data[_+2],g=0,A=4*r;A>g;g+=4){var y=t[d+g],I=t[d+g+1],O=t[d+g+2];if(y===f&&I===v&&O===T){var S=m+g,C=t[S],w=t[S+1],P=t[S+2];c.data[_]=C,c.data[_+1]=w,c.data[_+2]=P,p++}}return util.logInfo("replaced",p,"pixels for the type",i),l.putImageData(c,0,0),a}for(var r=[view.IMAGE_CODE_IDLE,view.IMAGE_CODE_IDLE_INVERTED,view.IMAGE_CODE_DOWN,view.IMAGE_CODE_UP,view.IMAGE_CODE_RIGHT,view.IMAGE_CODE_LEFT],n=e(view.getInfoImageForType(view.IMG_COLOR_MAP_PROPERTIES_ID)),o=e(view.getInfoImageForType(view.IMG_COLOR_MAP_UNITS_ID)),i=CWT_MOD_DEFAULT.graphic.units,a=0,l=i.length;l>a;a++)for(var s=i[a][0],u=0,c=r.length;c>u;u++){var d=r[u],m=view.getUnitImageForType(s,d,view.COLOR_RED);view.setUnitImageForType(t(m,o,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.BLUE,s),s,d,view.COLOR_BLUE),view.setUnitImageForType(t(m,o,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.GREEN,s),s,d,view.COLOR_GREEN),view.setUnitImageForType(t(m,o,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.BLACK_MASK,s),s,d,view.COLOR_BLACK_MASK)}for(var p=CWT_MOD_DEFAULT.graphic.properties,a=0,l=p.length;l>a;a++){var s=p[a][0],m=view.getPropertyImageForType(s,view.COLOR_RED);view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.BLUE),s,view.COLOR_BLUE),view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.GREEN),s,view.COLOR_GREEN),view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.GRAY),s,view.COLOR_NEUTRAL),view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.BLACK_MASK),s,view.COLOR_BLACK_MASK)}}}),controller.engineAction({name:"cutImages",key:"CUTI",action:function(){function e(e,t,r){var n=t?-1:1,o=r?-1:1,i=t?-1*e.width:0,a=r?-1*e.height:0,l=document.createElement("canvas");l.height=e.height,l.width=e.width;var s=l.getContext("2d");return s.save(),s.scale(n,o),s.drawImage(e,i,a,e.width,e.height),s.restore(),l}CWT_MOD_DEFAULT.graphic.baseSize,DEBUG&&util.logInfo("cutting unit commands into single types");for(var t=CWT_MOD_DEFAULT.graphic.units,r=0,n=t.length;n>r;r++){var o,i,a=view.COLOR_RED,l=t[r][0],s=view.getUnitImageForType(l,view.IMAGE_CODE_IDLE,a);o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,0,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_IDLE,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,0,0,96,32,0,0,96,32),view.setUnitImageForType(e(o,!0,!1),l,view.IMAGE_CODE_IDLE_INVERTED,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,288,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_LEFT,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,288,0,96,32,0,0,96,32),view.setUnitImageForType(e(o,!0,!1),l,view.IMAGE_CODE_RIGHT,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,96,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_UP,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,192,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_DOWN,a)}DEBUG&&util.logInfo("cutting unit commands into single types done"),DEBUG&&util.logInfo("cutting misc into single types");for(var u=CWT_MOD_DEFAULT.graphic.misc,r=0,n=u.length;n>r;r++){var c=u[r];if(c.length>2){var s=view.getInfoImageForType(c[0]);o=document.createElement("canvas"),i=o.getContext("2d"),c.length>6?c[6]===!0?(o.height=32,o.width=96,o=e(o,!0,!1),i=o.getContext("2d")):(o.height=16,o.width=16,i.save(),i.translate(8,8),i.rotate(c[6]*Math.PI/180),i.translate(-8,-8)):(o.height=16,o.width=16),c.length>6&&c[6]===!0?i.drawImage(s,c[2],c[3],c[4],c[5],0,0,96,32):i.drawImage(s,c[2],c[3],c[4],c[5],0,0,16,16),c.length>6&&i.restore(),view.setInfoImageForType(o,c[0])}}DEBUG&&util.logInfo("cutting misc into single types done")}}),controller.engineAction({name:"loadConfig",key:"LCFG",action:function(){var e=controller.storage.get("CWT_CONFIG");null===e&&(e={lastUpdate:new Date},controller.storage.set("CWT_CONFIG",e))}}),controller.engineAction({name:"loadImages",key:"LOIM",action:function(){controller.lockCommandEvaluation=!0;var e="../../../image/",t=function(e){for(var t=0,r=e.length;r>t;t++)if(e[t].complete!==!0)return!1;return!0},r=function(r,n){for(var o,i=[],a=[],l=0,s=r.length;s>l;l++)o=new Image,o.src=e+r[l][1],i[l]=o,a[l]=r[l][0];var u=function(){t(i)?n(a,i):setTimeout(u,250)};u()},n=4;r(CWT_MOD_DEFAULT.graphic.units,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setUnitImageForType(t[r],e[r],view.IMAGE_CODE_IDLE,view.COLOR_RED);n--}),r(CWT_MOD_DEFAULT.graphic.properties,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setPropertyImageForType(t[r],e[r],view.COLOR_RED);n--}),r(CWT_MOD_DEFAULT.graphic.tiles,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setTileImageForType(t[r],e[r]);n--}),r(CWT_MOD_DEFAULT.graphic.misc,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setInfoImageForType(t[r],e[r]);n--});var o=function(){0===n?controller.lockCommandEvaluation=!1:setTimeout(o,250)};o()}}),controller.INPUT_KEYBOARD_CODE_LEFT=37,controller.INPUT_KEYBOARD_CODE_UP=38,controller.INPUT_KEYBOARD_CODE_RIGHT=39,controller.INPUT_KEYBOARD_CODE_DOWN=40,controller.INPUT_KEYBOARD_CODE_BACKSPACE=8,controller.INPUT_KEYBOARD_CODE_ENTER=13,controller.INPUT_KEYBOARD_CODE_M=77,controller.INPUT_KEYBOARD_CODE_N=78,controller.engineAction({name:"loadInputDevices",key:"LOID",action:function(){var e=new DeviceDetection(navigator.userAgent);if(e.isDesktop()&&(document.onkeyup=function(){if("IDLE_R"===controller.stateMachine.state)switch(code){case controller.INPUT_KEYBOARD_CODE_LEFT:case controller.INPUT_KEYBOARD_CODE_UP:case controller.INPUT_KEYBOARD_CODE_RIGHT:case controller.INPUT_KEYBOARD_CODE_DOWN:case controller.INPUT_KEYBOARD_CODE_BACKSPACE:case controller.INPUT_KEYBOARD_CODE_ENTER:return controller.cursorActionCancel(),!1}},document.onkeydown=function(e){var t=controller.stateMachine.state,r="ACTION_MENU"===t||"ACTION_SUBMENU"===t,n=e.keyCode;switch(n){case controller.INPUT_KEYBOARD_CODE_LEFT:controller.moveCursor(model.MOVE_CODE_LEFT,1);break;case controller.INPUT_KEYBOARD_CODE_UP:r?controller.decreaseMenuCursor():controller.moveCursor(model.MOVE_CODE_UP,1);break;case controller.INPUT_KEYBOARD_CODE_RIGHT:controller.moveCursor(model.MOVE_CODE_RIGHT,1);break;case controller.INPUT_KEYBOARD_CODE_DOWN:r?controller.increaseMenuCursor():controller.moveCursor(model.MOVE_CODE_DOWN,1);break;case controller.INPUT_KEYBOARD_CODE_BACKSPACE:controller.cursorActionCancel();break;case controller.INPUT_KEYBOARD_CODE_ENTER:controller.cursorActionClick();break;case controller.INPUT_KEYBOARD_CODE_M:3>controller.screenScale&&controller.setScreenScale(controller.screenScale+1);break;case controller.INPUT_KEYBOARD_CODE_N:controller.screenScale>1&&controller.setScreenScale(controller.screenScale-1)}switch(n){case controller.INPUT_KEYBOARD_CODE_LEFT:case controller.INPUT_KEYBOARD_CODE_UP:case controller.INPUT_KEYBOARD_CODE_RIGHT:case controller.INPUT_KEYBOARD_CODE_DOWN:case controller.INPUT_KEYBOARD_CODE_BACKSPACE:case controller.INPUT_KEYBOARD_CODE_ENTER:case controller.INPUT_KEYBOARD_CODE_M:case controller.INPUT_KEYBOARD_CODE_N:return!1}}),e.isDesktop()){var t=document.getElementById("cwt_canvas");t.onmousemove=function(e){var t,r;"number"==typeof e.offsetX?(t=e.offsetX,r=e.offsetY):(t=e.layerX,r=e.layerY);var t=parseInt(t/16,10),r=parseInt(r/16,10);controller.setCursorPosition(t,r)},t.onmousedown=function(e){switch(e.which){case 1:controller.cursorActionClick();break;case 2:break;case 3:controller.cursorActionCancel()}},t.onmouseup=function(e){if("IDLE_R"===controller.stateMachine.state)switch(e.which){case 3:controller.cursorActionCancel()}}}if(e.isAndroid()||e.isTouchDevice()){var r=document.getElementById("cwt_canvas"),n=new Hammer(r,{prevent_default:!0});n.ontap=function(e){var t=e.position[0].x,r=e.position[0].y,n=controller.screenScale*TILE_LENGTH,t=parseInt(t/n,10),r=parseInt(r/n,10);t+=controller.screenX,r+=controller.screenY,controller.setCursorPosition(t,r),controller.cursorActionClick()},n.onhold=function(){controller.cursorActionCancel()},n.onrelease=function(){"IDLE_R"===controller.stateMachine.state&&controller.cursorActionCancel()},n.ondrag=function(){},n.ondragend=function(e){var t=TILE_LENGTH*controller.screenScale,r=e.angle,n=0;r>=-135&&-45>r?n=model.MOVE_CODE_UP:r>=-45&&45>r?n=model.MOVE_CODE_RIGHT:r>=45&&135>r?n=model.MOVE_CODE_DOWN:(r>=135||-135>r)&&(n=model.MOVE_CODE_LEFT);var o=parseInt(e.distance/t,10);0===o&&(o=1),controller.shiftScreenPosition(n,o)},n.ontransformend=function(e){return e.scale>1?3>controller.screenScale&&controller.setScreenScale(controller.screenScale+1):controller.screenScale>1&&controller.setScreenScale(controller.screenScale-1),!1}}}}),controller.engineAction({name:"loadSounds",key:"LOSO",action:function(){}}),controller.engineAction({name:"startRendering",key:"STRE",action:function(){controller.noRendering=!1,view.fitScreenToDeviceOrientation(),view.completeRedraw()}}),function(){for(var e=[["chrome",18,19,20,21,22,23,24],["mozilla",17,18,19],["safari",5,6]],t=!1,r=0,n=e.length;n>r;r++){var o=e[r];if(BrowserDetection[o[0]]===!0){t=!0;for(var i=!1,a=1,l=o.length;l>a;a++)0===BrowserDetection.version.indexOf(o[a])&&(i=!0);t||alert("Attention!\nThe version of your browser is not supported!")}}t||alert("Attention!\nYour browser is not supported!"),util.injectMod=function(e){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",e+".js"),document.getElementsByTagName("head")[0].appendChild(t)},controller.storage.has("mod")?util.injectMod(controller.storage.get("mod")):util.injectMod("mod"),util.i18n_setLanguage("en"),controller.pushSharedAction("LDMD"),controller.pushSharedAction("LOIM"),controller.pushSharedAction("CUTI"),controller.pushSharedAction("COLI"),controller.pushSharedAction("LOID"),controller.pushSharedAction("LOSO"),controller.pushSharedAction(testMapNew,"LDGM"),controller.pushSharedAction("LCFG"),controller.pushSharedAction("STRE")}();