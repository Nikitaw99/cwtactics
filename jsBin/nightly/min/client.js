view={};var ID_MENU_SECTION_VERSION="cwt_versus_screen",ID_ELMT_SECTION_VERSION_LIST="map_selection_field",ID_ELMT_SECTION_VERSION_START="versus_start",ID_ELMT_SECTION_MOBILE="cwt_mobileSound_screen",ID_ELMT_SECTION_MOBILE_NEXT="mobileSoundNext",ID_MENU_SECTION_LOAD="cwt_load_screen",ID_MENU_SECTION_MAIN="cwt_main_screen",ID_ELMT_SECTION_MAIN_ERROR="main_screen_error_msg",ID_ELMT_SECTION_MAIN_BTN_1="main_screen_enter_1",ID_ELMT_SECTION_MAIN_BTN_2="main_screen_enter_2",ID_ELMT_SECTION_MAIN_BTN_3="main_screen_enter_3",ID_ELMT_SECTION_MAIN_BTN_4="main_screen_enter_4",ID_ELMT_SECTION_MAIN_BTN_5="main_screen_enter_5",ID_ELMT_SECTION_MAIN_BTN_6="main_screen_enter_6",ID_MENU_SECTION_GAME="cwt_game_screen",ID_ELMT_GAME_CANVAS="cwt_canvas",ID_ELMT_GAME_MENU="cwt_menu",ID_ELMT_MENU="cwt_menu",ID_ELMT_MENU_HEADER="cwt_menu_header",ID_ELMT_MENU_CONTENT="cwt_menu_content",ID_ELMT_MENU_ENTRIES="cwt_menu_entries",ID_MENU_SECTION_ERROR="cwt_error_screen",ID_ELMT_ERROR_MSG="error_screen_errorMsgField",ID_MENU_SECTION_OPTIONS="cwt_options_screen",ID_ELMT_OTIONS_SFX_VOL="cwt_options_sfxVolume",ID_ELMT_OTIONS_MUSIC_VOL="cwt_options_musicVolume",ID_ELMT_OTIONS_MOD_INFO="cwt_options_modPath",ID_ELMT_OTIONS_MOD_TAKE="cwt_options_modPath_take",ID_ELMT_OTIONS_RESET="cwt_options_reset",ID_ELMT_OTIONS_GOBACK="cwt_options_goBack",ID_ELMT_UNITINFOBOX="cwt_unitinfo_box",ID_ELMT_UNITINFOBOX_NAME="cwt_unitinfo_name",ID_ELMT_UNITINFOBOX_PIC="cwt_unitinfo_picture",ID_ELMT_UNITINFOBOX_DESC="cwt_unitinfo_description",ID_ELMT_UNITINFOBOX_CLASS_D="cwt_unitinfo_class_D",ID_ELMT_UNITINFOBOX_CLASS="cwt_unitinfo_class_C",ID_ELMT_UNITINFOBOX_MVTP_D="cwt_unitinfo_movetype_D",ID_ELMT_UNITINFOBOX_MVTP="cwt_unitinfo_movetype_C",ID_ELMT_UNITINFOBOX_MAINWP_D="cwt_unitinfo_mainwp_D",ID_ELMT_UNITINFOBOX_MAINWP="cwt_unitinfo_mainwp_C",ID_ELMT_UNITINFOBOX_SECWP_D="cwt_unitinfo_secwp_D",ID_ELMT_UNITINFOBOX_SECWP="cwt_unitinfo_secwp_C",ID_ELMT_UNITINFOBOX_HP_D="cwt_unitinfo_HP_D",ID_ELMT_UNITINFOBOX_HP="cwt_unitinfo_HP_C",ID_ELMT_UNITINFOBOX_GAS_D="cwt_unitinfo_Gas_D",ID_ELMT_UNITINFOBOX_GAS="cwt_unitinfo_Gas_C",ID_ELMT_UNITINFOBOX_GAS2="cwt_unitinfo_Gas_C2",ID_ELMT_UNITINFOBOX_AMMO_D="cwt_unitinfo_Ammo_D",ID_ELMT_UNITINFOBOX_AMMO="cwt_unitinfo_Ammo_C",ID_ELMT_UNITINFOBOX_AMMO2="cwt_unitinfo_Ammo_C2",ID_ELMT_UNITINFOBOX_MVRANGE_D="cwt_unitinfo_mvrange_D",ID_ELMT_UNITINFOBOX_MVRANGE="cwt_unitinfo_mvrange_C",ID_ELMT_UNITINFOBOX_VISION_D="cwt_unitinfo_vision_D",ID_ELMT_UNITINFOBOX_VISION="cwt_unitinfo_vision_C",ID_ELMT_UNITINFOBOX_ATTRANGE_D="cwt_unitinfo_attrange_D",ID_ELMT_UNITINFOBOX_ATTRANGE="cwt_unitinfo_attrange_C",ID_ELMT_UNITINFOBOX_ATTRANGE2="cwt_unitinfo_attrange_C2",ID_ELMT_UNITINFOBOX_AG_INF_D="cwt_unitinfo_against_inf_D",ID_ELMT_UNITINFOBOX_AG_INF="cwt_unitinfo_against_inf_C",ID_ELMT_UNITINFOBOX_AG_VEH_D="cwt_unitinfo_against_veh_D",ID_ELMT_UNITINFOBOX_AG_VEH="cwt_unitinfo_against_veh_C",ID_ELMT_UNITINFOBOX_AG_AIR_D="cwt_unitinfo_against_air_D",ID_ELMT_UNITINFOBOX_AG_AIR="cwt_unitinfo_against_air_C",ID_ELMT_UNITINFOBOX_AG_HELI_D="cwt_unitinfo_against_heli_D",ID_ELMT_UNITINFOBOX_AG_HELI="cwt_unitinfo_against_heli_C",ID_ELMT_UNITINFOBOX_AG_SHIP_D="cwt_unitinfo_against_ship_D",ID_ELMT_UNITINFOBOX_AG_SHIP="cwt_unitinfo_against_ship_C",ID_ELMT_UNITINFOBOX_AG_SUB_D="cwt_unitinfo_against_sub_D",ID_ELMT_UNITINFOBOX_AG_SUB="cwt_unitinfo_against_sub_C",ID_ELMT_TILEINFOBOX="cwt_tileinfo_box",ID_ELMT_TILEINFOBOX_NAME="cwt_tileinfo_name",ID_ELMT_TILEINFOBOX_PIC="cwt_tileinfo_picture",ID_ELMT_TILEINFOBOX_DESC="cwt_tileinfo_description",ID_ELMT_TILEINFOBOX_DEFENSE_D="cwt_tileinfo_defense_D",ID_ELMT_TILEINFOBOX_DEFENSE="cwt_tileinfo_defense_C",ID_ELMT_TILEINFOBOX_OWNER_D="cwt_tileinfo_owner_D",ID_ELMT_TILEINFOBOX_OWNER="cwt_tileinfo_owner_C",ID_ELMT_TILEINFOBOX_CAPPT_D="cwt_tileinfo_capturePoints_D",ID_ELMT_TILEINFOBOX_CAPPT="cwt_tileinfo_capturePoints_C",ID_ELMT_PLAYERINFOBOX="cwt_playerinfo_box",ID_ELMT_PLAYERINFOBOX_NAME="cwt_playerinfo_name",ID_ELMT_PLAYERINFOBOX_PIC="cwt_playerinfo_picture",ID_ELMT_PLAYERINFOBOX_DESC="cwt_playerinfo_description",ID_ELMT_PLAYERINFOBOX_POWER_D="cwt_playerinfo_coPower_D",ID_ELMT_PLAYERINFOBOX_POWER="cwt_playerinfo_coPower_C",ID_ELMT_PLAYERINFOBOX_PROPS_D="cwt_playerinfo_numberProp_D",ID_ELMT_PLAYERINFOBOX_PROPS="cwt_playerinfo_numberProp_C",ID_ELMT_PLAYERINFOBOX_UNITS_D="cwt_playerinfo_numberUnits_D",ID_ELMT_PLAYERINFOBOX_UNITS="cwt_playerinfo_numberUnits_C";util.scoped(function(){function e(){return DEBUG&&util.log("dropped input"),this.BREAK_TRANSITION}controller.stateParent={UP:e,LEFT:e,RIGHT:e,DOWN:e,SPECIAL_1:e,SPECIAL_2:e,SPECIAL_3:e,SPECIAL_4:e,SPECIAL_5:e,SPECIAL_6:e,ACTION:e,CANCEL:e,HOVER:e}}),util.singleLazyCall=function(e){var t=!1;return function(){t&&util.raiseError("this function cannot be called twice"),e.apply(null,arguments)}},util.scoped(function(){function e(){if(4==this.readyState)if(4==this.readyState&&200==this.status)if(util.log("grabbed file successfully"),this.asJSON)try{this.winCallback(JSON.parse(this.responseText))}catch(e){this.failCallback(e)}else this.winCallback(this.responseText);else util.log("could not grab file"),this.failCallback(this.statusText)}var t;try{new XMLHttpRequest,t=!0}catch(o){t=!1}util.grabRemoteFile=function(o){var n;util.log("try to grab file",o.path),n=t?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n.asJSON=o.json,n.winCallback=o.success,n.failCallback=o.error,n.onreadystatechange=e,n.open("get",o.path,!0),n.send()}}),util.scoped(function(){"use strict";var e=window.navigator.userAgent.toLowerCase(),t=/mobile|android|kindle|silk|midp|(windows nt 6\.2.+arm|touch)/.test(e);e=/(chrome|firefox)[ \/]([\w.]+)/.exec(e)||/(iphone|ipad|ipod)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(android)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(webkit|opera)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||[];var o=e[1],n=parseFloat(e[2]);switch(o){case"msie":o="ie",n=doc.documentMode||n;break;case"firefox":o="ff";break;case"ipod":case"ipad":case"iphone":o="ios";break;case"webkit":o="safari"}window.Browser={name:o,mobile:t,version:n},Browser[o]=!0}),controller.colorizeImages=util.singleLazyCall(function(e,t){function o(e){var t=document.createElement("canvas"),o=t.getContext("2d"),n=e.width,r=e.height;return t.width=n,t.height=r,o.drawImage(e,0,0),o.getImageData(0,0,n,r).data}function n(e,t,o,n,r){var i=document.createElement("canvas"),a=i.getContext("2d"),l=e.width,s=e.height;i.width=l,i.height=s,a.drawImage(e,0,0);for(var c=a.getImageData(0,0,l,s),u=4*n*o,d=4*r*o,m=0,_=0;c.height>_;_++)for(var p=0;c.width>p;p++)for(var E=4*_*c.width+4*p,f=c.data[E],h=c.data[E+1],I=c.data[E+2],v=0,g=4*o;g>v;v+=4){var T=t[u+v],y=t[u+v+1],M=t[u+v+2];if(T===f&&y===h&&M===I){var O=d+v,w=t[O],A=t[O+1],C=t[O+2];c.data[E]=w,c.data[E+1]=A,c.data[E+2]=C,m++}}return a.putImageData(c,0,0),i}if(e)return DEBUG&&util.log("break at colorize images due error from previous inits"),t.pass(!0);DEBUG&&util.log("colorize images"),t.take();try{for(var r=model.graphics,i={BLACK_MASK:8,RED:0,BLUE:3,GREEN:4,colors:6},a={RED:0,GRAY:1,BLUE:3,GREEN:4,YELLOW:5,BLACK_MASK:8,colors:4},l=[view.IMAGE_CODE_IDLE,view.IMAGE_CODE_IDLE_INVERTED,view.IMAGE_CODE_DOWN,view.IMAGE_CODE_UP,view.IMAGE_CODE_RIGHT,view.IMAGE_CODE_LEFT],s=o(view.getInfoImageForType(view.IMG_COLOR_MAP_PROPERTIES_ID)),c=o(view.getInfoImageForType(view.IMG_COLOR_MAP_UNITS_ID)),u=r.units,d=0,m=u.length;m>d;d++)for(var _=u[d][0],p=0,E=l.length;E>p;p++){var f=l[p],h=view.getUnitImageForType(_,f,view.COLOR_RED);view.setUnitImageForType(n(h,c,i.colors,i.RED,i.BLUE,_),_,f,view.COLOR_BLUE),view.setUnitImageForType(n(h,c,i.colors,i.RED,i.GREEN,_),_,f,view.COLOR_GREEN),view.setUnitImageForType(n(h,c,i.colors,i.RED,i.BLACK_MASK,_),_,f,view.COLOR_BLACK_MASK)}for(var I=r.properties,d=0,m=I.length;m>d;d++){var _=I[d][0],h=view.getPropertyImageForType(_,view.COLOR_RED);view.setPropertyImageForType(n(h,s,a.colors,a.RED,a.BLUE),_,view.COLOR_BLUE),view.setPropertyImageForType(n(h,s,a.colors,a.RED,a.GREEN),_,view.COLOR_GREEN),view.setPropertyImageForType(n(h,s,a.colors,a.RED,a.GRAY),_,view.COLOR_NEUTRAL),view.setPropertyImageForType(n(h,s,a.colors,a.RED,a.BLACK_MASK),_,view.COLOR_BLACK_MASK)}t.pass(!1)}catch(m){controller.loadError=m,t.pass(!0)}}),controller.cutImages=util.singleLazyCall(function(e,t){function o(e,t,o){var n=t?-1:1,r=o?-1:1,i=t?-1*e.width:0,a=o?-1*e.height:0,l=document.createElement("canvas");l.height=e.height,l.width=e.width;var s=l.getContext("2d");return s.save(),s.scale(n,r),s.drawImage(e,i,a,e.width,e.height),s.restore(),l}if(e)return DEBUG&&util.log("break at cutting images due error from previous inits"),t.pass(!0);DEBUG&&util.log("cutting images"),t.take();try{var n=model.graphics;n.baseSize,DEBUG&&util.log("cutting unit commands into single types");for(var r=n.units,i=0,a=r.length;a>i;i++){var l,s,c=view.COLOR_RED,u=r[i][0],d=view.getUnitImageForType(u,view.IMAGE_CODE_IDLE,c);l=document.createElement("canvas"),l.height=32,l.width=96,s=l.getContext("2d"),s.drawImage(d,0,0,96,32,0,0,96,32),view.setUnitImageForType(l,u,view.IMAGE_CODE_IDLE,c),l=document.createElement("canvas"),l.height=32,l.width=96,s=l.getContext("2d"),s.drawImage(d,0,0,96,32,0,0,96,32),view.setUnitImageForType(o(l,!0,!1),u,view.IMAGE_CODE_IDLE_INVERTED,c),l=document.createElement("canvas"),l.height=32,l.width=96,s=l.getContext("2d"),s.drawImage(d,288,0,96,32,0,0,96,32),view.setUnitImageForType(l,u,view.IMAGE_CODE_LEFT,c),l=document.createElement("canvas"),l.height=32,l.width=96,s=l.getContext("2d"),s.drawImage(d,288,0,96,32,0,0,96,32),view.setUnitImageForType(o(l,!0,!1),u,view.IMAGE_CODE_RIGHT,c),l=document.createElement("canvas"),l.height=32,l.width=96,s=l.getContext("2d"),s.drawImage(d,96,0,96,32,0,0,96,32),view.setUnitImageForType(l,u,view.IMAGE_CODE_UP,c),l=document.createElement("canvas"),l.height=32,l.width=96,s=l.getContext("2d"),s.drawImage(d,192,0,96,32,0,0,96,32),view.setUnitImageForType(l,u,view.IMAGE_CODE_DOWN,c)}DEBUG&&util.log("cutting unit commands into single types done"),DEBUG&&util.log("cutting misc into single types");for(var m=n.misc,i=0,a=m.length;a>i;i++){var _=m[i];if(_.length>2){var d=view.getInfoImageForType(_[0]);l=document.createElement("canvas"),s=l.getContext("2d"),_.length>6?_[6]===!0?(l.height=32,l.width=96,l=o(l,!0,!1),s=l.getContext("2d")):(l.height=16,l.width=16,s.save(),s.translate(8,8),s.rotate(_[6]*Math.PI/180),s.translate(-8,-8)):(l.height=16,l.width=16),_.length>6&&_[6]===!0?s.drawImage(d,_[2],_[3],_[4],_[5],0,0,96,32):s.drawImage(d,_[2],_[3],_[4],_[5],0,0,16,16),_.length>6&&s.restore(),view.setInfoImageForType(l,_[0])}}DEBUG&&util.log("cutting misc into single types done"),t.pass(!1)}catch(a){controller.loadError=a,t.pass(!0)}}),util.scoped(function(){function e(e,t,o){var i=e[e.curStep_].id,a=e[e.curStep_].src,l=e[e.curStep_].music,s=e[e.curStep_].co_music;return r&&(s||l)?(util.log("ignoring co music because device has iOS"),o(e,t),void 0):(controller.storage.has(i,function(r){if(r)DEBUG&&util.log(i,"is in storage"),controller.storage.get(i,function(r){DEBUG&&util.log(i,"will be cached");try{var a=Base64Helper.decodeBuffer(r.value);n.decodeAudioData(a,function(n){controller.registerSoundFile(i,n),o(e,t)},function(e){controller.loadError=e,t.pass(!0)})}catch(l){controller.loadError=l,t.pass(!0)}});else{DEBUG&&util.log("load",i,"with HTTP request");var l=new XMLHttpRequest;l.open("GET",a,!0),l.responseType="arraybuffer",l.onload=function(){if(404===this.status)return controller.loadError="failed to load music file "+i,t.pass(!0),void 0;var r=l.response;DEBUG&&util.log("saving",i,"in storage"),controller.storage.set(i,Base64Helper.encodeBuffer(r),function(){DEBUG&&util.log("saved",i,"successfully in storage"),n.decodeAudioData(r,function(n){controller.registerSoundFile(i,n),o(e,t)},function(e){controller.loadError=e,t.pass(!0)})})},l.send()}}),void 0)}function t(e,t){return e===!0?(controller.loadError="could not grab music",t.pass(!0)):(e.curStep_++,e.curStep_===e.length?(util.log("finished initializing audio system"),t.pass(!1)):o(e,t),void 0)}function o(o,n){e(o,n,t)}var n,r=Browser.ios;controller.loadSoundFiles=util.singleLazyCall(function(e,t){if(e)return DEBUG&&util.log("break at init audio system due error from previous inits"),t.pass(!0);if(util.log("init audio system"),n=controller.audioContext(),null===n)return!1;if(t.take(),model.sounds.length>0){var r=[];r.curStep_=0;for(var i=0,a=model.sounds.length;a>i;i++)r[i]=model.sounds[i];o(r,t)}else t.pass(!1)})}),controller.loadImages=util.singleLazyCall(function(e,t){function o(e){DEBUG&&util.log("saved image type",e.key)}function n(){var e=this.mode_,t=this.baton_,n=this.list_,r=this.pickey_,i=this.saveIt_;switch(i&&controller.storage.set(r,Base64Helper.canvasToBase64(this),o),delete this.pickey_,delete this.baton_,delete this.list_,delete this.mode_,delete this.saveIt_,e){case"UNIT":view.setUnitImageForType(this,r,view.IMAGE_CODE_IDLE,view.COLOR_RED);break;case"PROPERTY":view.setPropertyImageForType(this,r,view.COLOR_RED);break;case"TILE":view.setTileImageForType(this,r);break;case"MISC":view.setInfoImageForType(this,r);break;default:util.raiseError("unknown mode key",e)}n.curStep_===n.length&&(s++,n=c.length>s?c[s]:null),t.pass(n)}function r(e,t){e===!0&&t.pass(!0),t.take(),e.curStep_===e.length&&util.raiseError("illegal index");var o=e[e.curStep_];e.curStep_++,img=new Image,img.pickey_=o[0],img.baton_=t,img.mode_=e.mode_,img.list_=e,img.saveIt_=!1,img.onerror=function(){controller.loadError={message:"could not load image "+img.pickey_},t.pass(!0)},"ANIMATED"===o[2]?view.animatedTiles[img.pickey_]=!0:"OVERLAYER"===o[2]&&(view.overlayImages[img.pickey_]=!0),controller.storage.has(o[0],function(e){e?controller.storage.get(o[0],function(e){img.onload=n,img.src="data:image/png;base64,"+e.value}):(img.saveIt_=!0,img.onload=n,img.src=o[1])})}if(e)return DEBUG&&util.log("break at load images due error from previous inits"),t.pass(!0);t.take();var i,a,l=model.graphics;l.units.curStep_=0,l.units.mode_="UNIT",l.properties.curStep_=0,l.properties.mode_="PROPERTY",l.tiles.curStep_=0,l.tiles.mode_="TILE",l.misc.curStep_=0,l.misc.mode_="MISC";var s=0,c=[l.units,l.properties,l.tiles,l.misc],u=jWorkflow.order(function(){return DEBUG&&util.log("start loading images"),c[0]});for(i=0,a=l.units.length;a>i;i++)u.andThen(r);for(i=0,a=l.properties.length;a>i;i++)u.andThen(r);for(i=0,a=l.tiles.length;a>i;i++)u.andThen(r);for(i=0,a=l.misc.length;a>i;i++)u.andThen(r);u.andThen(function(e){e===!0?(DEBUG&&util.log("failed to load images"),t.pass(!0)):(DEBUG&&util.log("finished loading images"),t.pass(!1))}).start()}),controller.loadInputDevices=util.singleLazyCall(function(e,t){function o(e){if(controller.inputCoolDown>0)return!1;if(controller.menuVisible)return!1;var t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));t>0?controller.screenStateMachine.event("SPECIAL_5"):controller.screenStateMachine.event("SPECIAL_6"),controller.inputCoolDown=1e3}var n=37,r=38,i=39,a=40,l=8,s=13,c=49,u=50,d=51,m=52,_=53,p=54;t.take(),DEBUG&&util.log("loading input devices"),document.getElementById(ID_ELMT_GAME_CANVAS);var E=document.getElementById(ID_ELMT_GAME_MENU);if(head.desktop){DEBUG&&util.log("initializing keyboard support"),document.onkeydown=function(e){var t=e.keyCode;if("cwt_options_mapIn"===event.target.id){switch(t){case r:return controller.screenStateMachine.event("UP",1),!1;case a:return controller.screenStateMachine.event("DOWN",1),!1}return!0}switch(t){case c:return controller.screenStateMachine.event("SPECIAL_1"),!1;case u:return controller.screenStateMachine.event("SPECIAL_2"),!1;case d:return controller.screenStateMachine.event("SPECIAL_3"),!1;case m:return controller.screenStateMachine.event("SPECIAL_4"),!1;case _:return controller.screenStateMachine.event("SPECIAL_5"),!1;case p:return controller.screenStateMachine.event("SPECIAL_6"),!1;case n:return controller.screenStateMachine.event("LEFT",1),!1;case r:return controller.screenStateMachine.event("UP",1),!1;case i:return controller.screenStateMachine.event("RIGHT",1),!1;case a:return controller.screenStateMachine.event("DOWN",1),!1;case l:return controller.screenStateMachine.event("CANCEL"),!1;case s:return controller.screenStateMachine.event("ACTION"),!1}return!0},DEBUG&&util.log("initializing mouse support");var f=!1;E.onmouseout=function(){f=!1},E.onmouseover=function(){f=!0},document.addEventListener&&(document.addEventListener("mousewheel",o,!1),document.addEventListener("DOMMouseScroll",o,!1));var h=TILE_LENGTH,I=0,v=0,g=0;document.addEventListener("mousemove",function(e){var t=e.target.id;if("cwt_canvas"===t||controller.menuVisible){var o,n;e=e||window.event,controller.menuVisible?(o=e.pageX,n=e.pageY,-1!==g?g-16>=n?(controller.screenStateMachine.event("UP"),g=n):n>=g+16&&(controller.screenStateMachine.event("DOWN"),g=n):g=n):("number"==typeof e.offsetX?(o=e.offsetX,n=e.offsetY):(o=e.layerX,n=e.layerY),o=parseInt(o/h,10),n=parseInt(n/h,10),controller.screenStateMachine.event("HOVER",o,n))}}),document.onmousedown=function(e){e=e||window.event,"number"==typeof e.offsetX?(I=e.offsetX,v=e.offsetY):(I=e.layerX,v=e.layerY)},document.onmouseup=function(e){e=e||window.event;var t,o;switch("number"==typeof e.offsetX?(t=e.offsetX,o=e.offsetY):(t=e.layerX,o=e.layerY),Math.abs(I-t),Math.abs(v-o),g=-1,e.which){case 1:controller.screenStateMachine.event("ACTION");break;case 2:break;case 3:controller.screenStateMachine.event("CANCEL")}}}head.mobile&&util.scoped(function(){var e,t,o,n,r,i,a,l,s,c,u,d=0,m=!1;document.addEventListener("touchstart",function(u){if("cwt_options_mapIn"!==u.target.id&&u.preventDefault(),e=u.touches[0].screenX,t=u.touches[0].screenY,o=e,n=t,m=!1,2===u.touches.length){r=u.touches[1].screenX,i=u.touches[1].screenY,a=r,l=i;var d=Math.abs(e-r),_=Math.abs(t-i);c=Math.sqrt(d*d+_*_)}else r=-1;s=u.timeStamp},!1),document.addEventListener("touchmove",function(i){if("cwt_options_mapIn"!==i.target.id&&i.preventDefault(),o=i.touches[0].screenX,n=i.touches[0].screenY,2===i.touches.length){a=i.touches[1].screenX,l=i.touches[1].screenY;var c=Math.abs(o-a),_=Math.abs(n-l);u=Math.sqrt(c*c+_*_)}else r=-1;var c=Math.abs(e-o),_=Math.abs(t-n),p=Math.sqrt(c*c+_*_),E=i.timeStamp-s;if(p>16&&E>300)if(m=!0,d>75){var f;f=c>_?e>o?"LEFT":"RIGHT":t>n?"UP":"DOWN",d=0,e=o,t=n,controller.screenStateMachine.event(f,1)}else d+=E},!1),document.addEventListener("touchend",function(i){if("cwt_options_mapIn"!==i.target.id&&i.preventDefault(),!(controller.inputCoolDown>0)){var a=Math.abs(e-o),l=Math.abs(t-n),d=Math.sqrt(a*a+l*l),m=i.timeStamp-s;if(-1!==r){var _=Math.abs(u-c);if(32>=_)if(a>48||l>48){var p;p=a>l?e>o?"SPECIAL_2":"SPECIAL_1":t>n?"SPECIAL_3":"SPECIAL_4",controller.screenStateMachine.event(p)}else controller.screenStateMachine.event("CANCEL");else c>u?controller.screenStateMachine.event("SPECIAL_6"):controller.screenStateMachine.event("SPECIAL_5");controller.inputCoolDown=500}else if(16>=d)500>=m&&controller.screenStateMachine.event("ACTION");else if(300>=m){var p;p=a>l?e>o?"LEFT":"RIGHT":t>n?"UP":"DOWN",controller.screenStateMachine.event(p,1)}}},!1)}),t.pass(!1)}),controller.mapList=[],controller.loadMaps=util.singleLazyCall(function(e,t){function o(e,t){if(e===!0)return!0;t.take();var o=r[n];controller.storage.get(o,function(e){null===e?util.grabRemoteFile({path:o,json:!0,error:function(e){controller.loadError=e,t.pass(!0)},success:function(e){DEBUG&&util.log("map grabbed, saving as",o),controller.storage.set(o,e,function(){n++,controller.mapList.push({name:e.name,key:o}),t.pass()})}}):(n++,controller.mapList.push({name:e.value.name,key:o}),t.pass())})}if(e)return DEBUG&&util.log("break at load maps due error from previous inits"),t.pass(!0);DEBUG&&util.log("loading maps"),t.take();for(var n=0,r=model.maps,i=jWorkflow.order(function(){DEBUG&&util.log("start loading maps")}),a=0,l=r.length;l>a;a++)i.andThen(o);i.andThen(function(e){e===!0?(DEBUG&&util.log("failed to load maps"),t.pass(!0)):(DEBUG&&util.log("finished loading maps"),t.pass(!1))}).start()}),controller.loadModification=util.singleLazyCall(function(e,t){return e?(DEBUG&&util.log("break at load modification due error from previous inits"),t.pass(!0)):(DEBUG&&util.log("loading modification"),t.take(),controller.storage.has("mod",function(e){e?(DEBUG&&util.log("modification available, grab from storage"),controller.storage.get("mod",function(e){try{var o=e.value;controller.stateMachine.event("start",o),t.pass(!1)}catch(n){controller.loadError=n.message,t.pass(!0)}})):(DEBUG&&util.log("modification not available, grab default one"),controller.storage.get("modificationPath",function(e){null===e?"awds.json":e.value,util.grabRemoteFile({path:"awds.json",json:!0,error:function(e){controller.loadError=e,t.pass(!0)},success:function(e){DEBUG&&util.log("modification grabbed, saving it"),controller.storage.set("mod",e,function(){DEBUG&&util.log("modification saved, next initializing engine");try{controller.stateMachine.event("start",e),t.pass(!1)}catch(o){controller.loadError=o.message,t.pass(!0)}})}})}))}),void 0)}),util.scoped(function(){var e={},t=[];view.registerSpriteAnimator=function(o,n,r,i){var a={};a.stps=n,a.tps=r,a.upt=i,a.step=0,a.time=0,e[o]=a,t.push(a)},view.getSpriteStep=function(t){return e[t].step},view.updateSpriteAnimations=function(e){for(var o=0,n=t.length;n>o;o++){var r=t[o];r.time+=e,r.time>=r.tps&&(r.time=0,r.step++,r.step>=r.stps&&(r.step=0),r.upt())}}}),util.scoped(function(){var e=controller.stateMachine.data.selection;view.registerSpriteAnimator("SELECTION",7,150,function(){var t=controller.stateMachine.state;if("MOVEPATH_SELECTION"===t||"ACTION_SELECT_TARGET_A"===t||"ACTION_SELECT_TARGET_B"===t||controller.attackRangeVisible)for(var o=0,n=0,r=model.mapWidth,i=model.mapHeight;r>o;o++)for(var a=n;i>a;a++)e.getValueAt(o,a)>-1&&view.markForRedraw(o,a)})}),view.registerSpriteAnimator("STATUS",20,375,function(){}),view.registerSpriteAnimator("UNIT",3,250,function(){for(var e=0,t=0,o=model.mapWidth,n=model.mapHeight;o>e;e++)for(var r=t;n>r;r++)null!==model.unitPosMap[e][r]&&view.markForRedrawWithNeighbours(e,r)}),view.registerSpriteAnimator("PROPERTY",4,400,function(){for(var e=0,t=0,o=model.mapWidth,n=model.mapHeight;o>e;e++)for(var r=t;n>r;r++)null!==model.propertyPosMap[e][r]&&view.markForRedrawWithNeighbours(e,r)}),view.registerSpriteAnimator("ANIM_TILES",4,300,function(){for(var e=0,t=0,o=model.mapWidth,n=model.mapHeight;o>e;e++)for(var r=t;n>r;r++)view.animatedTiles[view.mapImages[e][r]]&&view.markForRedraw(e,r)}),window.addEventListener("load",function(){window.applicationCache.addEventListener("updateready",function(){window.applicationCache.status==window.applicationCache.UPDATEREADY&&(window.applicationCache.swapCache(),confirm("A new version of this site is available. Load it?")&&window.location.reload())},!1)},!1),window.applicationCache.addEventListener("error",function(){alert("could not download the game data into the offline storage")},!1),util.scoped(function(){var e,t,o,n,r=null,i={},a="__volume_sfx__",l="__music_sfx__";controller.saveSoundConfigs=function(){DEBUG&&util.log("saving volume config in storage"),controller.storage.set(a,e.gain.value),controller.storage.set(l,t.gain.value)},controller.audioContext=function(){if(!r)try{if(util.log("init audio context"),window.AudioContext)util.log("using standardized one"),r=new window.AudioContext;else{if(!window.webkitAudioContext)throw Error("no webaudio contructor found");util.log("using webkit prefixed one"),r=new window.webkitAudioContext}e=r.createGainNode(),e.gain.value=1,e.connect(r.destination),t=r.createGainNode(),t.gain.value=.5,t.connect(r.destination),controller.storage.get(a,function(t){null!==t&&(e.gain.value=t.value)}),controller.storage.get(l,function(e){null!==e&&(t.gain.value=e.value)}),util.log("finished init audio context")}catch(o){DEBUG&&util.log("could not grab audio context, your environment seems to be out of webAudio API support err:",o),r=null}return r},controller.registerSoundFile=function(e,t){i[e]=t},controller.getSfxVolume=function(){return r?e.gain.value:0},controller.getMusicVolume=function(){return r?t.gain.value:0},controller.setSfxVolume=function(t){r&&(0>t?t=0:t>1&&(t=1),e.gain.value=t)},controller.setMusicVolume=function(e){r&&(0>e?e=0:e>1&&(e=1),t.gain.value=e)},controller.playSound=function(o,n,a){if(null!==r){var l=a?t:e,s=r.createBufferSource();return n&&(s.loop=!0),s.buffer=i[o],s.connect(l),s.noteOn(0),s}},controller.playEmptyAudio=function(){if(null!==r){var e=r.createBuffer(1,1,22050),t=r.createBufferSource();t.buffer=e,t.connect(r.destination),t.noteOn(0)}},controller.playMusic=function(e){null!==r&&n!==e&&(o&&(o.noteOff(0),o.disconnect(0)),i[e]&&(o=controller.playSound(e,!0,!0),n=e))}}),controller.isEnvironmentSupported=function(){DEBUG&&util.log("checking HTML and Javascript environment");var e=!0,t=head.browser;return head.mobile?(t.ios&&t.version>=6&&(e=!1),t.android&&t.version>=4&&(e=!1),t.safari&&t.version>=6&&(e=!1),t.chrome&&t.version>=18&&(e=!1),t.ff&&t.version>=17&&(e=!1)):(t.ie&&t.version>=9&&(e=!1),t.safari&&t.version>=6&&(e=!1),t.chrome&&t.version>=18&&(e=!1),t.ff&&t.version>=17&&(e=!1)),DEBUG&&util.log("brower is",e?"not supported":"supported"),e&&alert("Attention!\nYour browser is not supported! --> "+JSON.stringify(t)),e===!0},controller.clientInstances=util.list(CWT_MAX_PLAYER,!1),controller.mapCursorX=0,controller.mapCursorY=0,controller.resetMapCursor=function(){controller.mapCursorX=0,controller.mapCursorY=0},controller.cursorAction=function(e){if(!controller.inAnimationHookPhase()){var t=controller.stateMachine.state,o="MOVEPATH_SELECTION"===t||"IDLE_R"===t||"ACTION_SELECT_TARGET_A"===t||"ACTION_SELECT_TARGET_B"===t;e?controller.stateMachine.event("cancel",controller.mapCursorX,controller.mapCursorY):-1!==controller.menuCursorIndex?controller.stateMachine.event("action",controller.menuCursorIndex):controller.stateMachine.event("action",controller.mapCursorX,controller.mapCursorY);var n=controller.stateMachine.state,r="MOVEPATH_SELECTION"===n||"IDLE_R"===n||"ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n;if((o&&!r||r)&&view.markSelectionMapForRedraw(controller.stateMachine.data),"ACTION_MENU"===n||"ACTION_SUBMENU"===n){var i=controller.stateMachine.data.menu;controller.showMenu(i,controller.mapCursorX,controller.mapCursorY)}else("ACTION_MENU"===t||"ACTION_SUBMENU"===t)&&controller.hideMenu()}},controller.cursorActionCancel=function(){controller.cursorAction(!0),controller.playSound("CANCEL")},controller.cursorActionClick=function(){controller.cursorAction(!1),controller.playSound("ACTION")},controller.moveCursor=function(e,t){1===arguments.length&&(t=1);var o=controller.mapCursorX,n=controller.mapCursorY;switch(e){case model.MOVE_CODE_UP:n--;break;case model.MOVE_CODE_RIGHT:o++;break;case model.MOVE_CODE_DOWN:n++;break;case model.MOVE_CODE_LEFT:o--}controller.setCursorPosition(o,n)},controller.setCursorPosition=function(e,t,o){if(!controller.isMenuOpen()&&(o&&(e+=controller.screenX,t+=controller.screenY),model.isValidPosition(e,t)&&(e!==controller.mapCursorX||t!==controller.mapCursorY))){view.markForRedraw(controller.mapCursorX,controller.mapCursorY),controller.mapCursorY<model.mapHeight-1&&view.markForRedraw(controller.mapCursorX,controller.mapCursorY+1),controller.playSound("MAPTICK"),view.markForRedraw(controller.mapCursorX,controller.mapCursorY),controller.mapCursorX=e,controller.mapCursorY=t,controller.updateTileInformation();var n=controller.screenScale;0===n?n=.8:-1===n&&(n=.7);var r=parseInt(parseInt((window.innerWidth-80)/16,10)/n,10),i=parseInt(parseInt((window.innerHeight-80)/16,10)/n,10),a=-1;1>=e-controller.screenX?a=model.MOVE_CODE_LEFT:e-controller.screenX>=r-1?a=model.MOVE_CODE_RIGHT:1>=t-controller.screenY?a=model.MOVE_CODE_UP:t-controller.screenY>=i-1&&(a=model.MOVE_CODE_DOWN),-1!==a&&controller.shiftScreenPosition(a,5),DEBUG&&util.log("set cursor position to",e,t,"screen node is at",controller.screenX,controller.screenY),view.markForRedraw(e,t)}},util.scoped(function(){function e(){if(view.hooksBuffer.isEmpty())o=!1;else{o=!0;var e=view.hooksBuffer.pop(),n=e[e.length-1];t=view.animationHooks[n],t.prepare.apply(t,e)}}var t=null,o=!1,n=0;controller.prepareGameLoop=function(){n=0},controller.gameLoop=function(r){n+=r,controller.updateInputCoolDown(r);var i=0!==controller.moveScreenX||0!==controller.moveScreenY;if(i?controller.solveMapShift():(view.hasInfoMessage()?view.updateMessagePanelTime(r):o?(t.update(r),t.isDone()&&e()):(controller.updateState(n),n=0,e()),view.updateSpriteAnimations(r)),view.drawScreenChanges>0&&view.renderMap(controller.screenScale),o)t.render();else if("ACTION_SELECT_TILE"===controller.stateMachine.state){var a,l,s=view.selectionRange,c=controller.mapCursorX,u=controller.mapCursorY,d=u-s,m=u+s;for(0>d&&(d=0),m>=model.mapHeight&&(m=model.mapHeight-1);m>=d;d++){var _=Math.abs(d-u);for(a=c-s+_,l=c+s-_,0>a&&(a=0),l>=model.mapWidth&&(l=model.mapWidth-1);l>=a;a++)view.markForRedraw(a,d)}}},controller.inAnimationHookPhase=function(){return o}}),view.hooksBuffer=util.createRingBuffer(50),view.animationHooks={},view.registerAnimationHook=function(e){var t=e.key;view.animationHooks.hasOwnProperty(t)&&util.raiseError("animation algorithm for",t,"is already registered"),view.animationHooks[t]=e,model[t].listenCommand(function(){for(var e=[],o=0,n=arguments.length;n>o;o++)e[o]=arguments[o];e[e.length]=t,view.hooksBuffer.push(e)}),e.isEnabled=!0},view.IMAGE_CODE_IDLE="IDLE",view.IMAGE_CODE_IDLE_INVERTED="IDLE_R",view.IMAGE_CODE_RIGHT="RIGHT",view.IMAGE_CODE_LEFT="LEFT",view.IMAGE_CODE_UP="UP",view.IMAGE_CODE_DOWN="DOWN",view.IMAGE_CODE_STATELESS="STATELESS",view.COLOR_RED="RED",view.COLOR_GREEN="GREEN",view.COLOR_BLUE="BLUE",view.COLOR_YELLOW="YELLOW",view.COLOR_BLACK_MASK="BLACK_MASK",view.COLOR_NEUTRAL="GRAY",view.COLOR_NONE="NONE",view.IMG_COLOR_MAP_PROPERTIES_ID="IMG_MAP_PROPERTY",view.IMG_COLOR_MAP_UNITS_ID="IMG_MAP_UNIT",view.CodeStatelessview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{},NONE:{},GRAY:{}},view.overlayImages={},view.animatedTiles={},view.CodeIdleview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeIdleInvertedview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeRightview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeLeftview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeUpview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeDownview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.setImageForType=function(e,t,o,n){switch(void 0===o&&(o=view.IMAGE_CODE_STATELESS),void 0===n&&(n=view.COLOR_NONE),o){case view.IMAGE_CODE_IDLE:view.CodeIdleview[n][t]=e;break;case view.IMAGE_CODE_STATELESS:view.CodeStatelessview[n][t]=e;break;case view.IMAGE_CODE_IDLE_INVERTED:view.CodeIdleInvertedview[n][t]=e;break;case view.IMAGE_CODE_LEFT:view.CodeLeftview[n][t]=e;break;case view.IMAGE_CODE_RIGHT:view.CodeRightview[n][t]=e;break;case view.IMAGE_CODE_DOWN:view.CodeDownview[n][t]=e;break;case view.IMAGE_CODE_UP:view.CodeUpview[n][t]=e;break;default:util.raiseError("unknown image state code ",o)}},view.setUnitImageForType=view.setImageForType,view.setPropertyImageForType=function(e,t,o){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,o)},view.setTileImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.setInfoImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getImageForType=function(e,t,o){switch(t){case view.IMAGE_CODE_IDLE:return view.CodeIdleview[o][e];case view.IMAGE_CODE_IDLE_INVERTED:return view.CodeIdleInvertedview[o][e];case view.IMAGE_CODE_LEFT:return view.CodeLeftview[o][e];case view.IMAGE_CODE_RIGHT:return view.CodeRightview[o][e];case view.IMAGE_CODE_DOWN:return view.CodeDownview[o][e];case view.IMAGE_CODE_UP:return view.CodeUpview[o][e];case view.IMAGE_CODE_STATELESS:return view.CodeStatelessview[o][e];default:util.raiseError("unknown image state code ",t)}},view.getUnitImageForType=view.getImageForType,view.getPropertyImageForType=function(e,t){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,t)
},view.getTileImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getInfoImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},controller.inputCoolDown=0,controller.updateInputCoolDown=function(e){controller.inputCoolDown-=e,0>controller.inputCoolDown&&(controller.inputCoolDown=0)},view.mapImages=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),util.scoped(function(){function e(e,t,o,n,r){if(0>e||0>t||e>=model.mapWidth||t>=model.mapWidth)return n[o]="_",void 0;var i=r[model.map[e][t].ID];void 0===i&&(i=""),n[o]=i}function t(e,t,o,n){for(var r=0,i=e.length;i>r;r++){var a=e[r];if(!(""!==a[1]&&a[1]!==t[0]||""!==a[2]&&a[2]!==t[1]||""!==a[3]&&a[3]!==t[2]||""!==a[4]&&a[4]!==t[3])){if(!o){if(""!==a[5]&&a[5]!==t[4])continue;if(""!==a[6]&&a[6]!==t[5])continue;if(""!==a[7]&&a[7]!==t[6])continue;if(""!==a[8]&&a[8]!==t[7])continue}return a[0]}}return n}view.updateMapImages=function(){var o,n,r=model.mapWidth,i=model.mapHeight,a=e,l=t,s=[];for(o=0;r>o;o++)for(n=0;i>n;n++){var c=o,u=n,d=model.map[c][u].ID;if(model.graphics.connected[d]){var m=model.graphics.connectedKeys[d];5===model.graphics.connected[d][0].length?(a(o,n-1,0,s,m),a(o+1,n,1,s,m),a(o,n+1,2,s,m),a(o-1,n,3,s,m),view.mapImages[o][n]=l(model.graphics.connected[d],s,!0,d)):(a(o,n-1,0,s,m),a(o+1,n-1,1,s,m),a(o+1,n,2,s,m),a(o+1,n+1,3,s,m),a(o,n+1,4,s,m),a(o-1,n+1,5,s,m),a(o-1,n,6,s,m),a(o-1,n-1,7,s,m),view.mapImages[o][n]=l(model.graphics.connected[d],s,!1,d))}else view.mapImages[c][u]=d}}}),util.scoped(function(){var e={},t=document.getElementById(ID_ELMT_MENU);document.getElementById(ID_ELMT_MENU_HEADER),document.getElementById(ID_ELMT_MENU_CONTENT);var o=document.getElementById(ID_ELMT_MENU_ENTRIES);controller.menuPosX=-1,controller.menuPosY=-1,controller.menuCursorIndex=-1,controller.resetMenuCursor=function(){controller.menuCursorIndex=0},controller.setMenuIndex=function(e){controller.playSound("MENUTICK"),o.children[controller.menuCursorIndex].className="",controller.menuCursorIndex=e,o.children[controller.menuCursorIndex].className="activeButton"},controller.increaseMenuCursor=function(){o.children[controller.menuCursorIndex].className="",controller.menuCursorIndex++,controller.menuCursorIndex===controller.stateMachine.data.menu.size?controller.menuCursorIndex--:controller.playSound("MENUTICK"),o.children[controller.menuCursorIndex].className="activeButton",o.children[controller.menuCursorIndex].children[0].focus()},controller.decreaseMenuCursor=function(){o.children[controller.menuCursorIndex].className="",controller.menuCursorIndex--,0>controller.menuCursorIndex?controller.menuCursorIndex=0:controller.playSound("MENUTICK"),o.children[controller.menuCursorIndex].className="activeButton",o.children[controller.menuCursorIndex].children[0].focus()},controller.showMenu=function(n,r,i){DEBUG&&util.log("opening GUI menu"),TILE_LENGTH*controller.screenScale;var a=e.__mainMenu__;if("ACTION_SUBMENU"===controller.stateMachine.state){var l=e[controller.stateMachine.data.action.selectedEntry];l&&(a=l)}1===arguments.length&&(r=controller.menuPosX,i=controller.menuPosY),model.isValidPosition(r,i)||util.raiseError("invalid menu position");for(var s=o.children,c=0,u=s.length;u>c;c++)s[c].style.display="none";for(var c=0,u=n.size;u>c;c++){var d;if(s.length>c)s[c].className="",d=s[c].children[0];else{d=document.createElement("button");var m=document.createElement("li");m.appendChild(d),o.appendChild(m)}a(n.data[c],d,c),s[c].style.display=""}r-=controller.screenX,i-=controller.screenY,controller.menuPosX=r,controller.menuPosY=i,controller.menuCursorIndex=0,o.children[controller.menuCursorIndex].className="activeButton",o.children[controller.menuCursorIndex].children[0].focus(),t.className="uiPopup show",controller.menuVisible=!0,controller.setMenuIndex(0)},controller.hideMenu=function(){DEBUG&&util.log("closing GUI menu"),o.children[controller.menuCursorIndex].className="",t.className="uiPopup hide",controller.menuCursorIndex=-1,controller.menuVisible=!1},controller.menuVisible=!1,controller.isMenuOpen=function(){return controller.menuVisible},controller.registerMenuRenderer=function(t,o){e.hasOwnProperty(t)&&util.raiseError("renderer for",t,"is already registered"),e[t]=o}}),util.scoped(function(){var e,t=document.getElementById("cwt_info_box"),o=document.getElementById("cwt_info_box_content"),n=1e3;view.updateMessagePanelTime=function(o){e>0&&(e-=o,0>=e&&(t.className="uiPopup hide"))},view.hasInfoMessage=function(){return e>0},view.showInfoMessage=function(r,i){1===arguments.length&&(i=n),o.innerHTML=r,t.className="uiPopup show",e=i}}),controller.isNetworkGame=function(){return!1},controller.unitStatusMap=util.list(CWT_MAX_UNITS_PER_PLAYER*CWT_MAX_PLAYER,function(){return{HP_PIC:null,LOW_AMMO:!1,LOW_FUEL:!1,HAS_LOADS:!1,CAPTURES:!1,VISIBLE:!1}}),controller.getUnitStatusForUnit=function(e){var t=model.extractUnitId(e);return controller.unitStatusMap[t]},util.scoped(function(){function e(e,t,o,n){if(model.isValidPosition(e,t)){var r=model.unitPosMap[e][t];r&&(model.players[r.owner].team!==o&&(n.VISIBLE=!0),r.hidden&&(controller.unitStatusMap[model.extractUnitId(r)].VISIBLE=!0))}}function t(t,o){if(o||(o=controller.unitStatusMap[model.extractUnitId(t)]),o.VISIBLE=!0,t.hidden){o.VISIBLE=!1;var n=t.x,r=t.y,i=model.players[t.owner].team;e(n-1,r,i,o),e(n,r-1,i,o),e(n,r+1,i,o),e(n+1,r,i,o)}}controller.updateUnitStatus=function(e){var o=model.units[e];o.x,o.y;var n=controller.unitStatusMap[e],r=o.type,i=o.ammo,a=r.ammo;n.LOW_AMMO=parseInt(.25*a,10)>=i?!0:!1,0===a&&(n.LOW_AMMO=!1);var l=o.fuel,s=r.fuel;n.LOW_FUEL=parseInt(.25*s,10)>l?!0:!1;var c=-1;switch(90>=o.hp&&(c=parseInt(o.hp/10,10)+1),c){case 1:n.HP_PIC=view.getInfoImageForType("HP_1");break;case 2:n.HP_PIC=view.getInfoImageForType("HP_2");break;case 3:n.HP_PIC=view.getInfoImageForType("HP_3");break;case 4:n.HP_PIC=view.getInfoImageForType("HP_4");break;case 5:n.HP_PIC=view.getInfoImageForType("HP_5");break;case 6:n.HP_PIC=view.getInfoImageForType("HP_6");break;case 7:n.HP_PIC=view.getInfoImageForType("HP_7");break;case 8:n.HP_PIC=view.getInfoImageForType("HP_8");break;case 9:n.HP_PIC=view.getInfoImageForType("HP_9");break;default:n.HP_PIC=null}if(n.HAS_LOADS=-1>o.loadedIn?!0:!1,o.x>=0){var u=model.propertyPosMap[o.x][o.y];n.CAPTURES=null!==u&&20>u.capturePoints?!0:!1}t(o,n)}}),controller.mapAction({key:"options",hasSubMenu:!0,condition:function(e){var t=e.source.unit;if(null!==t&&t.owner===model.turnOwner&&model.canAct(e.source.unitId))return!1;var o=e.source.property;return null!==o&&o.type.builds?!1:!0},prepareMenu:function(e){e.menu.addEntry("options.sfx"),e.menu.addEntry("options.music"),e.menu.addEntry("options.yield")},invoke:function(e){var t=e.action.selectedSubEntry;switch(t){case"options.sfx":controller.getSfxVolume()>0?controller.setSfxVolume(0):controller.setSfxVolume(1);break;case"options.music":controller.getMusicVolume()>0?controller.setMusicVolume(0):controller.setMusicVolume(1);break;case"options.yield":model.playerGivesUp.callAsCommand()}}}),view.drawScreenChanges=0,view.drawScreen=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,!1),view.markForRedraw=function(e,t){if(e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t){if(view.drawScreen[e][t]===!0)return;view.drawScreen[e][t]=!0,view.drawScreenChanges++,t++,model.mapHeight>t&&(null!==model.propertyPosMap[e][t]?view.markForRedraw(e,t):view.overlayImages[view.mapImages[e][t]]===!0&&view.markForRedraw(e,t))}},view.markForRedrawRange=function(e,t,o){var n,r,i=t-o,a=t+o;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-o+l,r=e+o-l,0>n&&(n=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=n;n++)view.markForRedraw(n,i)}},view.markForRedrawWithNeighbours=function(e,t){t>0&&view.markForRedraw(e,t-1),e>0&&view.markForRedraw(e-1,t),view.markForRedraw(e,t),model.mapHeight-1>t&&view.markForRedraw(e,t+1),model.mapWidth-1>e&&view.markForRedraw(e+1,t)},view.markForRedrawWithNeighboursRing=function(e,t){var o=model.mapWidth,n=model.mapHeight;e>0&&(t>0&&view.markForRedraw(e-1,t-1),view.markForRedraw(e-1,t),n-1>t&&view.markForRedraw(e-1,t+1)),t>0&&view.markForRedraw(e,t-1),view.markForRedraw(e,t),n-1>t&&view.markForRedraw(e,t+1),o-1>e&&(t>0&&view.markForRedraw(e+1,t-1),view.markForRedraw(e+1,t),n-1>t&&view.markForRedraw(e+1,t+1))},view.completeRedraw=function(){view.drawScreenChanges=1;for(var e=0,t=model.mapWidth;t>e;e++)for(var o=0,n=model.mapHeight;n>o;o++)view.drawScreen[e][o]=!0},view.markSelectionMapForRedraw=function(e){for(var t=e.selection.centerX,o=e.selection.centerY,n=e.selection.data,r=0;n.length>r;r++)for(var i=n[r],a=0;i.length>a;a++)-1!==i[a]&&view.markForRedraw(t+r,o+a)},controller.screenElement=document.getElementById("cwt_canvas"),controller.screenX=0,controller.screenY=0,controller.screenWidth=-1,controller.screenHeight=-1,controller.screenScale=1,controller.moveScreenX=0,controller.moveScreenY=0,controller.setScreenScale=function(e){if(!(-1>e||e>3)){controller.screenScale=e,controller.screenElement.className="scale"+e,0===e?e=.8:-1===e&&(e=.7);var t=TILE_LENGTH*e;controller.screenWidth=parseInt(window.innerWidth/t,10),controller.screenHeight=parseInt(window.innerHeight/t,10),controller.setScreenPosition(controller.screenX,controller.screenY,!1)}},controller.setScreenPosition=function(e,t){controller.screenX=e,controller.screenY=t;var o=controller.screenElement.style,n=controller.screenScale,r=-(controller.screenX*TILE_LENGTH*n),i=-(controller.screenY*TILE_LENGTH*n);switch(n){case 2:r+=controller.screenElement.width/2,i+=controller.screenElement.height/2;break;case 3:r+=controller.screenElement.width,i+=controller.screenElement.height}o.position="absolute",o.left=r+"px",o.top=i+"px"},controller.shiftScreenPosition=function(e,t){1===arguments.length&&(t=1);var o=controller.screenX,n=controller.screenY;switch(e){case model.MOVE_CODE_DOWN:n+=t;break;case model.MOVE_CODE_RIGHT:o+=t;break;case model.MOVE_CODE_UP:n-=t;break;case model.MOVE_CODE_LEFT:o-=t}0>o&&(o=0),0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1),n>=model.mapHeight&&(n=model.mapHeight-1),controller.setScreenPosition(o,n,!1)},view.resizeCanvas=function(){var e=controller.screenElement;e.width=TILE_LENGTH*model.mapWidth,e.height=TILE_LENGTH*model.mapHeight,controller.screenWidth=parseInt(window.innerWidth/TILE_LENGTH,10),controller.screenHeight=parseInt(window.innerHeight/TILE_LENGTH,10)};var TILE_LENGTH=16;controller.baseSize=16,view.preventRenderUnit=null,view.canvasCtx=controller.screenElement.getContext("2d"),view.selectionRange=2,view.colorArray=[view.COLOR_RED,view.COLOR_BLUE,view.COLOR_GREEN,view.COLOR_YELLOW],view.renderMap=function(){var e=TILE_LENGTH,t=view.canvasCtx;controller.screenX,controller.screenY;for(var o,n,r,i,a,l,s,c,u,d,m,_=controller.mapCursorX,p=controller.mapCursorY,E=view.getSpriteStep("SELECTION"),f=view.getSpriteStep("UNIT"),h=view.getSpriteStep("PROPERTY"),I=view.getSpriteStep("STATUS"),v=view.getSpriteStep("ANIM_TILES"),g=controller.baseSize,T=model.players[model.turnOwner].team,y="MOVEPATH_SELECTION"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state||controller.attackRangeVisible,M="ACTION_SELECT_TILE"===controller.stateMachine.state,O=controller.stateMachine.data,w=O.selection,A=model.mapHeight-1,C=0;A>=C;C++)for(var S=model.mapWidth-1,N=0;S>=N;N++)if(m=0===model.fogData[N][C],view.drawScreen[N][C]===!0){o=view.mapImages[N][C],n=view.getTileImageForType(o),r=0,i=0,view.animatedTiles[o]&&(r+=g*v),a=g,l=2*g,s=N*e,c=C*e-e,u=e,d=2*e,0>c&&(i+=g,l-=g,c+=e,d-=e),void 0!==n?t.drawImage(n,r,i,a,l,s,c,u,d):(t.fillStyle="rgb(0,0,255)",t.fillRect(s,c,e,e));var D=model.propertyPosMap[N][C];if(null!==D){var L;o=D.type.ID,-1===D.owner?L=view.COLOR_NEUTRAL:(L=view.colorArray[D.owner],D.type.factionSprites&&(o=D.type.factionSprites[model.players[D.owner].mainCo.faction])),m&&(L=view.COLOR_NEUTRAL),n=view.getPropertyImageForType(o,L),r=0+g*h,i=0,a=g,l=2*g,s=N*e,c=C*e-e,u=e,d=2*e,0>c&&(i+=g,l-=g,c+=e,d-=e),void 0!==n?(t.drawImage(n,r,i,a,l,s,c,u,d),m&&d>16&&null!==D&&(n=view.getPropertyImageForType(D.type.ID,view.COLOR_BLACK_MASK),t.globalAlpha=.35,t.drawImage(n,r,i,a,l/2,s,c,u,d/2),t.globalAlpha=1)):(s=N*e,c=C*e,u=e,d=e,t.fillStyle="rgb(0,255,0)",t.fillRect(s,c,u,d))}if(m&&(s=N*e,c=C*e,u=e,d=e,t.globalAlpha=.2,t.fillStyle="black",t.fillRect(s,c,u,d),t.globalAlpha=1),y){n=view.getInfoImageForType("MOVEPATH_SELECTION"===controller.stateMachine.state?"MOVE_FOC":"ATK_FOC");var R=w.getValueAt(N,C);R>0&&(r=g*E,i=0,a=g,l=g,s=N*e,c=C*e,u=e,d=e,t.globalAlpha=.65,t.drawImage(n,r,i,a,l,s,c,u,d),t.globalAlpha=1)}if(M){var P=model.distance(_,p,N,C);if(view.selectionRange===P){var n=null;n=0===P?view.getInfoImageForType("SILO_ALL"):_===N?p>C?view.getInfoImageForType("SILO_N"):view.getInfoImageForType("SILO_S"):p===C?_>N?view.getInfoImageForType("SILO_W"):view.getInfoImageForType("SILO_E"):_>N?p>C?view.getInfoImageForType("SILO_NW"):view.getInfoImageForType("SILO_SW"):p>C?view.getInfoImageForType("SILO_NE"):view.getInfoImageForType("SILO_SE"),s=N*e,c=C*e,null!==n&&t.drawImage(n,s,c)}}var U=model.unitPosMap[N][C],b=null!==U?controller.getUnitStatusForUnit(U):null;if(!m&&null!==U&&(U.owner===model.turnOwner||model.players[U.owner].team==T||b.VISIBLE)&&U!==view.preventRenderUnit){var L;L=-1===U.owner?view.COLOR_NEUTRAL:view.colorArray[U.owner];var B=1===U.owner%2?view.IMAGE_CODE_IDLE:view.IMAGE_CODE_IDLE_INVERTED;if(n=view.getUnitImageForType(U.type.ID,B,L),r=2*g*f,i=0,a=2*g,l=2*g,s=N*e-e/2,c=C*e-e/2,u=e+e,d=e+e,void 0!==n?(t.drawImage(n,r,i,a,l,s,c,u,d),U.owner!==model.turnOwner||model.canAct(model.extractUnitId(U))||(t.globalAlpha=.5,t.drawImage(view.getUnitImageForType(U.type.ID,B,view.COLOR_BLACK_MASK),r,i,a,l,s,c,u,d),t.globalAlpha=1)):(s=N*e,c=C*e,u=e,d=e,t.fillStyle="rgb(255,0,0)",t.fillRect(s,c,u,d)),n=b.HP_PIC,null!==n&&t.drawImage(n,s+e,c+e),0!==I&&1!==I&&4!==I&&5!==I&&8!==I&&9!==I&&12!==I&&13!==I&&16!==I&&17!==I){var k=parseInt(I/4,10);n=null;var G=k;do{if(0===G&&b.LOW_AMMO?n=view.getInfoImageForType("SYM_AMMO"):1===G&&b.CAPTURES?n=view.getInfoImageForType("SYM_CAPTURE"):2===G&&b.LOW_FUEL?n=view.getInfoImageForType("SYM_FUEL"):3===G&&b.HAS_LOADS?n=view.getInfoImageForType("SYM_LOAD"):4===G&&U.hidden&&(n=view.getInfoImageForType("SYM_HIDDEN")),null!==n)break;G++,5===G&&(G=0)}while(G!==k);null!==n&&t.drawImage(n,s+e/2,c+e)}}view.drawScreen[N][C]=!1}if("MOVEPATH_SELECTION"===controller.stateMachine.state)for(var V,F,x,W,H=O.movePath.data,X=O.source.x,Y=O.source.y,K=0,z=H.length;z>K&&null!==H[K];K++){switch(V=X,F=Y,H[K]){case model.MOVE_CODE_UP:Y--;break;case model.MOVE_CODE_RIGHT:X++;break;case model.MOVE_CODE_DOWN:Y++;break;case model.MOVE_CODE_LEFT:X--}if(K===z-1||null===H[K+1])x=-1,W=-1;else switch(H[K+1]){case model.MOVE_CODE_UP:x=X,W=Y-1;break;case model.MOVE_CODE_RIGHT:x=X+1,W=Y;break;case model.MOVE_CODE_DOWN:x=X,W=Y+1;break;case model.MOVE_CODE_LEFT:x=X-1,W=Y}if(-1==x)switch(H[K]){case model.MOVE_CODE_UP:n=view.getTileImageForType("ARROW_N");break;case model.MOVE_CODE_RIGHT:n=view.getTileImageForType("ARROW_E");break;case model.MOVE_CODE_DOWN:n=view.getTileImageForType("ARROW_S");break;case model.MOVE_CODE_LEFT:n=view.getTileImageForType("ARROW_W")}else{var j=Math.abs(x-V),J=Math.abs(W-F);if(2===j)n=view.getTileImageForType("ARROW_WE");else if(2===J)n=view.getTileImageForType("ARROW_NS");else if(X>x&&F>Y||X>V&&W>Y)n=view.getTileImageForType("ARROW_SW");else if(X>x&&Y>F||X>V&&Y>W)n=view.getTileImageForType("ARROW_WN");else if(x>X&&Y>F||V>X&&Y>W)n=view.getTileImageForType("ARROW_NE");else{if(!(x>X&&F>Y||V>X&&W>Y)){util.raiseError("illegal move arrow state","old (",V,",",F,")","current (",X,",",Y,")","next (",x,",",W,")","path (",H,")");continue}n=view.getTileImageForType("ARROW_ES")}}X>=0&&Y>=0&&controller.screenWidth>X&&controller.screenHeight>Y&&t.drawImage(n,X*e,Y*e)}t.lineWidth=2,t.strokeStyle="#f00",t.strokeRect(e*controller.mapCursorX+1,e*controller.mapCursorY+1,e-2,e-2),view.drawScreenChanges=0},controller.screenStateMachine=simpleStateMachine(),controller.screenStateMachine.name="CLIENT",controller.screenStateMachine.data={},controller.loadStorageController=util.singleLazyCall(function(e,t){if(e)return DEBUG&&util.log("break at init storage system due error from previous inits"),e;t.take(),DEBUG&&util.log("initializing storage system");var o=0,n=Browser;DEBUG&&util.log("using lawnchair storage system with",n.mobile?"webkit-sqlite":"indexed-db","adapter");var r=new Lawnchair({adaptor:n.mobile?"webkit-sqlite":"indexed-db",maxSize:47104,name:"cwt"},function(){var e,n,i,a,l,s;e=function(e,t){r.get(e,t)},n=function(e,t){r.exists(e,t)},i=function(e){r.nuke(e)},s=function(e){r.keys(e)},a=function(e,t){r.get(e,obj,t)},l=function(e,t,n){DEBUG&&(o+=JSON.stringify({key:e,value:t}).length,util.log(o,"used in storage")),r.save({key:e,value:t},n)},controller.storage={get:e,has:n,set:l,keys:s,clear:i,remove:a},t.pass(!1)})}),controller.screenStateMachine.data.mapToLoad=null,controller.screenStateMachine.data.openedSection=null,controller.screenStateMachine.data.openSection=function(e){var t=document.getElementById(e);t||util.raiseError("unknown id",e),null!==this.openedSection&&(this.openedSection.style.display="none"),t.style.display="",this.openedSection=t},util.scoped(function(){function e(e){controller.startGameRound(e.value),controller.setCursorPosition(0,0),view.resizeCanvas(),view.updateMapImages(),view.completeRedraw();for(var o=0,n=model.units.length;n>o;o++)model.units[o].owner!==CWT_INACTIVE_ID&&controller.updateUnitStatus(o);controller.playSoundForPlayer(model.turnOwner),controller.renderPlayerInfo(),t()}function t(){function e(){if(!controller.inGameRound)return controller.screenStateMachine.event("gameHasEnded"),void 0;requestAnimationFrame(e);var o=(new Date).getTime(),n=o-t;t=o,controller.gameLoop(n)}DEBUG&&util.log("setup animation frame"),controller.prepareGameLoop();var t=(new Date).getTime();requestAnimationFrame(e)}controller.screenStateMachine.structure.GAMEROUND=Object.create(controller.stateParent),controller.screenStateMachine.structure.GAMEROUND.onenter=function(){this.data.openSection(ID_MENU_SECTION_GAME),controller.storage.get(this.data.mapToLoad,e)},controller.screenStateMachine.structure.GAMEROUND.gameHasEnded=function(){return"MAIN"},controller.screenStateMachine.structure.GAMEROUND.LEFT=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.BREAK_TRANSITION):(t||(t=1),1===t?controller.moveCursor(model.MOVE_CODE_LEFT,t):controller.shiftScreenPosition(model.MOVE_CODE_LEFT,t),this.BREAK_TRANSITION)},controller.screenStateMachine.structure.GAMEROUND.RIGHT=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.BREAK_TRANSITION):(t||(t=1),1===t?controller.moveCursor(model.MOVE_CODE_RIGHT,t):controller.shiftScreenPosition(model.MOVE_CODE_RIGHT,t),this.BREAK_TRANSITION)},controller.screenStateMachine.structure.GAMEROUND.UP=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.BREAK_TRANSITION;var n="ACTION_MENU"===o||"ACTION_SUBMENU"===o;return t||(t=1),n?controller.decreaseMenuCursor():1===t?controller.moveCursor(model.MOVE_CODE_UP,t):controller.shiftScreenPosition(model.MOVE_CODE_UP,t),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.DOWN=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.BREAK_TRANSITION;var n="ACTION_MENU"===o||"ACTION_SUBMENU"===o;return t||(t=1),n?controller.increaseMenuCursor():1===t?controller.moveCursor(model.MOVE_CODE_DOWN,t):controller.shiftScreenPosition(model.MOVE_CODE_DOWN,t),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.ACTION=function(e,t,o){return controller.hideAttackRangeInfo(),"number"==typeof t&&controller.setCursorPosition(t,o),controller.cursorActionClick(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.HOVER=function(e,t,o){return controller.setCursorPosition(t,o),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.CANCEL=function(e,t,o){return controller.hideAttackRangeInfo(),"number"==typeof t&&controller.setCursorPosition(t,o),controller.cursorActionCancel(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_1=function(){return this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_2=function(){return this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_3=function(){return controller.attackRangeVisible||controller.showAttackRangeInfo(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_4=function(){return this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_5=function(){return controller.setScreenScale(controller.screenScale+1),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_6=function(){return controller.setScreenScale(controller.screenScale-1),this.BREAK_TRANSITION}}),controller.screenStateMachine.structure.LOAD=Object.create(controller.stateParent),controller.screenStateMachine.structure.LOAD.onenter=function(){this.data.openSection(ID_MENU_SECTION_LOAD),jWorkflow.order(controller.isEnvironmentSupported).andThen(controller.loadStorageController).andThen(function(e,t){return e?e:(t.take(),controller.storage.get("resetDataAtStart",function(e){var o=null!==e&&e.value;o||(o="1"===getQueryParams(document.location.search).wipeoutMod),o?(DEBUG&&util.log("wipe out cached data"),controller.storage.clear(function(){t.pass(!1)})):t.pass(!1)}),void 0)}).andThen(controller.loadModification).andThen(controller.loadMaps).andThen(controller.loadImages).andThen(controller.cutImages).andThen(controller.colorizeImages).andThen(controller.loadSoundFiles).andThen(controller.loadInputDevices).andThen(function(){controller.screenStateMachine.event("complete")}).start()},controller.screenStateMachine.structure.LOAD.complete=function(){return"MOBILE"},controller.screenStateMachine.structure.LOAD.onerror=controller.haltEngine,controller.loadError=null,util.scoped(function(){function e(e,t){void 0===t&&(t=!0),-1!==n&&(o[n].className="menuButton"),t?e>0?(n++,n>=o.length&&(n=0)):(n--,0>n&&(n=o.length-1)):((0>e||e>=o.length)&&util.raiseError("wrong index"),n=e);var r=o[n].attributes.key.value;r=!controller.loadError&&"VERSUS"===r||"OPTIONS"===r?"menuButton active":"menuButton inactive",o[n].className=r}function t(t){o[t].onmouseover=function(){e(t,!1)}}for(var o=[document.getElementById(ID_ELMT_SECTION_MAIN_BTN_1),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_2),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_3),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_4),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_5),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_6)],n=-1,r=0,i=o.length;i>r;r++)t(r);controller.screenStateMachine.structure.MAIN=Object.create(controller.stateParent),controller.screenStateMachine.structure.MAIN.onenter=function(){controller.playEmptyAudio(),controller.playMusic("BG");for(var t=0,n=o.length;n>t;t++)o[t].innerHTML=model.localized(o[t].attributes.key.value);if(controller.loadError){var r=document.getElementById(ID_ELMT_SECTION_MAIN_ERROR);r.innerHTML=controller.loadError,r.style.display="block",controller.loadError=null}this.data.openSection(ID_MENU_SECTION_MAIN),e(1,!1)},controller.screenStateMachine.structure.MAIN.UP=function(){return e(-1),this.BREAK_TRANSITION},controller.screenStateMachine.structure.MAIN.DOWN=function(){return e(1),this.BREAK_TRANSITION},controller.screenStateMachine.structure.MAIN.ACTION=function(){var e=o[n],t=e.attributes.key.value;return controller.loadError=null,controller.loadError||"VERSUS"!==t?"OPTIONS"===t?"OPTIONS":this.BREAK_TRANSITION:"VERSUS"}}),controller.screenStateMachine.structure.MOBILE=Object.create(controller.stateParent),controller.screenStateMachine.structure.MOBILE.onenter=function(){this.data.openSection(ID_ELMT_SECTION_MOBILE);var e=document.getElementById(ID_ELMT_SECTION_MOBILE_NEXT);e.innerHTML=model.localized(e.attributes.key.value)},controller.screenStateMachine.structure.MOBILE.ACTION=function(){return"MAIN"},controller.screenStateMachine.structure.NONE=Object.create(controller.stateParent),controller.screenStateMachine.structure.NONE.start=function(){return"LOAD"},util.scoped(function(){function e(){DEBUG&&util.log("successfully set new mod path")}function t(){DEBUG&&util.log("successfully set wipe out... next start with clean data")}function o(e){r[e].onmouseover=function(){3!==n&&(r[n].className="menuButton"),n=e,3!==n&&(r[n].className="menuButton active")}}for(var n=-1,r=[document.getElementById(ID_ELMT_OTIONS_SFX_VOL),document.getElementById(ID_ELMT_OTIONS_MUSIC_VOL),document.getElementById(ID_ELMT_OTIONS_RESET),document.getElementById("cwt_options_mapIn"),document.getElementById("cwt_options_addMap"),document.getElementById(ID_ELMT_OTIONS_GOBACK)],i=document.getElementById("cwt_options_sfxVolume_desc"),a=document.getElementById("cwt_options_musicVolume_desc"),l=document.getElementById("cwt_options_reset"),s=document.getElementById("cwt_options_goBack"),c=document.getElementById("cwt_options_addMap"),u=document.getElementById("cwt_options_sfxVolume"),d=document.getElementById("cwt_options_musicVolume"),m=document.getElementById(ID_ELMT_OTIONS_MOD_INFO),_=0,p=r.length;p>_;_++)o(_);controller.screenStateMachine.structure.OPTIONS=Object.create(controller.stateParent),controller.screenStateMachine.structure.OPTIONS.onenter=function(){i.innerHTML=model.localized(i.attributes.key.value),a.innerHTML=model.localized(a.attributes.key.value),l.innerHTML=model.localized(l.attributes.key.value),s.innerHTML=model.localized(s.attributes.key.value),c.innerHTML=model.localized(c.attributes.key.value),this.data.openSection(ID_MENU_SECTION_OPTIONS),-1!==n&&3!==n&&(r[n].className="menuButton"),n=0,r[n].className="menuButton active",u.innerHTML=Math.round(100*controller.getSfxVolume()),d.innerHTML=Math.round(100*controller.getMusicVolume())},controller.screenStateMachine.structure.OPTIONS.UP=function(){return 3!==n&&(r[n].className="menuButton"),n--,0>n&&(n=r.length-1),3!==n&&(r[n].className="menuButton active"),this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.DOWN=function(){return 3!==n&&(r[n].className="menuButton"),n++,n>=r.length&&(n=0),3!==n&&(r[n].className="menuButton active"),this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.ACTION=function(){var o=r[n].id;switch(o){case ID_ELMT_OTIONS_MOD_TAKE:var i=m.value;controller.storage.set("modificationPath",i,e),controller.storage.set("resetDataAtStart",{value:!0},t);break;case ID_ELMT_OTIONS_RESET:controller.storage.set("resetDataAtStart",{value:!0},t);break;case"cwt_options_addMap":try{var a=document.getElementById("cwt_options_mapIn").value;a=JSON.parse(a),model.checkMap(a)}catch(l){return controller.loadError="illegal map","MAIN"}controller.storage.set(a.name,a,function(){controller.mapList.push({name:a.name,key:a.name})});break;case ID_ELMT_OTIONS_GOBACK:return controller.saveSoundConfigs(),"MAIN"}return this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.LEFT=function(){var e=r[n].id;switch(e){case ID_ELMT_OTIONS_SFX_VOL:controller.setSfxVolume(controller.getSfxVolume()-.05),u.innerHTML=Math.round(100*controller.getSfxVolume());break;case ID_ELMT_OTIONS_MUSIC_VOL:controller.setMusicVolume(controller.getMusicVolume()-.05),d.innerHTML=Math.round(100*controller.getMusicVolume())}return this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.RIGHT=function(){var e=r[n].id;switch(e){case ID_ELMT_OTIONS_SFX_VOL:controller.setSfxVolume(controller.getSfxVolume()+.05),u.innerHTML=Math.round(100*controller.getSfxVolume());break;case ID_ELMT_OTIONS_MUSIC_VOL:controller.setMusicVolume(controller.getMusicVolume()+.05),d.innerHTML=Math.round(100*controller.getMusicVolume())}return this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.CANCEL=function(){return controller.saveSoundConfigs(),"MAIN"}}),util.scoped(function(){function e(){o.innerHTML=controller.mapList[t].name}var t,o=document.getElementById("map_selection"),n=document.getElementById("versus_start_btn");controller.screenStateMachine.structure.VERSUS=Object.create(controller.stateParent),controller.screenStateMachine.structure.VERSUS.onenter=function(){this.data.openSection("cwt_versus_screen"),n.innerHTML=model.localized(n.attributes.key.value),t=0,e()},controller.screenStateMachine.structure.VERSUS.UP=function(){return t>0?t--:t=controller.mapList.length-1,e(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.VERSUS.DOWN=function(){return controller.mapList.length-1>t?t++:t=0,e(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.VERSUS.CANCEL=function(){return"MAIN"},controller.screenStateMachine.structure.VERSUS.ACTION=function(){return controller.mapList?(this.data.mapToLoad=controller.mapList[t].key,"GAMEROUND"):this.BREAK_TRANSITION}}),util.scoped(function(){function e(e,t,n,r){if(n-=r-1,!(0>n||n>9)){var i=TILE_LENGTH,a=48*n,l=0,s=48,c=48,u=e*i,d=t*i,m=i,_=i;view.canvasCtx.drawImage(o,a,l,s,c,u,d,m,_),view.markForRedraw(e,t)}}function t(e,t){if(model.isValidPosition(e,t)){var o=model.unitPosMap[e][t];null!==o&&controller.updateUnitStatus(model.extractUnitId(o))}}var o;view.registerAnimationHook({key:"fireBombAt",prepare:function(e,t,n){o||(o=view.getInfoImageForType("EXPLOSION_GROUND")),controller.playSound("ROCKET_IMPACT"),this.x=e,this.y=t,this.range=n,this.maxStep=10+n+1,this.step=0,this.time=0},render:function(){model.doInRange(this.x,this.y,this.range,e,this.step)},update:function(e){this.time+=e,this.time>75&&(this.step++,this.time=0)},isDone:function(){var e=this.step===this.maxStep;return e&&model.doInRange(this.x,this.y,this.range,t),e}})}),view.registerAnimationHook({key:"captureProperty",prepare:function(e,t){var o=model.properties[t];controller.updateUnitStatus(e),20===o.capturePoints?view.showInfoMessage(model.localized("propertyCaptured")):view.showInfoMessage(model.localized("propertyPointsLeft")+" "+o.capturePoints)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerAnimationHook({key:"changeWeather",prepare:function(e){view.showInfoMessage(model.localized("weatherChange")+" "+model.localized(e))},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerAnimationHook({key:"destroyUnit",prepare:function(e){var t=model.units[e];this.step=0,this.time=0,this.x=-t.x,this.y=-t.y,controller.playSound("EXPLODE")},render:function(){var e=this.step,t=view.getInfoImageForType("EXPLOSION_GROUND"),o=this.x,n=this.y,r=TILE_LENGTH,i=48*e,a=0,l=48,s=48,c=o*r,u=n*r,d=r,m=r;view.canvasCtx.drawImage(t,i,a,l,s,c,u,d,m),view.markForRedraw(o,n)},update:function(e){this.time+=e,this.time>75&&(this.step++,this.time=0)},isDone:function(){return 10===this.step}}),model.modifyVisionAt.listenCommand(function(e,t,o,n){n=10;var r,i,a=t-n,l=t+n;for(0>a&&(a=0),l>=model.mapHeight&&(l=model.mapHeight-1);l>=a;a++){var s=Math.abs(a-t);
for(r=e-n+s,i=e+n-s,0>r&&(r=0),i>=model.mapWidth&&(i=model.mapWidth-1);i>=r;r++){view.markForRedraw(r,a);var c=model.unitPosMap[r][a];null!==c&&c.hidden&&controller.updateUnitStatus(model.extractUnitId(c))}}}),model.recalculateFogMap.listenCommand(function(){view.completeRedraw()}),view.registerAnimationHook({key:"moveUnit",prepare:function(e,t,o,n){this.moveAnimationX=o,this.moveAnimationY=n,this.moveAnimationIndex=0,this.moveAnimationPath=e,this.moveAnimationUid=t,this.moveAnimationShift=0,this.moveAnimationDustX=-1,this.moveAnimationDustY=-1,this.moveAnimationDustTime=-1,this.moveAnimationDustStep=-1,this.moveAnimationDustPic=null,view.preventRenderUnit=model.units[t],model.units[t].type.movetype,DEBUG&&util.log("drawing move from","(",this.moveAnimationX,",",this.moveAnimationY,")","with path","(",this.moveAnimationPath,")")},update:function(e){var t=TILE_LENGTH;if(this.moveAnimationShift+=e/1e3*8*t,view.markForRedrawWithNeighboursRing(this.moveAnimationX,this.moveAnimationY),-1!==this.moveAnimationDustStep&&(this.moveAnimationDustTime+=e,this.moveAnimationDustTime>30&&(this.moveAnimationDustStep++,this.moveAnimationDustTime=0,3===this.moveAnimationDustStep&&(this.moveAnimationDustStep=-1))),this.moveAnimationShift>t){switch(this.moveAnimationDustX=this.moveAnimationX,this.moveAnimationDustY=this.moveAnimationY,this.moveAnimationDustTime=0,this.moveAnimationDustStep=0,this.moveAnimationPath[this.moveAnimationIndex]){case model.MOVE_CODE_UP:this.moveAnimationY--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_U");break;case model.MOVE_CODE_RIGHT:this.moveAnimationX++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_R");break;case model.MOVE_CODE_DOWN:this.moveAnimationY++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_D");break;case model.MOVE_CODE_LEFT:this.moveAnimationX--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_L")}this.moveAnimationIndex++,this.moveAnimationShift-=t,this.moveAnimationIndex===this.moveAnimationPath.length&&(this.moveAnimationX=0,this.moveAnimationY=0,this.moveAnimationIndex=0,this.moveAnimationPath=null,this.moveAnimationUid=-1,this.moveAnimationShift=0,view.preventRenderUnit=null)}},render:function(){var e,t=this.moveAnimationUid,o=this.moveAnimationX,n=this.moveAnimationY,r=this.moveAnimationShift,i=this.moveAnimationPath[this.moveAnimationIndex],a=model.units[t],l=view.colorArray[a.owner],s=a.type;switch(i){case model.MOVE_CODE_UP:e=view.IMAGE_CODE_UP;break;case model.MOVE_CODE_RIGHT:e=view.IMAGE_CODE_RIGHT;break;case model.MOVE_CODE_DOWN:e=view.IMAGE_CODE_DOWN;break;case model.MOVE_CODE_LEFT:e=view.IMAGE_CODE_LEFT}var c=view.getUnitImageForType(s.ID,e,l),u=TILE_LENGTH,d=controller.baseSize,m=2*d*view.getSpriteStep("UNIT"),_=0,p=2*d,E=2*d,f=o*u-u/2,h=n*u-u/2,I=u+u,v=u+u;switch(i){case model.MOVE_CODE_UP:h-=r;break;case model.MOVE_CODE_LEFT:f-=r;break;case model.MOVE_CODE_RIGHT:f+=r;break;case model.MOVE_CODE_DOWN:h+=r}if(void 0!==c)view.canvasCtx.drawImage(c,m,_,p,E,f,h,I,I);else{switch(f=o*u,h=n*u,I=u,v=u,i){case model.MOVE_CODE_UP:h-=r;break;case model.MOVE_CODE_LEFT:f-=r;break;case model.MOVE_CODE_RIGHT:f+=r;break;case model.MOVE_CODE_DOWN:h+=r}view.canvasCtx.fillStyle="rgb(255,0,0)",view.canvasCtx.fillRect(f,h,I,v)}if(-1!==this.moveAnimationDustStep){var u=TILE_LENGTH;m=2*d*this.moveAnimationDustStep,_=0,p=2*d,E=2*d,f=this.moveAnimationDustX*u-u/2,h=this.moveAnimationDustY*u-u/2,I=u+u,v=u+u,view.canvasCtx.drawImage(this.moveAnimationDustPic,m,_,p,E,f,h,I,v)}},isDone:function(){var e=-1===this.moveAnimationUid;return e&&util.log("DONE"),e}}),model.invokeNextStep_.listenCommand(function(){"IDLE"!==controller.stateMachine.state&&controller.showMenu(controller.stateMachine.data.menu,controller.mapCursorX,controller.mapCursorY)}),controller.playSoundForPlayer=function(e){var t=model.players[e].mainCo;Browser.ios?controller.playMusic(model.factionTypes[t.faction].music):controller.playMusic(t.music)},view.registerAnimationHook({key:"nextTurn",prepare:function(){controller.renderPlayerInfo(),controller.playSoundForPlayer(model.turnOwner),view.showInfoMessage(model.localized("day")+" "+model.day)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),model.transferMoney.listenCommand(function(){controller.renderPlayerInfo()}),model.transferUnit.listenCommand(function(e){var t=model.units[e],o=-t.x,n=-t.y;controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[o][n]))}),view.registerAnimationHook({key:"trapWait",prepare:function(e){var t=model.units[e];this.time=0,this.xp=t.x+1,this.yp=t.y,this.x=(t.x+1)*TILE_LENGTH,this.y=t.y*TILE_LENGTH},render:function(){var e=view.getInfoImageForType("TRAPPED");view.canvasCtx.drawImage(e,this.x,this.y)},update:function(e){this.time+=e},isDone:function(){var e=this.time>1e3;if(e)for(var t=view.getInfoImageForType("TRAPPED"),o=this.yp,n=this.xp,r=n+parseInt(t.width/TILE_LENGTH,10);r>=n;n++)view.markForRedraw(n,o);return e}}),model.damageUnit.listenCommand(function(e){controller.updateUnitStatus(e)}),model.healUnit.listenCommand(function(e){controller.updateUnitStatus(e)}),model.battleBetween.listenCommand(function(e,t){controller.renderPlayerInfo(),controller.updateUnitStatus(e),controller.updateUnitStatus(t)}),model.buildUnit.listenCommand(function(){controller.renderPlayerInfo()}),model.loadUnitInto.listenCommand(function(e,t){controller.updateUnitStatus(t)}),model.unloadUnitFrom.listenCommand(function(e){controller.updateUnitStatus(e)}),model.joinUnits.listenCommand(function(e,t){controller.updateUnitStatus(t)}),model.refillResources.listenCommand(function(e){"number"==typeof e.x&&(e=model.extractUnitId(e)),controller.updateUnitStatus(e)}),model.clearUnitPosition.listenCommand(function(e){var t=model.units[e],o=-t.x,n=-t.y;model.isValidPosition(o-1,n)&&model.unitPosMap[o-1][n]&&controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[o-1][n])),model.isValidPosition(o+1,n)&&model.unitPosMap[o+1][n]&&controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[o+1][n])),model.isValidPosition(o,n+1)&&model.unitPosMap[o][n+1]&&controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[o][n+1])),model.isValidPosition(o,n-1)&&model.unitPosMap[o][n-1]&&controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[o][n-1]))}),model.setUnitPosition.listenCommand(function(e){controller.updateUnitStatus(e)}),model.hideUnit.listenCommand(function(e){controller.updateUnitStatus(e)}),model.unhideUnit.listenCommand(function(e){controller.updateUnitStatus(e)}),util.scoped(function(){var e=util.matrix(4*CWT_MAX_SELECTION_RANGE+1,4*CWT_MAX_SELECTION_RANGE+1,0);controller.attackRangeVisible=!1,controller.showAttackRangeInfo=function(){if(!controller.attackRangeVisible){var t=controller.mapCursorX,o=controller.mapCursorY,n=model.unitPosMap[t][o];if(null!==n){var r=model.extractUnitId(n);DEBUG&&util.log("show attack range information");var i=controller.stateMachine.data.selection;if(i.setCenter(t,o,CWT_INACTIVE_ID),model.isIndirectUnit(r))model.attackRangeMod_(r,t,o,i);else{controller.stateMachine.data.movePath.fillMoveMap(t,o,n),i.data.cloneValues(e),i.setCenter(t,o,CWT_INACTIVE_ID);for(var a=e.length,l=0;a>l;l++)for(var s=0;a>s;s++)e[l][s]>=0&&model.attackRangeMod_(r,l,s,i,!0)}controller.attackRangeVisible=!0}}},controller.hideAttackRangeInfo=function(){controller.attackRangeVisible&&(DEBUG&&util.log("hide attack range information"),view.markSelectionMapForRedraw(controller.stateMachine.data),controller.attackRangeVisible=!1)}}),controller.registerMenuRenderer("buildUnit",function(e,t){var o=model.unitTypes[e].cost;t.innerHTML=model.localized(e)+" ("+o+"$)"}),util.scoped(function(){var e=document.getElementById("bottomBar_name"),t=document.getElementById("bottomBar_unit_row1"),o=document.getElementById("bottomBar_unit_row2"),n=document.getElementById("bottomBar_hp"),r=document.getElementById("bottomBar_fuel"),i=document.getElementById("bottomBar_ammo"),a=document.getElementById("bottomBar_fuel2"),l=document.getElementById("bottomBar_ammo2"),s=document.getElementById("bottomBar_attrange"),c=document.getElementById("bottomBar_attrange2"),u=document.getElementById("bottomBar_hp_d"),d=document.getElementById("bottomBar_fuel_d"),m=document.getElementById("bottomBar_ammo_d"),_=document.getElementById("bottomBar_attrange_d"),p=document.getElementById("bottomBar_playerName"),E=document.getElementById("bottomBar_playerpower"),f=document.getElementById("bottomBar_playergold"),h=document.getElementById("bottomBar_tplayerName"),I=document.getElementById("bottomBar_tplayerpower"),v=document.getElementById("bottomBar_tplayergoldrow"),g=document.getElementById("bottomBar_tplayergold"),T=document.getElementById("bottomBar_tilename"),y=document.getElementById("bottomBar_tile_row1"),M=document.getElementById("bottomBar_tile_row2"),O=document.getElementById("bottomBar_defense_d"),w=document.getElementById("bottomBar_defense"),A=document.getElementById("bottomBar_capPt_d"),C=document.getElementById("bottomBar_capPt"),S=document.getElementById("bottomBar_capPt2"),N=!1;controller.updateTileInformation=function(){var p,E=controller.mapCursorX,f=controller.mapCursorY,D=model.unitPosMap[E][f],L=model.propertyPosMap[E][f];if(N||(u.getContext("2d").drawImage(view.getInfoImageForType("SYM_HP"),0,0),d.getContext("2d").drawImage(view.getInfoImageForType("SYM_FUEL"),0,0),m.getContext("2d").drawImage(view.getInfoImageForType("SYM_AMMO"),0,0),_.getContext("2d").drawImage(view.getInfoImageForType("SYM_ATT"),0,0),O.getContext("2d").drawImage(view.getInfoImageForType("SYM_DEFENSE"),0,0),A.getContext("2d").drawImage(view.getInfoImageForType("SYM_CAPTURE"),0,0),N=!0),controller.renderPlayerInfo(),D){p=D.type,e.innerHTML=model.localized(p.ID),n.innerHTML=D.hp,r.innerHTML=D.fuel,a.innerHTML=p.fuel,i.innerHTML=D.ammo,l.innerHTML=p.ammo;var R=p.attack;R?(s.innerHTML=R.minrange||1,c.innerHTML=R.maxrange||1):(s.innerHTML="",c.innerHTML=""),e.style.opacity=1,t.style.opacity=1,o.style.opacity=1}else e.style.opacity=0,t.style.opacity=0,o.style.opacity=0;L?(p=L.type,T.innerHTML=model.localized(p.ID),C.innerHTML=L.capturePoints,S.innerHTML=20,w.innerHTML=p.defense,T.style.opacity=1,y.style.opacity=1,M.style.opacity=1):(T.style.opacity=0,y.style.opacity=0,M.style.opacity=0),p=null,D&&D.owner!==model.turnOwner?p=model.players[D.owner]:L&&L.owner!==model.turnOwner&&(p=model.players[L.owner]),p?(h.innerHTML=p.name,g.innerHTML=p.gold,I.innerHTML=p.power,h.style.opacity=1,v.style.opacity=1,I.style.opacity=1):(h.style.opacity=0,v.style.opacity=0,I.style.opacity=0)},controller.renderPlayerInfo=function(){var e=model.players[model.turnOwner];p.innerHTML=e.name,f.innerHTML=e.gold,E.innerHTML=e.power}}),controller.updateComplexTileInformation=function(){},controller.registerMenuRenderer("__mainMenu__",function(e,t){t.innerHTML=model.localized(e)}),controller.registerMenuRenderer("transferMoney",function(e,t){t.innerHTML=e+"$"}),util.scoped(function(){var e=function(e,t){t.innerHTML=model.players[e].name};controller.registerMenuRenderer("transferProperty",e),controller.registerMenuRenderer("transferUnit",e)}),controller.registerMenuRenderer("unloadUnit",function(e,t){t.innerHTML="done"===e?model.localized("done"):model.localized(model.units[e].type.ID)});