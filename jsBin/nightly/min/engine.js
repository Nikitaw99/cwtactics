var CLIENT_DEBUG=!0,DEBUG=!0,CWT_ACTIONS_BUFFER_SIZE=200,CWT_MAX_MAP_WIDTH=100,CWT_MAX_MAP_HEIGHT=100,CWT_MAX_PLAYER=5,CWT_MAX_UNITS_PER_PLAYER=50,CWT_MAX_PROPERTIES=200,CWT_MAX_SELECTION_RANGE=15,CWT_MAX_MOVE_RANGE=15,CWT_MAX_BUFFER_SIZE=200,CWT_INACTIVE_ID=-1,CWT_VERSION="Milestone 2.7",model={},controller={},view={},util={};if(util.injectMod=function(){util.raiseError("inject mod function is not re-defined in the client")},util.fill=function(e,t){var n="function"==typeof t;if(e.__matrixArray__===!0)for(var o=0,r=e.length;r>o;o++)for(var i=0,a=e.length;a>i;i++)e[o][i]=n?t(o,i):t;else for(var o=0,r=e.length;r>o;o++)e[o]=n?t(o):t},util.list=function(e,t){void 0===t&&(t=null);for(var n="function"==typeof t,o=[],r=0;e>r;r++)o[r]=n?t(r):t;return o},util.matrix=function(e,t,n){void 0===n&&(n=null);for(var o="function"==typeof n,r=[],i=0;e>i;i++){r[i]=[];for(var a=0;t>a;a++)r[i][a]=o?n(i,a):n}return r.__matrixArray__=!0,r},util.i18n_data={en:{}},util.i18n_lang=util.i18n_data.en,util.i18n_localized=function(e){var t=this.i18n_lang[e];return void 0===t?e:t},util.i18n_setLanguage=function(e){if(!util.i18n_data.hasOwnProperty(e))throw Error("unknown language");util.i18n_lang=util.i18n_data[e]},util.i18n_appendToLanguage=function(e,t){util.i18n_data.hasOwnProperty(e)||(util.i18n_data[e]={});for(var n=util.i18n_data[e],o=Object.keys(t),r=0,i=o.length;i>r;r++)n[o[r]]=t[o[r]]},util.raiseError=function(e){throw 0===arguments.length?e="CustomWars Debug:: An error was raised":arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),Error(e)},util.log=function(e){arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),console.log(e)},util.logInfo=function(){util.log.apply(this,arguments)},util.createRingBuffer=function(e){var t={push:function(e){if(null!==this._data[this._wInd])throw Error("message buffer is full");this._data[this._wInd]=e,this._wInd++,this._wInd===this._size&&(this._wInd=0)},isEmpty:function(){return null===this._data[this._rInd]},pop:function(){if(null===this._data[this._rInd])throw Error("message buffer is empty");var e=this._data[this._rInd];return this._data[this._rInd]=null,this._rInd++,this._rInd===this._size&&(this._rInd=0),e},clear:function(){this._rInd=0,this._wInd=0;for(var t=0;e>t;t++)this._data[t]=null}};return t._rInd=0,t._wInd=0,t._data=util.list(e,null),t._size=e,t},void 0!==jsonRuleEngine)throw Error("jsonRuleEngine is already defined in the global scope");var jsonRuleEngine=function(){var e={};return e.ruleContexts_={},e.attributeSolver_={},e.tagsSolver_={},e.pushRuleToCtx=function(t,n){e.ruleContexts_.hasOwnProperty(t)||(e.ruleContexts_[t]={});for(var o=Object.keys(n),r=0,i=o.length;i>r;r++){var a=o[r];"when"!==a&&(e.ruleContexts_[t].hasOwnProperty(a)||(e.ruleContexts_[t][a]=[]),e.ruleContexts_[t][a].push(n))}},e.removeRuleFromCtx=function(t,n){if(!e.ruleContexts_.hasOwnProperty(t))throw Error("given context is not created");for(var o=Object.keys(n),r=0,i=o.length;i>r;r++){var a=o[r];if("when"!==a&&!e.ruleContexts_[t].hasOwnProperty(a)){var l=e.ruleContexts_[t][a],s=l.indexOf(n);-1!==s&&l.splice(s,1)}}},e.registerResolver=function(t){if(!t.hasOwnProperty("key"))throw Error("solver implementation needs a valid key");e.eventSolver_[t.key]=t},e.registerAttributeSolver=function(t,n){e.attributeSolver_[t]=n},e.registerTagsSolver=function(t,n){e.tagsSolver_[t]=n},e.solveAttribute=function(){var t=arguments[arguments.length-4],n=arguments[arguments.length-3],o=arguments[arguments.length-2],r=arguments[arguments.length-1];t=e.tagsSolver_[t],n=e.attributeSolver_[n];var i=t.apply(null,arguments);return n.call(this,i,o,e.ruleContexts_[r][o])},e};if(void 0!==simpleStateMachine)throw Error("simpleStateMachine is already defined in the global scope");var simpleStateMachine=function(){return{BREAK_TRANSITION:"__BREAK_TRS__",state:"NONE",history:[],lastState:"__LAST_STATE_TRS__",structure:{},event:function(e){DEBUG&&util.log("got event",e);var t=this.structure[this.state][e];void 0===t&&util.raiseError("missing event",e,"in state",this.state);var n=t.apply(this,arguments);if(void 0!==n)if(n!==this.BREAK_TRANSITION){var o=n===this.lastState;o&&(n=1===this.history.length?"IDLE":this.history.pop());var r=this.structure[n];if(void 0===r&&util.raiseError("state",n,"is not defined"),void 0!==r.onenter){var i=r.onenter.apply(this,arguments);if(i===this.BREAK_TRANSITION)return}o||this.history.push(this.state),this.state=n,DEBUG&&util.log("changed state to",n),void 0!==r.actionState&&this.event.call(this,"actionState")}else"actionState"===e&&util.raiseError("an action state cannot return a break transition");else util.raiseError("an event must return a transition command")}}};util.FUNCTION_TRUE_RETURNER=function(){return!0},util.FUNCTION_FALSE_RETURNER=function(){return!1},model.fogData=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,0),model.ruleTable={},model.ruleTable.dataLevel={funds:1e3,noUnitsLeftLoose:!1,autoSupplyAtTurnStart:!0,cityRepair:20,captureWinLimit:0,turnTimeLimit:3e6,dayLimit:0,daysOfPeace:0,unitLimit:50,blockedUnits:[],att:100,def:100,cAtt:100,funds:1e3,vision:0,moveRange:0,siloRegeneration:-1,fogEnabled:!0,usableSilo:!0,resupplyUnitOnAlliedProperties:!0,healUnitsOnProperties:!0,healUnitsOnAlliedProperties:!0},model.ruleTable.mapLevel=Object.create(model.ruleTable.dataLevel),model.ruleTable.roundLevel=Object.create(model.ruleTable.mapLevel),model.ruleTable.playerLevel=Object.create(model.ruleTable.roundLevel),model.rules=model.ruleTable.playerLevel,model.setRulesByOption=function(e){for(var t=model.sheets.defaultRules,n=model.rules,o=Object.keys(t),r=0,i=o.length;i>r;r++){var a=o[r];n[a]=e.hasOwnProperty(a)?e[a]:t[a]}},model.setRule=function(e){var t=e.split(" "),n=t[0],o=t[1];switch(n){case"siloRegenerationDays":model.rules.siloRegeneration=model.daysToTurns(o);break;case"siloRegenerationTurns":model.rules.siloRegeneration=o;break;default:util.raiseError("unknown gamerule",n)}},model.map=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.mapHeight=-1,model.mapWidth=-1,model.distance=function(e,t,n,o){var r=Math.abs(e-n),i=Math.abs(t-o);return r+i},model.moveCodeFromAtoB=function(e,t,n,o){return 1!==model.distance(e,t,n,o)&&util.raiseError("both positions haven't a distance of 1"),e>n?model.MOVE_CODE_LEFT:n>e?model.MOVE_CODE_RIGHT:t>o?model.MOVE_CODE_UP:o>t?model.MOVE_CODE_DOWN:(util.unexpectedSituationError(),void 0)},model.isValidPosition=function(e,t){return e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t},model.thereIsAnOwnUnitAt=function(e,t,n){if(!model.isValidPosition(e,t))return!1;var o=model.unitPosMap[e][t];return null!==o&&n===o.owner},model.thereIsAnAlliedUnitAt=function(e,t,n){if(!model.isValidPosition(e,t))return!1;var o=model.unitPosMap[e][t];return null!==o&&n!==o.owner&&model.players[n].team===model.players[o.owner].team},model.thereIsAnEnemyUnitAt=function(e,t,n){if(!model.isValidPosition(e,t))return!1;var o=model.unitPosMap[e][t];return null!==o&&n!==o.owner&&model.players[n].team!==model.players[o.owner].team},model.MOVE_CODE_UP=0,model.MOVE_CODE_RIGHT=1,model.MOVE_CODE_DOWN=2,model.MOVE_CODE_LEFT=3,model.fillMoveMap=function(e){var t=e.sourceUnit,n=model.sheets.unitSheets[t.type],o=model.sheets.movetypeSheets[n.moveType],r=model.players[t.owner],i=n.moveRange,a=e.sourceX,l=e.sourceY,s=model.weather.ID;i>t.fuel&&(i=t.fuel),e.setSelectionCenter(a,l,CWT_INACTIVE_ID),e.setSelectionValueAt(a,l,i);for(var u=[a,l,i],d=[-1,-1,-1,-1,-1,-1,-1,-1];;){for(var c=-1,m=-1,p=0,h=u.length;h>p;p+=3){var _=u[p+2];void 0!==_&&null!==_&&(-1===c||_>c)&&(c=_,m=p)}if(-1===m)break;var f=u[m],E=u[m+1],T=u[m+2];u[m]=null,u[m+1]=null,u[m+2]=null,f>0?(d[0]=f-1,d[1]=E):(d[0]=-1,d[1]=-1),model.mapWidth-1>f?(d[2]=f+1,d[3]=E):(d[2]=-1,d[3]=-1),E>0?(d[4]=f,d[5]=E-1):(d[4]=-1,d[5]=-1),model.mapHeight-1>E?(d[6]=f,d[7]=E+1):(d[6]=-1,d[7]=-1);for(var g=0;8>g;g+=2)if(-1!==d[g]){var A=d[g],y=d[g+1],v=model.moveCosts(o,model.map[A][y],s);if(0!==v){var I=model.unitPosMap[A][y];if(null!==I&&model.fogData[A][y]>0&&!I.hidden&&model.players[I.owner].team!==r.team)continue;var S=T-v;if(S>=0&&S>e.getSelectionValueAt(A,y)){e.setSelectionValueAt(A,y,S);for(var p=0,h=u.length;h>=p;p+=3)if(null===u[p]||p===h){u[p]=A,u[p+1]=y,u[p+2]=S;break}}}}}for(var a=0,O=model.mapWidth;O>a;a++)for(var l=0,P=model.mapHeight;P>l;l++)if(-1!==e.getSelectionValueAt(a,l)){var v=model.moveCosts(o,model.map[a][l],s);e.setSelectionValueAt(a,l,v)}},model.addCodeToPath=function(e,t,n,o){var r=e.sourceUnit.fuel,i=0,a=e.movePath;a.push(o);var l=model.sheets.unitSheets[e.sourceUnit.type].moveRange;l>r&&(l=r);for(var s=e.sourceX,u=e.sourceY,d=0,c=a.length;c>d;d++){switch(a[d]){case model.MOVE_CODE_UP:u--;break;case model.MOVE_CODE_DOWN:u++;break;case model.MOVE_CODE_LEFT:s--;break;case model.MOVE_CODE_RIGHT:s++;break;default:util.raiseError()}i+=e.getSelectionValueAt(s,u)}i>l&&model.setPathByRecalculation(e,t,n)},model.setPathByRecalculation=function(e,t,n){var o=e.sourceX,r=e.sourceY,i=e.movePath;DEBUG&&util.log("searching path from (",o,",",r,") to (",t,",",n,")");var a=new Graph(e.selectionData),l=o-e.selectionCX,s=r-e.selectionCY,u=a.nodes[l][s],d=t-e.selectionCX,c=n-e.selectionCY,m=a.nodes[d][c],p=astar.search(a.nodes,u,m);DEBUG&&util.log("calculated way is",p);for(var h,_=[],f=o,E=r,T=0,g=p.length;g>T;T++){h=p[T];var A;h.x>f?A=model.MOVE_CODE_RIGHT:f>h.x?A=model.MOVE_CODE_LEFT:h.y>E?A=model.MOVE_CODE_DOWN:E>h.y?A=model.MOVE_CODE_UP:util.raiseError(),_.push(A),f=h.x,E=h.y}i.splice(0);for(var T=0,g=_.length;g>T;T++)i[T]=_[T]},model.players=util.list(CWT_MAX_PLAYER+1,function(e){var t=e===CWT_MAX_PLAYER;return{gold:0,team:t?9999:CWT_INACTIVE_ID,name:t?"NEUTRAL":null,mainCo:null,sideCo:null,power:0}}),model.isNeutralPlayer=function(e){return model.neutralPlayerId===e},model.extractPlayerId=function(e){null===e&&util.raiseError("player argument cannot be null");for(var t=model.players,n=0,o=t.length;o>n;n++)if(t[n]===e)return n;util.raiseError("cannot find player",t)},model.neutralPlayerId=model.players.length-1,model.alliedPlayers=function(e,t){return model.players[e].team===model.players[t].team},model.enemyPlayers=function(e,t){return model.players[e].team!==model.players[t].team},model.properties=util.list(CWT_MAX_PROPERTIES+1,function(){return{capturePoints:20,owner:-1,type:null}}),model.propertyPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.tileIsProperty=function(e,t){var n=model.propertyPosMap[e][t];return null!==n},model.extractPropertyId=function(e){null===e&&util.raiseError("property argument cannot be null");for(var t=model.properties,n=0,o=t.length;o>n;n++)if(t[n]===e)return n;util.raiseError("cannot find property",e)},model.countProperties=function(e){for(var t=0,n=model.properties,o=0,r=n.length;r>o;o++)n[o].owner===e&&t++;return t},model.RELATIONSHIP_SAME_OWNER=0,model.RELATIONSHIP_ALLIED=1,model.RELATIONSHIP_ENEMY=2,model.RELATIONSHIP_NONE=3,model.RELATIONSHIP_SAME_OBJECT=4,model.relationshipBetween=function(e,t){if(null===e||null===t)return model.RELATIONSHIP_NONE;if("number"!=typeof e&&"number"!=typeof t&&e===t)return model.RELATIONSHIP_SAME_OBJECT;if("number"!=typeof e&&(e=e.owner),"number"!=typeof t&&(t=t.owner),e===t)return model.RELATIONSHIP_SAME_OWNER;var n=model.players[e],o=model.players[t];return n===o?model.RELATIONSHIP_ALLIED:model.RELATIONSHIP_ENEMY},model.day=0,model.turnOwner=-1,model.leftActors=util.list(CWT_MAX_UNITS_PER_PLAYER,!1),model.canAct=function(e){var t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;if(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)return!1;var n=e-t;return model.leftActors[n]===!0},model.isTurnOwner=function(e){return model.turnOwner===e},model.daysToTurns=function(e){return model.players.length*e},model.weather=null,model.weatherDays=0,model.sheets={},model.sheets._dbAmanda=amanda("json"),model.sheets.UNIT_TYPE_SHEET=0,model.sheets.TILE_TYPE_SHEET=1,model.sheets.WEAPON_TYPE_SHEET=2,model.sheets.WEATHER_TYPE_SHEET=3,model.sheets.MOVE_TYPE_SHEET=4,model.sheets.RULESET=5,model.PRIMARY_WEAPON_TAG="mainWeapon",model.SECONDARY_WEAPON_TAG="subWeapon",model.sheets.unitSheets={},model.sheets.tileSheets={},model.sheets.weaponSheets={},model.sheets.weatherSheets={},model.sheets.movetypeSheets={},model.sheets.defaultRules=null,model.sheets.typeSheetValidators={rulesValidator:{type:"object",properties:{funds:{type:"integer",minimum:0,maximum:99999},noUnitsLeftLoose:{type:"boolean"},captureWinLimit:{type:"integer",minimum:0,maximum:99999},turnTimeLimit:{type:"integer",minimum:0,maximum:36e5},dayLimit:{type:"integer",minimum:0,maximum:99999},unitLimit:{type:"integer",minimum:1,maximum:50},blockedUnits:{type:"array"}}},unitValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},cost:{type:"integer",minimum:0},fuelConsumption:{type:"integer",minimum:0},maxAmmo:{type:"integer",minimum:0,maximum:99},maxFuel:{type:"integer",minimum:0,maximum:99,required:!0},moveRange:{type:"integer",minimum:0,maximum:15,required:!0},moveType:{type:"string",required:!0},weight:{type:"integer",required:!0}}},tileValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},capturePoints:{type:"integer",minimum:1,maximum:99},defense:{type:"integer",minimum:0,maximum:5}}},weaponValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},noMoveAndFire:{type:"boolean"}}},weatherValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},visionChange:{type:"integer"}}},movetypeValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},costs:{type:"object",properties:{type:"object",patternProperties:{"[.]*":{type:"integer",minimum:0}}}}}}},model.sheets.toJSON=function(){return void 0},model.parseSheet=function(e,t){var n,o,r,i=e.ID,a=model.sheets.typeSheetValidators;switch(t){case model.sheets.UNIT_TYPE_SHEET:n=a.unitValidator,o=model.sheets.unitSheets,r=a.unitValidator.properties.ID.except;break;case model.sheets.TILE_TYPE_SHEET:n=a.tileValidator,o=model.sheets.tileSheets,r=a.tileValidator.properties.ID.except;break;case model.sheets.WEAPON_TYPE_SHEET:n=a.weaponValidator,o=model.sheets.weaponSheets,r=a.weaponValidator.properties.ID.except;break;case model.sheets.WEATHER_TYPE_SHEET:n=a.weatherValidator,o=model.sheets.weatherSheets,r=a.weatherValidator.properties.ID.except;break;case model.sheets.MOVE_TYPE_SHEET:n=a.movetypeValidator,o=model.sheets.movetypeSheets,r=a.movetypeValidator.properties.ID.except;break;case model.sheets.RULESET:n=a.rulesValidator;break;default:util.raiseError("unknow type",t)}t!==model.sheets.RULESET&&o.hasOwnProperty(i)&&util.raiseError(i,"is already registered"),model.sheets._dbAmanda.validate(e,n,function(e){e&&util.raiseError("failed to parse sheet due",e.getMessages())}),t===model.sheets.RULESET?model.sheets.defaultRules=e:(o[i]=e,r.push(i))},model.getListOfUnitTypes=function(){return Object.keys(model.sheets.unitSheets)},model.getListOfPropertyTypes=function(){for(var e=model.sheets.tileSheets,t=Object.keys(e),n=[],o=t.length-1;o>=0;o--)e[t[o]].capturePoints>0&&n.push(t[o]);return n},model.getListOfTileTypes=function(){for(var e=model.sheets.tileSheets,t=Object.keys(e),n=[],o=t.length-1;o>=0;o--)void 0===e[t[o]].capturePoints&&n.push(t[o]);return n},model.primaryWeaponOfUnit=function(e){DEBUG&&null===e&&util.raiseError(),"number"==typeof e&&(e=model.units[e]);var t=model.sheets.unitSheets[e.type][model.PRIMARY_WEAPON_TAG];return void 0!==t?model.sheets.weaponSheets[t]:null},model.secondaryWeaponOfUnit=function(e){DEBUG&&null===e&&util.raiseError(),"number"==typeof e&&(e=model.units[e]);var t=model.sheets.unitSheets[e.type][model.SECONDARY_WEAPON_TAG];return void 0!==t?model.sheets.weaponSheets[t]:null},model.getBaseDamage=function(e,t){DEBUG&&null===e&&util.raiseError(),DEBUG&&null===t&&util.raiseError();var n;return n=e.damages[t],void 0!==n?n:(n=e.damages["*"],void 0!==n?n:0)},model.moveCosts=function(e,t,n){var o,r=e.costs[n];return o=r[t],void 0===o&&(o=r["*"]),o},model.regeneratingSilos={},model.getLoadedIds=function(e){for(var t=[],n=model.units[e].owner,o=CWT_MAX_UNITS_PER_PLAYER*n,r=o+CWT_MAX_UNITS_PER_PLAYER;r>o;o++)if(o!==e){var i=model.units[o];null!==i&&i.loadedIn===e&&t.push(o)}return t},model.hasLoadedIds=function(e){for(var t=model.units[e].owner,n=CWT_MAX_UNITS_PER_PLAYER*t,o=n+CWT_MAX_UNITS_PER_PLAYER;o>n;n++)if(n!==e){var r=model.units[n];if(null!==r&&r.loadedIn===e)return!0}return!1},model.isLoadedBy=function(e,t){return model.units[e].loadedIn===t},model.loadUnitInto=function(e,t){model.canLoad(e,t)||util.logError("transporter unit",t,"cannot load unit",e),model.units[e].loadedIn=t},model.unloadUnitFrom=function(e){model.units[e].loadedIn=-1},model.canLoad=function(e,t){e===t&&util.raiseError();for(var n=model.units[t],o=model.units[e],r=0,i=CWT_MAX_UNITS_PER_PLAYER*n.owner,a=i+CWT_MAX_UNITS_PER_PLAYER;a>i;i++)if(i!==t){var l=model.units[i];null!==l&&l.loadedIn===t&&(r+=model.sheets.unitSheets[model.units[i].type].weight)}r+=model.sheets.unitSheets[o.type].weight;var s=model.sheets.unitSheets[n.type].transport;if(r>s.maxWeight)return!1;var u=model.sheets.unitSheets[model.units[e].type],d=s.canLoad;return-1!==d.indexOf(model.units[e].type)?!0:-1!==d.indexOf(u.moveType)?!0:-1!==d.indexOf("*")?!0:!1},model.isTransport=function(e){return void 0!==model.sheets.unitSheets[model.units[e].type].transport},model.unitPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.units=util.list(CWT_MAX_PLAYER*CWT_MAX_UNITS_PER_PLAYER,function(){return{x:0,y:0,hp:99,ammo:0,fuel:0,type:null,loadedIn:-1,hidden:!1,owner:CWT_INACTIVE_ID}}),model.extractUnitId=function(e){null===e&&util.raiseError("unit argument cannot be null");for(var t=model.units,n=0,o=t.length;o>n;n++)if(t[n]===e)return n;util.raiseError("cannot find unit",e)},model.hasFreeUnitSlots=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,n=0,o=t+CWT_MAX_UNITS_PER_PLAYER;o>n;n++)if(model.units[n].owner!==CWT_INACTIVE_ID)return!0;return!1},model.tileOccupiedByUnit=function(e,t){var n=model.unitPosMap[e][t];return null===n?!1:model.extractUnitId(n)},model.countUnits=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,n=0,o=t,r=t+CWT_MAX_UNITS_PER_PLAYER;r>o;o++)model.units[o].owner!==CWT_INACTIVE_ID&&n++;return n},model.unitHpPt=function(e){return parseInt(e.hp/10)+1},model.unitHpPtRest=function(e){var t=parseInt(e.hp/10)+1;return e.hp-t},model.ptToHp=function(e){return 10*e},controller.actions={},controller.actionObjects_={},controller.engineAction=function(e){e.hasOwnProperty("key")||util.raiseError("action key isn't defined"),controller.actionObjects_.hasOwnProperty(e.key)&&util.raiseError("action key is already registered"),e.hasOwnProperty("name")||util.raiseError("action name isn't defined"),e.hasOwnProperty("action")||util.raiseError("action implementation isn't defined"),e.hasOwnProperty("condition")||(e.condition=!1),e.hasOwnProperty("shared")||(e.shared=!1);var t=e.key;controller.actions[e.name]=function(){var e=controller.actionObjects_[t];e.action.apply(e,arguments)},controller.actionObjects_[t]=e},controller.userAction=function(e){e.hasOwnProperty("condition")||(e.condition=util.FUNCTION_TRUE_RETURNER),e.hasOwnProperty("prepareMenu")||(e.prepareMenu=null),e.hasOwnProperty("prepareTargets")||(e.prepareTargets=null),e.hasOwnProperty("isTargetValid")||(e.isTargetValid=null),e.hasOwnProperty("multiStepAction")||(e.multiStepAction=!1),e.hasOwnProperty("shared")||(e.shared=!0),null===e.prepareTargets||e.hasOwnProperty("targetSelectionType")||(e.targetSelectionType="A"),e.hasOwnProperty("createDataSet")||util.raiseError("action data set creation handler isn't defined"),null!==e.prepareTargets&&null!==e.isTargetValid&&util.raiseError("only one selection type can be used in an action"),controller.engineAction(e)},controller.clientAction=function(e){e.shared=!1,controller.userAction(e)},controller.getActionObject=function(e){return controller.actionObjects_[e]},controller.actionBuffer_=util.createRingBuffer(CWT_ACTIONS_BUFFER_SIZE),controller.pushSharedAction=function(){var e=controller.actionObjects_[arguments[arguments.length-1]];e.shared&&controller.isNetworkGame()&&this.sendNetworkMessage_(arguments),controller.pushAction.apply(this,arguments)},controller.pushAction=function(){DEBUG&&util.log("push action",JSON.stringify(arguments),"into action stack"),controller.actionBuffer_.push(arguments)},controller.noNextActions=function(){return controller.actionBuffer_.isEmpty()},controller.doNextAction=function(){if(controller.actionBuffer_.isEmpty())return null;var e=controller.actionBuffer_.pop();DEBUG&&util.log("evaluate action",JSON.stringify(e));var t=controller.actionObjects_[e[e.length-1]];return t.action.apply(t,e),e},controller.serializationHandler={"interface":{save:null,load:null,serializeUnit:null,deserializeUnit:null,serializePlayer:null,deserializePlayer:null,serializeProperty:null,deserializeProperty:null},2.6:{save:function(){var e={};e.day=model.day,e.turnOwner=model.turnOwner,e.mapWidth=model.mapWidth,e.mapHeight=model.mapHeight,e.map=[];for(var t={},n=0,o=0,r=model.mapWidth;r>o;o++){e.map[o]=[];for(var i=0,a=model.mapHeight;a>i;i++){var l=e.map[o][i];t.hasOwnProperty(l)||(t[l]=n,n++),e.map[o][i]=t[l]}}e.typeMap=[];for(var s=Object.keys(t),u=0,d=s.length;d>u;u++)e.typeMap[t[s[u]]]=s[u];e.units=[];for(var u=0,d=model.units.length;d>u;u++)model.units[u].owner!==CWT_INACTIVE_ID&&e.units.push(this.serializeUnit(model.units[u]));e.properties=[];for(var u=0,d=model.properties.length;d>u;u++)model.properties[u].owner!==CWT_INACTIVE_ID&&e.properties.push(this.serializeProperty(model.properties[u]));e.players=[];for(var u=0,d=model.players.length;d>u;u++)model.players[u].team!==CWT_INACTIVE_ID&&e.players.push(this.serializePlayer(model.players[u]));e.actors=[];for(var u=0,d=model.leftActors.length;d>u;u++)model.leftActors[u]&&e.actors.push(u);e.rules={};for(var c=Object.keys(model.rules),u=0,d=c.length;d>u;u++){var m=c[u];e.rules[m]=model.rules[m]}return e},load:function(e){model.day=e.day,model.turnOwner=e.turnOwner,model.mapWidth=e.mapWidth,model.mapHeight=e.mapHeight;for(var t=0,n=model.mapWidth;n>t;t++)for(var o=0,r=model.mapHeight;r>o;o++)model.unitPosMap[t][o]=null,model.propertyPosMap[t][o]=null,model.map[t][o]=e.typeMap[e.map[t][o]];for(var i=0,a=model.units.length;a>i;i++)model.units[i].owner=CWT_INACTIVE_ID;for(var i=0,a=e.units.length;a>i;i++)this.deserializeUnit(e.units[i]);for(var i=0,a=model.properties.length;a>i;i++)model.properties[i].owner=CWT_INACTIVE_ID;for(var i=0,a=e.properties.length;a>i;i++)this.deserializeProperty(e.properties[i]);for(var i=0,a=model.players.length;a>i;i++)model.players[i].team=CWT_INACTIVE_ID;for(var i=0,a=e.players.length;a>i;i++)this.deserializePlayer(e.players[i]);for(var i=0,a=model.leftActors.length;a>i;i++)model.leftActors[i]=!1;for(var i=0,a=e.leftActors.length;a>i;i++)model.leftActors[e.leftActors[i]]=!0;model.setRulesByOption(e.rules)},serializeUnit:function(e){return[model.extractUnitId(e),e.type,e.x,e.y,e.hp,e.ammo,e.fuel,e.loadedIn,e.owner]},deserializeUnit:function(e){var t=e[0],n=model.units[t];n.type=e[1],n.x=e[2],n.y=e[3],n.hp=e[4],n.ammo=e[5],n.fuel=e[6],n.loadedIn=e[7],n.owner=e[8],model.unitPosMap[e[2]][e[3]]=n},serializePlayer:function(e){return[e.extractPlayerId(e),e.name,e.gold,e.team]},deserializePlayer:function(e){var t=e[0],n=model.players[t];n.name=e[1],n.gold=e[2],n.team=e[3]},serializeProperty:function(e){for(var t,n,o=!1,r=0;model.mapWidth>r&&!o;r++)for(var i=0;model.mapHeight>i&&!o;i++)model.propertyPosMap[r][i]===e&&(t=r,n=i,o=!0);return[model.extractPropertyId(e),t,n,e.type,e.capturePoints,e.owner]},deserializeProperty:function(e){var t=e[0],n=model.properties[t];n.type=e[3],n.capturePoints=e[4],n.owner=e[5],model.propertyPosMap[e[1]][e[2]]=n}}},controller.CURRENT_SERIALIZATION_HANDLER="2.6",controller.getActiveSerializationHandler=function(e){return 1===arguments.length?(DEBUG&&!controller.serializationHandler.hasOwnProperty(e)&&util.raiseError("unknown map format"),controller.serializationHandler[e]):controller.serializationHandler[controller.CURRENT_SERIALIZATION_HANDLER]},controller.isNetworkGame=function(){return!1},controller._parseNetworkMessage=function(){util.unexpectedSituationError()},controller.sendNetworkMessage_=function(){util.unexpectedSituationError()},controller.script=jsonRuleEngine(),controller.stateMachine=simpleStateMachine(),controller.stateMachine.data={setPosition_:function(e,t,n){var o;this[e[0]]=t,this[e[1]]=n;var r=-1!==t&&-1!==n,i=r?0===model.fogData[t][n]:!1;o=r?model.unitPosMap[t][n]:null,!r||i||null===o||o.hidden&&o.owner!==model.turnOwner&&model.players[o.owner].team!=model.players[model.turnOwner].team?(this[e[2]]=null,this[e[3]]=-1):(this[e[2]]=o,this[e[3]]=model.extractUnitId(o)),o=r?model.propertyPosMap[t][n]:null,r&&!i&&null!==o?(this[e[4]]=o,this[e[5]]=model.extractPropertyId(o)):(this[e[4]]=null,this[e[5]]=-1)},sourceX:0,sourceY:0,sourceUnit:null,sourceUnitId:-1,sourceProperty:null,sourcePropertyId:-1,sourceTags_:["sourceX","sourceY","sourceUnit","sourceUnitId","sourceProperty","sourcePropertyId"],setSource:function(e,t){this.setPosition_(this.sourceTags_,e,t)},targetX:0,targetY:0,targetUnit:null,targetUnitId:-1,targetProperty:null,targetPropertyId:-1,targetTags_:["targetX","targetY","targetUnit","targetUnitId","targetProperty","targetPropertyId"],setTarget:function(e,t){this.setPosition_(this.targetTags_,e,t)},selectionX:0,selectionY:0,selectionUnit:null,selectionUnitId:-1,selectionProperty:null,selectionPropertyId:-1,selectionTags_:["selectionX","selectionY","selectionUnit","selectionUnitId","selectionProperty","selectionPropertyId"],setSelectionTarget:function(e,t){this.setPosition_(this.selectionTags_,e,t)},movePath:[],cleanMovepath:function(){this.movePath.splice(0)},cloneMovepath:function(){for(var e=[],t=0,n=this.movePath.length;n>t;t++)e[t]=this.movePath[t];return e},action:null,subaction:null,actionObject:null,selectionCX:0,selectionCY:0,selectionData:util.matrix(4*CWT_MAX_SELECTION_RANGE+1,4*CWT_MAX_SELECTION_RANGE+1,0),setSelectionCenter:function(e,t,n){for(var o=this.selectionData,r=o.length,i=e,a=t,e=0;r>e;e++)for(var t=0;r>t;t++)o[e][t]=n;this.selectionCX=Math.max(0,i-2*CWT_MAX_SELECTION_RANGE),this.selectionCY=Math.max(0,a-2*CWT_MAX_SELECTION_RANGE)},getSelectionValueAt:function(e,t){var n=this.selectionData,o=this.selectionCY,r=this.selectionCX;e-=r,t-=o;var i=n.length;return 0>e||0>t||e>=i||t>=i?-1:n[e][t]},setSelectionValueAt:function(e,t,n){var o=this.selectionData,r=this.selectionCY,i=this.selectionCX;e-=i,t-=r;var a=o.length;0>e||0>t||e>=a||t>=a?util.raiseError():o[e][t]=n},prepareSelection:function(){var e=this.targetX,t=this.targetY;return this.setSelectionCenter(e,t,-1),this.actionObject.prepareTargets(this),"A"===this.actionObject.targetSelectionType?"ACTION_SELECT_TARGET_A":"ACTION_SELECT_TARGET_B"},menu:util.list(20,null),menuSize:0,addEntry:function(e){this.menuSize===this.menu.length&&util.raiseError(),this.menu[this.menuSize]=e,this.menuSize++},cleanMenu:function(){this.menuSize=0},prepareMenu:function(){var e=Object.keys(controller.actionObjects_),t=!0,n=this.sourceUnit;null===n||n.owner!==model.turnOwner?t=!1:model.canAct(this.sourceUnitId)||(t=!1);var o=!0,r=this.sourceProperty;null!==n&&(o=!1),(null===r||r.owner!==model.turnOwner)&&(o=!1);for(var i=0,a=e.length;a>i;i++){var l=controller.getActionObject(e[i]);l.condition&&(l.unitAction!==!0||t)&&(l.propertyAction!==!0||o)&&l.condition(this)&&this.addEntry(e[i])}},inMultiStep:!1},controller._turnTimerTime=0,controller.resetTurnTimer=function(){controller._turnTimerTime=0},controller.updateTurnTimer=function(e){controller._turnTimerTime>=0&&model.rules.turnTimeLimit>0&&(controller._turnTimerTime+=e,controller._turnTimerTime>model.rules.turnTimeLimit&&(controller._turnTimerTime=-1,controller.pushSharedAction("NXTR")))},controller.script.registerAttributeSolver("valueResolver",function(e,t,n){for(var o=0,r=0,i=n.length;i>r;r++){var a=n[r];if(a.when){for(var l=!1,s=0,u=a.when.length;u>s;s++)if(!e[a.when[s]]){l=!0;break}if(l)continue;o+=a[t]}else o+=a[t]}return o}),function(){var e={vehicle:!1,tank:!1,foot:!1,air:!1,naval:!1};controller.script.registerTagsSolver("unitValueResolver",function(t){var n=model.sheets.unitSheets[t.type],o=n.moveType;e.vehicle="MV_TIRE_A"===o||"MV_TIRE_B"===o,e.tank="MV_TANK"===o,e.foot="MV_INFANTRY"===o||"MV_MECH"===o,e.air="MV_AIR"===o,e.naval="MV_SHIP"===o||"MV_WATER_TRANSPORT"===o;var r=model.sheets.weaponSheets[n.mainWeapon];return e.direct=void 0!==r&&1===r.minRange,e.indirect=!e.direct,e})}(),controller.stateMachine.structure.ACTION_MENU={onenter:function(){return this.data.cleanMenu(),this.data.prepareMenu(),0===this.data.menuSize?(this.data.setTarget(-1,-1),this.BREAK_TRANSITION):void 0},action:function(e,t){var n=this.data.menu[t],o=controller.getActionObject(n);return this.data.action=n,this.data.actionObject=o,null!==o.prepareMenu?"ACTION_SUBMENU":null!==o.isTargetValid?"ACTION_SELECT_TILE":null!==o.prepareTargets&&"A"===o.targetSelectionType?this.data.prepareSelection():"FLUSH_ACTION"},cancel:function(){return this.data.setTarget(-1,-1),this.lastState}},controller.stateMachine.structure.ACTION_SUBMENU={onenter:function(){this.data.inMultiStep||(this.data.cleanMenu(),controller.getActionObject(this.data.action).prepareMenu(this.data),0===this.data.menuSize&&util.raiseError("sub menu cannot be empty"))},action:function(e,t){var n=this.data.menu[t];return"done"===n?"IDLE":(this.data.subAction=n,null!==this.data.actionObject.prepareTargets&&"B"===this.data.actionObject.targetSelectionType?this.data.prepareSelection():"FLUSH_ACTION")},cancel:function(){return this.data.inMultiStep?this.lastState:(this.data.cleanMenu(),this.data.prepareMenu(),this.lastState)}},controller.stateMachine.structure.FLUSH_ACTION={actionState:function(){var e=!1;if(null!==this.data.movePath)for(var t=this.data.movePath,n=this.data.sourceX,o=this.data.sourceY,r=0,i=t.length;i>r;r++){switch(t[r]){case model.MOVE_CODE_DOWN:o++;break;case model.MOVE_CODE_UP:o--;break;case model.MOVE_CODE_LEFT:n--;break;case model.MOVE_CODE_RIGHT:n++}var a=model.unitPosMap[n][o];null!==a&&model.players[model.turnOwner].team!==model.players[a.owner].team&&(this.data.action="TRWT",this.data.setTarget(n,o),t.splice(r),e=!0)}var l,s,u;return this.data.movePath.length>0&&(l="MOVE",s=controller.getActionObject(l),u=s.createDataSet(this.data),u.push(l),controller.pushSharedAction.apply(null,u)),l=this.data.action,s=this.data.actionObject,u=s.createDataSet(this.data),u.push(l),controller.pushSharedAction.apply(null,u),!e&&s.multiStepAction?(this.data.inMultiStep=!0,controller.pushSharedAction.apply(null,["IVMS"]),"MULTISTEP_IDLE"):"IDLE"}},controller.stateMachine.structure.IDLE={onenter:function(){this.data.cleanMenu(),this.data.cleanMovepath(),this.data.menuSize=0,this.data.inMultiStep=!1,this.data.action=null,this.data.subAction=null,this.data.setTarget(-1,-1),this.data.setSource(-1,-1),this.data.setSelectionTarget(-1,-1),this.history.splice(0),this.data.inMultiStep=!1},action:function(e,t,n){var o=this.data;return o.setSource(t,n),o.sourceUnitId!==CWT_INACTIVE_ID&&o.sourceUnit.owner===model.turnOwner&&model.canAct(o.sourceUnitId)?(this.data.setTarget(t,n),this.data.cleanMovepath(),model.fillMoveMap(this.data),"MOVEPATH_SELECTION"):(this.data.setTarget(t,n),"ACTION_MENU")},cancel:function(){return"IDLE_R"}},controller.stateMachine.structure.IDLE_R={onenter:function(e,t,n){return this.data.setSource(t,n),null===this.data.sourceUnit?this.BREAK_TRANSITION:(controller.getActionObject("ATUN").fillAttackableTiles(this.data),void 0)},cancel:function(){return"IDLE"}},controller.stateMachine.structure.MOVEPATH_SELECTION={onenter:function(){},action:function(e,t,n){if(0>this.data.getSelectionValueAt(t,n))return CLIENT_DEBUG&&util.log("break event because selection is not in the map"),this.BREAK_TRANSITION;var o=this.data.targetX,r=this.data.targetY,i=model.distance(o,r,t,n);if(this.data.setTarget(t,n),0===i)return"ACTION_MENU";if(1===i){var a=model.moveCodeFromAtoB(o,r,t,n);return model.addCodeToPath(this.data,t,n,a),this.BREAK_TRANSITION
}return model.setPathByRecalculation(this.data,t,n),this.BREAK_TRANSITION},cancel:function(){return this.data.setTarget(-1,-1),this.lastState}},controller.stateMachine.structure.MULTISTEP_IDLE={nextStep:function(){this.data.action;var e=this.data.actionObject;return this.data.cleanMenu(),this.data.cleanMovepath(),e.prepareMenu(this.data),this.data.addEntry("done"),this.data.inMultiStep=!0,this.data.menuSize>1?"ACTION_SUBMENU":"IDLE"}},controller.stateMachine.structure.NONE={start:function(){return"IDLE"}},controller.stateMachine.structure.ACTION_SELECT_TARGET_A={action:function(e,t,n){return 0>this.data.getSelectionValueAt(t,n)?(CLIENT_DEBUG&&util.log("break event because selection is not in the map"),this.BREAK_TRANSITION):(this.data.setSelectionTarget(t,n),"FLUSH_ACTION")},cancel:function(){return this.lastState}},controller.stateMachine.structure.ACTION_SELECT_TARGET_B=controller.stateMachine.structure.ACTION_SELECT_TARGET_A,controller.stateMachine.structure.ACTION_SELECT_TILE={action:function(e,t,n){return this.data.actionObject.isTargetValid(this.data,t,n)?(this.data.setSelectionTarget(t,n),"FLUSH_ACTION"):this.BREAK_TRANSITION},cancel:function(){return this.data.setSelectionTarget(-1,-1),this.lastState}},controller.engineAction({name:"addVision",key:"AVIS",action:function(e,t,n){if(model.rules.fogEnabled!==!1){var o,r,i=t-n,a=t+n;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(o=e-n+l,r=e+n-l,0>o&&(o=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=o;o++)model.fogData[o][i]++}}}}),controller.userAction({name:"attackUnit",key:"ATUN",unitAction:!0,hasSubMenu:!0,MOVABLE_CODE:1,MOVABLE_ATTACKABLE_CODE:2,ATTACKABLE_CODE:3,fillAttackableTiles:function(e){e.sourceX,e.sourceY;var t=e.sourceUnit;model.fillMoveMap(e);var n=e.selectionData,o=n.length;e.selectionCX,e.selectionCY;for(var r=0;o>r;r++)for(var i=0;o>i;i++)n[r][i]>=0&&(n[r][i]=this.MOVABLE_CODE);for(var r=0;o>r;r++)for(var i=0;o>i;i++)(n[r][i]===this.MOVABLE_CODE||n[r][i]===this.MOVABLE_ATTACKABLE_CODE)&&(this.markTargets(e,t,r,i,model.PRIMARY_WEAPON_TAG),this.markTargets(e,t,r,i,model.SECONDARY_WEAPON_TAG),n[r][i]===this.ATTACKABLE_CODE)},counterWeapon:function(e,t,n,o,r){var i=Math.abs(e-n)+Math.abs(t-o);if(i>1)return null;var a=model.unitPosMap[e][t],l=model.sheets.unitSheets[a.type],s=l[model.PRIMARY_WEAPON_TAG],u=l[model.SECONDARY_WEAPON_TAG];if(void 0!==s&&(s=model.sheets.weaponSheets[s],0===s.useAmmo||a.ammo>0)){var d=s.minRange,c=s.maxRange,m=model.getBaseDamage(s,r.type);if(1===d&&1===c&&1===i&&m>0)return s}if(void 0!==u&&(u=model.sheets.weaponSheets[u],0===u.useAmmo||a.ammo>0)){var d=u.minRange,c=u.maxRange,m=model.getBaseDamage(s,r.type);if(1===d&&1===c&&1===i&&m>0)return u}return null},markTargets:function(e,t,n,o,r){2===arguments.length&&(n=t.x,o=t.y),t.owner,model.players[t.owner].team;var i=model.sheets.unitSheets[t.type],a=model.sheets.weaponSheets[r===model.PRIMARY_WEAPON_TAG?i[model.PRIMARY_WEAPON_TAG]:i[model.SECONDARY_WEAPON_TAG]];if(void 0!==a){var l,s,u=a.minRange,d=a.maxRange,c=o-d,m=o+d;for(0>c&&(c=0),m>=model.mapHeight&&(m=model.mapHeight-1);m>=c;c++){var p=Math.abs(c-o);for(l=n-d+p,s=n+d-p,0>l&&(l=0),s>=model.mapWidth&&(s=model.mapWidth-1);s>=l;l++)if(model.distance(n,o,l,c)>=u){var h=e.getSelectionValueAt(l,c),_=this.ATTACKABLE_CODE;h===this.MOVABLE_CODE&&(_=this.MOVABLE_ATTACKABLE_CODE),e.setSelectionValueAt(l,c,_)}}}},hasTargets:function(e,t,n,o,r){2===arguments.length&&(n=e.x,o=e.y);var i=e.owner,a=model.players[e.owner].team,l=model.sheets.unitSheets[e.type],s=model.sheets.weaponSheets[t===model.PRIMARY_WEAPON_TAG?l[model.PRIMARY_WEAPON_TAG]:l[model.SECONDARY_WEAPON_TAG]];if(void 0===s)return!1;if(1===s.usesAmmo&&0===e.ammo)return!1;if(r&&"INDIRECT"===s.fireType)return!1;var u,d,c=s.minRange,m=s.maxRange,p=o-m,h=o+m;for(0>p&&(p=0),h>=model.mapHeight&&(h=model.mapHeight-1);h>=p;p++){var _=Math.abs(p-o);for(u=n-m+_,d=n+m-_,0>u&&(u=0),d>=model.mapWidth&&(d=model.mapWidth-1);d>=u;u++)if(model.distance(n,o,u,p)>=c){var f=model.unitPosMap[u][p];if(null!==f&&f.owner!==i&&model.players[f.owner].team!==a){if(0===model.fogData[u][p])continue;var E=model.getBaseDamage(s,f.type);if(E>0)return!0}}}},prepareMenu:function(e){var t=e.sourceUnit,n=e.targetX,o=e.targetY;this.hasTargets(t,model.PRIMARY_WEAPON_TAG,n,o,!0)&&e.addEntry("mainWeapon"),this.hasTargets(t,model.SECONDARY_WEAPON_TAG,n,o,!0)&&e.addEntry("subWeapon")},targetSelectionType:"B",prepareTargets:function(e){var t,n,o=e.sourceUnit,r=e.subAction,i=e.targetX,a=e.targetY,l="mainWeapon"===r?model.primaryWeaponOfUnit(o):model.secondaryWeaponOfUnit(o),s=o.owner,u=model.players[o.owner].team,d=l.minRange,c=l.maxRange,m=a-c,p=a+c;for(0>m&&(m=0),p>=model.mapHeight&&(p=model.mapHeight-1);p>=m;m++){var h=Math.abs(m-a);for(t=i-c+h,n=i+c-h,0>t&&(t=0),n>=model.mapWidth&&(n=model.mapWidth-1);n>=t;t++)if(model.distance(i,a,t,m)>=d){var _=model.unitPosMap[t][m];if(null!==_&&_.owner!==s&&model.players[_.owner].team!==u){if(0===model.fogData[t][m])continue;var f=model.getBaseDamage(l,_.type);f>0&&(DEBUG&&util.logInfo("found target at (",t,",",m,")"),e.setSelectionValueAt(t,m,1))}}}},condition:function(e){var t=model.rules.daysOfPeace;if(t>model.day-1)return!1;if(e.targetUnitId!==CWT_INACTIVE_ID&&e.targetUnitId!==e.sourceUnitId)return!1;var n=e.sourceUnit,o=!1;e.movePath.length>0&&(o=!0);var r=e.targetX,i=e.targetY;return null!==model.primaryWeaponOfUnit(n)&&this.hasTargets(n,model.PRIMARY_WEAPON_TAG,r,i,o)||null!==model.secondaryWeaponOfUnit(n)&&this.hasTargets(n,model.SECONDARY_WEAPON_TAG,r,i,o)?!0:!1},getEndDamage:function(e,t,n){var o,r=model.getBaseDamage(t,n.type),i=model.unitHpPt(e),a=100,l=parseInt(10*Math.random(),10),s=100;o=null!==model.propertyPosMap[n.x][n.y]?model.propertyPosMap[n.x][n.y].type:model.map[n.x][n.y];var u=model.sheets.tileSheets[o].defense,d=model.unitHpPt(n),c=(r*a/100+l)*(i/10)*((200-(s+u*d))/100);return c=parseInt(c,10),DEBUG&&util.log("attacker: ",model.extractUnitId(e),"[",r,"*",a,"/100+",l,"]*(",i,"/10)*[(200-(",s,"+",u,"*",d,"))/100]","=",c),c},createDataSet:function(e){var t=e.subAction===model.PRIMARY_WEAPON_TAG?model.primaryWeaponOfUnit(e.sourceUnit):model.secondaryWeaponOfUnit(e.sourceUnit),n=this.getEndDamage(e.sourceUnit,t,e.selectionUnit),o=0,r=this.counterWeapon(e.selectionX,e.selectionY,e.targetX,e.targetY,e.sourceUnit);return null!==r&&(o=this.getEndDamage(e.selectionUnit,r,e.sourceUnit)),[e.sourceUnitId,n,0!==t.usesAmmo,e.selectionUnitId,o,null!==r&&0!==r.usesAmmo]},action:function(e,t,n,o,r,i){controller.actions.damageUnit(o,t),controller.actions.wait(e),n&&model.units[e].ammo--;var a=model.sheets.unitSheets[model.units[o].type];controller.actions.givePower(model.units[e].owner,.5*parseInt(t/10,10)*a.cost),model.units[o].hp>0&&(controller.actions.damageUnit(e,r),i&&model.units[o].ammo--,model.sheets.unitSheets[model.units[e].type],controller.actions.givePower(model.units[o].owner,parseInt(t/10,10)*a.cost))}}),controller.userAction({name:"buildUnit",key:"BDUN",propertyAction:!0,hasSubMenu:!0,canPropTypeBuildUnitType:function(e,t){var n=model.sheets.tileSheets[e],o=n.builds;if(void 0===o)return!1;if(-1!==model.rules.blockedUnits.indexOf(t))return!1;if(-1!==o.indexOf("*"))return!0;if(-1!==o.indexOf(t))return!0;var r=model.sheets.unitSheets[t],i=r.moveType;return-1!==o.indexOf(i)?!0:!1},getBuildList:function(e){var t=[],n=model.getListOfUnitTypes(),o=model.properties[e];model.sheets.tileSheets[o.type];for(var r=model.players[model.turnOwner].gold,i=0,a=n.length;a>i;i++)this.canPropTypeBuildUnitType(o.type,n[i])&&r>=model.sheets.unitSheets[n[i]].cost&&t.push(n[i]);return t},condition:function(e){var t=e.sourceProperty;return model.countUnits(model.turnOwner)>=model.rules.unitLimit?!1:model.hasFreeUnitSlots(model.turnOwner)&&this.getBuildList(model.extractPropertyId(t)).length>0},prepareMenu:function(e){var t=e.sourceProperty;DEBUG&&null===t&&util.raiseError();for(var n=this.getBuildList(e.sourcePropertyId),o=0,r=n.length;r>o;o++)e.addEntry(n[o])},createDataSet:function(e){return[e.sourceX,e.sourceY,e.subAction]},action:function(e,t,n){controller.actions.createUnit(e,t,model.turnOwner,n);var o=model.extractUnitId(model.unitPosMap[e][t]),r=model.players[model.turnOwner];r.gold-=model.sheets.unitSheets[n].cost,controller.actions.wait(o)}}),controller.engineAction({name:"calculateFog",key:"CCFO",action:function(e,t){var n,o,r=model.mapWidth,i=model.mapHeight,a=model.players[e].team,l=model.rules.fogEnabled;void 0===t&&(t=model.weather.ID);var s=model.sheets.weatherSheets[t].visionChange;for(void 0===s&&(s=0),n=0;r>n;n++)for(o=0;i>o;o++)model.fogData[n][o]=l?0:1;if(l)for(n=0;r>n;n++)for(o=0;i>o;o++){var u=model.unitPosMap[n][o];if(null!==u){var d=u.owner;if(e===d||model.players[d].team===a){var c=model.sheets.unitSheets[u.type].vision+s;0>c&&(c=0),controller.actions.addVision(n,o,c)}}var m=model.propertyPosMap[n][o];if(null!==m){var d=m.owner;if(e===d||model.players[d].team===a){var c=model.sheets.tileSheets[m.type].vision+s;0>c&&(c=0),controller.actions.addVision(n,o,c)}}}}}),controller.userAction({name:"captureProperty",key:"CTPR",unitAction:!0,condition:function(e){return null!==e.targetProperty&&model.turnOwner!==e.targetProperty.owner&&(null===e.targetUnit||e.targetUnit===e.sourceUnit)&&model.sheets.tileSheets[e.targetProperty.type].capturePoints>0&&model.sheets.unitSheets[e.sourceUnit.type].captures>0},createDataSet:function(e){var t=parseInt(e.sourceUnit.hp/10,10)+1;return[e.sourceUnitId,e.targetPropertyId,e.targetX,e.targetY,t]},action:function(e,t,n,o,r){var i=model.units[e],a=model.properties[t];if(model.sheets.unitSheets[i.type],i.ST_CAPTURES=!0,a.capturePoints-=r,0>=a.capturePoints){var l=n,s=o;if(DEBUG&&util.logInfo("property at (",l,",",s,") captured"),controller.actions.addVision(l,s,model.sheets.tileSheets[a.type].vision),"HQTR"===a.type){for(var u=a.owner,d=model.players[u],c=u*CWT_MAX_UNITS_PER_PLAYER,m=c+CWT_MAX_UNITS_PER_PLAYER;m>c;c++)model.units[c].owner!==CWT_INACTIVE_ID&&controller.pushAction(c,"DEUN");for(var c=0,m=model.properties.length;m>c;c++)model.properties[c].owner===u&&(model.properties[c].owner=-1);d.team=-1,a.type="CITY";for(var p=-1,c=0,m=model.players.length;m>c;c++){var h=model.players[c];if(-1!==h.team)if(-1===p)p=h.team;else if(p!==h.team){p=-1;break}}-1!==p&&controller.pushAction("EDGM")}a.capturePoints=20,a.owner=i.owner;var _=model.rules.captureWinLimit;0!==_&&model.countProperties()>=_&&controller.pushAction("EDGM")}controller.actions.wait(e)}}),controller.engineAction({name:"changeWeather",key:"CWTH",action:function(e,t){DEBUG&&util.log("changing weather to",e,"for",t,"days"),model.weatherDays=t,model.weather=model.sheets.weatherSheets[e]}}),controller.engineAction({name:"createUnit",key:"CRUN",action:function(e,t,n,o){for(var r=n*CWT_MAX_UNITS_PER_PLAYER,i=r,a=r+CWT_MAX_UNITS_PER_PLAYER;a>i;i++)if(model.units[i].owner===CWT_INACTIVE_ID){var l=model.sheets.unitSheets[o],s=model.units[i];return s.owner=n,s.hp=99,s.type=o,s.ammo=l.maxAmmo,s.fuel=l.maxFuel,s.loadedIn=-1,s.x=e,s.y=t,model.unitPosMap[e][t]=s,n===model.turnOwner&&controller.pushAction(s.x,s.y,model.sheets.unitSheets[s.type].vision,"AVIS"),DEBUG&&util.log("build unit for player",n,"in slot",i),void 0}DEBUG&&util.raiseError("cannot build unit for player",n,"no slots free")}}),controller.engineAction({name:"damageUnit",key:"DMUN",action:function(e,t){var n=model.units[e];n.hp-=t,0>=n.hp&&controller.pushAction(e,"DEUN")}}),controller.engineAction({name:"destroyUnit",key:"DEUN",action:function(e){var t=model.units[e];t.owner===model.turnOwner&&controller.pushAction(t.x,t.y,model.sheets.unitSheets[t.type].vision,"RVIS");var n=t.owner;t.owner=CWT_INACTIVE_ID,-1!==t.x&&(model.unitPosMap[t.x][t.y]=null),model.rules.noUnitsLeftLoose&&0===model.countUnits(n)&&controller.pushAction("EDGM")}}),controller.engineAction({name:"endGame",key:"EDGM",action:function(){DEBUG&&util.log("the game ends because no opposite players exists")}}),controller.userAction({name:"giveMoneyToPlayer",key:"GMTP",hasSubMenu:!0,condition:function(e){if(500>model.players[model.turnOwner].gold)return!1;var t=e.targetProperty;return null===t?!1:t.owner===model.turnOwner?!1:!0},prepareMenu:function(e){var t=model.players[model.turnOwner].gold;t>=500&&e.addEntry(500),t>=1e3&&e.addEntry(1e3),t>=2500&&e.addEntry(2500),t>=5e3&&e.addEntry(5e3),t>=1e4&&e.addEntry(1e4),t>=25e3&&e.addEntry(25e3),t>=5e4&&e.addEntry(5e4)},createDataSet:function(e){var t=e.targetUnit;return null===t&&(t=e.targetProperty),[t.owner,e.subAction]},action:function(e,t){var n=model.players[model.turnOwner],o=model.players[e];t>n.gold&&(t=n.gold),n.gold-=t,o.gold+=t}}),controller.engineAction({name:"givePower",key:"GIPO",action:function(e,t){model.players[e].power+=t}}),controller.userAction({name:"givePropertyToPlayer",key:"GPTP",propertyAction:!0,hasSubMenu:!0,condition:function(e){var t=e.sourceProperty;return null===t?!1:"HQTR"===t.type?!1:!0},prepareMenu:function(e){for(var t=0,n=CWT_MAX_PLAYER;n>t;t++)t!==model.turnOwner&&model.players[t].team!==CWT_INACTIVE_ID&&e.addEntry(t)},createDataSet:function(e){return[e.sourcePropertyId,e.subAction]},action:function(e,t){var n=model.properties[e];n.owner=t;var o,r,i=model.mapWidth,a=model.mapHeight;for(o=0;i>o;o++)for(r=0;a>r;r++)if(model.propertyPosMap[o][r]===n)return controller.pushAction(o,r,model.sheets.tileSheets[n.type].vision,"RVIS"),void 0}}),controller.userAction({name:"giveUnitToPlayer",key:"GUTP",unitAction:!0,hasSubMenu:!0,condition:function(e){var t=e.sourceUnit;if(null===t)return!1;if(null!==e.targetUnit)return!1;if(model.hasLoadedIds(e.sourceUnitId))return!1;var n=e.targetUnit;return n!==t},prepareMenu:function(e){for(var t=0,n=CWT_MAX_PLAYER;n>t;t++)t!==model.turnOwner&&model.players[t].team!==CWT_INACTIVE_ID&&e.addEntry(t)},createDataSet:function(e){return[e.sourceUnitId,e.subAction]},action:function(e,t){var n=model.units[e],o=n.x,r=n.y,i=n.owner;n.owner=CWT_INACTIVE_ID,model.players[t].team!==model.players[i].team&&controller.pushAction(n.x,n.y,model.sheets.unitSheets[n.type].vision,"RVIS"),model.unitPosMap[n.x][n.y]=null,controller.actions.createUnit(n.x,n.y,t,n.type);var a=model.unitPosMap[n.x][n.y];a.hp=n.hp,a.ammo=n.ammo,a.fuel=n.fuel,a.exp=n.exp,a.type=n.type,a.x=o,a.y=r,a.loadedIn=n.loadedIn}}),controller.engineAction({name:"healUnit",key:"HEUN",action:function(e,t){var n=model.units[e];n.hp+=t,n.hp>99&&(n.hp=99);var o=-1;90>=n.hp&&(o=parseInt(n.hp/10,10)+1),n.ST_HP_NUM=o}}),controller.userAction({name:"hideUnit",key:"HIUN",unitAction:!0,condition:function(e){if(null!==e.targetUnit)return!1;var t=e.sourceUnit;if(null===t)return!1;if(t.hidden)return!1;var n=model.sheets.unitSheets[t.type];return n.canHide},createDataSet:function(e){return[e.sourceUnitId]},action:function(e){model.units[e].hidden=!0}}),controller.engineAction({name:"invokeMultiStepAction",key:"IVMS",action:function(){controller.stateMachine.event("nextStep")}}),controller.userAction({name:"join",key:"JNUN",unitAction:!0,condition:function(e){var t=e.sourceUnit,n=e.targetUnit;return null===t||null===n||n.owner!==model.turnOwner||n===t?!1:model.hasLoadedIds(e.sourceUnitId)||model.hasLoadedIds(e.targetUnitId)?!1:t.type===n.type&&89>n.hp},createDataSet:function(e){return[e.sourceUnitId,e.targetUnitId]},action:function(e,t){var n=model.units[e],o=model.units[t],r=model.sheets.unitSheets[o.type],i=model.unitHpPt(n);model.unitHpPt(n),controller.actions.healUnit(t,model.ptToHp(i)),o.ammo+=n.ammo,o.ammo>r.maxAmmo&&(o.ammo=r.maxAmmo),o.fuel+=n.fuel,o.fuel>r.maxFuel&&(o.fuel=r.maxFuel),controller.actions.destroyUnit(e),controller.actions.wait(t)}}),controller.engineAction({name:"loadGame",key:"LDGM",action:function(e){DEBUG&&util.log("start loading game instance");var t=controller.getActiveSerializationHandler(e.format);t.load(e),model.setRulesByOption({}),controller.actions.changeWeather("SUN",4+parseInt(6*Math.random(),10)),controller.actions.calculateFog(model.turnOwner),DEBUG&&util.log("game instance successfully loaded")}}),controller.engineAction({name:"loadMod",key:"LDMD",action:function(){for(var e=0,t=CWT_MOD_DEFAULT.movetypes.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.movetypes[e],model.sheets.MOVE_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.tiles.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.tiles[e],model.sheets.TILE_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.units.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.units[e],model.sheets.UNIT_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.weapons.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.weapons[e],model.sheets.WEAPON_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.weathers.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.weathers[e],model.sheets.WEATHER_TYPE_SHEET);for(var n=Object.keys(CWT_MOD_DEFAULT.locale),e=0,t=n.length;t>e;e++)util.i18n_appendToLanguage(n[e],CWT_MOD_DEFAULT.locale[n[e]]);model.parseSheet(CWT_MOD_DEFAULT.rules,model.sheets.RULESET)}}),controller.userAction({name:"loadUnit",key:"LODU",unitAction:!0,condition:function(e){var t=e.sourceUnitId,n=e.targetUnitId;return-1===n||e.targetUnit.owner!==model.turnOwner?!1:model.isTransport(n)&&model.canLoad(t,n)},createDataSet:function(e){return[e.sourceUnitId,e.targetUnitId]},action:function(e,t){model.loadUnitInto(e,t)}}),controller.engineAction({name:"makeActable",key:"MKAC",action:function(e){var e="number"==typeof e?e:model.extractUnitId(e),t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)&&util.raiseError("unit owner is not the active player"),model.leftActors[e-t]=!0,DEBUG&&util.log("unit",e,"going into wait status")}}),controller.engineAction({name:"moveUnit",key:"MOVE",shared:!0,createDataSet:function(e){return[e.cloneMovepath(),e.sourceUnitId,e.sourceX,e.sourceY]},action:function(e,t,n,o){for(var r=n,i=o,a=model.units[t],l=model.sheets.unitSheets[a.type],s=model.sheets.movetypeSheets[l.moveType],u=(e.length-1,0),d=0,c=e.length;c>d;d++){switch(e[d]){case model.MOVE_CODE_UP:0===i&&util.logError("cannot do move command UP because","current position is at the border"),i--;break;case model.MOVE_CODE_RIGHT:r===model.mapWidth-1&&util.logError("cannot do move command RIGHT because","current position is at the border"),r++;break;case model.MOVE_CODE_DOWN:i===model.mapHeight-1&&util.logError("cannot do move command DOWN because","current position is at the border"),i++;break;case model.MOVE_CODE_LEFT:0===r&&util.logError("cannot do move command LEFT because","current position is at the border"),r--;break;default:util.logError("unknown command ",e[d])}u+=model.moveCosts(s,model.map[r][i],model.weather.ID)}a.fuel-=u,-1!==a.x&&-1!==a.y&&(model.unitPosMap[a.x][a.y]=null,controller.pushAction(a.x,a.y,model.sheets.unitSheets[a.type].vision,"RVIS"),a.x=-1,a.y=-1),null===model.unitPosMap[r][i]&&(a.x=r,a.y=i,model.unitPosMap[r][i]=a,controller.pushAction(r,i,model.sheets.unitSheets[a.type].vision,"AVIS")),DEBUG&&util.log("moved unit",t,"from (",n,",",o,") to (",r,",",i,")")}}),controller.engineAction({name:"moveVision",key:"MVIS",action:function(e,t,n,o,r){controller.actions.removeVision(e,t,r),controller.actions.addVision(n,o,r)}}),controller.userAction({name:"nextTurn",key:"NXTR",condition:function(e){return null===e.sourceUnit?!0:e.sourceUnit.owner===model.turnOwner?!model.canAct(e.sourceUnitId):!0},createDataSet:function(){return[]},action:function(){var e,t=model.turnOwner,n=t;t++;for(var o=1;t!==n;){if(t===CWT_MAX_PLAYER){if(t=0,model.day++,model.weatherDays--,0>=model.weatherDays){var r,i=model.weather.ID;if("SUN"!==i)r=4+parseInt(6*Math.random(),10),e="SUN";else{r=1;var a=Object.keys(model.sheets.weatherSheets),l=a.indexOf(i);-1===l&&util.raiseError(),a.splice(l,1);var s=parseInt(Math.random()*a.length,10);e=a[s]}controller.pushSharedAction(e,r,"CWTH")}var u=model.rules.dayLimit;0!==u&&model.day===u&&controller.pushSharedAction("EDGM")}if(model.players[t].team!==CWT_INACTIVE_ID)break;t++,o++}t===n&&util.raiseError(),model.turnOwner=t;var d=model.players[t];model.rules.cityRepair;for(var c=model.rules.funds,m=model.rules.autoSupplyAtTurnStart,p=model.rules.resupplyUnitOnAlliedProperties,h=model.rules.healUnitsOnProperties,_=model.rules.healUnitsOnAlliedProperties,f=t*CWT_MAX_UNITS_PER_PLAYER,E=f,T=E+CWT_MAX_UNITS_PER_PLAYER;T>E;E++){var g=model.units[E];if(model.leftActors[E-f]=null!==g,null!==g&&-1!==g.x&&g.owner!==CWT_INACTIVE_ID){m&&model.sheets.unitSheets[g.type].hasOwnProperty("supply")&&controller.pushAction(E,g.x,g.y,"TSSP");var A=model.propertyPosMap[g.x][g.y];if(null!==A&&A.owner!==CWT_INACTIVE_ID){var y=model.players[A.owner].team===d.team;(A.owner===t||p&&y)&&controller.pushAction(E,"RFRS"),h&&99>g.hp&&(A.owner===t||_&&y)&&controller.pushAction(E,20,"HEUN")}}}for(var E=0,T=CWT_MAX_PROPERTIES;T>E;E++)"SILO_EMPTY"===model.properties[E].type&&controller.actions.siloRegeneration(E,o),model.properties[E].owner===t&&(d.gold+=c);controller.actions.calculateFog(t,e),controller.resetTurnTimer()}}),controller.engineAction({name:"refillRessources",key:"RFRS",action:function(e){var t=model.units[e],n=model.sheets.unitSheets[t.type];t.ammo=n.maxAmmo,t.fuel=n.maxFuel}}),controller.engineAction({name:"removeVision",key:"RVIS",action:function(e,t,n){if(model.rules.fogEnabled!==!1){var o,r,i=t-n,a=t+n;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(o=e-n+l,r=e+n-l,0>o&&(o=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=o;o++)model.fogData[o][i]--}}}}),controller.engineAction({name:"saveGame",key:"SAGA",action:function(){DEBUG&&util.log("start saving game instance");var e=controller.getActiveSerializationHandler(),t=e.save();t=JSON.stringify(t,null,"	"),DEBUG&&util.log("game instance successfully saved")}}),controller.userAction({name:"silofire",key:"SLFR",unitAction:!0,_doDamage:function(e,t){if(model.isValidPosition(e,t)){var n=model.unitPosMap[e][t];null!==n&&(n.hp-=20,9>n.hp&&(n.hp=9))}},isTargetValid:function(e,t,n){return model.isValidPosition(t,n)},condition:function(e){var t=e.sourceUnit,n=e.targetProperty;return null===n||n.owner!==model.turnOwner?!1:null!==e.targetUnit?!1:"INFT"!==t.type&&"MECH"!==t.type?!1:"SILO"===n.type},createDataSet:function(e){return[e.sourceUnitId,e.targetX,e.targetY,e.targetPropertyId,e.selectionX,e.selectionY]},action:function(e,t,n,o,r,i){var a=this._doDamage,l=r,s=i;a(l,s-2),a(l-1,s-1),a(l,s-1),a(l+1,s-1),a(l-2,s),a(l-1,s),a(l,s),a(l+1,s),a(l+2,s),a(l-1,s+1),a(l,s+1),a(l+1,s+1),a(l,s+2);var u=t,d=n;model.propertyPosMap[u][d].type="SILO_EMPTY",controller.actions.wait(e)}}),controller.engineAction({name:"siloRegeneration",key:"SIRE",action:function(e,t){var n=model.rules.siloRegeneration;-1!==n&&(model.regeneratingSilos.hasOwnProperty(e)?model.regeneratingSilos[e]+=t:model.regeneratingSilos[e]=t,model.regeneratingSilos[e]>=n&&(delete model.regeneratingSilos[e],model.properties[e].type="SILO"))}}),controller.engineAction({name:"startGame",key:"STGM",action:function(){}}),controller.userAction({name:"supply",key:"SPPL",unitAction:!0,_resupplyUnitAt:function(e,t){controller.pushAction(model.extractUnitId(model.unitPosMap[e][t]),"RFRS")},condition:function(e){var t=e.sourceUnit,n=model.sheets.unitSheets[t.type];if(void 0===n.supply)return!1;var o=t.owner,r=e.targetX,i=e.targetY,a=model.thereIsAnOwnUnitAt;return a(r-1,i,o)||a(r+1,i,o)||a(r,i-1,o)||a(r,i+1,o)},createDataSet:function(e){return[e.sourceUnitId,e.targetX,e.targetY]},action:function(e,t,n){var o=model.units[e],r=o.owner,i=model.thereIsAnOwnUnitAt,a=this._resupplyUnitAt;i(t-1,n,r)&&a(t-1,n),i(t+1,n,r)&&a(t+1,n),i(t,n-1,r)&&a(t,n-1),i(t,n+1,r)&&a(t,n+1),controller.actions.wait(e)}}),controller.engineAction({name:"trapWait",key:"TRWT",createDataSet:function(e){return[e.selectionUnitId]},action:function(e){controller.actions.wait(e)}}),controller.engineAction({name:"supplyTurnStart",key:"TSSP",action:function(e,t,n){controller.actions.supply(e,t,n),controller.actions.makeActable(e)}}),controller.userAction({name:"unhideUnit",key:"UHUN",unitAction:!0,condition:function(e){if(null!==e.targetUnit)return!1;var t=e.sourceUnit;return null===t?!1:t.hidden},createDataSet:function(e){return[e.sourceUnitId]},action:function(e){model.units[e].hidden=!1}}),controller.userAction({name:"unloadUnit",key:"UNUN",unitAction:!0,multiStepAction:!0,condition:function(e){if(e.sourceUnit,null!==e.targetUnit)return!1;var t=e.sourceUnitId;return model.isTransport(t)&&model.hasLoadedIds(t)},prepareMenu:function(e){for(var t=e.sourceUnitId,n=model.getLoadedIds(t),o=0,r=n.length;r>o;o++)e.addEntry(n[o])},targetSelectionType:"B",prepareTargets:function(e){var t=e.subAction,n=e.targetX,o=e.targetY,r=model.units[t],i=model.sheets.unitSheets[r.type],a=model.sheets.movetypeSheets[i.moveType],l=model.weather.ID;n>0&&null===model.unitPosMap[n-1][o]&&-1!==model.moveCosts(a,model.map[n-1][o],l)&&e.setSelectionValueAt(n-1,o,1),o>0&&null===model.unitPosMap[n][o-1]&&-1!==model.moveCosts(a,model.map[n][o-1],l)&&e.setSelectionValueAt(n,o-1,1),model.mapHeight-1>o&&null===model.unitPosMap[n][o+1]&&-1!==model.moveCosts(a,model.map[n][o+1],l)&&e.setSelectionValueAt(n,o+1,1),model.mapWidth-1>n&&null===model.unitPosMap[n+1][o]&&-1!==model.moveCosts(a,model.map[n+1][o],l)&&e.setSelectionValueAt(n+1,o,1)},createDataSet:function(e){return[e.sourceUnitId,e.targetX,e.targetY,e.subAction,e.selectionX,e.selectionY]},action:function(e,t,n,o,r,i){controller.actions.wait(e),model.unloadUnitFrom(o,e);var a;t>r?a=model.MOVE_CODE_LEFT:r>t?a=model.MOVE_CODE_RIGHT:n>i?a=model.MOVE_CODE_UP:i>n&&(a=model.MOVE_CODE_DOWN),controller.pushAction([a],o,t,n,"MOVE"),controller.pushAction(o,"WTUN")}}),controller.userAction({name:"wait",key:"WTUN",unitAction:!0,condition:function(e){return null===e.targetUnit||e.targetUnit===e.sourceUnit},createDataSet:function(e){return[e.sourceUnitId]},action:function(e){var e="number"==typeof e?e:model.extractUnitId(e),t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)&&util.raiseError("unit owner is not the active player"),model.leftActors[e-t]=!1,DEBUG&&util.log("unit",e,"going into wait status")}});