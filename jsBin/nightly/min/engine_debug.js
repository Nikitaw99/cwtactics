const DEBUG=!0,CWT_INACTIVE_ID=-1,CWT_VERSION="M 2.6";var model={},controller={},view={},util={};util.fill=function(e,t){var o="function"==typeof t;if(e.__matrixArray__===!0)for(var r=0,n=e.length;n>r;r++)for(var i=0,l=e.length;l>i;i++)e[r][i]=o?t(r,i):t;else for(var r=0,n=e.length;n>r;r++)e[r]=o?t(r):t},util.list=function(e,t){void 0===t&&(t=null);for(var o="function"==typeof t,r=[],n=0;e>n;n++)r[n]=o?t(n):t;return r},util.matrix=function(e,t,o){void 0===o&&(o=null);for(var r="function"==typeof o,n=[],i=0;e>i;i++){n[i]=[];for(var l=0;t>l;l++)n[i][l]=r?o(i,l):o}return n.__matrixArray__=!0,n},util.illegalUnitIdError=function(){throw Error("illegal unit id")},util.illegalPropertyIdError=function(){throw Error("illegal unit id")},util.illegalArgumentError=function(){throw Error("illegal argument")},util.typeError=function(){throw Error("type error")},util.unexpectedSituationError=function(){throw Error("unexpected error")},util.illegalPositionError=function(){throw Error("illegal map position")},util.nullPointerError=function(){throw Error("null pointer")},util.isDefined=function(e){return void 0!==e&&null!==e},util.isFn=function(e){return"function"==typeof e},util.isNumber=function(e){return"number"==typeof e},util.isString=function(e){return"string"==typeof e},util.isBool=function(e){return"boolean"==typeof e},util.StringIdMapper=function(){this.map={},this._len=0},util.StringIdMapper.prototype.getIdFromKey=function(e){return this.map[e]},util.StringIdMapper.prototype.getKeyFromId=function(e){for(var t=this.map,o=Object.keys(t),r=0,n=o.length;n>r;r++)if(t[o[r]]===e)return o[r];return null},util.StringIdMapper.prototype.registerKey=function(e){if(this.map.hasOwnProperty(e))throw Error();this.map[e]=this._len,this._len++},util.i18n_data={en:{}},util.i18n_lang=util.i18n_data.en,util.i18n_localized=function(e){var t=this.i18n_lang[e];return void 0===t?e:t},util.i18n_setLanguage=function(e){if(!util.i18n_data.hasOwnProperty(e))throw Error("unknown language");util.i18n_lang=util.i18n_data[e]},util.i18n_appendToLanguage=function(e,t){util.i18n_data.hasOwnProperty(e)||(util.i18n_data[e]={});for(var o=util.i18n_data[e],r=Object.keys(t),n=0,i=r.length;i>n;n++)o[r[n]]=t[r[n]]},util.LOG_INFO=0,util.LOG_WARN=1,util.LOG_ERROR=2,util.logWriter=function(e,t){switch(e){case util.LOG_ERROR:console.error(t);break;case util.LOG_INFO:console.log(t);break;case util.LOG_WARN:console.warn(t);break;default:console.log(t)}},util.logInfo=function(e){arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),util.logWriter(util.LOG_INFO,e)},util.logWarn=function(e){arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),util.logWriter(util.LOG_WARN,e)},util.logError=function(e){arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),util.logWriter(util.LOG_ERROR,e)},util.createRingBuffer=function(e){var t={push:function(e){if(null!==this._data[this._wInd])throw Error("message buffer is full");this._data[this._wInd]=e,this._wInd++,this._wInd===this._size&&(this._wInd=0)},isEmpty:function(){return null===this._data[this._rInd]},pop:function(){if(null===this._data[this._rInd])throw Error("message buffer is empty");var e=this._data[this._rInd];return this._data[this._rInd]=null,this._rInd++,this._rInd===this._size&&(this._rInd=0),e},clear:function(){this._rInd=0,this._wInd=0;for(var t=0;e>t;t++)this._data[t]=null}};return t._rInd=0,t._wInd=0,t._data=util.list(e,null),t._size=e,t},util.createStateMachine=function(e,t){return{state:function(){return e},event:function(o){util.logInfo("got event",o);var r=t[e][o];void 0===r&&util.illegalArgumentError("event "+o+" not defined "),e="function"==typeof r?r.apply(controller.input,arguments):r,util.logInfo("enter new state",e),t.hasOwnProperty(e)||util.illegalArgumentError("state "+e+" is not defined"),r=t[e].onenter,void 0!==r&&r.apply(controller.input,arguments),r=t[e].actionState,void 0!==r&&controller.input.event("actionState")}}},util.FUNCTION_TRUE_RETURNER=function(){return!0},util.FUNCTION_FALSE_RETURNER=function(){return!1},util.objectToJSON=function(e){return JSON.stringify(e)},util.replaceFunction=function(e,t){for(var o=e.split("."),r=window,n=0,i=o.length;i-1>n;n++)if(r=r[o[n]],void 0===r)throw Error("illegal given namespace: does not exists");var l=o[o.length-1],a=r[l];if("function"!=typeof a)throw Error("target object needs to be a function");var u=t(a);if("function"!=typeof u)throw Error("replacer factory needs to return a function");r[l]=u},model.fogData=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,0),model.resetFogData=function(e){0===arguments.length&&(e=0);for(var t,o=0,r=model.mapWidth,n=model.mapHeight;r>o;o++)for(t=0;n>t;t++)model.fogData[o][t]=e},model.fogOn=!0,model.generateFogMap=function(e){if(model.fogOn===!1)return model.resetFogData(1),void 0;var t,o=model.setVisioner,r=0,n=model.mapWidth,i=model.mapHeight,l=model.players[e].team;for(model.resetFogData();n>r;r++)for(t=0;i>t;t++){var a=model.unitPosMap[r][t];if(null!==a){var u=a.owner;if(e===u||model.players[u].team===l){var s=model.sheets.unitSheets[a.type].vision;o(r,t,s)}}var c=model.propertyPosMap[r][t];if(null!==c){var u=c.owner;if(e===u||model.players[u].team===l){var s=model.sheets.tileSheets[c.type].vision;o(r,t,s)}}}},model.setVisioner=function(e,t,o){if(model.fogOn!==!1){var r,n,i=t-o,l=t+o;for(0>i&&(i=0),l>=model.mapHeight&&(l=model.mapHeight-1);l>=i;i++){var a=Math.abs(i-t);for(r=e-o+a,n=e+o-a,0>r&&(r=0),n>=model.mapWidth&&(n=model.mapWidth-1);n>=r;r++)model.fogData[r][i]++}}},model.removeVisioner=function(e,t,o){if(model.fogOn!==!1){var r,n,i=t-o,l=t+o;for(0>i&&(i=0),l>=model.mapHeight&&(l=model.mapHeight-1);l>=i;i++){var a=Math.abs(i-t);for(r=e-o+a,n=e+o-a,0>r&&(r=0),n>=model.mapWidth&&(n=model.mapWidth-1);n>=r;r++)model.fogData[r][i]--}}},model.rules={},model.setRulesByOption=function(e){for(var t=model.sheets.defaultRules,o=model.rules,r=Object.keys(t),n=0,i=r.length;i>n;n++){var l=r[n];o[l]=e.hasOwnProperty(l)?e[l]:t[l]}},model.map=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.mapHeight=-1,model.mapWidth=-1,model.distance=function(e,t,o,r){var n=Math.abs(e-o),i=Math.abs(t-r);return n+i},model.moveCodeFromAtoB=function(e,t,o,r){return 1!==model.distance(e,t,o,r)&&util.illegalArgumentError("both positions haven't a distance of 1"),e>o?model.MOVE_CODE_LEFT:o>e?model.MOVE_CODE_RIGHT:t>r?model.MOVE_CODE_UP:r>t?model.MOVE_CODE_DOWN:(util.unexpectedSituationError(),void 0)},model.isValidPosition=function(e,t){return e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t},model.thereIsAnOwnUnitAt=function(e,t,o){if(!model.isValidPosition(e,t))return!1;var r=model.unitPosMap[e][t];return null!==r&&o===r.owner},model.thereIsAnAlliedUnitAt=function(e,t,o){if(!model.isValidPosition(e,t))return!1;var r=model.unitPosMap[e][t];return null!==r&&o!==r.owner&&model.players[o].team===model.players[r.owner].team},model.thereIsAnEnemyUnitAt=function(e,t,o){if(!model.isValidPosition(e,t))return!1;var r=model.unitPosMap[e][t];return null!==r&&o!==r.owner&&model.players[o].team!==model.players[r.owner].team},model.MOVE_CODE_UP=0,model.MOVE_CODE_RIGHT=1,model.MOVE_CODE_DOWN=2,model.MOVE_CODE_LEFT=3,model.fillMoveMap=function(e,t){var o=t.getSourceUnit(),r=model.sheets.unitSheets[o.type],n=model.sheets.movetypeSheets[r.moveType],i=model.players[o.owner],l=r.moveRange,a=t.getSourceX(),u=t.getSourceY();l>o.fuel&&(l=o.fuel),e.cleanIt(CWT_INACTIVE_ID,a,u),e.setPositionValue(a,u,l);for(var s=[a,u,l],c=[-1,-1,-1,-1,-1,-1,-1,-1];;){for(var d=-1,m=-1,p=0,g=s.length;g>p;p+=3){var h=s[p+2];void 0!==h&&null!==h&&(-1===d||h>d)&&(d=h,m=p)}if(-1===m)break;var f=s[m],_=s[m+1],A=s[m+2];s[m]=null,s[m+1]=null,s[m+2]=null,f>0?(c[0]=f-1,c[1]=_):(c[0]=-1,c[1]=-1),model.mapWidth-1>f?(c[2]=f+1,c[3]=_):(c[2]=-1,c[3]=-1),_>0?(c[4]=f,c[5]=_-1):(c[4]=-1,c[5]=-1),model.mapHeight-1>_?(c[6]=f,c[7]=_+1):(c[6]=-1,c[7]=-1);for(var E=0;8>E;E+=2)if(-1!==c[E]){var T=c[E],I=c[E+1],S=model.moveCosts(n,model.map[T][I]);if(0!==S){var y=model.unitPosMap[T][I];if(null!==y&&model.fogData[T][I]>0&&model.players[y.owner].team!==i.team)continue;var v=A-S;if(v>=0&&v>e.getPositionValue(T,I)){e.setPositionValue(T,I,v);for(var p=0,g=s.length;g>=p;p+=3)if(null===s[p]||p===g){s[p]=T,s[p+1]=I,s[p+2]=v;break}}}}}for(var a=0,O=model.mapWidth;O>a;a++)for(var u=0,P=model.mapHeight;P>u;u++)if(-1!==e.getPositionValue(a,u)){var S=model.moveCosts(n,model.map[a][u]);e.setPositionValue(a,u,S)}},model.addCodeToPath=function(e,t,o,r,n){var i=t.getSourceUnit().fuel,l=0,a=t.getMovePath();a.push(n);var u=model.sheets.unitSheets[t.getSourceUnit().type].moveRange;u>i&&(u=i);for(var s=t.getSourceX(),c=t.getSourceY(),d=0,m=a.length;m>d;d++){switch(a[d]){case model.MOVE_CODE_UP:c--;break;case model.MOVE_CODE_DOWN:c++;break;case model.MOVE_CODE_LEFT:s--;break;case model.MOVE_CODE_RIGHT:s++;break;default:util.illegalArgumentError()}l+=e.getPositionValue(s,c)}l>u&&model.setPathByRecalculation(e,t,o,r)},model.setPathByRecalculation=function(e,t,o,r){var n=t.getSourceX(),i=t.getSourceY(),l=t.getMovePath();util.logInfo("searching path from","(",n,",",i,")","to","(",o,",",r,")");var a=new Graph(e.getDataMatrix()),u=n-e.getCenterX(),s=i-e.getCenterY(),c=a.nodes[u][s],d=o-e.getCenterX(),m=r-e.getCenterY(),p=a.nodes[d][m],g=astar.search(a.nodes,c,p);util.logInfo("calculated way is",g);for(var h,f=[],_=n,A=i,E=0,T=g.length;T>E;E++){h=g[E];var I;if(h.x>_&&(I=model.MOVE_CODE_RIGHT),_>h.x&&(I=model.MOVE_CODE_LEFT),h.y>A&&(I=model.MOVE_CODE_DOWN),A>h.y&&(I=model.MOVE_CODE_UP),void 0===I)throw Error();f.push(I),_=h.x,A=h.y}l.splice(0);for(var E=0,T=f.length;T>E;E++)l[E]=f[E]},model.players=util.list(CWT_MAX_PLAYER+1,function(e){var t=e===CWT_MAX_PLAYER;return{gold:0,team:t?9999:CWT_INACTIVE_ID,name:t?"NEUTRAL":null}}),model.isNeutralPlayer=function(e){return model.neutralPlayerId===e},model.neutralPlayerId=model.players.length-1,model.alliedPlayers=function(e,t){return model.players[e].team===model.players[t].team},model.enemyPlayers=function(e,t){return model.players[e].team!==model.players[t].team},model.properties=util.list(CWT_MAX_PROPERTIES+1,function(){return{capturePoints:20,owner:-1}}),model.propertyPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.tileIsProperty=function(e,t){var o=model.propertyPosMap[e][t];return void 0!==o},model.extractPropertyId=function(e){if(null===e)throw Error("property argument cannot be null");for(var t=model.properties,o=0,r=t.length;r>o;o++)if(t[o]===e)return o;throw Error("cannot find property",e)},model.countProperties=function(e){for(var t=0,o=model.properties,r=0,n=o.length;n>r;r++)o[r].owner===e&&t++;return t},model.RELATIONSHIP_SAME_OWNER=0,model.RELATIONSHIP_ALLIED=1,model.RELATIONSHIP_ENEMY=2,model.RELATIONSHIP_NONE=3,model.RELATIONSHIP_SAME_OBJECT=4,model.relationshipBetween=function(e,t){if(null===e||null===t)return model.RELATIONSHIP_NONE;if("number"!=typeof e&&"number"!=typeof t&&e===t)return model.RELATIONSHIP_SAME_OBJECT;if("number"!=typeof e&&(e=e.owner),"number"!=typeof t&&(t=t.owner),e===t)return model.RELATIONSHIP_SAME_OWNER;var o=model.players[e],r=model.players[t];return o===r?model.RELATIONSHIP_ALLIED:model.RELATIONSHIP_ENEMY},model.day=0,model.turnOwner=-1,model.leftActors=util.list(CWT_MAX_UNITS_PER_PLAYER,!1),model.canAct=function(e){var t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;if(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)return!1;var o=e-t;return model.leftActors[o]===!0},model.isTurnOwner=function(e){return model.turnOwner===e},model.markAsUnusable=function(e){var e="number"==typeof e?e:model.extractUnitId(e),t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)&&util.logError("unit owner is not the active player"),model.leftActors[e-t]=!1,util.logInfo("unit",e,"going into wait status")},model.sheets={},model.sheets._dbAmanda=amanda("json"),model.sheets.UNIT_TYPE_SHEET=0,model.sheets.TILE_TYPE_SHEET=1,model.sheets.WEAPON_TYPE_SHEET=2,model.sheets.WEATHER_TYPE_SHEET=3,model.sheets.MOVE_TYPE_SHEET=4,model.sheets.RULESET=5,model.PRIMARY_WEAPON_TAG="mainWeapon",model.SECONDARY_WEAPON_TAG="subWeapon",model.sheets.unitSheets={},model.sheets.tileSheets={},model.sheets.weaponSheets={},model.sheets.weatherSheets={},model.sheets.movetypeSheets={},model.sheets.defaultRules=null,model.sheets.typeSheetValidators={rulesValidator:{type:"object",properties:{funds:{type:"integer",minimum:0,maximum:99999},noUnitsLeftLoose:{type:"boolean"},captureWinLimit:{type:"integer",minimum:0,maximum:99999},turnTimeLimit:{type:"integer",minimum:0,maximum:36e5},dayLimit:{type:"integer",minimum:0,maximum:99999},unitLimit:{type:"integer",minimum:1,maximum:50},blockedUnits:{type:"array"}}},unitValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},cost:{type:"integer",minimum:0},fuelConsumption:{type:"integer",minimum:0},maxAmmo:{type:"integer",minimum:0,maximum:99},maxFuel:{type:"integer",minimum:0,maximum:99,required:!0},moveRange:{type:"integer",minimum:0,maximum:15,required:!0},moveType:{type:"string",required:!0},weight:{type:"integer",required:!0}}},tileValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},capturePoints:{type:"integer",minimum:1,maximum:99},defense:{type:"integer",minimum:0,maximum:5}}},weaponValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},noMoveAndFire:{type:"boolean"}}},weatherValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0}}},movetypeValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},costs:{type:"object",patternProperties:{"[.]*":{type:"integer",minimum:0}}}}}},model.sheets.toJSON=function(){return void 0},model.parseSheet=function(e,t){var o,r,n,i=e.ID,l=model.sheets.typeSheetValidators;switch(t){case model.sheets.UNIT_TYPE_SHEET:o=l.unitValidator,r=model.sheets.unitSheets,n=l.unitValidator.properties.ID.except;break;case model.sheets.TILE_TYPE_SHEET:o=l.tileValidator,r=model.sheets.tileSheets,n=l.tileValidator.properties.ID.except;break;case model.sheets.WEAPON_TYPE_SHEET:o=l.weaponValidator,r=model.sheets.weaponSheets,n=l.weaponValidator.properties.ID.except;break;case model.sheets.WEATHER_TYPE_SHEET:o=l.weatherValidator,r=model.sheets.weatherSheets,n=l.weatherValidator.properties.ID.except;break;case model.sheets.MOVE_TYPE_SHEET:o=l.movetypeValidator,r=model.sheets.movetypeSheets,n=l.movetypeValidator.properties.ID.except;break;case model.sheets.RULESET:o=l.rulesValidator;break;default:util.logError("unknow type",t)}t!==model.sheets.RULESET&&r.hasOwnProperty(i)&&util.logError(i,"is already registered"),model.sheets._dbAmanda.validate(e,o,function(e){e&&util.logError("failed to parse sheet due",e.getMessages())}),t===model.sheets.RULESET?model.sheets.defaultRules=e:(r[i]=e,n.push(i))},model.getListOfUnitTypes=function(){return Object.keys(model.sheets.unitSheets)},model.getListOfPropertyTypes=function(){for(var e=model.sheets.tileSheets,t=Object.keys(e),o=[],r=t.length-1;r>=0;r--)e[t[r]].capturePoints>0&&o.push(t[r]);return o},model.getListOfTileTypes=function(){for(var e=model.sheets.tileSheets,t=Object.keys(e),o=[],r=t.length-1;r>=0;r--)void 0===e[t[r]].capturePoints&&o.push(t[r]);return o},model.primaryWeaponOfUnit=function(e){null===e&&util.illegalArgumentError(),"number"==typeof e&&(e=model.units[e]);var t=model.sheets.unitSheets[e.type][model.PRIMARY_WEAPON_TAG];return void 0!==t?model.sheets.weaponSheets[t]:null},model.secondaryWeaponOfUnit=function(e){null===e&&util.illegalArgumentError(),"number"==typeof e&&(e=model.units[e]);var t=model.sheets.unitSheets[e.type][model.SECONDARY_WEAPON_TAG];return void 0!==t?model.sheets.weaponSheets[t]:null},model.getBaseDamage=function(e,t){null===e&&util.illegalArgumentError(),null===t&&util.illegalArgumentError();var o;return o=e.damages[t],void 0!==o?o:(o=e.damages["*"],void 0!==o?o:0)},model.moveCosts=function(e,t){var o;return o=e.costs[t],void 0===o&&(o=e.costs["*"]),o},model.getLoadedIds=function(e){for(var t=[],o=model.units[e].owner,r=CWT_MAX_UNITS_PER_PLAYER*o,n=r+CWT_MAX_UNITS_PER_PLAYER;n>r;r++)if(r!==e){var i=model.units[r];null!==i&&i.loadedIn===e&&t.push(r)}return t},model.hasLoadedIds=function(e){for(var t=model.units[e].owner,o=CWT_MAX_UNITS_PER_PLAYER*t,r=o+CWT_MAX_UNITS_PER_PLAYER;r>o;o++)if(o!==e){var n=model.units[o];if(null!==n&&n.loadedIn===e)return!0}return!1},model.isLoadedBy=function(e,t){return model.units[e].loadedIn===t},model.loadUnitInto=function(e,t){model.canLoad(e,t)||util.logError("transporter unit",t,"cannot load unit",e),model.units[e].loadedIn=t},model.unloadUnitFrom=function(e){model.units[e].loadedIn=-1},model.canLoad=function(e,t){for(var o=model.units[t],r=model.units[e],n=0,i=CWT_MAX_UNITS_PER_PLAYER*o.owner,l=i+CWT_MAX_UNITS_PER_PLAYER;l>i;i++)if(i!==t){var a=model.units[i];null!==a&&a.loadedIn===t&&(n+=model.sheets.unitSheets[model.units[i].type].weight)}n+=model.sheets.unitSheets[r.type].weight;var u=model.sheets.unitSheets[o.type].transport;if(n>u.maxWeight)return!1;var s=model.sheets.unitSheets[model.units[e].type],c=u.canLoad;return-1!==c.indexOf(model.units[e].type)?!0:-1!==c.indexOf(s.moveType)?!0:-1!==c.indexOf("*")?!0:!1},model.isTransport=function(e){return void 0!==model.sheets.unitSheets[model.units[e].type].transport},model.unitPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.units=util.list(CWT_MAX_PLAYER*CWT_MAX_UNITS_PER_PLAYER,function(){return{x:0,y:0,hp:99,ammo:0,type:null,loadedIn:-1,fuel:0,owner:CWT_INACTIVE_ID,_clientData_:{}}}),model.extractUnitId=function(e){if(null===e)throw Error("unit argument cannot be null");for(var t=model.units,o=0,r=t.length;r>o;o++)if(t[o]===e)return o;throw Error("cannot find unit",JSON.stringify(e))},model.createUnit=function(e,t){for(var o=e*CWT_MAX_UNITS_PER_PLAYER,r=o,n=o+CWT_MAX_UNITS_PER_PLAYER;n>r;r++)if(model.units[r].owner===CWT_INACTIVE_ID){var i=model.sheets.unitSheets[t];return model.units[r].owner=e,model.units[r].hp=99,model.units[r].type=t,model.units[r].ammo=i.maxAmmo,model.units[r].fuel=i.maxFuel,model.units[r].loadedIn=-1,util.DEBUG&&util.logInfo("builded unit for player",e,"in slot",r),r}if(util.DEBUG)throw Error("cannot build unit for player",e,"no slots free");return-1},model.destroyUnit=function(e){model.eraseUnitPosition(e),model.units[e].owner=CWT_INACTIVE_ID},model.hasFreeUnitSlots=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,o=0,r=t+CWT_MAX_UNITS_PER_PLAYER;r>o;o++)if(model.units[o].owner!==CWT_INACTIVE_ID)return!0;return!1},model.eraseUnitPosition=function(e){var t=model.units[e],o=t.x,r=t.y;if(model.unitPosMap[o][r]=null,t.x=-1,t.y=-1,t.owner===model.turnOwner){var n=new controller.ActionData;n.setSource(o,r),n.setAction("remVisioner"),n.setSubAction(model.sheets.unitSheets[t.type].vision),controller.pushActionDataIntoBuffer(n)}},model.setUnitPosition=function(e,t,o){var r=model.units[e];if(r.x,r.y,r.x=t,r.y=o,model.unitPosMap[t][o]=r,r.owner===model.turnOwner){var n=new controller.ActionData;n.setSource(t,o),n.setAction("addVisioner"),n.setSubAction(model.sheets.unitSheets[r.type].vision),controller.pushActionDataIntoBuffer(n)}},model.tileOccupiedByUnit=function(e,t){var o=model.unitPosMap[e][t];return null===o?!1:model.extractUnitId(o)},model.countUnits=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,o=0,r=0,n=t+CWT_MAX_UNITS_PER_PLAYER;n>r;r++)model.units[r].owner!==CWT_INACTIVE_ID&&o++;return o},controller._actionDataPool=util.createRingBuffer(50),controller.aquireActionDataObject=function(){var e=controller._actionDataPool;return e.isEmpty()?new controller.ActionData:e.pop()},controller.releaseActionDataObject=function(e){!e instanceof controller.ActionData&&util.illegalArgumentError(),e.cleanIt(),controller._actionDataPool.push(e)},controller.ActionData=function(){this.data=[],this.cleanIt()},controller.ActionData.prototype.cleanIt=function(){this.data[0]=-1,this.data[1]=-1,this.data[2]=-1,this.data[3]=-1,this.data[4]=-1,this.data[5]=-1,this.data[6]=-1,this.data[7]=-1,this.data[8]=-1,this.data[9]=-1,this.data[10]=null,this.data[11]=null,this.data[12]=null},controller.ActionData.prototype.setSource=function(e,t){this.data[0]=e,this.data[1]=t},controller.ActionData.prototype.getSourceX=function(){return this.data[0]},controller.ActionData.prototype.getSourceY=function(){return this.data[1]},controller.ActionData.prototype.setTarget=function(e,t){this.data[2]=e,this.data[3]=t},controller.ActionData.prototype.getTargetX=function(){return this.data[2]},controller.ActionData.prototype.getTargetY=function(){return this.data[3]},controller.ActionData.prototype.setActionTarget=function(e,t){this.data[4]=e,this.data[5]=t},controller.ActionData.prototype.getActionTargetX=function(){return this.data[4]},controller.ActionData.prototype.getActionTargetY=function(){return this.data[5]},controller.ActionData.prototype.setSourceUnit=function(e){this.data[6]=null===e?-1:model.extractUnitId(e)},controller.ActionData.prototype.getSourceUnit=function(){var e=this.data[6];return-1===e?null:model.units[e]},controller.ActionData.prototype.getSourceUnitId=function(){return this.data[6]},controller.ActionData.prototype.setSourceProperty=function(e){this.data[7]=null===e?-1:model.extractPropertyId(e)},controller.ActionData.prototype.getSourceProperty=function(){var e=this.data[7];return-1===e?null:model.properties[e]},controller.ActionData.prototype.getSourcePropertyId=function(){return this.data[7]},controller.ActionData.prototype.setTargetUnit=function(e){this.data[8]=null===e?-1:model.extractUnitId(e)},controller.ActionData.prototype.getTargetUnit=function(){var e=this.data[8];return-1===e?null:model.units[e]},controller.ActionData.prototype.getTargetUnitId=function(){return this.data[8]},controller.ActionData.prototype.setTargetProperty=function(e){this.data[9]=null===e?-1:model.extractPropertyId(e)},controller.ActionData.prototype.getTargetProperty=function(){var e=this.data[9];return-1===e?null:model.properties[e]},controller.ActionData.prototype.getTargetPropertyId=function(){return this.data[9]},controller.ActionData.prototype.setMovePath=function(e){this.data[10]=e},controller.ActionData.prototype.getMovePath=function(){return this.data[10]},controller.ActionData.prototype.setAction=function(e){this.data[11]=e},controller.ActionData.prototype.getAction=function(){return this.data[11]},controller.ActionData.prototype.setSubAction=function(e){this.data[12]=e},controller.ActionData.prototype.getSubAction=function(){return this.data[12]},controller.ActionData.prototype.getCopy=function(){var e=controller.aquireActionDataObject();return e.data[0]=this.data[0],e.data[1]=this.data[1],e.data[2]=this.data[2],e.data[3]=this.data[3],e.data[4]=this.data[4],e.data[5]=this.data[5],e.data[6]=this.data[6],e.data[7]=this.data[7],e.data[8]=this.data[8],e.data[9]=this.data[9],e.data[10]=this.data[10],e.data[11]=this.data[11],e.data[12]=this.data[12],e},controller.commands={},controller.commandBuffer=util.createRingBuffer(200),controller.registerCommand=function(e){util.isString(e.key)||util.illegalArgumentError(),util.isFn(e.action)||util.illegalArgumentError(),util.isFn(e.condition)||util.illegalArgumentError();for(var t={prepareMenu:null,prepareTargets:null,localAction:!1,multiStepAction:!1,condition:util.FUNCTION_TRUE_RETURNER},o=e.key,r=Object.keys(e),n=0,i=r.length;i>n;n++)t[r[n]]=e[r[n]];controller.commands[o]=t},controller.invokeCommand=function(e,t){1===arguments.length&&(t=e.getAction()),util.isString(t)||util.illegalArgumentError(),util.isDefined(e)||util.illegalArgumentError();var o=controller.commands[t];null!==e.getMovePath()&&controller.commands.move.action.apply(o,[e]),o.action.apply(o,[e])},controller.isNetworkGame=function(){return!1},controller._parseNetworkMessage=function(){util.unexpectedSituationError()},controller._sendNetworkMessage=function(){util.unexpectedSituationError()},controller.pushActionDataIntoBuffer=function(e,t){if(util.logInfo("pushing command into buffer...\n","source (",e.getSourceX(),",",e.getSourceY(),")\n","target (",e.getTargetX(),",",e.getTargetY(),")\n","action target (",e.getActionTargetX(),",",e.getActionTargetY(),")\n","selected unit id",e.getSourceUnitId(),"\n","selected property id",e.getSourcePropertyId(),"\n","target unit id",e.getTargetUnitId(),"\n","target property id",e.getTargetPropertyId(),"\n","selected action",e.getAction(),"\n","sub menu action",e.getSubAction(),"\n","move path",e.getMovePath()),controller.commandBuffer.push(e),t!==!0&&this.isNetworkGame()){var o=controller.commands[e.getAction()];o.localAction!==!1&&this._sendNetworkMessage(e)}},controller.getActionObject=function(e){return controller.commands[e]},controller.isBufferEmpty=function(){return controller.commandBuffer.isEmpty()},controller.evalNextMessageFromBuffer=function(){if(controller.commandBuffer.isEmpty())return null;var e=controller.commandBuffer.pop();return util.logInfo("evaluating command into buffer...\n","source (",e.getSourceX(),",",e.getSourceY(),")\n","target (",e.getTargetX(),",",e.getTargetY(),")\n","action target (",e.getActionTargetX(),",",e.getActionTargetY(),")\n","selected unit id",e.getSourceUnitId(),"\n","selected property id",e.getSourcePropertyId(),"\n","target unit id",e.getTargetUnitId(),"\n","target property id",e.getTargetPropertyId(),"\n","selected action",e.getAction(),"\n","sub menu action",e.getSubAction(),"\n","move path",e.getMovePath()),controller.invokeCommand(e),e},controller.saveDOM=function(){return JSON.stringify(model)},controller.loadDOM=function(e){if("string"==typeof e){try{e=JSON.parse(e)}catch(t){if(util.DEBUG)throw Error("got invalid json save data")}throw Error("niy")}},controller.loadMod=function(e){var t;t=e.movetypes;for(var o=0,r=t.length;r>o;o++)model.parseSheet(t[o],model.MOVE_TYPE_SHEET);t=e.weapons;for(var o=0,r=t.length;r>o;o++)model.parseSheet(t[o],model.WEAPON_TYPE_SHEET);t=e.tiles;for(var o=0,r=t.length;r>o;o++)model.parseSheet(t[o],model.TILE_TYPE_SHEET);t=e.units;for(var o=0,r=t.length;r>o;o++)model.parseSheet(t[o],model.UNIT_TYPE_SHEET);var n=e.locale;if(void 0!==n)for(var i=Object.keys(n),o=0,r=i.length;r>o;o++)util.i18n_appendToLanguage(i[o],n[i[o]])},controller.idHolder=new util.StringIdMapper,controller.input=util.createStateMachine("NONE",{NONE:{start:function(){return this.menu=util.list(20,null),this.menuSize=0,this.inMultiStep=!1,this.actionData=controller.aquireActionDataObject(),this.selectionData=new controller.SelectionData(CWT_MAX_MOVE_RANGE),"IDLE"}},IDLE:{onenter:function(){this.menuSize=0,this.inMultiStep=!1,this.actionData.cleanIt()},action:function(e,t,o){this._checkClickEventArgs(e,t,o);var r,n=this.actionData;return n.setSource(t,o),null!==(r=model.unitPosMap[t][o])&&n.setSourceUnit(r),null!==(r=model.propertyPosMap[t][o])&&n.setSourceProperty(r),n.getSourceUnitId()!==CWT_INACTIVE_ID&&n.getSourceUnit().owner===model.turnOwner&&model.canAct(n.getSourceUnitId())?(n.setTarget(t,o),n.setMovePath([]),model.fillMoveMap(this.selectionData,n),"MOVEPATH_SELECTION"):(this._prepareMenu(),"ACTION_MENU")},cancel:function(){return"IDLE"}},MOVEPATH_SELECTION:{action:function(e,t,o){if(controller.input._checkClickEventArgs(e,t,o),0>this.selectionData.getPositionValue(t,o))return CLIENT_DEBUG&&util.logInfo("break event because selection is not in the map"),"MOVEPATH_SELECTION";var r=this.actionData,n=r.getTargetX(),i=r.getTargetY(),l=model.distance(n,i,t,o);if(r.setTarget(t,o),0===l){util.fill(this.menu,null),this.menuSize=0;var a;if(model.fogData[t][o]>0&&null!==(a=model.unitPosMap[t][o])&&this.actionData.setTargetUnit(a),null!==(a=model.propertyPosMap[t][o])&&this.actionData.setTargetProperty(a),this._prepareMenu(),this.menuSize>0)return"ACTION_MENU";var r=this.actionData;return r.setTarget(-1,-1),r.setTargetProperty(null),r.setTargetUnit(null),"MOVEPATH_SELECTION"}if(1===l){var u=model.moveCodeFromAtoB(n,i,t,o);return model.addCodeToPath(this.selectionData,r,t,o,u),"MOVEPATH_SELECTION"}return model.setPathByRecalculation(this.selectionData,r,t,o),"MOVEPATH_SELECTION"},cancel:function(){var e=this.actionData;return e.setTarget(-1,-1),e.setTargetProperty(null),e.setTargetUnit(null),"IDLE"}},ACTION_MENU:{action:function(e,t){controller.input._checkMenuEventArgs(e,t);var o=this.menu[t],r=controller.getActionObject(o);return this.actionData.setAction(o),null!==r.prepareMenu?(util.fill(this.menu,null),this.menuSize=0,r.prepareMenu(this.actionData,controller.input._addMenuEntry),"ACTION_SUBMENU"):r.freeTargetSelection?"ACTION_SELECT_TILE":null!==r.prepareTargets?controller.input._prepareSelection(r,"ACTION_MENU"):"FLUSH_ACTION"},cancel:function(){var e=this.actionData;e.setTarget(-1,-1),e.setTargetProperty(null),e.setTargetUnit(null);var e=this.actionData;return e.getSourceUnitId()!==CWT_INACTIVE_ID&&e.getSourceUnit().owner===model.turnOwner&&model.canAct(e.getSourceUnitId())?"MOVEPATH_SELECTION":"IDLE"}},ACTION_SUBMENU:{action:function(e,t){controller.input._checkMenuEventArgs(e,t);var o=this.menu[t];if("done"===o)return"IDLE";var r=controller.getActionObject(this.actionData.getAction());return this.actionData.setSubAction(o),null!==r.prepareTargets?controller.input._prepareSelection(r,"ACTION_SUBMENU"):"FLUSH_ACTION"},cancel:function(){return this.inMultiStep?"ACTION_SUBMENU":(util.fill(this.menu,null),this.menuSize=0,this._prepareMenu(),"ACTION_MENU")}},ACTION_SELECT_TARGET:{action:function(e,t,o){if(controller.input._checkClickEventArgs(e,t,o),0>this.selectionData.getPositionValue(t,o))return CLIENT_DEBUG&&util.logInfo("break event because selection is not in the map"),"ACTION_SELECT_TARGET";this.actionData.setActionTarget(t,o);var r;return model.fogData[t][o]>0&&null!==(r=model.unitPosMap[t][o])?this.actionData.setTargetUnit(r):this.actionData.setTargetUnit(null),null!==(r=model.propertyPosMap[t][o])?this.actionData.setTargetProperty(r):this.actionData.setTargetProperty(null),"FLUSH_ACTION"},cancel:function(){return this._last}},ACTION_SELECT_TILE:{action:function(e,t,o){controller.input._checkClickEventArgs(e,t,o),this.actionData.setActionTarget(t,o);var r;return model.fogData[t][o]>0&&null!==(r=model.unitPosMap[t][o])?this.actionData.setTargetUnit(r):this.actionData.setTargetUnit(null),null!==(r=model.propertyPosMap[t][o])?this.actionData.setTargetProperty(r):this.actionData.setTargetProperty(null),"FLUSH_ACTION"},cancel:function(){return"ACTION_MENU"}},FLUSH_ACTION:{actionState:function(){var e=this.actionData,t=!1;if(null!==e.getMovePath())for(var o=e.getMovePath(),r=e.getSourceX(),n=e.getSourceY(),i=0,l=o.length;l>i;i++){switch(o[i]){case model.MOVE_CODE_DOWN:n++;break;case model.MOVE_CODE_UP:n--;break;case model.MOVE_CODE_LEFT:r--;break;case model.MOVE_CODE_RIGHT:r++}if(0===model.fogData[r][n]){var a=model.unitPosMap[r][n];null!=a&&model.players[model.turnOwner].team!==model.players[a.owner].team&&(e.setAction("trapWait"),e.setTarget(r,n),e.setTargetUnit(a),e.setTargetProperty(null),o.splice(i),t=!0)}}controller.pushActionDataIntoBuffer(e.getCopy());var u=e.getAction(),s=controller.getActionObject(u);if(!t&&s.multiStepAction){this.inMultiStep=!0;var c=controller.aquireActionDataObject();return c.setAction("invokeMultiStepAction"),controller.pushActionDataIntoBuffer(c),"MULTISTEP_IDLE"}return"IDLE"}},MULTISTEP_IDLE:{nextStep:function(){var e=this.actionData.getAction(),t=controller.getActionObject(e);return this.menuSize=0,this.actionData.setMovePath(null),util.fill(this.menu,null),t.prepareMenu(this.actionData,controller.input._addMenuEntry),controller.input._addMenuEntry("done"),this.menuSize>1?"ACTION_SUBMENU":"IDLE"}}}),controller.input._addMenuEntry=function(e){controller.input.menuSize===controller.input.menu.length&&util.unexpectedSituationError(),controller.input.menu[controller.input.menuSize]=e,controller.input.menuSize++},controller.input._prepareSelection=function(e,t){var o=this.actionData.getTargetX(),r=this.actionData.getTargetY();return this._last=t,this.selectionData.cleanIt(-1,o,r),e.prepareTargets(this.actionData,this.selectionData),"ACTION_SELECT_TARGET"},controller.input._checkMenuEventArgs=function(e,t){util.isNumber(t)||util.illegalArgumentError(),(0>t||t>=this.menu.length)&&util.illegalArgumentError()
},controller.input._checkClickEventArgs=function(e,t,o){util.isNumber(t)&&util.isNumber(o)||util.illegalArgumentError(),model.isValidPosition(t,o)||util.illegalPositionError()},controller.input._prepareMenu=function(){var e=this.actionData,t=controller.input._addMenuEntry,o=Object.keys(controller.commands),r=!0,n=e.getSourceUnit();null===n||n.owner!==model.turnOwner?r=!1:model.canAct(e.getSourceUnitId())||(r=!1);var i=!0,l=e.getSourceProperty();null!==n&&(i=!1),(null===l||l.owner!==model.turnOwner)&&(i=!1);for(var a=0,u=o.length;u>a;a++){var s=controller.getActionObject(o[a]);(s.unitAction!==!0||r)&&(s.propertyAction!==!0||i)&&s.condition(e)&&t(o[a])}},controller.SelectionData=function(e){var t=2*e+1;this.data=[util.matrix(t,t,0),0,0]},controller.SelectionData.prototype.cleanIt=function(e,t,o){for(var r=this.data[0],n=r.length,i=0;n>i;i++)for(var l=0;n>l;l++)r[i][l]=e;this.data[1]=Math.max(0,t-CWT_MAX_SELECTION_RANGE),this.data[2]=Math.max(0,o-CWT_MAX_SELECTION_RANGE)},controller.SelectionData.prototype.setPositionValue=function(e,t,o){var r=this.data[0],n=this.data[1],i=this.data[2];e-=i,t-=n;var l=r.length;0>e||0>t||e>=l||t>=l?util.illegalPositionError():r[e][t]=o},controller.SelectionData.prototype.getPositionValue=function(e,t){var o=this.data[0],r=this.data[1],n=this.data[2];e-=n,t-=r;var i=o.length;return 0>e||0>t||e>=i||t>=i?-1:o[e][t]},controller.SelectionData.prototype.getCenterX=function(){return this.data[1]},controller.SelectionData.prototype.getCenterY=function(){return this.data[1]},controller.SelectionData.prototype.getDataMatrix=function(){return this.data[0]},controller.registerCommand({key:"addVisioner",condition:function(){return!1},action:function(e){model.setVisioner(e.getSourceX(),e.getSourceY(),e.getSubAction())}}),controller.registerCommand({key:"attack",unitAction:!0,targetSelection:!0,hasSubMenu:!0,counterWeapon:function(e,t,o,r){var n=Math.abs(e-o)+Math.abs(t-r);if(n>1)return null;var i=model.unitPosMap[e][t];model.unitPosMap[o][r];var l=model.sheets.unitSheets[i.type],a=l[model.PRIMARY_WEAPON_TAG],u=l[model.SECONDARY_WEAPON_TAG];if(void 0!==a){a=model.sheets.weaponSheets[a];var s=a.minRange,c=a.maxRange;if(1===s&&1===c&&1===n)return a}if(void 0!==u){u=model.sheets.weaponSheets[u];var s=u.minRange,c=u.maxRange;if(1===s&&1===c&&1===n)return u}return null},hasTargets:function(e,t,o,r){2===arguments.length&&(o=e.x,r=e.y);var n=e.owner,i=model.players[e.owner].team,l=model.sheets.unitSheets[e.type],a=model.sheets.weaponSheets[t===model.PRIMARY_WEAPON_TAG?l[model.PRIMARY_WEAPON_TAG]:l[model.SECONDARY_WEAPON_TAG]];if(void 0===a)return!1;var u,s,c=a.minRange,d=a.maxRange,m=r-d,p=r+d;for(0>m&&(m=0),p>=model.mapHeight&&(p=model.mapHeight-1);p>=m;m++){var g=Math.abs(m-r);for(u=o-d+g,s=o+d-g,0>u&&(u=0),s>=model.mapWidth&&(s=model.mapWidth-1);s>=u;u++)if(model.distance(o,r,u,m)>=c){var h=model.unitPosMap[u][m];if(null!==h&&h.owner!==n&&model.players[h.owner].team!==i){if(0===model.fogData[u][m])continue;var f=model.getBaseDamage(a,h.type);if(f>0)return!0}}}},prepareMenu:function(e,t){var o=e.getSourceUnit(),r=e.getTargetX(),n=e.getTargetY();this.hasTargets(o,model.PRIMARY_WEAPON_TAG,r,n,!0)&&t("mainWeapon"),this.hasTargets(o,model.SECONDARY_WEAPON_TAG,r,n,!0)&&t("subWeapon")},prepareTargets:function(e,t){var o,r,n=e.getSourceUnit(),i=e.getSubAction(),l=e.getTargetX(),a=e.getTargetY(),u="mainWeapon"===i?model.primaryWeaponOfUnit(n):model.secondaryWeaponOfUnit(n),s=n.owner,c=model.players[n.owner].team,d=u.minRange,m=u.maxRange,p=a-m,g=a+m;for(0>p&&(p=0),g>=model.mapHeight&&(g=model.mapHeight-1);g>=p;p++){var h=Math.abs(p-a);for(o=l-m+h,r=l+m-h,0>o&&(o=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=o;o++)if(model.distance(l,a,o,p)>=d){var f=model.unitPosMap[o][p];if(null!==f&&f.owner!==s&&model.players[f.owner].team!==c){if(0===model.fogData[o][p])continue;var _=model.getBaseDamage(u,f.type);_>0&&(util.logInfo("found target at (",o,",",p,")"),t.setPositionValue(o,p,1))}}}},condition:function(e){var t=model.rules.daysOfPeace;if(t>model.day-1)return!1;if(e.getTargetUnitId()!==CWT_INACTIVE_ID&&e.getTargetUnitId()!==e.getSourceUnitId())return!1;var o=e.getSourceUnit(),r=e.getTargetX(),n=e.getTargetY();return null!==model.primaryWeaponOfUnit(o)&&this.hasTargets(o,model.PRIMARY_WEAPON_TAG,r,n,!0)||null!==model.secondaryWeaponOfUnit(o)&&this.hasTargets(o,model.SECONDARY_WEAPON_TAG,r,n,!0)?!0:!1},action:function(e){var t=e.getSourceUnit(),o=e.getTargetUnit(),r=e.getSubAction(),n="mainWeapon"===r?model.primaryWeaponOfUnit(t):model.secondaryWeaponOfUnit(t),i=this.counterWeapon(o.x,o.y,t.x,t.y),l=model.getBaseDamage(n,o.type);if(o.hp-=l,0!==n.useAmmo&&t.ammo--,0>o.hp)model.destroyUnit(model.extractUnitId(o));else if(null!==i){var a=model.getBaseDamage(i,t.type);t.hp-=a,0!==i.useAmmo&&o.ammo--,0>t.hp&&model.destroyUnit(model.extractUnitId(t))}controller.invokeCommand(e,"wait")}}),controller.registerCommand({key:"buildUnit",propertyAction:!0,hasSubMenu:!0,canPropTypeBuildUnitType:function(e,t){var o=model.sheets.tileSheets[e],r=o.builds;if(void 0===r)return!1;if(-1!==model.rules.blockedUnits.indexOf(t))return!1;if(-1!==r.indexOf("*"))return!0;if(-1!==r.indexOf(t))return!0;var n=model.sheets.unitSheets[t],i=n.moveType;return-1!==r.indexOf(i)?!0:!1},getBuildList:function(e){var t=[],o=model.getListOfUnitTypes(),r=model.properties[e];model.sheets.tileSheets[r.type];for(var n=model.players[model.turnOwner].gold,i=0,l=o.length;l>i;i++)this.canPropTypeBuildUnitType(r.type,o[i])&&n>=model.sheets.unitSheets[o[i]].cost&&t.push(o[i]);return t},prepareMenu:function(e,t){var o=e.getSourceProperty();null===o&&util.illegalArgumentError();for(var r=this.getBuildList(model.extractPropertyId(o)),n=0,i=r.length;i>n;n++)t(r[n])},condition:function(e){return e.getSourceProperty(),model.countUnits(model.turnOwner)>=model.rules.unitLimit?!1:model.hasFreeUnitSlots(model.turnOwner)&&this.getBuildList(model.extractPropertyId(e.getSourceProperty())).length>0},action:function(e){var t=e.getSourceX(),o=e.getSourceY(),r=e.getSubAction(),n=model.createUnit(model.turnOwner,r);model.setUnitPosition(n,t,o);var i=model.players[model.turnOwner];i.gold-=model.sheets.unitSheets[r].cost;var l=controller.aquireActionDataObject();l.setSourceUnit(model.units[n]),l.setAction("wait"),controller.invokeCommand(l)}}),controller.registerCommand({key:"captureProperty",unitAction:!0,condition:function(e){var t=e.getSourceUnit(),o=e.getTargetUnit(),r=e.getTargetProperty();return null!==r&&model.turnOwner!==r.owner&&(null===o||o===t)&&model.sheets.tileSheets[r.type].capturePoints>0&&model.sheets.unitSheets[t.type].captures>0},action:function(e){var t=e.getSourceUnit(),o=e.getTargetProperty(),r=model.sheets.unitSheets[t.type];if(o.capturePoints-=r.captures,0>=o.capturePoints){var n=e.getTargetX(),i=e.getTargetY();util.logInfo("property at (",n,",",i,") captured");var e=new controller.ActionData;if(e.setSource(n,i),e.setAction("addVisioner"),e.setSubAction(model.sheets.tileSheets[o.type].vision),controller.pushActionDataIntoBuffer(e),"HQTR"===o.type){for(var l=o.owner,a=model.players[l],u=l*CWT_MAX_UNITS_PER_PLAYER,s=u+CWT_MAX_UNITS_PER_PLAYER;s>u;u++)model.units[u].owner=-1,model.eraseUnitPosition(u);for(var u=0,s=model.properties.length;s>u;u++)model.properties[u].owner===l&&(model.properties[u].owner=-1);a.team=-1;for(var c=-1,u=0,s=model.players.length;s>u;u++){var d=model.players[u];if(-1!==d.team)if(-1===c)c=d.team;else if(c!==d.team){c=-1;break}}if(-1!==c){var m=controller.aquireActionDataObject();m.setAction("endGame"),controller.pushActionDataIntoBuffer(m,!0)}}o.capturePoints=20,o.owner=t.owner;var p=model.rules.captureWinLimit;if(0!==p&&model.countProperties()>=p){var m=controller.aquireActionDataObject();m.setAction("endGame"),controller.pushActionDataIntoBuffer(m,!0)}}controller.invokeCommand(e,"wait")}}),controller.registerCommand({key:"endGame",condition:util.FUNCTION_FALSE_RETURNER,action:function(){util.logInfo("the game ends because no opposite players exists")}}),controller.registerCommand({key:"healUnit",condition:function(){return!1},action:function(e){var t=e.getTargetUnit(),o=20;t.hp+=o,t.hp>99&&(t.hp=99)}}),controller.registerCommand({key:"invokeMultiStepAction",condition:util.FUNCTION_FALSE_RETURNER,action:function(){controller.input.event("nextStep")}}),controller.registerCommand({key:"join",unitAction:!0,condition:function(e){var t=e.getSourceUnit(),o=e.getTargetUnit();return null===o||o.owner!==model.turnOwner||o===t?!1:t.type===o.type&&89>o.hp},action:function(e){var t=e.getSourceUnit(),o=e.getTargetUnit(),r=model.sheets.unitSheets[o.type];o.hp+=t.hp,o.hp>99&&(o.hp=99),o.ammo+=t.ammo,o.ammo>r.maxAmmo&&(o.ammo=r.maxAmmo),o.fuel+=t.fuel,o.fuel>r.maxFuel&&(o.fuel=r.maxFuel),model.destroyUnit(model.extractUnitId(t)),e.setSourceUnit(o),controller.invokeCommand(e,"wait")}}),controller.registerCommand({key:"loadGame",_copyProps:function(e,t){for(var o=Object.keys(e),r=0,n=o.length;n>r;r++)t[o[r]]=e[o[r]]},condition:util.FUNCTION_FALSE_RETURNER,action:function(e){util.DEBUG&&util.logInfo("start loading game instance");var t=this._copyProps,o=e.getSubAction();model.mapHeight=o[controller.SERIALIZATION_MAP_H],model.mapWidth=o[controller.SERIALIZATION_MAP_W];for(var r=0,n=model.mapWidth;n>r;r++)for(var i=0,l=model.mapHeight;l>i;i++)model.map[r][i]=o[controller.SERIALIZATION_MAP][r][i];for(var a=0,u=model.units.length;u>a;a++){var s=model.units[a];o[controller.SERIALIZATION_UNITS].hasOwnProperty(a)?t(o[controller.SERIALIZATION_UNITS][a],s):s.owner=CWT_INACTIVE_ID}for(var r=0,n=model.mapWidth;n>r;r++)for(var i=0,l=model.mapHeight;l>i;i++)model.unitPosMap[r][i]=null;var c;c=Object.keys(o[controller.SERIALIZATION_UNITS_POS]);for(var a=0,u=c.length;u>a;a++){var d=c[a].split(","),r=parseInt(d[0],10),i=parseInt(d[1],10);model.unitPosMap[r][i]=model.units[o[controller.SERIALIZATION_UNITS_POS][c[a]]]}for(var a=0,u=model.properties.length;u>a;a++){var m=model.properties[a];o[controller.SERIALIZATION_PROPS].hasOwnProperty(a)?t(o[controller.SERIALIZATION_PROPS][a],m):m.owner=CWT_INACTIVE_ID}for(var r=0,n=model.mapWidth;n>r;r++)for(var i=0,l=model.mapHeight;l>i;i++)model.propertyPosMap[r][i]=null;c=Object.keys(o[controller.SERIALIZATION_PROPS_POS]);for(var a=0,u=c.length;u>a;a++){var d=c[a].split(","),r=parseInt(d[0],10),i=parseInt(d[1],10);model.propertyPosMap[r][i]=model.properties[o[controller.SERIALIZATION_PROPS_POS][c[a]]]}if(model.day=o[controller.SERIALIZATION_DAY],model.turnOwner=o[controller.SERIALIZATION_TURNOWNER],void 0!==o[controller.SERIALIZATION_LEFTACTORS])for(var a=0,u=o[controller.SERIALIZATION_LEFTACTORS].length;u>a;a++)model.leftActors[a]=o[controller.SERIALIZATION_LEFTACTORS][a];else util.fill(model.leftActors,!0);for(var a=0,u=model.players.length;u>a;a++){var p=model.players[a];o[controller.SERIALIZATION_PLAYERS].hasOwnProperty(a)?t(o[controller.SERIALIZATION_PLAYERS][a],p):p.team=CWT_INACTIVE_ID}model.setRulesByOption({}),util.DEBUG&&util.logInfo("game instance successfully loaded")}}),controller.registerCommand({key:"loadMod",condition:util.FUNCTION_FALSE_RETURNER,action:function(){for(var e=0,t=CWT_MOD_DEFAULT.movetypes.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.movetypes[e],model.sheets.MOVE_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.tiles.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.tiles[e],model.sheets.TILE_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.units.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.units[e],model.sheets.UNIT_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.weapons.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.weapons[e],model.sheets.WEAPON_TYPE_SHEET);for(var o=Object.keys(CWT_MOD_DEFAULT.locale),e=0,t=o.length;t>e;e++)util.i18n_appendToLanguage(o[e],CWT_MOD_DEFAULT.locale[o[e]]);model.parseSheet(CWT_MOD_DEFAULT.rules,model.sheets.RULESET)}}),controller.registerCommand({key:"loadUnit",unitAction:!0,condition:function(e){var t=e.getSourceUnitId(),o=e.getTargetUnitId();return-1===o||e.getTargetUnit().owner!==model.turnOwner?!1:model.isTransport(o)&&model.canLoad(t,o)},action:function(e){var t=e.getSourceUnitId(),o=e.getTargetUnitId();model.loadUnitInto(t,o)}}),controller.registerCommand({key:"makeActable",userAction:!1,condition:function(){return!1},action:function(e){model.leftActors[e.getSourceUnitId()]=!0}}),controller.registerCommand({key:"move",condition:util.FUNCTION_FALSE_RETURNER,action:function(e){for(var t=e.getMovePath(),o=e.getSourceUnitId(),r=e.getSourceX(),n=e.getSourceY(),i=model.units[o],l=model.sheets.unitSheets[i.type],a=model.sheets.movetypeSheets[l.moveType],u=(t.length-1,0),s=0,c=t.length;c>s;s++){switch(t[s]){case model.MOVE_CODE_UP:0===n&&util.logError("cannot do move command UP because","current position is at the border"),n--;break;case model.MOVE_CODE_RIGHT:r===model.mapWidth-1&&util.logError("cannot do move command RIGHT because","current position is at the border"),r++;break;case model.MOVE_CODE_DOWN:n===model.mapHeight-1&&util.logError("cannot do move command DOWN because","current position is at the border"),n++;break;case model.MOVE_CODE_LEFT:0===r&&util.logError("cannot do move command LEFT because","current position is at the border"),r--;break;default:util.logError("unknown command ",t[s])}u+=model.moveCosts(a,model.map[r][n])}i.fuel-=u,-1!==i.x&&-1!==i.y&&model.eraseUnitPosition(o),null===model.unitPosMap[r][n]&&model.setUnitPosition(o,r,n),util.logInfo("moved unit",o,"from (",e.getSourceX(),",",e.getSourceY(),")","to (",r,",",n,")")}}),controller.registerCommand({key:"nextTurn",condition:function(e){return e.getSourceUnitId()===CWT_INACTIVE_ID?e.getSourcePropertyId()!==CWT_INACTIVE_ID&&e.getSourceProperty().owner===model.turnOwner?!1:!0:e.getSourceUnit().owner===model.turnOwner&&model.canAct(e.getSourceUnitId())?!1:!0},action:function(){var e=model.turnOwner,t=e;for(e++;e!==t;){if(e===CWT_MAX_PLAYER){e=0,model.day++;var o=model.rules.dayLimit;if(0!==o&&model.day===o){var r=controller.aquireActionDataObject();r.setAction("endGame"),controller.pushActionDataIntoBuffer(r,!0)}}if(model.players[e].team!==CWT_INACTIVE_ID)break;e++}e===t&&util.unexpectedSituationError(),model.turnOwner=e;var n=new controller.ActionData,i=model.rules.autoSupplyAtTurnStart;n.setAction("supplyTurnStart");for(var l=e*CWT_MAX_UNITS_PER_PLAYER,a=l,u=a+CWT_MAX_UNITS_PER_PLAYER;u>a;a++){model.leftActors[a-l]=null!==model.units[a];var s=model.units[a];i&&"APCR"===s.type&&(n.setSource(s.x,s.y),n.setTarget(s.x,s.y),n.setSourceUnit(s),controller.invokeCommand(n))}var c=model.players[e];model.rules.cityRepair;for(var d=model.rules.funds,a=0,u=model.properties.length;u>a;a++)model.properties[a].owner===e&&(c.gold+=d);model.generateFogMap(e)}}),controller.registerCommand({key:"remVisioner",condition:function(){return!1},action:function(e){model.removeVisioner(e.getSourceX(),e.getSourceY(),e.getSubAction())}}),controller.SERIALIZATION_MAP="map",controller.SERIALIZATION_MAP_H="mapHeight",controller.SERIALIZATION_MAP_W="mapWidth",controller.SERIALIZATION_UNITS="units",controller.SERIALIZATION_UNITS_POS="unitPosMap",controller.SERIALIZATION_PROPS="properties",controller.SERIALIZATION_PROPS_POS="propertyPosMap",controller.SERIALIZATION_PLAYERS="players",controller.SERIALIZATION_DAY="day",controller.SERIALIZATION_TURNOWNER="turnOwner",controller.SERIALIZATION_LEFTACTORS="leftActors",controller.registerCommand({key:"saveGame",condition:util.FUNCTION_FALSE_RETURNER,action:function(e){util.DEBUG&&util.logInfo("start saving game instance");var t={};t[controller.SERIALIZATION_MAP]=util.matrix(model.mapWidth,model.mapHeight,null);for(var o=0,r=model.mapWidth;r>o;o++)for(var n=0,i=model.mapHeight;i>n;n++)t[controller.SERIALIZATION_MAP][o][n]=model.map[o][n];t[controller.SERIALIZATION_MAP_H]=model.mapHeight,t[controller.SERIALIZATION_MAP_W]=model.mapWidth,t[controller.SERIALIZATION_UNITS]={};for(var l=0,a=model.units.length;a>l;l++){var u=model.units[l];u.owner!==CWT_INACTIVE_ID&&(t[controller.SERIALIZATION_UNITS][l]=u)}t[controller.SERIALIZATION_UNITS_POS]={};for(var o=0,r=model.mapWidth;r>o;o++)for(var n=0,i=model.mapHeight;i>n;n++){var u=model.unitPosMap[o][n];null!==u&&(t[controller.SERIALIZATION_UNITS_POS][o+","+n]=model.extractUnitId(u))}t[controller.SERIALIZATION_PROPS]={};for(var l=0,a=model.properties.length;a>l;l++){var s=model.properties[l];s.owner!==CWT_INACTIVE_ID&&(t[controller.SERIALIZATION_PROPS][l]=s)}t[controller.SERIALIZATION_PROPS_POS]={};for(var o=0,r=model.mapWidth;r>o;o++)for(var n=0,i=model.mapHeight;i>n;n++){var s=model.propertyPosMap[o][n];null!==s&&(t[controller.SERIALIZATION_PROPS_POS][o+","+n]=model.extractPropertyId(s))}t[controller.SERIALIZATION_DAY]=model.day,t[controller.SERIALIZATION_TURNOWNER]=model.turnOwner,t[controller.SERIALIZATION_LEFTACTORS]=model.leftActors,t[controller.SERIALIZATION_PLAYERS]={};for(var l=0,a=model.players.length;a>l;l++){var c=model.players[l];c.team!==CWT_INACTIVE_ID&&(t[controller.SERIALIZATION_PLAYERS][l]=c)}t=JSON.stringify(t,null,"	"),e.setSubAction(t),util.DEBUG&&util.logInfo("game instance successfully saved")}}),controller.registerCommand({key:"silofire",unitAction:!0,freeTargetSelection:!0,_doDamage:function(e,t){if(model.isValidPosition(e,t)){var o=model.unitPosMap[e][t];null!==o&&(o.hp-=20,9>o.hp&&(o.hp=9))}},condition:function(e){var t=e.getSourceUnit(),o=e.getTargetProperty();return null===o||o.owner!==model.turnOwner?!1:"INFT"!==t.type&&"MECH"!==t.type?!1:"SILO"===o.type},targetValid:function(e,t,o){return model.isValidPosition(t,o)},action:function(e){var t=this._doDamage,o=e.getActionTargetX(),r=e.getActionTargetY();t(o,r-2),t(o-1,r-1),t(o,r-1),t(o+1,r-1),t(o-2,r),t(o-1,r),t(o,r),t(o+1,r),t(o+2,r),t(o-1,r+1),t(o,r+1),t(o+1,r+1),t(o,r+2);var n=e.getSourceUnit().x,i=e.getSourceUnit().y;model.propertyPosMap[n][i].type="SILO_EMPTY",controller.invokeCommand(e,"wait")}}),controller.registerCommand({key:"startGame",condition:util.FUNCTION_FALSE_RETURNER,action:function(){}}),controller.registerCommand({key:"supply",unitAction:!0,_resupplyUnitAt:function(e,t){var o=model.unitPosMap[e][t],r=model.sheets.unitSheets[o.type];o.ammo=r.maxAmmo,o.fuel=r.maxFuel},condition:function(e){var t=e.getSourceUnit(),o=model.sheets.unitSheets[t.type];if(void 0===o.supply)return!1;var r=t.owner,n=e.getTargetX(),i=e.getTargetY(),l=model.thereIsAnOwnUnitAt;return l(n-1,i,r)||l(n+1,i,r)||l(n,i-1,r)||l(n,i+1,r)},action:function(e){var t=e.getSourceUnit(),o=t.owner,r=e.getTargetX(),n=e.getTargetY(),i=model.thereIsAnOwnUnitAt,l=this._resupplyUnitAt;i(r-1,n,o)&&l(r-1,n),i(r+1,n,o)&&l(r+1,n),i(r,n-1,o)&&l(r,n-1),i(r,n+1,o)&&l(r,n+1),controller.invokeCommand(e,"wait")}}),controller.registerCommand({key:"trapWait",condition:function(){return!1},action:function(e){var t=new controller.ActionData;t.setSource(e.getSourceX(),e.getSourceY()),t.setAction("wait"),t.setSourceUnit(e.getSourceUnit()),controller.invokeCommand(t)}}),controller.registerCommand({key:"supplyTurnStart",userAction:!1,condition:function(){return!1},action:function(e){controller.invokeCommand(e,"supply"),controller.invokeCommand(e,"makeActable")}}),controller.registerCommand({key:"unloadUnit",unitAction:!0,multiStepAction:!0,prepareMenu:function(e,t){for(var o=e.getSourceUnitId(),r=model.getLoadedIds(o),n=0,i=r.length;i>n;n++)t(r[n])},prepareTargets:function(e,t){var o=e.getSubAction(),r=e.getTargetX(),n=e.getTargetY(),i=model.units[o],l=model.sheets.unitSheets[i.type],a=model.sheets.movetypeSheets[l.moveType];r>0&&null===model.unitPosMap[r-1][n]&&-1!==model.moveCosts(a,model.map[r-1][n])&&t.setPositionValue(r-1,n,1),n>0&&null===model.unitPosMap[r][n-1]&&-1!==model.moveCosts(a,model.map[r][n-1])&&t.setPositionValue(r,n-1,1),model.mapHeight-1>n&&null===model.unitPosMap[r][n+1]&&-1!==model.moveCosts(a,model.map[r][n+1])&&t.setPositionValue(r,n+1,1),model.mapWidth-1>r&&null===model.unitPosMap[r+1][n]&&-1!==model.moveCosts(a,model.map[r+1][n])&&t.setPositionValue(r+1,n,1)},condition:function(e){if(e.getSourceUnit(),null!==e.getTargetUnit())return!1;var t=e.getSourceUnitId();return model.isTransport(t)&&model.hasLoadedIds(t)},action:function(e){var t=e.getSubAction(),o=e.getSourceUnitId(),r=e.getActionTargetX(),n=e.getActionTargetY(),i=e.getTargetX(),l=e.getTargetY();controller.invokeCommand(e,"wait"),model.unloadUnitFrom(t,o);var a;i>r?a=model.MOVE_CODE_LEFT:r>i?a=model.MOVE_CODE_RIGHT:l>n?a=model.MOVE_CODE_UP:n>l&&(a=model.MOVE_CODE_DOWN);var u=controller.aquireActionDataObject();u.setSourceUnit(model.units[t]),u.setMovePath([a]),u.setAction("wait"),u.setSource(i,l),controller.pushActionDataIntoBuffer(u,!0)}}),controller.registerCommand({key:"wait",unitAction:!0,condition:function(e){var t=e.getSourceUnit(),o=e.getTargetUnit();return null===o||o===t},action:function(e){model.markAsUnusable(e.getSourceUnitId())}});