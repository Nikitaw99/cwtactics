!function(){for(var e=0,t=["ms","moz","webkit","o"],o=0;o<t.length&&!window.requestAnimationFrame;++o)window.requestAnimationFrame=window[t[o]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[o]+"CancelAnimationFrame"]||window[t[o]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var o=(new Date).getTime(),n=Math.max(0,16-(o-e)),r=window.setTimeout(function(){t(o+n)},n);return e=o+n,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}();var Base64Helper={};Base64Helper.canvasToBase64=function(e){var t=document.createElement("canvas");t.width=e.width,t.height=e.height;var o=t.getContext("2d");o.drawImage(e,0,0);var n=t.toDataURL("image/png");return n.replace(/^data:image\/(png|jpg);base64,/,"")},function(e){var t=e;Base64Helper.encodeBuffer=function(e){for(var o,n,r,a,i,s="",l=new Uint8Array(e),c=l.byteLength,u=c%3,d=c-u,m=0;d>m;m+=3)i=l[m]<<16|l[m+1]<<8|l[m+2],o=(16515072&i)>>18,n=(258048&i)>>12,r=(4032&i)>>6,a=63&i,s+=t[o]+t[n]+t[r]+t[a];return 1==u?(i=l[d],o=(252&i)>>2,n=(3&i)<<4,s+=t[o]+t[n]+"=="):2==u&&(i=l[d]<<8|l[d+1],o=(64512&i)>>10,n=(1008&i)>>4,r=(15&i)<<2,s+=t[o]+t[n]+t[r]+"="),s},Base64Helper.decodeBuffer=function(t){var o,n,r,a,i,s=.75*t.length,l=t.length,c=0;"="===t[t.length-1]&&(s--,"="===t[t.length-2]&&s--);var u=new ArrayBuffer(s),d=new Uint8Array(u);for(o=0;l>o;o+=4)n=e.indexOf(t[o]),r=e.indexOf(t[o+1]),a=e.indexOf(t[o+2]),i=e.indexOf(t[o+3]),d[c++]=n<<2|r>>4,d[c++]=(15&r)<<4|a>>2,d[c++]=(3&a)<<6|63&i;return u}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/");var Lawnchair=function(e,t){if(!(this instanceof Lawnchair))return new Lawnchair(e,t);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(!(arguments.length<=2))throw"Incorrect # of ctor args!";t="function"==typeof arguments[0]?arguments[0]:arguments[1],e="function"==typeof arguments[0]?{}:arguments[0]||{},this.record=e.record||"record",this.name=e.name||"records";var o;if(e.adapter){"string"==typeof e.adapter&&(e.adapter=[e.adapter]);for(var n=0,r=e.adapter.length;r>n;n++){for(var a=Lawnchair.adapters.length-1;a>=0&&(Lawnchair.adapters[a].adapter!==e.adapter[n]||!(o=Lawnchair.adapters[a].valid()?Lawnchair.adapters[a]:void 0));a--);if(o)break}}else for(var a=0,i=Lawnchair.adapters.length;i>a&&!(o=Lawnchair.adapters[a].valid()?Lawnchair.adapters[a]:void 0);a++);if(!o)throw"No valid adapter.";for(var n in o)this[n]=o[n];for(var a=0,i=Lawnchair.plugins.length;i>a;a++)Lawnchair.plugins[a].call(this);this.init(e,t)};Lawnchair.adapters=[],Lawnchair.adapter=function(e,t){t.adapter=e;var o="adapter valid init keys save batch get exists all remove nuke".split(" "),n=this.prototype.indexOf;for(var r in t)if(-1===n(o,r))throw"Invalid adapter! Nonstandard method: "+r;Lawnchair.adapters.splice(0,0,t)},Lawnchair.plugins=[],Lawnchair.plugin=function(e){for(var t in e)"init"===t?Lawnchair.plugins.push(e[t]):this.prototype[t]=e[t]},Lawnchair.prototype={isArray:Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},indexOf:function(e,t,o,n){if(e.indexOf)return e.indexOf(t);for(o=0,n=e.length;n>o;o++)if(e[o]===t)return o;return-1},lambda:function(e){return this.fn(this.record,e)},fn:function(e,t){return"string"==typeof t?new Function(e,t):t},uuid:function(){var e=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},each:function(e){var t=this.lambda(e);if(this.__results)for(var o=0,n=this.__results.length;n>o;o++)t.call(this,this.__results[o],o);else this.all(function(e){for(var o=0,n=e.length;n>o;o++)t.call(this,e[o],o)});return this}},"undefined"!=typeof module&&module.exports&&(module.exports=Lawnchair),Lawnchair.adapter("indexed-db",function(){function e(e,t){console.error("error in indexed-db adapter!",e,t)}var t=3,o=function(){return window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB||window.oIndexedDB||window.msIndexedDB},n=function(){return window.IDBTransaction||window.webkitIDBTransaction||window.mozIDBTransaction||window.oIDBTransaction||window.msIDBTransaction},r=function(){return window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange||window.oIDBKeyRange||window.msIDBKeyRange},a=function(){return window.IDBDatabaseException||window.webkitIDBDatabaseException||window.mozIDBDatabaseException||window.oIDBDatabaseException||window.msIDBDatabaseException},i=function(){return!!window.indexedDB},s=n()&&"READ_WRITE"in n()?n().READ_WRITE:"readwrite";return{valid:function(){return!!o()},init:function(n,r){this.idb=o(),this.waiting=[],this.useAutoIncrement=i();var s=this.idb.open(this.name,t),l=this,c=l.fn(l.name,r);if(c&&"function"!=typeof c)throw"callback not valid";var u=function(){return s.onupgradeneeded=s.onsuccess=s.error=null,c?c.call(l,l):void 0},d=function(){try{l.db.deleteObjectStore("teststore")}catch(e){}try{l.db.deleteObjectStore(l.record)}catch(e){}var e={};l.useAutoIncrement&&(e.autoIncrement=!0),l.db.createObjectStore(l.record,e),l.store=!0};s.onupgradeneeded=function(e){l.db=s.result,l.transaction=s.transaction,d(e.oldVersion,e.newVersion)},s.onsuccess=function(o){if(l.db=o.target.result,l.db.version!=""+t){var n=l.db.version,r=l.db.setVersion(""+t);r.onsuccess=function(){var e=r.result;r.onsuccess=r.onerror=null,d(n,t),e.oncomplete=function(){for(var e=0;e<l.waiting.length;e++)l.waiting[e].call(l);l.waiting=[],u()}},r.onerror=function(t){r.onsuccess=r.onerror=null,console.error("Failed to create objectstore "+t),e(t)}}else{l.store=!0;for(var a=0;a<l.waiting.length;a++)l.waiting[a].call(l);l.waiting=[],u()}},s.onerror=function(){return a()&&s.errorCode===a().VERSION_ERR?(l.idb.deleteDatabase(l.name),l.init(n,r)):(console.error("Failed to open database"),void 0)}},save:function(t,o){var n=this;if(!this.store)return this.waiting.push(function(){this.save(t,o)}),void 0;for(var r=(this.isArray(t)?t:[t]).map(function(e){return e.key||(e.key=n.uuid()),e}),a=function(){o&&n.lambda(o).call(n,n.isArray(t)?r:r[0])},i=this.db.transaction(this.record,s),l=i.objectStore(this.record),c=0;c<r.length;c++){var u=r[c];l.put(u,u.key)}return l.transaction.oncomplete=a,l.transaction.onabort=e,this},batch:function(e,t){return this.save(e,t)},get:function(t,o){if(!this.store)return this.waiting.push(function(){this.get(t,o)}),void 0;var n=this,r=function(e){var r=e.target.result;o&&(r&&(r.key=t),n.lambda(o).call(n,r))};if(this.isArray(t))for(var a=[],i=t.length,s=t,l=function(e){n.get(s[e],function(t){a[e]=t,--i>0||o&&n.lambda(o).call(n,a)})},c=0,u=s.length;u>c;c++)l(c);else{var d=this.db.transaction(this.record).objectStore(this.record).get(t);d.onsuccess=function(e){d.onsuccess=d.onerror=null,r(e)},d.onerror=function(t){d.onsuccess=d.onerror=null,e(t)}}return this},exists:function(t,o){if(!this.store)return this.waiting.push(function(){this.exists(t,o)}),void 0;var n=this,a=this.db.transaction(n.record).objectStore(this.record).openCursor(r().only(t));return a.onsuccess=function(e){a.onsuccess=a.onerror=null;var t;n.lambda(o).call(n,null!==e.target.result&&e.target.result!==t)},a.onerror=function(t){a.onsuccess=a.onerror=null,e(t)},this},all:function(e){if(!this.store)return this.waiting.push(function(){this.all(e)}),void 0;var t=this.fn(this.name,e)||void 0,o=this,n=this.db.transaction(this.record).objectStore(this.record),r=[];return n.openCursor().onsuccess=function(e){var n=e.target.result;n?(r.push(n.value),n.continue()):t&&t.call(o,r)},this},keys:function(e){if(!this.store)return this.waiting.push(function(){this.keys(e)}),void 0;var t=this.fn(this.name,e)||void 0,o=this,n=this.db.transaction(this.record).objectStore(this.record),r=[];return n.openCursor().onsuccess=function(e){var n=e.target.result;n?(r.push(n.key),n.continue()):t&&t.call(o,r)},this},remove:function(t,o){if(!this.store)return this.waiting.push(function(){this.remove(t,o)}),void 0;var n=this,r=t;this.isArray(t)||(r=[t]);for(var a=function(){o&&n.lambda(o).call(n)},i=this.db.transaction(this.record,s).objectStore(this.record),l=t.key?t.key:t,c=0;c<r.length;c++){var l=r[c].key?r[c].key:r[c];i.delete(l)}return i.transaction.oncomplete=a,i.transaction.onabort=e,this},nuke:function(t){if(!this.store)return this.waiting.push(function(){this.nuke(t)}),void 0;var o=this,n=t?function(){o.lambda(t).call(o)}:function(){};try{var r=this.db.transaction(this.record,s).objectStore(this.record);r.clear(),r.transaction.oncomplete=n,r.transaction.onabort=e}catch(t){"NotFoundError"==t.name?n():e(t)}return this}}}()),Lawnchair.adapter("webkit-sqlite",function(){var e=function(e,t){console.error("error in sqlite adaptor!",e,t)},t=function(){return new Date};return Function.prototype.bind||(Function.prototype.bind=function(e){var t=[].slice,o=t.call(arguments,1),n=this,r=function(){},a=function(){return n.apply(this instanceof r?this:e||{},o.concat(t.call(arguments)))};return r.prototype=n.prototype,a.prototype=new r,a}),{valid:function(){return!!window.openDatabase},init:function(t,o){var n=this,r=n.fn(n.name,o),a="CREATE TABLE IF NOT EXISTS "+this.record+" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)",i=function(){return r?r.call(n,n):void 0};if(r&&"function"!=typeof r)throw"callback not valid";this.db=openDatabase(this.name,"1.0.0",this.name,t.maxSize||65536),this.db.transaction(function(e){e.executeSql(a,[])},e,i)},keys:function(t){var o=this.lambda(t),n=this,r="SELECT id FROM "+this.record+" ORDER BY timestamp DESC";return this.db.readTransaction(function(t){var a=function(e,t){if(0==t.rows.length)o.call(n,[]);else{for(var r=[],a=0,i=t.rows.length;i>a;a++)r.push(t.rows.item(a).id);o.call(n,r)}};t.executeSql(r,[],a,e)}),this},save:function(o,n,r){var a=this,i=(this.isArray(o)?o:[o]).map(function(e){return e.key||(e.key=a.uuid()),e}),s="INSERT OR REPLACE INTO "+this.record+" (value, timestamp, id) VALUES (?,?,?)",l=function(){n&&a.lambda(n).call(a,a.isArray(o)?i:i[0])},r=r||null,c=[],u=t();try{for(var d=0,m=i.length;m>d;d++)c[d]=[JSON.stringify(i[d]),u,i[d].key]}catch(t){throw r?r(t):e(t),t}return a.db.transaction(function(e){for(var t=0,o=i.length;o>t;t++)e.executeSql(s,c[t])},r?r:e,l),this},batch:function(e,t){return this.save(e,t)},get:function(t,o){var n=this,r="",a=this.isArray(t)?t:[t];r="SELECT id, value FROM "+this.record+" WHERE id IN ("+a.map(function(){return"?"}).join(",")+")";var i=function(e,r){for(var i,s,l={},c=0,u=r.rows.length;u>c;c++)i=JSON.parse(r.rows.item(c).value),i.key=r.rows.item(c).id,l[i.key]=i;s=a.map(function(e){return l[e]}),n.isArray(t)||(s=s.length?s[0]:null),o&&n.lambda(o).call(n,s)};return this.db.readTransaction(function(t){t.executeSql(r,a,i,e)}),this},exists:function(t,o){var n="SELECT * FROM "+this.record+" WHERE id = ?",r=this,a=function(e,t){o&&r.fn("exists",o).call(r,t.rows.length>0)};return this.db.readTransaction(function(o){o.executeSql(n,[t],a,e)}),this},all:function(t){var o=this,n="SELECT * FROM "+this.record,r=[],a=this.fn(this.name,t)||void 0,i=function(e,t){if(0!=t.rows.length)for(var n=0,i=t.rows.length;i>n;n++){var s=JSON.parse(t.rows.item(n).value);s.key=t.rows.item(n).id,r.push(s)}a&&a.call(o,r)};return this.db.readTransaction(function(t){t.executeSql(n,[],i,e)}),this},remove:function(t,o){var n,r=this,a="DELETE FROM "+this.record+" WHERE id ",i=function(){o&&r.lambda(o).call(r)};return this.isArray(t)?(n=t,a+="IN ("+n.map(function(){return"?"}).join(",")+")"):(a+="= ?",n=[t]),n=n.map(function(e){return e.key?e.key:e}),this.db.transaction(function(t){t.executeSql(a,n,i,e)}),this},nuke:function(t){var o="DELETE FROM "+this.record,n=this,r=t?function(){n.lambda(t).call(n)}:function(){};return this.db.transaction(function(t){t.executeSql(o,[],r,e)}),this}}}()),window.getQueryParams=function(e){e=e.split("+").join(" ");for(var t,o={},n=/[?&]?([^=]+)=([^&]*)/g;t=n.exec(e);)o[decodeURIComponent(t[1])]=decodeURIComponent(t[2]);return o};var jWorkflow=function(){function e(e){if("function"!=typeof e)throw"expected function but was "+typeof e}function t(e){return"function"==typeof e.andThen&&"function"==typeof e.start&&"function"==typeof e.chill}function o(e){return!!e.map&&!!e.reduce}var n={order:function(n,r){var a,i=[],s=null,l=function(){var e=!1;return{take:function(){e=!0},pass:function(t){var o;e=!1,a.length?(o=a.shift(),t=o.func.apply(o.context,[t,l]),e||l.pass(t)):s.func&&s.func.apply(s.context,[t])},drop:function(t){e=!0,a=[],setTimeout(function(){l.pass(t)},1)}}}(),c={andThen:function(n,r){if(t(n)){var a=function(e,t){t.take(),n.start({callback:function(e){t.pass(e)},context:r,initialValue:e})};i.push({func:a,context:r})}else if(o(n)){var s=function(e,t){t.take();var o=n.length,r=function(){return--o||t.pass()};n.forEach(function(e){jWorkflow.order(e).start(r)})};i.push({func:s,context:r})}else e(n),i.push({func:n,context:r});return c},chill:function(e){return c.andThen(function(t,o){o.take(),setTimeout(function(){o.pass(t)},e)})},start:function(){var e,t,o;arguments[0]&&"object"==typeof arguments[0]?(e=arguments[0].callback,t=arguments[0].context,o=arguments[0].initialValue):(e=arguments[0],t=arguments[1]),s={func:e,context:t},a=i.slice(),l.pass(o)}};return n?c.andThen(n,r):c}};return n}();"object"==typeof module&&"function"==typeof require&&(module.exports=jWorkflow),util.scoped(function(){"use strict";var e=window.navigator.userAgent.toLowerCase(),t=/mobile|android|kindle|silk|midp|(windows nt 6\.2.+arm|touch)/.test(e);e=/(chrome|firefox)[ \/]([\w.]+)/.exec(e)||/(iphone|ipad|ipod)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(android)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(webkit|opera)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||[];var o=e[1],n=parseFloat(e[2]);switch(o){case"msie":o="ie",n=doc.documentMode||n;break;case"firefox":o="ff";break;case"ipod":case"ipad":case"iphone":o="ios";break;case"webkit":o="safari"}window.Browser={name:o,mobile:t,version:n},Browser[o]=!0});var view=window.view={};window.onerror=function(e){controller.showErrorPanel("Critical Game Fault",e.stack)},util.singleLazyCall=function(e){var t=!1;return function(){t&&assert(!1,"this function cannot be called twice"),e.apply(null,arguments)}},util.iterateListByFlow=function(e,t,o){for(var n={i:0,list:t},r=0,a=t.length;a>r;r++)e.andThen(function(e,t){o.call(this,e,t),this.i++},n);e.andThen(function(){assert(t===this.list),assert(this.i===this.list.length)},n)},util.scoped(function(){function e(){if(4==this.readyState)if(4==this.readyState&&200==this.status)if(util.log("grabbed file successfully"),this.asJSON){var e;try{e=JSON.parse(this.responseText)}catch(e){this.failCallback(e)}this.winCallback(e)}else this.winCallback(this.responseText);else util.log("could not grab file"),this.failCallback(this.statusText)}var t;try{new XMLHttpRequest,t=!0}catch(e){t=!1}util.grabRemoteFile=function(o){var n;util.log("try to grab file",o.path),n=t?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n.asJSON=o.json,n.winCallback=o.success,n.failCallback=o.error,n.onreadystatechange=e,n.open("get",o.path+"?_cwtR="+parseInt(1e4*Math.random(),10),!0),n.send()}}),util.scoped(function(){var e=controller.stateMachine.data.selection,t=[0,3,0,250,0,0,3,0,250,0,0,7,0,150,0,0,20,0,300,0,0,4,0,400,0,0,4,0,500,0,0,8,0,500,0],o=1;view.getSpriteStep=function(e){switch(e){case"UNIT":return t[0];case"UNIT_SIMPLE":return t[5];case"SELECTION":return t[10];case"STATUS":return t[15];case"PROPERTY":return t[20];case"ANIM_TILES":return t[25];case"ANIM_TILES_EXT":return t[30]}return 0},view.updateSpriteAnimations=function(n){for(var r=!1,a=0,i=t.length;i>a;a+=5)if(t[a+2]+=n,t[a+2]>=t[a+3]){if(t[a+2]=0,0===a?(t[a]+=o,-1===o?-1===t[a]&&(t[a]=1,o=1):t[a]===t[a+1]&&(t[a]=t[a+1]-2,o=-1)):(t[a]+=1,t[a]===t[a+1]&&(t[a]=0)),r=!0,t[a+4]=1,r){var s=0,l=0,c=model.map_width,u=model.map_height;if(1===t[4]||1===t[9]||1===t[24]||1===t[29])for(;c>s;s++)for(var d=l;u>d;d++)(1===t[4]||1===t[9])&&null!==model.unit_posData[s][d]&&view.redraw_markPosWithNeighboursRing(s,d),1===t[24]&&null!==model.property_posMap[s][d]&&view.redraw_markPosWithNeighboursRing(s,d),(1===t[29]||1===t[34])&&view.animatedTiles[model.map_data[s][d].ID]&&view.redraw_markPos(s,d);var m="MOVEPATH_SELECTION"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state||controller.attackRangeVisible;m&&1===t[14]&&e.rerenderNonInactive()}t[4]=0,t[9]=0,t[14]=0,t[19]=0,t[24]=0,t[29]=0,t[34]=0}}}),controller.audio_SFX_STORAGE_PARAMETER="volume_sfx",controller.audio_MUSIC_STORAGE_PARAMETER="music_sfx",controller.audio_ctx_=!1,controller.audio_gainNode_music_=null,controller.audio_gainNode_sfx_=null,controller.audio_initialize=function(){if(util.log("initializing audio context"),!controller.features_client.audioSFX&&!controller.features_client.audioMusic)return controller.audio_ctx_=null,null;try{if(window.AudioContext)controller.audio_ctx_=new window.AudioContext;else{if(!window.webkitAudioContext)throw Error("no AudioContext constructor found");controller.audio_ctx_=new window.webkitAudioContext}controller.audio_gainNode_sfx_=controller.audio_ctx_.createGainNode(),controller.audio_gainNode_sfx_.gain.value=1,controller.audio_gainNode_sfx_.connect(controller.audio_ctx_.destination),controller.audio_gainNode_music_=controller.audio_ctx_.createGainNode(),controller.audio_gainNode_music_.gain.value=.5,controller.audio_gainNode_music_.connect(controller.audio_ctx_.destination),controller.storage_general.get(controller.audio_SFX_STORAGE_PARAMETER,function(e){e&&(controller.audio_gainNode_sfx_.gain.value=e.value)}),controller.storage_general.get(controller.audio_MUSIC_STORAGE_PARAMETER,function(e){e&&(controller.audio_gainNode_music_.gain.value=e.value)})}catch(e){}},controller.audio_grabContext=function(){return controller.audio_ctx_},controller.audio_buffer_={},controller.audio_currentMusic_=null,controller.audio_currentMusicId_=null,controller.audio_registerAudioBuffer=function(e,t){controller.audio_buffer_[e]=t},controller.audio_loadByArrayBuffer=function(e,t,o){assert(util.isString(e)),controller.audio_grabContext().decodeAudioData(t,function(t){controller.audio_registerAudioBuffer(e,t),o&&o(!0,e)},function(){o&&o(!1,e)})},controller.audio_unloadBuffer=function(e){assert(util.isString(e)),delete controller.audio_buffer_[e]},controller.audio_isBuffered=function(e){return controller.audio_buffer_.hasOwnProperty(e)},controller.audio_getSfxVolume=function(){return controller.audio_ctx_?controller.audio_gainNode_sfx_.gain.value:void 0},controller.audio_getMusicVolume=function(){return controller.audio_ctx_?controller.audio_gainNode_music_.gain.value:void 0},controller.audio_setSfxVolume=function(e){controller.audio_ctx_&&(0>e?e=0:e>1&&(e=1),controller.audio_gainNode_sfx_.gain.value=e)},controller.audio_setMusicVolume=function(e){controller.audio_ctx_&&(0>e?e=0:e>1&&(e=1),controller.audio_gainNode_music_.gain.value=e)},controller.audio_saveConfigs=function(){controller.audio_gainNode_sfx_&&controller.storage_general.set(controller.audio_SFX_STORAGE_PARAMETER,controller.audio_gainNode_sfx_.gain.value),controller.audio_gainNode_music_&&controller.storage_general.set(controller.audio_MUSIC_STORAGE_PARAMETER,controller.audio_gainNode_music_.gain.value)},controller.audio_playSound=function(e,t,o){if(controller.audio_ctx_&&controller.audio_buffer_[e]){var n=o?controller.audio_gainNode_music_:controller.audio_gainNode_sfx_,r=controller.audio_ctx_.createBufferSource();return t&&(r.loop=!0),r.buffer=controller.audio_buffer_[e],r.connect(n),r.noteOn(0),r}},controller.audio_playNullSound=function(){if(controller.audio_ctx_){var e=controller.audio_ctx_,t=e.createBuffer(1,1,22050),o=e.createBufferSource();o.buffer=t,o.connect(e.destination),o.noteOn(0)}},controller.audio_playMusic=function(e){controller.audio_ctx_&&controller.audio_currentMusicId_!==e&&controller.audio_buffer_[e]&&(controller.audio_stopMusic(),controller.audio_currentMusic_=controller.audio_playSound(e,!0,!0),controller.audio_currentMusicId_=e)},controller.audio_stopMusic=function(){controller.audio_currentMusic_&&(controller.audio_currentMusic_.noteOff(0),controller.audio_currentMusic_.disconnect(0)),controller.audio_currentMusic_=null,controller.audio_currentMusicId_=null},controller.background_cssEl_=null,controller.background_registerAsBackground=function(e){assert(util.isString(e)&&e.length>0),controller.background_cssEl_||(controller.background_cssEl_=document.createElement("style"),document.getElementsByTagName("head")[0].appendChild(controller.background_cssEl_)),controller.background_cssEl_.innerHTML=".cwt_page {background-image: url(data:image/jpeg;base64,"+e+");background-repeat: no-repeat;background-position: 0px 45px;background-size: 100% calc(100% - 44px);}"},controller.BUTTON_GROUP_DEFAULT_STYLE="cwt_panel_header_big cwt_page_button cwt_panel_button",controller.BUTTON_GROUP_DEFAULT_STYLE_ACT="cwt_panel_header_big cwt_page_button cwt_panel_button active",controller.BUTTON_GROUP_DEFAULT_STYLE_INACT="cwt_panel_header_big cwt_page_button cwt_panel_button inactive",controller.ButtonGroup={changeIndex:function(e,t){void 0===t&&(t=!0),-1!==this.index&&(this.elements[this.index].className=this.cls),t?(this.index+=e,e>0?this.index>=this.elements.length&&(this.index=0):this.index<0&&(this.index=this.elements.length-1)):this.index=0>e||e>=this.elements.length?0:e,vl=this.elements[this.index].attributes.inactive&&"true"===this.elements[this.index].attributes.inactive.value?this.cls_inact:this.cls_act,this.elements[this.index].className=vl},increaseIndex:function(e){void 0===e&&(e=1),this.changeIndex(e,!0)},decreaseIndex:function(e){e=void 0===e?-1:-e,this.changeIndex(e,!0)},setIndex:function(e){this.changeIndex(e,!1)},isIndexInactive:function(){return this.elements[this.index].attributes.inactive&&"true"===this.elements[this.index].attributes.inactive.value},getActiveKey:function(){return this.elements[this.index].attributes.key.value},getActiveData:function(){return this.elements[this.index].attributes.data.value},getActiveElement:function(){return this.elements[this.index]}},controller.registerButtonGroupHover=function(e,t,o){t.onmouseover=function(){e.setIndex(o,!1)},t.onclick=function(){controller.screenStateMachine.event("INP_ACTION")}},controller.generateButtonGroup=function(e,t,o,n){for(var r=e.getElementsByTagName("button"),a=[],i=0,s=r.length;s>i;i++)r[i].attributes.ignore&&"true"===r[i].attributes.ignore.value||a.push(r[i]);var l=Object.create(controller.ButtonGroup);l.index=0,l.elements=a,1===arguments.length&&(t=controller.BUTTON_GROUP_DEFAULT_STYLE,o=controller.BUTTON_GROUP_DEFAULT_STYLE_ACT,n=controller.BUTTON_GROUP_DEFAULT_STYLE_INACT),l.cls=t,l.cls_act=o,l.cls_inact=n;for(var i=0,s=a.length;s>i;i++)a[i].className=l.cls,controller.registerButtonGroupHover(l,a[i],i);return l.setIndex(0),l},controller.coMusic_playLoadedMusic_=function(e,t){controller.audio_playMusic(t),view.hasInfoMessage()&&view.message_closePanel(1e3)},controller.coMusic_storeAudio_=function(e){var t=Base64Helper.decodeBuffer(e.value);controller.audio_loadByArrayBuffer(e.key,t,controller.coMusic_playLoadedMusic_)},controller.coMusic_loadAudio_=function(e){controller.storage_assets.get(e,controller.coMusic_storeAudio_)},controller.coMusic_playCoMusic=function(e){return e?(controller.audio_isBuffered(e)?controller.coMusic_playLoadedMusic_(!1,e):controller.coMusic_loadAudio_(e),void 0):(view.hasInfoMessage()&&view.message_closePanel(1e3),void 0)},controller.mapCursorX=0,controller.mapCursorY=0,controller.resetMapCursor=function(){controller.mapCursorX=0,controller.mapCursorY=0},controller.cursorAction=function(e){if(!controller.inAnimationHookPhase()){var t=controller.stateMachine.state,o="MOVEPATH_SELECTION"===t||"IDLE_R"===t||"ACTION_SELECT_TARGET_A"===t||"ACTION_SELECT_TARGET_B"===t;e?controller.stateMachine.event("cancel",controller.mapCursorX,controller.mapCursorY):controller.menuVisible?controller.stateMachine.event("action",controller.menu_getSelectedIndex()):controller.stateMachine.event("action",controller.mapCursorX,controller.mapCursorY);var n=controller.stateMachine.state,r="MOVEPATH_SELECTION"===n||"IDLE_R"===n||"ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n;if((o&&!r||r)&&view.redraw_markSelection(controller.stateMachine.data),"ACTION_MENU"===n||"ACTION_SUBMENU"===n){var a=controller.stateMachine.data.menu;controller.showMenu(a,controller.mapCursorX,controller.mapCursorY)}else("ACTION_MENU"===t||"ACTION_SUBMENU"===t)&&controller.hideMenu()}},controller.cursorActionCancel=function(){controller.cursorAction(!0),controller.audio_playSound(model.data_sounds.CANCEL)},controller.cursorActionClick=function(){controller.cursorAction(!1),controller.audio_playSound(model.data_sounds.MENUTICK)},controller.moveCursor=function(e,t){1===arguments.length&&(t=1);var o=controller.mapCursorX,n=controller.mapCursorY;switch(e){case model.move_MOVE_CODES.UP:n-=t;break;case model.move_MOVE_CODES.RIGHT:o+=t;break;case model.move_MOVE_CODES.DOWN:n+=t;break;case model.move_MOVE_CODES.LEFT:o-=t}controller.setCursorPosition(o,n)},controller.setCursorPosition=function(e,t,o,n){if(!controller.isMenuOpen()&&(o&&(e+=controller.screenX,t+=controller.screenY),0>e&&(e=0),0>t&&(t=0),e>=model.map_width&&(e=model.map_width-1),t>=model.map_height&&(t=model.map_height-1),e!==controller.mapCursorX||t!==controller.mapCursorY)){view.redraw_markPos(controller.mapCursorX,controller.mapCursorY),controller.mapCursorY<model.map_height-1&&view.redraw_markPos(controller.mapCursorX,controller.mapCursorY+1);var r=-1,a=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===a){var i=controller.stateMachine.data;if(i.selection.getValueAt(e,t)>0){var s=model.unit_posData[e][t];s&&(r=model.battle_getBattleDamageAgainst(i.source.unit,s,0,model.battle_canUseMainWeapon(i.source.unit,s),!1,i.source.x,i.source.y))}}n!==!0&&controller.audio_playSound(model.data_sounds.MAPTICK),view.redraw_markPos(controller.mapCursorX,controller.mapCursorY),controller.mapCursorX=e,controller.mapCursorY=t,controller.updateSimpleTileInformation(r);var l=controller.screenScale;0===l?l=.8:-1===l&&(l=.7);var c=parseInt(parseInt((window.innerWidth-80)/16,10)/l,10),u=parseInt(parseInt((window.innerHeight-80)/16,10)/l,10);controller.sideSimpleTileInformationPanel<0&&e-controller.screenX<.25*c&&controller.moveSimpleTileInformationToRight(),controller.sideSimpleTileInformationPanel>0&&e-controller.screenX>=.75*c&&controller.moveSimpleTileInformationToLeft();var d=-1;e-controller.screenX<=1?d=model.move_MOVE_CODES.LEFT:e-controller.screenX>=c-1?d=model.move_MOVE_CODES.RIGHT:t-controller.screenY<=1?d=model.move_MOVE_CODES.UP:t-controller.screenY>=u-1&&(d=model.move_MOVE_CODES.DOWN),-1!==d&&controller.shiftScreenPosition(d,5),view.redraw_markPos(e,t)}},util.scoped(function(){var e=document.getElementById("cwt_errorPanel"),t=document.getElementById("cwt_errorPanel_reason"),o=document.getElementById("cwt_errorPanel_data");controller.errorButtons=controller.generateButtonGroup(e,"cwt_panel_header_small cwt_page_button cwt_panel_button","cwt_panel_header_small cwt_page_button cwt_panel_button button_active","cwt_panel_header_small cwt_page_button cwt_panel_button button_inactive"),controller.errorPanelVisible=!1,controller.showErrorPanel=function(n,r){o.innerHTML=n,t.innerHTML=r,e.style.display="block",controller.errorPanelVisible=!0},controller.hideErrorPanel=function(){e.style.display="none",controller.errorPanelVisible=!1}}),controller.features_client={audioSFX:!1,audioMusic:!1,gamePad:!1,keyboard:!1,mouse:!1,touch:!1,supported:!1,scaledImg:!1,iosWebSQLFix:!1},controller.features_analyseClient=function(){Browser.mobile?(Browser.ios?(Browser.version>=5&&(controller.features_client.supported=!0),Browser.version>=6&&(controller.features_client.audioSFX=!0),controller.features_client.iosWebSQLFix=!0):Browser.android&&(controller.features_client.supported=!0),controller.features_client.touch=!0):(controller.stateMachine.data.fastClickMode=!0,(Browser.chrome||Browser.safari)&&(controller.features_client.supported=!0,controller.features_client.audioSFX=!0,controller.features_client.audioMusic=!0),Browser.chrome&&(controller.features_client.gamePad=!0),controller.features_client.mouse=!0,controller.features_client.keyboard=!0)},util.scoped(function(){function e(){if(view.hooksBuffer.isEmpty())o=!1;else{o=!0;var e=view.hooksBuffer.pop(),n=e[e.length-1];t=view.animationHooks[n],t.prepare.apply(t,e)}}var t=null,o=!1,n=0;controller.prepareGameLoop=function(){n=0},controller.gameLoop=function(r,a,i){n+=r;var s=0!==controller.moveScreenX||0!==controller.moveScreenY;if(s?controller.solveMapShift():(view.hasInfoMessage()?view.updateMessagePanelTime(r):a&&(o?(t.update(r),t.isDone()&&e()):i||(controller.update_tickFrame(n),n=0,e())),view.updateSpriteAnimations(r)),!a)if(view.redraw_dataChanges>0&&view.renderMap(controller.screenScale),o)t.render();else if("ACTION_SELECT_TILE"===controller.stateMachine.state){var l,c,u=view.selectionRange,d=controller.mapCursorX,m=controller.mapCursorY,_=m-u,p=m+u;for(0>_&&(_=0),p>=model.map_height&&(p=model.map_height-1);p>=_;_++){var f=Math.abs(_-m);for(l=d-u+f,c=d+u-f,0>l&&(l=0),c>=model.map_width&&(c=model.map_width-1);c>=l;l++)view.redraw_markPos(l,_)}}},controller.inGameLoop=!1,controller.inAnimationHookPhase=function(){return o}}),view.hooksBuffer=util.createRingBuffer(50),view.animationHooks={},view.registerAnimationHook=function(e){var t=e.key;view.animationHooks.hasOwnProperty(t)&&assert(!1,"animation algorithm for",t,"is already registered"),view.animationHooks[t]=e,model.event_on(t,function(){for(var e=[],o=0,n=arguments.length;n>o;o++)e[o]=arguments[o];e[e.length]=t,view.hooksBuffer.push(e)}),e.isEnabled=!0},view.IMAGE_CODE_IDLE="IDLE",view.IMAGE_CODE_IDLE_INVERTED="IDLE_R",view.IMAGE_CODE_RIGHT="RIGHT",view.IMAGE_CODE_LEFT="LEFT",view.IMAGE_CODE_UP="UP",view.IMAGE_CODE_DOWN="DOWN",view.IMAGE_CODE_STATELESS="STATELESS",view.COLOR_RED="RED",view.COLOR_GREEN="GREEN",view.COLOR_BLUE="BLUE",view.COLOR_YELLOW="YELLOW",view.COLOR_BLACK_MASK="BLACK_MASK",view.COLOR_NEUTRAL="GRAY",view.COLOR_NONE="NONE",view.IMG_COLOR_MAP_PROPERTIES_ID="IMG_MAP_PROPERTY",view.IMG_COLOR_MAP_UNITS_ID="IMG_MAP_UNIT",view.CodeStatelessview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{},NONE:{},GRAY:{}},view.overlayImages={},view.animatedTiles={},view.CodeIdleview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeIdleInvertedview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeRightview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeLeftview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeUpview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeDownview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.setImageForType=function(e,t,o,n){switch(void 0===o&&(o=view.IMAGE_CODE_STATELESS),void 0===n&&(n=view.COLOR_NONE),o){case view.IMAGE_CODE_IDLE:view.CodeIdleview[n][t]=e;break;case view.IMAGE_CODE_STATELESS:view.CodeStatelessview[n][t]=e;break;case view.IMAGE_CODE_IDLE_INVERTED:view.CodeIdleInvertedview[n][t]=e;break;case view.IMAGE_CODE_LEFT:view.CodeLeftview[n][t]=e;break;case view.IMAGE_CODE_RIGHT:view.CodeRightview[n][t]=e;break;case view.IMAGE_CODE_DOWN:view.CodeDownview[n][t]=e;break;case view.IMAGE_CODE_UP:view.CodeUpview[n][t]=e;break;default:assert(!1,"unknown image state code ",o)}},view.setUnitImageForType=view.setImageForType,view.setPropertyImageForType=function(e,t,o){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,o)},view.setTileImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.setTileShadowImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_BLACK_MASK)},view.setInfoImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getImageForType=function(e,t,o){switch(t){case view.IMAGE_CODE_IDLE:return view.CodeIdleview[o][e];case view.IMAGE_CODE_IDLE_INVERTED:return view.CodeIdleInvertedview[o][e];
case view.IMAGE_CODE_LEFT:return view.CodeLeftview[o][e];case view.IMAGE_CODE_RIGHT:return view.CodeRightview[o][e];case view.IMAGE_CODE_DOWN:return view.CodeDownview[o][e];case view.IMAGE_CODE_UP:return view.CodeUpview[o][e];case view.IMAGE_CODE_STATELESS:return view.CodeStatelessview[o][e];default:assert(!1,"unknown image state code ",t)}},view.getUnitImageForType=view.getImageForType,view.getPropertyImageForType=function(e,t){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,t)},view.getTileImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getTileShadowImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_BLACK_MASK)},view.getInfoImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},controller.imagePersistence_save=function(){},view.imageProcessor_UNIT_INDEXES={BLACK_MASK:8,RED:0,BLUE:3,GREEN:4,YELLOW:5,colors:6},view.imageProcessor_PROPERTY_INDEXES={RED:0,GRAY:1,BLUE:3,GREEN:4,YELLOW:5,BLACK_MASK:8,colors:4},view.imageProcessor_getPropertyColorData=util.scoped(function(){var e=null;return function(){return e||(e=view.imageProcessor_getImageDataArray(view.getInfoImageForType(view.IMG_COLOR_MAP_PROPERTIES_ID))),e}}),view.imageProcessor_getUnitColorData=util.scoped(function(){var e=null;return function(){return e||(e=view.imageProcessor_getImageDataArray(view.getInfoImageForType(view.IMG_COLOR_MAP_UNITS_ID))),e}}),view.imageProcessor_getImageDataArray=function(e){var t=document.createElement("canvas"),o=t.getContext("2d"),n=e.width,r=e.height;return t.width=n,t.height=r,o.drawImage(e,0,0),o.getImageData(0,0,n,r).data},view.imageProcessor_flipImage=function(e,t,o){var n=t?-1:1,r=o?-1:1,a=t?-1*e.width:0,i=o?-1*e.height:0,s=document.createElement("canvas");s.height=e.height,s.width=e.width;var l=s.getContext("2d");return l.save(),l.scale(n,r),l.drawImage(e,a,i,e.width,e.height),l.restore(),s},view.imageProcessor_convertToBlackMask=function(e){var t=document.createElement("canvas"),o=t.getContext("2d"),n=e.width,r=e.height;t.width=n,t.height=r,o.drawImage(e,0,0);for(var a=o.getImageData(0,0,n,r),i=0;i<a.height;i++)for(var s=0;s<a.width;s++){var l=4*i*a.width+4*s,c=a.data[l+3];c>0&&(a.data[l]=0,a.data[l+1]=0,a.data[l+2]=0)}return o.putImageData(a,0,0),t},view.imageProcessor_replaceColors=function(e,t,o,n,r){var a=document.createElement("canvas"),i=a.getContext("2d"),s=e.width,l=e.height;a.width=s,a.height=l,i.drawImage(e,0,0);for(var c=i.getImageData(0,0,s,l),u=4*n*o,d=4*r*o,m=0;m<c.height;m++)for(var _=0;_<c.width;_++)for(var p=4*m*c.width+4*_,f=c.data[p],h=c.data[p+1],g=c.data[p+2],v=0,E=4*o;E>v;v+=4){var w=t[u+v],I=t[u+v+1],T=t[u+v+2];if(w===f&&I===h&&T===g){var M=d+v,y=t[M],A=t[M+1],S=t[M+2];c.data[p]=y,c.data[p+1]=A,c.data[p+2]=S}}return i.putImageData(c,0,0),a},view.imageProcessor_colorizeUnit=util.scoped(function(){var e=[view.IMAGE_CODE_IDLE,view.IMAGE_CODE_IDLE_INVERTED,view.IMAGE_CODE_DOWN,view.IMAGE_CODE_UP,view.IMAGE_CODE_RIGHT,view.IMAGE_CODE_LEFT];return function(t){for(var o=0,n=e.length;n>o;o++){var r=e[o],a=view.getUnitImageForType(t,r,view.COLOR_RED),i=view.imageProcessor_getUnitColorData(),s=view.imageProcessor_UNIT_INDEXES;view.setUnitImageForType(view.imageProcessor_replaceColors(a,i,s.colors,s.RED,s.BLUE),t,r,view.COLOR_BLUE),view.setUnitImageForType(view.imageProcessor_replaceColors(a,i,s.colors,s.RED,s.GREEN),t,r,view.COLOR_GREEN),view.setUnitImageForType(view.imageProcessor_replaceColors(a,i,s.colors,s.RED,s.YELLOW),t,r,view.COLOR_YELLOW),view.setUnitImageForType(view.imageProcessor_convertToBlackMask(a),t,r,view.COLOR_BLACK_MASK)}}}),view.imageProcessor_colorizeProperty=function(e){var t=view.getPropertyImageForType(e,view.COLOR_RED),o=view.imageProcessor_getPropertyColorData(),n=view.imageProcessor_PROPERTY_INDEXES;view.setPropertyImageForType(view.imageProcessor_replaceColors(t,o,n.colors,n.RED,n.BLUE),e,view.COLOR_BLUE),view.setPropertyImageForType(view.imageProcessor_replaceColors(t,o,n.colors,n.RED,n.GREEN),e,view.COLOR_GREEN),view.setPropertyImageForType(view.imageProcessor_replaceColors(t,o,n.colors,n.RED,n.YELLOW),e,view.COLOR_YELLOW),view.setPropertyImageForType(view.imageProcessor_replaceColors(t,o,n.colors,n.RED,n.GRAY),e,view.COLOR_NEUTRAL),view.setPropertyImageForType(view.imageProcessor_convertToBlackMask(t),e,view.COLOR_BLACK_MASK)},view.imageProcessor_colorizeTile=function(e){view.setTileShadowImageForType(view.imageProcessor_convertToBlackMask(view.getTileImageForType(e)),e)},view.imageProcessor_cropMiscSprite=function(e){if(e.length>2){var t=view.getInfoImageForType(e[0]),o=document.createElement("canvas"),n=o.getContext("2d");e.length>6?e[6]===!0?(o.height=32,o.width=96,o=view.imageProcessor_flipImage(o,!0,!1),n=o.getContext("2d")):e[6]===!1?(o.height=32,o.width=96,o=view.imageProcessor_flipImage(o,!1,!0),n=o.getContext("2d")):e.length>7&&3===e[7]?(o.height=24,o.width=24,n.save(),n.translate(8,8),n.rotate(e[6]*Math.PI/180),n.translate(-8,-8)):(o.height=16,o.width=16,n.save(),n.translate(8,8),n.rotate(e[6]*Math.PI/180),n.translate(-8,-8)):(o.height=16,o.width=16),e.length>6&&e[6]===!0?n.drawImage(t,e[2],e[3],e[4],e[5],0,0,96,32):e.length>7&&3===e[7]?n.drawImage(t,e[2],e[3],e[4],e[5],0,0,24,24):n.drawImage(t,e[2],e[3],e[4],e[5],0,0,16,16),e.length>6&&n.restore(),view.setInfoImageForType(o,e[0])}},view.imageProcessor_cropUnitSprite=function(e){var t,o,n=view.COLOR_RED,r=view.getUnitImageForType(e,view.IMAGE_CODE_IDLE,n);t=document.createElement("canvas"),t.height=32,t.width=96,o=t.getContext("2d"),o.drawImage(r,0,0,96,32,0,0,96,32),view.setUnitImageForType(t,e,view.IMAGE_CODE_IDLE,n),t=document.createElement("canvas"),t.height=32,t.width=96,o=t.getContext("2d"),o.drawImage(r,0,0,96,32,0,0,96,32),view.setUnitImageForType(view.imageProcessor_flipImage(t,!0,!1),e,view.IMAGE_CODE_IDLE_INVERTED,n),t=document.createElement("canvas"),t.height=32,t.width=96,o=t.getContext("2d"),o.drawImage(r,288,0,96,32,0,0,96,32),view.setUnitImageForType(t,e,view.IMAGE_CODE_LEFT,n),t=document.createElement("canvas"),t.height=32,t.width=96,o=t.getContext("2d"),o.drawImage(r,288,0,96,32,0,0,96,32),view.setUnitImageForType(view.imageProcessor_flipImage(t,!0,!1),e,view.IMAGE_CODE_RIGHT,n),t=document.createElement("canvas"),t.height=32,t.width=96,o=t.getContext("2d"),o.drawImage(r,96,0,96,32,0,0,96,32),view.setUnitImageForType(t,e,view.IMAGE_CODE_UP,n),t=document.createElement("canvas"),t.height=32,t.width=96,o=t.getContext("2d"),o.drawImage(r,192,0,96,32,0,0,96,32),view.setUnitImageForType(t,e,view.IMAGE_CODE_DOWN,n)},view.imageProcessor_scale2x=function(e){var t,o,n,r,a,i,s,l,c,u,d,m,_,p,f,h,g,v,E,w,I,T,M,y,A,S,O,C,b=e.width,L=e.height,k=document.createElement("canvas"),P=k.getContext("2d");k.width=b,k.height=L,P.drawImage(e,0,0);var D=P.getImageData(0,0,b,L),R=document.createElement("canvas"),N=R.getContext("2d");R.width=2*b,R.height=2*L;for(var x=N.getImageData(0,0,2*b,2*L),B=0;B<D.height;B++)for(var U=0;U<D.width;U++)h=4*B*D.width+4*U,t=D.data[h],o=D.data[h+1],n=D.data[h+2],U>0?(h=4*B*D.width+4*(U-1),_=D.data[h],p=D.data[h+1],f=D.data[h+2]):(_=t,p=o,f=n),B>0?(h=4*(B-1)*D.width+4*U,r=D.data[h],a=D.data[h+1],i=D.data[h+2]):(r=t,a=o,i=n),U<D.height-1?(h=4*(B+1)*D.width+4*U,s=D.data[h],l=D.data[h+1],c=D.data[h+2]):(s=t,l=o,c=n),U<D.width-1?(h=4*B*D.width+4*(U+1),u=D.data[h],d=D.data[h+1],m=D.data[h+2]):(u=t,d=o,m=n),g=t,v=o,E=n,w=t,I=o,T=n,M=t,y=o,A=n,S=t,O=o,C=n,r===s&&a===l&&i===c||_===u&&p===d&&f===m||(r===_&&a===p&&i===f&&(g=_,v=p,E=f),r===u&&a===d&&i===m&&(w=u,I=d,T=m),_===s&&p===l&&f===c&&(M=_,y=p,A=f),s===u&&l===d&&c===m&&(S=u,O=d,C=m)),h=2*B*4*x.width+2*U*4,x.data[h+0]=g,x.data[h+1]=v,x.data[h+2]=E,x.data[h+4]=w,x.data[h+5]=I,x.data[h+6]=T,h=4*(2*B+1)*x.width+2*U*4,x.data[h+0]=M,x.data[h+1]=y,x.data[h+2]=A,x.data[h+4]=S,x.data[h+5]=O,x.data[h+6]=C;return N.putImageData(x,0,0),k=null,R},controller.KEY_MAPPINGS={KEYBOARD:0,GAMEPAD:1},controller.DEFAULT_KEY_MAP={KEYBOARD:{UP:38,DOWN:40,LEFT:37,RIGHT:39,ACTION:13,CANCEL:8},MOUSE:{HOVER:0},GAMEPAD:{ACTION:0,CANCEL:1}},controller.KEYMAP_STORAGE_KEY="__user_key_map__",controller.keyMaps={KEYBOARD:util.copy(controller.DEFAULT_KEY_MAP.KEYBOARD),GAMEPAD:util.copy(controller.DEFAULT_KEY_MAP.GAMEPAD)},controller.input_genericInputRequest=!1,controller.inputCoolDown=0,controller.input_blocked=!1,controller.input_stack=util.list(10,-1),controller.input_data1=util.list(10,-1),controller.input_data2=util.list(10,-1),controller.input_stack_r_=0,controller.input_stack_w_=0,controller.input_pushKey=function(e,t,o){return controller.input_blocked||controller.inputCoolDown>0?void 0:(0===t||t||(t=-1),0===o||o||(o=-1),-1===controller.input_stack[controller.input_stack_w_]?(controller.input_stack[controller.input_stack_w_]=e,controller.input_data1[controller.input_stack_w_]=t,controller.input_data2[controller.input_stack_w_]=o,controller.input_stack_w_++,controller.input_stack_w_===controller.input_stack.length&&(controller.input_stack_w_=0),controller.inputCoolDown=50,void 0):void 0)},controller.input_evalNextKey=function(){var e=controller.input_stack_r_,t=controller.input_stack[controller.input_stack_r_];if(-1===t)return!1;controller.input_stack[e]=-1;var o=controller.input_data1[e],n=controller.input_data2[e],r=controller.DEFAULT_KEY_MAP.KEYBOARD,a=controller.DEFAULT_KEY_MAP.MOUSE,i=null;switch(t){case r.UP:i=o>1?"SHIFT_UP":"INP_UP";break;case r.DOWN:i=o>1?"SHIFT_DOWN":"INP_DOWN";break;case r.LEFT:i=o>1?"SHIFT_LEFT":"INP_LEFT";break;case r.RIGHT:i=o>1?"SHIFT_RIGHT":"INP_RIGHT";break;case r.ACTION:i="INP_ACTION";break;case r.CANCEL:i="INP_CANCEL";break;case a.HOVER:i="INP_HOVER";break;default:return assert("false"),!1}return-1!==o&&-1!==n?controller.screenStateMachine.event(i,o,n):controller.screenStateMachine.event(i),e++,e===controller.input_stack.length&&(e=0),controller.input_stack_r_=e,!0},controller.input_requestBlock=function(){assert(!controller.input_blocked),controller.input_blocked=!0},controller.input_releaseBlock=function(){controller.input_blocked=!1},controller.saveKeyMapping=function(){controller.storage_general.set(controller.KEYMAP_STORAGE_KEY,controller.keyMaps)},controller.loadKeyMapping=function(e){controller.storage_general.get(controller.KEYMAP_STORAGE_KEY,function(t){t&&(controller.keyMaps=t.value),e&&e()})},controller.updateInputCoolDown=function(e){controller.inputCoolDown-=e,controller.inputCoolDown<0&&(controller.inputCoolDown=0)},view.mapImages=util.matrix(80,60,null),util.scoped(function(){function e(e,t,o,n,r){if(0>e||0>t||e>=model.map_width||t>=model.map_height)return n[o]="",void 0;var a=r[model.map_data[e][t].ID];void 0===a&&(a=""),n[o]=a}function t(e,t,o,n){for(var r=0,a=e.length;a>r;r++){var i=e[r];if(!(""!==i[1]&&i[1]!==t[0]||""!==i[2]&&i[2]!==t[1]||""!==i[3]&&i[3]!==t[2]||""!==i[4]&&i[4]!==t[3])){if(!o){if(""!==i[5]&&i[5]!==t[4])continue;if(""!==i[6]&&i[6]!==t[5])continue;if(""!==i[7]&&i[7]!==t[6])continue;if(""!==i[8]&&i[8]!==t[7])continue}return i[0]}}return n}view.updateMapImages=function(){var o,n,r=model.map_width,a=model.map_height,i=e,s=t,l=[];for(o=0;r>o;o++)for(n=0;a>n;n++){var c=o,u=n,d=model.map_data[c][u].ID,m=model.data_tileSheets[d].assets.gfx_variants;if(m){var _=m[0];5===m[1][0].length?(i(o,n-1,0,l,_),i(o+1,n,1,l,_),i(o,n+1,2,l,_),i(o-1,n,3,l,_),view.mapImages[o][n]=s(m[1],l,!0,d)):(i(o,n-1,0,l,_),i(o+1,n-1,1,l,_),i(o+1,n,2,l,_),i(o+1,n+1,3,l,_),i(o,n+1,4,l,_),i(o-1,n+1,5,l,_),i(o-1,n,6,l,_),i(o-1,n-1,7,l,_),view.mapImages[o][n]=s(m[1],l,!1,d))}else view.mapImages[c][u]=d}}}),util.scoped(function(){var e=250,t={};controller.registerMenuRenderer=function(e,o){assert(!t.hasOwnProperty(e),"renderer for",e,"is already registered"),t[e]=o};var o=document.getElementById("cwt_menu"),n=(document.getElementById("cwt_menu_header"),document.getElementById("cwt_menu_entries")),r=(document.getElementById("cwt_menu_content"),document.getElementById("cwt_menu_pageUp")),a=document.getElementById("cwt_menu_pageDown"),i="button_active",s=10,l=0;!function(){var e=function(e,t){e.onmouseover=function(){controller.setMenuIndex(t,!1)},e.onclick=function(){controller.screenStateMachine.event("INP_ACTION")}};r.onclick=function(){controller.menu_prevPage()},a.onclick=function(){controller.menu_nextPage()};for(var t=document.createDocumentFragment(),o=0,i=s;i>o;o++){var l=document.createElement("button"),c=document.createElement("li");e(l,o),c.appendChild(l),t.appendChild(c)}n.appendChild(t)}(),o.style.width=e+"px";var c=function(e,o){var r=controller.stateMachine.data.menu,a=n.children,i=s*e,c=t.__mainMenu__;if("ACTION_SUBMENU"===controller.stateMachine.state){var u=t[controller.stateMachine.data.action.selectedEntry];u&&(c=u)}for(var d=0,m=s;m>d;d++)i+d<r.size?(a[d].style.display="",c(r.data[i+d],a[d].children[0],i+d,r.enabled[i+d])):a[d].style.display="none";o?controller.setMenuIndex(0):controller.setMenuIndex(s-1),l=e};controller.menuCursorIndex=-1,controller.menu_getSelectedIndex=function(){return l*s+controller.menuCursorIndex},controller.setMenuIndex=function(e){var t=n.children;-1!==controller.menuCursorIndex&&(t[controller.menuCursorIndex].className=""),controller.menuCursorIndex=e,t[e].className=i,t[e].children[0].focus(),controller.audio_playSound(model.data_sounds.MENUTICK)},controller.resetMenuCursor=function(){-1!==controller.menuCursorIndex&&(n.children[controller.menuCursorIndex].className=""),controller.menuCursorIndex=0},controller.increaseMenuCursor=function(){controller.menuCursorIndex<s-1&&controller.menu_getSelectedIndex()<controller.stateMachine.data.menu.size-1?controller.setMenuIndex(controller.menuCursorIndex+1):controller.menu_nextPage()},controller.decreaseMenuCursor=function(){controller.menuCursorIndex>0?controller.setMenuIndex(controller.menuCursorIndex-1):controller.menu_prevPage()},controller.menu_prevPage=function(){l>0&&c(l-1,!1)},controller.menu_nextPage=function(){l<controller.stateMachine.data.menu.size/s-1&&c(l+1,!0)},controller.menuVisible=!1;var u=-1,d=-1;controller.showMenu=function(t,n,i){var l=TILE_LENGTH*controller.screenScale;1===arguments.length&&(n=u,i=d),c(0,!0),t.size>s?(a.style.display="",r.style.display=""):(a.style.display="none",r.style.display="none"),n-=controller.screenX,i-=controller.screenY,controller.menuPosX=n,controller.menuPosY=i;var m=n*l,_=i*l;m+e>=controller.screenWidthPx&&(m=controller.screenWidthPx-e-10),_+o.offsetHeight>=controller.screenHeightPx&&(_=controller.screenHeightPx-o.offsetHeight-10),o.style.left=m+"px",o.style.top=_+"px",o.style.opacity=1,controller.menuVisible=!0},controller.hideMenu=function(){o.style.left="-1000px",o.style.top="-1000px",o.style.opacity=0,controller.menuVisible=!1,controller.resetMenuCursor()},controller.isMenuOpen=function(){return controller.menuVisible}}),util.scoped(function(){var e=document.getElementById("cwt_info_box"),t=document.getElementById("cwt_info_box_content"),o=2e3,n=0;view.updateMessagePanelTime=function(t){n>0&&(n-=t,0>=n&&(e.style.opacity=0,e.style.top="-1000px",controller.input_releaseBlock()))},view.message_closePanel=function(e){n=e?e:1},view.hasInfoMessage=function(){return n>0},view.showInfoMessage=function(r,a){1===arguments.length&&(a=o),t.innerHTML=r,e.style.opacity=1,e.style.top="96px",n=a,controller.input_requestBlock()}}),controller.metadata_TYPES={SIZE_X:0,SIZE_Y:1,NUM_PROPERTIES:2,MAX_PLAYER:3},controller.metadata_grabFromMapData=function(e,t,o,n){for(var r,a=0;a<t.length;a++){o[a].width=16,o[a].height=32;var i=o[a].getContext("2d");if(i.clearRect(0,0,16,32),null===e||null===n||a>=n.length)t[a].innerHTML="&#160;";else{r||(r=e.prps);for(var s=0,l=n[a],c=0;c<r.length;c++)r[c][3]===l&&s++;t[a].innerHTML=s,i.drawImage(view.getPropertyImageForType(l,view.COLOR_NEUTRAL),0,0,16,32,0,0,16,32)}}},controller.minimap_mapSelectionCanvas=document.getElementById("cwt_versus_minimap_canvas"),controller.minimap_ingameCanvas=document.getElementById("cwt_ingame_minimap_canvas"),controller.minimap_ingameBlend=document.getElementById("cwt_ingame_minimap_blend"),controller.minimap_showIngameMinimap=function(){var e=controller.minimap_ingameBlend.style,t=controller.minimap_ingameCanvas,o=t.style;controller.minimap_renderMinimap_(t,model.map_width,model.map_height,model.map_data,null,!0),e.display="block",o.display="block",o.left=parseInt(controller.screenWidthPx/2-t.width/2,10)+"px",o.top=parseInt(controller.screenHeightPx/2-t.height/2,10)+"px"},controller.minimap_hideIngameMinimap=function(){var e=controller.minimap_ingameBlend.style,t=controller.minimap_ingameCanvas.style;e.display="none",t.display="none"},controller.minimap_renderMinimap_=function(e,t,o,n,r,a){var i=view.getInfoImageForType(a?"MINIMAP4X":"MINIMAP2X"),s=a?4:2;e.width=t*s,e.height=o*s;var l=e.getContext("2d");l.clearRect(0,0,e.width,e.height);var c,u,d=t,m=o;for(c=0;d>c;c++)for(u=0;m>u;u++){var _=r?model.data_tileSheets[r[n[c][u]]]:n[c][u];void 0!==_.assets.mmap4x_gfx?l.drawImage(i,_.assets.mmap4x_gfx*s,0,s,s,c*s,u*s,s,s):(l.fillStyle="#FF0000",l.fillRect(c*s,u*s,s,s))}},controller.minimap_renderMapSelectionMinimap=function(e){var t=controller.minimap_mapSelectionCanvas;controller.minimap_renderMinimap_(t,e.mpw,e.mph,e.map,e.typeMap,e.mph<=30&&e.mpw<=80),t.style.top="calc(50% - "+parseInt(t.height/2,10)+"px)"},controller.network_gameId=null,controller.network_clientId=-1,controller.network_target=null,controller.network_isActive=function(){return null!==controller.network_gameId},controller.network_isHost=function(){return!controller.network_isActive()||0===controller.network_clientId},controller.network_parseMessage=function(){var e=function(){if(4==xmlHttp.readyState){var e=xmlHttp.responseText;if(""!==e)for(var t=e.split("_&_"),o=0,n=t.length;n>o;o++)void 0!==t[o]&&t[o].length>0&&network._incomingMessage(t[o])}};return function(){var t=new XMLHttpRequest;t.open("GET",controller.network_target+"?cmd=GRABCMD&gameId="+controller.network_gameId+"&userId="+controller.network_clientId,!0),t.onreadystatechange=e,t.send(null)}}(),controller.network_sendMessage=function(){},controller.unitStatusMap=util.list(200,function(){return{HP_PIC:null,LOW_AMMO:!1,LOW_FUEL:!1,HAS_LOADS:!1,CAPTURES:!1,VISIBLE:!1}}),controller.getUnitStatusForUnit=function(e){var t=model.unit_extractId(e);return controller.unitStatusMap[t]},util.scoped(function(){function e(e,t,o,n){if(model.map_isValidPosition(e,t)){var r=model.unit_posData[e][t];r&&(model.player_data[r.owner].team!==o&&(n.VISIBLE=!0),r.hidden&&(controller.unitStatusMap[model.unit_extractId(r)].VISIBLE=!0))}}function t(t,o){if(o||(o=controller.unitStatusMap[model.unit_extractId(t)]),o.VISIBLE=!0,t.hidden){o.VISIBLE=!1;var n=t.x,r=t.y,a=model.player_data[t.owner].team;e(n-1,r,a,o),e(n,r-1,a,o),e(n,r+1,a,o),e(n+1,r,a,o)}}controller.updateUnitStatus=function(e){var o=model.unit_data[e],n=(o.x,o.y,controller.unitStatusMap[e]),r=o.type,a=o.ammo,i=r.ammo;n.LOW_AMMO=a<=parseInt(.25*i,10)?!0:!1,0===i&&(n.LOW_AMMO=!1);var s=o.fuel,l=r.fuel;n.LOW_FUEL=s<parseInt(.25*l,10)?!0:!1;var c=-1;switch(o.hp<=90&&(c=model.unit_convertHealthToPoints(o.hp)),c){case 1:n.HP_PIC=view.getInfoImageForType("HP_1");break;case 2:n.HP_PIC=view.getInfoImageForType("HP_2");break;case 3:n.HP_PIC=view.getInfoImageForType("HP_3");break;case 4:n.HP_PIC=view.getInfoImageForType("HP_4");break;case 5:n.HP_PIC=view.getInfoImageForType("HP_5");break;case 6:n.HP_PIC=view.getInfoImageForType("HP_6");break;case 7:n.HP_PIC=view.getInfoImageForType("HP_7");break;case 8:n.HP_PIC=view.getInfoImageForType("HP_8");break;case 9:n.HP_PIC=view.getInfoImageForType("HP_9");break;default:n.HP_PIC=null}if(n.HAS_LOADS=o.loadedIn<-1?!0:!1,o.x>=0){var u=model.property_posMap[o.x][o.y];n.CAPTURES=null!==u&&u.capturePoints<20?!0:!1}t(o,n)}}),controller.action_clientAction({key:"options",condition:function(){return!0},invoke:function(){controller.screenStateMachine.event("toOptions_",!0)}}),view.redraw_dataChanges=0,view.redraw_data=util.matrix(80,60,!1),view.redraw_MODE={RECTANGLE:0,CIRCLE:1},view.redraw_markPos=function(e,t,o,n,r){"number"!=typeof o?o=0:o--,"number"!=typeof n?n=0:n--,"undefined"==typeof r&&(r=view.redraw_MODE.RECTANGLE);var a=r===view.redraw_MODE.CIRCLE,i=e,s=t;a&&(e-=o,t-=n);for(var l=Math.min(e+o,model.map_width-1),c=Math.min(t+n,model.map_height-1);l>=e;e++)for(t=s;;){if(0>e||0>t||e>=model.map_width||t>=model.map_height)break;if(view.redraw_data[e][t]){if(t++,c>=t)continue;break}if((!a||Math.abs(e-i)+Math.abs(t-s)<=o)&&(view.redraw_data[e][t]=!0,view.redraw_dataChanges++),model.property_posMap[e][t]&&"PROP_INV"===model.property_posMap[e][t].type.ID&&e===l&&(l++,t>c&&(c=t)),t++,t===model.map_height)break;if(null===model.property_posMap[e][t]&&!(c>=t)&&view.overlayImages[view.mapImages[e][t]]!==!0)break}},view.redraw_markAll=function(){view.redraw_dataChanges=1;for(var e=0,t=model.map_width;t>e;e++)for(var o=0,n=model.map_height;n>o;o++)view.redraw_data[e][o]=!0},view.redraw_markSelection=function(e){var t=e.selection.centerX,o=e.selection.centerY,n=e.selection.data;view.redraw_markPos(t,o,n.length,n.length,view.redraw_MODE.RECTANGLE)},view.redraw_markPosWithNeighbours=function(e,t){view.redraw_markPos(e,t,2,0,view.redraw_MODE.CIRCLE)},view.redraw_markPosWithNeighboursRing=function(e,t){view.redraw_markPos(e-1,t-1,3,3,view.redraw_MODE.RECTANGLE)},controller.screenElement=document.getElementById("cwt_canvas"),controller.infoElement=document.getElementById("cwt_game_infoBar"),controller.screenX=0,controller.screenY=0,controller.screenWidth=-1,controller.screenHeight=-1,controller.screenWidthPx=-1,controller.screenHeightPx=-1,controller.screenScale=1,controller.moveScreenX=0,controller.moveScreenY=0,controller.setScreenScale=function(e){1>e||e>3||(controller.screenScale=e,controller.screenElement.className="scale"+e,view.updateScreenPosition())},controller.getMapXByScreenX=function(e){return controller.screenX+parseInt(e/(TILE_LENGTH*controller.screenScale),10)},controller.getMapXByScreenY=function(e){return controller.screenY+parseInt(e/(TILE_LENGTH*controller.screenScale),10)},controller.getCanvasPosX=function(e){return e*TILE_LENGTH},controller.getCanvasPosY=function(e){return e*TILE_LENGTH},controller.setScreenPosition=function(e,t){controller.screenX=e,controller.screenY=t;var o=controller.screenElement.style,n=controller.screenScale,r=-(controller.screenX*TILE_LENGTH*n),a=-(controller.screenY*TILE_LENGTH*n);switch(n){case 2:r+=controller.screenElement.width/2,a+=controller.screenElement.height/2;break;case 3:r+=controller.screenElement.width,a+=controller.screenElement.height}o.position="absolute",o.left=r+"px",o.top=a+"px"},controller.shiftScreenPosition=function(e,t){1===arguments.length&&(t=1);var o=controller.screenX,n=controller.screenY;switch(e){case model.move_MOVE_CODES.DOWN:n+=t;break;case model.move_MOVE_CODES.RIGHT:o+=t;break;case model.move_MOVE_CODES.UP:n-=t;break;case model.move_MOVE_CODES.LEFT:o-=t}0>o&&(o=0),0>n&&(n=0),o>=model.map_width&&(o=model.map_width-1),n>=model.map_height&&(n=model.map_height-1),controller.setScreenPosition(o,n,!1)},view.resizeCanvas=function(){var e=controller.screenElement;e.width=TILE_LENGTH*model.map_width,e.height=TILE_LENGTH*model.map_height,view.updateScreenPosition()},function(){function e(e,t,o){return t>e?o:(t=parseInt(t/2,10),e=parseInt(e/2,10),-e+t)}view.updateScreenPosition=function(){var t=TILE_LENGTH*controller.screenScale,o=controller.screenWidth=parseInt(window.innerWidth/t,10),n=controller.screenHeight=parseInt(window.innerHeight/t,10);controller.screenWidthPx=window.innerWidth,controller.screenHeightPx=window.innerHeight;var r=model.map_width,a=model.map_height,i=e(o,r,controller.screenX),s=e(n,a,controller.screenY);if(controller.setScreenPosition(i,s,!1),0>i){var l=-i*t-160;controller.infoElement.style.right=(l>0?l:"4px")+"px"}else controller.infoElement.style.right="4px";if(0>s){var l=-s*t;controller.infoElement.style.bottom=(l>0?l:"4px")+"px"}else controller.infoElement.style.bottom="4px"}}(),window.addEventListener("resize",view.updateScreenPosition,!0);var TILE_LENGTH=16;controller.baseSize=16,view.preventRenderUnit=null,view.canvasCtx=controller.screenElement.getContext("2d"),view.selectionRange=2,view.colorArray=[view.COLOR_RED,view.COLOR_BLUE,view.COLOR_GREEN,view.COLOR_YELLOW],view.renderMap=function(){for(var e,t,o,n,r,a,i,s,l,c,u,d=TILE_LENGTH,m=view.canvasCtx,_=(controller.screenX,controller.screenY,controller.mapCursorX),p=controller.mapCursorY,f=view.getSpriteStep("SELECTION"),h=view.getSpriteStep("UNIT"),g=view.getSpriteStep("UNIT_SIMPLE"),v=view.getSpriteStep("PROPERTY"),E=view.getSpriteStep("STATUS"),w=view.getSpriteStep("ANIM_TILES"),I=view.getSpriteStep("ANIM_TILES_EXT"),T=controller.baseSize,M=model.data_simpleAnimatedUnits,y=-1!==model.client_lastPid?model.player_data[model.client_lastPid].team:-1,A="MOVEPATH_SELECTION"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state||controller.attackRangeVisible,S="MOVEPATH_SELECTION"===controller.stateMachine.state||"ACTION_MENU"===controller.stateMachine.state||"ACTION_SUBMENU"===controller.stateMachine.state,O="ACTION_SELECT_TILE"===controller.stateMachine.state,C=controller.stateMachine.data,b=C.selection,L=model.map_height-1,k=0;L>=k;k++)for(var P=model.map_width-1,D=0;P>=D;D++)if(u=0===model.fog_clientData[D][k],view.redraw_data[D][k]===!0){e=view.mapImages[D][k],t=view.getTileImageForType(e),o=0,n=0,view.animatedTiles[model.map_data[D][k].ID]&&(o+=2===model.map_data[D][k].assets.animated?T*I:T*w),r=T,a=2*T,i=D*d,s=k*d-d,l=d,c=2*d,0>s&&(n+=T,a-=T,s+=d,c-=d),void 0!==t?(m.drawImage(t,o,n,r,a,i,s,l,c),u&&(t=view.getTileShadowImageForType(view.mapImages[D][k]),m.globalAlpha=.35,m.drawImage(t,o,n,r,a,i,s,l,c),m.globalAlpha=1)):(m.fillStyle="rgb(0,0,255)",m.fillRect(i,s,d,d));var R=model.property_posMap[D][k];if(null!==R&&R.type.assets.gfx){var N;if(e=R.type.ID,-1===R.owner)N=view.COLOR_NEUTRAL;else if(N=view.colorArray[R.owner],R.type.factionSprites){var x=model.co_data[R.owner].coA;x&&(e=R.type.factionSprites[x.faction])}u&&(N=view.COLOR_NEUTRAL),t=view.getPropertyImageForType(e,N),o=0+T*v,n=0,r=T,a=2*T,i=D*d,s=k*d-d,l=d,c=2*d,0>s&&(n+=T,a-=T,s+=d,c-=d),R.type.assets.gfxOffset&&(o=0+R.type.assets.gfxOffset[0]*v,r=R.type.assets.gfxOffset[0],a=R.type.assets.gfxOffset[1],i+=R.type.assets.gfxOffset[2],s+=R.type.assets.gfxOffset[3],l=R.type.assets.gfxOffset[0],c=R.type.assets.gfxOffset[1]),void 0!==t?(m.drawImage(t,o,n,r,a,i,s,l,c),u&&(t=view.getPropertyImageForType(R.type.ID,view.COLOR_BLACK_MASK),m.globalAlpha=.35,m.drawImage(t,o,n,r,a,i,s,l,c),m.globalAlpha=1)):(i=D*d,s=k*d,l=d,c=d,m.fillStyle="rgb(0,255,0)",m.fillRect(i,s,l,c))}if(A){t=view.getInfoImageForType("MOVEPATH_SELECTION"===controller.stateMachine.state?"MOVE_FOC":"ATK_FOC");var B=b.getValueAt(D,k);B>0&&(o=T*f,n=0,r=T,a=T,i=D*d,s=k*d,l=d,c=d,m.globalAlpha=.65,m.drawImage(t,o,n,r,a,i,s,l,c),m.globalAlpha=1)}if(O){var U=model.map_getDistance(_,p,D,k);if(view.selectionRange===U){var t=null;t=0===U?view.getInfoImageForType("SILO_ALL"):_===D?p>k?view.getInfoImageForType("SILO_N"):view.getInfoImageForType("SILO_S"):p===k?_>D?view.getInfoImageForType("SILO_W"):view.getInfoImageForType("SILO_E"):_>D?p>k?view.getInfoImageForType("SILO_NW"):view.getInfoImageForType("SILO_SW"):p>k?view.getInfoImageForType("SILO_NE"):view.getInfoImageForType("SILO_SE"),i=D*d,s=k*d,null!==t&&m.drawImage(t,i,s)}}var F=model.unit_posData[D][k],G=null!==F?controller.getUnitStatusForUnit(F):null;if(!u&&null!==F&&F.type.assets.gfx&&(F.owner===model.round_turnOwner||model.player_data[F.owner].team==y||G.VISIBLE)&&F!==view.preventRenderUnit){var N,Y=M[F.type.ID]?g:h;N=-1===F.owner?view.COLOR_NEUTRAL:view.colorArray[F.owner];var H;if(H=F.type.cannon?view.IMAGE_CODE_IDLE:F.owner%2===1?view.IMAGE_CODE_IDLE:view.IMAGE_CODE_IDLE_INVERTED,t=view.getUnitImageForType(F.type.ID,H,N),o=2*T*Y,n=0,r=2*T,a=2*T,i=D*d-d/2,s=k*d-d/2,l=d+d,c=d+d,void 0!==t?(m.drawImage(t,o,n,r,a,i,s,l,c),F.owner!==model.round_turnOwner||model.actions_canAct(model.unit_extractId(F))||(m.globalAlpha=.5,m.drawImage(view.getUnitImageForType(F.type.ID,H,view.COLOR_BLACK_MASK),o,n,r,a,i,s,l,c),m.globalAlpha=1)):(i=D*d,s=k*d,l=d,c=d,m.fillStyle="rgb(255,0,0)",m.fillRect(i,s,l,c)),t=G.HP_PIC,null!==t&&m.drawImage(t,i+d,s+d),0!==E&&1!==E&&4!==E&&5!==E&&8!==E&&9!==E&&12!==E&&13!==E&&16!==E&&17!==E){var X=parseInt(E/4,10);t=null;var K=X;do{if(0===K&&G.LOW_AMMO?t=view.getInfoImageForType("SYM_AMMO"):1===K&&G.CAPTURES?t=view.getInfoImageForType("SYM_CAPTURE"):2===K&&G.LOW_FUEL?t=view.getInfoImageForType("SYM_FUEL"):3===K&&G.HAS_LOADS?t=view.getInfoImageForType("SYM_LOAD"):4===K&&F.hidden&&(t=view.getInfoImageForType("SYM_HIDDEN")),null!==t)break;K++,5===K&&(K=0)}while(K!==X);null!==t&&m.drawImage(t,i+d/2,s+d)}}view.redraw_data[D][k]=!1}if(S)for(var V,W,z,j,q=C.movePath.data,Q=C.source.x,J=C.source.y,Z=0,$=q.length;$>Z&&(-1!==q[Z]&&null!==q[Z]);Z++){switch(V=Q,W=J,q[Z]){case model.move_MOVE_CODES.UP:J--;break;case model.move_MOVE_CODES.RIGHT:Q++;break;case model.move_MOVE_CODES.DOWN:J++;break;case model.move_MOVE_CODES.LEFT:Q--}if(-1===q[Z+1]||null===q[Z+1])z=-1,j=-1;else switch(q[Z+1]){case model.move_MOVE_CODES.UP:z=Q,j=J-1;break;case model.move_MOVE_CODES.RIGHT:z=Q+1,j=J;break;case model.move_MOVE_CODES.DOWN:z=Q,j=J+1;break;case model.move_MOVE_CODES.LEFT:z=Q-1,j=J}if(-1==z)switch(q[Z]){case model.move_MOVE_CODES.UP:t=view.getTileImageForType("ARROW_N");break;case model.move_MOVE_CODES.RIGHT:t=view.getTileImageForType("ARROW_E");break;case model.move_MOVE_CODES.DOWN:t=view.getTileImageForType("ARROW_S");break;case model.move_MOVE_CODES.LEFT:t=view.getTileImageForType("ARROW_W")}else{var et=Math.abs(z-V),tt=Math.abs(j-W);if(2===et)t=view.getTileImageForType("ARROW_WE");else if(2===tt)t=view.getTileImageForType("ARROW_NS");else if(Q>z&&W>J||Q>V&&j>J)t=view.getTileImageForType("ARROW_SW");else if(Q>z&&J>W||Q>V&&J>j)t=view.getTileImageForType("ARROW_WN");else if(z>Q&&J>W||V>Q&&J>j)t=view.getTileImageForType("ARROW_NE");else{if(!(z>Q&&W>J||V>Q&&j>J)){assert(!1,"illegal move arrow state","old (",V,",",W,")","current (",Q,",",J,")","next (",z,",",j,")","path (",q,")");continue}t=view.getTileImageForType("ARROW_ES")}}Q>=0&&J>=0&&Q<controller.screenWidth&&J<controller.screenHeight&&m.drawImage(t,Q*d,J*d)}m.lineWidth=2,m.strokeStyle="#f00",m.strokeRect(d*controller.mapCursorX+1,d*controller.mapCursorY+1,d-2,d-2),view.redraw_dataChanges=0},controller.openedSection=null,controller.openSection=function(e){if(null!==e){var t=document.getElementById(e);t||model.criticalError(constants.error.CLIENT_ERROR,constants.error.CLIENT_DATA_ERROR),null!==this.openedSection&&(this.openedSection.style.display="none"),t.style.display="",this.openedSection=t}},controller.screenStateMachine=util.stateMachine({},{noHistory:!0}),controller.screenStateMachine.data={},controller.storage_SIZES={maps:10,assets:40,general:5},controller.storage_NAMES={maps:"MAPS",assets:"ASSETS",general:"GENERAL"},controller.storage_maps=null,controller.storage_assets=null,controller.storage_general=null,controller.storage_create=function(e,t,o,n){var r=new Lawnchair({adaptor:o,maxSize:1024*(controller.features_client.iosWebSQLFix?4:t)*1024,name:e},function(){n({get:function(e,t){r.get(e,t)},has:function(e,t){r.exists(e,t)},exists:function(e,t){r.exists(e,t)},set:function(e,t,o){r.save({key:e,value:t},o,function(){r.save({key:e,value:t},o)})},keys:function(e){r.keys(e)},clear:function(e){r.nuke(e)},remove:function(e,t){r.remove(e,t)}})})},controller.storage_initialize=function(e,t){t.take();var o=Browser.mobile?"webkit-sqlite":"indexed-db";jWorkflow.order(function(e,t){t.take(),controller.storage_create(controller.storage_NAMES.maps,controller.storage_SIZES.maps,o,function(e){controller.storage_maps=e,t.pass()})}).andThen(function(e,t){t.take(),controller.storage_create(controller.storage_NAMES.assets,controller.storage_SIZES.assets,o,function(e){controller.storage_assets=e,t.pass()})}).andThen(function(e,t){t.take(),controller.storage_create(controller.storage_NAMES.general,controller.storage_SIZES.general,o,function(e){controller.storage_general=e,t.pass()
})}).start(function(e){t.pass()})},controller.storage_wipeOut=function(e){function t(e,t){e.andThen(function(e,o){o.take(),t.clear(function(){o.pass()})})}var o=jWorkflow.order();controller.storage_general&&t(o,controller.storage_general),controller.storage_assets&&t(o,controller.storage_assets),controller.storage_maps&&t(o,controller.storage_maps),o.start(function(){e&&e()})},controller.colorizeImages=util.singleLazyCall(function(e,t){t.take();var o=jWorkflow.order(function(){});model.data_unitTypes.forEach(function(e){model.data_unitSheets[e].assets.gfx&&o.andThen(function(){view.imageProcessor_colorizeUnit(e)})}),model.data_propertyTypes.forEach(function(e){model.data_tileSheets[e].assets.gfx&&o.andThen(function(){view.imageProcessor_colorizeProperty(e)})}),model.data_tileTypes.forEach(function(e){o.andThen(function(){view.imageProcessor_colorizeTile(e)})}),model.data_tileTypes.forEach(function(e){var t=model.data_tileSheets[e];t.assets.gfx_variants&&t.assets.gfx_variants[1].forEach(function(e){o.andThen(function(){view.imageProcessor_colorizeTile(e[0])})})}),o.start(function(){t.pass()})}),controller.cutImages=util.singleLazyCall(function(e,t){t.take();var o=jWorkflow.order(function(){});model.data_unitTypes.forEach(function(e){model.data_unitSheets[e].assets.gfx&&o.andThen(function(){view.imageProcessor_cropUnitSprite(e)})}),model.data_graphics.misc.forEach(function(e){o.andThen(function(){view.imageProcessor_cropMiscSprite(e)})}),o.start(function(){t.pass()})}),controller.dataLoader_start=function(e,t){assert(e&&t);jWorkflow.order().andThen(function(){e.innerHTML="Loading",t.className="loadBar_0"}).andThen(controller.features_analyseClient).andThen(function(){t.className="loadBar_5"}).andThen(function(e,t){controller.features_client.supported||(t.take(),confirm("Your system isn't supported by CW:T. Try to run it?")&&t.pass())}).andThen(function(){t.className="loadBar_10"}).andThen(controller.storage_initialize).andThen(function(){t.className="loadBar_15"}).andThen(function(e,t){return e?e:(t.take(),controller.storage_general.get("cwt_resetData",function(e){var o=e&&e.value===!0;o||(o="1"===getQueryParams(document.location.search).cwt_resetData),o?controller.storage_general.clear(function(){controller.storage_assets.clear(function(){controller.storage_maps.clear(function(){t.pass(!1)})})}):t.pass(!1)}),void 0)}).andThen(function(e,t){return e?e:(t.take(),controller.storage_general.get("cwt_forceTouch",function(e){var o=e&&e.value===!0;o||(o="1"===getQueryParams(document.location.search).cwt_forceTouch),o&&(controller.features_client.mouse=!1,controller.features_client.touch=!0,controller.screenStateMachine.structure.OPTIONS.forceTouch=!0),t.pass(!1)}),void 0)}).andThen(function(e,t){return e?e:(t.take(),controller.storage_general.get("cwt_animatedTiles",function(e){e?controller.screenStateMachine.structure.OPTIONS.animatedTiles=e.value===!0?!0:!1:"1"===getQueryParams(document.location.search).cwt_animatedTiles?controller.screenStateMachine.structure.OPTIONS.animatedTiles=!0:"0"===getQueryParams(document.location.search).cwt_animatedTiles&&(controller.screenStateMachine.structure.OPTIONS.animatedTiles=!1),t.pass(!1)}),void 0)}).andThen(function(){t.className="loadBar_20"}).andThen(controller.modification_load).andThen(function(){e.innerHTML=model.data_localized("loading.loadMaps"),t.className="loadBar_30"}).andThen(controller.loadMaps_doIt).andThen(function(){e.innerHTML=model.data_localized("loading.loadImages"),t.className="loadBar_40"}).andThen(controller.loadImages_doIt).andThen(function(e,t){t.take();var o=model.data_menu.bgs[parseInt(model.data_menu.bgs.length*Math.random(),10)];controller.storage_assets.get(model.data_assets.images+"/"+o,function(e){e&&controller.background_registerAsBackground(e.value),t.pass()})}).andThen(function(){e.innerHTML=model.data_localized("loading.cropImages"),t.className="loadBar_60"}).andThen(controller.cutImages).andThen(function(){e.innerHTML=model.data_localized("loading.colorizeImages"),t.className="loadBar_65"}).andThen(controller.colorizeImages).andThen(function(){e.innerHTML=model.data_localized("loading.loadSounds"),t.className="loadBar_70"}).andThen(controller.audio_initialize).andThen(controller.loadAudio_doIt).andThen(function(){e.innerHTML=model.data_localized("loading.prepareInput"),t.className="loadBar_90"}).andThen(controller.loadInputDevices).andThen(function(){e.innerHTML=model.data_localized("loading.prepareInput"),t.className="loadBar_93"}).andThen(function(e,t){t.take(),controller.loadKeyMapping(function(){t.pass()})}).andThen(function(){e.innerHTML=model.data_localized("loading.prepareLanguage"),t.className="loadBar_95"}).andThen(function(){for(var e=document.querySelectorAll("[key]"),t=0,o=e.length;o>t;t++)e[t].innerHTML=model.data_localized(e[t].attributes.key.value)}).andThen(function(){e.innerHTML=model.data_localized("loading.done"),t.className="loadBar_100"}).andThen(function(){controller.screenStateMachine.event("complete")}).start(function(e){e&&assert(!1,"data loader failed ("+e+")")})},controller.loadAudio_loadIt_=function(e,t,o,n){(!t||controller.features_client.audioMusic)&&(controller.audio_isBuffered(e)||(o.take(),controller.storage_assets.get(e,function(r){if(r)n?controller.storage_assets.get(e,function(t){assert(t.value);var n=Base64Helper.decodeBuffer(t.value);controller.audio_loadByArrayBuffer(e,n,function(){o.pass()})}):o.pass();else{var a=new XMLHttpRequest;a.open("GET",(t?model.data_assets.music:model.data_assets.sounds)+"/"+e,!0),a.responseType="arraybuffer",a.onload=function(){if(404===this.status)return o.pass(),void 0;var t=a.response,r=Base64Helper.encodeBuffer(t);controller.storage_assets.set(e,r,function(){n?controller.audio_loadByArrayBuffer(e,t,function(){o.pass()}):o.pass()})},a.send()}})))},controller.loadAudio_doIt=util.singleLazyCall(function(e,t){if(controller.features_client.audioSFX||controller.features_client.audioMusic){var o=controller.audio_grabContext();if(o){t.take();var n=jWorkflow.order(function(){});if(controller.features_client.audioMusic&&(n.andThen(function(e,t){controller.loadAudio_loadIt_(model.data_menu.music,!0,t,!0)}),util.iterateListByFlow(n,model.data_fractionTypes,function(e,t){controller.loadAudio_loadIt_(model.data_fractionSheets[this.list[this.i]].music,!0,t)}),util.iterateListByFlow(n,model.data_coTypes,function(e,t){controller.loadAudio_loadIt_(model.data_coSheets[this.list[this.i]].music,!0,t)})),controller.features_client.audioSFX){for(var r=Object.keys(model.data_sounds),a=[],i=0;i<r.length;i++)a.push(model.data_sounds[r[i]]);util.iterateListByFlow(n,a,function(e,t){controller.loadAudio_loadIt_(this.list[this.i],!1,t,!0)}),util.iterateListByFlow(n,model.data_propertyTypes,function(e,t){var o=this.list[this.i],n=model.data_tileSheets[o];n.assets&&n.assets.fireSound&&controller.loadAudio_loadIt_(n.assets.fireSound,!1,t,!0)}),util.iterateListByFlow(n,model.data_unitTypes,function(e,t){var o=this.list[this.i],n=model.data_unitSheets[o];n.assets&&n.assets.pri_att_sound&&controller.loadAudio_loadIt_(n.assets.pri_att_sound,!1,t,!0)}),util.iterateListByFlow(n,model.data_unitTypes,function(e,t){var o=this.list[this.i],n=model.data_unitSheets[o];n.assets&&n.assets.sec_att_sound&&controller.loadAudio_loadIt_(n.assets.sec_att_sound,!1,t,!0)})}n.start(function(){t.pass()})}}}),controller.loadImages_loadFailed_=function(){var e="could not load "+this.pickey_;assert(!1,e)},controller.loadImages_loadSuccessful_=function(){var e=this.mode_,t=this.baton_,o=this.pickey_;switch(this.saveIt_&&controller.storage_assets.set(this.src,Base64Helper.canvasToBase64(this),controller.loadImages_pictureSaved_),delete this.pickey_,delete this.baton_,delete this.mode_,delete this.saveIt_,e){case"U":view.setUnitImageForType(this,o,view.IMAGE_CODE_IDLE,view.COLOR_RED);break;case"P":view.setPropertyImageForType(this,o,view.COLOR_RED);break;case"T":view.setTileImageForType(this,o);break;case"M":view.setInfoImageForType(this,o);break;default:assert(!1)}t.pass()},controller.loadImages_pictureSaved_=function(e){},controller.loadImages_prepareImg_=function(e,t,o,n){t=model.data_assets.images+"/"+t;var r=new Image;r.pickey_=e,r.baton_=n,r.mode_=o,r.saveIt_=!1,r.onerror=controller.loadImages_loadFailed_,r.onload=controller.loadImages_loadSuccessful_,n.take(),controller.storage_assets.get(t,function(e){e?controller.storage_assets.get(t,function(e){r.src="data:image/png;base64,"+e.value}):(r.saveIt_=!0,r.src=t)})},controller.loadImages_doIt=util.singleLazyCall(function(e,t){t.take();var o=jWorkflow.order(function(){});util.iterateListByFlow(o,model.data_unitTypes,function(e,t){var o=model.data_unitSheets[this.list[this.i]];o.assets.gfx&&controller.loadImages_prepareImg_(this.list[this.i],o.assets.gfx,"U",t)}),util.iterateListByFlow(o,model.data_tileTypes,function(e,t){var o=this.list[this.i],n=model.data_tileSheets[o];controller.loadImages_prepareImg_(o,n.assets.gfx,"T",t),n.assets.gfxOverlay&&(view.overlayImages[o]=!0),(1===n.assets.animated||2===n.assets.animated)&&(view.animatedTiles[o]=!0)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.gfx&&controller.loadImages_prepareImg_(this.list[this.i],o.assets.gfx,"P",t)}),model.data_tileTypes.forEach(function(e){var t=model.data_tileSheets[e];if(t.assets.gfx_variants){var n=jWorkflow.order(function(){});t.assets.gfx_variants[1].forEach(function(e){n.andThen(function(t,o){controller.loadImages_prepareImg_(e[0],e[0],"T",o)})}),o.andThen(n)}}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.fireAnimation&&controller.loadImages_prepareImg_(o.assets.fireAnimation[0],o.assets.fireAnimation[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.streamAnimation&&controller.loadImages_prepareImg_(o.assets.streamAnimation[0],o.assets.streamAnimation[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.chargeAnimation&&controller.loadImages_prepareImg_(o.assets.chargeAnimation[0],o.assets.chargeAnimation[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.fireAnimation2&&controller.loadImages_prepareImg_(o.assets.fireAnimation2[0],o.assets.fireAnimation2[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.streamAnimation2&&controller.loadImages_prepareImg_(o.assets.streamAnimation2[0],o.assets.streamAnimation2[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.chargeAnimation2&&controller.loadImages_prepareImg_(o.assets.chargeAnimation2[0],o.assets.chargeAnimation2[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.fireAnimation3&&controller.loadImages_prepareImg_(o.assets.fireAnimation3[0],o.assets.fireAnimation3[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.streamAnimation3&&controller.loadImages_prepareImg_(o.assets.streamAnimation3[0],o.assets.streamAnimation3[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.chargeAnimation3&&controller.loadImages_prepareImg_(o.assets.chargeAnimation3[0],o.assets.chargeAnimation3[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.fireAnimation4&&controller.loadImages_prepareImg_(o.assets.fireAnimation4[0],o.assets.fireAnimation4[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.streamAnimation4&&controller.loadImages_prepareImg_(o.assets.streamAnimation4[0],o.assets.streamAnimation4[0],"M",t)}),util.iterateListByFlow(o,model.data_propertyTypes,function(e,t){var o=model.data_tileSheets[this.list[this.i]];o.assets.chargeAnimation4&&controller.loadImages_prepareImg_(o.assets.chargeAnimation4[0],o.assets.chargeAnimation4[0],"M",t)}),util.iterateListByFlow(o,model.data_menu.bgs,function(e,t){controller.loadImages_prepareImg_(this.list[this.i],this.list[this.i],"M",t)}),util.iterateListByFlow(o,model.data_graphics.misc,function(e,t){controller.loadImages_prepareImg_(this.list[this.i][0],this.list[this.i][1],"M",t)}),o.start(function(e){t.pass()})}),controller.loadInputDevices=util.singleLazyCall(function(){var e=document.getElementById("cwt_canvas"),t=document.getElementById("cwt_menu");controller.features_client.keyboard&&controller.setupKeyboardControls(e,t),controller.features_client.gamePad&&controller.setupGamePadControls(e,t),controller.features_client.mouse&&controller.setupMouseControls(e,t),controller.features_client.touch&&controller.setupTouchControls(e,t)}),controller.loadMaps_load_=function(e,t){t.take(),controller.storage_maps.exists(e,function(o){o?t.pass():util.grabRemoteFile({path:model.data_assets.maps+"/"+e,json:!0,error:function(){t.pass()},success:function(o){controller.storage_maps.set(e,o,function(){}),t.pass()}})})},controller.loadMaps_doIt=util.singleLazyCall(function(e,t){var o=jWorkflow.order(function(){t.take()});util.iterateListByFlow(o,model.data_maps,function(e,t){controller.loadMaps_load_(this.list[this.i],t)}),o.start(function(){t.pass()})}),controller.modification_load=util.singleLazyCall(function(e,t){function o(e,t){t.take(),util.grabRemoteFile({path:"http://ctomni231.github.io/cwtactics/mod/cwt/"+e+".json",json:!0,error:function(e){t.drop(e)},success:function(o){a[e]=o,t.pass()}})}function n(e,n){var r=window.navigator.language;r&&"en"!==r?(n.take(),util.grabRemoteFile({path:"http://ctomni231.github.io/cwtactics/mod/cwt//language_"+r+".json",json:!0,error:function(){util.grabRemoteFile({path:"http://ctomni231.github.io/cwtactics/mod/cwt//language.json",json:!0,error:function(e){t.drop({message:e,stack:null})},success:function(e){a.language=e,n.pass()}})},success:function(e){a.language=e,n.pass()}})):o("language",n)}var r="modification_data";t.take();var a;jWorkflow.order().andThen(function(e,t){t.take(),controller.storage_general.get(r,function(e){e?(a=e.value,t.pass(!1)):(a={},t.pass(!0))})}).andThen(function(e,t){return e?(t.take(),jWorkflow.order().andThen(function(e,t){o("header",t)}).andThen(function(e,t){o("co",t)}).andThen(function(e,t){o("fraction",t)}).andThen(function(e,t){o("gamemode",t)}).andThen(function(e,t){o("maps",t)}).andThen(function(e,t){o("movetypes",t)}).andThen(function(e,t){o("globalrules",t)}).andThen(function(e,t){o("sounds",t)}).andThen(function(e,t){o("menu",t)}).andThen(function(e,t){o("tiles",t)}).andThen(function(e,t){o("units",t)}).andThen(function(e,t){o("weathers",t)}).andThen(function(e,t){o("assets",t)}).andThen(function(e,t){o("graphics",t)}).andThen(function(e,t){o("tips",t)}).andThen(n).start(function(e){e?t.drop(e):t.pass(!0)}),void 0):!1}).andThen(function(e,t){e&&(t.take(),controller.storage_general.set(r,a,function(){t.pass()}))}).andThen(function(){model.modification_load(a)}).start(function(e){e?t.drop(e):t.pass()})}),util.scoped(function(){var e,t=[];controller.setupGamePadControls=function(){var t=!!navigator.webkitGetGamepads||!!navigator.webkitGamepads;e=t?!0:!1},controller.updateGamePadControls=function(){if(e)for(var o=navigator.webkitGetGamepads(),n=0,r=4;r>n;n++){var a=o[n];if(a&&(!t[n]||a.timestamp!=t[n])){if(t[n]=a.timestamp,controller.input_blocked)return!1;if(controller.input_genericInputRequest&&"REMAP_GAMEPAD"===controller.screenStateMachine.state){var i=-1;1===a.buttons[0]?i=0:1===a.buttons[1]?i=1:1===a.buttons[2]?i=2:1===a.buttons[3]?i=3:1===a.buttons[4]?i=4:1===a.buttons[5]?i=5:1===a.buttons[6]?i=6:1===a.buttons[7]?i=7:1===a.buttons[8]?i=8:1===a.buttons[9]?i=9:1===a.buttons[10]?i=10:1===a.buttons[11]?i=11:1===a.buttons[12]?i=12:1===a.buttons[13]&&(i=13),i>-1&&controller.screenStateMachine.event("INPUT_SET",i)}else{var s=controller.keyMaps.GAMEPAD,l=controller.keyMaps.KEYBOARD,c=null;a.axes[1]<-.5?c=l.UP:a.axes[1]>.5&&(c=l.DOWN),a.axes[0]<-.5?c=l.LEFT:a.axes[0]>.5&&(c=l.RIGHT),1===a.buttons[s.ACTION]?c=l.ACTION:1===a.buttons[s.CANCEL]&&(c=l.CANCEL),c&&controller.input_pushKey(c,-1,-1)}}}}}),util.scoped(function(){controller.setupKeyboardControls=function(){document.onkeydown=function(e){if(controller.input_blocked)return!1;if(controller.input_genericInputRequest&&"REMAP_KEYBOARD"===controller.screenStateMachine.state)controller.screenStateMachine.event("INPUT_SET",e.keyCode);else{var t=null,o=controller.keyMaps.KEYBOARD;switch(e.keyCode){case o.LEFT:t=controller.DEFAULT_KEY_MAP.KEYBOARD.LEFT;break;case o.UP:t=controller.DEFAULT_KEY_MAP.KEYBOARD.UP;break;case o.RIGHT:t=controller.DEFAULT_KEY_MAP.KEYBOARD.RIGHT;break;case o.DOWN:t=controller.DEFAULT_KEY_MAP.KEYBOARD.DOWN;break;case o.CANCEL:t=controller.DEFAULT_KEY_MAP.KEYBOARD.CANCEL;break;case o.ACTION:t=controller.DEFAULT_KEY_MAP.KEYBOARD.ACTION}}return null!==t&&controller.input_pushKey(t,-1,-1),!1}}}),controller.setupMouseControls=function(){controller.screenElement.addEventListener("mousemove",function(e){{var t,o;e.target.id}e=e||window.event,"number"==typeof e.offsetX?(t=e.offsetX,o=e.offsetY):(t=e.layerX,o=e.layerY),t=parseInt(t/TILE_LENGTH,10),o=parseInt(o/TILE_LENGTH,10),(t!==controller.mapCursorX||o!==controller.mapCursorY)&&controller.input_pushKey(controller.DEFAULT_KEY_MAP.MOUSE.HOVER,t,o)}),controller.screenElement.onmouseup=function(e){if(controller.input_blocked)return!1;var t=controller.DEFAULT_KEY_MAP.KEYBOARD;if(controller.menuVisible)return controller.input_pushKey(t.CANCEL,-1,-1),void 0;switch(e=e||window.event,e.which){case 1:controller.input_pushKey(t.ACTION,-1,-1);break;case 2:break;case 3:controller.input_pushKey(t.CANCEL,-1,-1)}}},controller.setupTouchControls=function(){util.scoped(function(){function e(e,t,o){t=controller.getMapXByScreenX(t),o=controller.getMapXByScreenY(o);var n="MOVEPATH_SELECTION"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state||controller.attackRangeVisible;controller.menuVisible?"cwt_menu"===e.target.id?controller.input_pushKey(controller.keyMaps.KEYBOARD.ACTION,-1,-1):controller.input_pushKey(controller.keyMaps.KEYBOARD.CANCEL,-1,-1):n?controller.stateMachine.data.selection.getValueAt(t,o)>0?controller.input_pushKey(controller.keyMaps.KEYBOARD.ACTION,t,o):controller.input_pushKey(controller.keyMaps.KEYBOARD.CANCEL,t,o):controller.input_pushKey(controller.keyMaps.KEYBOARD.ACTION,t,o)}function t(){controller.input_pushKey(controller.keyMaps.KEYBOARD.CANCEL,-1,-1)}function o(e,t,o){var n=null;1===t&&(n=controller.keyMaps.KEYBOARD.RIGHT),-1===t&&(n=controller.keyMaps.KEYBOARD.LEFT),1===o&&(n=controller.keyMaps.KEYBOARD.DOWN),-1===o&&(n=controller.keyMaps.KEYBOARD.UP),controller.input_pushKey(n,"GAME_ROUND"===controller.screenStateMachine.state?10:1,-1)}function n(e,t,o){var n=null;1===t&&(n=controller.keyMaps.KEYBOARD.RIGHT),-1===t&&(n=controller.keyMaps.KEYBOARD.LEFT),1===o&&(n=controller.keyMaps.KEYBOARD.DOWN),-1===o&&(n=controller.keyMaps.KEYBOARD.UP),controller.input_pushKey(n,1,-1),controller.menuVisible&&("cwt_menu"===e.target.id||controller.input_pushKey(controller.keyMaps.KEYBOARD.CANCEL,-1,-1))}function r(e,t){0>t?controller.setScreenScale(controller.screenScale-1):controller.setScreenScale(controller.screenScale+1)}var a,i,s,l,c,u,d,m,_,p,f,h=0,g=!1;controller.screenElement.addEventListener("touchstart",function(e){if(e.preventDefault(),controller.input_blocked)return!1;if(a=e.touches[0].clientX,i=e.touches[0].clientY,s=a,l=i,g=!1,2===e.touches.length){c=e.touches[1].clientX,u=e.touches[1].clientY,d=c,m=u;var t=Math.abs(a-c),o=Math.abs(i-u);p=Math.sqrt(t*t+o*o)}else c=-1;_=e.timeStamp},!1),controller.screenElement.addEventListener("touchmove",function(e){if(e.preventDefault(),controller.input_blocked)return!1;var t,o;s=e.touches[0].clientX,l=e.touches[0].clientY,2===e.touches.length?(d=e.touches[1].clientX,m=e.touches[1].clientY,t=Math.abs(s-d),o=Math.abs(l-m),f=Math.sqrt(t*t+o*o)):c=-1,t=Math.abs(a-s),o=Math.abs(i-l);var r=Math.sqrt(t*t+o*o),u=e.timeStamp-_;r>16&&u>300&&(g=!0,h>75?(t>o?n(e,a>s?-1:1,0):n(e,0,i>l?-1:1),h=0,a=s,i=l):h+=u)},!1),controller.screenElement.addEventListener("touchend",function(n){if(n.preventDefault(),controller.input_blocked)return!1;if(!(controller.inputCoolDown>0)){var u=Math.abs(a-s),d=Math.abs(i-l),m=Math.sqrt(u*u+d*d),h=n.timeStamp-_;-1!==c?(Math.abs(f-p)<=32?t(n,s,l):r(n,p>f?1:-1),controller.inputCoolDown=500):16>=m?500>=h&&e(n,s,l):300>=h&&(u>d?o(n,a>s?-1:1,0):o(n,0,i>l?-1:1))}},!1)})},util.scoped(function(){var e=util.matrix(61,61,0);controller.attackRangeVisible=!1,controller.showAttackRangeInfo=function(){if(!controller.attackRangeVisible){var t=controller.mapCursorX,o=controller.mapCursorY,n=model.unit_posData[t][o];if(null!==n){var r=model.unit_extractId(n),a=controller.stateMachine.data.selection;if(a.setCenter(t,o,-1),model.battle_isIndirectUnit(r))model.battle_calculateTargets(r,t,o,a);else{controller.stateMachine.data.movePath.move_fillMoveMap(t,o,n),a.data.cloneValues(e),a.setCenter(t,o,-1);for(var i=e.length,s=0;i>s;s++)for(var l=0;i>l;l++)e[s][l]>=0&&model.battle_calculateTargets(r,s,l,a,!0)}controller.attackRangeVisible=!0}}},controller.hideAttackRangeInfo=function(){controller.attackRangeVisible&&(view.redraw_markSelection(controller.stateMachine.data),controller.attackRangeVisible=!1)}}),controller.registerMenuRenderer("buildUnit",function(e,t,o,n){var r=model.data_unitSheets[e].cost;t.innerHTML=n?model.data_localized(e)+" ("+r+" G)":"<span style='color:red;'>"+model.data_localized(e)+" ("+r+" G) </span>"}),util.scoped(function(){var e=(document.getElementById("cwt_game_infoBar"),document.getElementById("game_infobox_damage")),t=document.getElementById("game_infobox_damage_holder"),o=document.getElementById("infoBox_unitRow1"),n=document.getElementById("infoBox_unitRow2"),r=document.getElementById("infoBox_unitRow3"),a=document.getElementById("infoBox_name"),i=document.getElementById("infoBox_hp"),s=document.getElementById("infoBox_fuel"),l=document.getElementById("infoBox_ammo"),c=document.getElementById("infoBox_fuel2"),u=document.getElementById("infoBox_ammo2"),d=document.getElementById("infoBox_attrange"),m=document.getElementById("infoBox_attrange2"),_=document.getElementById("infoBox_hp_d"),p=document.getElementById("infoBox_pr_hp_d"),f=document.getElementById("infoBox_fuel_d"),h=document.getElementById("infoBox_ammo_d"),g=document.getElementById("infoBox_attrange_d"),v=document.getElementById("infoBox_playerName"),E=document.getElementById("infoBox_playerpower"),w=document.getElementById("infoBox_playergold"),I=(document.getElementById("infoBox_tileRow1"),document.getElementById("infoBox_tileRow2"),document.getElementById("infoBox_tileRow2d2")),T=document.getElementById("infoBox_tilename"),M=document.getElementById("infoBox_defense_d"),y=document.getElementById("infoBox_defense"),A=document.getElementById("infoBox_capPt_d"),S=document.getElementById("infoBox_capPt"),O=document.getElementById("infoBox_capPt2"),C=!1,b=!0;controller.sideSimpleTileInformationPanel=-1,controller.moveSimpleTileInformationToLeft=function(){controller.sideSimpleTileInformationPanel<0||(controller.sideSimpleTileInformationPanel=-1)},controller.moveSimpleTileInformationToRight=function(){controller.sideSimpleTileInformationPanel>0||(controller.sideSimpleTileInformationPanel=1)},controller.updateSimpleTileInformation=function(L){var k,P=controller.mapCursorX,D=controller.mapCursorY,R=model.unit_posData[P][D],N=model.property_posMap[P][D];if(C||(_.getContext("2d").drawImage(view.getInfoImageForType("SYM_HP"),0,0),p.getContext("2d").drawImage(view.getInfoImageForType("SYM_HP"),0,0),f.getContext("2d").drawImage(view.getInfoImageForType("SYM_FUEL"),0,0),h.getContext("2d").drawImage(view.getInfoImageForType("SYM_AMMO"),0,0),g.getContext("2d").drawImage(view.getInfoImageForType("SYM_ATT"),0,0),M.getContext("2d").drawImage(view.getInfoImageForType("SYM_DEFENSE"),0,0),A.getContext("2d").drawImage(view.getInfoImageForType("SYM_CAPTURE"),0,0),C=!0),R){k=R.type,a.innerHTML=model.data_localized(k.ID),i.innerHTML=model.unit_convertHealthToPoints(R.hp),s.innerHTML=R.fuel,c.innerHTML=k.fuel,l.innerHTML=R.ammo,u.innerHTML=k.ammo;var x=k.attack;x?(d.innerHTML=x.minrange||1,m.innerHTML=x.maxrange||1):(d.innerHTML="",m.innerHTML=""),a.style.opacity=1,o.style.opacity=1,n.style.opacity=1,r.style.opacity=1}else a.style.opacity=0,o.style.opacity=0,n.style.opacity=0,r.style.opacity=0;N?(k=N.type,T.innerHTML=model.data_localized(k.ID),S.innerHTML=N.capturePoints,N.capturePoints<0?b||(p.style.display="none",A.style.display="",b=!0):b&&(p.style.display="",A.style.display="none",b=!1),O.innerHTML=20,y.innerHTML=k.defense,I.style.opacity=1):(k=model.map_data[P][D],T.innerHTML=model.data_localized(k.ID),y.innerHTML=k.defense,I.style.opacity=0),k=null;var B=-1;B=R?R.owner:N&&-1!==N.owner?N.owner:model.round_turnOwner,B>-1?(k=model.player_data[B],v.innerHTML=k.name,w.innerHTML=k.gold,E.innerHTML=model.co_data[B].power):(v.innerHTML="",w.innerHTML="",E.innerHTML=""),L>=0?(t.style.display="block",e.innerHTML=L):t.style.display="none"}}),controller.updateComplexTileInformation=function(){},controller.registerMenuRenderer("__mainMenu__",function(e,t){t.innerHTML=model.data_localized(e)}),controller.registerMenuRenderer("team_transferMoney",function(e,t){t.innerHTML=e+"$"}),util.scoped(function(){var e=function(e,t){t.innerHTML=model.player_data[e].name};controller.registerMenuRenderer("transferProperty",e),controller.registerMenuRenderer("transferUnit",e)}),controller.registerMenuRenderer("unloadUnit",function(e,t){t.innerHTML="done"===e?model.data_localized("done"):model.data_localized(model.unit_data[e].type.ID)}),util.scoped(function(){function e(e,t,n,r){if(n-=r-1,!(0>n||n>9)){var a=TILE_LENGTH,i=48*n,s=0,l=48,c=48,u=e*a,d=t*a,m=a,_=a;view.canvasCtx.drawImage(o,i,s,l,c,u,d,m,_),view.redraw_markPos(e,t)}}function t(e,t){if(model.map_isValidPosition(e,t)){var o=model.unit_posData[e][t];null!==o&&controller.updateUnitStatus(model.unit_extractId(o))}}var o,n,r;view.registerAnimationHook({key:"rocketFly",prepare:function(e,t,o,a){n||(n=view.getInfoImageForType("FLYING_ROCKET")),r||(r=view.getInfoImageForType("FLYING_ROCKET_INV")),this.siloX=controller.getCanvasPosX(e),this.siloY=controller.getCanvasPosY(t),this.targetX=controller.getCanvasPosX(o),this.targetY=controller.getCanvasPosY(a),this.curX=this.siloX,this.curY=this.siloY,this.phase=0},render:function(){var e=TILE_LENGTH,t=0,o=0,a=24,i=24,s=this.curX,l=this.curY,c=e+8,u=e+8;0>l&&(a+=l,o-=l,l=0),view.canvasCtx.drawImage(0===this.phase?n:r,t,o,a,i,s,l,c,u),view.redraw_markPosWithNeighboursRing(parseInt(this.curX/TILE_LENGTH,10),parseInt(this.curY/TILE_LENGTH,10))},update:function(e){var t=e/1e3*14*TILE_LENGTH;0===this.phase?(this.curY-=t,this.curY<=0&&(this.curX=this.targetX,this.curY=0,this.phase=1)):(this.curY+=t,this.curY>=this.targetY&&(this.phase=2))},isDone:function(){return 2===this.phase}}),view.registerAnimationHook({key:"explode_invoked",prepare:function(e,t,n){o||(o=view.getInfoImageForType("EXPLOSION_GROUND")),controller.audio_playSound("ROCKET_IMPACT"),this.x=e,this.y=t,this.range=n,this.maxStep=10+n+1,this.step=0,this.time=0},render:function(){model.map_doInRange(this.x,this.y,this.range,e,this.step)},update:function(e){this.time+=e,this.time>75&&(this.step++,this.time=0)},isDone:function(){var e=this.step===this.maxStep;return e&&model.map_doInRange(this.x,this.y,this.range,t),e}}),view.registerAnimationHook({key:"bombs_fireCannon",prepare:function(e,t,o,n,r){var a=model.data_tileSheets[r],i=a.assets.fireAnimation;assert(5===i.length),this.pic=view.getInfoImageForType(i[0]),this.sizeX=i[1],this.sizeY=i[2],this.offsetX=i[3],this.offsetY=i[4],this.curX=e,this.curY=t,this.step=0,this.time=0,controller.audio_playSound(a.assets.fireSound)},render:function(){var e=TILE_LENGTH,t=this.sizeX*this.step,o=0,n=this.sizeX,r=this.sizeY,a=this.curX*e+this.offsetX,i=this.curY*e+this.offsetY,s=this.sizeX,l=this.sizeY;view.canvasCtx.drawImage(this.pic,t,o,n,r,a,i,s,l)},update:function(e){this.time+=e,this.time>100&&(this.step++,this.time=0)},isDone:function(){return 6===this.step}}),view.registerAnimationHook({key:"bombs_fireLaser",prepare:function(e,t){var o=model.property_posMap[e][t].type,n=o.assets.chargeAnimation,r=o.assets.fireAnimation,a=o.assets.streamAnimation;assert(5===n.length),assert(5===r.length),assert(5===a.length),this.a={pic:view.getInfoImageForType(n[0]),sizeX:r[1],sizeY:r[2],offsetX:r[3],offsetY:r[4]},this.b={pic:view.getInfoImageForType(r[0]),sizeX:n[1],sizeY:n[2],offsetX:n[3],offsetY:n[4]},this.c={pic:view.getInfoImageForType(a[0]),sizeX:a[1],sizeY:a[2],offsetX:a[3],offsetY:a[4]},n=o.assets.chargeAnimation3,r=o.assets.fireAnimation3,a=o.assets.streamAnimation3,assert(5===n.length),assert(5===r.length),assert(5===a.length),this.a2={pic:view.getInfoImageForType(n[0]),sizeX:r[1],sizeY:r[2],offsetX:r[3],offsetY:r[4]},this.b2={pic:view.getInfoImageForType(r[0]),sizeX:n[1],sizeY:n[2],offsetX:n[3],offsetY:n[4]},this.c2={pic:view.getInfoImageForType(a[0]),sizeX:a[1],sizeY:a[2],offsetX:a[3],offsetY:a[4]},n=o.assets.chargeAnimation2,r=o.assets.fireAnimation2,a=o.assets.streamAnimation2,assert(5===n.length),assert(5===r.length),assert(5===a.length),this.a3={pic:view.getInfoImageForType(n[0]),sizeX:r[1],sizeY:r[2],offsetX:r[3],offsetY:r[4]},this.b3={pic:view.getInfoImageForType(r[0]),sizeX:n[1],sizeY:n[2],offsetX:n[3],offsetY:n[4]},this.c3={pic:view.getInfoImageForType(a[0]),sizeX:a[1],sizeY:a[2],offsetX:a[3],offsetY:a[4]},n=o.assets.chargeAnimation4,r=o.assets.fireAnimation4,a=o.assets.streamAnimation4,assert(5===n.length),assert(5===r.length),assert(5===a.length),this.a4={pic:view.getInfoImageForType(n[0]),sizeX:r[1],sizeY:r[2],offsetX:r[3],offsetY:r[4]},this.b4={pic:view.getInfoImageForType(r[0]),sizeX:n[1],sizeY:n[2],offsetX:n[3],offsetY:n[4]},this.c4={pic:view.getInfoImageForType(a[0]),sizeX:a[1],sizeY:a[2],offsetX:a[3],offsetY:a[4]},this.curX=e,this.curY=t,this.phase=0,this.step=0,this.time=0,controller.audio_playSound(o.assets.fireSound)},render:function(){var e=0===this.phase?this.a:this.b,t=0===this.phase?this.a2:this.b2,o=0===this.phase?this.a3:this.b3,n=0===this.phase?this.a4:this.b4,r=TILE_LENGTH,a=e.sizeX*this.step,i=0,s=e.sizeX,l=e.sizeY,c=this.curX*r+e.offsetX,u=this.curY*r+e.offsetY,d=e.sizeX,m=e.sizeY;if(view.canvasCtx.drawImage(e.pic,a,i,s,l,c,u,d,m),r=TILE_LENGTH,a=t.sizeX*this.step,i=0,s=t.sizeX,l=t.sizeY,c=this.curX*r+t.offsetX,u=this.curY*r+t.offsetY,d=t.sizeX,m=t.sizeY,view.canvasCtx.drawImage(t.pic,a,i,s,l,c,u,d,m),r=TILE_LENGTH,a=o.sizeX*this.step,i=0,s=o.sizeX,l=o.sizeY,c=this.curX*r+o.offsetX,u=this.curY*r+o.offsetY,d=o.sizeX,m=o.sizeY,view.canvasCtx.drawImage(o.pic,a,i,s,l,c,u,d,m),r=TILE_LENGTH,a=n.sizeX*this.step,i=0,s=n.sizeX,l=n.sizeY,c=this.curX*r+n.offsetX,u=this.curY*r+n.offsetY,d=n.sizeX,m=n.sizeY,view.canvasCtx.drawImage(n.pic,a,i,s,l,c,u,d,m),view.redraw_markPosWithNeighboursRing(this.curX,this.curY),e===this.b){e=this.c,t=this.c2,o=this.c3,n=this.c4,a=e.sizeX*this.step,i=0,s=e.sizeX,l=e.sizeY;for(var _=this.curX+1,p=model.map_width;p>_;_++)c=_*r+e.offsetX,u=this.curY*r+e.offsetY,d=e.sizeX,m=e.sizeY,view.canvasCtx.drawImage(e.pic,a,i,s,l,c,u,d,m),view.redraw_markPos(_,this.curY-1),view.redraw_markPos(_,this.curY),view.redraw_markPos(_,this.curY+1);a=t.sizeX*this.step,i=0,s=t.sizeX,l=t.sizeY;for(var _=this.curX-1,p=0;_>=p;_--)c=_*r+t.offsetX,u=this.curY*r+t.offsetY,d=t.sizeX,m=t.sizeY,view.canvasCtx.drawImage(t.pic,a,i,s,l,c,u,d,m),view.redraw_markPos(_,this.curY-1),view.redraw_markPos(_,this.curY),view.redraw_markPos(_,this.curY+1);
a=o.sizeX*this.step,i=0,s=o.sizeX,l=o.sizeY;for(var _=this.curY+1,p=model.map_height;p>_;_++)c=this.curX*r+o.offsetX,u=_*r+o.offsetY,d=o.sizeX,m=o.sizeY,view.canvasCtx.drawImage(o.pic,a,i,s,l,c,u,d,m),view.redraw_markPos(this.curX+1,_),view.redraw_markPos(this.curX,_),view.redraw_markPos(this.curX-1,_);a=n.sizeX*this.step,i=0,s=n.sizeX,l=n.sizeY;for(var _=this.curY-1,p=0;_>=0;_--)c=this.curX*r+n.offsetX,u=_*r+n.offsetY,d=n.sizeX,m=n.sizeY,view.canvasCtx.drawImage(n.pic,a,i,s,l,c,u,d,m),view.redraw_markPos(this.curX+1,_),view.redraw_markPos(this.curX,_),view.redraw_markPos(this.curX-1,_)}},update:function(e){if(this.time+=e,this.time>100)switch(this.step++,this.time=0,this.phase){case 0:10===this.step&&(this.step=0,this.phase++);case 1:12===this.step&&(this.step=0,this.phase++)}},isDone:function(){return 2===this.phase}})}),view.registerAnimationHook({key:"capture_invoked",prepare:function(e,t){controller.updateUnitStatus(t);var o=model.property_data[e];model.fog_clientData[o.x][o.y]>0&&(20===o.capturePoints?view.showInfoMessage(model.data_localized("propertyCaptured")):view.showInfoMessage(model.data_localized("propertyPointsLeft")+" "+o.capturePoints))},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerAnimationHook({key:"weather_change",prepare:function(e){view.showInfoMessage(model.data_localized("weatherChange")+" "+model.data_localized(e))},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerAnimationHook({key:"destroyUnit",prepare:function(e){var t=model.unit_data[e];this.step=0,this.time=0,this.x=-t.x,this.y=-t.y,controller.audio_playSound("EXPLODE")},render:function(){var e=this.step,t=view.getInfoImageForType("EXPLOSION_GROUND"),o=this.x,n=this.y,r=TILE_LENGTH,a=48*e,i=0,s=48,l=48,c=o*r,u=n*r,d=r,m=r;view.canvasCtx.drawImage(t,a,i,s,l,c,u,d,m),view.redraw_markPos(o,n)},update:function(e){this.time+=e,this.time>75&&(this.step++,this.time=0)},isDone:function(){return 10===this.step}}),model.event_on("modifyVisionAt",function(e,t,o,n){n=10;var r,a,i=t-n,s=t+n;for(0>i&&(i=0),s>=model.map_height&&(s=model.map_height-1);s>=i;i++){var l=Math.abs(i-t);for(r=e-n+l,a=e+n-l,0>r&&(r=0),a>=model.map_width&&(a=model.map_width-1);a>=r;r++){view.redraw_markPos(r,i);var c=model.unit_posData[r][i];null!==c&&c.hidden&&controller.updateUnitStatus(model.unit_extractId(c))}}}),model.event_on("recalculateFogMap",function(){view.redraw_markAll()}),view.registerAnimationHook({key:"move_moveByCache",prepare:function(e,t,o){this.moveAnimationX=t,this.moveAnimationY=o,this.moveAnimationIndex=0,this.moveAnimationPath=model.move_pathCache,this.moveAnimationUid=e,this.moveAnimationClientOwned=model.fog_visibleClientPids[model.unit_data[e].owner],this.moveAnimationShift=0,this.moveAnimationDustX=-1,this.moveAnimationDustY=-1,this.moveAnimationDustTime=-1,this.moveAnimationDustStep=-1,this.moveAnimationDustPic=null,view.preventRenderUnit=model.unit_data[e];model.unit_data[e].type.movetype},update:function(e){var t=TILE_LENGTH;if(this.moveAnimationShift+=e/1e3*8*t,view.redraw_markPosWithNeighboursRing(this.moveAnimationX,this.moveAnimationY),-1!==this.moveAnimationDustStep&&(this.moveAnimationDustTime+=e,this.moveAnimationDustTime>30&&(this.moveAnimationDustStep++,this.moveAnimationDustTime=0,3===this.moveAnimationDustStep&&(this.moveAnimationDustStep=-1))),this.moveAnimationShift>t){switch(this.moveAnimationDustX=this.moveAnimationX,this.moveAnimationDustY=this.moveAnimationY,this.moveAnimationDustTime=0,this.moveAnimationDustStep=0,this.moveAnimationPath[this.moveAnimationIndex]){case model.move_MOVE_CODES.UP:this.moveAnimationY--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_U");break;case model.move_MOVE_CODES.RIGHT:this.moveAnimationX++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_R");break;case model.move_MOVE_CODES.DOWN:this.moveAnimationY++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_D");break;case model.move_MOVE_CODES.LEFT:this.moveAnimationX--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_L")}this.moveAnimationIndex++,this.moveAnimationShift-=t,(this.moveAnimationIndex===this.moveAnimationPath.length||-1===this.moveAnimationPath[this.moveAnimationIndex])&&(this.moveAnimationX=0,this.moveAnimationY=0,this.moveAnimationIndex=0,this.moveAnimationPath=null,this.moveAnimationUid=-1,this.moveAnimationShift=0,view.preventRenderUnit=null)}},render:function(){var e,t=this.moveAnimationUid,o=this.moveAnimationX,n=this.moveAnimationY,r=this.moveAnimationShift,a=this.moveAnimationPath[this.moveAnimationIndex],i=model.unit_data[t],s=view.colorArray[i.owner],l=i.type;if(this.moveAnimationClientOwned||model.fog_clientData[o][n]){switch(a){case model.move_MOVE_CODES.UP:e=view.IMAGE_CODE_UP;break;case model.move_MOVE_CODES.RIGHT:e=view.IMAGE_CODE_RIGHT;break;case model.move_MOVE_CODES.DOWN:e=view.IMAGE_CODE_DOWN;break;case model.move_MOVE_CODES.LEFT:e=view.IMAGE_CODE_LEFT}var c=view.getUnitImageForType(l.ID,e,s),u=TILE_LENGTH,d=controller.baseSize,m=2*d*view.getSpriteStep("UNIT"),_=0,p=2*d,f=2*d,h=o*u-u/2,g=n*u-u/2,v=u+u,E=u+u;switch(a){case model.move_MOVE_CODES.UP:g-=r;break;case model.move_MOVE_CODES.LEFT:h-=r;break;case model.move_MOVE_CODES.RIGHT:h+=r;break;case model.move_MOVE_CODES.DOWN:g+=r}if(void 0!==c)view.canvasCtx.drawImage(c,m,_,p,f,h,g,v,v);else{switch(h=o*u,g=n*u,v=u,E=u,a){case model.move_MOVE_CODES.UP:g-=r;break;case model.move_MOVE_CODES.LEFT:h-=r;break;case model.move_MOVE_CODES.RIGHT:h+=r;break;case model.move_MOVE_CODES.DOWN:g+=r}view.canvasCtx.fillStyle="rgb(255,0,0)",view.canvasCtx.fillRect(h,g,v,E)}if(-1!==this.moveAnimationDustStep){var u=TILE_LENGTH;m=2*d*this.moveAnimationDustStep,_=0,p=2*d,f=2*d,h=this.moveAnimationDustX*u-u/2,g=this.moveAnimationDustY*u-u/2,v=u+u,E=u+u,view.canvasCtx.drawImage(this.moveAnimationDustPic,m,_,p,f,h,g,v,E)}}},isDone:function(){var e=-1===this.moveAnimationUid;return e}}),model.event_on("multistep_next",function(){"IDLE"!==controller.stateMachine.state&&controller.showMenu(controller.stateMachine.data.menu,controller.mapCursorX,controller.mapCursorY)}),util.scoped(function(){view.registerAnimationHook({key:"nextTurn_invoked",prepare:function(){if(view.showInfoMessage(model.data_localized("day")+" "+model.round_day+" - "+model.player_data[model.round_turnOwner].name,999999999),controller.features_client.audioMusic){var e=model.co_data[model.round_turnOwner].coA;controller.coMusic_playCoMusic(e?e.music:null)}else view.message_closePanel(1e3)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}})}),model.event_on("transferMoney_invoked",function(){controller.updateSimpleTileInformation()}),model.event_on("transferUnit_invoked",function(e){var t=model.unit_data[e],o=-t.x,n=-t.y;controller.updateUnitStatus(model.unit_extractId(model.unit_posData[o][n]))}),view.registerAnimationHook({key:"trapwait_invoked",prepare:function(e){var t=model.unit_data[e];this.time=0,this.xp=t.x+1,this.yp=t.y,this.x=(t.x+1)*TILE_LENGTH,this.y=t.y*TILE_LENGTH},render:function(){var e=view.getInfoImageForType("TRAPPED");view.canvasCtx.drawImage(e,this.x,this.y)},update:function(e){this.time+=e},isDone:function(){var e=this.time>1e3;if(e)for(var t=view.getInfoImageForType("TRAPPED"),o=this.yp,n=this.xp,r=n+parseInt(t.width/TILE_LENGTH,10);r>=n;n++)view.redraw_markPos(n,o);return e}}),model.event_on("damageUnit",function(e){controller.updateUnitStatus(e)}),model.event_on("healUnit",function(e){controller.updateUnitStatus(e)}),model.event_on("attack_invoked",function(e,t){controller.updateSimpleTileInformation(),controller.updateUnitStatus(e),controller.updateUnitStatus(t)}),model.event_on("buildUnit_invoked",function(){controller.updateSimpleTileInformation()}),model.event_on("createUnit",function(e){controller.updateUnitStatus(e)}),model.event_on("loadUnit_invoked",function(e,t){controller.updateUnitStatus(t)}),model.event_on("unloadUnit_invoked",function(e){controller.updateUnitStatus(e)}),model.event_on("joinUnits_invoked",function(e,t){controller.updateUnitStatus(t)}),model.event_on("supply_refillResources",function(e){"number"==typeof e.x&&(e=model.unit_extractId(e)),controller.updateUnitStatus(e)}),model.event_on("clearUnitPosition",function(e){var t=model.unit_data[e],o=-t.x,n=-t.y;model.map_isValidPosition(o-1,n)&&model.unit_posData[o-1][n]&&controller.updateUnitStatus(model.unit_extractId(model.unit_posData[o-1][n])),model.map_isValidPosition(o+1,n)&&model.unit_posData[o+1][n]&&controller.updateUnitStatus(model.unit_extractId(model.unit_posData[o+1][n])),model.map_isValidPosition(o,n+1)&&model.unit_posData[o][n+1]&&controller.updateUnitStatus(model.unit_extractId(model.unit_posData[o][n+1])),model.map_isValidPosition(o,n-1)&&model.unit_posData[o][n-1]&&controller.updateUnitStatus(model.unit_extractId(model.unit_posData[o][n-1]))}),model.event_on("setUnitPosition",function(e){controller.updateUnitStatus(e)}),model.event_on("unitHide_invoked",function(e){controller.updateUnitStatus(e)}),model.event_on("unitUnhide_invoked",function(e){controller.updateUnitStatus(e)}),util.scoped(function(){function e(e){return function(){if(controller.errorPanelVisible){if("LEFT"===e)controller.errorButtons.decreaseIndex();else if("RIGHT"===e)controller.errorButtons.increaseIndex();else if("ACTION"===e){var t=controller.errorButtons.getActiveKey();"error.panel.yes"===t?controller.storage_general.clear(function(){controller.storage_assets.clear(function(){controller.storage_maps.clear(function(){window.location.reload()})})}):window.location.reload()}return this.breakTransition()}var o=this.structure[this.state][e];return o?o.apply(this,arguments):this.breakTransition()}}controller.stateParent={onenter:function(){return controller.openSection(this.structure[this.state].section),this.structure[this.state].enterState?this.structure[this.state].enterState.apply(this,arguments):void 0},INP_UP:e("UP"),INP_LEFT:e("LEFT"),INP_RIGHT:e("RIGHT"),INP_DOWN:e("DOWN"),INP_ACTION:e("ACTION"),INP_CANCEL:e("CANCEL"),INP_HOVER:e("HOVER"),onerror:controller.haltEngine}}),util.scoped(function(){function e(){document.location.reload()}var t=controller.generateButtonGroup(document.getElementById("cwt_confirmWipeOut_screen"),"cwt_panel_header_small cwt_page_button w_400 cwt_panel_button","cwt_panel_header_small cwt_page_button w_400 cwt_panel_button button_active","cwt_panel_header_small cwt_page_button w_400 cwt_panel_button button_inactive");controller.screenStateMachine.structure.WIPEOUT=Object.create(controller.stateParent),controller.screenStateMachine.structure.WIPEOUT.section="cwt_confirmWipeOut_screen",controller.screenStateMachine.structure.WIPEOUT.enterState=function(){},controller.screenStateMachine.structure.WIPEOUT.UP=function(){return this.breakTransition()},controller.screenStateMachine.structure.WIPEOUT.DOWN=function(){return this.breakTransition()},controller.screenStateMachine.structure.WIPEOUT.LEFT=function(){return"options.doit"===t.getActiveKey()&&t.decreaseIndex(),this.breakTransition()},controller.screenStateMachine.structure.WIPEOUT.RIGHT=function(){return"options.goBack"===t.getActiveKey()&&t.increaseIndex(),this.breakTransition()},controller.screenStateMachine.structure.WIPEOUT.ACTION=function(){switch(t.getActiveKey()){case"options.doit":controller.storage_general.set("cwt_resetData",!0,e);break;case"options.goBack":return"OPTIONS"}return this.breakTransition()},controller.screenStateMachine.structure.WIPEOUT.CANCEL=function(){return"OPTIONS"}}),util.scoped(function(){var e=!1,t=!1;controller.screenStateMachine.structure.GAMEROUND=Object.create(controller.stateParent),controller.screenStateMachine.structure.GAMEROUND.section="cwt_game_screen",controller.screenStateMachine.structure.GAMEROUND.enterState=function(){if(e!==!0){controller.audio_stopMusic(),controller.setCursorPosition(0,0),controller.update_startGameRound();for(var o=0,n=model.unit_data.length;n>o;o++)-1!==model.unit_data[o].owner&&controller.updateUnitStatus(o);view.resizeCanvas(),view.updateMapImages(),view.redraw_markAll(),controller.setScreenScale(2),controller.inGameLoop=!0,controller.prepareGameLoop()}e=!1,t=!1},controller.screenStateMachine.structure.GAMEROUND.gameHasEnded=function(){return controller.inGameLoop=!1,"MAIN"},controller.screenStateMachine.structure.GAMEROUND.LEFT=function(e,t){var o=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.breakTransition()):(t||(t=1),1===t?controller.moveCursor(model.move_MOVE_CODES.LEFT,t):controller.shiftScreenPosition(model.move_MOVE_CODES.LEFT,t),this.breakTransition())},controller.screenStateMachine.structure.GAMEROUND.RIGHT=function(e,t){var o=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.breakTransition()):(t||(t=1),1===t?controller.moveCursor(model.move_MOVE_CODES.RIGHT,t):controller.shiftScreenPosition(model.move_MOVE_CODES.RIGHT,t),this.breakTransition())},controller.screenStateMachine.structure.GAMEROUND.UP=function(e,t){var o=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.breakTransition();var n="ACTION_MENU"===o||"ACTION_SUBMENU"===o;return t||(t=1),n?controller.decreaseMenuCursor():1===t?controller.moveCursor(model.move_MOVE_CODES.UP,t):controller.shiftScreenPosition(model.move_MOVE_CODES.UP,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.DOWN=function(e,t){var o=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.breakTransition();var n="ACTION_MENU"===o||"ACTION_SUBMENU"===o;return t||(t=1),n?controller.increaseMenuCursor():1===t?controller.moveCursor(model.move_MOVE_CODES.DOWN,t):controller.shiftScreenPosition(model.move_MOVE_CODES.DOWN,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SHIFT_DOWN=function(e,t){return controller.shiftScreenPosition(model.move_MOVE_CODES.DOWN,t),controller.moveCursor(model.move_MOVE_CODES.DOWN,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SHIFT_UP=function(e,t){return controller.shiftScreenPosition(model.move_MOVE_CODES.UP,t),controller.moveCursor(model.move_MOVE_CODES.UP,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SHIFT_LEFT=function(e,t){return controller.shiftScreenPosition(model.move_MOVE_CODES.LEFT,t),controller.moveCursor(model.move_MOVE_CODES.LEFT,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SHIFT_RIGHT=function(e,t){return controller.shiftScreenPosition(model.move_MOVE_CODES.RIGHT,t),controller.moveCursor(model.move_MOVE_CODES.RIGHT,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.ACTION=function(e,t,o){var n=controller.stateMachine.state;return"IDLE"===n&&controller.attackRangeVisible?(controller.hideAttackRangeInfo(),this.breakTransition()):("number"==typeof t&&controller.setCursorPosition(t,o),controller.cursorActionClick(),this.breakTransition())},controller.screenStateMachine.structure.GAMEROUND.HOVER=function(e,t,o){return controller.setCursorPosition(t,o,!1,!0),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.CANCEL=function(e,o,n){if(!controller.menuVisible){var r,a;if(1===arguments.length?(r=controller.mapCursorX,a=controller.mapCursorY):(r=o,a=n),t)return controller.minimap_hideIngameMinimap(),t=!1,this.breakTransition();var i=model.property_posMap[r][a],s=model.unit_posData[r][a];if("IDLE"===controller.stateMachine.state&&(!model.fog_turnOwnerData[r][a]||!i&&!s))return controller.minimap_showIngameMinimap(),t=!0,this.breakTransition()}var l=controller.stateMachine.state;if("IDLE"===l){if(controller.attackRangeVisible)return controller.hideAttackRangeInfo(),this.breakTransition();var s=model.unit_posData[controller.mapCursorX][controller.mapCursorY];if(s)return controller.showAttackRangeInfo(),this.breakTransition()}return"number"==typeof o&&controller.setCursorPosition(o,n),controller.cursorActionCancel(),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.toOptions_=function(){return assert(2===arguments.length&&arguments[1]===!0),e=!0,"OPTIONS"}}),controller.screenStateMachine.structure.LOAD=Object.create(controller.stateParent),controller.screenStateMachine.structure.LOAD.section="cwt_load_screen",controller.screenStateMachine.structure.LOAD.enterState=function(){controller.dataLoader_start(document.getElementById("loading_text"),document.getElementById("loading_bar"))},controller.screenStateMachine.structure.LOAD.complete=function(){return"MOBILE"},controller.screenStateMachine.structure.LOAD.onerror=controller.haltEngine,util.scoped(function(){var e=document.getElementById("cwt_main_screen"),t=controller.generateButtonGroup(e,"cwt_panel_header_big cwt_page_button w_400 cwt_panel_button","cwt_panel_header_big cwt_page_button w_400 cwt_panel_button button_active","cwt_panel_header_big cwt_page_button w_400 cwt_panel_button button_inactive");document.getElementById("mainScreen_version").innerHTML="0.3.6",controller.screenStateMachine.structure.MAIN=Object.create(controller.stateParent),controller.screenStateMachine.structure.MAIN.section="cwt_main_screen",controller.screenStateMachine.structure.MAIN.enterState=function(){controller.audio_playNullSound(),controller.features_client.audioMusic&&controller.audio_playMusic(model.data_menu.music),t.setIndex(1)},controller.screenStateMachine.structure.MAIN.UP=function(){return t.decreaseIndex(),this.breakTransition()},controller.screenStateMachine.structure.MAIN.DOWN=function(){return t.increaseIndex(),this.breakTransition()},controller.screenStateMachine.structure.MAIN.ACTION=function(){var e,o;return t.isIndexInactive()?(o=model.data_sounds.CANCEL,e=this.breakTransition()):(o=model.data_sounds.MENUTICK,e=t.getActiveKey()),controller.audio_playSound(o),e}}),controller.screenStateMachine.structure.NONE=Object.create(controller.stateParent),controller.screenStateMachine.structure.NONE.section=null,controller.screenStateMachine.structure.NONE.start=function(){controller.hideMenu();var e=document.getElementById("DELTA"),t=document.getElementById("DELTA2"),o=0,n=0,r=0,a=!1;return function(){function i(){var l=(new Date).getTime(),c=l-s;s=l,c>32&&(a?o++:n++,e.innerHTML=o,t.innerHTML=n),a=!a,controller.updateInputCoolDown(c),controller.updateGamePadControls(c);var u=controller.input_evalNextKey();controller.inGameLoop&&(controller.update_inGameRound?controller.gameLoop(c,a,u):controller.screenStateMachine.event("gameHasEnded")),r=c,"MOBILE"===controller.screenStateMachine.state&&controller.screenStateMachine.event("decreaseTimer",c),requestAnimationFrame(i)}var s=(new Date).getTime();requestAnimationFrame(i)}(),"LOAD"},util.scoped(function(){function e(){controller.screenStateMachine.structure.OPTIONS.forceTouch=!controller.screenStateMachine.structure.OPTIONS.forceTouch,t()}function t(){l.innerHTML=controller.screenStateMachine.structure.OPTIONS.forceTouch?model.data_localized("yes"):model.data_localized("no")}function o(){controller.screenStateMachine.structure.OPTIONS.animatedTiles=!controller.screenStateMachine.structure.OPTIONS.animatedTiles,n()}function n(){c.innerHTML=controller.screenStateMachine.structure.OPTIONS.animatedTiles?model.data_localized("yes"):model.data_localized("no")}function r(){i.innerHTML=Math.round(100*controller.audio_getSfxVolume()),s.innerHTML=Math.round(100*controller.audio_getMusicVolume())}var a,i=document.getElementById("cwt_options_sfxVolume"),s=document.getElementById("cwt_options_musicVolume"),l=document.getElementById("cwt_options_forceTouch"),c=document.getElementById("cwt_options_animatedTiles"),u=controller.generateButtonGroup(document.getElementById("cwt_options_screen"),"cwt_panel_header_small cwt_page_button w_400 cwt_panel_button","cwt_panel_header_small cwt_page_button w_400 cwt_panel_button button_active","cwt_panel_header_small cwt_page_button w_400 cwt_panel_button button_inactive");controller.screenStateMachine.structure.OPTIONS=Object.create(controller.stateParent),controller.screenStateMachine.structure.OPTIONS.forceTouch=!1,controller.screenStateMachine.structure.OPTIONS.animatedTiles=!0,controller.screenStateMachine.structure.OPTIONS.section="cwt_options_screen",controller.screenStateMachine.structure.OPTIONS.enterState=function(e,o){a=a||o===!0?!0:!1,r(),t(),n(),u.setIndex(1)},controller.screenStateMachine.structure.OPTIONS.UP=function(){switch(u.getActiveKey()){case"options.sfx.up":case"options.music.up":case"options.music.down":u.decreaseIndex(),u.decreaseIndex();break;default:u.decreaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.OPTIONS.DOWN=function(){switch(u.getActiveKey()){case"options.sfx.up":case"options.sfx.down":case"options.music.down":u.increaseIndex(),u.increaseIndex();break;default:u.increaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.OPTIONS.LEFT=function(){switch(u.getActiveKey()){case"options.sfx.up":case"options.music.up":u.increaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.OPTIONS.RIGHT=function(){switch(u.getActiveKey()){case"options.sfx.down":case"options.music.down":u.increaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.OPTIONS.ACTION=function(){switch(u.getActiveKey()){case"options.sfx.down":controller.audio_setSfxVolume(controller.audio_getSfxVolume()-.05),r();break;case"options.sfx.up":controller.audio_setSfxVolume(controller.audio_getSfxVolume()+.05),r();break;case"options.music.down":controller.audio_setMusicVolume(controller.audio_getMusicVolume()-.05),r();break;case"options.music.up":controller.audio_setMusicVolume(controller.audio_getMusicVolume()+.05),r();break;case"options.setKeyboad":return"REMAP_KEYBOARD";case"options.setGamepad":return"REMAP_GAMEPAD";case"options.resetData":return"WIPEOUT";case"options.forceTouch":e();break;case"options.animatedTiles":o();break;case"options.goBack":controller.audio_saveConfigs(),controller.storage_general.set("cwt_forceTouch",controller.screenStateMachine.structure.OPTIONS.forceTouch),controller.storage_general.set("cwt_animatedTiles",controller.screenStateMachine.structure.OPTIONS.animatedTiles);var t=a?"GAMEROUND":"MAIN";return a=!1,t}return this.breakTransition()},controller.screenStateMachine.structure.OPTIONS.CANCEL=function(){return controller.audio_saveConfigs(),a?"GAMEROUND":"MAIN"}}),util.scoped(function(){function e(e,o){if(a[e]){var n=controller.configBoundaries_[a[e]];!o&&model.cfg_configuration[a[e]]+n.step<=n.max?model.cfg_configuration[a[e]]+=n.step:model.cfg_configuration[a[e]]-n.step>=n.min&&(model.cfg_configuration[a[e]]-=n.step),t(e)}}function t(e){i[e].innerHTML=a[e]?model.cfg_configuration[a[e]]:"&#160;",s[e].innerHTML=a[e]?model.data_localized(a[e]):"&#160;"}function o(){var e=5*r;a[0]=e<controller.configNames_.length?controller.configNames_[e]:null,a[1]=e+1<controller.configNames_.length?controller.configNames_[e+1]:null,a[2]=e+2<controller.configNames_.length?controller.configNames_[e+2]:null,a[3]=e+3<controller.configNames_.length?controller.configNames_[e+3]:null,a[4]=e+4<controller.configNames_.length?controller.configNames_[e+4]:null,t(0),t(1),t(2),t(3),t(4)}var n=controller.generateButtonGroup(document.getElementById("cwt_parameter_setup_screen"),"cwt_panel_header_big cwt_page_button cwt_panel_button","cwt_panel_header_big cwt_page_button cwt_panel_button button_active","cwt_panel_header_big cwt_page_button cwt_panel_button button_inactive"),r=0,a=[null,null,null,null,null],i=[document.getElementById("options.parameter.1.value"),document.getElementById("options.parameter.2.value"),document.getElementById("options.parameter.3.value"),document.getElementById("options.parameter.4.value"),document.getElementById("options.parameter.5.value")],s=[document.getElementById("options.parameter.1.desc"),document.getElementById("options.parameter.2.desc"),document.getElementById("options.parameter.3.desc"),document.getElementById("options.parameter.4.desc"),document.getElementById("options.parameter.5.desc")];controller.screenStateMachine.structure.PARAMETER_SETUP=Object.create(controller.stateParent),controller.screenStateMachine.structure.PARAMETER_SETUP.section="cwt_parameter_setup_screen",controller.screenStateMachine.structure.PARAMETER_SETUP.enterState=function(){r=0,o()},controller.screenStateMachine.structure.PARAMETER_SETUP.UP=function(){var e=1;switch(n.getActiveKey()){case"config.parameter.next":case"config.parameter.prev":case"options.nextPage":case"options.prevPage":case"options.goBack":case"options.next":e=2}return e&&n.decreaseIndex(e),this.breakTransition()},controller.screenStateMachine.structure.PARAMETER_SETUP.DOWN=function(){var e=1;switch(n.getActiveKey()){case"config.parameter.next":case"config.parameter.prev":case"options.nextPage":case"options.prevPage":case"options.goBack":e=2}return e&&n.increaseIndex(e),this.breakTransition()},controller.screenStateMachine.structure.PARAMETER_SETUP.LEFT=function(){switch(n.getActiveKey()){case"config.parameter.next":case"options.nextPage":case"options.next":n.decreaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.PARAMETER_SETUP.RIGHT=function(){switch(n.getActiveKey()){case"config.parameter.prev":case"options.prevPage":case"options.goBack":n.increaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.PARAMETER_SETUP.CANCEL=function(){return"PLAYER_SETUP"},controller.screenStateMachine.structure.PARAMETER_SETUP.ACTION=function(){switch(n.getActiveKey()){case"config.parameter.prev":var t=-1;switch(n.getActiveData()){case"1":t=0;break;case"2":t=1;break;case"3":t=2;break;case"4":t=3;break;case"5":t=4}e(t,!0);break;case"config.parameter.next":var t=-1;switch(n.getActiveData()){case"1":t=0;break;case"2":t=1;break;case"3":t=2;break;case"4":t=3;break;case"5":t=4}e(t,!1);break;case"options.prevPage":if(!(r>0))return;r--,o();break;case"options.nextPage":if(!(controller.configNames_.length>5*(r+1)))return;r++,o();break;case"options.goBack":return"PLAYER_SETUP";case"options.next":return"GAMEROUND"}return this.breakTransition()}}),util.scoped(function(){function e(e,t,o){s.innerHTML=model.data_localized(e),l.innerHTML=o>=0&&o<r.length?r[o]:"&#160;",c.innerHTML=t?model.data_localized(t):t}function t(){var e=null;model.co_activeMode===model.co_MODES.AW1?e="options.playerConf.mode.AW1":model.co_activeMode===model.co_MODES.AW2&&(e="options.playerConf.mode.AW2"),a.innerHTML=model.data_localized(e)}function o(t){var o=controller.roundConfig_typeSelected[t];-1===o?e("config.player.off","&#160;",-1):-2===o?e("config.player.disabled","&#160;",-1):e(0===o?"config.player.human":"config.player.AI",-1!==controller.roundConfig_coSelected[t]?model.data_coSheets[model.data_coTypes[controller.roundConfig_coSelected[t]]].ID:"config.player.co.none",controller.roundConfig_teamSelected[t]),i.innerHTML=t+1}var n=controller.generateButtonGroup(document.getElementById("cwt_player_setup_screen"),"cwt_panel_header_big cwt_page_button cwt_panel_button","cwt_panel_header_big cwt_page_button cwt_panel_button button_active","cwt_panel_header_big cwt_page_button cwt_panel_button button_inactive"),r=["A","B","C","D"],a=document.getElementById("options.playerConf.coMode"),i=document.getElementById("options.playerConf.selectedSlot"),s=(document.getElementById("options.playerConf.coMode"),document.getElementById("options.playerConf.type")),l=document.getElementById("options.playerConf.team"),c=document.getElementById("options.playerConf.coA"),u=-1;controller.screenStateMachine.structure.PLAYER_SETUP=Object.create(controller.stateParent),controller.screenStateMachine.structure.PLAYER_SETUP.section="cwt_player_setup_screen",controller.screenStateMachine.structure.PLAYER_SETUP.enterState=function(){u=0,o(u),t()},controller.screenStateMachine.structure.PLAYER_SETUP.UP=function(){var e=0;switch(n.getActiveKey()){case"options.playerConf.p1":case"options.playerConf.gameMode.prev":case"options.goBack":e=1;break;case"config.type.next":case"config.co.next":case"config.team.next":case"config.type.prev":case"config.co.prev":case"config.team.prev":case"options.playerConf.p2":case"options.playerConf.gameMode.next":case"options.next":e=2;break;case"options.playerConf.p3":e=3;break;case"options.playerConf.p4":e=4}return e&&n.decreaseIndex(e),this.breakTransition()},controller.screenStateMachine.structure.PLAYER_SETUP.DOWN=function(){var e=0;switch(n.getActiveKey()){case"options.playerConf.p1":e=4;break;case"options.playerConf.p2":e=3;break;case"config.type.prev":case"config.co.prev":case"config.team.prev":case"config.type.next":case"config.co.next":case"config.team.next":case"options.playerConf.p3":case"options.goBack":case"options.playerConf.gameMode.prev":e=2;break;case"options.playerConf.p4":case"options.playerConf.gameMode.next":case"options.next":e=1}return e&&n.increaseIndex(e),this.breakTransition()},controller.screenStateMachine.structure.PLAYER_SETUP.LEFT=function(){switch(n.getActiveKey()){case"config.type.next":case"config.co.next":case"config.team.next":case"options.playerConf.p2":case"options.playerConf.p3":case"options.playerConf.p4":case"options.playerConf.gameMode.next":case"options.next":n.decreaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.PLAYER_SETUP.RIGHT=function(){switch(n.getActiveKey()){case"config.type.prev":case"config.co.prev":case"config.team.prev":case"options.playerConf.p2":case"options.playerConf.p3":case"options.playerConf.p1":case"options.playerConf.gameMode.prev":case"options.goBack":n.increaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.PLAYER_SETUP.CANCEL=function(){return"VERSUS"},controller.screenStateMachine.structure.PLAYER_SETUP.ACTION=function(){switch(assert(-1!==u),n.getActiveKey()){case"config.co.prev":case"config.co.next":case"config.team.prev":case"config.team.next":if(-1===model.player_data[u].team)return}switch(n.getActiveKey()){case"config.type.prev":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.PLAYER_TYPE,!0);break;case"config.type.next":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.PLAYER_TYPE,!1);break;case"config.co.prev":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.CO_MAIN,!0);break;case"config.co.next":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.CO_MAIN,!1);break;case"config.team.prev":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.TEAM,!0);break;case"config.team.next":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.TEAM,!1);break;case"options.playerConf.p1":u=0;break;case"options.playerConf.p2":u=1;break;case"options.playerConf.p3":u=2;break;case"options.playerConf.p4":u=3;break;case"options.playerConf.gameMode.prev":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.GAME_TYPE,!0),t();break;case"options.playerConf.gameMode.next":controller.roundConfig_changeConfig(u,controller.roundConfig_CHANGE_TYPE.GAME_TYPE,!1),t();break;case"options.goBack":return"VERSUS";case"options.next":return controller.roundConfig_evalAfterwards(),"PARAMETER_SETUP"}return o(u),this.breakTransition()}}),function(){function e(e,t,o){if(-1===t)return e.innerHTML="...",void 0;if(!o)return e.innerHTML=t,void 0;var n=String.fromCharCode(t);
switch(t){case 6:n="Mac";break;case 8:n="Backspace";break;case 9:n="Tab";break;case 13:n="Enter";break;case 16:n="Shift";break;case 17:n="CTRL";break;case 18:n="ALT";break;case 19:n="Pause/Break";break;case 20:n="Caps Lock";break;case 27:n="ESC";break;case 32:n="Space";break;case 33:n="Page Up";break;case 34:n="Page Down";break;case 35:n="End";break;case 36:n="Home";break;case 37:n="Arrow Left";break;case 38:n="Arrow Up";break;case 39:n="Arrow Right";break;case 40:n="Arrow Down";break;case 43:n="Plus";break;case 45:n="Insert";break;case 46:n="Delete";break;case 91:n="Left Window Key";break;case 92:n="Right Window Key";break;case 93:n="Select Key";break;case 96:n="Numpad 0";break;case 97:n="Numpad 1";break;case 98:n="Numpad 2";break;case 99:n="Numpad 3";break;case 100:n="Numpad 4";break;case 101:n="Numpad 5";break;case 102:n="Numpad 6";break;case 103:n="Numpad 7";break;case 104:n="Numpad 8";break;case 105:n="Numpad 9";break;case 106:n="*";break;case 107:n="+";break;case 109:n="-";break;case 110:n=";";break;case 111:n="/";break;case 112:n="F1";break;case 113:n="F2";break;case 114:n="F3";break;case 115:n="F4";break;case 116:n="F5";break;case 117:n="F6";break;case 118:n="F7";break;case 119:n="F8";break;case 120:n="F9";break;case 121:n="F10";break;case 122:n="F11";break;case 123:n="F12";break;case 144:n="Num Lock";break;case 145:n="Scroll Lock";break;case 186:n=";";break;case 187:n="=";break;case 188:n=",";break;case 189:n="-";break;case 190:n=".";break;case 191:n="/";break;case 192:n="`";break;case 219:n="[";break;case 220:n="\\";break;case 221:n="]";break;case 222:n="'"}e.innerHTML=n}function t(t,o){i=-1,e(s.LEFT,t.LEFT,o),e(s.DOWN,t.DOWN,o),e(s.UP,t.UP,o),e(s.RIGHT,t.RIGHT,o),e(s.ACTION,t.ACTION,o),e(s.CANCEL,t.CANCEL,o)}function o(t,o,n){switch(i){case-1:assert(!1);case 0:t.LEFT=o,e(s.LEFT,o,n);break;case 1:t.UP=o,e(s.UP,o,n);break;case 2:t.DOWN=o,e(s.DOWN,o,n);break;case 3:t.RIGHT=o,e(s.RIGHT,o,n);break;case 4:t.ACTION=o,e(s.ACTION,o,n);break;case 5:t.CANCEL=o,e(s.CANCEL,o,n)}return i=-1,controller.input_genericInputRequest=!1,this.breakTransition()}function n(){switch(l.getActiveKey()){case"options.remap.right":i=3,e(s.RIGHT,-1,!0);break;case"options.remap.left":i=0,e(s.LEFT,-1,!0);break;case"options.remap.up":i=1,e(s.UP,-1,!0);break;case"options.remap.down":i=2,e(s.DOWN,-1,!0);break;case"options.remap.action":i=4,e(s.ACTION,-1,!0);break;case"options.remap.cancel":i=5,e(s.CANCEL,-1,!0);break;case"options.goBack":return controller.saveKeyMapping(),"OPTIONS"}return controller.input_genericInputRequest=!0,this.breakTransition()}function r(){l.decreaseIndex()}function a(){l.increaseIndex()}var i,s={LEFT:document.getElementById("options.remap.left"),DOWN:document.getElementById("options.remap.down"),UP:document.getElementById("options.remap.up"),RIGHT:document.getElementById("options.remap.right"),ACTION:document.getElementById("options.remap.action"),CANCEL:document.getElementById("options.remap.cancel")},l=controller.generateButtonGroup(document.getElementById("cwt_keyMapping_screen"),"cwt_panel_header_small cwt_page_button w_400 cwt_panel_button","cwt_panel_header_small cwt_page_button w_400 cwt_panel_button button_active","cwt_panel_header_small cwt_page_button w_400 cwt_panel_button button_inactive");controller.screenStateMachine.structure.REMAP_KEYBOARD=Object.create(controller.stateParent),controller.screenStateMachine.structure.REMAP_GAMEPAD=Object.create(controller.stateParent),controller.screenStateMachine.structure.REMAP_KEYBOARD.section="cwt_keyMapping_screen",controller.screenStateMachine.structure.REMAP_GAMEPAD.section="cwt_keyMapping_screen",controller.screenStateMachine.structure.REMAP_KEYBOARD.enterState=function(){t.call(this,controller.keyMaps.KEYBOARD,!0)},controller.screenStateMachine.structure.REMAP_GAMEPAD.enterState=function(){t.call(this,controller.keyMaps.GAMEPAD,!1)},controller.screenStateMachine.structure.REMAP_KEYBOARD.ACTION=n,controller.screenStateMachine.structure.REMAP_GAMEPAD.ACTION=n,controller.screenStateMachine.structure.REMAP_KEYBOARD.UP=r,controller.screenStateMachine.structure.REMAP_GAMEPAD.UP=r,controller.screenStateMachine.structure.REMAP_KEYBOARD.DOWN=a,controller.screenStateMachine.structure.REMAP_GAMEPAD.DOWN=a,controller.screenStateMachine.structure.REMAP_KEYBOARD.INPUT_SET=function(e,t){o.call(this,controller.keyMaps.KEYBOARD,t,!0)},controller.screenStateMachine.structure.REMAP_GAMEPAD.INPUT_SET=function(e,t){o.call(this,controller.keyMaps.GAMEPAD,t,!1)}}(),controller.screenStateMachine.structure.RULE_EDIT=Object.create(controller.stateParent),controller.screenStateMachine.structure.RULE_EDIT.section="cwt_ruleEditScreen",controller.screenStateMachine.structure.RULE_EDIT.enterState=function(){},util.scoped(function(){function e(){model.data_tips.length>0&&(n.innerHTML=model.data_tips[t])}{var t,o=1e4,n=document.getElementById("startScreen_toolTip"),r=document.getElementById("cwt_mobileSound_screen");controller.generateButtonGroup(r,"cwt_panel_header_big cwt_page_button w_400 cwt_panel_button","cwt_panel_header_big cwt_page_button w_400 cwt_panel_button button_active","cwt_panel_header_big cwt_page_button w_400 cwt_panel_button button_inactive")}controller.screenStateMachine.structure.MOBILE=Object.create(controller.stateParent),controller.screenStateMachine.structure.MOBILE.timer=0,controller.screenStateMachine.structure.MOBILE.section="cwt_mobileSound_screen",controller.screenStateMachine.structure.MOBILE.enterState=function(){t=parseInt(Math.random()*model.data_tips.length,10),e(),controller.screenStateMachine.structure.MOBILE.timer=o},controller.screenStateMachine.structure.MOBILE.decreaseTimer=function(n,r){return controller.screenStateMachine.structure.MOBILE.timer-=r,controller.screenStateMachine.structure.MOBILE.timer<=0&&(controller.screenStateMachine.structure.MOBILE.timer=o,t++,t>=model.data_tips.length&&(t=0),e()),this.breakTransition()},controller.screenStateMachine.structure.MOBILE.ACTION=function(){return controller.stateMachine.event("start"),"MAIN"},controller.screenStateMachine.structure.MOBILE.LEFT=function(){return t--,0>t&&(t=model.data_tips.length-1),controller.screenStateMachine.structure.MOBILE.timer=o,e(),this.breakTransition()},controller.screenStateMachine.structure.MOBILE.RIGHT=function(){return t++,t>=model.data_tips.length&&(t=0),controller.screenStateMachine.structure.MOBILE.timer=o,e(),this.breakTransition()}}),util.scoped(function(){function e(e){controller.input_requestBlock(),controller.storage_maps.get(e,t)}function t(e){controller.metadata_grabFromMapData(e.value,d,m,model.data_header.map_meta),f.innerHTML=e.value.name,controller.minimap_renderMapSelectionMinimap(e.value),controller.input_releaseBlock()}function o(t){_[t]&&(controller.metadata_grabFromMapData(null,d,m,null),p=_[t],e(_[t]))}function n(e,t){t?(u[e].innerHTML=t,_[e]=t):(u[e].innerHTML="&#160;",_[e]=null)}function r(e){var t=5*e;t>=0&&t<model.data_maps.length&&(n(0,model.data_maps[t]),n(1,t+1<model.data_maps.length?model.data_maps[t+1]:null),n(2,t+2<model.data_maps.length?model.data_maps[t+2]:null),n(3,t+3<model.data_maps.length?model.data_maps[t+3]:null),n(4,t+4<model.data_maps.length?model.data_maps[t+4]:null),h.innerHTML=e+1,c=e)}function a(e){var t=e.value;controller.persistence_prepareModel(t),controller.roundConfig_prepare()}function i(e){a(e),controller.screenStateMachine.event("_toConf")}function s(e){a(e),controller.roundConfig_evalAfterwards(),controller.screenStateMachine.event("_toMap")}{var l=controller.generateButtonGroup(document.getElementById("cwt_versus_screen"),"cwt_panel_header_big cwt_page_button w_400 cwt_panel_button","cwt_panel_header_big cwt_page_button w_400 cwt_panel_button button_active","cwt_panel_header_big cwt_page_button w_400 cwt_panel_button button_inactive"),c=0,u=[document.getElementById("options.versus.map.1"),document.getElementById("options.versus.map.2"),document.getElementById("options.versus.map.3"),document.getElementById("options.versus.map.4"),document.getElementById("options.versus.map.5")],d=[document.getElementById("options.versus.meta.1"),document.getElementById("options.versus.meta.2"),document.getElementById("options.versus.meta.3"),document.getElementById("options.versus.meta.4"),document.getElementById("options.versus.meta.5"),document.getElementById("options.versus.meta.6")],m=[document.getElementById("options.versus.meta.1.canvas"),document.getElementById("options.versus.meta.2.canvas"),document.getElementById("options.versus.meta.3.canvas"),document.getElementById("options.versus.meta.4.canvas"),document.getElementById("options.versus.meta.5.canvas"),document.getElementById("options.versus.meta.6.canvas")],_=[null,null,null,null,null],p=null,f=document.getElementById("versus.map.category"),h=document.getElementById("versus.mapSelect.page");document.getElementById("map_meta_sizex"),document.getElementById("map_meta_sizey"),document.getElementById("map_meta_properties"),document.getElementById("map_meta_players")}controller.screenStateMachine.structure.VERSUS=Object.create(controller.stateParent),controller.screenStateMachine.structure.VERSUS.section="cwt_versus_screen",controller.screenStateMachine.structure.VERSUS._toConf=function(){return"PLAYER_SETUP"},controller.screenStateMachine.structure.VERSUS._toMap=function(){return"GAMEROUND"},controller.screenStateMachine.structure.VERSUS.enterState=function(){r(0),p=null},controller.screenStateMachine.structure.VERSUS.UP=function(){switch(l.getActiveKey()){case"options.versus.quickMatch":l.decreaseIndex(3);break;case"options.goBack":case"options.nextPage.small":case"options.versus.configuredMatch":l.decreaseIndex(2);break;default:l.decreaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.VERSUS.DOWN=function(){switch(l.getActiveKey()){case"options.goBack":case"options.versus.quickMatch":l.increaseIndex(3);break;case"options.prevPage.small":case"options.versus.configuredMatch":l.increaseIndex(2);break;default:l.increaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.VERSUS.LEFT=function(){switch(l.getActiveKey()){case"options.nextPage.small":case"options.versus.configuredMatch":case"options.versus.quickMatch":l.decreaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.VERSUS.RIGHT=function(){switch(l.getActiveKey()){case"options.prevPage.small":case"options.versus.configuredMatch":case"options.goBack":l.increaseIndex()}return this.breakTransition()},controller.screenStateMachine.structure.VERSUS.CANCEL=function(){return"MAIN"},controller.screenStateMachine.structure.VERSUS.ACTION=function(){switch(l.getActiveKey()){case"options.goBack":return"MAIN";case"options.versus.configuredMatch":p&&controller.storage_maps.get(p,i);break;case"options.versus.quickMatch":p&&controller.storage_maps.get(p,s);break;case"options.prevPage.small":r(c-1);break;case"options.nextPage.small":r(c+1);break;default:var e=-1;switch(l.getActiveData()){case"1":e=0;break;case"2":e=1;break;case"3":e=2;break;case"4":e=3;break;case"5":e=4}o(e)}return this.breakTransition()}});