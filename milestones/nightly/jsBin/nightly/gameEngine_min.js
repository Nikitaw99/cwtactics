var cwt={};cwt.DEBUG=!1,cwt.mod={},cwt.loadDefaultMod=function(){var a,b,c=cwt.mod.awds,d=c.movetypes;for(a=0,b=d.length;a<b;a++)cwt.parseSheet(d[a],cwt.MOVE_TYPE_SHEET);d=c.weapons;for(a=0,b=d.length;a<b;a++)cwt.parseSheet(d[a],cwt.WEAPON_TYPE_SHEET);d=c.tiles;for(a=0,b=d.length;a<b;a++)cwt.parseSheet(d[a],cwt.TILE_TYPE_SHEET);d=c.units;for(a=0,b=d.length;a<b;a++)cwt.parseSheet(d[a],cwt.UNIT_TYPE_SHEET)},cwt.util={setDebug:function(a){cwt.DEBUG=a},observable:function(a,b){if(typeof b!="string"||b.length==0)throw Error("illegal listener name");a["_listeners_"+b]=[],a["add"+b+"Listener"]=function(c){a["_listeners_"+b].push(c)},a["emit"+b]=function(){var c,d,e=a["_listeners_"+b];for(c=0,d=e.length;c<d;c++)e[c].apply(a,arguments)},a["remove"+b+"Listener"]=function(c){var d=a["_listeners_"+b].indexOf(c);return d===-1?!1:(a["_listeners_"+b].splice(d,1),!0)}},fill:function(a,b){var c,d,e,f,g=typeof b=="function";if(a.__matrixArray__===!0)for(c=0,d=a.length;c<d;c++)for(e=0,f=a.length;e<f;e++)g?a[c][e]=b(c,e):a[c][e]=b;else for(c=0,d=a.length;c<d;c++)g?a[c]=b(c):a[c]=b},list:function(a,b){var c,d,e;b===undefined&&(b=null),c=typeof b=="function",d=[];for(e=0;e<a;e++)c?d[e]=b(e):d[e]=b;return d},matrix:function(a,b,c){var d,e,f,g;c===undefined&&(c=null),d=typeof c=="function",e=[];for(f=0;f<a;f++){e[f]=[];for(g=0;g<b;g++)d?e[f][g]=c(f,g):e[f][g]=c}return e.__matrixArray__=!0,e},GAME_CLIENT_NOTICE_FN:function(){},trueReturner:function(){return!0},objectPool:function(a){function c(){var b={};return a(b),b}var b=[];return{request:function(){return cwt.DEBUG&&cwt.info("got request call"),b.length>0?(cwt.DEBUG&&cwt.info("returning cached object"),b.pop()):(cwt.DEBUG&&cwt.info("returning fresh object"),c())},release:function(c){cwt.DEBUG&&cwt.info("releasing object {0} back to the object pool",c),a(c),b.push(c)}}}},cwt._initializerFn=[],cwt.onInit=function(a,b){cwt._initializerFn.push([a,b])},cwt.start=function(){var a,b,c=cwt._initializerFn;for(a=0,b=c.length;a<b;a++)cwt.DEBUG&&cwt.info("initializing {0}",c[a][0]),c[a][1]();c.splice(0)},cwt.actionRegister_={},cwt._actionCurrentKey=null,cwt._actionList=[],cwt._actionAddEntry=function(a){cwt._actionList[cwt._actionList.length]={k:cwt._actionCurrentKey,a:a}},cwt.userAction=function(a,b){cwt.actionRegister_[a]=b},cwt._unitActions={ON_ENEMY_UNIT:{},ON_ALLIED_UNIT:{},ON_OWN_UNIT:{},ON_OWN_PROPERTY:{},ON_ALLIED_PROPERTY:{},ON_ENEMY_PROPERTY:{},ON_TILE:{}},cwt._propertyActions={},cwt.userActionNEW=function(a){a.unitSelected!==!0,a.propertySelected!==!0,!a.condition},cwt.userInvokableTransaction=function(a,b){cwt.transaction(a),cwt.userAction(a,b)},cwt.doAction=function(a){cwt[a.k].apply(cwt,a.a)},cwt.getActionList=function(a,b,c){var d,e,f,g,h,i,j,k,l=cwt._actionList;l.splice(0),d=undefined,e=cwt.propertyByPos(a,b),f=cwt.unitByPos(a,b),g=e!==null?cwt.extractPropertyId(e):null,h=f!==null?cwt.extractUnitId(f):null,i=Object.keys(cwt.actionRegister_);if(c!==undefined){d=cwt.unitById(c);if(a===undefined||b===undefined)a=d.x,b=d.y}for(j=0,k=i.length;j<k;j++)cwt._actionCurrentKey=i[j],cwt.actionRegister_[i[j]](cwt._actionAddEntry,a,b,e,f,d===undefined?null:d);return l},cwt.MAX_BUFFER_SIZE=200,cwt.bufferReadIndex_=0,cwt.bufferWriteIndex_=0,cwt.bufferData_=null,cwt.onInit("command pipeline",function(){cwt.bufferData_=cwt.util.list(cwt.MAX_BUFFER_SIZE,null)}),cwt.pushMsgToBuffer=function(a){cwt.bufferData_[cwt.bufferWriteIndex_]!==null&&cwt.error("message buffer is full"),cwt.DEBUG&&cwt.info("adding message '{0}â€˜ to buffer",a),cwt.bufferData_[cwt.bufferWriteIndex_]=a,cwt.bufferWriteIndex_++,cwt.bufferWriteIndex_===cwt.MAX_BUFFER_SIZE&&(cwt.bufferWriteIndex_=0)},cwt.isMsgInBuffer=function(){return cwt.bufferData_[cwt.bufferReadIndex_]!==null},cwt.popMsgFromBuffer=function(){var a;return cwt.bufferData_[cwt.bufferReadIndex_]===null&&cwt.error("message buffer is empty"),a=cwt.bufferData_[cwt.bufferReadIndex_],cwt.bufferData_[cwt.bufferReadIndex_]=null,cwt.bufferReadIndex_++,cwt.bufferReadIndex_===cwt.MAX_BUFFER_SIZE&&(cwt.bufferReadIndex_=0),a},cwt._loggerArg=null,cwt._formatReplacer=function(a,b){var c=cwt._loggerArg[parseInt(b,10)+1];return typeof c!="string"?JSON.stringify(c):c},cwt._stringFormat=function(a){return cwt._loggerArg=arguments,a.replace(/\{(\d+)\}/g,cwt._formatReplacer)},cwt.info=function(){var a=cwt._stringFormat.apply(cwt.log,arguments);console.log(a),log.info(a)},cwt.warn=function(){var a=cwt._stringFormat.apply(cwt.log,arguments);console.log(a),log.warn(a)},cwt.error=function(){var a=cwt._stringFormat.apply(cwt.log,arguments);throw console.log(a),log.error(a),Error(a)},cwt._persitenceMap=[],cwt.serializedProperty=function(a){cwt._persitenceMap.indexOf(a)===-1?cwt[a]===undefined?cwt.error("property {0} is not defined",a):cwt._persitenceMap.push(a):cwt.error("property {0} is already registered",a)},cwt.serializeModel=function(){var a,b,c,d={},e=cwt._persitenceMap;for(a=0,b=e.length;a<b;a++)d[e[a]]=cwt[e[a]];c=JSON.stringify(d);for(a=0,b=e.length;a<b;a++)delete d[e[a]];return c},cwt.deserializeModelData=function(a){typeof a=="string"&&(a=JSON.parse(a)),cwt.loadMap(a)},cwt._transactions={},cwt.transaction=function(a,b){var c,d,e,f;if(typeof a=="function"){c=Object.keys(cwt),d=!1;for(e=0,f=c.length;e<f;e++)if(cwt[c[e]]===a){a=c[e],d=!0;break}d||cwt.error("cannot find function in cwt context")}cwt._transactions[a]=cwt[a],cwt[a]=function(){b&&cwt.DEBUG&&cwt.info("doing shared transaction {0}",a),cwt.pushMsgToBuffer({k:a,a:arguments})}},cwt.evalTransactionMessage=function(a){var b=cwt._transactions[a.k];b.apply(cwt,a.a)},cwt.createTagContainer=function(){var a;return a={nodes:[]}},cwt.solveTagAttribute=function(a,b){var c;for(c=0;c<b.length;c++)a=cwt._tagCodes[b[c].a](a,b[c]);return a},cwt._tagCodes={},cwt._tagCodes.FOR_DAYS=function(a,b){return cwt.day<b.lastDay?null:a},cwt._tagCodes.TWICE=function(a,b){return cwt.solveTagAttribute(a,b.commands)+cwt.solveTagAttribute(a,b.commands)-a},cwt._tagCodes.CONDITION=function(a,b){return b.cond===1?b.thenBlock:b.elseBlock},cwt._tagCodes.CHANGE_VALUE=function(a,b){return a+b.value},cwt._tagCodes.SET_VALUE=function(a,b){return b.value},cwt._tagCodes.VALUE=function(a,b){return b.value},cwt.MAX_MAP_WIDTH=100,cwt.MAX_MAP_HEIGHT=100,cwt.MAX_PLAYER=8,cwt.MAX_UNITS_PER_PLAYER=50,cwt.MAX_PROPERTIES=200,cwt.MAX_SELECTION_RANGE=15,cwt.INACTIVE_ID=-1,cwt.mapWidth=0,cwt.mapHeight=0,cwt._map=null,cwt._unitPosMap=null,cwt._units=null,cwt._players=null,cwt._propertyPosMap=null,cwt._properties=null,cwt._transportMapPool=cwt.util.objectPool(function(a){a.maxWeight=0,a.currentWeight=0,a.loaded=[]}),cwt._transportRelation={},cwt.onInit("data",function(){var a,b;cwt.serializedProperty("mapWidth"),cwt.serializedProperty("mapHeight"),cwt.serializedProperty("_map"),cwt.serializedProperty("_units"),cwt.serializedProperty("_players"),cwt.serializedProperty("_properties"),cwt.serializedProperty("_unitPosMap"),cwt.serializedProperty("_propertyPosMap"),cwt.transaction("setUnitPosition"),a=cwt.MAX_MAP_WIDTH,b=cwt.MAX_MAP_HEIGHT,cwt._map=cwt.util.matrix(a,b,null),cwt._unitPosMap=cwt.util.matrix(a,b,null),cwt._propertyPosMap=cwt.util.matrix(a,b,null),cwt._units=cwt.util.list(cwt.MAX_PLAYER*cwt.MAX_UNITS_PER_PLAYER,function(){return{x:0,y:0,hp:0,type:null,ammo:0,fuel:0,owner:cwt.INACTIVE_ID}}),cwt._players=cwt.util.list(cwt.MAX_PLAYER+1,function(a){var b=a===8;return{gold:0,team:b?9999:cwt.INACTIVE_ID,name:b?"NEUTRAL":null}}),cwt._properties=cwt.util.list(cwt.MAX_PROPERTIES,function(){return{capturePoints:20,owner:-1}})}),cwt.unitById=function(a){var b;return(a<0||cwt._units.length<=a)&&cwt.error("invalid unit id {0}",a),b=this._units[a],b.owner===cwt.INACTIVE_ID?null:b},cwt.unitByPos=function(a,b){return cwt._unitPosMap[a][b]},cwt.extractUnitId=function(a){var b,c,d;a===null&&cwt.error("unit argument cannot be null"),b=cwt._units;for(c=0,d=b.length;c<d;c++)if(b[c]===a)return c;cwt.error("cannot find unit {0}",a)},cwt.player=function(a){var b;return(a<0||this._players.length<=a)&&cwt.log.error("invalid id"),b=this._players[a],b.team===cwt.INACTIVE_ID?null:b},cwt.propertyById=function(a){var b;return(a<0||cwt._properties.length<=a)&&cwt.error("invalid property id {0}",a),b=cwt._properties[a],b.owner===cwt.INACTIVE_ID?null:b},cwt.propertyByPos=function(a,b){return cwt._propertyPosMap[a][b]},cwt.tileOccupiedByUnit=function(a,b){var c=cwt.unitByPos(a,b);return c===null?!1:cwt.extractUnitId(c)},cwt.tileIsProperty=function(a,b){var c=cwt.propertyByPos(a,b);return c===null?!1:cwt.extractPropertyId(c)},cwt.extractPropertyId=function(a){var b,c,d;a===null&&cwt.error("property argument cannot be null"),b=cwt._properties;for(c=0,d=b.length;c<d;c++)if(b[c]===a)return c;cwt.error("cannot find property {0}",a)},cwt.eraseUnitPosition=function(a){cwt.setUnitPosition(a)},cwt.setUnitPosition=function(a,b,c){var d=cwt.unitById(a),e=d.x,f=d.y,g=cwt._unitPosMap;g[e][f]=null,arguments.length>1&&(d.x=b,d.y=c,g[b][c]=d)},cwt.distance=function(a,b,c,d){var e=Math.abs(a-c),f=Math.abs(b-d);return e+f},cwt.isTransport=function(a){return cwt._transportRelation.hasOwnProperty(a)},cwt.createTransporterId=function(a){var b=cwt._transportMapPool.request();cwt._transportRelation[a]=b},cwt.destroyTransporterId=function(a){var b=cwt._transportRelation[a];cwt._transportMapPool(b)},cwt.loadUnitIntoTransporter=function(a,b){var c=cwt.unitById(a);cwt.eraseUnitPosition(b),cwt._pushToTransport(a,b),cwt.setUnitPosition(a,c.x,c.y)},cwt._pushToTransport=function(a,b){var c=cwt._transportRelation[a];c===undefined&&cwt.error("unit {0} is not a transporter",a),c.loaded.push(b)},cwt.transaction(cwt._pushToTransport),cwt.unloadUnitFromTransporter=function(a,b,c,d){cwt._popFromTransport(a,b),cwt.setUnitPosition(b,c,d)},cwt._popFromTransport=function(a,b){var c,d=cwt._transportRelation[a];d===undefined&&cwt.error("unit {0} is not a transporter",a),c=d.loaded.indexOf(b),c===-1&&cwt.error("unit {0} is not in the transporter",b),d.loaded.splice(c,1)},cwt.transaction(cwt._popFromTransport),cwt.userAction("loadUnitIntoTransporter",function(a,b,c,d,e,f){e!==null&&e.owner===f.owner&&a.push({k:"loadUnitIntoTransporter",a:[cwt.extractUnitId(e),cwt.extractUnitId(f)]})}),cwt.userAction("unloadUnitFromTransporter",function(a,b,c,d,e,f){var g;if(f===null)return;g=cwt._transportRelation[cwt.extractUnitId(f)],e===null&&g!==undefined&&g.loaded.length>0&&cwt.unitByPos(b+1,c)===null&&a.push({k:"unloadUnitFromTransporter",a:[cwt.extractUnitId(f),g.loaded[0],b+1,c]})}),cwt.loadMap=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;cwt.DEBUG&&cwt.info("start loading map"),cwt.mapWidth=a.width,cwt.mapHeight=a.height,cwt.turnPid_=0;for(b=0,c=cwt.mapWidth;b<c;b++)for(d=0,e=cwt.mapHeight;d<e;d++)cwt._map[b][d]=a.filler;for(b=0,c=cwt.mapWidth;b<c;b++)for(d=0,e=cwt.maxHeight;d<e;d++)cwt._unitPosMap[b][d]=null;f=Object.keys(a.data);for(g=0,h=f.length;g<h;g++){b=parseInt(f[g],10),i=Object.keys(a.data[f[g]]);for(j=0,k=i.length;j<k;j++)d=parseInt(i[j],10),cwt._map[b][d]=a.data[f[g]][i[j]]}for(g=0,h=cwt._units.length;g<h;g++)cwt._units[g].owner=cwt.INACTIVE_ID;for(g=0,h=a.players.length;g<h;g++){l=a.players[g],m=cwt._players[g],m.gold=l.gold,m.team=l.team,m.name=l.name,n=g*cwt.MAX_UNITS_PER_PLAYER;for(j=0,o=l.units.length;j<o;j++)p=l.units[j],q=this._units[n+j],q.fuel=p.fuel,q.x=p.x,q.y=p.y,q.hp=p.hp,q.ammo=p.ammo,q.type=p.type,q.owner=p.owner,q.type==="APC"&&cwt.createTransporterId(j),cwt._unitPosMap[p.x][p.y]=q}for(g=a.players.length,h=cwt._players.length;g<h;g++)cwt._players[g].team=cwt.INACTIVE_ID;for(g=0,h=a.properties.length;g<h;g++)r=a.properties[g],s=cwt._properties[g],s.owner=r.owner,s.capturePoints=r.capturePoints,s.type=r.type,s.x=r.x,s.y=r.y,cwt._propertyPosMap[s.x][s.y]=s;for(g=a.properties.length,h=cwt._properties.length;g<h;g++)cwt._properties[g].owner=cwt.INACTIVE_ID;n=cwt.turnPid_*cwt.MAX_UNITS_PER_PLAYER;for(g=n,h=g+cwt.MAX_UNITS_PER_PLAYER;g<h;g++)cwt.turnActors_[g-n]=cwt.unitById(g)!==null?!0:!1;cwt.DEBUG&&cwt.info("map successfully loaded")},cwt.onInit("battle api",function(){cwt.transaction(cwt.unitAttack),cwt.userAction("unitAttack",function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(f===null)return;g=f.owner,h=cwt.player(g).team,i=cwt.unitSheet(f.type).weapons;for(j=0,k=i.length;j<k;j++){l=cwt.weaponSheet(i[j]),m=l.minRange,n=l.maxRange,q=c-n,r=c+n,q<0&&(q=0),r>=cwt.mapHeight&&(r=cwt.mapHeight-1);for(;q<=r;q++){s=Math.abs(q-c),o=b-n+s,p=b+n-s,o<0&&(o=0),p>=cwt.mapWidth&&(p=cwt.mapWidth-1);for(;o<=p;o++)cwt.distance(b,c,o,q)>=m&&(t=cwt.unitByPos(o,q),t!==null&&t.owner!==g&&cwt.player(t.owner).team!==h&&(u=cwt.getBaseDamage(l,t.type),u>0&&a.push({k:"unitAttack",a:[cwt.extractUnitId(f),cwt.extractUnitId(t),u,0,i[j],null]})))}}})}),cwt.getBaseDamage=function(a,b){var c=a.damages[b];return c!==undefined?c:(c=a.damages["*"],c!==undefined?c:0)},cwt.unitAttack=function(a,b,c,d,e,f){var g=cwt.unitById(a),h=cwt.unitById(b),i=cwt.weaponSheet(e),j=f!==null?cwt.weaponSheet(f):null;h.hp-=c,i.useAmmo!==-1&&g.ammo--,cwt.increasePowerMeter(g.owner,0),cwt.increasePowerMeter(h.owner,0),h.hp<0?cwt.destroyUnit(b):j!==null&&(g.hp-=d,j.useAmmo!==-1&&h.ammo--,cwt.increasePowerMeter(g.owner,0),cwt.increasePowerMeter(h.owner,0),g.hp<0&&cwt.destroyUnit(a)),cwt._localWait(cwt.extractUnitId(g))},cwt.increasePowerMeter=function(){},cwt.destroyUnit=function(a){cwt.eraseUnitPosition(a)},cwt.UNIT_TYPE_SHEET=0,cwt.TILE_TYPE_SHEET=1,cwt.WEAPON_TYPE_SHEET=2,cwt.WEATHER_TYPE_SHEET=3,cwt.MOVE_TYPE_SHEET=4,cwt.dbAmanda_=null,cwt.unitSheets_={},cwt.tileSheets_={},cwt.weaponSheets_={},cwt.weatherSheets_={},cwt.movetypeSheets_={},cwt.onInit("db",function(){cwt.dbAmanda_=amanda("json")}),cwt.typeSheetValidators_={unitValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},cost:{type:"integer",minimum:0},fuelConsumption:{type:"integer",minimum:0},maxAmmo:{type:"integer",minimum:0,maximum:99},maxFuel:{type:"integer",minimum:0,maximum:99,required:!0},moveRange:{type:"integer",minimum:0,maximum:15,required:!0},moveType:{type:"string",required:!0},weight:{type:"integer",required:!0}}},tileValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},capturePoints:{type:"integer",minimum:1,maximum:99},defense:{type:"integer",minimum:0,maximum:5}}},weaponValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0}}},weatherValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0}}},movetypeValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},costs:{type:"object",patternProperties:{"[.]*":{type:"integer",minimum:0}}}}}},cwt.unitSheet=function(a){return cwt.unitSheets_.hasOwnProperty(a)||cwt.error("unknown id "+a),cwt.unitSheets_[a]},cwt.tileSheet=function(a){return cwt.tileSheets_.hasOwnProperty(a)||cwt.error("unknown id "+a),cwt.tileSheets_[a]},cwt.movetypeSheet=function(a){return cwt.movetypeSheets_.hasOwnProperty(a)||cwt.error("unknown id "+a),cwt.movetypeSheets_[a]},cwt.weaponSheet=function(a){return cwt.weaponSheets_.hasOwnProperty(a)||cwt.error("unknown id "+a),cwt.weaponSheets_[a]},cwt.weatherSheet=function(a){return cwt.weatherSheets_.hasOwnProperty(a)||cwt.error("unknown id "+a),cwt.weatherSheets_[a]},cwt.parseSheet=function(a,b){var c,d,e,f=a.ID;switch(b){case cwt.UNIT_TYPE_SHEET:c=cwt.typeSheetValidators_.unitValidator,d=cwt.unitSheets_,e=cwt.typeSheetValidators_.unitValidator.properties.ID.except;break;case cwt.TILE_TYPE_SHEET:c=cwt.typeSheetValidators_.tileValidator,d=cwt.tileSheets_,e=cwt.typeSheetValidators_.tileValidator.properties.ID.except;break;case cwt.WEAPON_TYPE_SHEET:c=cwt.typeSheetValidators_.weaponValidator,d=cwt.weaponSheets_,e=cwt.typeSheetValidators_.weaponValidator.properties.ID.except;break;case cwt.WEATHER_TYPE_SHEET:c=cwt.typeSheetValidators_.weatherValidator,d=cwt.weatherSheets_,e=cwt.typeSheetValidators_.weatherValidator.properties.ID.except;break;case cwt.MOVE_TYPE_SHEET:c=cwt.typeSheetValidators_.movetypeValidator,d=cwt.movetypeSheets_,e=cwt.typeSheetValidators_.movetypeValidator.properties.ID.except;break;default:cwt.error("unknow type {0}",b)}cwt.dbAmanda_.validate(a,c,function(a){if(a)throw cwt.error("failed to parse sheet due {0}",a.getMessages()),Error(a)}),d.hasOwnProperty(f)&&cwt.error("{0} is already registered",f),d[f]=a,e.push(f)},cwt.input=StateMachine.create({initial:"Off",error:function(a,b,c,d,e,f,g){return cwt.DEBUG&&cwt.error("error in input controller code:{0} message:{1} e:{4} from:{2} to:{3}",e,f,b,c,g.message),""},events:[{name:"init",from:"Off",to:"NoSelection"},{name:"unitSelected",from:"NoSelection",to:"UnitSelection"},{name:"showMoveMap",from:["UnitSelection","UnitMoveMap"],to:"UnitMoveMap"},{name:"showActionMap",from:["UnitSelection","UnitMoveMap"],to:"UnitActions"},{name:"factorySelected",from:"NoSelection",to:"FactoryActions"},{name:"mapSelected",from:"NoSelection",to:"MapActions"},{name:"doAction",from:["MapActions","UnitActions","FactoryActions"],to:"NoSelection"},{name:"back",from:"*",to:"NoSelection"}],callbacks:{onchangestate:function(a,b,c){b!=="none"&&b!=="Off"&&this.emitStateChange(c,b,a)},onbeforeinit:function(){cwt.util.observable(this,"StateChange"),this.movemap=null},onbeforeunitSelected:function(a,b,c,d){cwt.DEBUG&&cwt.info("selecting unit {0}",d),this.selected=d},onbeforefactorySelected:function(a,b,c,d){cwt.DEBUG&&cwt.info("selecting property {0}",d),this.selected=d},onbeforedoAction:function(a,b,c,d){var e=this.actions;(d<0||d>=e.length)&&cwt.error("invalid action index {0}",d),this.movemap!==null&&this.movemap.way.length>0&&cwt.moveUnit(this.movemap),cwt.doAction(e[d])},onshowActionMap:function(a,b,c,d,e,f){f!==undefined&&(this.movemap.way=f)},onenterNoSelection:function(){this.movemap=null,this.actions=null,this.selected=-1},onenterUnitMoveMap:function(){this.movemap=cwt.createMoveCard(this.selected),cwt.clearTargetSelection(this.selected.x,this.selected.y)},onenterFactoryActions:function(){this.selected===-1&&cwt.error("no factory is selected"),cwt.error("factory actions are not implemented yet")},onenterMapActions:function(a,b,c,d,e){this.actions=cwt.mapActions(d,e)},onenterUnitActions:function(a,b,c,d,e){this.selected===-1&&cwt.error("no unit is selected"),this.movemap.moveMap[d][e]>0?this.actions=cwt.unitActions(this.selected,d,e):cwt.error("cannot move onto tile {0},{1}",d,e)}}}),cwt.selectedUnit_=null,cwt.selectionTargets_=null,cwt.selectionScreenY_=-1,cwt.selectionScreenX_=-1,cwt.clearTargetSelection=function(a,b){var c,d,e=cwt.MAX_SELECTION_RANGE*2+1;for(c=0;c<e;c++)for(d=0;d<e;d++)cwt.selectionTargets_[c][d]=-1;a=Math.max(0,a-cwt.MAX_SELECTION_RANGE),b=Math.max(0,b-cwt.MAX_SELECTION_RANGE),cwt.selectionScreenX_=a,cwt.selectionScreenY_=b},cwt.setTargetForSelection=function(a,b){var c=a-cwt.selectionScreenX_,d=b-cwt.selectionScreenY_,e=cwt.MAX_MOVE_RANGE*2+1;if(!(c<0||c>=e||d<0||d>=e))return cwt.selectionTargets_[c][d];cwt.error("position ({0},{1}) is out of move map bounds",a,b)},cwt.receiveTargetFromSelection=cwt.util.GAME_CLIENT_NOTICE_FN,cwt.transaction(cwt.receiveTargetFromSelection),cwt.onInit("input controller",function(){var a=cwt.MAX_MOVE_RANGE*2+1;cwt.input.init(),cwt.selectionTargets_=cwt.util.matrix(a,a,-1)}),cwt._moveCardPool=null,cwt.MAX_MOVE_RANGE=15,cwt.MOVE_CODE_UP=0,cwt.MOVE_CODE_RIGHT=1,cwt.MOVE_CODE_DOWN=2,cwt.MOVE_CODE_LEFT=3,cwt.onInit("move",function(){cwt.transaction("_movePath"),cwt._moveCardPool=cwt.util.objectPool(function(a){var b,c,d;a.uid=-1,a.x=-1,a.y=-1,a.r=-1,b=cwt.MAX_MOVE_RANGE*2+1;if(a.moveMap===undefined)a.moveMap=cwt.util.matrix(b,b,-1);else for(c=0;c<b;c++)for(d=0;d<b;d++)a.moveMap[c][d]=-1;a.moveMapX=-1,a.moveMapY=-1,a.way===undefined?a.way=[]:a.way.splice(0)})}),cwt.moveCosts=function(a,b){var c=a.costs[b];return c!==undefined?c:a.costs["*"]},cwt.moveCostsForPos=function(a,b,c){var d=b-a.moveMapX,e=c-a.moveMapY;if(!(d<0||e<0||d>=2*cwt.MAX_MOVE_RANGE+1||e>=2*cwt.MAX_MOVE_RANGE+1))return a.moveMap[d][e];cwt.error("position {0},{1} is out of move map bounds",b,c)},cwt.createMoveCard=function(a,b,c){var b,c,d,e,f,g,h,i,j=cwt.unitById(a),k=cwt.unitSheet(j.type),l=cwt.movetypeSheet(k.moveType),m=cwt.player(j.owner);arguments.length===1&&(b=j.x,c=j.y),d=cwt._moveCardPool.request(),d.uid=a,d.x=b,d.y=c,d.r=k.moveRange,d.moveMapX=Math.max(d.x-cwt.MAX_MOVE_RANGE,0),d.moveMapY=Math.max(d.y-cwt.MAX_MOVE_RANGE,0),j.fuel<d.r&&(d.r=j.fuel),d.moveMap[d.x-d.moveMapX][d.y-d.moveMapY]=d.r,f=[[b,c,d.r]];while(f.length>0)e=f[0],f.splice(0,1),e[1]>0&&cwt._moveCheck(e[0],e[1]-1,e[2],l,d.moveMap,d.moveMapX,d.moveMapY,f,m),e[0]<cwt.mapWidth-1&&cwt._moveCheck(e[0]+1,e[1],e[2],l,d.moveMap,d.moveMapX,d.moveMapY,f,m),e[1]<cwt.mapHeight-1&&cwt._moveCheck(e[0],e[1]+1,e[2],l,d.moveMap,d.moveMapX,d.moveMapY,f,m),e[0]>0&&cwt._moveCheck(e[0]-1,e[1],e[2],l,d.moveMap,d.moveMapX,d.moveMapY,f,m);g=cwt.MAX_MOVE_RANGE*2+1;for(b=0,h=g;b<h;b++)for(c=0,i=g;c<i;c++)d.moveMap[b-d.moveMapX][c-d.moveMapY]!=-1&&(d.moveMap[b-d.moveMapX][c-d.moveMapY]=cwt.moveCosts(l,cwt._map[b][c]));return cwt.DEBUG&&cwt.info("result move card\n {0}",d),d},cwt.returnPath=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n=f.moveMap,o=cwt.unitById(f.uid),p=cwt.unitSheet(o.type),q=cwt.movetypeSheet(p.moveType),r=new Graph(f.moveMap),s=r.nodes[b-f.moveMapX][c-f.moveMapY],t=r.nodes[d-f.moveMapX][e-f.moveMapY],u=astar.search(r.nodes,s,t);cwt.DEBUG&&cwt.info("path:{0}",u),g=[],h=b-f.moveMapX,i=c-f.moveMapY;for(k=0,l=u.length;k<l;k++){j=u[k],j.x>h&&(m=1),j.x<h&&(m=3),j.y>i&&(m=2),j.y<i&&(m=0);if(m===undefined)throw Error();g.push(m),h=j.x,i=j.y}return g},cwt.moveUnit=function(a){var b,c,d=a.x,e=a.y,f=a.way,g=cwt.unitById(a.uid),h=cwt.unitSheet(g.type),i=cwt.movetypeSheet(h.moveType),j=f.length-1,k=0;for(b=0,c=f.length;b<c;b++){switch(f[b]){case cwt.MOVE_CODE_UP:e===0&&cwt.error("cannot do move command UP because current position is at the border"),e--;break;case cwt.MOVE_CODE_RIGHT:d===cwt.mapWidth-1&&cwt.error("cannot do move command UP because current position is at the border"),d++;break;case cwt.MOVE_CODE_DOWN:e===cwt.mapHeight-1&&cwt.error("cannot do move command DOWN because current position is at the border"),e++;break;case cwt.MOVE_CODE_LEFT:d===0&&cwt.error("cannot do move command LEFT because current position is at the border"),d--;break;default:throw Error("unknown command "+f[b])}if(cwt._wayBlocked(d,e,g.owner,b==c-1)){j=b-1;switch(f[b]){case cwt.MOVE_CODE_UP:e++;break;case cwt.MOVE_CODE_RIGHT:d--;break;case cwt.MOVE_CODE_DOWN:e--;break;case cwt.MOVE_CODE_LEFT:d++}j==-1&&cwt.error("unit is blocked by an enemy, but the enemy stands beside the start tile, that is a logic fault!");break}k+=cwt.moveCosts(i,cwt._map[d][e])}g.fuel-=k,cwt.setUnitPosition(a.uid),cwt._movePath(a.uid,a.x,a.y,j!==f.length-1?f.slice(0,j+1):f),cwt.setUnitPosition(a.uid,d,e),cwt.DEBUG&&cwt.info("moved unit {0} from ({1},{2}) to ({3},{4})",a.uid,a.x,a.y,d,e)},cwt._movePath=function(){},cwt._moveCheck=function(a,b,c,d,e,f,g,h,i){var j,k,l=cwt.moveCosts(d,cwt._map[a][b]);if(l!=0){j=cwt.unitByPos(a,b);if(j!==null&&cwt.player(j.owner).team!==i.team)return;k=c-l,k>=0&&e[a-f][b-g]<k&&(h.push([a,b,k]),e[a-f][b-g]=k)}},cwt._wayBlocked=function(a,b,c,d){var e=cwt.unitByPos(a,b);if(e!==null)if(e.owner===c)d&&cwt._transportRelation[cwt.extractUnitId(e)]===undefined&&cwt.error("cannot move onto a tile that is occupied by an own unit");else{if(cwt.player(e.owner).team!==cwt.player(c).team)return!0;d&&cwt.error("cannot move onto a tile that is occupied by an allied unit")}return!1},cwt.onInit("properties",function(){cwt.transaction("captureProperty"),cwt.userAction("captureProperty",function(a,b,c,d,e,f){f!==null&&d!==null&&cwt.unitSheet(f.type).captures>0&&cwt.player(d.owner).team!==cwt.player(f.owner).team&&a([b,c,cwt.extractUnitId(f)])})}),cwt.captureProperty=function(a,b,c){var d,e,f,g,h,i=cwt.unitById(c),j=cwt.unitSheet(i.type),k=cwt.propertyByPos(a,b);k.capturePoints-=j.captures;if(k.capturePoints<=0){cwt.DEBUG&&cwt.info("property at ({0},{1}) captured",a,b);if(k.type==="HQ"){d=cwt.player(k.owner),e=cwt.selectOwnUnits(k.owner);for(f=0,g=e.length;f<g;f++)e[f].team=-1,cwt._unitPosMap[e[f].x][e[f].y]=null;h=cwt.selectOwnProperties(k.owner);for(f=0,g=h.length;f<g;f++)h[f].owner=-1;d.team=-1,cwt.winnerExists()&&cwt.DEBUG&&cwt.info("the game ends because no opposite players exists")}k.capturePoints=20,k.owner=i.owner}cwt._localWait(i)},cwt._createPidTidSelector=function(a,b){var c=cwt._units;return function(d){var e,f,g,h,i=[],j=cwt.player(d).team,k=-1,l=-1;for(e=0,f=c.length;e<f;e++){if(e%cwt.MAX_UNITS_PER_PLAYER===0){k++,g=cwt.player(k);if(g===null){e+=cwt.MAX_UNITS_PER_PLAYER-1;continue}l=g.team}h=cwt.unitById(e),h!==null&&k===d===a&&l===j===b&&(i[i.length]=h)}return i}},cwt._createPidTidSelectorProperties=function(a,b){var c=cwt._properties;return function(d){var e,f,g,h=[],i=cwt.player(d).team;for(e=0,f=c.length;e<f;e++)g=cwt.propertyById(e),g!==null&&g.owner!==-1&&g.owner===d===a&&cwt.player(g.owner).team===i===b&&(h[h.length]=g);return h}},cwt.selectOwnUnits=null,cwt.selectEnemyUnits=null,cwt.selectAlliedUnits=null,cwt.selectOwnProperties=null,cwt.selectEnemyProperties=null,cwt.selectAlliedProperties=null,cwt.onInit("selectors",function(){cwt.selectOwnUnits=cwt._createPidTidSelector(!0,!0),cwt.selectEnemyUnits=cwt._createPidTidSelector(!1,!1),cwt.selectAlliedUnits=cwt._createPidTidSelector(!1,!0),cwt.selectOwnProperties=cwt._createPidTidSelectorProperties(!0,!0),cwt.selectEnemyProperties=cwt._createPidTidSelectorProperties(!1,!1),cwt.selectAlliedProperties=cwt._createPidTidSelectorProperties(!1,!0)}),cwt.turnPid_=-1,cwt.turnActors_=null,cwt.day=0,cwt.onInit("turn",function(){cwt.turnActors_=cwt.util.list(cwt.MAX_UNITS_PER_PLAYER,-1),cwt.serializedProperty("_turnPid"),cwt.serializedProperty("_turnActors"),cwt.userAction("nextTurn",function(a,b,c,d,e,f){f===null&&a([])}),cwt.userInvokableTransaction("wait",function(a,b,c,d,e,f){f!==null&&a([f])})}),cwt.canAct=function(a){var b,c=cwt.turnPid_*cwt.MAX_UNITS_PER_PLAYER;return a<c||a>=c+cwt.MAX_UNITS_PER_PLAYER?!1:(b=a-c,cwt.turnActors_[b]===!0)},cwt.wait=function(a){cwt._localWait(a)},cwt._localWait=function(a){var b=typeof a=="number"?a:cwt.extractUnitId(a),c=cwt.turnPid_*cwt.MAX_UNITS_PER_PLAYER;(b<c||b>=c+cwt.MAX_UNITS_PER_PLAYER)&&cwt.error("unit owner is not the active player"),cwt.turnActors_[b-c]=!1,cwt.DEBUG&&cwt.info("unit {0} going into wait status",b)},cwt.nextTurn=function(){var a,b,c,d,e;cwt.DEBUG&&cwt.info("ending turn"),a=cwt.turnPid_,a!==-1&&cwt._turnEnd(cwt.player(a)),b=a,a++;while(a!==b){if(cwt.player(a)!==null)break;a++,a===cwt.MAX_PLAYER&&(a=0)}a===b&&cwt.error("cannot find next player"),cwt.turnPid_=a,c=a*cwt.MAX_UNITS_PER_PLAYER;for(d=c,e=d+cwt.MAX_UNITS_PER_PLAYER;d<e;d++)cwt.turnActors_[d-c]=cwt.unitById(d)!==null?!0:!1;cwt._turnStart(cwt.player(a))},cwt._turnStart=function(a){cwt.DEBUG&&cwt.info(a.name+" starts his turn")},cwt._turnEnd=function(a){cwt.DEBUG&&cwt.info(a.name+" ends his turn")},cwt.winnerExists=function(){var a,b,c,d;for(b=0;b<cwt.MAX_PLAYER;b++){c=cwt.player(b);if(c===null)continue;d=c.team;if(a===undefined)a=d;else if(a!==d)return!1;return!0}}