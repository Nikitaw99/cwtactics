var TILE_LENGTH=16;controller.baseSize=16,view.preventRenderUnit=null,view.canvasCtx=controller.screenElement.getContext("2d"),view.selectionRange=2,view.colorArray=[view.COLOR_RED,view.COLOR_BLUE,view.COLOR_GREEN,view.COLOR_YELLOW],view.renderMap=function(){var e=TILE_LENGTH,t=view.canvasCtx;controller.screenX,controller.screenY;for(var o,n,r,i,l,a,s,c,d,u,m,p=controller.mapCursorX,f=controller.mapCursorY,E=view.getSpriteStep("SELECTION"),h=view.getSpriteStep("UNIT"),v=view.getSpriteStep("UNIT_SIMPLE"),I=view.getSpriteStep("PROPERTY"),T=view.getSpriteStep("STATUS"),_=view.getSpriteStep("ANIM_TILES"),g=controller.baseSize,A=model.graphics.simpleAnimatedUnits,y=-1!==model.lastActiveClientPid?model.players[model.lastActiveClientPid].team:-1,w="MOVEPATH_SELECTION"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state||controller.attackRangeVisible,S="ACTION_SELECT_TILE"===controller.stateMachine.state,N=controller.stateMachine.data,L=N.selection,O=model.mapHeight-1,C=0;O>=C;C++)for(var M=model.mapWidth-1,R=0;M>=R;R++)if(m=0===model.clientFogData[R][C],view.drawScreen[R][C]===!0){o=view.mapImages[R][C],n=view.getTileImageForType(o),r=0,i=0,view.animatedTiles[o]&&(r+=g*_),l=g,a=2*g,s=R*e,c=C*e-e,d=e,u=2*e,0>c&&(i+=g,a-=g,c+=e,u-=e),void 0!==n?(t.drawImage(n,r,i,l,a,s,c,d,u),m&&(n=view.getTileShadowImageForType(view.mapImages[R][C]),t.globalAlpha=.35,t.drawImage(n,r,i,l,a,s,c,d,u),t.globalAlpha=1)):(t.fillStyle="rgb(0,0,255)",t.fillRect(s,c,e,e));var P=model.propertyPosMap[R][C];if(null!==P){var b;if(o=P.type.ID,-1===P.owner)b=view.COLOR_NEUTRAL;else if(b=view.colorArray[P.owner],P.type.factionSprites){var D=model.coData[P.owner].coA;D&&(o=P.type.factionSprites[D.faction])}m&&(b=view.COLOR_NEUTRAL),n=view.getPropertyImageForType(o,b),r=0+g*I,i=0,l=g,a=2*g,s=R*e,c=C*e-e,d=e,u=2*e,0>c&&(i+=g,a-=g,c+=e,u-=e),void 0!==n?(t.drawImage(n,r,i,l,a,s,c,d,u),m&&(n=view.getPropertyImageForType(P.type.ID,view.COLOR_BLACK_MASK),t.globalAlpha=.35,t.drawImage(n,r,i,l,a,s,c,d,u),t.globalAlpha=1)):(s=R*e,c=C*e,d=e,u=e,t.fillStyle="rgb(0,255,0)",t.fillRect(s,c,d,u))}if(w){n=view.getInfoImageForType("MOVEPATH_SELECTION"===controller.stateMachine.state?"MOVE_FOC":"ATK_FOC");var U=L.getValueAt(R,C);U>0&&(r=g*E,i=0,l=g,a=g,s=R*e,c=C*e,d=e,u=e,t.globalAlpha=.65,t.drawImage(n,r,i,l,a,s,c,d,u),t.globalAlpha=1)}if(S){var x=model.distance(p,f,R,C);if(view.selectionRange===x){var n=null;n=0===x?view.getInfoImageForType("SILO_ALL"):p===R?f>C?view.getInfoImageForType("SILO_N"):view.getInfoImageForType("SILO_S"):f===C?p>R?view.getInfoImageForType("SILO_W"):view.getInfoImageForType("SILO_E"):p>R?f>C?view.getInfoImageForType("SILO_NW"):view.getInfoImageForType("SILO_SW"):f>C?view.getInfoImageForType("SILO_NE"):view.getInfoImageForType("SILO_SE"),s=R*e,c=C*e,null!==n&&t.drawImage(n,s,c)}}var k=model.unitPosMap[R][C],F=null!==k?controller.getUnitStatusForUnit(k):null;if(!m&&null!==k&&(k.owner===model.turnOwner||model.players[k.owner].team==y||F.VISIBLE)&&k!==view.preventRenderUnit){var b,G=A[k.type.ID]?v:h;b=-1===k.owner?view.COLOR_NEUTRAL:view.colorArray[k.owner];var H;if(H=k.type.cannon?view.IMAGE_CODE_IDLE:1===k.owner%2?view.IMAGE_CODE_IDLE:view.IMAGE_CODE_IDLE_INVERTED,n=view.getUnitImageForType(k.type.ID,H,b),r=2*g*G,i=0,l=2*g,a=2*g,s=R*e-e/2,c=C*e-e/2,d=e+e,u=e+e,void 0!==n?(t.drawImage(n,r,i,l,a,s,c,d,u),k.owner!==model.turnOwner||model.canAct(model.extractUnitId(k))||(t.globalAlpha=.5,t.drawImage(view.getUnitImageForType(k.type.ID,H,view.COLOR_BLACK_MASK),r,i,l,a,s,c,d,u),t.globalAlpha=1)):(s=R*e,c=C*e,d=e,u=e,t.fillStyle="rgb(255,0,0)",t.fillRect(s,c,d,u)),n=F.HP_PIC,null!==n&&t.drawImage(n,s+e,c+e),0!==T&&1!==T&&4!==T&&5!==T&&8!==T&&9!==T&&12!==T&&13!==T&&16!==T&&17!==T){var B=parseInt(T/4,10);n=null;var V=B;do{if(0===V&&F.LOW_AMMO?n=view.getInfoImageForType("SYM_AMMO"):1===V&&F.CAPTURES?n=view.getInfoImageForType("SYM_CAPTURE"):2===V&&F.LOW_FUEL?n=view.getInfoImageForType("SYM_FUEL"):3===V&&F.HAS_LOADS?n=view.getInfoImageForType("SYM_LOAD"):4===V&&k.hidden&&(n=view.getInfoImageForType("SYM_HIDDEN")),null!==n)break;V++,5===V&&(V=0)}while(V!==B);null!==n&&t.drawImage(n,s+e/2,c+e)}}view.drawScreen[R][C]=!1}if("MOVEPATH_SELECTION"===controller.stateMachine.state)for(var W,Y,X,K,j=N.movePath.data,J=N.source.x,z=N.source.y,q=0,$=j.length;$>q&&-1!==j[q]&&null!==j[q];q++){switch(W=J,Y=z,j[q]){case model.moveCodes.UP:z--;break;case model.moveCodes.RIGHT:J++;break;case model.moveCodes.DOWN:z++;break;case model.moveCodes.LEFT:J--}if(-1===j[q+1]||null===j[q+1])X=-1,K=-1;else switch(j[q+1]){case model.moveCodes.UP:X=J,K=z-1;break;case model.moveCodes.RIGHT:X=J+1,K=z;break;case model.moveCodes.DOWN:X=J,K=z+1;break;case model.moveCodes.LEFT:X=J-1,K=z}if(-1==X)switch(j[q]){case model.moveCodes.UP:n=view.getTileImageForType("ARROW_N");break;case model.moveCodes.RIGHT:n=view.getTileImageForType("ARROW_E");break;case model.moveCodes.DOWN:n=view.getTileImageForType("ARROW_S");break;case model.moveCodes.LEFT:n=view.getTileImageForType("ARROW_W")}else{var Z=Math.abs(X-W),Q=Math.abs(K-Y);if(2===Z)n=view.getTileImageForType("ARROW_WE");else if(2===Q)n=view.getTileImageForType("ARROW_NS");else if(J>X&&Y>z||J>W&&K>z)n=view.getTileImageForType("ARROW_SW");else if(J>X&&z>Y||J>W&&z>K)n=view.getTileImageForType("ARROW_WN");else if(X>J&&z>Y||W>J&&z>K)n=view.getTileImageForType("ARROW_NE");else{if(!(X>J&&Y>z||W>J&&K>z)){util.raiseError("illegal move arrow state","old (",W,",",Y,")","current (",J,",",z,")","next (",X,",",K,")","path (",j,")");continue}n=view.getTileImageForType("ARROW_ES")}}J>=0&&z>=0&&controller.screenWidth>J&&controller.screenHeight>z&&t.drawImage(n,J*e,z*e)}t.lineWidth=2,t.strokeStyle="#f00",t.strokeRect(e*controller.mapCursorX+1,e*controller.mapCursorY+1,e-2,e-2),view.drawScreenChanges=0};