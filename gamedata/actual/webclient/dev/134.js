util.scoped(function(){function e(){function e(){if(!controller.inGameRound)return controller.screenStateMachine.event("gameHasEnded"),void 0;requestAnimationFrame(e);var o=(new Date).getTime(),n=o-t;t=o,controller.gameLoop(n)}constants.DEBUG&&util.log("setup animation frame"),controller.prepareGameLoop();var t=(new Date).getTime();requestAnimationFrame(e)}controller.screenStateMachine.structure.GAMEROUND=Object.create(controller.stateParent),controller.screenStateMachine.structure.GAMEROUND.section="cwt_game_screen",controller.screenStateMachine.structure.GAMEROUND.enterState=function(){controller.setCursorPosition(0,0),controller.startGameRound();for(var t=0,o=model.units.length;o>t;t++)model.units[t].owner!==constants.INACTIVE_ID&&controller.updateUnitStatus(t);view.resizeCanvas(),view.updateMapImages(),view.completeRedraw(),controller.setScreenScale(2),e()},controller.screenStateMachine.structure.GAMEROUND.gameHasEnded=function(){return"MAIN"},controller.screenStateMachine.structure.GAMEROUND.LEFT=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.breakTransition()):(t||(t=1),1===t?controller.moveCursor(model.moveCodes.LEFT,t):controller.shiftScreenPosition(model.moveCodes.LEFT,t),this.breakTransition())},controller.screenStateMachine.structure.GAMEROUND.RIGHT=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.breakTransition()):(t||(t=1),1===t?controller.moveCursor(model.moveCodes.RIGHT,t):controller.shiftScreenPosition(model.moveCodes.RIGHT,t),this.breakTransition())},controller.screenStateMachine.structure.GAMEROUND.UP=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.breakTransition();var n="ACTION_MENU"===o||"ACTION_SUBMENU"===o;return t||(t=1),n?controller.decreaseMenuCursor():1===t?controller.moveCursor(model.moveCodes.UP,t):controller.shiftScreenPosition(model.moveCodes.UP,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.DOWN=function(e,t){controller.hideAttackRangeInfo();var o=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===o||"ACTION_SELECT_TARGET_B"===o)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.breakTransition();var n="ACTION_MENU"===o||"ACTION_SUBMENU"===o;return t||(t=1),n?controller.increaseMenuCursor():1===t?controller.moveCursor(model.moveCodes.DOWN,t):controller.shiftScreenPosition(model.moveCodes.DOWN,t),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.ACTION=function(e,t,o){return controller.hideAttackRangeInfo(),"number"==typeof t&&(controller.eraseWantedCursorPosition(),controller.setCursorPosition(t,o)),controller.cursorActionClick(),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.HOVER=function(e,t,o){return controller.setWantedCursorPosition(t,o),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.CANCEL=function(e,t,o){return controller.hideAttackRangeInfo(),"number"==typeof t&&(controller.eraseWantedCursorPosition(),controller.setCursorPosition(t,o)),controller.cursorActionCancel(),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_1=function(){return this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_2=function(){return this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_3=function(){return controller.attackRangeVisible||controller.showAttackRangeInfo(),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_4=function(){return this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_5=function(){return controller.setScreenScale(controller.screenScale+1),this.breakTransition()},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_6=function(){return controller.setScreenScale(controller.screenScale-1),this.breakTransition()}});