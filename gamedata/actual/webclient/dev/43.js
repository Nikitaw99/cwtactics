controller.registerInvokableCommand("setUnitPosition"),controller.registerInvokableCommand("clearUnitPosition"),controller.registerInvokableCommand("moveUnit"),controller.defineEvent("setUnitPosition"),controller.defineEvent("clearUnitPosition"),controller.defineEvent("moveUnit"),controller.defineGameScriptable("moverange",1,constants.MAX_SELECTION_RANGE),controller.defineGameScriptable("movecost",1,constants.MAX_SELECTION_RANGE),model.moveTypeParser.addHandler(function(e){if(!util.expectObject(e,"costs",!0))return!1;for(var t=e.costs,o=Object.keys(t),n=0,r=o.length;r>n;n++){if(!util.expectNumber(t,o[n],!0,!0,-1,constants.MAX_SELECTION_RANGE))return!1;if(!util.not(t,o[n],0))return!1}}),model.moveCodes={UP:0,RIGHT:1,DOWN:2,LEFT:3},model.moveUnit=function(e,t,o,n,r){var l=o,a=n,i=model.units[t],s=i.type,c=model.moveTypes[s.movetype],d=!1,u=(e.length-1,0);controller.events.moveUnit(e,t,o,n);for(var m=0,p=e.length;p>m;m++){switch(e[m]){case model.moveCodes.UP:0===a&&(d=!0),a--;break;case model.moveCodes.RIGHT:l===model.mapWidth-1&&(d=!0),l++;break;case model.moveCodes.DOWN:a===model.mapHeight-1&&(d=!0),a++;break;case model.moveCodes.LEFT:0===l&&(d=!0),l--;break;default:}d&&model.criticalError(constants.error.ILLEGAL_PARAMETERS,constants.error.ILLEGAL_MOVE_PATH),r&&(u+=model.moveCosts(c,l,a))}if(i.fuel-=u,0>i.fuel&&model.criticalError(constants.error.ILLEGAL_DATA,constants.error.NOT_ENOUGH_FUEL),i.x>=0&&i.y>=0){var E=model.propertyPosMap[i.x][i.y];E&&model.resetCapturePoints(model.extractPropertyId(E)),model.clearUnitPosition(t)}null===model.unitPosMap[l][a]&&model.setUnitPosition(t,l,a)},model.clearUnitPosition=function(e){var t=model.units[e],o=t.x,n=t.y;model.modifyVisionAt(o,n,t.owner,t.type.vision,-1),model.unitPosMap[o][n]=null,t.x=-t.x,t.y=-t.y;var r=controller.events.clearUnitPosition;r&&r(e)},model.setUnitPosition=function(e,t,o){var n=model.units[e];n.x=t,n.y=o,model.unitPosMap[t][o]=n,model.modifyVisionAt(t,o,n.owner,n.type.vision,1);var r=controller.events.setUnitPosition;r&&r(e,t,o)},model.moveCosts=function(e,t,o){var n,r=model.map[t][o];return n=e.costs[r.ID],"number"==typeof n?n:(n=e.costs[r.movetype],"number"==typeof n?n:(n=e.costs["*"],"number"==typeof n?n:-1))},model.canTypeMoveTo=function(e,t,o){return model.isValidPosition(t,o)?-1===model.moveCosts(e,t,o)?!1:0===model.fogData[t][o]?!0:null!==model.unitPosMap[t][o]?!1:!0:void 0},model.moveCodeFromAtoB=function(e,t,o,n){return model.distance(e,t,o,n)>1&&model.criticalError(constants.error.ILLEGAL_PARAMETERS,constants.error.POSITIONS_SHOULD_BE_NEIGHBORS),o>e?model.moveCodes.RIGHT:e>o?model.moveCodes.LEFT:n>t?model.moveCodes.DOWN:t>n?model.moveCodes.UP:(model.criticalError(constants.error.ILLEGAL_PARAMETERS,constants.error.UNKNOWN),void 0)},model.generatePath=function(e,t,o,n,r,l){var a,i=new Graph(r.data),s=e-r.centerX,c=t-r.centerY,d=i.nodes[s][c],u=o-r.centerX,m=n-r.centerY,p=i.nodes[u][m],E=astar.search(i.nodes,d,p),f=e,A=t;l.resetValues();for(var _=0,T=0,h=E.length;h>T;T++){a=E[T];var I;a.x>f?I=model.moveCodes.RIGHT:f>a.x?I=model.moveCodes.LEFT:a.y>A?I=model.moveCodes.DOWN:A>a.y?I=model.moveCodes.UP:model.criticalError(constants.error.ILLEGAL_DATA,constants.error.ILLEGAL_MOVE_CODE),l[_]=I,_++,f=a.x,A=a.y}},model.addMoveCodeToPath=function(e,t){var o,n=t.getLastCode();switch(e){case model.moveCodes.UP:o=model.moveCodes.DOWN;break;case model.moveCodes.DOWN:o=model.moveCodes.UP;break;case model.moveCodes.LEFT:o=model.moveCodes.RIGHT;break;case model.moveCodes.RIGHT:o=model.moveCodes.LEFT;break;default:model.criticalError(constants.error.ILLEGAL_DATA,constants.error.ILLEGAL_MOVE_PATH)}if(n===o)return t[t.getSize()-1]=constants.INACTIVE_ID,!0;var r=controller.stateMachine.data.source,l=r.unit,a=l.fuel,i=0,s=l.type.range;s>a&&(s=a),t[t.getSize()]=e;for(var c=r.x,d=r.y,u=0,m=t.getSize();m>u;u++){switch(t[u]){case model.moveCodes.UP:d--;break;case model.moveCodes.DOWN:d++;break;case model.moveCodes.LEFT:c--;break;case model.moveCodes.RIGHT:c++;break;default:model.criticalError(constants.error.ILLEGAL_DATA,constants.error.ILLEGAL_MOVE_CODE)}i+=controller.stateMachine.data.selection.getValueAt(c,d)}return i>s?(t[t.getSize()-1]=constants.INACTIVE_ID,!1):!0},model.fillMoveMapHelper=[],model.fillMoveMap=function(e,t,o,n,r){"number"!=typeof o&&(o=e.x),"number"!=typeof n&&(n=e.y),r||(r=e.unit);var l,a=!1;null!==model.fillMoveMapHelper?(l=model.fillMoveMapHelper,model.fillMoveMapHelper=null,a=!0):l=[];var i=model.moveTypes[r.type.movetype],s=model.players[r.owner];controller.prepareTags(o,n,model.extractUnitId(r));var c=controller.scriptedValue(r.owner,"moverange",r.type.range);c>r.fuel&&(c=r.fuel),t.setCenter(o,n,constants.INACTIVE_ID),t.setValueAt(o,n,c),l[0]=o,l[1]=n,l[2]=c;for(var d=[-1,-1,-1,-1,-1,-1,-1,-1];;){for(var u=-1,m=-1,p=0,E=l.length;E>p;p+=3){var f=l[p+2];void 0!==f&&null!==f&&(-1===u||f>u)&&(u=f,m=p)}if(-1===m)break;var A=l[m],_=l[m+1],T=l[m+2];l[m]=null,l[m+1]=null,l[m+2]=null,A>0?(d[0]=A-1,d[1]=_):(d[0]=-1,d[1]=-1),model.mapWidth-1>A?(d[2]=A+1,d[3]=_):(d[2]=-1,d[3]=-1),_>0?(d[4]=A,d[5]=_-1):(d[4]=-1,d[5]=-1),model.mapHeight-1>_?(d[6]=A,d[7]=_+1):(d[6]=-1,d[7]=-1);for(var h=0;8>h;h+=2)if(-1!==d[h]){var I=d[h],v=d[h+1],N=model.moveCosts(i,I,v);if(-1!==N){var y=model.unitPosMap[I][v];if(null!==y&&model.fogData[I][v]>0&&!y.hidden&&model.players[y.owner].team!==s.team)continue;var g=T-N;if(g>=0&&g>t.getValueAt(I,v)){t.setValueAt(I,v,g);for(var p=0,E=l.length;E>=p;p+=3)if(null===l[p]||p===E){l[p]=I,l[p+1]=v,l[p+2]=g;break}}}}}if(a){for(var L=0,S=l.length;S>L;L++)l[L]=null;model.fillMoveMapHelper=l}for(o=0,xe=model.mapWidth;xe>o;o++)for(n=0,ye=model.mapHeight;ye>n;n++)t.getValueAt(o,n)!==constants.INACTIVE_ID&&(N=model.moveCosts(i,o,n),t.setValueAt(o,n,N))};