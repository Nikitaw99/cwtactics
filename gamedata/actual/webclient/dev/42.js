controller.registerInvokableCommand("recalculateFogMap"),controller.registerInvokableCommand("modifyVisionAt"),controller.defineEvent("modifyVisionAt"),controller.defineEvent("recalculateFogMap"),controller.defineGameScriptable("vision",1,40),controller.defineGameConfig("fogEnabled",0,1,1),model.unitTypeParser.addHandler(function(e){return util.expectNumber(e,"vision",!0,!0,1,constants.MAX_SELECTION_RANGE)?void 0:!1}),model.tileTypeParser.addHandler(function(e){return util.expectNumber(e,"vision",!1,!0,0,constants.MAX_SELECTION_RANGE)?void 0:!1}),model.fogData=util.matrix(constants.MAX_MAP_WIDTH,constants.MAX_MAP_HEIGHT,0),model.clientFogData=util.matrix(constants.MAX_MAP_WIDTH,constants.MAX_MAP_HEIGHT,0),model.clientFogVisible=util.matrix(constants.MAX_PLAYER,!1),model.turnOwnerFogVisible=util.matrix(constants.MAX_PLAYER,!1),controller.persistenceHandler(function(){},function(){}),model.remoteConnectOfPlayer=function(e){model.isValidPlayerId(e)||model.criticalError(constants.error.ILLEGAL_PARAMETERS,constants.error.UNKNOWN_PLAYER_ID),model.clientInstances[e]&&model.criticalError(constants.error.ILLEGAL_PARAMETERS,constants.error.GAME_STATE_BREAK)},model.updateVisiblePid=function(){for(var e=model.players[model.lastActiveClientPid].team,t=model.players[model.turnOwner].team,o=0,n=constants.MAX_PLAYER;n>o;o++)model.clientFogVisible[o]=model.clientInstances[o]===!0||e===model.players[o].team,model.turnOwnerFogVisible[o]=o===model.turnOwner||t===model.players[o].team},model.modifyVisionAt=function(e,t,o,n,r){if(controller.configValue("fogEnabled")){controller.prepareTags(e,t),n>0&&(n=controller.scriptedValue(o,"vision",n));var l=model.clientFogVisible[o],i=model.turnOwnerFogVisible[o];if(l||i){if(0===n)l&&(model.clientFogData[e][t]+=r),i&&(model.fogData[e][t]+=r);else{var a,s,c=model.mapHeight,d=model.mapWidth,u=t-n,m=t+n;for(0>u&&(u=0),m>=c&&(m=c-1);m>=u;u++){var p=Math.abs(u-t);for(a=e-n+p,s=e+n-p,0>a&&(a=0),s>=d&&(s=d-1);s>=a;a++)util.log("("+a+","+u+") changed fog by ("+r+")"),l&&(model.clientFogData[a][u]+=r),i&&(model.fogData[a][u]+=r)}}controller.events.modifyVisionAt(e,t,o,n,r)}}},model.recalculateFogMap=function(){var e,t,o=model.mapWidth,n=model.mapHeight,r=1===controller.configValue("fogEnabled");for(e=0;o>e;e++)for(t=0;n>t;t++)r?(model.clientFogData[e][t]=0,model.fogData[e][t]=0):(model.clientFogData[e][t]=1,model.fogData[e][t]=1);if(r)for(e=0;o>e;e++)for(t=0;n>t;t++){var l=model.unitPosMap[e][t];if(null!==l){var i=l.type.vision;0>i&&(i=0),model.modifyVisionAt(e,t,l.owner,i,1)}var a=model.propertyPosMap[e][t];if(null!==a){var i=a.type.vision;0>i&&(i=0),model.modifyVisionAt(e,t,a.owner,i,1)}}controller.events.recalculateFogMap()};