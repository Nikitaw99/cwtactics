(function(){function t(){return E}function e(){return _}function n(){null!==this.history&&this.history&&this.history.splice(0)}function r(){this.state=u,this.lastState=null,this.clearHistory()}function i(t){var e=this.structure[this.state][t];if(void 0===e)return this.onerror(t,this.state,"N/A",constants.error.STM_NO_EVENT),void 0;var n=e.apply(this,arguments);if(n||this.onerror(t,this.state,n,constants.error.STM_INVALID_NEXT_STATE),n===_&&"actionState"===t)return this.onerror(t,this.state,n,constants.error.STM_ACTIONSTATE_BREAKS_TRANS),void 0;if(n!==_){var r=n===this.backToLastState();r&&(null===this.history&&this.onerror(t,this.state,n,constants.error.STM_BACK_TRANSITION_NO_HISTORY),1===this.history.length?n="IDLE":(this.history.pop(),n=this.history[this.history.length-1]));var i=this.structure[n],o=this.state;if(this.state=n,!i)return this.state=o,this.onerror(t,this.state,n,constants.error.STM_NEXT_STATE_MISSING),void 0;if(i.onenter){var s=i.onenter.apply(this,arguments);if(s===_)return this.state=o,void 0}null===this.history||r||this.history.push(this.state),void 0!==i.actionState&&this.event.call(this,"actionState")}}function o(t,e,n,r){util.log("state machine error (code:",r,"ev:",t,"from:",e,"to:",n,")")}function s(s,E){var _={};return _.structure=s?s:{},_.state=u,_.lastState=null,_.history=E&&!E.noHistory?null:[],_.reset=r,_.event=i,_.clearHistory=n,_.backToLastState=t,_.breakTransition=e,_.onerror=E&&E.onerror?E.onerror:o,_}var E="$_LAST_STATE",_="$_BREAK_TRANSITION",u="NONE";util.stateMachine=s})();