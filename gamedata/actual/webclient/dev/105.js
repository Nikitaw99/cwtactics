util.scoped(function(){function e(e,t,o){var i=e[e.curStep_].id,l=e[e.curStep_].src,a=e[e.curStep_].music,s=e[e.curStep_].co_music;return r&&(s||a)?(util.log("ignoring co music because device has iOS"),o(e,t),void 0):(controller.storage.has(i,function(r){if(r)constants.DEBUG&&util.log(i,"is in storage"),controller.storage.get(i,function(r){constants.DEBUG&&util.log(i,"will be cached");try{var l=Base64Helper.decodeBuffer(r.value);n.decodeAudioData(l,function(n){controller.registerSoundFile(i,n),o(e,t)},function(e){controller.loadFault(e,t)})}catch(a){controller.loadFault(a,t)}});else{constants.DEBUG&&util.log("load",i,"with HTTP request");var a=new XMLHttpRequest;a.open("GET",l,!0),a.responseType="arraybuffer",a.onload=function(){if(404===this.status)return controller.loadFault({message:"failed to load music file "+i,stack:null},t),void 0;var r=a.response;constants.DEBUG&&util.log("saving",i,"in storage"),controller.storage.set(i,Base64Helper.encodeBuffer(r),function(){constants.DEBUG&&util.log("saved",i,"successfully in storage"),n.decodeAudioData(r,function(n){controller.registerSoundFile(i,n),o(e,t)},function(e){controller.loadFault(e,t)})})},a.send()}}),void 0)}function t(e,t){return e===!0?(controller.loadError="could not grab music",t.pass(!0)):(e.curStep_++,e.curStep_===e.length?(util.log("finished initializing audio system"),t.pass(!1)):o(e,t),void 0)}function o(o,n){e(o,n,t)}var n,r=Browser.ios;controller.loadSoundFiles=util.singleLazyCall(function(e,t){if(e)return constants.DEBUG&&util.log("break at init audio system due error from previous inits"),t.pass(!0);if(util.log("init audio system"),n=controller.audioContext(),null===n)return!1;if(t.take(),model.sounds.length>0){var r=[];r.curStep_=0;for(var i=0,l=model.sounds.length;l>i;i++)r[i]=model.sounds[i];o(r,t)}else t.pass(!1)})});