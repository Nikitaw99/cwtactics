util.scoped(function(){function e(){if(view.hooksBuffer.isEmpty())o=!1;else{o=!0;var e=view.hooksBuffer.pop(),n=e[e.length-1];t=view.animationHooks[n],t.prepare.apply(t,e)}}var t=null,o=!1,n=0;controller.prepareGameLoop=function(){n=0},controller.gameLoop=function(r){n+=r,controller.updateInputCoolDown(r);var l=0!==controller.moveScreenX||0!==controller.moveScreenY;if(-1!==controller.mapTargetCursorX){var i=controller.mapCursorX,a=controller.mapCursorY;view.markForRedrawWithNeighboursRing(i,a);var s=0;i!==controller.mapTargetCursorX&&(s=i-controller.mapTargetCursorX,0>s&&(s=-s),s=s>25?5:s>15?3:s>5?2:1,controller.mapTargetCursorX>i?i+=s:i-=s),a!==controller.mapTargetCursorY&&(s=a-controller.mapTargetCursorY,0>s&&(s=-s),s=s>25?5:s>15?3:s>5?2:1,controller.mapTargetCursorY>a?a+=s:a-=s),controller.setCursorPosition(i,a),i===controller.mapTargetCursorX&&a===controller.mapTargetCursorY&&controller.eraseWantedCursorPosition()}if(l?controller.solveMapShift():(view.hasInfoMessage()?view.updateMessagePanelTime(r):o?(t.update(r),t.isDone()&&e()):(controller.updateState(n),n=0,e()),view.updateSpriteAnimations(r)),view.drawScreenChanges>0&&view.renderMap(controller.screenScale),o)t.render();else if("ACTION_SELECT_TILE"===controller.stateMachine.state){var c,d,u=view.selectionRange,m=controller.mapCursorX,p=controller.mapCursorY,f=p-u,h=p+u;for(0>f&&(f=0),h>=model.mapHeight&&(h=model.mapHeight-1);h>=f;f++){var E=Math.abs(f-p);for(c=m-u+E,d=m+u-E,0>c&&(c=0),d>=model.mapWidth&&(d=model.mapWidth-1);d>=c;c++)view.markForRedraw(c,f)}}},controller.inAnimationHookPhase=function(){return o}});