view={};var ID_MENU_SECTION_VERSION="cwt_versus_screen",ID_ELMT_SECTION_VERSION_LIST="map_selection_field",ID_ELMT_SECTION_VERSION_START="versus_start",ID_ELMT_SECTION_MOBILE="cwt_mobileSound_screen",ID_ELMT_SECTION_MOBILE_NEXT="mobileSoundNext",ID_MENU_SECTION_LOAD="cwt_load_screen",ID_MENU_SECTION_MAIN="cwt_main_screen",ID_ELMT_SECTION_MAIN_ERROR="main_screen_error_msg",ID_ELMT_SECTION_MAIN_BTN_1="main_screen_enter_1",ID_ELMT_SECTION_MAIN_BTN_2="main_screen_enter_2",ID_ELMT_SECTION_MAIN_BTN_3="main_screen_enter_3",ID_ELMT_SECTION_MAIN_BTN_4="main_screen_enter_4",ID_ELMT_SECTION_MAIN_BTN_5="main_screen_enter_5",ID_ELMT_SECTION_MAIN_BTN_6="main_screen_enter_6",ID_MENU_SECTION_GAME="cwt_game_screen",ID_ELMT_GAME_CANVAS="cwt_canvas",ID_ELMT_GAME_MENU="cwt_menu",ID_ELMT_MENU="cwt_menu",ID_ELMT_MENU_HEADER="cwt_menu_header",ID_ELMT_MENU_CONTENT="cwt_menu_content",ID_ELMT_MENU_ENTRIES="cwt_menu_entries",ID_MENU_SECTION_ERROR="cwt_error_screen",ID_ELMT_ERROR_MSG="error_screen_errorMsgField",ID_MENU_SECTION_OPTIONS="cwt_options_screen",ID_ELMT_OTIONS_SFX_VOL="cwt_options_sfxVolume",ID_ELMT_OTIONS_MUSIC_VOL="cwt_options_musicVolume",ID_ELMT_OTIONS_MOD_INFO="cwt_options_modPath",ID_ELMT_OTIONS_MOD_TAKE="cwt_options_modPath_take",ID_ELMT_OTIONS_RESET="cwt_options_reset",ID_ELMT_OTIONS_GOBACK="cwt_options_goBack",ID_ELMT_UNITINFOBOX="cwt_unitinfo_box",ID_ELMT_UNITINFOBOX_NAME="cwt_unitinfo_name",ID_ELMT_UNITINFOBOX_PIC="cwt_unitinfo_picture",ID_ELMT_UNITINFOBOX_DESC="cwt_unitinfo_description",ID_ELMT_UNITINFOBOX_CLASS_D="cwt_unitinfo_class_D",ID_ELMT_UNITINFOBOX_CLASS="cwt_unitinfo_class_C",ID_ELMT_UNITINFOBOX_MVTP_D="cwt_unitinfo_movetype_D",ID_ELMT_UNITINFOBOX_MVTP="cwt_unitinfo_movetype_C",ID_ELMT_UNITINFOBOX_MAINWP_D="cwt_unitinfo_mainwp_D",ID_ELMT_UNITINFOBOX_MAINWP="cwt_unitinfo_mainwp_C",ID_ELMT_UNITINFOBOX_SECWP_D="cwt_unitinfo_secwp_D",ID_ELMT_UNITINFOBOX_SECWP="cwt_unitinfo_secwp_C",ID_ELMT_UNITINFOBOX_HP_D="cwt_unitinfo_HP_D",ID_ELMT_UNITINFOBOX_HP="cwt_unitinfo_HP_C",ID_ELMT_UNITINFOBOX_GAS_D="cwt_unitinfo_Gas_D",ID_ELMT_UNITINFOBOX_GAS="cwt_unitinfo_Gas_C",ID_ELMT_UNITINFOBOX_GAS2="cwt_unitinfo_Gas_C2",ID_ELMT_UNITINFOBOX_AMMO_D="cwt_unitinfo_Ammo_D",ID_ELMT_UNITINFOBOX_AMMO="cwt_unitinfo_Ammo_C",ID_ELMT_UNITINFOBOX_AMMO2="cwt_unitinfo_Ammo_C2",ID_ELMT_UNITINFOBOX_MVRANGE_D="cwt_unitinfo_mvrange_D",ID_ELMT_UNITINFOBOX_MVRANGE="cwt_unitinfo_mvrange_C",ID_ELMT_UNITINFOBOX_VISION_D="cwt_unitinfo_vision_D",ID_ELMT_UNITINFOBOX_VISION="cwt_unitinfo_vision_C",ID_ELMT_UNITINFOBOX_ATTRANGE_D="cwt_unitinfo_attrange_D",ID_ELMT_UNITINFOBOX_ATTRANGE="cwt_unitinfo_attrange_C",ID_ELMT_UNITINFOBOX_ATTRANGE2="cwt_unitinfo_attrange_C2",ID_ELMT_UNITINFOBOX_AG_INF_D="cwt_unitinfo_against_inf_D",ID_ELMT_UNITINFOBOX_AG_INF="cwt_unitinfo_against_inf_C",ID_ELMT_UNITINFOBOX_AG_VEH_D="cwt_unitinfo_against_veh_D",ID_ELMT_UNITINFOBOX_AG_VEH="cwt_unitinfo_against_veh_C",ID_ELMT_UNITINFOBOX_AG_AIR_D="cwt_unitinfo_against_air_D",ID_ELMT_UNITINFOBOX_AG_AIR="cwt_unitinfo_against_air_C",ID_ELMT_UNITINFOBOX_AG_HELI_D="cwt_unitinfo_against_heli_D",ID_ELMT_UNITINFOBOX_AG_HELI="cwt_unitinfo_against_heli_C",ID_ELMT_UNITINFOBOX_AG_SHIP_D="cwt_unitinfo_against_ship_D",ID_ELMT_UNITINFOBOX_AG_SHIP="cwt_unitinfo_against_ship_C",ID_ELMT_UNITINFOBOX_AG_SUB_D="cwt_unitinfo_against_sub_D",ID_ELMT_UNITINFOBOX_AG_SUB="cwt_unitinfo_against_sub_C",ID_ELMT_TILEINFOBOX="cwt_tileinfo_box",ID_ELMT_TILEINFOBOX_NAME="cwt_tileinfo_name",ID_ELMT_TILEINFOBOX_PIC="cwt_tileinfo_picture",ID_ELMT_TILEINFOBOX_DESC="cwt_tileinfo_description",ID_ELMT_TILEINFOBOX_DEFENSE_D="cwt_tileinfo_defense_D",ID_ELMT_TILEINFOBOX_DEFENSE="cwt_tileinfo_defense_C",ID_ELMT_TILEINFOBOX_OWNER_D="cwt_tileinfo_owner_D",ID_ELMT_TILEINFOBOX_OWNER="cwt_tileinfo_owner_C",ID_ELMT_TILEINFOBOX_CAPPT_D="cwt_tileinfo_capturePoints_D",ID_ELMT_TILEINFOBOX_CAPPT="cwt_tileinfo_capturePoints_C",ID_ELMT_PLAYERINFOBOX="cwt_playerinfo_box",ID_ELMT_PLAYERINFOBOX_NAME="cwt_playerinfo_name",ID_ELMT_PLAYERINFOBOX_PIC="cwt_playerinfo_picture",ID_ELMT_PLAYERINFOBOX_DESC="cwt_playerinfo_description",ID_ELMT_PLAYERINFOBOX_POWER_D="cwt_playerinfo_coPower_D",ID_ELMT_PLAYERINFOBOX_POWER="cwt_playerinfo_coPower_C",ID_ELMT_PLAYERINFOBOX_PROPS_D="cwt_playerinfo_numberProp_D",ID_ELMT_PLAYERINFOBOX_PROPS="cwt_playerinfo_numberProp_C",ID_ELMT_PLAYERINFOBOX_UNITS_D="cwt_playerinfo_numberUnits_D",ID_ELMT_PLAYERINFOBOX_UNITS="cwt_playerinfo_numberUnits_C";util.scoped(function(){function e(){return DEBUG&&util.log("dropped input"),this.BREAK_TRANSITION}controller.stateParent={UP:e,LEFT:e,RIGHT:e,DOWN:e,SPECIAL_1:e,SPECIAL_2:e,SPECIAL_3:e,SPECIAL_4:e,SPECIAL_5:e,SPECIAL_6:e,ACTION:e,CANCEL:e,HOVER:e}}),util.singleLazyCall=function(e){var t=!1;return function(){t&&util.raiseError("this function cannot be called twice"),e.apply(null,arguments)}},util.scoped(function(){function e(){if(4==this.readyState)if(4==this.readyState&&200==this.status)if(util.log("grabbed file successfully"),this.asJSON)try{this.winCallback(JSON.parse(this.responseText))}catch(e){this.failCallback(e)}else this.winCallback(this.responseText);else util.log("could not grab file"),this.failCallback(this.statusText)}var t;try{new XMLHttpRequest,t=!0}catch(o){t=!1}util.grabRemoteFile=function(o){var n;util.log("try to grab file",o.path),n=t?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),n.asJSON=o.json,n.winCallback=o.success,n.failCallback=o.error,n.onreadystatechange=e,n.open("get",o.path,!0),n.send()}}),util.scoped(function(){"use strict";var e=window.navigator.userAgent.toLowerCase(),t=/mobile|android|kindle|silk|midp|(windows nt 6\.2.+arm|touch)/.test(e);e=/(chrome|firefox)[ \/]([\w.]+)/.exec(e)||/(iphone|ipad|ipod)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(android)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(webkit|opera)(?:.*version)?[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||[];var o=e[1],n=parseFloat(e[2]);switch(o){case"msie":o="ie",n=doc.documentMode||n;break;case"firefox":o="ff";break;case"ipod":case"ipad":case"iphone":o="ios";break;case"webkit":o="safari"}window.Browser={name:o,mobile:t,version:n},Browser[o]=!0}),controller.colorizeImages=util.singleLazyCall(function(e,t){function o(e){var t=document.createElement("canvas"),o=t.getContext("2d"),n=e.width,r=e.height;return t.width=n,t.height=r,o.drawImage(e,0,0),o.getImageData(0,0,n,r).data}function n(e,t,o,n,r){var i=document.createElement("canvas"),l=i.getContext("2d"),a=e.width,s=e.height;i.width=a,i.height=s,l.drawImage(e,0,0);for(var c=l.getImageData(0,0,a,s),u=4*n*o,d=4*r*o,m=0,_=0;c.height>_;_++)for(var p=0;c.width>p;p++)for(var E=4*_*c.width+4*p,I=c.data[E],f=c.data[E+1],h=c.data[E+2],T=0,v=4*o;v>T;T+=4){var g=t[u+T],O=t[u+T+1],M=t[u+T+2];if(g===I&&O===f&&M===h){var y=d+T,A=t[y],w=t[y+1],N=t[y+2];c.data[E]=A,c.data[E+1]=w,c.data[E+2]=N,m++}}return l.putImageData(c,0,0),i}if(e)return DEBUG&&util.log("break at colorize images due error from previous inits"),t.pass(!0);DEBUG&&util.log("colorize images"),t.take();try{for(var r=model.graphics,i={BLACK_MASK:8,RED:0,BLUE:3,GREEN:4,colors:6},l={RED:0,GRAY:1,BLUE:3,GREEN:4,YELLOW:5,BLACK_MASK:8,colors:4},a=[view.IMAGE_CODE_IDLE,view.IMAGE_CODE_IDLE_INVERTED,view.IMAGE_CODE_DOWN,view.IMAGE_CODE_UP,view.IMAGE_CODE_RIGHT,view.IMAGE_CODE_LEFT],s=o(view.getInfoImageForType(view.IMG_COLOR_MAP_PROPERTIES_ID)),c=o(view.getInfoImageForType(view.IMG_COLOR_MAP_UNITS_ID)),u=r.units,d=0,m=u.length;m>d;d++)for(var _=u[d][0],p=0,E=a.length;E>p;p++){var I=a[p],f=view.getUnitImageForType(_,I,view.COLOR_RED);view.setUnitImageForType(n(f,c,i.colors,i.RED,i.BLUE,_),_,I,view.COLOR_BLUE),view.setUnitImageForType(n(f,c,i.colors,i.RED,i.GREEN,_),_,I,view.COLOR_GREEN),view.setUnitImageForType(n(f,c,i.colors,i.RED,i.BLACK_MASK,_),_,I,view.COLOR_BLACK_MASK)}for(var h=r.properties,d=0,m=h.length;m>d;d++){var _=h[d][0],f=view.getPropertyImageForType(_,view.COLOR_RED);view.setPropertyImageForType(n(f,s,l.colors,l.RED,l.BLUE),_,view.COLOR_BLUE),view.setPropertyImageForType(n(f,s,l.colors,l.RED,l.GREEN),_,view.COLOR_GREEN),view.setPropertyImageForType(n(f,s,l.colors,l.RED,l.GRAY),_,view.COLOR_NEUTRAL),view.setPropertyImageForType(n(f,s,l.colors,l.RED,l.BLACK_MASK),_,view.COLOR_BLACK_MASK)}t.pass(!1)}catch(m){controller.loadError=m,t.pass(!0)}}),controller.cutImages=util.singleLazyCall(function(e,t){function o(e,t,o){var n=t?-1:1,r=o?-1:1,i=t?-1*e.width:0,l=o?-1*e.height:0,a=document.createElement("canvas");a.height=e.height,a.width=e.width;var s=a.getContext("2d");return s.save(),s.scale(n,r),s.drawImage(e,i,l,e.width,e.height),s.restore(),a}if(e)return DEBUG&&util.log("break at cutting images due error from previous inits"),t.pass(!0);DEBUG&&util.log("cutting images"),t.take();try{var n=model.graphics;n.baseSize,DEBUG&&util.log("cutting unit commands into single types");for(var r=n.units,i=0,l=r.length;l>i;i++){var a,s,c=view.COLOR_RED,u=r[i][0],d=view.getUnitImageForType(u,view.IMAGE_CODE_IDLE,c);a=document.createElement("canvas"),a.height=32,a.width=96,s=a.getContext("2d"),s.drawImage(d,0,0,96,32,0,0,96,32),view.setUnitImageForType(a,u,view.IMAGE_CODE_IDLE,c),a=document.createElement("canvas"),a.height=32,a.width=96,s=a.getContext("2d"),s.drawImage(d,0,0,96,32,0,0,96,32),view.setUnitImageForType(o(a,!0,!1),u,view.IMAGE_CODE_IDLE_INVERTED,c),a=document.createElement("canvas"),a.height=32,a.width=96,s=a.getContext("2d"),s.drawImage(d,288,0,96,32,0,0,96,32),view.setUnitImageForType(a,u,view.IMAGE_CODE_LEFT,c),a=document.createElement("canvas"),a.height=32,a.width=96,s=a.getContext("2d"),s.drawImage(d,288,0,96,32,0,0,96,32),view.setUnitImageForType(o(a,!0,!1),u,view.IMAGE_CODE_RIGHT,c),a=document.createElement("canvas"),a.height=32,a.width=96,s=a.getContext("2d"),s.drawImage(d,96,0,96,32,0,0,96,32),view.setUnitImageForType(a,u,view.IMAGE_CODE_UP,c),a=document.createElement("canvas"),a.height=32,a.width=96,s=a.getContext("2d"),s.drawImage(d,192,0,96,32,0,0,96,32),view.setUnitImageForType(a,u,view.IMAGE_CODE_DOWN,c)}DEBUG&&util.log("cutting unit commands into single types done"),DEBUG&&util.log("cutting misc into single types");for(var m=n.misc,i=0,l=m.length;l>i;i++){var _=m[i];if(_.length>2){var d=view.getInfoImageForType(_[0]);a=document.createElement("canvas"),s=a.getContext("2d"),_.length>6?_[6]===!0?(a.height=32,a.width=96,a=o(a,!0,!1),s=a.getContext("2d")):(a.height=16,a.width=16,s.save(),s.translate(8,8),s.rotate(_[6]*Math.PI/180),s.translate(-8,-8)):(a.height=16,a.width=16),_.length>6&&_[6]===!0?s.drawImage(d,_[2],_[3],_[4],_[5],0,0,96,32):s.drawImage(d,_[2],_[3],_[4],_[5],0,0,16,16),_.length>6&&s.restore(),view.setInfoImageForType(a,_[0])}}DEBUG&&util.log("cutting misc into single types done"),t.pass(!1)}catch(l){controller.loadError=l,t.pass(!0)}}),util.scoped(function(){function e(e,t,o){var i=e[e.curStep_].id,l=e[e.curStep_].src,a=e[e.curStep_].music,s=e[e.curStep_].co_music;return r&&(s||a)?(util.log("ignoring co music because device has iOS"),o(e,t),void 0):(controller.storage.has(i,function(r){if(r)DEBUG&&util.log(i,"is in storage"),controller.storage.get(i,function(r){DEBUG&&util.log(i,"will be cached");try{var l=Base64Helper.decodeBuffer(r.value);n.decodeAudioData(l,function(n){controller.registerSoundFile(i,n),o(e,t)},function(e){controller.loadError=e,t.pass(!0)})}catch(a){controller.loadError=a,t.pass(!0)}});else{DEBUG&&util.log("load",i,"with HTTP request");var a=new XMLHttpRequest;a.open("GET",l,!0),a.responseType="arraybuffer",a.onload=function(){if(404===this.status)return controller.loadError="failed to load music file "+i,t.pass(!0),void 0;var r=a.response;DEBUG&&util.log("saving",i,"in storage"),controller.storage.set(i,Base64Helper.encodeBuffer(r),function(){DEBUG&&util.log("saved",i,"successfully in storage"),n.decodeAudioData(r,function(n){controller.registerSoundFile(i,n),o(e,t)},function(e){controller.loadError=e,t.pass(!0)})})},a.send()}}),void 0)}function t(e,t){return e===!0?(controller.loadError="could not grab music",t.pass(!0)):(e.curStep_++,e.curStep_===e.length?(util.log("finished initializing audio system"),t.pass(!1)):o(e,t),void 0)}function o(o,n){e(o,n,t)}var n,r=Browser.ios;controller.loadSoundFiles=util.singleLazyCall(function(e,t){if(e)return DEBUG&&util.log("break at init audio system due error from previous inits"),t.pass(!0);if(util.log("init audio system"),n=controller.audioContext(),null===n)return!1;if(t.take(),model.sounds.length>0){var r=[];r.curStep_=0;for(var i=0,l=model.sounds.length;l>i;i++)r[i]=model.sounds[i];o(r,t)}else t.pass(!1)})}),controller.loadImages=util.singleLazyCall(function(e,t){function o(e){DEBUG&&util.log("saved image type",e.key)}function n(){var e=this.mode_,t=this.baton_,n=this.list_,r=this.pickey_,i=this.saveIt_;switch(i&&controller.storage.set(r,Base64Helper.canvasToBase64(this),o),delete this.pickey_,delete this.baton_,delete this.list_,delete this.mode_,delete this.saveIt_,e){case"UNIT":view.setUnitImageForType(this,r,view.IMAGE_CODE_IDLE,view.COLOR_RED);break;case"PROPERTY":view.setPropertyImageForType(this,r,view.COLOR_RED);break;case"TILE":view.setTileImageForType(this,r);break;case"MISC":view.setInfoImageForType(this,r);break;default:util.raiseError("unknown mode key",e)}n.curStep_===n.length&&(s++,n=c.length>s?c[s]:null),t.pass(n)}function r(e,t){e===!0&&t.pass(!0),t.take(),e.curStep_===e.length&&util.raiseError("illegal index");var o=e[e.curStep_];e.curStep_++,img=new Image,img.pickey_=o[0],img.baton_=t,img.mode_=e.mode_,img.list_=e,img.saveIt_=!1,img.onerror=function(){controller.loadError={message:"could not load image "+img.pickey_},t.pass(!0)},"ANIMATED"===o[2]?view.animatedTiles[img.pickey_]=!0:"OVERLAYER"===o[2]&&(view.overlayImages[img.pickey_]=!0),controller.storage.has(o[0],function(e){e?controller.storage.get(o[0],function(e){img.onload=n,img.src="data:image/png;base64,"+e.value}):(img.saveIt_=!0,img.onload=n,img.src=o[1])})}if(e)return DEBUG&&util.log("break at load images due error from previous inits"),t.pass(!0);t.take();var i,l,a=model.graphics;a.units.curStep_=0,a.units.mode_="UNIT",a.properties.curStep_=0,a.properties.mode_="PROPERTY",a.tiles.curStep_=0,a.tiles.mode_="TILE",a.misc.curStep_=0,a.misc.mode_="MISC";var s=0,c=[a.units,a.properties,a.tiles,a.misc],u=jWorkflow.order(function(){return DEBUG&&util.log("start loading images"),c[0]});for(i=0,l=a.units.length;l>i;i++)u.andThen(r);for(i=0,l=a.properties.length;l>i;i++)u.andThen(r);for(i=0,l=a.tiles.length;l>i;i++)u.andThen(r);for(i=0,l=a.misc.length;l>i;i++)u.andThen(r);u.andThen(function(e){e===!0?(DEBUG&&util.log("failed to load images"),t.pass(!0)):(DEBUG&&util.log("finished loading images"),t.pass(!1))}).start()}),controller.loadInputDevices=util.singleLazyCall(function(e,t){function o(e){if(controller.inputCoolDown>0)return!1;if(!M){var t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));t>0?controller.screenStateMachine.event("SPECIAL_5"):controller.screenStateMachine.event("SPECIAL_6"),controller.inputCoolDown=1e3}}var n=37,r=38,i=39,l=40,a=8,s=13,c=77,u=78,d=49,m=50,_=51,p=52,E=53,I=54,f=9;t.take(),DEBUG&&util.log("loading input devices"),document.getElementById(ID_ELMT_GAME_CANVAS);var h=document.getElementById(ID_ELMT_GAME_MENU);if(head.desktop){DEBUG&&util.log("initializing keyboard support"),document.onkeydown=function(e){var t=e.keyCode;if("cwt_options_mapIn"===event.target.id){switch(t){case r:return controller.screenStateMachine.event("UP",1),!1;case l:return controller.screenStateMachine.event("DOWN",1),!1}return!0}switch(t){case d:return controller.screenStateMachine.event("SPECIAL_1"),!1;case m:return controller.screenStateMachine.event("SPECIAL_2"),!1;case _:return controller.screenStateMachine.event("SPECIAL_3"),!1;case p:return controller.screenStateMachine.event("SPECIAL_4"),!1;case E:return controller.screenStateMachine.event("SPECIAL_5"),!1;case I:return controller.screenStateMachine.event("SPECIAL_6"),!1;case n:return controller.screenStateMachine.event("LEFT",1),!1;case r:return controller.screenStateMachine.event("UP",1),!1;case i:return controller.screenStateMachine.event("RIGHT",1),!1;case l:return controller.screenStateMachine.event("DOWN",1),!1;case a:return controller.screenStateMachine.event("CANCEL"),!1;case s:return controller.screenStateMachine.event("ACTION"),!1;case c:return controller.screenStateMachine.event("ZOOM_IN"),!1;case u:return controller.screenStateMachine.event("ZOOM_OUT"),!1;case f:return!1}return!0},DEBUG&&util.log("initializing mouse support");var T=!1;h.onmouseout=function(){T=!1},h.onmouseover=function(){T=!0},document.addEventListener&&(document.addEventListener("mousewheel",o,!1),document.addEventListener("DOMMouseScroll",o,!1));var v=TILE_LENGTH,g=0,O=0;document.addEventListener("mousemove",function(e){var t,o;e=e||window.event,M||("number"==typeof e.offsetX?(t=e.offsetX,o=e.offsetY):(t=e.layerX,o=e.layerY),t=parseInt(t/v,10),o=parseInt(o/v,10),controller.screenStateMachine.event("HOVER",t,o))});var M=!1;document.onmousedown=function(e){e=e||window.event,M=!0,"number"==typeof e.offsetX?(g=e.offsetX,O=e.offsetY):(g=e.layerX,O=e.layerY)},document.onmouseup=function(e){e=e||window.event,M=!1;var t,o;"number"==typeof e.offsetX?(t=e.offsetX,o=e.offsetY):(t=e.layerX,o=e.layerY);var n=Math.abs(g-t),r=Math.abs(O-o),i=controller.stateMachine.state;if("ACTION_MENU"!==i&&"ACTION_SUBMENU"!==i||T)switch(e.which){case 1:controller.screenStateMachine.event("ACTION");break;case 2:break;case 3:if(n>32||r>32){var l;l=n>r?g>t?"SPECIAL_2":"SPECIAL_1":O>o?"SPECIAL_3":"SPECIAL_4",controller.screenStateMachine.event(l)}else controller.screenStateMachine.event("CANCEL")}else controller.cursorActionCancel()}}head.mobile&&util.scoped(function(){var e,t,o,n,r,i,l,a,s,c,u,d=0,m=!1;document.addEventListener("touchstart",function(u){if("cwt_options_mapIn"!==u.target.id&&u.preventDefault(),e=u.touches[0].screenX,t=u.touches[0].screenY,o=e,n=t,m=!1,2===u.touches.length){r=u.touches[1].screenX,i=u.touches[1].screenY,l=r,a=i;var d=Math.abs(e-r),_=Math.abs(t-i);c=Math.sqrt(d*d+_*_)}else r=-1;s=u.timeStamp},!1),document.addEventListener("touchmove",function(i){if("cwt_options_mapIn"!==i.target.id&&i.preventDefault(),o=i.touches[0].screenX,n=i.touches[0].screenY,2===i.touches.length){l=i.touches[1].screenX,a=i.touches[1].screenY;var c=Math.abs(o-l),_=Math.abs(n-a);u=Math.sqrt(c*c+_*_)}else r=-1;var c=Math.abs(e-o),_=Math.abs(t-n),p=Math.sqrt(c*c+_*_),E=i.timeStamp-s;if(p>16&&E>300)if(m=!0,d>75){var I;I=c>_?e>o?"LEFT":"RIGHT":t>n?"UP":"DOWN",d=0,e=o,t=n,controller.screenStateMachine.event(I,1)}else d+=E},!1),document.addEventListener("touchend",function(i){if("cwt_options_mapIn"!==i.target.id&&i.preventDefault(),!(controller.inputCoolDown>0)){var l=Math.abs(e-o),a=Math.abs(t-n),d=Math.sqrt(l*l+a*a),m=i.timeStamp-s;if(-1!==r){var _=Math.abs(u-c);if(32>=_)if(l>48||a>48){var p;p=l>a?e>o?"SPECIAL_2":"SPECIAL_1":t>n?"SPECIAL_3":"SPECIAL_4",controller.screenStateMachine.event(p)}else controller.screenStateMachine.event("CANCEL");else c>u?controller.screenStateMachine.event("SPECIAL_6"):controller.screenStateMachine.event("SPECIAL_5");controller.inputCoolDown=500}else if(16>=d)500>=m&&controller.screenStateMachine.event("ACTION");else if(300>=m){var p;p=l>a?e>o?"LEFT":"RIGHT":t>n?"UP":"DOWN",controller.screenStateMachine.event(p,1)}}},!1)}),t.pass(!1)}),controller.mapList=[],controller.loadMaps=util.singleLazyCall(function(e,t){function o(e,t){if(e===!0)return!0;t.take();var o=r[n];controller.storage.get(o,function(e){null===e?util.grabRemoteFile({path:o,json:!0,error:function(e){controller.loadError=e,t.pass(!0)},success:function(e){DEBUG&&util.log("map grabbed, saving as",o),controller.storage.set(o,e,function(){n++,controller.mapList.push({name:e.name,key:o}),t.pass()})}}):(n++,controller.mapList.push({name:e.value.name,key:o}),t.pass())})}if(e)return DEBUG&&util.log("break at load maps due error from previous inits"),t.pass(!0);DEBUG&&util.log("loading maps"),t.take();for(var n=0,r=model.maps,i=jWorkflow.order(function(){DEBUG&&util.log("start loading maps")}),l=0,a=r.length;a>l;l++)i.andThen(o);i.andThen(function(e){e===!0?(DEBUG&&util.log("failed to load maps"),t.pass(!0)):(DEBUG&&util.log("finished loading maps"),t.pass(!1))}).start()}),controller.loadModification=util.singleLazyCall(function(e,t){return e?(DEBUG&&util.log("break at load modification due error from previous inits"),t.pass(!0)):(DEBUG&&util.log("loading modification"),t.take(),controller.storage.has("mod",function(e){e?(DEBUG&&util.log("modification available, grab from storage"),controller.storage.get("mod",function(e){try{var o=e.value;controller.stateMachine.event("start",o),t.pass(!1)}catch(n){controller.loadError=n.message,t.pass(!0)}})):(DEBUG&&util.log("modification not available, grab default one"),controller.storage.get("modificationPath",function(e){null===e?"awds.json":e.value,util.grabRemoteFile({path:"awds.json",json:!0,error:function(e){controller.loadError=e,t.pass(!0)},success:function(e){DEBUG&&util.log("modification grabbed, saving it"),controller.storage.set("mod",e,function(){DEBUG&&util.log("modification saved, next initializing engine");try{controller.stateMachine.event("start",e),t.pass(!1)}catch(o){controller.loadError=o.message,t.pass(!0)}})}})}))}),void 0)}),util.scoped(function(){var e={},t=[];view.registerSpriteAnimator=function(o,n,r,i){var l={};l.stps=n,l.tps=r,l.upt=i,l.step=0,l.time=0,e[o]=l,t.push(l)},view.getSpriteStep=function(t){return e[t].step},view.updateSpriteAnimations=function(e){for(var o=0,n=t.length;n>o;o++){var r=t[o];r.time+=e,r.time>=r.tps&&(r.time=0,r.step++,r.step>=r.stps&&(r.step=0),r.upt())}}}),util.scoped(function(){var e=controller.stateMachine.data.selection;view.registerSpriteAnimator("SELECTION",7,150,function(){var t=controller.stateMachine.state;if("MOVEPATH_SELECTION"===t||"ACTION_SELECT_TARGET_A"===t||"ACTION_SELECT_TARGET_B"===t||controller.attackRangeVisible)for(var o=0,n=0,r=model.mapWidth,i=model.mapHeight;r>o;o++)for(var l=n;i>l;l++)e.getValueAt(o,l)>-1&&view.markForRedraw(o,l)})}),view.registerSpriteAnimator("STATUS",20,375,function(){}),view.registerSpriteAnimator("UNIT",3,250,function(){for(var e=0,t=0,o=model.mapWidth,n=model.mapHeight;o>e;e++)for(var r=t;n>r;r++)null!==model.unitPosMap[e][r]&&view.markForRedrawWithNeighbours(e,r)}),view.registerSpriteAnimator("PROPERTY",4,400,function(){for(var e=0,t=0,o=model.mapWidth,n=model.mapHeight;o>e;e++)for(var r=t;n>r;r++)null!==model.propertyPosMap[e][r]&&view.markForRedrawWithNeighbours(e,r)}),view.registerSpriteAnimator("ANIM_TILES",4,300,function(){for(var e=0,t=0,o=model.mapWidth,n=model.mapHeight;o>e;e++)for(var r=t;n>r;r++)view.animatedTiles[view.mapImages[e][r]]&&view.markForRedraw(e,r)}),window.addEventListener("load",function(){window.applicationCache.addEventListener("updateready",function(){window.applicationCache.status==window.applicationCache.UPDATEREADY&&(window.applicationCache.swapCache(),confirm("A new version of this site is available. Load it?")&&window.location.reload())},!1)},!1),window.applicationCache.addEventListener("error",function(){alert("could not download the game data into the offline storage")},!1),util.scoped(function(){var e,t,o,n,r=null,i={},l="__volume_sfx__",a="__music_sfx__";controller.saveSoundConfigs=function(){DEBUG&&util.log("saving volume config in storage"),controller.storage.set(l,e.gain.value),controller.storage.set(a,t.gain.value)},controller.audioContext=function(){if(!r)try{if(util.log("init audio context"),window.AudioContext)util.log("using standardized one"),r=new window.AudioContext;else{if(!window.webkitAudioContext)throw Error("no webaudio contructor found");util.log("using webkit prefixed one"),r=new window.webkitAudioContext}e=r.createGainNode(),e.gain.value=1,e.connect(r.destination),t=r.createGainNode(),t.gain.value=.5,t.connect(r.destination),controller.storage.get(l,function(t){null!==t&&(e.gain.value=t.value)}),controller.storage.get(a,function(e){null!==e&&(t.gain.value=e.value)}),util.log("finished init audio context")}catch(o){DEBUG&&util.log("could not grab audio context, your environment seems to be out of webAudio API support err:",o),r=null}return r},controller.registerSoundFile=function(e,t){i[e]=t},controller.getSfxVolume=function(){return r?e.gain.value:0},controller.getMusicVolume=function(){return r?t.gain.value:0},controller.setSfxVolume=function(t){r&&(0>t?t=0:t>1&&(t=1),e.gain.value=t)},controller.setMusicVolume=function(e){r&&(0>e?e=0:e>1&&(e=1),t.gain.value=e)},controller.playSound=function(o,n,l){if(null!==r){var a=l?t:e,s=r.createBufferSource();return n&&(s.loop=!0),s.buffer=i[o],s.connect(a),s.noteOn(0),s}},controller.playEmptyAudio=function(){if(null!==r){var e=r.createBuffer(1,1,22050),t=r.createBufferSource();t.buffer=e,t.connect(r.destination),t.noteOn(0)}},controller.playMusic=function(e){null!==r&&n!==e&&(o&&(o.noteOff(0),o.disconnect(0)),i[e]&&(o=controller.playSound(e,!0,!0),n=e))}}),controller.isEnvironmentSupported=function(){DEBUG&&util.log("checking HTML and Javascript environment");var e=!0,t=head.browser;return head.mobile?(t.ios&&t.version>=6&&(e=!1),t.android&&t.version>=4&&(e=!1),t.safari&&t.version>=6&&(e=!1),t.chrome&&t.version>=18&&(e=!1),t.ff&&t.version>=17&&(e=!1)):(t.ie&&t.version>=9&&(e=!1),t.safari&&t.version>=6&&(e=!1),t.chrome&&t.version>=18&&(e=!1),t.ff&&t.version>=17&&(e=!1)),DEBUG&&util.log("brower is",e?"not supported":"supported"),e&&alert("Attention!\nYour browser is not supported! --> "+JSON.stringify(t)),e===!0},controller.clientInstances=util.list(CWT_MAX_PLAYER,!1),controller.mapCursorX=0,controller.mapCursorY=0,controller.resetMapCursor=function(){controller.mapCursorX=0,controller.mapCursorY=0},controller.cursorAction=function(e){if(!controller.inAnimationHookPhase()){var t=controller.stateMachine.state,o="MOVEPATH_SELECTION"===t||"IDLE_R"===t||"ACTION_SELECT_TARGET_A"===t||"ACTION_SELECT_TARGET_B"===t;e?controller.stateMachine.event("cancel",controller.mapCursorX,controller.mapCursorY):-1!==controller.menuCursorIndex?controller.stateMachine.event("action",controller.menuCursorIndex):controller.stateMachine.event("action",controller.mapCursorX,controller.mapCursorY);var n=controller.stateMachine.state,r="MOVEPATH_SELECTION"===n||"IDLE_R"===n||"ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n;if((o&&!r||r)&&view.markSelectionMapForRedraw(controller.stateMachine.data),"ACTION_MENU"===n||"ACTION_SUBMENU"===n){var i=controller.stateMachine.data.menu;controller.showMenu(i,controller.mapCursorX,controller.mapCursorY)}else("ACTION_MENU"===t||"ACTION_SUBMENU"===t)&&controller.hideMenu()}},controller.cursorActionCancel=function(){controller.cursorAction(!0),controller.playSound("CANCEL")},controller.cursorActionClick=function(){controller.cursorAction(!1),controller.playSound("ACTION")},controller.moveCursor=function(e,t){1===arguments.length&&(t=1);var o=controller.mapCursorX,n=controller.mapCursorY;switch(e){case model.MOVE_CODE_UP:n--;break;case model.MOVE_CODE_RIGHT:o++;break;case model.MOVE_CODE_DOWN:n++;break;case model.MOVE_CODE_LEFT:o--}controller.setCursorPosition(o,n)},controller.setCursorPosition=function(e,t,o){if(!controller.isMenuOpen()&&(o&&(e+=controller.screenX,t+=controller.screenY),model.isValidPosition(e,t)&&(e!==controller.mapCursorX||t!==controller.mapCursorY))){view.markForRedraw(controller.mapCursorX,controller.mapCursorY),controller.mapCursorY<model.mapHeight-1&&view.markForRedraw(controller.mapCursorX,controller.mapCursorY+1),controller.playSound("MAPTICK"),view.markForRedraw(controller.mapCursorX,controller.mapCursorY),controller.mapCursorX=e,controller.mapCursorY=t;var n=controller.screenScale;0===n?n=.8:-1===n&&(n=.7);var r=parseInt(parseInt(window.innerWidth/16,10)/n,10),i=parseInt(parseInt(window.innerHeight/16,10)/n,10),l=-1;1>=e-controller.screenX?l=model.MOVE_CODE_LEFT:e-controller.screenX>=r-1?l=model.MOVE_CODE_RIGHT:1>=t-controller.screenY?l=model.MOVE_CODE_UP:t-controller.screenY>=i-1&&(l=model.MOVE_CODE_DOWN),-1!==l&&controller.shiftScreenPosition(l,5),DEBUG&&util.log("set cursor position to",e,t,"screen node is at",controller.screenX,controller.screenY),view.markForRedraw(e,t)}},util.scoped(function(){function e(){if(view.hooksBuffer.isEmpty())o=!1;else{o=!0;var e=view.hooksBuffer.pop(),n=e[e.length-1];t=view.animationHooks[n],t.prepare.apply(t,e)}}var t=null,o=!1,n=0;controller.prepareGameLoop=function(){n=0},controller.gameLoop=function(r){n+=r,controller.updateInputCoolDown(r);var i=0!==controller.moveScreenX||0!==controller.moveScreenY;if(i?controller.solveMapShift():(view.hasInfoMessage()?view.updateMessagePanelTime(r):o?(t.update(r),t.isDone()&&e()):(controller.updateState(n),n=0,e()),view.updateSpriteAnimations(r)),view.drawScreenChanges>0&&view.renderMap(controller.screenScale),o)t.render();else if("ACTION_SELECT_TILE"===controller.stateMachine.state){var l,a,s=view.selectionRange,c=controller.mapCursorX,u=controller.mapCursorY,d=u-s,m=u+s;for(0>d&&(d=0),m>=model.mapHeight&&(m=model.mapHeight-1);m>=d;d++){var _=Math.abs(d-u);for(l=c-s+_,a=c+s-_,0>l&&(l=0),a>=model.mapWidth&&(a=model.mapWidth-1);a>=l;l++)view.markForRedraw(l,d)}}},controller.inAnimationHookPhase=function(){return o}}),view.hooksBuffer=util.createRingBuffer(50),view.animationHooks={},view.registerAnimationHook=function(e){var t=e.key;view.animationHooks.hasOwnProperty(t)&&util.raiseError("animation algorithm for",t,"is already registered"),view.animationHooks[t]=e,model[t].listenCommand(function(){for(var e=[],o=0,n=arguments.length;n>o;o++)e[o]=arguments[o];e[e.length]=t,view.hooksBuffer.push(e)}),e.isEnabled=!0},view.IMAGE_CODE_IDLE="IDLE",view.IMAGE_CODE_IDLE_INVERTED="IDLE_R",view.IMAGE_CODE_RIGHT="RIGHT",view.IMAGE_CODE_LEFT="LEFT",view.IMAGE_CODE_UP="UP",view.IMAGE_CODE_DOWN="DOWN",view.IMAGE_CODE_STATELESS="STATELESS",view.COLOR_RED="RED",view.COLOR_GREEN="GREEN",view.COLOR_BLUE="BLUE",view.COLOR_YELLOW="YELLOW",view.COLOR_BLACK_MASK="BLACK_MASK",view.COLOR_NEUTRAL="GRAY",view.COLOR_NONE="NONE",view.IMG_COLOR_MAP_PROPERTIES_ID="IMG_MAP_PROPERTY",view.IMG_COLOR_MAP_UNITS_ID="IMG_MAP_UNIT",view.CodeStatelessview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{},NONE:{},GRAY:{}},view.overlayImages={},view.animatedTiles={},view.CodeIdleview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeIdleInvertedview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeRightview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeLeftview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeUpview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeDownview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.setImageForType=function(e,t,o,n){switch(void 0===o&&(o=view.IMAGE_CODE_STATELESS),void 0===n&&(n=view.COLOR_NONE),o){case view.IMAGE_CODE_IDLE:view.CodeIdleview[n][t]=e;break;case view.IMAGE_CODE_STATELESS:view.CodeStatelessview[n][t]=e;break;case view.IMAGE_CODE_IDLE_INVERTED:view.CodeIdleInvertedview[n][t]=e;break;case view.IMAGE_CODE_LEFT:view.CodeLeftview[n][t]=e;break;case view.IMAGE_CODE_RIGHT:view.CodeRightview[n][t]=e;break;case view.IMAGE_CODE_DOWN:view.CodeDownview[n][t]=e;break;case view.IMAGE_CODE_UP:view.CodeUpview[n][t]=e;break;default:util.raiseError("unknown image state code ",o)}},view.setUnitImageForType=view.setImageForType,view.setPropertyImageForType=function(e,t,o){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,o)},view.setTileImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.setInfoImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getImageForType=function(e,t,o){switch(t){case view.IMAGE_CODE_IDLE:return view.CodeIdleview[o][e];case view.IMAGE_CODE_IDLE_INVERTED:return view.CodeIdleInvertedview[o][e];case view.IMAGE_CODE_LEFT:return view.CodeLeftview[o][e];case view.IMAGE_CODE_RIGHT:return view.CodeRightview[o][e];case view.IMAGE_CODE_DOWN:return view.CodeDownview[o][e];case view.IMAGE_CODE_UP:return view.CodeUpview[o][e];case view.IMAGE_CODE_STATELESS:return view.CodeStatelessview[o][e];default:util.raiseError("unknown image state code ",t)
}},view.getUnitImageForType=view.getImageForType,view.getPropertyImageForType=function(e,t){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,t)},view.getTileImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getInfoImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},controller.inputCoolDown=0,controller.updateInputCoolDown=function(e){controller.inputCoolDown-=e,0>controller.inputCoolDown&&(controller.inputCoolDown=0)},view.mapImages=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),util.scoped(function(){function e(e,t,o,n,r){if(0>e||0>t||e>=model.mapWidth||t>=model.mapWidth)return n[o]="_",void 0;var i=r[model.map[e][t].ID];void 0===i&&(i=""),n[o]=i}function t(e,t,o,n){for(var r=0,i=e.length;i>r;r++){var l=e[r];if(!(""!==l[1]&&l[1]!==t[0]||""!==l[2]&&l[2]!==t[1]||""!==l[3]&&l[3]!==t[2]||""!==l[4]&&l[4]!==t[3])){if(!o){if(""!==l[5]&&l[5]!==t[4])continue;if(""!==l[6]&&l[6]!==t[5])continue;if(""!==l[7]&&l[7]!==t[6])continue;if(""!==l[8]&&l[8]!==t[7])continue}return l[0]}}return n}view.updateMapImages=function(){var o,n,r=model.mapWidth,i=model.mapHeight,l=e,a=t,s=[];for(o=0;r>o;o++)for(n=0;i>n;n++){var c=o,u=n,d=model.map[c][u].ID;if(model.graphics.connected[d]){var m=model.graphics.connectedKeys[d];5===model.graphics.connected[d][0].length?(l(o,n-1,0,s,m),l(o+1,n,1,s,m),l(o,n+1,2,s,m),l(o-1,n,3,s,m),view.mapImages[o][n]=a(model.graphics.connected[d],s,!0,d)):(l(o,n-1,0,s,m),l(o+1,n-1,1,s,m),l(o+1,n,2,s,m),l(o+1,n+1,3,s,m),l(o,n+1,4,s,m),l(o-1,n+1,5,s,m),l(o-1,n,6,s,m),l(o-1,n-1,7,s,m),view.mapImages[o][n]=a(model.graphics.connected[d],s,!1,d))}else view.mapImages[c][u]=d}}}),util.scoped(function(){function e(e,t){e.onmouseover=function(){controller.setMenuIndex(t)}}var t={},o=document.getElementById(ID_ELMT_MENU);document.getElementById(ID_ELMT_MENU_HEADER),document.getElementById(ID_ELMT_MENU_CONTENT);var n=document.getElementById(ID_ELMT_MENU_ENTRIES);controller.menuPosX=-1,controller.menuPosY=-1,controller.menuCursorIndex=-1,controller.resetMenuCursor=function(){controller.menuCursorIndex=0},controller.setMenuIndex=function(e){controller.playSound("MENUTICK"),n.children[controller.menuCursorIndex].className="",controller.menuCursorIndex=e,n.children[controller.menuCursorIndex].className="activeButton"},controller.increaseMenuCursor=function(){n.children[controller.menuCursorIndex].className="",controller.menuCursorIndex++,controller.menuCursorIndex===controller.stateMachine.data.menu.size?controller.menuCursorIndex--:controller.playSound("MENUTICK"),n.children[controller.menuCursorIndex].className="activeButton",n.children[controller.menuCursorIndex].children[0].focus()},controller.decreaseMenuCursor=function(){n.children[controller.menuCursorIndex].className="",controller.menuCursorIndex--,0>controller.menuCursorIndex?controller.menuCursorIndex=0:controller.playSound("MENUTICK"),n.children[controller.menuCursorIndex].className="activeButton",n.children[controller.menuCursorIndex].children[0].focus()},controller.showMenu=function(r,i,l){DEBUG&&util.log("opening GUI menu"),TILE_LENGTH*controller.screenScale;var a=t.__mainMenu__;if("ACTION_SUBMENU"===controller.stateMachine.state){var s=t[controller.stateMachine.data.action.selectedEntry];s&&(a=s)}1===arguments.length&&(i=controller.menuPosX,l=controller.menuPosY),model.isValidPosition(i,l)||util.raiseError("invalid menu position");for(var c=n.children,u=0,d=c.length;d>u;u++)c[u].style.display="none";for(var u=0,d=r.size;d>u;u++){var m;if(c.length>u)c[u].className="",m=c[u].children[0];else{m=document.createElement("button"),e(m,u);var _=document.createElement("li");_.appendChild(m),n.appendChild(_)}a(r.data[u],m,u),c[u].style.display=""}i-=controller.screenX,l-=controller.screenY,controller.menuPosX=i,controller.menuPosY=l,controller.menuCursorIndex=0,n.children[controller.menuCursorIndex].className="activeButton",n.children[controller.menuCursorIndex].children[0].focus();var p=o.style;p.zIndex=-1,p.display="block",p.left=parseInt(window.innerWidth/2-o.offsetWidth/2,10)+"px",p.top=parseInt(window.innerHeight/2-o.offsetHeight/2,10)+"px",p.zIndex=9,controller.setMenuIndex(0)},controller.hideMenu=function(){DEBUG&&util.log("closing GUI menu"),n.children[controller.menuCursorIndex].className="",o.style.display="none",controller.menuCursorIndex=-1},controller.isMenuOpen=function(){return"block"===o.style.display},controller.registerMenuRenderer=function(e,o){t.hasOwnProperty(e)&&util.raiseError("renderer for",e,"is already registered"),t[e]=o}}),util.scoped(function(){var e,t=document.getElementById("cwt_info_box"),o=document.getElementById("cwt_info_box_content"),n=1e3;view.updateMessagePanelTime=function(o){e>0&&(e-=o,0>=e&&(t.className="tooltip out"))},view.hasInfoMessage=function(){return e>0},view.showInfoMessage=function(r,i){1===arguments.length&&(i=n),o.innerHTML=r,t.className="tooltip active",t.style.position="absolute",t.style.left=parseInt(window.innerWidth/2-t.offsetWidth/2,10)+"px",t.style.top=parseInt(window.innerHeight/2-t.offsetHeight/2,10)+"px",e=i}}),controller.isNetworkGame=function(){return!1},controller.unitStatusMap=util.list(CWT_MAX_UNITS_PER_PLAYER*CWT_MAX_PLAYER,function(){return{HP_PIC:null,LOW_AMMO:!1,LOW_FUEL:!1,HAS_LOADS:!1,CAPTURES:!1,CLIENT_VISIBLE:!1}}),controller.getUnitStatusForUnit=function(e){var t=model.extractUnitId(e);return controller.unitStatusMap[t]},controller.inVision_=function(e,t,o,n){if(!model.isValidPosition(e,t))return!1;var r=model.unitPosMap[e][t];return null!==r&&(r.owner===o||model.players[r.owner].team==n)},controller.updateUnitStatus=function(e){var t=model.units[e],o=t.x,n=t.y,r=controller.unitStatusMap[e],i=t.type,l=t.ammo,a=i.ammo;r.LOW_AMMO=parseInt(.25*a,10)>=l?!0:!1,0===a&&(r.LOW_AMMO=!1);var s=t.fuel,c=i.fuel;r.LOW_FUEL=parseInt(.25*c,10)>s?!0:!1;var u=-1;switch(90>=t.hp&&(u=parseInt(t.hp/10,10)+1),u){case 1:r.HP_PIC=view.getInfoImageForType("HP_1");break;case 2:r.HP_PIC=view.getInfoImageForType("HP_2");break;case 3:r.HP_PIC=view.getInfoImageForType("HP_3");break;case 4:r.HP_PIC=view.getInfoImageForType("HP_4");break;case 5:r.HP_PIC=view.getInfoImageForType("HP_5");break;case 6:r.HP_PIC=view.getInfoImageForType("HP_6");break;case 7:r.HP_PIC=view.getInfoImageForType("HP_7");break;case 8:r.HP_PIC=view.getInfoImageForType("HP_8");break;case 9:r.HP_PIC=view.getInfoImageForType("HP_9");break;default:r.HP_PIC=null}if(r.HAS_LOADS=-1>t.loadedIn?!0:!1,t.x>=0){var d=model.propertyPosMap[t.x][t.y];r.CAPTURES=null!==d&&20>d.capturePoints?!0:!1}r.CLIENT_VISIBLE=!1;var m=model.turnOwner,_=model.players[m].team,p=controller.inVision_;(p(o-1,n,m,_)||p(o,n-1,m,_)||p(o,n+1,m,_)||p(o+1,n,m,_))&&(r.CLIENT_VISIBLE=!0)},controller.mapAction({key:"options",hasSubMenu:!0,condition:function(e){var t=e.source.unit;if(null!==t&&t.owner===model.turnOwner&&model.canAct(e.source.unitId))return!1;var o=e.source.property;return null!==o&&o.type.builds?!1:!0},prepareMenu:function(e){e.menu.addEntry("options.sfx"),e.menu.addEntry("options.music"),e.menu.addEntry("options.yield")},invoke:function(e){var t=e.action.selectedSubEntry;switch(t){case"options.sfx":controller.getSfxVolume()>0?controller.setSfxVolume(0):controller.setSfxVolume(1);break;case"options.music":controller.getMusicVolume()>0?controller.setMusicVolume(0):controller.setMusicVolume(1);break;case"options.yield":model.playerGivesUp.callAsCommand()}}}),view.drawScreenChanges=0,view.drawScreen=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,!1),view.markForRedraw=function(e,t){if(e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t){if(view.drawScreen[e][t]===!0)return;view.drawScreen[e][t]=!0,view.drawScreenChanges++,t++,model.mapHeight>t&&(null!==model.propertyPosMap[e][t]?view.markForRedraw(e,t):view.overlayImages[view.mapImages[e][t]]===!0&&view.markForRedraw(e,t))}else util.raiseError("illegal arguments ",e,",",t," -> out of view bounds")},view.markForRedrawRange=function(e,t,o){var n,r,i=t-o,l=t+o;for(0>i&&(i=0),l>=model.mapHeight&&(l=model.mapHeight-1);l>=i;i++){var a=Math.abs(i-t);for(n=e-o+a,r=e+o-a,0>n&&(n=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=n;n++)view.markForRedraw(n,i)}},view.markForRedrawWithNeighbours=function(e,t){t>0&&view.markForRedraw(e,t-1),e>0&&view.markForRedraw(e-1,t),view.markForRedraw(e,t),model.mapHeight-1>t&&view.markForRedraw(e,t+1),model.mapWidth-1>e&&view.markForRedraw(e+1,t)},view.markForRedrawWithNeighboursRing=function(e,t){var o=model.mapWidth,n=model.mapHeight;e>0&&(t>0&&view.markForRedraw(e-1,t-1),view.markForRedraw(e-1,t),n-1>t&&view.markForRedraw(e-1,t+1)),t>0&&view.markForRedraw(e,t-1),view.markForRedraw(e,t),n-1>t&&view.markForRedraw(e,t+1),o-1>e&&(t>0&&view.markForRedraw(e+1,t-1),view.markForRedraw(e+1,t),n-1>t&&view.markForRedraw(e+1,t+1))},view.completeRedraw=function(){view.drawScreenChanges=1;for(var e=0,t=model.mapWidth;t>e;e++)for(var o=0,n=model.mapHeight;n>o;o++)view.drawScreen[e][o]=!0},view.markSelectionMapForRedraw=function(e){for(var t=e.selection.centerX,o=e.selection.centerY,n=e.selection.data,r=0;n.length>r;r++)for(var i=n[r],l=0;i.length>l;l++)-1!==i[l]&&view.markForRedraw(t+r,o+l)},controller.screenElement=document.getElementById("cwt_canvas"),controller.screenX=0,controller.screenY=0,controller.screenWidth=-1,controller.screenHeight=-1,controller.screenScale=1,controller.moveScreenX=0,controller.moveScreenY=0,controller.setScreenScale=function(e){if(!(-1>e||e>3)){controller.screenScale=e,controller.screenElement.className="scale"+e,0===e?e=.8:-1===e&&(e=.7);var t=TILE_LENGTH*e;controller.screenWidth=parseInt(window.innerWidth/t,10),controller.screenHeight=parseInt(window.innerHeight/t,10),controller.setScreenPosition(controller.screenX,controller.screenY,!1)}},controller.setScreenPosition=function(e,t){controller.screenX=e,controller.screenY=t;var o=controller.screenElement.style,n=controller.screenScale,r=-(controller.screenX*TILE_LENGTH*n),i=-(controller.screenY*TILE_LENGTH*n);switch(n){case 2:r+=controller.screenElement.width/2,i+=controller.screenElement.height/2;break;case 3:r+=controller.screenElement.width,i+=controller.screenElement.height}o.position="absolute",o.left=r+"px",o.top=i+"px"},controller.shiftScreenPosition=function(e,t){1===arguments.length&&(t=1);var o=controller.screenX,n=controller.screenY;switch(e){case model.MOVE_CODE_DOWN:n+=t;break;case model.MOVE_CODE_RIGHT:o+=t;break;case model.MOVE_CODE_UP:n-=t;break;case model.MOVE_CODE_LEFT:o-=t}0>o&&(o=0),0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1),n>=model.mapHeight&&(n=model.mapHeight-1),controller.setScreenPosition(o,n,!1)},view.resizeCanvas=function(){var e=controller.screenElement;e.width=TILE_LENGTH*model.mapWidth,e.height=TILE_LENGTH*model.mapHeight,controller.screenWidth=parseInt(window.innerWidth/TILE_LENGTH,10),controller.screenHeight=parseInt(window.innerHeight/TILE_LENGTH,10)};var TILE_LENGTH=16;controller.baseSize=16,view.preventRenderUnit=null,view.canvasCtx=controller.screenElement.getContext("2d"),view.selectionRange=2,view.colorArray=[view.COLOR_RED,view.COLOR_BLUE,view.COLOR_GREEN,view.COLOR_YELLOW],view.renderMap=function(){var e=TILE_LENGTH,t=view.canvasCtx;controller.screenX,controller.screenY;for(var o,n,r,i,l,a,s,c,u,d,m,_=controller.mapCursorX,p=controller.mapCursorY,E=view.getSpriteStep("SELECTION"),I=view.getSpriteStep("UNIT"),f=view.getSpriteStep("PROPERTY"),h=view.getSpriteStep("STATUS"),T=view.getSpriteStep("ANIM_TILES"),v=controller.baseSize,g=model.players[model.turnOwner].team,O="MOVEPATH_SELECTION"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state||controller.attackRangeVisible,M="ACTION_SELECT_TILE"===controller.stateMachine.state,y=controller.stateMachine.data,A=y.selection,w=model.mapHeight-1,N=0;w>=N;N++)for(var C=model.mapWidth-1,D=0;C>=D;D++)if(m=0===model.fogData[D][N],view.drawScreen[D][N]===!0){o=view.mapImages[D][N],n=view.getTileImageForType(o),r=0,i=0,view.animatedTiles[o]&&(r+=v*T),l=v,a=2*v,s=D*e,c=N*e-e,u=e,d=2*e,0>c&&(i+=v,a-=v,c+=e,d-=e),void 0!==n?t.drawImage(n,r,i,l,a,s,c,u,d):(t.fillStyle="rgb(0,0,255)",t.fillRect(s,c,e,e));var S=model.propertyPosMap[D][N];if(null!==S){var L;o=S.type.ID,-1===S.owner?L=view.COLOR_NEUTRAL:(L=view.colorArray[S.owner],S.type.factionSprites&&(o=S.type.factionSprites[model.players[S.owner].mainCo.faction])),m&&(L=view.COLOR_NEUTRAL),n=view.getPropertyImageForType(o,L),r=0+v*f,i=0,l=v,a=2*v,s=D*e,c=N*e-e,u=e,d=2*e,0>c&&(i+=v,a-=v,c+=e,d-=e),void 0!==n?(t.drawImage(n,r,i,l,a,s,c,u,d),m&&d>16&&null!==S&&(n=view.getPropertyImageForType(S.type.ID,view.COLOR_BLACK_MASK),t.globalAlpha=.35,t.drawImage(n,r,i,l,a/2,s,c,u,d/2),t.globalAlpha=1)):(s=D*e,c=N*e,u=e,d=e,t.fillStyle="rgb(0,255,0)",t.fillRect(s,c,u,d))}if(m&&(s=D*e,c=N*e,u=e,d=e,t.globalAlpha=.2,t.fillStyle="black",t.fillRect(s,c,u,d),t.globalAlpha=1),O){n=view.getInfoImageForType("MOVEPATH_SELECTION"===controller.stateMachine.state?"MOVE_FOC":"ATK_FOC");var R=A.getValueAt(D,N);R>0&&(r=v*E,i=0,l=v,a=v,s=D*e,c=N*e,u=e,d=e,t.globalAlpha=.65,t.drawImage(n,r,i,l,a,s,c,u,d),t.globalAlpha=1)}if(M){var P=model.distance(_,p,D,N);if(view.selectionRange===P){var n=null;n=0===P?view.getInfoImageForType("SILO_ALL"):_===D?p>N?view.getInfoImageForType("SILO_N"):view.getInfoImageForType("SILO_S"):p===N?_>D?view.getInfoImageForType("SILO_W"):view.getInfoImageForType("SILO_E"):_>D?p>N?view.getInfoImageForType("SILO_NW"):view.getInfoImageForType("SILO_SW"):p>N?view.getInfoImageForType("SILO_NE"):view.getInfoImageForType("SILO_SE"),s=D*e,c=N*e,null!==n&&t.drawImage(n,s,c)}}var U=model.unitPosMap[D][N],B=null!==U?controller.getUnitStatusForUnit(U):null;if(!m&&null!==U&&(!U.hidden||U.owner===model.turnOwner||model.players[U.owner].team==g||B.TURN_OWNER_VISIBLE)&&U!==view.preventRenderUnit){var L;L=-1===U.owner?view.COLOR_NEUTRAL:view.colorArray[U.owner];var b=1===U.owner%2?view.IMAGE_CODE_IDLE:view.IMAGE_CODE_IDLE_INVERTED;if(n=view.getUnitImageForType(U.type.ID,b,L),r=2*v*I,i=0,l=2*v,a=2*v,s=D*e-e/2,c=N*e-e/2,u=e+e,d=e+e,void 0!==n?(t.drawImage(n,r,i,l,a,s,c,u,d),U.owner!==model.turnOwner||model.canAct(model.extractUnitId(U))||(t.globalAlpha=.5,t.drawImage(view.getUnitImageForType(U.type.ID,b,view.COLOR_BLACK_MASK),r,i,l,a,s,c,u,d),t.globalAlpha=1)):(s=D*e,c=N*e,u=e,d=e,t.fillStyle="rgb(255,0,0)",t.fillRect(s,c,u,d)),n=B.HP_PIC,null!==n&&t.drawImage(n,s+e,c+e),0!==h&&1!==h&&4!==h&&5!==h&&8!==h&&9!==h&&12!==h&&13!==h&&16!==h&&17!==h){var G=parseInt(h/4,10);n=null;var k=G;do{if(0===k&&B.LOW_AMMO?n=view.getInfoImageForType("SYM_AMMO"):1===k&&B.CAPTURES?n=view.getInfoImageForType("SYM_CAPTURE"):2===k&&B.LOW_FUEL?n=view.getInfoImageForType("SYM_FUEL"):3===k&&B.HAS_LOADS?n=view.getInfoImageForType("SYM_LOAD"):4===k&&U.hidden&&(n=view.getInfoImageForType("SYM_HIDDEN")),null!==n)break;k++,5===k&&(k=0)}while(k!==G);null!==n&&t.drawImage(n,s+e/2,c+e)}}view.drawScreen[D][N]=!1}if("MOVEPATH_SELECTION"===controller.stateMachine.state)for(var F,V,W,H,x=y.movePath.data,X=y.source.x,Y=y.source.y,K=0,z=x.length;z>K&&null!==x[K];K++){switch(F=X,V=Y,x[K]){case model.MOVE_CODE_UP:Y--;break;case model.MOVE_CODE_RIGHT:X++;break;case model.MOVE_CODE_DOWN:Y++;break;case model.MOVE_CODE_LEFT:X--}if(K===z-1||null===x[K+1])W=-1,H=-1;else switch(x[K+1]){case model.MOVE_CODE_UP:W=X,H=Y-1;break;case model.MOVE_CODE_RIGHT:W=X+1,H=Y;break;case model.MOVE_CODE_DOWN:W=X,H=Y+1;break;case model.MOVE_CODE_LEFT:W=X-1,H=Y}if(-1==W)switch(x[K]){case model.MOVE_CODE_UP:n=view.getTileImageForType("ARROW_N");break;case model.MOVE_CODE_RIGHT:n=view.getTileImageForType("ARROW_E");break;case model.MOVE_CODE_DOWN:n=view.getTileImageForType("ARROW_S");break;case model.MOVE_CODE_LEFT:n=view.getTileImageForType("ARROW_W")}else{var j=Math.abs(W-F),J=Math.abs(H-V);if(2===j)n=view.getTileImageForType("ARROW_WE");else if(2===J)n=view.getTileImageForType("ARROW_NS");else if(X>W&&V>Y||X>F&&H>Y)n=view.getTileImageForType("ARROW_SW");else if(X>W&&Y>V||X>F&&Y>H)n=view.getTileImageForType("ARROW_WN");else if(W>X&&Y>V||F>X&&Y>H)n=view.getTileImageForType("ARROW_NE");else{if(!(W>X&&V>Y||F>X&&H>Y)){util.raiseError("illegal move arrow state","old (",F,",",V,")","current (",X,",",Y,")","next (",W,",",H,")","path (",x,")");continue}n=view.getTileImageForType("ARROW_ES")}}X>=0&&Y>=0&&controller.screenWidth>X&&controller.screenHeight>Y&&t.drawImage(n,X*e,Y*e)}t.lineWidth=2,t.strokeStyle="#f00",t.strokeRect(e*controller.mapCursorX+1,e*controller.mapCursorY+1,e-2,e-2),view.drawScreenChanges=0},controller.screenStateMachine=simpleStateMachine(),controller.screenStateMachine.name="CLIENT",controller.screenStateMachine.data={},controller.loadStorageController=util.singleLazyCall(function(e,t){if(e)return DEBUG&&util.log("break at init storage system due error from previous inits"),e;t.take(),DEBUG&&util.log("initializing storage system");var o=0,n=Browser;DEBUG&&util.log("using lawnchair storage system with",n.mobile?"webkit-sqlite":"indexed-db","adapter");var r=new Lawnchair({adaptor:n.mobile?"webkit-sqlite":"indexed-db",maxSize:47104,name:"cwt"},function(){var e,n,i,l,a,s;e=function(e,t){r.get(e,t)},n=function(e,t){r.exists(e,t)},i=function(e){r.nuke(e)},s=function(e){r.keys(e)},l=function(e,t){r.get(e,obj,t)},a=function(e,t,n){DEBUG&&(o+=JSON.stringify({key:e,value:t}).length,util.log(o,"used in storage")),r.save({key:e,value:t},n)},controller.storage={get:e,has:n,set:a,keys:s,clear:i,remove:l},t.pass(!1)})}),controller.screenStateMachine.data.mapToLoad=null,controller.screenStateMachine.data.openedSection=null,controller.screenStateMachine.data.openSection=function(e){var t=document.getElementById(e);t||util.raiseError("unknown id",e),null!==this.openedSection&&(this.openedSection.style.display="none"),t.style.display="",this.openedSection=t},util.scoped(function(){function e(e){controller.startGameRound(e.value),controller.setCursorPosition(0,0),view.resizeCanvas(),view.updateMapImages(),view.completeRedraw();for(var o=0,n=model.units.length;n>o;o++)model.units[o].owner!==CWT_INACTIVE_ID&&controller.updateUnitStatus(o);controller.playSoundForPlayer(model.turnOwner),controller.renderPlayerInfo(),t()}function t(){function e(){if(!controller.inGameRound)return controller.screenStateMachine.event("gameHasEnded"),void 0;requestAnimationFrame(e);var o=(new Date).getTime(),n=o-t;t=o,controller.gameLoop(n)}DEBUG&&util.log("setup animation frame"),controller.prepareGameLoop();var t=(new Date).getTime();requestAnimationFrame(e)}function o(){controller.unitInfoVisible&&controller.hideUnitInfo(),controller.tileInfoVisible&&controller.hideTileInfo(),controller.playerInfoVisible&&controller.hidePlayerInfo(),controller.attackRangeVisible&&controller.hideAttackRangeInfo()}controller.screenStateMachine.structure.GAMEROUND=Object.create(controller.stateParent),controller.screenStateMachine.structure.GAMEROUND.onenter=function(){this.data.openSection(ID_MENU_SECTION_GAME),controller.storage.get(this.data.mapToLoad,e)},controller.screenStateMachine.structure.GAMEROUND.gameHasEnded=function(){return o(),"MAIN"},controller.screenStateMachine.structure.GAMEROUND.LEFT=function(e,t){o();var n=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.BREAK_TRANSITION):(t||(t=1),1===t?controller.moveCursor(model.MOVE_CODE_LEFT,t):controller.shiftScreenPosition(model.MOVE_CODE_LEFT,t),this.BREAK_TRANSITION)},controller.screenStateMachine.structure.GAMEROUND.RIGHT=function(e,t){o();var n=controller.stateMachine.state;return"ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n?(controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.BREAK_TRANSITION):(t||(t=1),1===t?controller.moveCursor(model.MOVE_CODE_RIGHT,t):controller.shiftScreenPosition(model.MOVE_CODE_RIGHT,t),this.BREAK_TRANSITION)},controller.screenStateMachine.structure.GAMEROUND.UP=function(e,t){o();var n=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!0,controller.setCursorPosition),this.BREAK_TRANSITION;var r="ACTION_MENU"===n||"ACTION_SUBMENU"===n;return t||(t=1),r?controller.decreaseMenuCursor():1===t?controller.moveCursor(model.MOVE_CODE_UP,t):controller.shiftScreenPosition(model.MOVE_CODE_UP,t),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.DOWN=function(e,t){o();var n=controller.stateMachine.state;if("ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n)return controller.stateMachine.data.selection.nextValidPosition(controller.mapCursorX,controller.mapCursorY,0,!1,controller.setCursorPosition),this.BREAK_TRANSITION;var r="ACTION_MENU"===n||"ACTION_SUBMENU"===n;return t||(t=1),r?controller.increaseMenuCursor():1===t?controller.moveCursor(model.MOVE_CODE_DOWN,t):controller.shiftScreenPosition(model.MOVE_CODE_DOWN,t),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.ACTION=function(e,t,n){return o(),"number"==typeof t&&controller.setCursorPosition(t,n),controller.cursorActionClick(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.HOVER=function(e,t,o){return controller.setCursorPosition(t,o),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.CANCEL=function(e,t,n){return o(),"number"==typeof t&&controller.setCursorPosition(t,n),controller.cursorActionCancel(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_1=function(){return controller.tileInfoVisible||(o(),controller.showTileInfo()),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_2=function(){return controller.unitInfoVisible||(o(),controller.showUnitInfo()),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_3=function(){return controller.attackRangeVisible||(o(),controller.showAttackRangeInfo()),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_4=function(){return controller.playerInfoVisible||(o(),controller.showPlayerInfo()),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_5=function(){return o(),controller.setScreenScale(controller.screenScale+1),this.BREAK_TRANSITION},controller.screenStateMachine.structure.GAMEROUND.SPECIAL_6=function(){return o(),controller.setScreenScale(controller.screenScale-1),this.BREAK_TRANSITION}}),controller.screenStateMachine.structure.LOAD=Object.create(controller.stateParent),controller.screenStateMachine.structure.LOAD.onenter=function(){this.data.openSection(ID_MENU_SECTION_LOAD),jWorkflow.order(controller.isEnvironmentSupported).andThen(controller.loadStorageController).andThen(function(e,t){return e?e:(t.take(),controller.storage.get("resetDataAtStart",function(e){var o=null!==e&&e.value;o||(o="1"===getQueryParams(document.location.search).wipeoutMod),o?(DEBUG&&util.log("wipe out cached data"),controller.storage.clear(function(){t.pass(!1)})):t.pass(!1)}),void 0)}).andThen(controller.loadModification).andThen(controller.loadMaps).andThen(controller.loadImages).andThen(controller.cutImages).andThen(controller.colorizeImages).andThen(controller.loadSoundFiles).andThen(controller.loadInputDevices).andThen(function(){controller.screenStateMachine.event("complete")}).start()},controller.screenStateMachine.structure.LOAD.complete=function(){return"MOBILE"},controller.screenStateMachine.structure.LOAD.onerror=controller.haltEngine,controller.loadError=null,util.scoped(function(){function e(e,t){void 0===t&&(t=!0),-1!==n&&(o[n].className="menuButton"),t?e>0?(n++,n>=o.length&&(n=0)):(n--,0>n&&(n=o.length-1)):((0>e||e>=o.length)&&util.raiseError("wrong index"),n=e);var r=o[n].attributes.key.value;r=!controller.loadError&&"VERSUS"===r||"OPTIONS"===r?"menuButton active":"menuButton inactive",o[n].className=r}function t(t){o[t].onmouseover=function(){e(t,!1)}}for(var o=[document.getElementById(ID_ELMT_SECTION_MAIN_BTN_1),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_2),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_3),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_4),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_5),document.getElementById(ID_ELMT_SECTION_MAIN_BTN_6)],n=-1,r=0,i=o.length;i>r;r++)t(r);controller.screenStateMachine.structure.MAIN=Object.create(controller.stateParent),controller.screenStateMachine.structure.MAIN.onenter=function(){controller.playEmptyAudio(),controller.playMusic("BG");for(var t=0,n=o.length;n>t;t++)o[t].innerHTML=model.localized(o[t].attributes.key.value);if(controller.loadError){var r=document.getElementById(ID_ELMT_SECTION_MAIN_ERROR);r.innerHTML=controller.loadError,r.style.display="block",controller.loadError=null}this.data.openSection(ID_MENU_SECTION_MAIN),e(1,!1)},controller.screenStateMachine.structure.MAIN.UP=function(){return e(-1),this.BREAK_TRANSITION},controller.screenStateMachine.structure.MAIN.DOWN=function(){return e(1),this.BREAK_TRANSITION},controller.screenStateMachine.structure.MAIN.ACTION=function(){var e=o[n],t=e.attributes.key.value;return controller.loadError=null,controller.loadError||"VERSUS"!==t?"OPTIONS"===t?"OPTIONS":this.BREAK_TRANSITION:"VERSUS"}}),controller.screenStateMachine.structure.MOBILE=Object.create(controller.stateParent),controller.screenStateMachine.structure.MOBILE.onenter=function(){this.data.openSection(ID_ELMT_SECTION_MOBILE);var e=document.getElementById(ID_ELMT_SECTION_MOBILE_NEXT);e.innerHTML=model.localized(e.attributes.key.value)},controller.screenStateMachine.structure.MOBILE.ACTION=function(){return"MAIN"},controller.screenStateMachine.structure.NONE=Object.create(controller.stateParent),controller.screenStateMachine.structure.NONE.start=function(){return"LOAD"},util.scoped(function(){function e(){DEBUG&&util.log("successfully set new mod path")}function t(){DEBUG&&util.log("successfully set wipe out... next start with clean data")}function o(e){r[e].onmouseover=function(){3!==n&&(r[n].className="menuButton"),n=e,3!==n&&(r[n].className="menuButton active")}}for(var n=-1,r=[document.getElementById(ID_ELMT_OTIONS_SFX_VOL),document.getElementById(ID_ELMT_OTIONS_MUSIC_VOL),document.getElementById(ID_ELMT_OTIONS_RESET),document.getElementById("cwt_options_mapIn"),document.getElementById("cwt_options_addMap"),document.getElementById(ID_ELMT_OTIONS_GOBACK)],i=document.getElementById("cwt_options_sfxVolume_desc"),l=document.getElementById("cwt_options_musicVolume_desc"),a=document.getElementById("cwt_options_reset"),s=document.getElementById("cwt_options_goBack"),c=document.getElementById("cwt_options_addMap"),u=document.getElementById("cwt_options_sfxVolume"),d=document.getElementById("cwt_options_musicVolume"),m=document.getElementById(ID_ELMT_OTIONS_MOD_INFO),_=0,p=r.length;p>_;_++)o(_);controller.screenStateMachine.structure.OPTIONS=Object.create(controller.stateParent),controller.screenStateMachine.structure.OPTIONS.onenter=function(){i.innerHTML=model.localized(i.attributes.key.value),l.innerHTML=model.localized(l.attributes.key.value),a.innerHTML=model.localized(a.attributes.key.value),s.innerHTML=model.localized(s.attributes.key.value),c.innerHTML=model.localized(c.attributes.key.value),this.data.openSection(ID_MENU_SECTION_OPTIONS),-1!==n&&3!==n&&(r[n].className="menuButton"),n=0,r[n].className="menuButton active",u.innerHTML=Math.round(100*controller.getSfxVolume()),d.innerHTML=Math.round(100*controller.getMusicVolume())},controller.screenStateMachine.structure.OPTIONS.UP=function(){return 3!==n&&(r[n].className="menuButton"),n--,0>n&&(n=r.length-1),3!==n&&(r[n].className="menuButton active"),this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.DOWN=function(){return 3!==n&&(r[n].className="menuButton"),n++,n>=r.length&&(n=0),3!==n&&(r[n].className="menuButton active"),this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.ACTION=function(){var o=r[n].id;switch(o){case ID_ELMT_OTIONS_MOD_TAKE:var i=m.value;controller.storage.set("modificationPath",i,e),controller.storage.set("resetDataAtStart",{value:!0},t);break;case ID_ELMT_OTIONS_RESET:controller.storage.set("resetDataAtStart",{value:!0},t);break;case"cwt_options_addMap":try{var l=document.getElementById("cwt_options_mapIn").value;l=JSON.parse(l),model.checkMap(l)}catch(a){return controller.loadError="illegal map","MAIN"}controller.storage.set(l.name,l,function(){controller.mapList.push({name:l.name,key:l.name})});break;case ID_ELMT_OTIONS_GOBACK:return controller.saveSoundConfigs(),"MAIN"}return this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.LEFT=function(){var e=r[n].id;switch(e){case ID_ELMT_OTIONS_SFX_VOL:controller.setSfxVolume(controller.getSfxVolume()-.05),u.innerHTML=Math.round(100*controller.getSfxVolume());break;case ID_ELMT_OTIONS_MUSIC_VOL:controller.setMusicVolume(controller.getMusicVolume()-.05),d.innerHTML=Math.round(100*controller.getMusicVolume())}return this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.RIGHT=function(){var e=r[n].id;switch(e){case ID_ELMT_OTIONS_SFX_VOL:controller.setSfxVolume(controller.getSfxVolume()+.05),u.innerHTML=Math.round(100*controller.getSfxVolume());break;case ID_ELMT_OTIONS_MUSIC_VOL:controller.setMusicVolume(controller.getMusicVolume()+.05),d.innerHTML=Math.round(100*controller.getMusicVolume())}return this.BREAK_TRANSITION},controller.screenStateMachine.structure.OPTIONS.CANCEL=function(){return controller.saveSoundConfigs(),"MAIN"}}),util.scoped(function(){function e(){o.innerHTML=controller.mapList[t].name}var t,o=document.getElementById("map_selection"),n=document.getElementById("versus_start_btn");controller.screenStateMachine.structure.VERSUS=Object.create(controller.stateParent),controller.screenStateMachine.structure.VERSUS.onenter=function(){this.data.openSection("cwt_versus_screen"),n.innerHTML=model.localized(n.attributes.key.value),t=0,e()},controller.screenStateMachine.structure.VERSUS.UP=function(){return t>0?t--:t=controller.mapList.length-1,e(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.VERSUS.DOWN=function(){return controller.mapList.length-1>t?t++:t=0,e(),this.BREAK_TRANSITION},controller.screenStateMachine.structure.VERSUS.CANCEL=function(){return"MAIN"},controller.screenStateMachine.structure.VERSUS.ACTION=function(){return controller.mapList?(this.data.mapToLoad=controller.mapList[t].key,"GAMEROUND"):this.BREAK_TRANSITION}}),view.registerAnimationHook({key:"captureProperty",prepare:function(e,t){var o=model.properties[t];controller.updateUnitStatus(e),20===o.capturePoints?view.showInfoMessage(model.localized("propertyCaptured")):view.showInfoMessage(model.localized("propertyPointsLeft")+" "+o.capturePoints)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerAnimationHook({key:"changeWeather",prepare:function(e){view.showInfoMessage(model.localized("weatherChange")+" "+model.localized(e))},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerAnimationHook({key:"destroyUnit",prepare:function(e){var t=model.units[e];this.step=0,this.time=0,this.x=-t.x,this.y=-t.y,controller.playSound("EXPLODE")},render:function(){var e=this.step,t=view.getInfoImageForType("EXPLOSION_GROUND"),o=this.x,n=this.y,r=TILE_LENGTH,i=48*e,l=0,a=48,s=48,c=o*r,u=n*r,d=r,m=r;view.canvasCtx.drawImage(t,i,l,a,s,c,u,d,m),view.markForRedraw(o,n)},update:function(e){this.time+=e,this.time>75&&(this.step++,this.time=0)},isDone:function(){return 10===this.step}}),model.modifyVisionAt.listenCommand(function(e,t,o,n){n=10;var r,i,l=t-n,a=t+n;for(0>l&&(l=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=l;l++){var s=Math.abs(l-t);for(r=e-n+s,i=e+n-s,0>r&&(r=0),i>=model.mapWidth&&(i=model.mapWidth-1);i>=r;r++){view.markForRedraw(r,l);
var c=model.unitPosMap[r][l];null!==c&&c.hidden&&controller.updateUnitStatus(model.extractUnitId(c))}}}),model.recalculateFogMap.listenCommand(function(){view.completeRedraw()}),view.registerAnimationHook({key:"moveUnit",prepare:function(e,t,o,n){this.moveAnimationX=o,this.moveAnimationY=n,this.moveAnimationIndex=0,this.moveAnimationPath=e,this.moveAnimationUid=t,this.moveAnimationShift=0,this.moveAnimationDustX=-1,this.moveAnimationDustY=-1,this.moveAnimationDustTime=-1,this.moveAnimationDustStep=-1,this.moveAnimationDustPic=null,view.preventRenderUnit=model.units[t],model.units[t].type.movetype,DEBUG&&util.log("drawing move from","(",this.moveAnimationX,",",this.moveAnimationY,")","with path","(",this.moveAnimationPath,")")},update:function(e){var t=TILE_LENGTH;if(this.moveAnimationShift+=e/1e3*8*t,view.markForRedrawWithNeighboursRing(this.moveAnimationX,this.moveAnimationY),-1!==this.moveAnimationDustStep&&(this.moveAnimationDustTime+=e,this.moveAnimationDustTime>30&&(this.moveAnimationDustStep++,this.moveAnimationDustTime=0,3===this.moveAnimationDustStep&&(this.moveAnimationDustStep=-1))),this.moveAnimationShift>t){switch(this.moveAnimationDustX=this.moveAnimationX,this.moveAnimationDustY=this.moveAnimationY,this.moveAnimationDustTime=0,this.moveAnimationDustStep=0,this.moveAnimationPath[this.moveAnimationIndex]){case model.MOVE_CODE_UP:this.moveAnimationY--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_U");break;case model.MOVE_CODE_RIGHT:this.moveAnimationX++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_R");break;case model.MOVE_CODE_DOWN:this.moveAnimationY++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_D");break;case model.MOVE_CODE_LEFT:this.moveAnimationX--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_L")}this.moveAnimationIndex++,this.moveAnimationShift-=t,this.moveAnimationIndex===this.moveAnimationPath.length&&(this.moveAnimationX=0,this.moveAnimationY=0,this.moveAnimationIndex=0,this.moveAnimationPath=null,this.moveAnimationUid=-1,this.moveAnimationShift=0,view.preventRenderUnit=null)}},render:function(){var e,t=this.moveAnimationUid,o=this.moveAnimationX,n=this.moveAnimationY,r=this.moveAnimationShift,i=this.moveAnimationPath[this.moveAnimationIndex],l=model.units[t],a=view.colorArray[l.owner],s=l.type;switch(i){case model.MOVE_CODE_UP:e=view.IMAGE_CODE_UP;break;case model.MOVE_CODE_RIGHT:e=view.IMAGE_CODE_RIGHT;break;case model.MOVE_CODE_DOWN:e=view.IMAGE_CODE_DOWN;break;case model.MOVE_CODE_LEFT:e=view.IMAGE_CODE_LEFT}var c=view.getUnitImageForType(s.ID,e,a),u=TILE_LENGTH,d=controller.baseSize,m=2*d*view.getSpriteStep("UNIT"),_=0,p=2*d,E=2*d,I=o*u-u/2,f=n*u-u/2,h=u+u,T=u+u;switch(i){case model.MOVE_CODE_UP:f-=r;break;case model.MOVE_CODE_LEFT:I-=r;break;case model.MOVE_CODE_RIGHT:I+=r;break;case model.MOVE_CODE_DOWN:f+=r}if(void 0!==c)view.canvasCtx.drawImage(c,m,_,p,E,I,f,h,h);else{switch(I=o*u,f=n*u,h=u,T=u,i){case model.MOVE_CODE_UP:f-=r;break;case model.MOVE_CODE_LEFT:I-=r;break;case model.MOVE_CODE_RIGHT:I+=r;break;case model.MOVE_CODE_DOWN:f+=r}view.canvasCtx.fillStyle="rgb(255,0,0)",view.canvasCtx.fillRect(I,f,h,T)}if(-1!==this.moveAnimationDustStep){var u=TILE_LENGTH;m=2*d*this.moveAnimationDustStep,_=0,p=2*d,E=2*d,I=this.moveAnimationDustX*u-u/2,f=this.moveAnimationDustY*u-u/2,h=u+u,T=u+u,view.canvasCtx.drawImage(this.moveAnimationDustPic,m,_,p,E,I,f,h,T)}},isDone:function(){var e=-1===this.moveAnimationUid;return e&&util.log("DONE"),e}}),model.invokeNextStep_.listenCommand(function(){"IDLE"!==controller.stateMachine.state&&controller.showMenu(controller.stateMachine.data.menu,controller.mapCursorX,controller.mapCursorY)}),controller.playSoundForPlayer=function(e){var t=model.players[e].mainCo;Browser.ios?controller.playMusic(model.factionTypes[t.faction].music):controller.playMusic(t.music)},view.registerAnimationHook({key:"nextTurn",prepare:function(){controller.renderPlayerInfo(),controller.playSoundForPlayer(model.turnOwner),view.showInfoMessage(model.localized("day")+" "+model.day)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),util.scoped(function(){function e(e,t,n,r){if(n-=r-1,!(0>n||n>9)){var i=TILE_LENGTH,l=48*n,a=0,s=48,c=48,u=e*i,d=t*i,m=i,_=i;view.canvasCtx.drawImage(o,l,a,s,c,u,d,m,_),view.markForRedraw(e,t)}}function t(e,t){if(model.isValidPosition(e,t)){var o=model.unitPosMap[e][t];null!==o&&controller.updateUnitStatus(model.extractUnitId(o))}}var o;view.registerAnimationHook({key:"fireSilo",prepare:function(e,t,n,r){o||(o=view.getInfoImageForType("EXPLOSION_GROUND")),this.x=t,this.y=n,this.range=r,this.step=0,this.time=0},render:function(){model.doInRange(this.x,this.y,this.range,e,this.step)},update:function(e){this.time+=e,this.time>75&&(this.step++,this.time=0)},isDone:function(){var e=13===this.step;return e&&model.doInRange(this.x,this.y,this.range,t),e}})}),model.transferMoney.listenCommand(function(){controller.renderPlayerInfo()}),model.transferUnit.listenCommand(function(e){var t=model.units[e],o=-t.x,n=-t.y;controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[o][n]))}),view.registerAnimationHook({key:"trapWait",prepare:function(e){var t=model.units[e];this.time=0,this.xp=t.x+1,this.yp=t.y,this.x=(t.x+1)*TILE_LENGTH,this.y=t.y*TILE_LENGTH},render:function(){var e=view.getInfoImageForType("TRAPPED");view.canvasCtx.drawImage(e,this.x,this.y)},update:function(e){this.time+=e},isDone:function(){var e=this.time>1e3;if(e)for(var t=view.getInfoImageForType("TRAPPED"),o=this.yp,n=this.xp,r=n+parseInt(t.width/TILE_LENGTH,10);r>=n;n++)view.markForRedraw(n,o);return e}}),model.damageUnit.listenCommand(function(e){controller.updateUnitStatus(e)}),model.healUnit.listenCommand(function(e){controller.updateUnitStatus(e)}),model.battleBetween.listenCommand(function(e,t){controller.renderPlayerInfo(),controller.updateUnitStatus(e),controller.updateUnitStatus(t)}),model.buildUnit.listenCommand(function(){controller.renderPlayerInfo()}),model.loadUnitInto.listenCommand(function(e,t){controller.updateUnitStatus(t)}),model.unloadUnitFrom.listenCommand(function(e){controller.updateUnitStatus(e)}),model.joinUnits.listenCommand(function(e,t){controller.updateUnitStatus(t)}),model.refillResources.listenCommand(function(e){"number"==typeof e.x&&(e=model.extractUnitId(e)),controller.updateUnitStatus(e)}),model.setUnitPosition.listenCommand(function(e){controller.updateUnitStatus(e)}),util.scoped(function(){var e=util.matrix(4*CWT_MAX_SELECTION_RANGE+1,4*CWT_MAX_SELECTION_RANGE+1,0);controller.attackRangeVisible=!1,controller.showAttackRangeInfo=function(){if(!controller.attackRangeVisible){var t=controller.mapCursorX,o=controller.mapCursorY,n=model.unitPosMap[t][o];if(null!==n){var r=model.extractUnitId(n);DEBUG&&util.log("show attack range information");var i=controller.stateMachine.data.selection;if(i.setCenter(t,o,CWT_INACTIVE_ID),model.isIndirectUnit(r))model.attackRangeMod_(r,t,o,i);else{controller.stateMachine.data.movePath.fillMoveMap(t,o,n),i.data.cloneValues(e),i.setCenter(t,o,CWT_INACTIVE_ID);for(var l=e.length,a=0;l>a;a++)for(var s=0;l>s;s++)e[a][s]>=0&&model.attackRangeMod_(r,a,s,i,!0)}controller.attackRangeVisible=!0}}},controller.hideAttackRangeInfo=function(){controller.attackRangeVisible&&(DEBUG&&util.log("hide attack range information"),view.markSelectionMapForRedraw(controller.stateMachine.data),controller.attackRangeVisible=!1)}}),controller.registerMenuRenderer("buildUnit",function(e,t){var o=model.unitTypes[e].cost;t.innerHTML=model.localized(e)+" ("+o+"$)"}),controller.registerMenuRenderer("__mainMenu__",function(e,t){t.innerHTML=model.localized(e)}),controller.playerInfoEl_gold=document.getElementById("playerGold"),controller.playerInfoEl_power=document.getElementById("playerPower"),controller.renderPlayerInfo=function(){var e=model.players[model.turnOwner];controller.playerInfoEl_gold.innerHTML=e.gold,controller.playerInfoEl_power.innerHTML=e.power},util.scoped(function(){var e={BOX:document.getElementById(ID_ELMT_PLAYERINFOBOX),NAME:document.getElementById(ID_ELMT_PLAYERINFOBOX_NAME),PIC:document.getElementById(ID_ELMT_PLAYERINFOBOX_PIC),DESC:document.getElementById(ID_ELMT_PLAYERINFOBOX_DESC),POWER:document.getElementById(ID_ELMT_PLAYERINFOBOX_POWER),POWER_D:document.getElementById(ID_ELMT_PLAYERINFOBOX_POWER_D),PROPS:document.getElementById(ID_ELMT_PLAYERINFOBOX_PROPS),PROPS_D:document.getElementById(ID_ELMT_PLAYERINFOBOX_PROPS_D),UNITS:document.getElementById(ID_ELMT_PLAYERINFOBOX_UNITS),UNITS_D:document.getElementById(ID_ELMT_PLAYERINFOBOX_UNITS_D)};controller.showPlayerInfo=function(){if(!controller.playerInfoVisible){var t=controller.mapCursorX,o=controller.mapCursorY,n=-1,r=model.propertyPosMap[t][o];if(null!==r)n=r.owner;else{var i=model.unitPosMap[t][o];null!==i&&(n=i.owner)}if(-1!==n){var l=model.players[n];DEBUG&&util.log("show player information screen"),e.NAME.innerHTML=l.name,e.POWER_D.innerHTML="POWER_METER",e.POWER.innerHTML=l.power,e.PROPS_D.innerHTML="NUMBER PROPERTIES",e.PROPS.innerHTML=model.countProperties(n),e.UNITS_D.innerHTML="NUMBER UNITS",e.UNITS.innerHTML=model.countUnits(n),e.BOX.className="tooltip active",e.BOX.style.position="absolute",e.BOX.style.left=parseInt(window.innerWidth/2-e.BOX.offsetWidth/2,10)+"px",e.BOX.style.top=parseInt(window.innerHeight/2-e.BOX.offsetHeight/2,10)+"px",controller.playerInfoVisible=!0}}},controller.playerInfoVisible=!1,controller.hidePlayerInfo=function(){controller.playerInfoVisible&&(DEBUG&&util.log("hide player information screen"),e.BOX.className="tooltip out",controller.playerInfoVisible=!1)}}),util.scoped(function(){var e={BOX:document.getElementById(ID_ELMT_TILEINFOBOX),NAME:document.getElementById(ID_ELMT_TILEINFOBOX_NAME),PIC:document.getElementById(ID_ELMT_TILEINFOBOX_PIC),DESC:document.getElementById(ID_ELMT_TILEINFOBOX_DESC),DEFENSE:document.getElementById(ID_ELMT_TILEINFOBOX_DEFENSE),CAPPT:document.getElementById(ID_ELMT_TILEINFOBOX_CAPPT),OWNER:document.getElementById(ID_ELMT_TILEINFOBOX_OWNER),DEFENSE_D:document.getElementById(ID_ELMT_TILEINFOBOX_DEFENSE_D),OWNER_D:document.getElementById(ID_ELMT_TILEINFOBOX_OWNER_D),CAPPT_D:document.getElementById(ID_ELMT_TILEINFOBOX_CAPPT_D)};controller.showTileInfo=function(){if(!controller.tileInfoVisible){var t=controller.mapCursorX,o=controller.mapCursorY,n=model.map[t][o],r=model.propertyPosMap[t][o];null!==r&&(n=r.type),DEBUG&&util.log("show tile information screen"),e.NAME.innerHTML=model.localized(n.ID),e.DEFENSE.innerHTML=n.defense,e.DEFENSE_D.innerHTML=model.localized("DEFENSE"),e.CAPPT_D.innerHTML=model.localized("CAPTURE_PT"),e.CAPPT.innerHTML=null!==r?r.capturePoints:"-",e.OWNER_D.innerHTML=model.localized("OWNER"),e.OWNER.innerHTML=null!==r?model.players[r.owner].name:"-",e.BOX.className="tooltip active",e.BOX.style.position="absolute",e.BOX.style.left=parseInt(window.innerWidth/2-e.BOX.offsetWidth/2,10)+"px",e.BOX.style.top=parseInt(window.innerHeight/2-e.BOX.offsetHeight/2,10)+"px",controller.tileInfoVisible=!0}},controller.tileInfoVisible=!1,controller.hideTileInfo=function(){controller.tileInfoVisible&&(DEBUG&&util.log("hide tile information screen"),e.BOX.className="tooltip out",controller.tileInfoVisible=!1)}}),controller.registerMenuRenderer("transferMoney",function(e,t){t.innerHTML=e+"$"}),util.scoped(function(){var e=function(e,t){t.innerHTML=model.players[e].name};controller.registerMenuRenderer("transferProperty",e),controller.registerMenuRenderer("transferUnit",e)}),util.scoped(function(){var e={BOX:document.getElementById(ID_ELMT_UNITINFOBOX),NAME:document.getElementById(ID_ELMT_UNITINFOBOX_NAME),PIC:document.getElementById(ID_ELMT_UNITINFOBOX_PIC),DESC:document.getElementById(ID_ELMT_UNITINFOBOX_DESC),CLASS:document.getElementById(ID_ELMT_UNITINFOBOX_CLASS),MVTP:document.getElementById(ID_ELMT_UNITINFOBOX_MVTP),MAINWP:document.getElementById(ID_ELMT_UNITINFOBOX_MAINWP),SECWP:document.getElementById(ID_ELMT_UNITINFOBOX_SECWP),HP:document.getElementById(ID_ELMT_UNITINFOBOX_HP),GAS:document.getElementById(ID_ELMT_UNITINFOBOX_GAS),AMMO:document.getElementById(ID_ELMT_UNITINFOBOX_AMMO),GAS2:document.getElementById(ID_ELMT_UNITINFOBOX_GAS2),AMMO2:document.getElementById(ID_ELMT_UNITINFOBOX_AMMO2),MVRANGE:document.getElementById(ID_ELMT_UNITINFOBOX_MVRANGE),VISION:document.getElementById(ID_ELMT_UNITINFOBOX_VISION),ATTRANGE:document.getElementById(ID_ELMT_UNITINFOBOX_ATTRANGE),ATTRANGE2:document.getElementById(ID_ELMT_UNITINFOBOX_ATTRANGE2),AG_INF:document.getElementById(ID_ELMT_UNITINFOBOX_AG_INF),AG_VEH:document.getElementById(ID_ELMT_UNITINFOBOX_AG_VEH),AG_AIR:document.getElementById(ID_ELMT_UNITINFOBOX_AG_AIR),AG_HELI:document.getElementById(ID_ELMT_UNITINFOBOX_AG_HELI),AG_SHIP:document.getElementById(ID_ELMT_UNITINFOBOX_AG_SHIP),AG_SUB:document.getElementById(ID_ELMT_UNITINFOBOX_AG_SUB),CLASS_D:document.getElementById(ID_ELMT_UNITINFOBOX_CLASS_D),MVTP_D:document.getElementById(ID_ELMT_UNITINFOBOX_MVTP_D),MAINWP_D:document.getElementById(ID_ELMT_UNITINFOBOX_MAINWP_D),SECWP_D:document.getElementById(ID_ELMT_UNITINFOBOX_SECWP_D),HP_D:document.getElementById(ID_ELMT_UNITINFOBOX_HP_D),GAS_D:document.getElementById(ID_ELMT_UNITINFOBOX_GAS_D),AMMO_D:document.getElementById(ID_ELMT_UNITINFOBOX_AMMO_D),MVRANGE_D:document.getElementById(ID_ELMT_UNITINFOBOX_MVRANGE_D),VISION_D:document.getElementById(ID_ELMT_UNITINFOBOX_VISION_D),ATTRANGE_D:document.getElementById(ID_ELMT_UNITINFOBOX_ATTRANGE_D),AG_INF_D:document.getElementById(ID_ELMT_UNITINFOBOX_AG_INF_D),AG_VEH_D:document.getElementById(ID_ELMT_UNITINFOBOX_AG_VEH_D),AG_AIR_D:document.getElementById(ID_ELMT_UNITINFOBOX_AG_AIR_D),AG_HELI_D:document.getElementById(ID_ELMT_UNITINFOBOX_AG_HELI_D),AG_SHIP_D:document.getElementById(ID_ELMT_UNITINFOBOX_AG_SHIP_D),AG_SUB_D:document.getElementById(ID_ELMT_UNITINFOBOX_AG_SUB_D)};controller.showUnitInfo=function(){if(!controller.unitInfoVisible){var t=controller.mapCursorX,o=controller.mapCursorY,n=model.unitPosMap[t][o];if(n){var r=n.type;DEBUG&&util.log("show unit information screen"),e.NAME.innerHTML=model.localized(r.ID),e.MVTP_D.innerHTML=model.localized("MOVETYPE"),e.MVTP.innerHTML=model.localized(r.movetype),e.MAINWP_D.innerHTML=model.localized("PRIMARY_WP"),e.MAINWP.innerHTML="",e.SECWP_D.innerHTML=model.localized("SECONDARY_WP"),e.SECWP.innerHTML="",e.HP_D.innerHTML=model.localized("HP"),e.HP.innerHTML=n.hp,e.GAS_D.innerHTML=model.localized("FUEL"),e.GAS.innerHTML=n.fuel,e.GAS2.innerHTML=r.fuel,e.AMMO_D.innerHTML=model.localized("AMMO"),e.AMMO.innerHTML=n.ammo,e.AMMO2.innerHTML=r.ammo,e.MVRANGE_D.innerHTML=model.localized("MOVERANGE"),e.MVRANGE.innerHTML=r.range,e.VISION_D.innerHTML=model.localized("VISION"),e.VISION.innerHTML=r.vision,e.ATTRANGE_D.innerHTML=model.localized("ATTACK_RANGE");var i=r.attack;i?(e.ATTRANGE.innerHTML=i.minrange||1,e.ATTRANGE2.innerHTML=i.maxrange||1):(e.ATTRANGE.innerHTML="",e.ATTRANGE2.innerHTML=""),e.BOX.className="tooltip active",e.BOX.style.position="absolute",e.BOX.style.left=parseInt(window.innerWidth/2-e.BOX.offsetWidth/2,10)+"px",e.BOX.style.top=parseInt(window.innerHeight/2-e.BOX.offsetHeight/2,10)+"px",controller.unitInfoVisible=!0}}},controller.unitInfoVisible=!1,controller.hideUnitInfo=function(){controller.unitInfoVisible&&(DEBUG&&util.log("hide unit information screen"),e.BOX.className="tooltip out",controller.unitInfoVisible=!1)}}),controller.registerMenuRenderer("unloadUnit",function(e,t){t.innerHTML="done"===e?model.localized("done"):model.localized(model.units[e].type.ID)});