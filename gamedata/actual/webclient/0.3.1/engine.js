var CWT_INACTIVE_ID=-1,DEBUG=!0,CWT_ACTIONS_BUFFER_SIZE=200,CWT_MAX_MAP_WIDTH=100,CWT_MAX_MAP_HEIGHT=100,CWT_MAX_PLAYER=5,CWT_MAX_UNITS_PER_PLAYER=50,CWT_MAX_PROPERTIES=200,CWT_MAX_SELECTION_RANGE=15,CWT_MAX_BUFFER_SIZE=200,CWT_VERSION="0.3.1",model={},controller={},util={};if(util.scoped=function(e){return e()},util.raiseError=function(e){throw 0===arguments.length?e="CustomWars Debug:: An error was raised":arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),util.log("ERROR:",e),Error(e)},util.log=function(e){arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),console.log(e)},util.fillList_=function(){for(var e=this.__defValue__,t=this.__length__,o="function"==typeof e,n=0,r=t;r>n;n++)this[n]=o?e(n):e},util.fillMatrix_=function(){for(var e=this.__defValue__,t=this.__width__,o=this.__height__,n="function"==typeof e,r=0,l=t;l>r;r++)for(var a=0,i=o;i>a;a++)this[r][a]=n?e(r,a):e},util.cloneList_=function(e){var t=this.__length__;if(e.__length__!==t)throw Error();for(var o=0,n=t;n>o;o++)e[o]=this[o]},util.cloneMatrix_=function(e){var t=this.__width__,o=this.__height__;if(e.length!==this.length)throw Error();for(var n=0,r=t;r>n;n++)for(var l=0,a=o;a>l;l++)e[n][l]=this[n][l]},util.list=function(e,t){void 0===t&&(t=null);var o=[];return o.__defValue__=t,o.__length__=e,o.resetValues=util.fillList_,o.cloneValues=util.cloneList_,o.resetValues(),o},util.matrix=function(e,t,o){void 0===o&&(o=null);var n=[];n.__defValue__=o,n.__width__=e,n.__height__=t,n.resetValues=util.fillMatrix_,n.cloneValues=util.cloneMatrix_;for(var r=0;e>r;r++)n[r]=[];return n.resetValues(),n},util.createRingBuffer=function(e){var t={push:function(e){if(null!==this._data[this._wInd])throw Error("message buffer is full");this._data[this._wInd]=e,this._wInd++,this._wInd===this._size&&(this._wInd=0)},isEmpty:function(){return null===this._data[this._rInd]},pop:function(){if(null===this._data[this._rInd])throw Error("message buffer is empty");var e=this._data[this._rInd];return this._data[this._rInd]=null,this._rInd++,this._rInd===this._size&&(this._rInd=0),e},clear:function(){this._rInd=0,this._wInd=0;for(var t=0;e>t;t++)this._data[t]=null}};return t._rInd=0,t._wInd=0,t._data=util.list(e,null),t._size=e,t},void 0!==simpleStateMachine)throw Error("simpleStateMachine is already defined in the global scope");var simpleStateMachine=function(){return{BREAK_TRANSITION:"__BREAK_TRS__",state:"NONE",history:[],name:"UNNAMED STATEMACHINE",lastState:"__LAST_STATE_TRS__",structure:{},event:function(e){DEBUG&&util.log(this.name+": got event",e);var t=this.structure[this.state][e];void 0===t&&util.raiseError("missing event",e,"in state",this.state);var o=t.apply(this,arguments);if(void 0!==o)if(o!==this.BREAK_TRANSITION){var n=o===this.lastState;n&&(o=1===this.history.length?"IDLE":this.history.pop());var r=this.structure[o];if(void 0===r&&util.raiseError("state",o,"is not defined"),void 0!==r.onenter){var l=r.onenter.apply(this,arguments);if(l===this.BREAK_TRANSITION)return}n||this.history.push(this.state),this.state=o,DEBUG&&util.log(this.name+": changed state to",o),void 0!==r.actionState&&this.event.call(this,"actionState")}else"actionState"===e&&util.raiseError("an action state cannot return a break transition");else util.raiseError("an event must return a transition command")}}};model.leftActors=util.list(CWT_MAX_UNITS_PER_PLAYER,!1),model.canAct=function(e){var t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;return e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e?!1:model.leftActors[e-t]===!0},model.setActableStatus=function(e,t){var o=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;e>=o+CWT_MAX_UNITS_PER_PLAYER||o>e?util.raiseError("unit with id",e,"does not belongs to the turn owner"):model.leftActors[e-o]=t},model.resetActableStatus=function(){for(var e=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER,t=e,o=t+CWT_MAX_UNITS_PER_PLAYER;o>t;t++)model.leftActors[t-e]=!0},model.markUnitActable=function(e){model.setActableStatus(e,!0)},model.trapWait=function(){},model.markUnitNonActable=function(e){model.setActableStatus(e,!1)},model.isIndirectUnit=function(e){return"number"==typeof model.units[e].type.minrange},model.baseDamageAgainst=function(e,t,o){var n,r=e.type.attack,l=t.type.ID;return o===void 0&&(o=!0),o&&e.ammo>0&&void 0!==r.main_wp&&(n=r.main_wp[l],"number"==typeof n)?n:void 0!==r.sec_wp&&(n=r.sec_wp[l],"number"==typeof n)?n:-1},model.canUseMainWeapon=function(e,t){var o,n=e.type.attack,r=t.type.ID;return e.ammo>0&&void 0!==n.main_wp&&(o=n.main_wp[r],"number"==typeof o)?!0:!1},model.hasMainWeapon=function(e){var t=e.attack;return t!==void 0&&t.main_wp!==void 0},model.hasSecondaryWeapon=function(e){var t=e.attack;return t!==void 0&&t.sec_wp!==void 0},model.attackRangeMod_=function(e,t,o,n,r){var l=n!==void 0;r||(r=!1);var a=model.units[e],i=model.players[a.owner].team,d=a.type.attack;if(1===arguments.length&&(t=a.x,o=a.y),d===void 0)return!1;if(model.hasMainWeapon(a.type)&&!model.hasSecondaryWeapon(a.type)&&a.type.ammo>0&&0===a.ammo)return!1;var s=1,u=1;a.type.attack.minrange&&(controller.prepareTags(t,o,e),s=controller.scriptedValue(a.owner,"minRange",a.type.attack.minrange),u=controller.scriptedValue(a.owner,"maxRange",a.type.attack.maxrange));var m,c,p=o-u,f=o+u;for(0>p&&(p=0),f>=model.mapHeight&&(f=model.mapHeight-1);f>=p;p++){var _=Math.abs(p-o);for(m=t-u+_,c=t+u-_,0>m&&(m=0),c>=model.mapWidth&&(c=model.mapWidth-1);c>=m;m++)if(r)model.distance(t,o,m,p)>=s&&n.setValueAt(m,p,1);else{if(0===model.fogData[m][p])continue;if(model.distance(t,o,m,p)>=s){var h=model.unitPosMap[m][p];if(null!==h&&model.players[h.owner].team!==i){var E=model.baseDamageAgainst(a,h);if(E>0){if(!l)return!0;n.setValueAt(m,p,E)}}}}}return!1},model.hasTargets=function(e,t,o){return model.attackRangeMod_(e,t,o)},model.getBattleDamage=function(e,t,o,n,r){var l=model.baseDamageAgainst(e,t,n),a=model.unitHpPt(e),i=model.unitHpPt(t);controller.prepareTags(e.x,e.y);var d=parseInt(o/100*controller.scriptedValue(e.owner,"luck",10),10),s=controller.scriptedValue(e.owner,"att",100);r&&(s+=controller.scriptedValue(unit.owner,"counterAtt",0)),controller.prepareTags(t.x,t.y);var u=controller.scriptedValue(t.owner,"def",100),m=controller.scriptedValue(t.owner,"terraindefense",model.map[t.x][t.y].defense),c=(l*s/100+d)*(a/10)*((200-(u+m*i))/100);return c=parseInt(c,10),DEBUG&&util.log("attacker:",model.extractUnitId(e),"[",l,"*",s,"/100+",d,"]*(",a,"/10)*[(200-(",u,"+",m,"*",i,"))/100]","=",c),c},model.battleBetween=function(e,t,o,n){var r=model.units[e],l=model.units[t],a=r.type,i=l.type,d=r.owner,s=l.owner,u=model.unitHpPt(l),m=model.unitHpPt(r);if(model.damageUnit(t,model.getBattleDamage(r,l,o)),u-=model.unitHpPt(l),model.canUseMainWeapon(r,l)&&r.ammo--,u=parseInt(.1*u*i.cost,10),model.modifyPowerLevel(d,parseInt(.5*u,10)),model.modifyPowerLevel(s,u),l.hp>0&&!model.isIndirectUnit(t)){var c=model.canUseMainWeapon(l,r);model.damageUnit(e,model.getBattleDamage(l,r,n,c,!0)),m-=model.unitHpPt(r),c&&l.ammo--,m=parseInt(.1*m*a.cost,10),model.modifyPowerLevel(s,parseInt(.5*m,10)),model.modifyPowerLevel(d,m)}},model.INACTIVE_POWER=0,model.CO_POWER=1,model.SUPER_CO_POWER=2,model.TAG_CO_POWER=3,util.scoped(function(){function e(e,t){var o=model.players[e];o.coPower_active=t,o.power=0,o.timesPowerUsed++}model.activateCoPower=function(t){e(t,model.INACTIVE_POWER)},model.activateCoPower=function(t){e(t,model.CO_POWER)},model.activateSuperCoPower=function(t){e(t,model.SUPER_CO_POWER)}}),model.modifyPowerLevel=function(e,t){model.players[e].power+=t,0>model.players[e].power&&(model.players[e].power=0)},model.coStarCost=function(e){var t=controller.configValue("coStarCost"),o=model.players[e].timesPowerUsed,n=controller.configValue("coStarCostIncreaseSteps");return o>n&&(o=n),t+=o*controller.configValue("coStarCostIncrease")},util.scoped(function(){function t(e,t,o){var n=e[t];return void 0===n&&o===!0&&util.raiseError(t,"needs to be defined"),void 0===n?!1:("object"!=typeof n&&void 0===typeof n.length&&util.raiseError(t,"needs to be an array but is ",typeof n),!0)}function o(e,t,o){var n=e[t];return void 0===n&&o===!0&&util.raiseError(t,"needs to be defined"),void 0===n?!1:("string"!=typeof n&&util.raiseError(t,"needs to be a string but is ",typeof n),!0)}function n(e,t,o){var n=e[t];return void 0===n&&o===!0&&util.raiseError(t,"needs to be defined"),void 0===n?!1:("object"!=typeof n&&util.raiseError(t,"needs to be an object but is ",typeof n),!0)}function r(e,t,o){var n=e[t];return void 0===n&&o===!0&&util.raiseError(t,"needs to be defined"),void 0===n?!1:("boolean"!=typeof n&&util.raiseError(t,"needs to be a boolean but is ",typeof n),!0)}function l(e,t){t.hasOwnProperty(e)&&util.raiseError(e,"is already registered")}function a(e,t,o){t[e]===o&&util.raiseError(e,"cannot have value",o)}function d(e,t){t.hasOwnProperty(e)||util.raiseError(e,"is not registered")}function s(e,t,o,n,r,l){var a=e[t];return void 0===a&&o===!0&&util.raiseError(t,"needs to be defined"),void 0===a?!1:("number"!=typeof a&&util.raiseError(t,"needs to be a number but is ",typeof a),n===!0&&parseInt(a,10)!==a&&util.raiseError(t,"needs to be an integer"),void 0!==r&&r>a&&util.raiseError(t,"needs to be greater equal",r,"but is",a),void 0!==r&&isNaN(r)&&util.raiseError("wrong minimum parameter"),void 0!==l&&a>l&&util.raiseError(t,"needs to be greater equal",l,"but is",a),void 0!==l&&isNaN(l)&&util.raiseError("wrong maximum parameter"),!0)}model.unitTypes={},model.tileTypes={},model.weatherTypes={},model.defaultWeatherType=null,model.nonDefaultWeatherType=[],model.moveTypes={},model.factionTypes={},model.coTypes={},model.globalRules=[],model.mapRules=[],model.language={en:{}},model.sounds=null,model.graphics=null,model.maps=null,model.wpKeys_=["main_wp","sec_wp"];var u="en";model.localized=function(e){var t=model.language[u][e];return void 0===t?e:t},model.parseUnitType=function(e){var a,i,u,m,c,p,f,_,h;if(o(e,"ID",!0),DEBUG&&util.log("try parsing unit sheet",e.ID),l(e.ID,model.unitTypes),o(e,"movetype",!0),d(e.movetype,model.moveTypes),s(e,"range",!0,!0,0,CWT_MAX_SELECTION_RANGE),s(e,"vision",!0,!0,1,CWT_MAX_SELECTION_RANGE),s(e,"fuel",!0,!0,0,99),s(e,"ammo",!0,!0,0,9),s(e,"cost",!0,!0,0,99999),r(e,"stealth",!1),r(e,"suppliesloads",!1),s(e,"captures",!1,!0,1,10),t(e,"canload",!1))for(s(e,"maxloads",!0,!0,1,5),u=e.canload,c=0,f=u.length;f>c;c++)o(u,c,!0);if(t(e,"supply",!1))for(u=e.supply,c=0,f=u.length;f>c;c++)o(u,c,!0);if(n(e,"suicide",!1)&&(h=e.suicide,s(h,"damage",!0,!0,1,9),s(h,"range",!0,!0,1,CWT_MAX_SELECTION_RANGE),n(h,"nodamage",!1)))for(u=h.nodamage,c=0,f=u.length;f>c;c++)o(u,c,!0);if(n(e,"repairs",!1))for(h=e.repairs,a=Object.keys(h),p=0,_=a.length;_>p;p++)i=a[p],s(h,i,!0,!0,1,9);if(n(e,"attack",!1))for(m=e.attack,s(m,"minrange",!1,!0,1),s(m,"maxrange",!1,!0,m.minrange+1),c=0,f=model.wpKeys_.length;_>c;c++)if(n(m,model.wpKeys_[c],!1))for(u=m[model.wpKeys_[c]],a=Object.keys(u),p=0,_=a.length;_>p;p++)i=a[p],s(u,i,!0,!0,1);model.listOfUnitTypes.push(e.ID),model.unitTypes[e.ID]=e},model.parseTileType=function(e){if(o(e,"ID",!0),DEBUG&&util.log("try parsing tile sheet",e.ID),l(e.ID,model.tileTypes),s(e,"defense",!0,!0,0,6),s(e,"vision",!1,!0,0,CWT_MAX_SELECTION_RANGE),s(e,"points",!1,!0,1,100),s(e,"funds",!1,!0,10,99999),n(e,"repairs",!1))for(sub=e.repairs,keys=Object.keys(sub),i2=0,e2=keys.length;e2>i2;i2++)key=keys[i2],s(sub,key,!0,!0,1,9);if(t(e,"builds",!1))for(list=e.builds,i1=0,e1=list.length;e1>i1;i1++)o(list,i1,!0);model.tileTypes[e.ID]=e},model.parseWeatherType=function(e){o(e,"ID",!0),DEBUG&&util.log("try parsing weather sheet",e.ID),l(e.ID,model.weatherTypes),r(e,"defaultWeather",!1),s(e,"vision",!1,!0,-5,5),s(e,"att",!1,!0,-100,100),s(e,"minRange",!1,!0,-5,5),s(e,"maxRange",!1,!0,-5,5),model.weatherTypes[e.ID]=e,e.defaultWeather?model.defaultWeatherType=e:model.nonDefaultWeatherType.push(e)},model.parseMoveType=function(e){o(e,"ID",!0),DEBUG&&util.log("try parsing movetype sheet",e.ID),l(e.ID,model.moveTypes),n(e,"costs",!0);for(var t=e.costs,r=Object.keys(t),i=0,d=r.length;d>i;i++)s(t,r[i],!0,!0,-1,CWT_MAX_SELECTION_RANGE),a(t,r[i],0);model.moveTypes[e.ID]=e},model.parseCoType=function(e){o(e,"ID",!0),DEBUG&&util.log("try parsing co sheet",e.ID),l(e.ID,model.coTypes),s(e,"coStars",!0,!0,-1,10),a(e,"coStars",0),s(e,"scoStars",!0,!0,-1,10),a(e,"scoStars",0),t(e,"d2d",!0),t(e,"cop",!0),t(e,"scop",!0),o(e,"faction",!0),d(e.faction,model.factionTypes),o(e,"music",!1),model.coTypes[e.ID]=e},model.parseFactionType=function(e){o(e,"ID",!0),DEBUG&&util.log("try parsing faction sheet",e.ID),l(e.ID,model.factionTypes),o(e,"music",!0),model.factionTypes[e.ID]=e},model.parseRule=function(e,t){t?model.mapRules.push(e):model.globalRules.push(e)},model.checkMap=function(n){var r;for(o(n,"name",!0),t(n,"players",!0),r=n.players,s(r,"length",!0,!0,1,4),i=0,e=r.length;e>i;i++)t(r,i,!0),s(r[i],0,!0,!0,i,i),o(r[i],1,!0),s(r[i],2,!0,!0,0,999999),s(r[i],3,!0,!0,1,4),o(r[i],4,!0),o(r[i],5,!0),s(r[i],6,!0,!0,0,99999);for(t(n,"leftActors",!0),r=n.leftActors,s(r,"length",!0,!0,1,50),i=0,e=r.length;e>i;i++)s(r,i,!0,!0,0,49);if(t(n,"timers",!0),t(n,"rules",!0),s(n,"day",!0,!0,0,9999),s(n,"turnOwner",!0,!0,0,n.players.length-1),s(n,"mapHeight",!0,!0,10,100),s(n,"mapWidth",!0,!0,10,100),t(n,"typeMap",!0))for(r=n.typeMap,i=0,e=r.length;e>i;i++)o(r,i,!0);if(t(n,"map",!0))for(r=n.map,s(r,"length",!0,!0,10,100),i=0,e=r.length;e>i;i++)t(r,i,!0),s(r[i],"length",!0,!0,10,100)},model.listOfUnitTypes=[],model.listOfPropertyTypes_=null,model.getListOfPropertyTypes=function(){if(null===model.listOfTileTypes_){for(var e=model.tileTypes,t=Object.keys(e),o=[],n=t.length-1;n>=0;n--)e[t[n]].capturePoints>0&&o.push(t[n]);model.listOfPropertyTypes_=o}return model.listOfPropertyTypes_},model.listOfTileTypes_=null,model.getListOfTileTypes=function(){if(null===model.listOfTileTypes_){for(var e=model.tileTypes,t=Object.keys(e),o=[],n=t.length-1;n>=0;n--)void 0===e[t[n]].capturePoints&&o.push(t[n]);model.listOfTileTypes_=o}return model.listOfTileTypes_}}),model.turnTimedEvents_time_=util.list(50,null),model.turnTimedEvents_data_=util.list(50,null),model.pushTimedEvent=function(e,t){for(var o=model.turnTimedEvents_time_,n=0,r=o.length;r>n;n++)if(null===model.turnTimedEvents_time_[n])return model.turnTimedEvents_time_[n]=e,model.turnTimedEvents_data_[n]=t,void 0;util.reaiseError("no free slot")},model.tickTimedEvents=function(){for(var e=model.turnTimedEvents_time_,t=0,o=e.length;o>t;t++)if(null!==e[t]&&(e[t]--,0===e[t])){e[t]=null;var n=model.turnTimedEvents_data_[t];model.turnTimedEvents_data_[t]=null,controller.isNetworkGame()&&controller.sendNetworkMessage(JSON.stringify(n)),controller.actionBuffer_.push(n)}},model.fogData=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,0),util.scoped(function(){function e(e,t,o,n,r){if(controller.configValue("fogEnabled")){controller.prepareTags(e,t),n=controller.scriptedValue(o,"vision",n);var l,a,i=model.mapHeight,d=model.mapWidth,s=t-n,u=t+n;for(0>s&&(s=0),u>=i&&(u=i-1);u>=s;s++){var m=Math.abs(s-t);for(l=e-n+m,a=e+n-m,0>l&&(l=0),a>=d&&(a=d-1);a>=l;l++)model.fogData[l][s]+=r}}}model.modifyVisionAt=e,model.recalculateFogMap=function(t){var o,n,r=model.mapWidth,l=model.mapHeight,a=model.players[t].team,i=1===controller.configValue("fogEnabled");for(o=0;r>o;o++)for(n=0;l>n;n++)model.fogData[o][n]=i?0:1;if(i)for(o=0;r>o;o++)for(n=0;l>n;n++){var d=model.unitPosMap[o][n];if(null!==d){var s=d.owner;if(t===s||model.players[s].team===a){var u=d.type.vision;0>u&&(u=0),e(o,n,s,u,1)}}var m=model.propertyPosMap[o][n];if(null!==m){var s=m.owner;if(-1!==s&&(t===s||model.players[s].team===a)){var u=m.type.vision;0>u&&(u=0),e(o,n,s,u,1)}}}}}),model.map=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.mapHeight=-1,model.mapWidth=-1,model.distance=function(e,t,o,n){var r=Math.abs(e-o),l=Math.abs(t-n);return r+l},model.moveCodeFromAtoB=function(e,t,o,n){return 1!==model.distance(e,t,o,n)&&util.raiseError("both positions haven't a distance of 1"),e>o?model.MOVE_CODE_LEFT:o>e?model.MOVE_CODE_RIGHT:t>n?model.MOVE_CODE_UP:n>t?model.MOVE_CODE_DOWN:(util.raiseError("fatal error while getting move code from (",e,",",t,") to (",o,",",n,")"),void 0)},model.isValidPosition=function(e,t){return e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t},model.doInRange=function(e,t,o,n,r){var l,a,i=t-o,d=t+o;for(0>i&&(i=0),d>=model.mapHeight&&(d=model.mapHeight-1);d>=i;i++){var s=Math.abs(i-t);for(l=e-o+s,a=e+o-s,0>l&&(l=0),a>=model.mapWidth&&(a=model.mapWidth-1);a>=l;l++)n(l,i,r,Math.abs(l-e)+s)}},model.MOVE_CODE_UP=0,model.MOVE_CODE_RIGHT=1,model.MOVE_CODE_DOWN=2,model.MOVE_CODE_LEFT=3,model.moveUnit=function(e,t,o,n){for(var r=o,l=n,a=model.units[t],i=a.type,d=model.moveTypes[i.movetype],s=(e.length-1,0),u=0,m=e.length;m>u;u++){switch(e[u]){case model.MOVE_CODE_UP:0===l&&util.logError("cannot do move command UP because","current position is at the border"),l--;break;case model.MOVE_CODE_RIGHT:r===model.mapWidth-1&&util.logError("cannot do move command RIGHT because","current position is at the border"),r++;break;case model.MOVE_CODE_DOWN:l===model.mapHeight-1&&util.logError("cannot do move command DOWN because","current position is at the border"),l++;break;case model.MOVE_CODE_LEFT:0===r&&util.logError("cannot do move command LEFT because","current position is at the border"),r--;break;default:util.logError("unknown command ",e[u])}s+=model.moveCosts(d,model.map[r][l])}a.fuel-=s,0>a.fuel&&util.raiseError("illegal game state"),a.x>=0&&a.y>=0&&model.clearUnitPosition(t),null===model.unitPosMap[r][l]&&model.setUnitPosition(t,r,l),DEBUG&&util.log("moved unit",t,"from (",o,",",n,") to (",r,",",l,")")},model.clearUnitPosition=function(e){var t=model.units[e],o=t.x,n=t.y;t.owner===model.turnOwner&&model.modifyVisionAt(o,n,t.owner,t.type.vision,-1),model.unitPosMap[o][n]=null,t.x=-t.x,t.y=-t.y},model.setUnitPosition=function(e,t,o){var n=model.units[e];n.x=t,n.y=o,model.unitPosMap[t][o]=n,n.owner===model.turnOwner&&model.modifyVisionAt(t,o,n.owner,n.type.vision,1)},model.moveCosts=function(e,t){var o,n=e.costs;return o=n[t.ID],"number"==typeof o?o:(o=n["*"],"number"==typeof o?o:-1)},model.moveCodeFromAtoB=function(e,t,o,n){return model.distance(e,t,o,n)>1&&util.raiseError("positions aren't neighbours"),o>e?model.MOVE_CODE_RIGHT:e>o?model.MOVE_CODE_LEFT:n>t?model.MOVE_CODE_DOWN:t>n?model.MOVE_CODE_UP:(util.raiseError("fatal error"),void 0)},model.invokeNextStep_=function(){controller.stateMachine.event("nextStep")},model.MODE_SAME_OBJECT=-1,model.MODE_NONE=0,model.MODE_OWN=1,model.MODE_ALLIED=2,model.MODE_TEAM=3,model.MODE_ENEMY=4,model.players=util.list(CWT_MAX_PLAYER,function(){return{gold:0,team:CWT_INACTIVE_ID,name:null,mainCo:null,sideCo:null,power:model.INACTIVE_POWER,timesPowerUsed:0}}),model.extractPlayerId=function(e){null===e&&util.raiseError("player argument cannot be null");for(var t=model.players,o=0,n=t.length;n>o;o++)if(t[o]===e)return o;util.raiseError("cannot find player",t)},model.playerLooses=function(e){DEBUG&&util.logInfo("player",e,"looses this game round");for(var t=e*CWT_MAX_UNITS_PER_PLAYER,o=t+CWT_MAX_UNITS_PER_PLAYER;o>t;t++)model.units[t].owner!==CWT_INACTIVE_ID&&model.destroyUnit(t);for(var t=0,o=model.properties.length;o>t;t++)model.properties[t].owner===e&&(model.properties[t].owner=-1);oldPlayer.team=-1;for(var n=-1,t=0,o=model.players.length;o>t;t++){var r=model.players[t];if(-1!==r.team)if(-1===n)n=r.team;else if(n!==r.team){n=-1;break}}-1!==n&&controller.endGameRound()},model.thereIsUnitCheck=function(e,t,o,n){if(!model.isValidPosition(e,t))return!1;var r=model.unitPosMap[e][t];return null!==r&&model.relationShipCheck(o,r.owner,n)},model.thereIsPropertyCheck=function(e,t,o,n){if(!model.isValidPosition(e,t))return!1;var r=model.propertyPosMap[e][t];return null!==r&&model.relationShipCheck(o,r.owner,n)},model.relationShipCheck=function(e,t){if(null===e||null===t)return model.MODE_NONE;if(-1===e||-1===t)return model.MODE_NONE;if(-1===model.players[e].team||-1===model.players[t].team)return model.MODE_NONE;if(e===t)return model.MODE_OWN;var o=model.players[e].team,n=model.players[t].team;return-1===o||-1===n?model.MODE_NONE:o===n?model.MODE_ALLIED:o!==n?model.MODE_ENEMY:model.MODE_NONE},model.relationShipCheckUnitNeighbours=function(e,t,o,n){var r=model.relationShipCheck;return t>0&&null!==model.unitPosMap[t-1][o]&&r(e,model.unitPosMap[t-1][o].owner)===n?!0:o>0&&null!==model.unitPosMap[t][o-1]&&r(e,model.unitPosMap[t][o-1].owner)===n?!0:model.mapWidth-1>t&&null!==model.unitPosMap[t+1][o]&&r(e,model.unitPosMap[t+1][o].owner)===n?!0:model.mapHeight-1>o&&null!==model.unitPosMap[t][o+1]&&r(e,model.unitPosMap[t][o+1].owner)===n?!0:!1},model.properties=util.list(CWT_MAX_PROPERTIES+1,function(){return{capturePoints:20,owner:-1,x:0,y:0,type:null}}),model.propertyPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.tileIsProperty=function(e,t){return null!==model.propertyPosMap[e][t]},model.extractPropertyId=function(e){null===e&&util.raiseError("property argument cannot be null");for(var t=model.properties,o=0,n=t.length;n>o;o++)if(t[o]===e)return o;util.raiseError("cannot find property",e)},model.countProperties=function(e){for(var t=0,o=model.properties,n=0,r=o.length;r>n;n++)o[n].owner===e&&t++;return t},model.buildUnit=function(e,t,o){model.createUnit(model.turnOwner,e,t,o);var n=model.unitTypes[o].cost,r=model.players[model.turnOwner];n>r.gold&&util.raiseError("buyer hasn't enough money"),r.gold-=n},model.isBuildableByFactory=function(e,t){var o=e.type.builds;return void 0===o?!1:-1!==o.indexOf("*")?!0:-1!==o.indexOf(t)?!0:-1!==o.indexOf(model.unitTypes[t].movetype)?!0:!1},model.propertyFunds=function(e){for(var t,o=model.players[e],n=model.properties,r=0,l=n.length;l>r;r++)if(t=n[r],t.owner===e){controller.prepareTags(t.x,t.y);var a=controller.scriptedValue(t.owner,"funds",t.type.funds);"number"==typeof a&&(o.gold+=a)}},model.propertySupply=function(e){for(var t,o=model.properties,n=0,r=o.length;r>n;n++)if(t=o[n],t.owner===e&&void 0!==t.type.supply){var l=t.x,a=t.y,i=model.thereIsUnitCheck,d=model.MODE_OWN;1===controller.configValue("supplyAlliedUnits")&&(d=model.MODE_TEAM),i(l,a,e,d)&&model.refillResources(model.unitPosMap[l][a])}},model.propertyRepairs=function(e){for(var t,o=model.properties,n=0,r=o.length;r>n;n++)if(t=o[n],t.owner===e){var l=t.x,a=t.y,i=model.thereIsUnitCheck,d=model.MODE_OWN;1===controller.configValue("repairAlliedUnits")&&(d=model.MODE_TEAM),i(l,a,e,d)&&model.healUnit(model.extractUnitId(model.unitPosMap[l][a]),20,!0)}},model.captureProperty=function(e,t){var o=model.units[e],n=model.properties[t],r=parseInt(o.hp/10,10)+1;if(n.capturePoints-=r,0>=n.capturePoints){var l=n.x,a=n.y;DEBUG&&util.logInfo("property",t,"captured by",e),model.modifyVisionAt(l,a,n.type.vision,1);var i=n.type.changeAfterCaptured;if(i!==void 0&&(DEBUG&&util.logInfo("property",t,"changes type to",i),n.type=i),n.type.looseAfterCaptured===!0){var d=n.owner;model.playerLooses(d)}n.capturePoints=20,n.owner=o.owner;var s=controller.configValue("captureLimit");0!==s&&model.countProperties()>=s&&controller.endGameRound()}},model.changePropertyType=function(e,t){model.properties[e]=t},util.scoped(function(){function e(e,t){var o=model.unitPosMap[e][t];null!==o&&model.damageUnit(model.extractUnitId(o),20,9)}model.fireSilo=function(t,o,n,r,l){model.doInRange(o,n,r,e,l);var a=model.properties[t].type;model.changePropertyType(t,a.changeTo),model.pushTimedEvent(model.daysToTurns(5),model.changePropertyType.callToList(t,a.ID))}}),model.day=0,model.turnOwner=-1,model.configRule={},model.isTurnOwner=function(e){return model.turnOwner===e},model.daysToTurns=function(e){return model.players.length*e},model.nextTurn=function(){var e=model.turnOwner,t=e;for(DEBUG&&util.log("player",e,"ends it's turn"),e++;e!==t;){if(e===CWT_MAX_PLAYER){e=0,model.day++,model.tickTimedEvents();var o=controller.configValue("dayLimit");o>0&&model.day===o&&controller.endGameRound()}if(model.players[e].team!==CWT_INACTIVE_ID)break;e++}e===t&&util.raiseError("could not find next player"),model.drainFuel(e),model.propertyFunds(e),model.propertyRepairs(e),model.propertySupply(e),model.resetActableStatus(e),1===controller.configValue("autoSupplyAtTurnStart")&&model.supplyUnitsBySupplierUnits(e),model.recalculateFogMap(e),DEBUG&&util.log("player",e,"is new turn owner"),model.turnOwner=e,model.resetTurnTimer()},model.transferMoney=function(e,t,o){var n=model.players[e],r=model.players[t];o>n.gold&&util.raiseError("source player does not has",o,"units of money"),n.gold-=o,r.gold+=o},model.transferUnit=function(e,t){var o=model.units[e],n=o.x,r=o.y,l=o.owner;o.owner=CWT_INACTIVE_ID,model.players[t].team!==model.players[l].team&&model.modifyVisionAt(o.x,o.y,o.type.vision,-1),model.unitPosMap[o.x][o.y]=null,model.createUnit(t,o.x,o.y,o.type.ID);var a=model.unitPosMap[o.x][o.y];a.hp=o.hp,a.ammo=o.ammo,a.fuel=o.fuel,a.exp=o.exp,a.type=o.type,a.x=n,a.y=r,a.loadedIn=o.loadedIn},model.transferProperty=function(e,t){var o=model.properties[e];o.owner=t;var n,r,l=model.mapWidth,a=model.mapHeight;for(n=0;l>n;n++)for(r=0;a>r;r++)if(model.propertyPosMap[n][r]===o)return},util.scoped(function(){var e=0,t=0;model.gametimeElapsed=0,model.turntimeElapsed=0,model.resetTurnTimer=function(){model.turntimeElapsed=0},model.updateTimer=function(o){model.turntimeElapsed+=o,model.gametimeElapsed+=o,e&&model.turntimeElapsed>=e&&model.nextTurn.callAsCommand(),t&&model.gametimeElapsed>=t&&controller.endGameRound()},model.setupTimer=function(){model.turntimeElapsed=0,model.gametimeElapsed=0,e=6e4*controller.configValue("turnTimeLimit"),t=6e4*controller.configValue("gameTimeLimit")}}),model.hasLoadedIds=function(e){for(var t=model.units[e].owner,o=CWT_MAX_UNITS_PER_PLAYER*t,n=o+CWT_MAX_UNITS_PER_PLAYER;n>o;o++)if(o!==e){var r=model.units[o];if(null!==r&&r.loadedIn===e)return!0}return!1},model.isLoadedBy=function(e,t){return model.units[e].loadedIn===t},model.loadUnitInto=function(e,t){model.canLoad(e,t)||util.raiseError("transporter unit",t,"cannot load unit",e),model.units[e].loadedIn=t,model.units[t].loadedIn--},model.unloadUnitFrom=function(e,t,o,n,r,l){if(-1!==r&&-1!==l){model.units[n].loadedIn=-1,model.units[e].loadedIn++;var a;t>r?a=model.MOVE_CODE_LEFT:r>t?a=model.MOVE_CODE_RIGHT:o>l?a=model.MOVE_CODE_UP:l>o&&(a=model.MOVE_CODE_DOWN),model.moveUnit([a],n,t,o),model.markUnitNonActable(n)}},model.canLoad=function(e,t){e===t&&util.raiseError("transporter cannot load itself");var o=model.units[t],n=model.units[e],r=o.type.maxloads;if(0===o.loadedIn+r+1)return!1;var l=o.type.canload;return-1===l.indexOf(n.type.ID)&&-1===l.indexOf(n.type.movetype)&&-1===l.indexOf("*")?!1:!0},model.isTransport=function(e){return"number"==typeof model.units[e].type.maxloads},model.unitPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.units=util.list(CWT_MAX_PLAYER*CWT_MAX_UNITS_PER_PLAYER,function(){return{x:0,y:0,hp:99,ammo:0,fuel:0,type:null,loadedIn:-1,hidden:!1,owner:CWT_INACTIVE_ID}}),model.extractUnitId=function(e){null===e&&util.raiseError("unit argument cannot be null");for(var t=model.units,o=0,n=t.length;n>o;o++)if(t[o]===e)return o;util.raiseError("cannot find unit",e)},model.hasFreeUnitSlots=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,o=t+CWT_MAX_UNITS_PER_PLAYER;o>t;t++)if(model.units[t].owner!==CWT_INACTIVE_ID)return!0;return!1},model.isTileOccupiedByUnit=function(e,t){var o=model.unitPosMap[e][t];return null===o?-1:model.extractUnitId(o)},model.countUnits=function(e){for(var t=0,o=e*CWT_MAX_UNITS_PER_PLAYER,n=o+CWT_MAX_UNITS_PER_PLAYER;n>o;o++)model.units[o].owner!==CWT_INACTIVE_ID&&t++;return t},model.unitHpPt=function(e){return parseInt(e.hp/10)+1},model.unitHpPtRest=function(e){var t=parseInt(e.hp/10)+1;return e.hp-t},model.ptToHp=function(e){return 10*e},model.refillResources=function(e){var t="number"==typeof e.x?e:model.units[e],o=t.type;t.ammo=o.ammo,t.fuel=o.fuel},model.unitSuppliesNeighbours=function(e){var t=model.units[e];void 0===t.type.supply&&util.raiseError("unit is not a supplier unit");var o=t.x,n=t.y,r=t.owner,l=1===controller.configValue("supplyAlliedUnits")?model.MODE_TEAM:model.MODE_OWN,a=model.relationShipCheck;o>0&&null!==model.unitPosMap[o-1][n]&&a(r,model.unitPosMap[o-1][n].owner,l)&&model.refillResources(model.unitPosMap[o-1][n]),n>0&&null!==model.unitPosMap[o][n-1]&&a(r,model.unitPosMap[o][n-1].owner,l)&&model.refillResources(model.unitPosMap[o][n-1]),model.mapWidth-1>o&&null!==model.unitPosMap[o+1][n]&&a(r,model.unitPosMap[o+1][n].owner,l)&&model.refillResources(model.unitPosMap[o+1][n]),model.mapHeight-1>n&&null!==model.unitPosMap[o][n+1]&&a(r,model.unitPosMap[o][n+1].owner,l)&&model.refillResources(model.unitPosMap[o][n+1])},model.damageUnit=function(e,t,o){"number"!=typeof e&&util.raiseError("id expected");var n=model.units[e];n.hp-=t,o&&o>=n.hp?n.hp=o:0>=n.hp&&model.destroyUnit(e)},model.healUnit=function(e,t,o){"number"!=typeof e&&util.raiseError("id expected");var n=model.units[e];if(n.hp+=t,n.hp>99){if(o===!0){var r=n.hp-99;model.players[n.owner].gold+=parseInt(n.type.cost*r/100,10)}n.hp=99}},model.hideUnit=function(e){model.units[e].hidden=!0},model.unhideUnit=function(e){model.units[e].hidden=!1},model.joinUnits=function(e,t){var o=model.units[e],n=model.units[t];n.type!==o.type&&util.raiseError("both units has to be the same type of unit"),model.healUnit(t,model.ptToHp(model.unitHpPt(o)),!0),n.ammo+=o.ammo,n.ammo>n.type.ammo&&(n.ammo=n.type.ammo),n.fuel+=o.fuel,n.fuel>n.type.fuel&&(n.fuel=n.type.fuel),o.owner=CWT_INACTIVE_ID},model.drainFuel=function(e){for(var t,o=e*CWT_MAX_UNITS_PER_PLAYER,n=o+CWT_MAX_UNITS_PER_PLAYER;n>o;o++)if(t=model.units[o],t.owner!==CWT_INACTIVE_ID){var r=t.type.dailyFuelDrain;"number"==typeof r&&(t.hidden&&t.type.dailyFuelDrainHidden&&(r=t.type.dailyFuelUseHidden),t.fuel-=r,0>=t.fuel&&model.destroyUnit(o))}},model.supplyUnitsBySupplierUnits=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,o=t+CWT_MAX_UNITS_PER_PLAYER;o>t;t++)unit=model.units[t],unit.owner!==CWT_INACTIVE_ID&&void 0!==unit.type.supply&&model.unitSuppliesNeighbours(t)},model.createUnit=function(e,t,o,n){for(var r=e*CWT_MAX_UNITS_PER_PLAYER,l=r+CWT_MAX_UNITS_PER_PLAYER;l>r;r++)if(model.units[r].owner===CWT_INACTIVE_ID){var a=model.unitTypes[n],i=model.units[r];return i.hp=99,i.owner=e,i.type=a,i.ammo=a.ammo,i.fuel=a.fuel,i.loadedIn=-1,model.setUnitPosition(r,t,o),DEBUG&&util.log("build unit for player",e,"in slot",r),void 0}util.raiseError("cannot build unit for player",e,"because no slot is free")},model.destroyUnit=function(e){model.clearUnitPosition(e);var t=model.units[e];t.owner=CWT_INACTIVE_ID,1===controller.configValue("noUnitsLeftLoose")&&0===model.countUnits(t.owner)&&controller.endGameRound()},model.weather=null,model.calculateNextWeather=function(){var e,t;if(null!==model.weather&&model.weather===model.defaultWeatherType){var o=model.nonDefaultWeatherType;e=o[parseInt(Math.random()*o.length,10)].ID,t=1}else e=model.defaultWeatherType.ID,t=controller.configValue("weatherMinDays")+parseInt(controller.configValue("weatherRandomDays")*Math.random(),10);model.changeWeather.callAsCommand(e),DEBUG&&util.log("Weather will change in",t,"days"),model.pushTimedEvent(model.daysToTurns(t),model.calculateNextWeather.callToList())},model.changeWeather=function(e){model.weatherTypes.hasOwnProperty(e)||util.raiseError("unknown weather type"),DEBUG&&util.log("changing weather to",e),model.weather=model.weatherTypes[e]},controller.actionMap={},controller.actionObjects={},controller.actionBuffer_=util.createRingBuffer(CWT_ACTIONS_BUFFER_SIZE),controller.defineAction_=function(e){e.hasOwnProperty("condition")||util.raiseError("condition needed"),e.hasOwnProperty("key")||util.raiseError("action key isn't defined"),e.hasOwnProperty("invoke")||util.raiseError("action implementation isn't defined"),controller.actionObjects.hasOwnProperty(e.key)&&util.raiseError("action key is already registered"),e.hasOwnProperty("prepareMenu")||(e.prepareMenu=null),e.hasOwnProperty("prepareTargets")||(e.prepareTargets=null),e.hasOwnProperty("isTargetValid")||(e.isTargetValid=null),e.hasOwnProperty("multiStepAction")||(e.multiStepAction=!1),null===e.prepareTargets||e.hasOwnProperty("targetSelectionType")||(e.targetSelectionType="A"),null!==e.prepareTargets&&null!==e.isTargetValid&&util.raiseError("only one selection type can be used in an action"),controller.actionObjects[e.key]=e
},controller.unitAction=function(e){e.mapAction=!1,e.unitAction=!0,e.propertyAction=!1,controller.defineAction_(e)},controller.propertyAction=function(e){e.mapAction=!1,e.unitAction=!1,e.propertyAction=!0,controller.defineAction_(e)},controller.mapAction=function(e){e.mapAction=!0,e.unitAction=!1,e.propertyAction=!1,controller.defineAction_(e)},controller.callToList_=function(){for(var e=[],t=0,o=arguments.length;o>t;t++)e[t]=arguments[t];return e[e.length]=this.__actionId__,e},controller.callAsCommand_=function(){for(var e=[],t=0,o=arguments.length;o>t;t++)e[t]=arguments[t];e[e.length]=this.__actionId__,DEBUG&&util.log("adding",JSON.stringify(e),"to the command stack as",controller.actionMap[this.__actionId__],"command"),controller.isNetworkGame()&&controller.sendNetworkMessage(JSON.stringify(e)),controller.actionBuffer_.push(e)},controller.listenCommand_=function(e){controller.listenCommand(controller.actionMap[this.__actionId__],e)},util.scoped(function(){for(var e=0,t=Object.keys(model),o=0,n=t.length;n>o;o++){var r=t[o],l=model[r];"function"==typeof l&&(l.__actionId__=""+e,l.callAsCommand=controller.callAsCommand_,l.callToList=controller.callToList_,l.listenCommand=controller.listenCommand_,controller.actionMap[""+e]=t[o],e++)}}),util.scoped(function(){var e=null;controller.buildAction=function(){e||(e=controller.stateMachine.data);var t=e.target,o=e.source,n=e.movePath,r=e.action,l=controller.actionObjects[r.selectedEntry],a=!1;if(n.data.length>0){if(null!==n.data)for(var i=n.data,d=o.x,s=o.y,u=0,m=i.length;m>u;u++){switch(i[u]){case model.MOVE_CODE_DOWN:s++;break;case model.MOVE_CODE_UP:s--;break;case model.MOVE_CODE_LEFT:d--;break;case model.MOVE_CODE_RIGHT:d++}var c=model.unitPosMap[d][s];null!==c&&model.players[model.turnOwner].team!==model.players[c.owner].team&&(t.set(d,s),i.splice(u),a=!0)}model.moveUnit.callAsCommand(n.clone(),o.unitId,o.x,o.y)}return a?model.trapWait.callAsCommand(o.unitId):l.invoke(e),l.unitAction&&"wait"!==r.selectedEntry&&model.markUnitNonActable.callAsCommand(o.unitId),a}}),function(){var e={};controller.listenCommand=function(t,o){model[t].__actionId__===void 0&&util.raiseError(t+" isn't a valid command able action"),e[t]&&util.raiseError("listener for",t,"is already registered");var n=model[t];model[t]=function(){var e=n.apply(model,arguments);return o.apply(null,arguments),e},model[t].callAsCommand=function(){n.callAsCommand.apply(n,arguments)},model[t].callToList=function(){n.callToList.apply(n,arguments)},e[t]=!0}}(),util.scoped(function(){function e(e){var t="client has to implement interface "+e;return function(){util.raiseError(t)}}controller.isNetworkGame=e("controller.isNetworkGame"),controller.parseNetworkMessage=e("controller.parseNetworkMessage"),controller.sendNetworkMessage=e("controller.sendNetworkMessage")}),model.loadModification=function(e){var t,o;for(t=0,o=e.weathers.length;o>t;t++)model.parseWeatherType(e.weathers[t]);for(t=0,o=e.tiles.length;o>t;t++)model.parseTileType(e.tiles[t]);for(t=0,o=e.movetypes.length;o>t;t++)model.parseMoveType(e.movetypes[t]);for(t=0,o=e.units.length;o>t;t++)model.parseUnitType(e.units[t]);for(t=0,o=e.factions.length;o>t;t++)model.parseFactionType(e.factions[t]);for(t=0,o=e.commanders.length;o>t;t++)model.parseCoType(e.commanders[t]);for(t=0,o=e.globalRules.length;o>t;t++)model.parseRule(e.globalRules[t],!1);model.graphics=e.graphics,model.sounds=e.sounds,model.maps=e.maps,model.language=e.language},util.scoped(function(){function e(e){var t=e[0],o=model.units[t];o.type=model.unitTypes[e[1]],o.x=e[2],o.y=e[3],o.hp=e[4],o.ammo=e[5],o.fuel=e[6],o.loadedIn=e[7],o.owner=e[8],model.unitPosMap[e[2]][e[3]]=o}function t(e){return[model.extractUnitId(e),e.type.ID,e.x,e.y,e.hp,e.ammo,e.fuel,e.loadedIn,e.owner]}function o(e){return[e.extractPlayerId(e),e.name,e.gold,e.team,e.mainCo?e.mainCo.ID:"",e.sideCo?e.sideCo.ID:"",e.power,e.timesPowerUsed]}function n(e){var t=e[0],o=model.players[t];o.name=e[1],o.gold=e[2],o.team=e[3],e[4]?o.mainCo=model.coTypes[e[4]]:null,e[5]?o.sideCo=model.coTypes[e[5]]:null,o.power=e[6],o.timesPowerUsed=e[7]}function r(e){for(var t,o,n=!1,r=0;model.mapWidth>r&&!n;r++)for(var l=0;model.mapHeight>l&&!n;l++)model.propertyPosMap[r][l]===e&&(t=r,o=l,n=!0);return[model.extractPropertyId(e),t,o,e.type.ID,e.capturePoints,e.owner]}function l(e){var t=e[0],o=model.properties[t];o.type=model.tileTypes[e[3]],o.capturePoints=e[4],o.owner=e[5],o.x=e[1],o.y=e[2],model.propertyPosMap[e[1]][e[2]]=o}model.getCompactModel=function(){var e={};e.day=model.day,e.turnOwner=model.turnOwner,e.mapWidth=model.mapWidth,e.mapHeight=model.mapHeight,e.timeElapsed=model.timeElapsed,e.map=[];for(var n={},l=0,a=0,i=model.mapWidth;i>a;a++){e.map[a]=[];for(var d=0,s=model.mapHeight;s>d;d++){var u=e.map[a][d].ID;n.hasOwnProperty(u)||(n[u]=l,l++),e.map[a][d]=n[u]}}e.typeMap=[];for(var m=Object.keys(n),c=0,p=m.length;p>c;c++)e.typeMap[n[m[c]]]=m[c];e.units=[];for(var c=0,p=model.units.length;p>c;c++)model.units[c].owner!==CWT_INACTIVE_ID&&e.units.push(t(model.units[c]));e.properties=[];for(var c=0,p=model.properties.length;p>c;c++)model.properties[c].owner!==CWT_INACTIVE_ID&&e.properties.push(r(model.properties[c]));e.players=[];for(var c=0,p=model.players.length;p>c;c++)model.players[c].team!==CWT_INACTIVE_ID&&e.players.push(o(model.players[c]));e.actors=[];for(var c=0,p=model.leftActors.length;p>c;c++)model.leftActors[c]&&e.actors.push(c);e.timers=[];for(var c=0,p=model.turnTimedEvents_time_.length;p>c;c++)null!==model.turnTimedEvents_time_[c]&&e.timers.push([model.turnTimedEvents_time_[c],model.turnTimedEvents_data_[c]]);return e},model.loadCompactModel=function(t){model.day=t.day,model.turnOwner=t.turnOwner,model.mapWidth=t.mapWidth,model.mapHeight=t.mapHeight,model.timeElapsed=t.timeElapsed;for(var o=0,r=model.mapWidth;r>o;o++)for(var a=0,i=model.mapHeight;i>a;a++)model.unitPosMap[o][a]=null,model.propertyPosMap[o][a]=null,model.map[o][a]=model.tileTypes[t.typeMap[t.map[o][a]]];for(var d=0,s=model.units.length;s>d;d++)model.units[d].owner=CWT_INACTIVE_ID;for(var d=0,s=t.units.length;s>d;d++)e(t.units[d]);for(var d=0,s=model.properties.length;s>d;d++)model.properties[d].owner=CWT_INACTIVE_ID;for(var d=0,s=t.properties.length;s>d;d++)l(t.properties[d]);for(var d=0,s=model.players.length;s>d;d++)model.players[d].team=CWT_INACTIVE_ID;for(var d=0,s=t.players.length;s>d;d++)n(t.players[d]);for(var d=0,s=model.leftActors.length;s>d;d++)model.leftActors[d]=!1;for(var d=0,s=t.leftActors.length;s>d;d++)model.leftActors[t.leftActors[d]]=!0;for(var d=0,s=model.turnTimedEvents_time_.length;s>d;d++)model.turnTimedEvents_time_[d]=null,model.turnTimedEvents_data_[d]=null;for(var d=0,s=t.timers.length;s>d;d++)model.turnTimedEvents_time_[d]=t.timers[d][0],model.turnTimedEvents_data_[d]=t.timers[d][1];model.mapRules.splice(0);for(var d=0,s=t.rules.length;s>d;d++)model.parseRule(t.rules[d],!0);controller.buildRoundConfig({})}}),controller.scriptBoundaries_={minrange:[1,CWT_MAX_SELECTION_RANGE-1],maxrange:[1,CWT_MAX_SELECTION_RANGE],moverange:[1,CWT_MAX_SELECTION_RANGE],movecost:[1,CWT_MAX_SELECTION_RANGE],vision:[1,10],att:[50,400],counteratt:[50,400],def:[50,400],luck:[-50,50],captureRate:[50,9999],neutralizeWeather:[0,1],firstcounter:[0,1],funds:[1,99999],fuelDrain:[1,1],comtowerbonus:[1,100],terraindefense:[0,12],terraindefensemodifier:[10,300]},controller.configBoundaries_={daysOfPeace:{min:0,max:50,defaultValue:0},fogEnabled:{min:0,max:1,defaultValue:1},dayLimit:{min:0,max:999,defaultValue:0},noUnitsLeftLoose:{min:0,max:1,defaultValue:0},supplyAlliedUnits:{min:0,max:1,defaultValue:0},captureLimit:{min:0,max:CWT_MAX_PROPERTIES,defaultValue:0},unitLimit:{min:0,max:CWT_MAX_UNITS_PER_PLAYER,defaultValue:0},weatherMinDays:{min:1,max:5,defaultValue:1},weatherRandomDays:{min:0,max:5,defaultValue:4},repairAlliedUnits:{min:0,max:1,defaultValue:0},autoSupplyAtTurnStart:{min:0,max:1,defaultValue:1},coStarCost:{min:5,max:5e4,step:5,defaultValue:9e3},coStarCostIncrease:{min:0,max:5e4,step:5,defaultValue:1800},coStarCostIncreaseSteps:{min:0,max:50,defaultValue:10},turnTimeLimit:{min:0,max:60,defaultValue:0},gameTimeLimit:{min:0,max:99999,defaultValue:0}},controller.buildRoundConfig=function(e){for(var t=controller.configBoundaries_,o=Object.keys(t),n=0,r=o.length;r>n;n++){var l,a=o[n];e.hasOwnProperty(a)?(l=e[a],t[a].min>l&&util.raiseError(a,"is greater than it's minimum value"),l>t[a].max&&util.raiseError(a,"is greater than it's maximum value"),t[a].hasOwnProperty("step")&&0!==l%t[a].step&&util.raiseError(a,"is does not fits one of it's possible values")):l=t[a].defaultValue,model.configRule[a]=l}},controller.configValue=function(e){return model.configRule[e]},util.scoped(function(){function e(e,t,o,n){for(var r=0,l=e.length;l>r;r++){var a=e[r],i=a[o];if("number"==typeof i){var d,s;if(s=a.$all,s!==void 0){d=!1;for(var u=0,m=s.length;m>u;u++)if(t[s[u]]!==!0){d=!0;break}if(d)continue}if(s=a.$any,s!==void 0){d=!0;for(var u=0,m=s.length;m>u;u++)if(t[s[u]]===!0){d=!1;break}if(d)continue}n+=i}}return bounds=controller.scriptBoundaries_[o],void 0!==bounds?bounds[0]>n?n=bounds[0]:n>bounds[1]&&(n=bounds[1]):util.raiseError("no boundaries given for "+o),n}controller.scriptedValue=function(t,o,n){"number"!=typeof n&&util.raiseError("numberic value as parameter value expected");var r=controller.scriptTags;n=e(model.globalRules,r,o,n),n=e(model.mapRules,r,o,n);var l=model.players[t].mainCo,a=!0;l&&(n=e(l.d2d,r,o,n),a=0===e(l.d2d,r,"neutralizeWeather",0));var i=model.weather;a&&i&&(n=e(i.rules,r,o,n));var d=controller.scriptBoundaries_[o];return d[0]>n?n=d[0]:n>d[1]&&(n=d[1]),n}}),controller.stateMachine=simpleStateMachine(),controller.stateMachine.name="ENGINE",controller.TaggedPosition={clean:function(){this.x=-1,this.y=-1,this.unit=null,this.unitId=-1,this.property=null,this.propertyId=-1},set:function(e,t){this.x=e,this.y=t;var o,n=-1!==e&&-1!==t,r=n?0===model.fogData[e][t]:!1;o=n?model.unitPosMap[e][t]:null,!n||r||null===o||o.hidden&&o.owner!==model.turnOwner&&model.players[o.owner].team!==model.players[model.turnOwner].team?(this.unit=null,this.unitId=-1):(this.unit=o,this.unitId=model.extractUnitId(o)),o=n?model.propertyPosMap[e][t]:null,n&&null!==o?(this.property=o,this.propertyId=model.extractPropertyId(o)):(this.property=null,this.propertyId=-1)}},controller.stateMachine.data={},controller.scriptTags={},controller.prepareTags=function(e,t,o,n,r,l){var a=controller.scriptTags;a.__oldUnit__&&(a[a.__oldUnit__]=!1),a.__oldTile__&&(a[a.__oldTile__]=!1),a.INDIRECT=!1,a.DIRECT=!1;var i=o>-1?model.units[o]:model.unitPosMap[e][t];i&&(a.__oldUnit__=i.type.ID,a[a.__oldUnit__]=!0,model.isIndirectUnit(o>-1?o:model.extractUnitId(i))?a.INDIRECT=!0:a.DIRECT=!0);var d=model.map[e][t].ID,s=model.propertyPosMap[e][t];s&&(d=s.type.ID),a.__oldTile__=d,a[a.__oldTile__]=!0,arguments.length>3&&(a.OTHER_INDIRECT=!1,a.OTHER_DIRECT=!1,i=l>-1?model.units[l]:model.unitPosMap[n][r],i&&(model.isIndirectUnit(l>-1?l:model.extractUnitId(i))?a.OTHER_INDIRECT=!0:a.OTHER_DIRECT=!0))},controller.inGameRound=!1,function(){var e=controller.actionBuffer_,t=0;controller.updateState=function(o){if(controller.inGameRound||util.raiseError("no game round is active"),model.updateTimer(o),controller.inGameRound&&!e.isEmpty()){var n=e.pop(),r=controller.actionMap[n[n.length-1]];if(void 0===r&&util.raiseError("unknown or illegal model action"),DEBUG){var l=JSON.stringify(n);t+=l.length,util.log("evaluate action",l,"which is command",r,"all evaluated characters so far are",t)}model[r].apply(model,n)}},controller.startGameRound=function(o){DEBUG&&util.log("start game round"),controller.inGameRound=!0,t=0,e.clear(),model.setupTimer(),model.loadCompactModel(o),model.calculateNextWeather(),model.recalculateFogMap(0)},controller.endGameRound=function(){DEBUG&&util.log("end game round"),controller.inGameRound=!1}}(),controller.stateMachine.data.action={selectedEntry:null,selectedSubEntry:null,object:null},controller.stateMachine.data.menu={data:util.list(20,null),size:0,addEntry:function(e){this.size===this.data.length&&util.raiseError(),this.data[this.size]=e,this.size++},clean:function(){this.size=0},generate:util.scoped(function(){var e,t=controller.stateMachine.data;return function(){e||(e=Object.keys(controller.actionObjects));var o=!0,n=t.source.unit;null===n||n.owner!==model.turnOwner?o=!1:model.canAct(t.source.unitId)||(o=!1);var r=!0,l=t.source.property;null!==n&&(r=!1),(null===l||l.owner!==model.turnOwner)&&(r=!1);for(var a=0,i=e.length;i>a;a++){var d=controller.actionObjects[e[a]];d.condition&&(d.unitAction!==!0||o)&&(d.propertyAction!==!0||r)&&d.condition(t)&&this.addEntry(e[a])}}})},controller.stateMachine.data.movePath={ILLEGAL_MOVE_FIELD:-1,data:[],clean:function(){this.data.splice(0)},clone:function(){for(var e=[],t=0,o=this.data.length;o>t;t++)e[t]=this.data[t];return e},addCodeToPath:function(e,t,o){var n=controller.stateMachine.data.movePath.data,r=n[n.length-1];switch(o){case model.MOVE_CODE_UP:if(r===model.MOVE_CODE_DOWN)return n.pop(),void 0;break;case model.MOVE_CODE_DOWN:if(r===model.MOVE_CODE_UP)return n.pop(),void 0;break;case model.MOVE_CODE_LEFT:if(r===model.MOVE_CODE_RIGHT)return n.pop(),void 0;break;case model.MOVE_CODE_RIGHT:if(r===model.MOVE_CODE_LEFT)return n.pop(),void 0;break;default:util.raiseError()}var l=controller.stateMachine.data.source,a=l.unit,i=a.fuel,d=0;n.push(o);var s=a.type.range;s>i&&(s=i);for(var u=l.x,m=l.y,c=0,p=n.length;p>c;c++){switch(n[c]){case model.MOVE_CODE_UP:m--;break;case model.MOVE_CODE_DOWN:m++;break;case model.MOVE_CODE_LEFT:u--;break;case model.MOVE_CODE_RIGHT:u++;break;default:util.raiseError()}d+=controller.stateMachine.data.selection.getValueAt(u,m)}d>s&&this.setPathByRecalculation(e,t)},setPathByRecalculation:function(e,t){var o=controller.stateMachine.data.source,n=controller.stateMachine.data.selection,r=controller.stateMachine.data.movePath.data,l=o.x,a=o.y;DEBUG&&util.log("searching path from (",l,",",a,") to (",e,",",t,")");var i=new Graph(n.data),d=l-n.centerX,s=a-n.centerY,u=i.nodes[d][s],m=e-n.centerX,c=t-n.centerY,p=i.nodes[m][c],f=astar.search(i.nodes,u,p);DEBUG&&util.log("calculated way is",f);for(var _,h=[],E=l,y=a,g=0,T=f.length;T>g;g++){_=f[g];var v;_.x>E?v=model.MOVE_CODE_RIGHT:E>_.x?v=model.MOVE_CODE_LEFT:_.y>y?v=model.MOVE_CODE_DOWN:y>_.y?v=model.MOVE_CODE_UP:util.raiseError(),h.push(v),E=_.x,y=_.y}r.splice(0);for(var g=0,T=h.length;T>g;g++)r[g]=h[g]},fillMoveMap:function(e,t,o){var n=controller.stateMachine.data.source,r=controller.stateMachine.data.selection;o||(o=n.unit);var l=model.moveTypes[o.type.movetype],a=model.players[o.owner];"number"!=typeof e&&(e=n.x),"number"!=typeof t&&(t=n.y),controller.prepareTags(e,t,model.extractUnitId(o));var i=controller.scriptedValue(o.owner,"moverange",o.type.range);i>o.fuel&&(i=o.fuel),r.setCenter(e,t,this.ILLEGAL_MOVE_FIELD),r.setValueAt(e,t,i);for(var d=[e,t,i],s=[-1,-1,-1,-1,-1,-1,-1,-1];;){for(var u=-1,m=-1,c=0,p=d.length;p>c;c+=3){var f=d[c+2];void 0!==f&&null!==f&&(-1===u||f>u)&&(u=f,m=c)}if(-1===m)break;var _=d[m],h=d[m+1],E=d[m+2];d[m]=null,d[m+1]=null,d[m+2]=null,_>0?(s[0]=_-1,s[1]=h):(s[0]=-1,s[1]=-1),model.mapWidth-1>_?(s[2]=_+1,s[3]=h):(s[2]=-1,s[3]=-1),h>0?(s[4]=_,s[5]=h-1):(s[4]=-1,s[5]=-1),model.mapHeight-1>h?(s[6]=_,s[7]=h+1):(s[6]=-1,s[7]=-1);for(var y=0;8>y;y+=2)if(-1!==s[y]){var g=s[y],T=s[y+1],v=model.moveCosts(l,model.map[g][T]);if(-1!==v){var I=model.unitPosMap[g][T];if(null!==I&&model.fogData[g][T]>0&&!I.hidden&&model.players[I.owner].team!==a.team)continue;var M=E-v;if(M>=0&&M>r.getValueAt(g,T)){r.setValueAt(g,T,M);for(var c=0,p=d.length;p>=c;c+=3)if(null===d[c]||c===p){d[c]=g,d[c+1]=T,d[c+2]=M;break}}}}}for(var e=0,A=model.mapWidth;A>e;e++)for(var t=0,O=model.mapHeight;O>t;t++)if(r.getValueAt(e,t)!==this.ILLEGAL_MOVE_FIELD){var v=model.moveCosts(l,model.map[e][t]);r.setValueAt(e,t,v)}}},controller.stateMachine.data.inMultiStep=!1,controller.stateMachine.data.source=Object.create(controller.TaggedPosition),controller.stateMachine.data.target=Object.create(controller.TaggedPosition),controller.stateMachine.data.targetselection=Object.create(controller.TaggedPosition),controller.stateMachine.data.thereIsUnitRelationShip=function(e,t){return e.unit&&e.unit===t.unit?model.MODE_SAME_OBJECT:model.relationShipCheck(null!==e.unit?e.unit.owner:null,null!==t.unit?t.unit.owner:null)},controller.stateMachine.data.thereIsUnitToPropertyRelationShip=function(e,t){return model.relationShipCheck(null!==e.unit?e.unit.owner:null,null!==t.property?t.property.owner:null)},controller.stateMachine.data.selection={centerX:0,centerY:0,data:util.matrix(4*CWT_MAX_SELECTION_RANGE+1,4*CWT_MAX_SELECTION_RANGE+1,0),setCenter:function(e,t,o){for(var n=this.data,r=n.length,l=e,a=t,e=0;r>e;e++)for(var t=0;r>t;t++)n[e][t]=o;this.centerX=Math.max(0,l-2*CWT_MAX_SELECTION_RANGE),this.centerY=Math.max(0,a-2*CWT_MAX_SELECTION_RANGE)},getValueAt:function(e,t){var o=this.data,n=this.centerX,r=this.centerY;e-=r,t-=n;var l=o.length;return 0>e||0>t||e>=l||t>=l?-1:o[e][t]},setValueAt:function(e,t,o){var n=this.data,r=this.centerX,l=this.centerY;e-=l,t-=r;var a=n.length;0>e||0>t||e>=a||t>=a?util.raiseError():n[e][t]=o},prepare:function(){var e=controller.stateMachine.data.target,t=e.x,o=e.y;this.setCenter(t,o,-1);var n=controller.stateMachine.data.action.object;return n.prepareTargets(controller.stateMachine.data),"A"===n.targetSelectionType?"ACTION_SELECT_TARGET_A":"ACTION_SELECT_TARGET_B"},nextValidPosition:function(e,t,o,n,r){var l=this.data,a=this.centerX,i=this.centerY;e-=i,t-=a;var d=l.length;(0>e||0>t||e>=d||t>=d)&&(n?(e=d-1,t=d-1):(e=0,t=0));var s=n?-1:1;for(t+=s;n?e>=0:d>e;e+=s){for(;n?t>=0:d>t;t+=s)if(l[e][t]>=o)return DEBUG&&util.log("found the next valid position at",e,",",t),r(e,t),void 0;t=n?d-1:0}DEBUG&&util.log("could not find the next valid position")}},controller.stateMachine.structure.ACTION_MENU={onenter:function(){return this.data.menu.clean(),this.data.menu.generate(),0===this.data.menu.size?(this.data.target.clean(),this.BREAK_TRANSITION):void 0},action:function(e,t){var o=this.data.menu.data[t],n=controller.actionObjects[o];return this.data.action.selectedEntry=o,this.data.action.object=n,null!==n.prepareMenu?"ACTION_SUBMENU":null!==n.isTargetValid?"ACTION_SELECT_TILE":null!==n.prepareTargets&&"A"===n.targetSelectionType?this.data.selection.prepare():"FLUSH_ACTION"},cancel:function(){return this.data.target.clean(),this.lastState}},controller.stateMachine.structure.ACTION_SUBMENU={onenter:function(){this.data.inMultiStep||(this.data.menu.clean(),this.data.action.object.prepareMenu(this.data),0===this.data.menu.size&&util.raiseError("sub menu cannot be empty"))},action:function(e,t){var o=this.data.menu.data[t];return"done"===o?"IDLE":(this.data.action.selectedSubEntry=o,null!==this.data.action.object.prepareTargets&&"B"===this.data.action.object.targetSelectionType?this.data.selection.prepare():"FLUSH_ACTION")},cancel:function(){return this.data.inMultiStep?this.lastState:(this.data.menu.clean(),this.data.menu.generate(),this.lastState)}},controller.stateMachine.structure.FLUSH_ACTION={actionState:function(){var e=controller.buildAction();return!e&&this.data.action.object.multiStepAction?(model.invokeNextStep_.callAsCommand(),"MULTISTEP_IDLE"):"IDLE"}},controller.stateMachine.structure.IDLE={onenter:function(){this.data.menu.clean(),this.data.movePath.clean(),this.data.action.selectedEntry=null,this.data.action.selectedSubEntry=null,this.data.action.object=null,this.history.splice(0),this.data.inMultiStep=!1,this.data.makeMultistep=!0,this.data.source.clean(),this.data.target.clean(),this.data.targetselection.clean()},action:function(e,t,o){return this.data.source.set(t,o),this.data.source.unitId!==CWT_INACTIVE_ID&&this.data.source.unit.owner===model.turnOwner&&model.canAct(this.data.source.unitId)?(this.data.target.set(t,o),this.data.movePath.clean(),this.data.movePath.fillMoveMap(),"MOVEPATH_SELECTION"):(this.data.target.set(t,o),"ACTION_MENU")},cancel:function(){return this.BREAK_TRANSITION}},controller.stateMachine.structure.MOVEPATH_SELECTION={onenter:function(){},action:function(e,t,o){if(0>this.data.selection.getValueAt(t,o))return DEBUG&&util.log("break event because selection is not in the selection map"),this.BREAK_TRANSITION;var n=this.data.target.x,r=this.data.target.y,l=model.distance(n,r,t,o);if(this.data.target.set(t,o),0===l)return"ACTION_MENU";if(1===l){var a=model.moveCodeFromAtoB(n,r,t,o);return controller.stateMachine.data.movePath.addCodeToPath(t,o,a),this.BREAK_TRANSITION}return controller.stateMachine.data.movePath.setPathByRecalculation(t,o),this.BREAK_TRANSITION},cancel:function(){return this.data.target.clean(),this.lastState}},controller.stateMachine.structure.MULTISTEP_IDLE={nextStep:function(){var e=this.data.action.object;return this.data.movePath.clean(),this.data.menu.clean(),e.prepareMenu(this.data),this.data.menu.addEntry("done"),this.data.inMultiStep=!0,this.data.menu.size>1?"ACTION_SUBMENU":"IDLE"}},controller.stateMachine.structure.NONE={start:function(e,t){return model.loadModification(t),"IDLE"}},controller.stateMachine.structure.ACTION_SELECT_TARGET_A={onenter:function(){this.data.targetselection.clean()},action:function(e,t,o){return 0>this.data.selection.getValueAt(t,o)?(DEBUG&&util.log("break event because selection is not in the map"),this.BREAK_TRANSITION):(this.data.targetselection.set(t,o),"FLUSH_ACTION")},cancel:function(){return this.lastState}},controller.stateMachine.structure.ACTION_SELECT_TARGET_B=controller.stateMachine.structure.ACTION_SELECT_TARGET_A,controller.stateMachine.structure.ACTION_SELECT_TILE={onenter:function(){this.data.targetselection.clean()},action:function(e,t,o){return this.data.action.object.isTargetValid(this.data,t,o)?(this.data.targetselection.set(t,o),"FLUSH_ACTION"):this.BREAK_TRANSITION},cancel:function(){return this.data.targetselection.clean(),this.lastState}},controller.mapAction({key:"activatePower",hasSubMenu:!0,condition:function(){var e=model.players[model.turnOwner];return null===e.mainCo?!1:e.coPower_active!==model.INACTIVE_POWER?!1:e.power>=model.coStarCost(model.turnOwner)*e.mainCo.coStars},prepareMenu:function(e){e.action.addEntry("cop",player.power>=model.coStarCost(model.turnOwner)*player.mainCo.coStars),e.action.addEntry("scop",player.power>=model.coStarCost(model.turnOwner)*player.mainCo.scoStars)},invoke:function(e){switch(e.action.selectedSubEntry){case"cop":model.activateCoPower.callAsCommand(model.turnOwner);break;case"scop":model.activateSuperCoPower.callAsCommand(model.turnOwner)}}}),controller.unitAction({key:"attack",unitAction:!0,targetSelectionType:"A",prepareTargets:function(e){model.attackRangeMod_(e.source.unitId,e.target.x,e.target.y,e.selection)},condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);return t!==model.MODE_NONE&&t!==model.MODE_SAME_OBJECT&&t!==model.MODE_OWN?!1:model.day-1<controller.configValue("daysOfPeace")?!1:model.isIndirectUnit(e.source.unitId)&&e.movePath.data.length>0?!1:model.hasTargets(e.source.unitId,e.target.x,e.target.y)},invoke:function(e){model.battleBetween.callAsCommand(e.source.unitId,e.targetselection.unitId,Math.round(100*Math.random()),Math.round(100*Math.random()))}}),controller.propertyAction({key:"buildUnit",propertyAction:!0,hasSubMenu:!0,condition:function(e){var t=controller.configValue("unitLimit");if(t&&model.countUnits(model.turnOwner)>=t)return!1;if(!model.hasFreeUnitSlots(model.turnOwner))return!1;for(var o=e.source.property,n=model.listOfUnitTypes,r=0,l=n.length;l>r;r++)if(model.isBuildableByFactory(o,n[r]))return!0;return!1},prepareMenu:function(e){for(var t=model.players[model.turnOwner].gold,o=e.source.property,n=model.listOfUnitTypes,r=0,l=n.length;l>r;r++){var a=n[r];model.isBuildableByFactory(o,a)&&e.menu.addEntry(a,t>=model.unitTypes[a].cost)}},invoke:function(e){model.buildUnit.callAsCommand(e.source.x,e.source.y,e.action.selectedSubEntry)}}),controller.unitAction({key:"capture",condition:function(e){if(null===e.target.property)return null;var t=e.thereIsUnitToPropertyRelationShip(e.source,e.target);return t!==model.MODE_ENEMY&&t!==model.MODE_NONE?!1:e.target.property.type.points>0&&e.source.unit.type.captures>0},invoke:function(e){model.captureProperty.callAsCommand(e.source.unitId,e.target.propertyId)}}),util.scoped(function(){var e=[500,1e3,2500,5e3,1e4,25e3,5e4];controller.mapAction({key:"transferMoney",hasSubMenu:!0,condition:function(t){var o,n=model.turnOwner;return model.players[n].gold<e[0]?!1:(o=t.target.unit,null===o||o.owner===n?(o=t.target.property,null!==o&&o.owner!==n?!0:!1):!0)},prepareMenu:function(t){for(var o=model.players[model.turnOwner].gold,n=0,r=e.length;r>n;n++)o>=e[n]&&t.menu.addEntry(e[n])},invoke:function(e){var t=null!==e.target.property?e.target.property.owner:e.target.unit.owner;model.transferMoney.callAsCommand(model.turnOwner,t,e.action.selectedSubEntry)}})}),controller.propertyAction({key:"transferProperty",propertyAction:!0,hasSubMenu:!0,condition:function(e){return e.source.property.type.noTransfer?!1:!0},prepareMenu:function(e){for(var t=0,o=CWT_MAX_PLAYER;o>t;t++)t!==model.turnOwner&&model.players[t].team!==CWT_INACTIVE_ID&&e.menu.addEntry(t,!0)},invoke:function(e){model.transferProperty.callAsCommand(e.source.propertyId,e.action.selectedSubEntry)}}),controller.unitAction({key:"transferUnit",hasSubMenu:!0,condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);return t!==model.MODE_NONE&&t!==model.MODE_SAME_OBJECT?!1:model.hasLoadedIds(e.source.unitId)?!1:!0},prepareMenu:function(e){for(var t=0,o=CWT_MAX_PLAYER;o>t;t++)t!==model.turnOwner&&model.players[t].team!==CWT_INACTIVE_ID&&e.menu.addEntry(t,!0)},invoke:function(e){model.transferUnit.callAsCommand(e.source.unitId,e.action.selectedSubEntry)}}),controller.unitAction({key:"hideUnit",condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);if(t!==model.MODE_NONE&&t!==model.MODE_SAME_OBJECT)return!1;var o=e.source.unit;return o.type.stealth?o.hidden?!1:!0:!1},invoke:function(e){model.hideUnit.callAsCommand(e.source.unitId)}}),controller.unitAction({key:"joinUnits",condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);return t!==model.MODE_OWN?!1:model.hasLoadedIds(e.source.unitId)||model.hasLoadedIds(e.target.unitId)?!1:e.source.unit.type===e.target.unit.type&&90>e.target.unit.hp},invoke:function(e){model.joinUnits.callAsCommand(e.source.unitId,e.target.unitId)}}),controller.unitAction({key:"loadUnit",condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);if(t!==model.MODE_OWN)return!1;var o=e.target.unitId;return model.isTransport(o)&&model.canLoad(e.source.unitId,o)},invoke:function(e){model.loadUnitInto.callAsCommand(e.source.unitId,e.target.unitId)}}),controller.mapAction({key:"nextTurn",condition:function(e){var t=e.source.unit;if(null!==t&&t.owner===model.turnOwner&&model.canAct(e.source.unitId))return!1;var o=e.source.property;return null!==o&&o.type.builds?!1:!0},invoke:function(){model.nextTurn.callAsCommand()}}),controller.unitAction({key:"silofire",isTargetValid:function(e,t,o){return model.isValidPosition(t,o)},selectionRange:2,condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);if(t!==model.MODE_SAME_OBJECT&&t!==model.MODE_NONE)return!1;if(!e.target.property)return!1;var o=e.thereIsUnitToPropertyRelationShip(e.source,e.target);if(o!==model.MODE_NONE)return!1;var n=e.target.property.type.rocketsilo;return n===void 0?!1:-1===n.indexOf(e.source.unit.type.ID)?!1:!0},invoke:function(e){model.fireSilo.callAsCommand(e.target.propertyId,e.targetselection.x,e.targetselection.y,2,e.source.unit.owner)}}),controller.unitAction({key:"supplyUnit",condition:function(e){if(!e.source.unit.type.supply)return!1;var t=e.source.unit.owner,o=e.target.x,n=e.target.y;return model.relationShipCheckUnitNeighbours(t,o,n,model.MODE_OWN)},invoke:function(e){model.unitSuppliesNeighbours.callAsCommand(e.source.unitId)}}),controller.unitAction({key:"unhideUnit",condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);return t!==model.MODE_NONE&&t!==model.MODE_SAME_OBJECT?!1:e.source.unit.hidden},invoke:function(e){model.unhideUnit.callAsCommand(e.source.unitId)}}),util.scoped(function(){function e(e,t,o){return model.isValidPosition(e,t)?-1===model.moveCosts(o,model.map[e][t])?!1:0===model.fogData[e][t]?!0:null!==model.unitPosMap[e][t]?!1:!0:void 0}controller.unitAction({key:"unloadUnit",multiStepAction:!0,condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);if(t!==model.MODE_SAME_OBJECT&&t!==model.MODE_NONE)return!1;var o=e.source.unitId;return model.isTransport(o)&&model.hasLoadedIds(o)},prepareMenu:function(e){for(var t=CWT_MAX_UNITS_PER_PLAYER*model.turnOwner,o=t+CWT_MAX_UNITS_PER_PLAYER;o>t;t++){var n=model.units[t];n.owner!==CWT_INACTIVE_ID&&n.loadedIn===e.source.unitId&&e.menu.addEntry(t,!0)}},targetSelectionType:"B",prepareTargets:function(t){var o=t.target.x,n=t.target.y,r=model.moveTypes[model.units[t.action.selectedSubEntry].type.movetype];e(o-1,n,r)&&t.selection.setValueAt(o-1,n,1),e(o+1,n,r)&&t.selection.setValueAt(o+1,n,1),e(o,n-1,r)&&t.selection.setValueAt(o,n-1,1),e(o,n+1,r)&&t.selection.setValueAt(o,n+1,1)},invoke:function(e){e.target.x,e.target.y,model.unloadUnitFrom.callAsCommand(e.source.unitId,e.target.x,e.target.y,e.action.selectedSubEntry,e.targetselection.x,e.targetselection.y)}})}),controller.unitAction({key:"wait",condition:function(e){var t=e.thereIsUnitRelationShip(e.source,e.target);return t!==model.MODE_NONE&&t!==model.MODE_SAME_OBJECT?!1:!0},invoke:function(e){model.markUnitNonActable.callAsCommand(e.source.unitId)}});