function Graph(e){for(var t=[],o=0;o<e.length;o++){t[o]=[];for(var n=0,a=e[o];n<a.length;n++)t[o][n]=new GraphNode(o,n,a[n])}this.input=e,this.nodes=t}function GraphNode(e,t,o){this.data={},this.x=e,this.y=t,this.pos={x:e,y:t},this.type=o}function BinaryHeap(e){this.content=[],this.scoreFunction=e}var GraphNodeType={OPEN:1,WALL:-1};Graph.prototype.toString=function(){for(var e,t,o,n,a="\n",r=this.nodes,l=0,i=r.length;i>l;l++){for(e="",t=r[l],o=0,n=t.length;n>o;o++)e+=t[o].type+" ";a=a+e+"\n"}return a},GraphNode.prototype.toString=function(){return"["+this.x+" "+this.y+"]"},GraphNode.prototype.isWall=function(){return this.type==GraphNodeType.WALL},BinaryHeap.prototype={push:function(e){this.content.push(e),this.sinkDown(this.content.length-1)},pop:function(){var e=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),e},remove:function(e){var t=this.content.indexOf(e),o=this.content.pop();t!==this.content.length-1&&(this.content[t]=o,this.scoreFunction(o)<this.scoreFunction(e)?this.sinkDown(t):this.bubbleUp(t))},size:function(){return this.content.length},rescoreElement:function(e){this.sinkDown(this.content.indexOf(e))},sinkDown:function(e){for(var t=this.content[e];e>0;){var o=(e+1>>1)-1,n=this.content[o];if(!(this.scoreFunction(t)<this.scoreFunction(n)))break;this.content[o]=t,this.content[e]=n,e=o}},bubbleUp:function(e){for(var t=this.content.length,o=this.content[e],n=this.scoreFunction(o);;){var a=e+1<<1,r=a-1,l=null;if(t>r){var i=this.content[r],d=this.scoreFunction(i);n>d&&(l=r)}if(t>a){var s=this.content[a],c=this.scoreFunction(s);(null===l?n:d)>c&&(l=a)}if(null===l)break;this.content[e]=this.content[l],this.content[l]=o,e=l}}};var astar={init:function(e){for(var t=0,o=e.length;o>t;t++)for(var n=0,a=e[t].length;a>n;n++){var r=e[t][n];r.f=0,r.g=0,r.h=0,r.cost=r.type,r.visited=!1,r.closed=!1,r.parent=null}},heap:function(){return new BinaryHeap(function(e){return e.f})},search:function(e,t,o,n,a){astar.init(e),a=a||astar.manhattan,n=!!n;var r=astar.heap();for(r.push(t);r.size()>0;){var l=r.pop();if(l===o){for(var i=l,d=[];i.parent;)d.push(i),i=i.parent;return d.reverse()}l.closed=!0;for(var s=astar.neighbors(e,l,n),c=0,m=s.length;m>c;c++){var u=s[c];if(!u.closed&&!u.isWall()){var _=l.g+u.cost,p=u.visited;(!p||_<u.g)&&(u.visited=!0,u.parent=l,u.h=u.h||a(u.pos,o.pos),u.g=_,u.f=u.g+u.h,p?r.rescoreElement(u):r.push(u))}}}return[]},manhattan:function(e,t){var o=Math.abs(t.x-e.x),n=Math.abs(t.y-e.y);return o+n},neighbors:function(e,t,o){var n=[],a=t.x,r=t.y;return e[a-1]&&e[a-1][r]&&n.push(e[a-1][r]),e[a+1]&&e[a+1][r]&&n.push(e[a+1][r]),e[a]&&e[a][r-1]&&n.push(e[a][r-1]),e[a]&&e[a][r+1]&&n.push(e[a][r+1]),o&&(e[a-1]&&e[a-1][r-1]&&n.push(e[a-1][r-1]),e[a+1]&&e[a+1][r-1]&&n.push(e[a+1][r-1]),e[a-1]&&e[a-1][r+1]&&n.push(e[a-1][r+1]),e[a+1]&&e[a+1][r+1]&&n.push(e[a+1][r+1])),n}},model={},controller={},util={};model.event_eventName=[],model.event_eventIndex={},model.event_eventFirst={},model.event_callbacks={},model.events={},model.event_define=function(e){if(assertStr(e),void 0===model.event_eventIndex[e]){var t=model.event_eventName.length,o=[];model.event_eventName[t]=e,model.event_eventIndex[e]=t,model.event_callbacks[e]=o,model.events[e]=function(){if(model.event_eventFirst[e]&&model.event_eventFirst[e].apply(null,arguments)===!1)return!1;for(var t=0,n=o.length;n>t;t++)if(o[t].apply(null,arguments)===!1)return!1;return!0}}},model.event_firstOn=function(e,t){assertStr(e),assertFn(t),model.event_callbacks[e]||model.event_define(e),model.event_eventFirst[e]=t},model.event_on=function(e,t){if(Array.isArray(e))for(var o=0,n=e.length;n>o;o++)model.event_on(e[o],t);else assertStr(e),assertFn(t),model.event_callbacks[e]||model.event_define(e),model.event_callbacks[e].push(t)};var assert=function(e,t){if(!e)throw"undefined"==typeof t&&(t="FAIL"),console.error&&console.error(t),new Error(t)},assertFn=function(e){assert("function"==typeof e)},assertInt=function(e){assert("number"==typeof e&&0===e%1)},assertIntRange=function(e,t,o){assertInt(e),assert(e>=t&&o>=e)},assertBool=function(e){assert("boolean"==typeof e)},assertStr=function(e){assert("string"==typeof e)},assertList=function(e){assert(Array.isArray(e))},assertDef=function(e){assert("undefined"!=typeof e)},assertUndef=function(e){assert("undefined"==typeof e)},assertNull=function(e){assert(null===e)},assertNotNull=function(e){assert(null!==e)};util.scoped=function(e){return e()},util.wish=function(){return{declined:!1,approve:function(){this.declined=!1},decline:function(){this.declined=!0}}},util.copy=function(e){for(var t={},o=Object.keys(e),n=0,a=o.length;a>n;n++){var r=o[n];t[r]=e[r]}return t},util.isUndefined=function(e){return"undefined"==typeof e},util.isString=function(e){return"string"==typeof e},util.isBoolean=function(e){return"boolean"==typeof e},util.isFunction=function(e){return"function"==typeof e},util.isObject=function(e){return"object"==typeof e},util.isInt=function(e){return"number"==typeof e&&0===e%1},util.intRange=function(e,t,o){return"number"==typeof e&&0===e%1&&e>=t&&o>=e},function(){var e=function(){for(var e=this.__defValue__,t=this.__length__,o="function"==typeof e,n=0,a=t;a>n;n++)this[n]=o?e(n,this[n]):e},t=function(e){var t=this.__length__,o=e.__length__;if(o=e.length,o!==t)throw Error("source and target list have different lengths");for(var n=0,a=t;a>n;n++)e[n]=this[n]},o=function(e){var t=this.__length__,o=e.__length__;if(o=e.length,o!==t)throw Error("source and target list have different lengths");for(var n=0,a=t;a>n;n++)this[n]=e[n]};util.list=function(n,a){void 0===a&&(a=null);var r=[];return r.__defValue__=a,r.__length__=n,r.resetValues=e,r.cloneValues=t,r.grabValues=o,r.resetValues(),r}}(),util.error=function(e,t,o){console.log("%cCW:T ERROR","color:red;"),console.log("%c .ERROR_ID:"+e,"color:red;"),console.log("%c .DATA:"+t,"color:red;"),console.log("%c .STACK:"+o,"color:red;")},util.log=function(e){arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),console.log(e)},function(){var e=function(){for(var e=this.__defValue__,t=this.__width__,o=this.__height__,n="function"==typeof e,a=0,r=t;r>a;a++)for(var l=0,i=o;i>l;l++)this[a][l]=n?e(a,l,this[a][l]):e},t=function(e){var t=this.__width__,o=this.__height__;if(e.length!==this.length)throw Error();for(var n=0,a=t;a>n;n++)for(var r=0,l=o;l>r;r++)e[n][r]=this[n][r]};util.matrix=function(o,n,a){void 0===a&&(a=null);var r=[];r.__defValue__=a,r.__width__=o,r.__height__=n,r.resetValues=e,r.cloneValues=t;for(var l=0;o>l;l++)r[l]=[];return r.resetValues(),r}}(),util.createRingBuffer=function(e,t){var o={push:function(e){if(null!==this._data[this._wInd])throw Error("message buffer is full");this._data[this._wInd]=e,this._wInd++,this._wInd===this._size&&(this._wInd=0)},isEmpty:function(){return null===this._data[this._rInd]},pop:function(){if(null===this._data[this._rInd])throw Error("message buffer is empty");var e=this._data[this._rInd];return this._data[this._rInd]=null,this._rInd++,this._rInd===this._size&&(this._rInd=0),e},clear:function(){this._rInd=0,this._wInd=0;for(var t=0;e>t;t++)this._data[t]=null}};return o._rInd=0,o._wInd=0,o._data=util.list(e,t?t:null),o._size=e,o},function(){function e(e,t,o){var n=this.data.length,a=e,r=t;for(e=0;n>e;e++)for(t=0;n>t;t++)this.data[e][t]=o;this.centerX=Math.max(0,a-(n-1)),this.centerY=Math.max(0,r-(n-1))}function t(e,t){var o=this.data,n=this.centerX,a=this.centerY,r=o.length;return e-=a,t-=n,0>e||0>t||e>=r||t>=r?-1:o[e][t]}function o(e,t,o){var n=this.data,a=this.centerX,r=this.centerY,l=n.length;e-=r,t-=a,0>e||0>t||e>=l||t>=l?model.criticalError(error.ILLEGAL_PARAMETERS,error.SELECTION_DATA_OUT_OF_BOUNDS):n[e][t]=o}function n(e){if(this.data.length!==e.data.length)throw Error("illegal grab selection");this.centerX=e.centerX,this.centerY=e.centerY;var t=this.data.length;for(x=0;t>x;x++)for(y=0;t>y;y++)this.data[x][y]=e.data[x][y]}function a(e,t,o,n,a,r){var l=this.data,i=this.centerX,d=this.centerY,s=l.length;e-=d,t-=i,(0>e||0>t||e>=s||t>=s)&&(n?(e=s-1,t=s-1):(e=0,t=0));var c=n?-1:1;for(t+=c;n?e>=0:s>e;e+=c){for(;n?t>=0:s>t;t+=c)if(l[e][t]>=o)return a(e,t,r),void 0;t=n?s-1:0}}function r(e,t,o){void 0===o&&(o=0);var n,a,r=this.data.length,l=parseInt(Math.random()*r,10);for(n=0;r>n;n++)for(a=0;r>a;a++)if(this.data[n][a]>=o&&(l--,0>l))return e(n,a,t),!0;return!1}util.selectionMap=function(l){var i={};return i.centerX=0,i.centerY=0,i.data=util.matrix(l,l,-1),i.nextValidPosition=a,i.nextRandomPosition=r,i.setValueAt=o,i.getValueAt=t,i.setCenter=e,i.grab=n,i}}(),function(){function e(){return i}function t(){return d}function o(){null!==this.history&&this.history&&this.history.splice(0)}function n(){this.state=s,this.lastState=null,this.clearHistory()}function a(e){var t=this.structure[this.state][e];if(void 0===t)return this.onerror(e,this.state,"N/A","NO EVENT"),void 0;var o=t.apply(this,arguments);if(o||this.onerror(e,this.state,o,r.STM_INVALID_NEXT_STATE),o===d&&"actionState"===e)return this.onerror(e,this.state,o,"BREAKS TRANSITION"),void 0;if(o!==d){var n=o===this.backToLastState();n&&(null===this.history&&this.onerror(e,this.state,o,"NO HISTORY GIVEN"),1===this.history.length?o="IDLE":(this.history.pop(),o=this.history[this.history.length-1]));var a=this.structure[o],l=this.state;if(this.state=o,!a)return this.state=l,this.onerror(e,this.state,o,"NO NEXT STATE"),void 0;if(a.onenter){var i=a.onenter.apply(this,arguments);if(i===d)return this.state=l,void 0}null===this.history||n||this.history.push(this.state),void 0!==a.actionState&&this.event.call(this,"actionState")}}function r(e,t,o,n){util.log("state machine error (code:",n,"ev:",e,"from:",t,"to:",o,")")}function l(l,i){var d={};return d.structure=l?l:{},d.state=s,d.lastState=null,d.history=i&&!i.noHistory?null:[],d.reset=n,d.event=a,d.clearHistory=o,d.backToLastState=e,d.breakTransition=t,d.onerror=i&&i.onerror?i.onerror:r,d}var i="$_LAST_STATE",d="$_BREAK_TRANSITION",s="NONE";util.stateMachine=l}(),controller.action_objects={},controller.action_define_=function(e){e.hasOwnProperty("condition")||(e.condition=null),assert(e.hasOwnProperty("key")),assert(e.hasOwnProperty("invoke")),assert(!controller.action_objects.hasOwnProperty(e.key)),e.hasOwnProperty("prepareMenu")||(e.prepareMenu=null),e.hasOwnProperty("prepareTargets")||(e.prepareTargets=null),e.hasOwnProperty("prepareSelection")||(e.prepareSelection=null),e.hasOwnProperty("isTargetValid")||(e.isTargetValid=null),e.hasOwnProperty("multiStepAction")||(e.multiStepAction=!1),null===e.prepareTargets||e.hasOwnProperty("targetSelectionType")||(e.targetSelectionType="A"),assert(null===e.prepareTargets||null===e.isTargetValid),controller.action_objects[e.key]=e,e.noImplictEvents||(model.event_define(e.key+"_check"),model.event_define(e.key+"_invoked"))},controller.action_unitAction=function(e){e.mapAction=!1,e.clientAction=!1,e.unitAction=!0,e.propertyAction=!1,controller.action_define_(e)},controller.action_propertyAction=function(e){e.mapAction=!1,e.clientAction=!1,e.unitAction=!1,e.propertyAction=!0,controller.action_define_(e)},controller.action_mapAction=function(e){e.mapAction=!0,e.clientAction=!1,e.unitAction=!1,e.propertyAction=!1,controller.action_define_(e)},controller.action_clientAction=function(e){e.mapAction=!1,e.clientAction=!0,e.unitAction=!1,e.propertyAction=!1,controller.action_define_(e)},controller.actionBuilder_buildFromUserData=function(e){e||(e=controller.stateMachine.data);var t=e.target,o=e.source,n=e.action,a=e.movePath,r=n.object,l=!1;return-1!==a.data[0]&&(l=model.move_trapCheck(a.data,o,t),model.events.move_flushMoveData(a.data,o)),l?controller.commandStack_sharedInvokement("trapwait_invoked",o.unitId):r.invoke(e),(l||r.unitAction&&!r.noAutoWait)&&controller.commandStack_sharedInvokement("wait_invoked",o.unitId),l},controller.commandStack_curReadPos=0,controller.commandStack_curWritePos=0,controller.commandStack_buffer_=util.list(1400,-1),controller.commandStack_resetData=function(){controller.commandStack_buffer_.resetValues(),controller.commandStack_curReadPos=0,controller.commandStack_curWritePos=0},controller.commandStack_hasData=function(){return controller.commandStack_curReadPos!==controller.commandStack_curWritePos},controller.commandStack_invokeNext=function(){assert(controller.commandStack_hasData());var e=7*controller.commandStack_curReadPos,t=controller.commandStack_buffer_,o=model.event_eventName[t[e]];model.events[o](t[e+1],t[e+2],t[e+3],t[e+4],t[e+5],t[e+6]),t[e]=-1,controller.commandStack_curReadPos++,controller.commandStack_curReadPos>=200&&(controller.commandStack_curReadPos=0)},controller.commandStack_localInvokement=function(e){assertStr(e),assertIntRange(arguments.length,1,7);var t=7*controller.commandStack_curWritePos,o=0,n=7;for(assert(-1===controller.commandStack_buffer_[o+t]),controller.commandStack_buffer_[o+t]=model.event_eventIndex[e],o++;n>o;)controller.commandStack_buffer_[o+t]=arguments.length>o?arguments[o]:-1,o++;controller.commandStack_curWritePos++,controller.commandStack_curWritePos>=200&&(controller.commandStack_curWritePos=0)},controller.commandStack_sharedInvokement=function(){controller.isNetworkGame()&&controller.sendNetworkMessage(JSON.stringify(arguments)),controller.commandStack_localInvokement.apply(this,arguments)},controller.configBoundaries_={},controller.defineGameConfig=function(e,t,o,n,a){(!e||controller.configBoundaries_.hasOwnProperty(e))&&model.criticalError(error.ILLEGAL_PARAMETERS,error.ILLEGAL_CONFIG_VAR_DEFINTION),(t>o||t>n||n>o)&&model.criticalError(error.ILLEGAL_PARAMETERS,error.ILLEGAL_CONFIG_VAR_DEFINTION),controller.configBoundaries_[e]={min:t,max:o,defaultValue:n,step:"number"==typeof a?a:1}},controller.buildRoundConfig=function(e){for(var t=controller.configBoundaries_,o=Object.keys(t),n=0,a=o.length;a>n;n++){var r,l=o[n];e&&e.hasOwnProperty(l)?(r=e[l],r<t[l].min&&assert(!1,l,"is greater than it's minimum value"),r>t[l].max&&assert(!1,l,"is greater than it's maximum value"),t[l].hasOwnProperty("step")&&0!==r%t[l].step&&assert(!1,l,"is does not fits one of it's possible values")):r=t[l].defaultValue,model.cfg_configuration[l]=r}},controller.configValue=function(e){return model.cfg_configuration[e]},model.modification_load=function(e){model.data_addEngineTypeSheets(),model.data_tileParser.parseAll(e.tiles),model.data_weatherParser.parseAll(e.weathers),model.data_movetypeParser.parseAll(e.movetypes),model.data_unitParser.parseAll(e.units),model.data_fractionParser.parseAll(e.fraction),model.data_gameModeParser.parseAll(e.gamemode),model.data_coParser.parseAll(e.co),model.data_language=e.language,model.data_graphics=e.graphics,model.data_sounds=e.sounds,model.data_header=e.header,model.data_assets=e.assets,model.data_menu=e.menu,model.data_maps=e.maps,model.data_tips=e.tips,model.data_globalRules=e.globalrules,model.events.modification_loaded()},util.scoped(function(){function e(e){return function(){assert(!1,"client has to implement interface "+e)}}controller.isNetworkGame=e("controller.isNetworkGame"),controller.isHost=e("controller.isHost"),controller.parseNetworkMessage=e("controller.parseNetworkMessage"),controller.sendNetworkMessage=e("controller.sendNetworkMessage")}),model.event_define("prepare_game"),model.event_define("load_game"),model.event_define("save_game"),controller.persistence_saveModel=function(){var e={};return model.events.save_game(e),JSON.stringify(e)},controller.persistence_prepareModel=function(e){model.events.prepare_game(e)},controller.persistence_loadModel=function(e){model.events.load_game(e)},controller.roundConfig_CHANGE_TYPE={CO_MAIN:0,CO_SIDE:1,CO_TYPE:2,PLAYER_TYPE:3,TEAM:4},controller.roundConfig_coSelected=util.list(4,-1),controller.roundConfig_typeSelected=util.list(4,-1),controller.roundConfig_teamSelected=util.list(4,0),controller.roundConfig_prepare=function(){controller.roundConfig_coSelected.resetValues(),controller.roundConfig_typeSelected.resetValues(),controller.roundConfig_teamSelected.resetValues();for(var e=0,t=4;t>e;e++)model.player_data[e].team>-1?(controller.roundConfig_typeSelected[e]=0===e?0:1,controller.roundConfig_teamSelected[e]=e):controller.roundConfig_typeSelected[e]=-2},controller.roundConfig_evalAfterwards=function(){var e;controller.ai_reset(),model.events.client_deregisterPlayers();for(var t=!0,o=0,n=4;n>o;o++)if(0===controller.roundConfig_typeSelected[o]){t=!1;break}for(var o=0,n=4;n>o;o++)if(controller.roundConfig_typeSelected[o]>=0)model.player_data[o].gold=0,model.player_data[o].team=controller.roundConfig_teamSelected[o],1===controller.roundConfig_typeSelected[o]?(controller.ai_register(o),t&&model.events.client_registerPlayer(o)):model.events.client_registerPlayer(o),e=-1!==controller.roundConfig_coSelected[o]?model.data_coTypes[controller.roundConfig_coSelected[o]]:null,model.events.setMainCo(o,e);else{model.player_data[o].team=-1;for(var a=model.unit_firstUnitId(o),r=model.unit_lastUnitId(o);r>=a;a++){var l=model.unit_data[a];l&&(model.unit_posData[l.x][l.y]=null,model.unit_data[a].owner=-1)}for(var i=0,d=model.property_data.length;d>i;i++){var s=model.property_data[i];s&&s.owner===o&&(s.owner=-1)}}},controller.roundConfig_changeConfig=function(e,t,o){switch(assert(t>=controller.roundConfig_CHANGE_TYPE.CO_MAIN&&t<=controller.roundConfig_CHANGE_TYPE.TEAM),t){case controller.roundConfig_CHANGE_TYPE.CO_MAIN:var n=controller.roundConfig_coSelected[e];o?(n--,-1>n&&(n=model.data_coTypes.length-1)):(n++,n>=model.data_coTypes.length&&(n=-1)),controller.roundConfig_coSelected[e]=n;break;case controller.roundConfig_CHANGE_TYPE.CO_SIDE:assert(!1,"not supported yet");break;case controller.roundConfig_CHANGE_TYPE.CO_TYPE:assert(!1,"not supported yet");break;case controller.roundConfig_CHANGE_TYPE.PLAYER_TYPE:var n=controller.roundConfig_typeSelected[e];if(-2===n)break;o?(n--,-1>n&&(n=1)):(n++,n>=2&&(n=-1)),controller.roundConfig_typeSelected[e]=n;break;case controller.roundConfig_CHANGE_TYPE.TEAM:for(var n=controller.roundConfig_teamSelected[e];;){o?(n--,0>n&&(n=3)):(n++,n>=4&&(n=0));for(var a=!1,r=0,l=4;l>r;r++)r!==e&&controller.roundConfig_typeSelected[r]>=0&&controller.roundConfig_teamSelected[r]!==n&&(a=!0);if(a)break}controller.roundConfig_teamSelected[e]=n}},controller.script_DESCRITORS={MOVE_TYPE:0,TILE_TYPE:1,PROP_TYPE:2,UNIT_TYPE:3,ATTACK_TYPE:4,__TARGET_START__:20,TARGET_MOVE_TYPE:20,TARGET_TILE_TYPE:21,TARGET_PROP_TYPE:22,TARGET_UNIT_TYPE:23,TARGET_ATTACK_TYPE:24,__END_MARKER__:24},controller.script_VALUES={DIRECT:0,INDIRECT:1,BALLISTIC:2,NONE:-1},controller.script_memory_=util.list(controller.script_DESCRITORS.__END_MARKER__,-1),controller.scriptBoundaries_={},controller.defineGameScriptable=function(e,t,o){(!e||controller.scriptBoundaries_.hasOwnProperty(e)||t>o)&&model.criticalError(error.ILLEGAL_PARAMETERS,error.ILLEGAL_CONFIG_VAR_DEFINTION),controller.scriptBoundaries_[e]=[t,o]},function(){function e(e,t){var o;if(t){if(o=controller.script_VALUES[e],void 0!==o)return o;for(var n=2;n>=0;n--){switch(n){case 0:o=model.data_unitSheets[e];break;case 1:o=model.data_tileSheets[e];break;case 2:o=model.data_movetypeSheets[e]}if(o)return o.__sheetIndex__}}else o=controller.script_DESCRITORS[e];return assert(void 0!==o,"unknown script string mapping"),o}controller.script_parseRule=function(t){for(var o=0,n=t.length;n>o;o++){var a=t[o];if("undefined"!=typeof a.$when){var r=a.$when;assert(0===r.length%2,"when block length must be odd");for(var l=0,i=r.length;i>l;l+=2){assertStr(r[l]),r[l]=e(r[l],!1);for(var d=0,s=r[l+1].length;s>d;d++)"string"==typeof r[l+1][d]&&(r[l+1][d]=e(r[l+1][d],!0))}}}return t}}(),function(){function e(e,t,o,n){controller.scriptTags;var a=controller.script_memory_,r=controller.script_DESCRITORS,l=controller.script_VALUES,i=o>-1?model.unit_data[o]:model.unit_posData[e][t];if(i){var d=model.battle_isIndirectUnit(o>-1?o:model.unit_extractId(i));a[n+r.UNIT_TYPE]=i.type.__sheetIndex__,a[n+r.ATTACK_TYPE]=d?l.INDIRECT:l.DIRECT,a[n+r.MOVE_TYPE]=model.data_movetypeSheets[i.type.movetype].__sheetIndex__}a[n+r.TILE_TYPE]=model.map_data[e][t].__sheetIndex__;var s=model.property_posMap[e][t];s&&(a[n+r.PROP_TYPE]=s.type.__sheetIndex__)}controller.prepareTags=function(t,o,n,a,r,l){e(t,o,n,0),arguments.length>3&&e(a,r,l,controller.script_DESCRITORS.__TARGET_START__)}}(),function(){var e=function(e,t,o,n){if(!e)return n;for(var a=0,r=e.length;r>a;a++){var l=e[a];if(null!==l){var i=l[o];if("number"==typeof i){var d=!0,s=l.$when;if(s)for(var c=0,m=s.length;m>c;c+=2){var u=t[s[c]],_=s[c+1],p=!1;if(_[0]===!0)u>=_[1]&&u<=_[2]&&(p=!0);else for(var f=0,v=_.length;v>f;f++)if(u===_[f]){p=!0;break}if(!p){d=!1;break}}d&&(l.$set&&(n=0),n+=i)}}}return n};controller.scriptedValue=function(t,o,n){assert(util.isInt(n));var a=controller.script_memory_;n=e(model.data_globalRules,a,o,n);var r=model.co_data[t].coA,l=!0;r&&(n=e(r.d2d,a,o,n),l=0===e(r.d2d,a,"neutralizeWeather",0),model.co_data[t].level>=model.co_POWER_LEVEL.COP&&(model.co_data[t].level===model.co_POWER_LEVEL.COP?n=e(r.cop.turn,a,o,n):model.co_data[t].level===model.co_POWER_LEVEL.SCOP&&(n=e(r.scop.turn,a,o,n))));var i=model.weather_data;l&&i&&(n=e(i.rules,a,o,n));var d=controller.scriptBoundaries_[o];return n<d[0]?n=d[0]:n>d[1]&&(n=d[1]),n}}(),controller.scriptedValueByRules=function(){console.log("::WARNING:: this should not be used! ::WARNING::")},controller.TaggedPosition={clean:function(){this.x=-1,this.y=-1,this.unit=null,this.unitId=-1,this.property=null,this.propertyId=-1},grab:function(e){this.x=e.x,this.y=e.y,this.unit=e.unit,this.unitId=e.unitId,this.property=e.property,this.propertyId=e.propertyId},set:function(e,t){this.x=e,this.y=t;var o,n=-1!==e&&-1!==t,a=n?0===model.fog_turnOwnerData[e][t]:!1;o=n?model.unit_getByPos(e,t):null,!n||a||null===o||o.hidden&&o.owner!==model.round_turnOwner&&model.player_data[o.owner].team!==model.player_data[model.round_turnOwner].team?(this.unit=null,this.unitId=-1):(this.unit=o,this.unitId=model.unit_extractId(o)),o=n?model.property_getByPos(e,t):null,n&&null!==o?(this.property=o,this.propertyId=model.property_extractId(o)):(this.property=null,this.propertyId=-1)}},controller.stateMachine=util.stateMachine({NONE:{start:function(){return"IDLE"}},IDLE:{onenter:function(){this.data.menu.clean(),this.data.movePath.clean(),this.data.action.selectedEntry=null,this.data.action.selectedSubEntry=null,this.data.action.object=null,this.clearHistory(),this.data.inMultiStep=!1,this.data.makeMultistep=!0,this.data.source.clean(),this.data.target.clean(),this.data.targetselection.clean()},action:function(e,t,o){return this.data.source.set(t,o),-1!==this.data.source.unitId&&this.data.source.unit.owner===model.round_turnOwner&&model.actions_canAct(this.data.source.unitId)?(this.data.target.set(t,o),this.data.movePath.clean(),this.data.movePath.move_fillMoveMap(),this.data.selection.getValueAt(t-1,o)<0&&this.data.selection.getValueAt(t+1,o)<0&&this.data.selection.getValueAt(t,o-1)<0&&this.data.selection.getValueAt(t,o+1)<0?(this.data.target.set(t,o),"ACTION_MENU"):"MOVEPATH_SELECTION"):(this.data.target.set(t,o),"ACTION_MENU")},cancel:function(){return this.breakTransition()}},MOVEPATH_SELECTION:{onenter:function(){},action:function(e,t,o){if(this.data.selection.getValueAt(t,o)<0)return this.breakTransition();var n=this.data.target.x,a=this.data.target.y,r=model.map_getDistance(n,a,t,o);if(this.data.target.set(t,o),0===r)return"ACTION_MENU";if(1===r){var l=model.move_codeFromAtoB(n,a,t,o);return controller.stateMachine.data.movePath.addCodeToPath(t,o,l),this.breakTransition()}return controller.stateMachine.data.movePath.setPathByRecalculation(t,o),this.breakTransition()},cancel:function(){return this.data.target.clean(),this.backToLastState()}},ACTION_MENU:{onenter:function(){return this.data.menu.clean(),this.data.menu.generate(),0===this.data.menu.size?this.breakTransition():void 0},action:function(e,t){var o=this.data.menu.data[t],n=controller.action_objects[o];return this.data.action.selectedEntry=o,this.data.action.object=n,null!==n.prepareMenu?"ACTION_SUBMENU":null!==n.isTargetValid?"ACTION_SELECT_TILE":null!==n.prepareTargets&&"A"===n.targetSelectionType?this.data.selection.prepare():"FLUSH_ACTION"},cancel:function(){return this.data.target.grab(this.data.source),this.backToLastState()}},ACTION_SUBMENU:{onenter:function(){this.data.inMultiStep||(this.data.menu.clean(),this.data.action.object.prepareMenu(this.data),0===this.data.menu.size&&assert(!1,"sub menu cannot be empty"))},action:function(e,t){if(!this.data.menu.enabled[t])return this.breakTransition();var o=this.data.menu.data[t];return"done"===o?"IDLE":(this.data.action.selectedSubEntry=o,null!==this.data.action.object.prepareTargets&&"B"===this.data.action.object.targetSelectionType?this.data.selection.prepare():"FLUSH_ACTION")},cancel:function(){return this.data.inMultiStep?this.backToLastState():(this.data.menu.clean(),this.data.menu.generate(),this.backToLastState())}},ACTION_SELECT_TARGET_A:{onenter:function(){this.data.targetselection.clean()},action:function(e,t,o){return this.data.selection.getValueAt(t,o)<0?this.breakTransition():(this.data.targetselection.set(t,o),"FLUSH_ACTION")},cancel:function(){return this.backToLastState()}},ACTION_SELECT_TARGET_B:{onenter:function(){this.data.targetselection.clean()},action:function(e,t,o){return this.data.selection.getValueAt(t,o)<0?this.breakTransition():(this.data.targetselection.set(t,o),"FLUSH_ACTION")},cancel:function(){return this.backToLastState()}},ACTION_SELECT_TILE:{onenter:function(){this.data.targetselection.clean();var e=this.data.action.object.prepareSelection;e?e(this.data):this.data.selectionRange=1},action:function(e,t,o){return this.data.action.object.isTargetValid(this.data,t,o)?(this.data.targetselection.set(t,o),"FLUSH_ACTION"):this.breakTransition()},cancel:function(){return this.data.targetselection.clean(),this.backToLastState()}},FLUSH_ACTION:{actionState:function(){var e=controller.actionBuilder_buildFromUserData();return!e&&this.data.action.object.multiStepAction?(this.data.breakMultiStep=!1,controller.commandStack_localInvokement("multistep_next"),"MULTISTEP_IDLE"):"IDLE"}},MULTISTEP_IDLE:{nextStep:function(){var e=this.data.action.object;return this.data.movePath.clean(),this.data.menu.clean(),e.prepareMenu(this.data),this.data.menu.addEntry("done"),this.data.inMultiStep=!0,this.data.menu.size>1?"ACTION_SUBMENU":"IDLE"},nextStepBreak:function(){return"IDLE"}}}),controller.stateMachine.data={source:Object.create(controller.TaggedPosition),target:Object.create(controller.TaggedPosition),targetselection:Object.create(controller.TaggedPosition),thereIsUnitRelationShip:function(e,t){return e.unit&&e.unit===t.unit?model.player_RELATION_MODES.SAME_OBJECT:model.player_getRelationship(null!==e.unit?e.unit.owner:-1,null!==t.unit?t.unit.owner:-1)},thereIsUnitToPropertyRelationShip:function(e,t){return model.player_getRelationship(null!==e.unit?e.unit.owner:-1,null!==t.property?t.property.owner:null)},action:{selectedEntry:null,selectedSubEntry:null,object:null},movePath:{data:util.scoped(function(){var e=util.list(15,-1);return e.getLastCode=function(){for(var e=this.length-1;e>0;e--)if(-1!==this[e])return this[e];return-1},e.getSize=function(){for(var e=this.length-1;e>0;e--)if(-1!==this[e])return e+1;return 0},e}),clean:function(){this.data.resetValues()},clone:function(){for(var e=[],t=0,o=this.data.length;o>t&&-1!==this.data[t];t++)e[t]=this.data[t];return e},addCodeToPath:function(e,t,o){var n=model.move_addCodeToPath(o,this.data);n||this.setPathByRecalculation(e,t)},setPathByRecalculation:function(e,t){var o=controller.stateMachine.data,n=o.source,a=o.selection,r=o.movePath.data;this.data.resetValues(),model.move_generatePath(n.x,n.y,e,t,a,r)},move_fillMoveMap:function(e,t,o){var n=controller.stateMachine.data;model.move_fillMoveMap(n.source,n.selection,e,t,o)}},menu:{data:util.list(20,null),enabled:util.list(20,!0),size:0,addEntry:function(e,t){assert(this.size<this.data.length),this.data[this.size]=e,"undefined"==typeof t&&(t=!0),this.enabled[this.size]=t===!0,this.size++},clean:function(){this.size=0},generate:util.scoped(function(){var e;return function(){e||(e=Object.keys(controller.action_objects));var t,o,n=controller.stateMachine.data,a=!1,r=!0,l=n.source.property,i=!0,d=n.source.unit,s=n.thereIsUnitRelationShip(n.source,n.target),c=n.thereIsUnitRelationShip(n.source,n.targetselection),m=n.thereIsUnitToPropertyRelationShip(n.source,n.target),u=n.thereIsUnitToPropertyRelationShip(n.source,n.targetselection);null===d||d.owner!==model.round_turnOwner?i=!1:model.actions_canAct(n.source.unitId)||(i=!1),null!==d&&(r=!1),(null===l||l.owner!==model.round_turnOwner||l.type.blocker)&&(r=!1),i||r||(a=!0);for(var _=0,p=e.length;p>_;_++){var f=controller.action_objects[e[_]];if(f.clientAction||model.client_isLocalPid(model.round_turnOwner)&&controller.ai_isHuman(model.round_turnOwner)){if(f.unitAction){if(!i)continue;if(f.relation){t=null,"S"===f.relation[0]&&"T"===f.relation[1]?t=s:"S"===f.relation[0]&&"ST"===f.relation[1]&&(t=c),o=!1;for(var v=2,h=f.relation.length;h>v;v++)f.relation[v]===t&&(o=!0);if(!o)continue}if(f.relationToProp){t=null,"S"===f.relation[0]&&"T"===f.relationToProp[1]?t=m:"S"===f.relation[0]&&"ST"===f.relationToProp[1]&&(t=u),o=!1;for(var v=2,h=f.relationToProp.length;h>v;v++)f.relationToProp[v]===t&&(o=!0);if(!o)continue}}else{if(f.propertyAction&&!r)continue;if(f.mapAction===!0&&!a)continue;if(f.clientAction===!0&&!a)continue}f.condition&&f.condition(n)!==!1&&n.menu.addEntry(e[_])}}}})},selection:util.scoped(function(){var e=util.selectionMap(61);return e.prepare=function(){var e=controller.stateMachine.data.target,t=e.x,o=e.y;this.setCenter(t,o,-1);var n=controller.stateMachine.data.action.object;return n.prepareTargets(controller.stateMachine.data),"A"===n.targetSelectionType?"ACTION_SELECT_TARGET_A":"ACTION_SELECT_TARGET_B"},e.rerenderNonInactive=function(){var e=this.data.length,t=this.centerX,o=this.centerY;for(x=0;e>x;x++)for(y=0;e>y;y++)this.data[x+t][y+o]>-1&&view.redraw_markPos(x+t,y+o)},e}),selectionRange:-1,inMultiStep:!1,breakMultiStep:!1},controller.ai_spec="DumbBoyv.0.1Alpha",controller.ai_SCORE={LOW:100,NORMAL:200,HIGH:300,CRITICAL:999},controller.ai_CHECKS=[],controller.ai_data=util.list(4,function(){return{pid:-1}}),controller.ai_loopHolder_={i:-1,e:-1,prop:-1,score:-1},controller.ai_scoreDataHolder_={source:Object.create(controller.TaggedPosition),target:Object.create(controller.TaggedPosition),targetselection:Object.create(controller.TaggedPosition),selection:util.selectionMap(61),move:util.list(15,-1),action:{selectedSubEntry:""},cacheInt:0},controller.ai_actionDataHolder_={source:Object.create(controller.TaggedPosition),target:Object.create(controller.TaggedPosition),targetselection:Object.create(controller.TaggedPosition),selection:util.selectionMap(61),used:!1,move:util.list(15,-1),check_index:-1,endsAiTurn:!1,action:{selectedSubEntry:""},cacheInt:0},controller.ai_reset=function(){for(var e=0,t=4;t>e;e++)controller.ai_data[e].pid=-1},controller.ai_active=null,controller.ai_defineRoutine=function(e){assert(util.isString(e.key)),assert(!controller.ai_CHECKS.hasOwnProperty(e.key)),assert(util.isFunction(e.scoring)),assert(util.isFunction(e.prepare)),controller.ai_CHECKS.push(e)},controller.ai_getRoutine=function(e){assert(util.isString(e));for(var t=0,o=controller.ai_CHECKS.length;o>t;){if(controller.ai_CHECKS[t].key===e)return controller.ai_CHECKS[t];t++}return null},controller.ai_register=function(e){assert(model.player_isValidPid(e));for(var t=0;t<controller.ai_data.length;t++)if(-1===controller.ai_data[t].pid)return controller.ai_data[t].pid=e,void 0},controller.ai_deregister=function(e){for(var t=0;t<controller.ai_data.length;t++)if(controller.ai_data[t].pid===e)return controller.ai_data[t].pid=-1,void 0;assert(!1,"player isn't ai controlled")},controller.ai_isHuman=function(e){for(var t=controller.ai_data.length-1;t>=0;t--)if(controller.ai_data[t].pid===e)return!1;return!0},controller.ai_machine=util.stateMachine({IDLE:{tick:function(){util.log(controller.ai_spec,"- doing step in idle state"),assert(!controller.ai_active);
for(var e=controller.ai_data.length-1;e>=0;e--)controller.ai_data[e].pid===model.round_turnOwner&&(controller.ai_active=controller.ai_data[e]);return assert(controller.ai_active),"SET_UP_AI_TURN"}},SET_UP_AI_TURN:{tick:function(){return util.log(controller.ai_spec,"- setup turn"),"PHASE_PREPARE_SEARCH_TASKS"}},PHASE_PREPARE_SEARCH_TASKS:{tick:function(){util.log(controller.ai_spec,"- prepare search unit tasks");var e=controller.ai_loopHolder_;return e.i=model.unit_firstUnitId(model.round_turnOwner),e.e=model.unit_lastUnitId(model.round_turnOwner)+300+1,e.prop=e.i+50,e.score=-1,"PHASE_SEARCH_TASK"}},PHASE_SEARCH_TASK:{tick:function(){util.log(controller.ai_spec,"- search task");for(var e=controller.ai_loopHolder_,t=controller.ai_scoreDataHolder_,o=controller.ai_actionDataHolder_;;){t.source.set(-1,-1),t.target.set(-1,-1),t.targetselection.set(-1,-1),t.selection.setCenter(0,0,-1),t.used=!1,t.selectedSubEntry="",t.cacheInt=-1;var n=-1;if(e.i<e.e)if(e.i<e.prop){var a=model.unit_data[e.i];-1!==a.owner&&-1===a.loadedIn&&model.actions_canAct(e.i)&&(n=0,t.source.set(a.x,a.y),model.move_fillMoveMap(t.source,t.selection))}else{var r=model.property_data[e.i-e.prop];r.owner===controller.ai_active.pid&&(n=1,t.source.set(r.x,r.y))}else n=2;var l=-1,i=0,d=controller.ai_CHECKS.length;if(-1!==n)for(;d>i;){var s=controller.ai_CHECKS[i];i++,0!==n&&s.unitAction||1!==n&&s.propAction||2!==n&&s.mapAction||(l=s.scoring(t,e.score),l>e.score&&(o.source.grab(t.source),o.target.grab(t.target),o.targetselection.grab(t.targetselection),o.selection.grab(t.selection),o.used=!0,o.check_index=i-1,o.endsAiTurn=s.endsAiTurn===!0,o.cacheInt=t.cacheInt,o.move.grabValues(t.move),e.score=l,o.action.selectedSubEntry=t.action.selectedSubEntry))}if(e.i++,-1!==n&&-1!==l||e.i>e.e)break}return e.i<=e.e?"PHASE_SEARCH_TASK":"PHASE_FLUSH_TASK"}},PHASE_FLUSH_TASK:{tick:function(){util.log(controller.ai_spec,"- flush most important command");var e=controller.ai_actionDataHolder_;if(e.used){var t=controller.ai_CHECKS[e.check_index];return t.prepare(e),e.endsAiTurn===!0?"TEAR_DOWN_AI_TURN":"PHASE_PREPARE_SEARCH_TASKS"}throw Error("at least one action must explicit ending AI turn")}},TEAR_DOWN_AI_TURN:{tick:function(){return util.log(controller.ai_spec,"- tear down turn"),controller.ai_active=null,controller.action_objects.nextTurn.invoke(),"IDLE"}}}),controller.ai_machine.state="IDLE",controller.update_inGameRound=!1,controller.update_tickFrame=function(e){assert(controller.update_inGameRound),model.events.gameround_update(e),controller.commandStack_hasData()?controller.commandStack_invokeNext():controller.ai_active&&controller.ai_machine.event("tick")},controller.update_prepareGameRound=function(){controller.commandStack_resetData()},controller.update_startGameRound=function(){assert(!controller.update_inGameRound),controller.update_inGameRound=!0,-1===model.round_turnOwner&&(model.events.gameround_start(),controller.commandStack_localInvokement("nextTurn_invoked"),controller.isHost()&&model.events.weather_calculateNext())},controller.update_endGameRound=function(){assert(controller.update_inGameRound),controller.update_inGameRound=!1},model.actions_leftActors=util.list(50,!1),model.actions_canAct=function(e){assert(model.unit_isValidUnitId(e));var t=50*model.round_turnOwner;return e>=t+50||t>e?!1:model.actions_leftActors[e-t]===!0},controller.defineGameConfig("daysOfPeace",0,50,0),controller.defineGameScriptable("minrange",1,14),controller.defineGameScriptable("maxrange",1,15),controller.defineGameScriptable("att",50,400),controller.defineGameScriptable("def",50,400),controller.defineGameScriptable("counteratt",50,400),controller.defineGameScriptable("luck",-50,50),controller.defineGameScriptable("firstCounter",0,1),controller.defineGameScriptable("terrainDefense",0,12),controller.defineGameScriptable("terrainDefenseModifier",10,300),model.battle_FIRETYPES={DIRECT:0,INDIRECT:1,BALLISTIC:2,NONE:3},model.battle_WEAPON_KEYS=["main_wp","sec_wp"],model.battle_isPeacePhaseActive=function(){return model.round_day<controller.configValue("daysOfPeace")},model.battle_calculateTargets=function(e,t,o,n,a){var r="undefined"!=typeof n;a||(a=!1),assert(model.unit_isValidUnitId(e)),r&&n.setCenter(t,o,-1);var l=model.unit_data[e],i=model.player_data[l.owner].team,d=l.type.attack;if(1===arguments.length&&(t=l.x,o=l.y),assert(model.map_isValidPosition(t,o)),3===arguments.length&&assert(util.isBoolean(a)),"undefined"==typeof d)return!1;if(model.battle_hasMainWeapon(l.type)&&!model.battle_hasSecondaryWeapon(l.type)&&l.type.ammo>0&&0===l.ammo)return!1;var s=1,c=1;l.type.attack.minrange&&(controller.prepareTags(t,o,e),s=controller.scriptedValue(l.owner,"minrange",l.type.attack.minrange),c=controller.scriptedValue(l.owner,"maxrange",l.type.attack.maxrange));var m,u,_=o-c,p=o+c;for(0>_&&(_=0),p>=model.map_height&&(p=model.map_height-1);p>=_;_++){var f=Math.abs(_-o);for(m=t-c+f,u=t+c-f,0>m&&(m=0),u>=model.map_width&&(u=model.map_width-1);u>=m;m++)if(a)model.map_getDistance(t,o,m,_)>=s&&n.setValueAt(m,_,1);else{if(0===model.fog_turnOwnerData[m][_])continue;if(model.map_getDistance(t,o,m,_)>=s){var v=-1,h=model.unit_posData[m][_];if(null!==h&&model.player_data[h.owner].team!==i&&(v=model.battle_getBaseDamageAgainst(l,h),v>0)){if(!r)return!0;n.setValueAt(m,_,v)}}}}return!1},model.battle_hasMainWeapon=function(e){var t=e.attack;return"undefined"!=typeof t&&"undefined"!=typeof t.main_wp},model.battle_hasSecondaryWeapon=function(e){var t=e.attack;return"undefined"!=typeof t&&"undefined"!=typeof t.sec_wp},model.battle_getUnitFireType=function(e){if(!model.battle_hasMainWeapon(e)&&!model.battle_hasSecondaryWeapon(e))return model.battle_FIRETYPES.NONE;if("undefined"!=typeof e.attack.minrange){var t=e.attack.minrange;return 1===t?model.battle_FIRETYPES.BALLISTIC:model.battle_FIRETYPES.INDIRECT}return model.battle_FIRETYPES.DIRECT},model.battle_isIndirectUnit=function(e){return assert(model.unit_isValidUnitId(e)),model.battle_getUnitFireType(model.unit_data[e].type)===model.battle_FIRETYPES.INDIRECT},model.battle_isBallisticUnit=function(e){return assert(model.unit_isValidUnitId(e)),model.battle_getUnitFireType(model.unit_data[e].type)===model.battle_FIRETYPES.BALLISTIC},model.battle_canUseMainWeapon=function(e,t){var o,n=e.type.attack,a=t.type.ID;return e.ammo>0&&void 0!==n.main_wp&&(o=n.main_wp[a],"undefined"!=typeof o)?!0:!1},model.battle_hasTargets=function(e,t,o){return model.battle_calculateTargets(e,t,o)},model.battle_getBaseDamageAgainst=function(e,t,o){var n=e.type.attack;if(!n)return-1;var a,r=t.type.ID;return"undefined"==typeof o&&(o=!0),o&&e.ammo>0&&void 0!==n.main_wp&&(a=n.main_wp[r],"undefined"!=typeof a)?a:void 0!==n.sec_wp&&(a=n.sec_wp[r],"undefined"!=typeof a)?a:-1},model.battle_getBattleDamageAgainst=function(e,t,o,n,a){"undefined"==typeof a&&(a=!1),assert(util.intRange(o,0,100)),assert(util.isBoolean(n)),assert(util.isBoolean(a));var r=model.battle_getBaseDamageAgainst(e,t,n);if(-1===r)return-1;var l=model.unit_convertHealthToPoints(e),i=model.unit_convertHealthToPoints(t);controller.prepareTags(e.x,e.y);var d=parseInt(o/100*controller.scriptedValue(e.owner,"luck",10),10),s=controller.scriptedValue(e.owner,"att",100);a&&(s+=controller.scriptedValue(t.owner,"counteratt",0)),controller.prepareTags(t.x,t.y);var c=controller.scriptedValue(t.owner,"def",100),m=model.map_data[t.x][t.y].defense,u=parseInt(controller.scriptedValue(t.owner,"terrainDefense",m)*controller.scriptedValue(t.owner,"terrainDefenseModifier",100)/100,10),_=(r*s/100+d)*(l/10)*((200-(c+u*i))/100);return _=parseInt(_,10)},model.bombs_tryToMarkCannonTargets=function(e,t,o,n,a,r,l,i,d,s,c){assert(model.player_isValidPid(e));for(var m=model.player_data[e].team,u=i,_=!1;d>=l;l++)for(i=u;i>=s;i--)if(model.map_isValidPosition(l,i)&&!(Math.abs(l-o)+Math.abs(i-n)>c||Math.abs(l-a)+Math.abs(i-r)>c||model.fog_turnOwnerData[l][i]<=0)){var p=model.unit_posData[l][i];p&&p.owner!==e&&model.player_data[p.owner].team!==m&&(t.setValueAt(l,i,1),_=!0)}return _},model.bombs_markCannonTargets=function(e,t){var o,n=model.unit_data[e],a=model.property_posMap[n.x][n.y],r="PROP_INV"!==a.type.ID?a.type:model.bombs_grabPropTypeFromPos(n.x,n.y);assert(r.cannon),t.setCenter(n.x,n.y,-1);var l=r.cannon.range;switch(r.cannon.direction){case"N":o=model.bombs_tryToMarkCannonTargets(n.owner,t,n.x,n.y,n.x,n.y-l-1,n.x-n+1,n.y-1,n.x+n-1,n.y-l,l);break;case"E":o=model.bombs_tryToMarkCannonTargets(n.owner,t,n.x,n.y,n.x+l+1,n.y,n.x+1,n.y+l-1,n.x+l,n.y-l+1,l);break;case"W":o=model.bombs_tryToMarkCannonTargets(n.owner,t,n.x,n.y,n.x-l-1,n.y,n.x-l,n.y+l-1,n.x-1,n.y-l+1,l);break;case"S":o=model.bombs_tryToMarkCannonTargets(n.owner,t,n.x,n.y,n.x,n.y+l+1,n.x-l+1,n.y+l,n.x+l-1,n.y+1,l)}return o},model.bombs_isCannon=function(e){assert(model.unit_isValidUnitId(e));var t=model.unit_data[e];return"CANNON_UNIT_INV"===t.type.ID},model.bombs_isLaser=function(e){assert(model.unit_isValidUnitId(e));var t=model.unit_data[e];return"LASER_UNIT_INV"===t.type.ID},model.bombs_isSuicideUnit=function(e){return assert(model.unit_isValidUnitId(e)),"undefined"!=typeof model.unit_data[e].type.suicide},model.bombs_isSilo=function(e,t){assert(model.property_isValidPropId(e)),assert(model.unit_isValidUnitId(t));var o=model.property_data[e].type;if(!o.rocketsilo)return!1;if(2===arguments.length){var n=model.unit_data[t].type.ID;if(-1===o.rocketsilo.fireable.indexOf(n))return!1}return!0},model.bombs_grabPropTypeFromPos=function(e,t){for(;;){if(!(t+1<model.map_height&&model.property_posMap[e][t+1]&&"PROP_INV"===model.property_posMap[e][t+1].type.ID))break;t++}if("PROP_INV"!==model.property_posMap[e][t].type.ID)return model.property_posMap[e][t].type;for(;;){if(e+1<model.map_width&&model.property_posMap[e+1][t]&&"PROP_INV"!==model.property_posMap[e+1][t].type.ID)return model.property_posMap[e+1][t].type;break}assert(!1)},model.cfg_configuration={},model.client_instances=util.list(4,!1),model.client_lastPid=-1,model.client_isLocalPid=function(e){return assert(model.player_isValidPid(e)),model.client_instances[e]===!0},controller.defineGameConfig("co_getStarCost",5,5e4,9e3,5),controller.defineGameConfig("co_getStarCostIncrease",0,5e4,1800,5),controller.defineGameConfig("co_getStarCostIncreaseSteps",0,50,10),model.co_MODES={NONE:0,AW1:1,AW2:2,AWDS:3,AWDR:4},model.co_POWER_LEVEL={INACTIVE:0,COP:1,SCOP:2,TSCOP:3},model.co_activeMode=model.co_MODES.AW1,model.co_data=util.list(4,function(){return{power:0,timesUsed:0,level:0,coA:null,coB:null,detachedTo:-1}}),model.co_commanderRange=function(e){return assert(util.intRange(e,0,3)),assert(model.co_activeMode===model.co_MODES.AWDR),-1===model.co_data[e].detachedTo?-1:-1},model.co_isInCommanderFocus=function(e,t){if(model.co_activeMode!==model.co_MODES.AWDR)return!1;if(-1===model.co_data[t].detachedTo)return!1;var o=model.units[model.co_data[t].detachedTo],n=o.x,a=o.y,r=model.co_commanderRange(t),l=model.units[e],i=l.x,d=l.y,s=Math.abs(i-n);if(s>r)return!1;var c=Math.abs(d-a);return s+c>r?!1:!0},model.co_canActivatePower=function(e,t){assert(model.player_isValidPid(e)),assert(util.intRange(t,model.co_POWER_LEVEL.INACTIVE,model.co_POWER_LEVEL.TSCOP));var o=model.co_data[model.round_turnOwner];if(null===o.coA)return!1;if(o.level!==model.co_POWER_LEVEL.INACTIVE)return!1;var n;switch(t){case model.co_POWER_LEVEL.COP:n=o.coA.coStars;break;case model.co_POWER_LEVEL.SCOP:n=o.coA.scoStars}return o.power>=model.co_getStarCost(model.round_turnOwner)*n},model.co_getStarCost=function(e){assert(model.player_isValidPid(e));var t=controller.configValue("co_getStarCost"),o=model.co_data[e].timesPowerUsed,n=controller.configValue("co_getStarCostIncreaseSteps");return o>n&&(o=n),t+=o*controller.configValue("co_getStarCostIncrease")},model.coPower_invokePower=function(e,t){assert(model.player_isValidPid(e)),assert(t===model.co_POWER_LEVEL.COP||t===model.co_POWER_LEVEL.SCOP);var o=model.co_data[e];assert(o.coA);var n=t===model.co_POWER_LEVEL.COP?o.coA.cop.power:o.coA.scop.power;n.healUnits&&controller.action_sharedInvoke("coPower_heal",[o.scriptedValueByRules(n.healUnits,e,"target",0)+model.player_RELATION_MODES.OWN,o.scriptedValueByRules(n.healUnits,e,"amount",0)])},model.coPower_heal=function(e,t,o){assert(model.player_isValidPid(e)),assert(t>=model.player_RELATION_MODES.OWN&&t<=model.player_RELATION_MODES.ENEMY),assert(util.intRange(o,1,10));for(var n=model.player_data[e].team,a=model.unit_data,r=0,l=a.length;l>r;r++){var i=a[r],d=!1,s=model.player_data[i.owner].team;if(-1!==i.owner)switch(t){case model.player_RELATION_MODES.OWN:i.owner===e&&(d=!0);break;case model.player_RELATION_MODES.ALLIED:i.owner!==e&&n===s&&(d=!0);break;case model.player_RELATION_MODES.TEAM:i.owner===e&&n===s&&(d=!0);break;case model.player_RELATION_MODES.ENEMY:n!==s&&(d=!0)}d&&model.unit_heal(r,o,!1)}},model.data_createParser=function(e,t,o){var n=[],a=util.isFunction(o);return model.event_define("parse_"+e),{addHandler:function(e){assert(util.isFunction(e)),n.push(e)},parse:function(n){assert(util.isString(n.ID)),assert(!t.hasOwnProperty(n.ID)),model.events["parse_"+e](n),a?o(n):o.push(n.ID),t[n.ID]=n},parseAll:function(e){for(var t=0,o=e.length;o>t;t++)this.parse(e[t])}}},model.data_addEngineTypeSheets=function(){model.data_movetypeParser.parse({ID:"NO_MOVE",sound:null,costs:{"*":-1}}),model.data_unitParser.parse({ID:"CANNON_UNIT_INV",cost:0,range:0,movetype:"NO_MOVE",vision:1,fuel:0,ammo:0,assets:{}}),model.data_unitParser.parse({ID:"LASER_UNIT_INV",cost:0,range:0,movetype:"NO_MOVE",vision:1,fuel:0,ammo:0,assets:{}}),model.data_tileParser.parse({ID:"PROP_INV",defense:0,vision:0,capturePoints:1,blocker:!0,assets:{}})},model.data_unitSheets={},model.data_unitTypes=[],model.data_simpleAnimatedUnits={},model.data_unitParser=model.data_createParser("unit",model.data_unitSheets,function(e){model.data_unitTypes.push(e.ID),e.__sheetIndex__=model.data_unitTypes.length-1,e.assets.simpleAnimated&&(model.data_simpleAnimatedUnits[e.ID]=!0)}),model.data_tileSheets={},model.data_propertyTypes=[],model.data_tileTypes=[],model.data_tileParser=model.data_createParser("tile",model.data_tileSheets,function(e){e.capturePoints||e.rocketsilo||e.cannon||e.laser?(model.data_propertyTypes.push(e.ID),e.__sheetIndex__=model.data_propertyTypes.length-1):(model.data_tileTypes.push(e.ID),e.__sheetIndex__=model.data_tileTypes.length-1)}),model.data_weatherSheets={},model.data_defaultWeatherSheet=null,model.data_nonDefaultWeatherTypes=[],model.data_weatherParser=model.data_createParser("weather",model.data_weatherSheets,function(e){e.defaultWeather?model.data_defaultWeatherSheet=e:model.data_nonDefaultWeatherTypes.push(e)}),model.data_movetypeSheets={},model.data_movetypeTypes=[],model.data_movetypeParser=model.data_createParser("movetype",model.data_movetypeSheets,function(e){model.data_movetypeTypes.push(e.ID),e.__sheetIndex__=model.data_movetypeTypes.length-1}),model.data_gameModeSheets={},model.data_gameModeTypes=[],model.data_gameModeParser=model.data_createParser("gameMode",model.data_gameModeSheets,model.data_gameModeTypes),model.data_fractionSheets={},model.data_fractionTypes=[],model.data_fractionParser=model.data_createParser("fraction",model.data_fractionSheets,model.data_fractionTypes),model.data_fractionParser.addHandler(function(e){assert(e.hasOwnProperty("music"))}),model.data_coSheets={},model.data_coTypes=[],model.data_coParser=model.data_createParser("co",model.data_coSheets,function(e){model.data_coTypes.push(e.ID)}),model.data_globalRules=null,model.data_sounds=null,model.data_graphics=null,model.data_menu=null,model.data_maps=null,model.data_header=null,model.data_assets=null,model.data_tips=null,model.data_language={},model.data_localized=function(e){var t=model.data_language[e];return void 0===t?e:t},model.dayTick_dataTime=util.list(50,-1),model.dayTick_dataEvent=util.list(50,null),model.dayTick_dataArgs=util.list(100,-1),model.factory_wish=util.wish(),model.factory_canProduceSomething=function(e,t){return model.events.buildUnit_check(e,t)},model.factory_isFactory=function(e){return assert(model.property_isValidPropId(e)),model.property_data[e].type.builds},model.factoryGenerateBuildMenu=function(e,t,o){assert(model.property_isValidPropId(e)),assert(model.factory_isFactory(e));var n=model.property_data[e];assert(model.player_isValidPid(n.owner));for(var a=model.player_data[n.owner].gold,r=model.data_unitTypes,l=n.type.builds,i=0,d=r.length;d>i;i++){var s=r[i],c=model.data_unitSheets[s];-1!==l.indexOf(c.movetype)&&(c.cost<=a||o)&&t.addEntry(s,c.cost<=a)}},controller.defineGameScriptable("vision",1,40),controller.defineGameConfig("fogEnabled",0,1,1),model.fog_turnOwnerData=util.matrix(100,100,0),model.fog_clientData=util.matrix(100,100,0),model.fog_visibleClientPids=util.list(4,!1),model.fog_visibleTurnOwnerPids=util.list(4,!1),model.fog_remoteConnectOfPlayer=function(e){assert(model.player_isValidPid(e))},model.manpower_data=util.list(4,999999),model.map_data=util.matrix(100,100,null),model.map_height=-1,model.map_width=-1,model.map_getDistance=function(e,t,o,n){return assert(model.map_isValidPosition(e,t)),assert(model.map_isValidPosition(o,n)),Math.abs(e-o)+Math.abs(t-n)},model.map_isValidPosition=function(e,t){return e>=0&&t>=0&&e<model.map_width&&t<model.map_height},model.map_doInRange=function(e,t,o,n,a){assert(model.map_isValidPosition(e,t)),assert(util.isInt(o)&&o>=0),assert("function"==typeof n);var r,l,i=t-o,d=t+o;for(0>i&&(i=0),d>=model.map_height&&(d=model.map_height-1);d>=i;i++){var s=Math.abs(i-t);for(r=e-o+s,l=e+o-s,0>r&&(r=0),l>=model.map_width&&(l=model.map_width-1);l>=r;r++)if(n(r,i,a,Math.abs(r-e)+s)===!1)return}},controller.defineGameScriptable("moverange",1,15),controller.defineGameScriptable("movecost",1,15),model.move_MOVE_CODES={UP:0,RIGHT:1,DOWN:2,LEFT:3},model.move_pathCache=util.list(15,-1),model.move_getMoveCosts=function(e,t,o){assert(model.map_isValidPosition(t,o));var n,a;return a=model.property_posMap[t][o],n=a?a.type.blocker?-1:e.costs[a.type.ID]:e.costs[model.map_data[t][o].ID],"number"==typeof n?n:(n=e.costs["*"],"number"==typeof n?n:-1)},model.move_canTypeMoveTo=function(e,t,o){return model.map_isValidPosition(t,o)?-1===model.move_getMoveCosts(e,t,o)?!1:0===model.fog_turnOwnerData[t][o]?!0:null!==model.unit_posData[t][o]?!1:!0:void 0},model.move_codeFromAtoB=function(e,t,o,n){return assert(model.map_isValidPosition(e,t)),assert(model.map_isValidPosition(o,n)),assert(1===model.map_getDistance(e,t,o,n)),o>e?model.move_MOVE_CODES.RIGHT:e>o?model.move_MOVE_CODES.LEFT:n>t?model.move_MOVE_CODES.DOWN:t>n?model.move_MOVE_CODES.UP:null},model.move_generatePath=function(e,t,o,n,a,r){assert(model.map_isValidPosition(e,t)),assert(model.map_isValidPosition(o,n));var l,i=new Graph(a.data),d=e-a.centerX,s=t-a.centerY,c=i.nodes[d][s],m=o-a.centerX,u=n-a.centerY,_=i.nodes[m][u],p=astar.search(i.nodes,c,_),f=e,v=t;r.resetValues();for(var h=0,y=0,g=p.length;g>y;y++){l=p[y];var T;l.x>f?T=model.move_MOVE_CODES.RIGHT:l.x<f?T=model.move_MOVE_CODES.LEFT:l.y>v?T=model.move_MOVE_CODES.DOWN:l.y<v?T=model.move_MOVE_CODES.UP:util.expect(util.expect.isTrue,!1),r[h]=T,h++,f=l.x,v=l.y}},model.move_addCodeToPath=function(e,t){assert(util.intRange(e,model.move_MOVE_CODES.UP,model.move_MOVE_CODES.LEFT));var o,n=t.getLastCode();switch(e){case model.move_MOVE_CODES.UP:o=model.move_MOVE_CODES.DOWN;break;case model.move_MOVE_CODES.DOWN:o=model.move_MOVE_CODES.UP;break;case model.move_MOVE_CODES.LEFT:o=model.move_MOVE_CODES.RIGHT;break;case model.move_MOVE_CODES.RIGHT:o=model.move_MOVE_CODES.LEFT}if(n===o)return t[t.getSize()-1]=-1,!0;var a=controller.stateMachine.data.source,r=a.unit,l=r.fuel,i=0,d=r.type.range;d>l&&(d=l),t[t.getSize()]=e;for(var s=a.x,c=a.y,m=0,u=t.getSize();u>m;m++){switch(t[m]){case model.move_MOVE_CODES.UP:c--;break;case model.move_MOVE_CODES.DOWN:c++;break;case model.move_MOVE_CODES.LEFT:s--;break;case model.move_MOVE_CODES.RIGHT:s++}i+=controller.stateMachine.data.selection.getValueAt(s,c)}return i>d?(t[t.getSize()-1]=-1,!1):!0},model.move_move_fillMoveMapHelper_=[],model.move_fillMoveMap=function(e,t,o,n,a){var r;"number"!=typeof o&&(o=e.x),"number"!=typeof n&&(n=e.y),a||(a=e.unit),assert(model.map_isValidPosition(o,n));var l,i=!1;null!==model.move_move_fillMoveMapHelper_?(l=model.move_move_fillMoveMapHelper_,model.move_move_fillMoveMapHelper_=null,i=!0):l=[];var d=model.data_movetypeSheets[a.type.movetype],s=model.player_data[a.owner];controller.prepareTags(o,n,model.unit_extractId(a));var c=controller.scriptedValue(a.owner,"moverange",a.type.range);a.fuel<c&&(c=a.fuel),t.setCenter(o,n,-1),t.setValueAt(o,n,c),l[0]=o,l[1]=n,l[2]=c;for(var m=[-1,-1,-1,-1,-1,-1,-1,-1];;){for(var u=-1,_=-1,p=0,f=l.length;f>p;p+=3){var v=l[p+2];void 0!==v&&null!==v&&(-1===u||v>u)&&(u=v,_=p)}if(-1===_)break;var h=l[_],y=l[_+1],g=l[_+2];l[_]=null,l[_+1]=null,l[_+2]=null,h>0?(m[0]=h-1,m[1]=y):(m[0]=-1,m[1]=-1),h<model.map_width-1?(m[2]=h+1,m[3]=y):(m[2]=-1,m[3]=-1),y>0?(m[4]=h,m[5]=y-1):(m[4]=-1,m[5]=-1),y<model.map_height-1?(m[6]=h,m[7]=y+1):(m[6]=-1,m[7]=-1);for(var T=0;8>T;T+=2)if(-1!==m[T]){var E=m[T],S=m[T+1];if(r=model.move_getMoveCosts(d,E,S),-1!==r){var I=model.unit_posData[E][S];if(null!==I&&model.fog_turnOwnerData[E][S]>0&&!I.hidden&&model.player_data[I.owner].team!==s.team)continue;var k=g-r;if(k>=0&&k>t.getValueAt(E,S)){t.setValueAt(E,S,k);for(var p=0,f=l.length;f>=p;p+=3)if(null===l[p]||p===f){l[p]=E,l[p+1]=S,l[p+2]=k;break}}}}}if(i){for(var O=0,A=l.length;A>O;O++)l[O]=null;model.move_move_fillMoveMapHelper_=l}for(o=0,xe=model.map_width;xe>o;o++)for(n=0,ye=model.map_height;ye>n;n++)-1!==t.getValueAt(o,n)&&(r=model.move_getMoveCosts(d,o,n),t.setValueAt(o,n,r))},model.move_trapCheck=function(e,t,o){for(var n,a,r=t.x,l=t.y,i=model.player_data[t.unit.owner].team,d=0,s=e.length;s>d&&-1!==e[d];d++){switch(e[d]){case model.move_MOVE_CODES.DOWN:l++;break;case model.move_MOVE_CODES.UP:l--;break;case model.move_MOVE_CODES.LEFT:r--;break;case model.move_MOVE_CODES.RIGHT:r++}var c=model.unit_posData[r][l];if(c){if(i!==model.player_data[c.owner].team)return o.set(n,a),e[d]=-1,!0}else n=r,a=l}return!1},model.player_RELATION_MODES={SAME_OBJECT:-1,NONE:0,OWN:1,ALLIED:2,TEAM:3,ENEMY:4,NULL:5},model.player_data=util.list(4,function(){return{gold:0,team:-1,name:null}}),model.player_isValidPid=function(e){return assert(model.property_isValidPropId(e)),0>e||e>=4?!1:-1!==model.player_data[e].team},model.player_extractId=function(e){var t=model.player_data.indexOf(e);return assert(t>-1),t},model.player_areEnemyTeamsLeft=function(){for(var e,t=-1,o=0,n=model.player_data.length;n>o;o++)if(e=model.player_data[o],-1!==e.team)if(-1===t)t=e.team;else if(t!==e.team){t=-1;break}return-1===t},model.player_getRelationship=function(e,t){if(null===e||null===t)return model.player_RELATION_MODES.NULL;if(-1===e||-1===t)return model.player_RELATION_MODES.NONE;if(-1===model.player_data[e].team||-1===model.player_data[t].team)return model.player_RELATION_MODES.NONE;if(e===t)return model.player_RELATION_MODES.OWN;var o=model.player_data[e].team,n=model.player_data[t].team;return-1===o||-1===n?model.player_RELATION_MODES.NONE:o===n?model.player_RELATION_MODES.ALLIED:o!==n?model.player_RELATION_MODES.ENEMY:model.player_RELATION_MODES.NONE},model.player_getRelationshipUnitNeighbours=function(e,t,o,n){assert(model.property_isValidPropId(e)),assert(model.map_isValidPosition(t,o));var a=model.player_getRelationship,r=n===model.player_RELATION_MODES.OWN,l=0,i=model.unit_data.length;for(r&&(l=model.unit_firstUnitId(e),i=model.unit_lastUnitId(e));i>l;l++)if(1===model.unit_getDistance(sid,l)&&(r||a(e,model.unit_data[l].owner)===n))return!0;return!1},controller.defineGameScriptable("captureRate",50,9999),controller.defineGameScriptable("funds",1,99999),controller.defineGameConfig("captureLimit",0,300,0),model.property_data=util.list(301,function(){return{capturePoints:20,owner:-1,x:0,y:0,type:null}}),model.property_posMap=util.matrix(100,100,null),model.property_isValidPropId=function(e){return"number"==typeof e&&e>=0&&300>e},model.property_thereIsAProperty=function(e,t,o,n){assert(model.map_isValidPosition(e,t)),assert(model.player_isValidPid(o));var a=model.property_posMap[e][t];return null!==a&&model.player_getRelationship(o,a.owner)===n},model.property_getByPos=function(e,t){return assert(model.map_isValidPosition(e,t)),model.property_posMap[e][t]},model.property_isPropertyAtTile=function(e,t){return assert(model.map_isValidPosition(e,t)),null!==model.property_getByPos(e,t)},model.property_extractId=function(e){var t=model.property_data.indexOf(e);return assert(-1!==t),t},model.property_countProperties=function(e){assert(model.player_isValidPid(e));for(var t=0,o=model.property_data,n=0,a=o.length;a>n;n++)o[n].owner===e&&t++;return t},model.property_isCapturableBy=function(e,t){return assert(model.property_isValidPropId(e)),assert(model.unit_isValidUnitId(t)),model.property_data[e].type.capturePoints>0&&model.unit_data[t].type.captures>0},controller.defineGameConfig("round_dayLimit",0,999,0),model.round_day=0,model.round_turnOwner=-1,model.round_isTurnOwner=function(e){return model.round_turnOwner===e},model.round_daysToTurns=function(e){return model.player_data.length*e},model.rule_global=[],model.rule_map=util.list(20,null),controller.defineGameScriptable("propertyHeal",1,10),controller.defineGameConfig("autoSupplyAtTurnStart",0,1,1),model.supply_isSupplyUnit=function(e){return assert(model.unit_isValidUnitId(e)),model.unit_data[e].type.supply},model.supply_hasSupplyTargetsNearby=function(e,t,o){assert(model.unit_isValidUnitId(e));var n=model.unit_data[e];return-1!==n.loadedIn?!1:(assert(model.map_isValidPosition(t,o)),model.supply_isSupplyUnit(e)?!1:!1)},model.team_MONEY_TRANSFER_STEPS=[1e3,2500,5e3,1e4,25e3,5e4],controller.defineGameConfig("model.timer_turnTimeLimit",0,60,0),controller.defineGameConfig("model.timer_gameTimeLimit",0,99999,0),model.timer_turnTimeLimit=0,model.timer_gameTimeLimit=0,model.timer_gameTimeElapsed=0,model.timer_turnTimeElapsed=0,model.transport_hasLoads=function(e){assert(model.unit_isValidUnitId(e));for(var t=model.unit_data[e].owner,o=model.unit_firstUnitId(t),n=model.unit_lastUnitId(t);n>o;o++)if(o!==e){var a=model.unit_data[o];if(null!==a&&a.loadedIn===e)return!0}return!1},model.transport_isLoadedBy=function(e,t){return assert(model.unit_isValidUnitId(e)),assert(model.unit_isValidUnitId(t)),assert(e!==t),model.unit_data[e].loadedIn===t},model.transport_canLoadUnit=function(e,t){assert(model.unit_isValidUnitId(e)),assert(model.unit_isValidUnitId(t)),assert(t!==e);var o=model.unit_data[t],n=model.unit_data[e];return assert(model.transport_isTransportUnit(t)),assert(n.loadedIn!==t),0===o.loadedIn+o.type.maxloads+1?!1:-1!==o.type.canload.indexOf(n.type.movetype)},model.transport_isTransportUnit=function(e){return assert(model.unit_isValidUnitId(e)),"number"==typeof model.unit_data[e].type.maxloads},controller.defineGameScriptable("fuelDrainRate",50,100),controller.defineGameScriptable("fuelDrain",1,99),controller.defineGameConfig("noUnitsLeftLoose",0,1,0),controller.defineGameConfig("unitLimit",0,50,0),model.unit_data=util.list(200,function(){return{hp:99,x:0,y:0,ammo:0,fuel:0,loadedIn:-1,type:null,hidden:!1,owner:-1}}),model.unit_posData=util.matrix(100,100,null),model.unit_getDistance=function(e,t){assert(model.unit_isValidUnitId(e)),assert(model.unit_isValidUnitId(t));var o,n;return o=model.unit_data[e],n=model.unit_data[t],-1===n.x||-1===o.x?-1:Math.abs(o.x-n.x)+Math.abs(o.y-n.y)},model.unit_isValidUnitId=function(e){return e>=0&&200>e&&-1!==model.unit_data[e].owner},model.unit_getFreeSlot=function(e){if(!model.unit_hasFreeSlots(e))return-1;for(var t=model.unit_firstUnitId(e),o=model.unit_lastUnitId(e);o>t;t++)if(-1===model.unit_data[t].owner)return t},model.unit_thereIsAUnit=function(e,t,o,n){if(!model.map_isValidPosition(e,t))return!1;assert(model.player_isValidPid(o));var a=model.unit_posData[e][t];return null!==a&&model.player_getRelationship(o,a.owner)===n},model.unit_firstUnitId=function(e){return 50*e},model.unit_lastUnitId=function(e){return 50*(e+1)-1},model.unit_getByPos=function(e,t){return assert(model.map_isValidPosition(e,t)),model.unit_posData[e][t]},model.unit_extractId=function(e){assert(null!==e);var t=model.unit_data.indexOf(e);return assert(t>-1),t},model.unit_hasFreeSlots=function(e){assert(model.player_isValidPid(e));var t=controller.configValue("unitLimit");t||(t=9999999);for(var o=model.unit_firstUnitId(e),n=model.unit_lastUnitId(e),a=0,r=!1;n>=o;o++)if(-1===model.unit_data[o].owner)r=!0;else if(a++,a>=t)return!1;return r},model.unit_isTileOccupied=function(e,t){assert(model.map_isValidPosition(e,t));var o=model.unit_posData[e][t];return null===o?-1:model.unit_extractId(o)},model.unit_countUnits=function(e){assert(model.player_isValidPid(e));for(var t=0,o=model.unit_firstUnitId(e),n=model.unit_lastUnitId(e);n>=o;o++)-1!==model.unit_data[o].owner&&t++;return t},model.unit_convertHealthToPoints=function(e){return parseInt(e.hp/10)+1},model.unit_convertHealthToPointsRest=function(e){return assert(util.intRange(e.hp,0,99)),e.hp-(parseInt(e.hp/10)+1)},model.unit_convertPointsToHealth=function(e){return assert(util.intRange(e,0,10)),10*e},controller.defineGameScriptable("neutralizeWeather",0,1),controller.defineGameConfig("weatherMinDays",1,5,1),controller.defineGameConfig("weatherRandomDays",0,5,4),model.weather_data=null,function(){function e(e){var t=50*model.unit_data[e].owner;model.actions_leftActors[e-t]=!1}model.event_on("wait_invoked",e),model.event_on("trapwait_invoked",e)}(),model.event_on("nextTurn_pidStartsTurn",function(e){for(var t=model.unit_firstUnitId(e),o=model.unit_lastUnitId(e),n=t;o>t;t++)model.actions_leftActors[t-n]=-1!==model.unit_data[t].owner}),model.event_on("attack_check",function(){return model.round_day<controller.configValue("daysOfPeace")?!1:void 0}),model.event_on("attack_check",function(e,t,o,n){return model.battle_isIndirectUnit(e)&&n===!0?!1:void 0}),model.event_on("attack_check",function(e,t,o){return model.battle_calculateTargets(e,t,o)?void 0:!1}),model.event_on("attack_invoked",function(e,t,o,n){assert(model.unit_isValidUnitId(e)),assert(model.unit_isValidUnitId(t)),assertIntRange(o,0,100),assertIntRange(n,0,100);var a=model.unit_data[e],r=model.unit_data[t],l=model.battle_isIndirectUnit(e);if(!l&&1===controller.scriptedValue(r.owner,"firstCounter",0)&&!model.battle_isIndirectUnit(t)){var i=r;r=a,a=i}var d,s=a.type,c=r.type,m=a.owner,u=r.owner,_=model.unit_convertHealthToPoints(r),p=model.unit_convertHealthToPoints(a),f=model.battle_canUseMainWeapon(a,r);d=model.battle_getBattleDamageAgainst(a,r,o,f,!1),-1!==d&&(model.events.damageUnit(t,d),_-=model.unit_convertHealthToPoints(r),f&&a.ammo--,_=parseInt(.1*_*c.cost,10),model.events.co_modifyPowerLevel(m,parseInt(.5*_,10)),model.events.co_modifyPowerLevel(u,_)),r.hp>0&&!model.battle_isIndirectUnit(t)&&(f=model.battle_canUseMainWeapon(r,a),d=model.battle_getBattleDamageAgainst(r,a,n,f,!0),-1!==d&&(model.events.damageUnit(e,d),p-=model.unit_convertHealthToPoints(a),f&&r.ammo--,p=parseInt(.1*p*s.cost,10),model.events.co_modifyPowerLevel(u,parseInt(.5*p,10)),model.events.co_modifyPowerLevel(m,p)))}),model.event_on("attackUnit_unitAttacks",function(){}),model.event_on("fireCannon_check",function(e,t){return model.bombs_isCannon(e)&&model.bombs_markCannonTargets(e,t)}),model.event_on("fireCannon_fillTargets",function(e,t){model.bombs_markCannonTargets(e,t)}),model.event_on("fireCannon_invoked",function(e,t,o,n){model.property_posMap[o][n];var a=model.unit_posData[o][n],r=model.bombs_grabPropTypeFromPos(e,t);model.events.damageUnit(model.unit_extractId(a),model.unit_convertPointsToHealth(r.cannon.damage),9)}),function(){function e(e,t){var o=model.property_posMap[e][t];o.type.cannon;var n=o.type.bigProperty;assert(e-n.x>=0),assert(t-n.y>=0);for(var a=e-n.actor[0],r=t-n.actor[1],l=e,i=t,d=e-n.x;e>d;e--){t=i;for(var s=t-n.y;t>s;t--)(e!==l||t!==i)&&model.events.property_createProperty(o.owner,e,t,"PROP_INV"),e===a&&t===r&&model.events.createUnit(model.unit_getFreeSlot(o.owner),o.owner,e,t,"CANNON_UNIT_INV")
}}model.event_on("gameround_start",function(){for(var t=0,o=model.map_width;o>t;t++)for(var n=0,a=model.map_height;a>n;n++){var r=model.property_posMap[t][n];r&&(r.type.bigProperty&&r.type.cannon?e(t,n):r.type.cannon?model.events.createUnit(model.unit_getFreeSlot(r.owner),r.owner,t,n,"CANNON_UNIT_INV"):r.type.laser&&model.events.createUnit(model.unit_getFreeSlot(r.owner),r.owner,t,n,"LASER_UNIT_INV"))}})}(),model.event_on("client_deregisterPlayers",function(){model.client_instances.resetValues()}),model.event_on("client_registerPlayer",function(e){return assert(model.player_isValidPid(e)),model.client_instances[e]=!0,-1===model.client_lastPid&&(model.client_lastPid=e),!0}),model.event_on("client_deregisterPlayer",function(e){return assert(model.player_isValidPid(e)),model.client_instances[e]=!1,!0}),model.event_on("attachCommander_check",function(){return model.co_activeMode!==model.co_MODES.AWDR?!1:void 0}),model.event_on("attachCommander_invoked",function(e,t){assert(-1===model.co_data[e].detachedTo),model.co_data[e].detachedTo=t}),model.event_on("detachCommander_check",function(){return model.co_activeMode!==model.co_MODES.AWDR?!1:void 0}),model.event_on("detachCommander_invoked",function(e,t){assert(model.co_data[e].detachedTo!==t),model.co_data[e].detachedTo=-1}),model.event_on("activatePower_check",function(){return model.co_activeMode!==model.co_MODES.AW1&&model.co_activeMode!==model.co_MODES.AW2&&model.co_activeMode!==model.co_MODES.AWDS?!1:void 0}),model.event_on("activatePower_check",function(e){return model.co_canActivatePower(e,model.co_POWER_LEVEL.COP)?void 0:!1}),model.event_on("activatePower_invoked",function(e,t){var o=model.co_data[e];o.power=0,o.level=t,o.timesUsed++}),function(){function e(e,t,o){null===t?o?model.co_data[e].coA=null:model.co_data[e].coB=null:(assert(model.data_coSheets.hasOwnProperty(t)),o?model.co_data[e].coA=model.data_coSheets[t]:model.co_data[e].coB=model.data_coSheets[t])}model.event_on("setMainCo",function(t,o){e(t,o,!0)}),model.event_on("setSideCo",function(t,o){e(t,o,!1)})}(),model.event_on("co_modifyPowerLevel",function(e,t){assert(model.player_isValidPid(e));var o=model.co_data[e];o.power+=t,o.power<0&&(o.power=0)}),model.event_on("dayEvent",function(e,t,o,n){void 0===o&&(o=-1),void 0===n&&(n=-1);for(var a=model.dayTick_dataTime,r=0,l=a.length;l>r;r++)if(-1===a[r])return a[r]=model.round_daysToTurns(e),model.dayTick_dataEvent[r]=t,model.dayTick_dataArgs[2*r]=o,model.dayTick_dataArgs[2*r+1]=n,void 0;assert(!1,"day event buffer overflow")}),model.event_on("nextTurn_invoked",function(){for(var e=model.dayTick_dataTime,t=0,o=e.length;o>t;t++)-1!==e[t]&&(e[t]--,e[t]||(e[t]=-1,model.events[model.dayTick_dataEvent[t]](model.dayTick_dataArgs[2*t],model.dayTick_dataArgs[2*t+1])))}),model.event_on("buildUnit_check",function(e,t){return model.factory_isFactory(e)?-1===t?!1:void 0:!1}),model.event_on("buildUnit_invoked",function(e,t,o){var n=model.property_posMap[e][t],a=model.data_unitSheets[o].cost,r=model.player_data[n.owner];r.gold-=a,assert(r.gold>=0),model.events.createUnit(model.unit_getFreeSlot(n.owner),n.owner,e,t,o)}),model.event_on("modifyVisionAt",function(e,t,o,n,a){if(-1!==o&&controller.configValue("fogEnabled")){assert(model.map_isValidPosition(e,t)),assert(util.isInt(n)&&n>=0),controller.prepareTags(e,t),n>0&&(n=controller.scriptedValue(o,"vision",n));var r=model.fog_visibleClientPids[o],l=model.fog_visibleTurnOwnerPids[o];if(r||l)if(0===n)r&&(model.fog_clientData[e][t]+=a),l&&(model.fog_turnOwnerData[e][t]+=a);else{var i,d,s=model.map_height,c=model.map_width,m=t-n,u=t+n;for(0>m&&(m=0),u>=s&&(u=s-1);u>=m;m++){var _=Math.abs(m-t);for(i=e-n+_,d=e+n-_,0>i&&(i=0),d>=c&&(d=c-1);d>=i;i++)model.map_data[i][m].blocksVision&&model.map_getDistance(e,t,i,m)>1||(r&&(model.fog_clientData[i][m]+=a),l&&(model.fog_turnOwnerData[i][m]+=a))}}}}),model.event_on("recalculateFogMap",function(){var e,t,o=model.map_width,n=model.map_height,a=1===controller.configValue("fogEnabled");for(e=0;o>e;e++)for(t=0;n>t;t++)a?(model.fog_clientData[e][t]=0,model.fog_turnOwnerData[e][t]=0):(model.fog_clientData[e][t]=1,model.fog_turnOwnerData[e][t]=1);if(a){var r;for(e=0;o>e;e++)for(t=0;n>t;t++){var l=model.unit_posData[e][t];null!==l&&(r=l.type.vision,0>r&&(r=0),model.events.modifyVisionAt(e,t,l.owner,r,1));var i=model.property_posMap[e][t];null!==i&&(r=i.type.vision,0>r&&(r=0),model.events.modifyVisionAt(e,t,i.owner,r,1))}}}),model.event_on("nextTurn_pidStartsTurn",function(e){var t=model.player_data[e].team;model.client_instances[e]&&(model.client_lastPid=e);for(var o=model.client_lastPid,n=0,a=4;a>n;n++)model.fog_visibleClientPids[n]=!1,model.fog_visibleTurnOwnerPids[n]=!1,-1!==model.player_data[n].team&&(model.player_data[n].team===o&&(model.fog_visibleClientPids[n]=!0),model.player_data[n].team===t&&(model.fog_visibleTurnOwnerPids[n]=!0));model.events.recalculateFogMap()}),model.event_on("joinUnits_check",function(e,t){var o=model.unit_data[e],n=model.unit_data[t];return model.transport_hasLoads(e)||model.transport_hasLoads(t)||o.type!==n.type||n.hp>=90?!1:void 0}),model.event_on("joinUnits_invoked",function(e,t){var o=model.unit_data[e],n=model.unit_data[t];assert(n.type===o.type),model.events.healUnit(t,model.unit_convertPointsToHealth(model.unit_convertHealthToPoints(o)),!0),n.ammo+=o.ammo,n.ammo>n.type.ammo&&(n.ammo=n.type.ammo),n.fuel+=o.fuel,n.fuel>n.type.fuel&&(n.fuel=n.type.fuel),o.owner=-1}),model.event_on("fireLaser_check",function(e){return model.bombs_isLaser(e)?void 0:!1}),model.event_on("fireLaser_invoked",function(e,t){var o=model.property_posMap[e][t];assert(o);var n=e,a=t,r=o.owner;for(e=0,xe=model.map_width;xe>e;e++)for(t=0,ye=model.map_height;ye>t;t++)if(n===e||a===t){var l=model.unit_posData[e][t];l&&l.owner!==r&&model.events.damageUnit(model.unit_extractId(l),model.unit_convertPointsToHealth(o.type.laser.damage),9)}}),model.event_on("buildUnit_check",function(e,t){return model.manpower_data[t]<=0?!1:void 0}),model.event_on("buildUnit_invoked",function(e,t){model.manpower_data[model.property_posMap[e][t].owner]--}),model.event_on("move_flushMoveData",function(e,t){controller.commandStack_sharedInvokement("move_clearWayCache");for(var o=0,n=e.length;n>o&&-1!==e[o];o+=6)controller.commandStack_sharedInvokement("move_appendToWayCache",e[o],e[o+1],e[o+2],e[o+3],e[o+4],e[o+5]);controller.commandStack_sharedInvokement("move_moveByCache",t.unitId,t.x,t.y,0)}),model.event_on("move_clearWayCache",function(){model.move_pathCache.resetValues()}),model.event_on("move_appendToWayCache",function(){for(var e=0;-1!==model.move_pathCache[e];)e++,e>=15&&assert(!1);for(var t=0;t<arguments.length;)model.move_pathCache[e]=arguments[t],t++,e++,e>=15&&assert(!1)}),model.event_on("move_moveByCache",function(e,t,o,n){for(var a=model.move_pathCache,r=t,l=o,i=model.unit_data[e],d=i.type,s=model.data_movetypeSheets[d.movetype],c=!1,m=(a.length-1,0),u=0,_=a.length;_>u&&-1!==a[u];u++){switch(a[u]){case model.move_MOVE_CODES.UP:0===l&&(c=!0),l--;break;case model.move_MOVE_CODES.RIGHT:r===model.map_width-1&&(c=!0),r++;break;case model.move_MOVE_CODES.DOWN:l===model.map_height-1&&(c=!0),l++;break;case model.move_MOVE_CODES.LEFT:0===r&&(c=!0),r--}assert(!c),n!==!0&&(m+=model.move_getMoveCosts(s,r,l))}i.fuel-=m,assert(i.fuel>=0),i.x>=0&&i.y>=0&&model.events.clearUnitPosition(e),null===model.unit_posData[r][l]&&model.events.setUnitPosition(e,r,l)}),function(){function e(e,t,o){var n=model.unit_data[e];n.x=t,n.y=o,model.unit_posData[t][o]=n,model.events.modifyVisionAt(t,o,n.owner,n.type.vision,1)}model.event_on("setUnitPosition",e),model.event_on("createUnit",function(t,o,n,a){e(t,n,a)})}(),model.event_on(["clearUnitPosition","destroyUnitSilent"],function(e){var t=model.unit_data[e],o=t.x,n=t.y;model.events.modifyVisionAt(o,n,t.owner,t.type.vision,-1),model.unit_posData[o][n]=null,t.x=-t.x,t.y=-t.y}),model.event_on("multistep_next",function(){controller.stateMachine.data.breakMultiStep?controller.stateMachine.event("nextStepBreak"):controller.stateMachine.event("nextStep")}),model.event_on("player_deactivatePlayer",function(e){assert(model.property_isValidPropId(e));var t,o;for(t=model.unit_firstUnitId(e),o=model.unit_lastUnitId(e);o>t;t++)-1!==model.unit_data[t].owner&&model.events.destroyUnit(t);for(t=0,o=model.property_data.length;o>t;t++){var n=model.property_data[t];if(n.owner===e){n.owner=-1;var a=n.type.changeAfterCaptured;a&&model.events.property_changeType(t,a)}}model.player_data[e].team=-1,model.player_areEnemyTeamsLeft()||controller.commandStack_localInvokement("player_noTeamsAreLeft")}),model.event_on("player_playerGivesUp",function(){assert(model.client_isLocalPid(model.round_turnOwner)),model.events.nextTurn_invoked()}),model.event_on("player_noTeamsAreLeft",function(){controller.update_endGameRound()}),model.event_on("capture_check",function(e,t){return model.property_isCapturableBy(e,t)?void 0:!1}),model.event_on("capture_invoked",function(e,t){assert(model.property_isValidPropId(e)),assert(model.unit_isValidUnitId(t));var o=model.unit_data[t],n=model.property_data[e],a=parseInt(o.hp/10,10)+1;if(a=parseInt(a*controller.scriptedValue(o.owner,"captureRate",100)/100,10),n.capturePoints-=a,n.capturePoints<=0){var r=n.x,l=n.y;if(model.events.modifyVisionAt(r,l,n.type.vision,1),n.type.looseAfterCaptured===!0){var i=n.owner;model.events.player_deactivatePlayer(i)}var d=n.type.changeAfterCaptured;"undefined"!=typeof d&&model.events.property_changeType(e,d),n.capturePoints=20,n.owner=o.owner;var s=controller.configValue("captureLimit");0!==s&&model.countProperties()>=s&&controller.update_endGameRound()}}),model.event_on("property_createProperty",function(e,t,o,n){for(var a=model.property_data,r=0,l=a.length;l>r;r++)if(-1===a[r].owner&&!a[r].type)return a[r].owner=e,a[r].type=model.data_tileSheets[n],a[r].capturePoints=1,a[r].x=t,a[r].y=o,model.property_posMap[t][o]=a[r],void 0;assert(!1)}),model.event_on("move_moveByCache",function(e,t,o){var n=model.property_posMap[t][o];n&&(n.capturePoints=20)}),model.event_on("property_changeType",function(e,t){assert(model.property_isValidPropId(e)),"string"==typeof t?(assert(-1!==model.data_propertyTypes.indexOf(t)),t=model.data_tileSheets[t]):assert(-1!==model.data_propertyTypes.indexOf(t.ID)),model.property_data[e].type=t}),model.event_on("property_changeTypeById",function(e,t){model.events.property_changeType(e,model.data_propertyTypes[t])}),model.event_on("nextTurn_invoked",function(){var e=model.round_turnOwner,t=e;for(e++;e!==t;){if(4===e){e=0,model.round_day++;var o=controller.configValue("round_dayLimit");o>0&&model.round_day===o&&controller.update_endGameRound()}if(-1!==model.player_data[e].team)break;e++}assert(e!==t),model.events.nextTurn_pidStartsTurn(e)}),model.event_on("nextTurn_pidStartsTurn",function(t){for(model.round_turnOwner=t,model.client_isLocalPid(t)&&(model.client_lastPid=t),i=0,e=model.property_data.length;e>i;i++)model.property_data[i].owner===t&&model.events.nextTurn_propertyCheck(i);for(1===controller.configValue("autoSupplyAtTurnStart"),i=model.unit_firstUnitId(t),e=model.unit_lastUnitId(t);e>i;i++)-1!==model.unit_data[i].owner&&model.events.nextTurn_unitCheck(i);controller.isHost()&&!controller.ai_isHuman(t)&&controller.ai_machine.event("tick")}),model.event_on("modification_loaded",function(){var e,t;for(controller.script_parseRule(model.data_globalRules),e=model.data_nonDefaultWeatherTypes.length-1;e>=0;e--)controller.script_parseRule(model.data_nonDefaultWeatherTypes[e].rules);for(e=model.data_coTypes.length-1;e>=0;e--)t=model.data_coSheets[model.data_coTypes[e]],controller.script_parseRule(t.d2d),controller.script_parseRule(t.cop.turn),controller.script_parseRule(t.scop.turn)}),model.event_on("silofire_check",function(e,t){return model.bombs_isSilo(e,t)?void 0:!1}),model.event_on("silofire_validPos",function(e,t){return model.map_isValidPosition(e,t)?void 0:!1}),model.event_on("silofire_invoked",function(e,t,o,n,a){var r=model.property_posMap[e][t],l=model.property_extractId(r),i=r.type,d=i.rocketsilo.range,s=model.unit_convertPointsToHealth(i.rocketsilo.damage);model.events.property_changeType(l,model.data_tileSheets[i.changeTo]),model.events.rocketFly(e,t,o,n),model.events.explode_invoked(o,n,d,s,a)}),model.event_on("silofire_invoked",function(e,t){var o=model.property_posMap[e][t],n=model.property_extractId(o),a=o.type;model.events.dayEvent(5,"property_changeTypeById",n,model.data_propertyTypes.indexOf(a))}),model.event_on("unitHide_check",function(e){var t=model.unit_data[e];return!t.type.stealth||t.hidden?!1:void 0}),model.event_on("unitUnhide_check",function(e){var t=model.unit_data[e];return t.type.stealth&&t.hidden?void 0:!1}),model.event_on("unitHide_invoked",function(e){model.unit_data[e].hidden=!0}),model.event_on("unitUnhide_invoked",function(e){model.unit_data[e].hidden=!1}),model.event_on("explode_check",function(e){return model.bombs_isSuicideUnit(e)?void 0:!1}),function(){function e(e,t,o){var n=model.unit_posData[e][t];n&&model.events.damageUnit(model.unit_extractId(n),o,9)}model.event_on("explode_invoked",function(t,o,n,a){model.map_doInRange(t,o,n,e,a)})}(),model.event_on("supplyUnit_check",function(e,t,o){return model.supply_hasSupplyTargetsNearby(e,t,o)?void 0:!1}),model.event_on("supplyUnit_invoked",function(e){var t=model.unit_data[e];assert(t.type.supply),t.x,t.y;for(var o=t.owner,n=model.unit_firstUnitId(o),a=model.unit_lastUnitId(o);a>n;n++)model.unit_isValidUnitId(n)&&1===model.unit_getDistance(e,n)&&model.events.supply_refillResources(n)}),model.event_on("supply_refillResources",function(e){assert(model.unit_isValidUnitId(e));var t=model.unit_data[e],o=t.type;t.ammo=o.ammo,t.fuel=o.fuel}),model.event_on("nextTurn_unitCheck",function(e){var t=model.unit_data[e];model.events.supplyUnit_check(e,t.x,t.y)&&model.events.supplyUnit_invoked(e)}),model.event_on("nextTurn_unitCheck",function(e){var t=model.unit_data[e],o=t.type.dailyFuelDrain;return"number"==typeof o&&(t.hidden&&t.type.dailyFuelDrainHidden&&(o=t.type.dailyFuelDrainHidden),o=parseInt(controller.scriptedValue(t.owner,"fuelDrain",o)/100*controller.scriptedValue(t.owner,"fuelDrainRate",100),10),t.fuel-=o,t.fuel<=0)?(model.events.destroyUnit(e),!1):void 0}),model.event_on("nextTurn_propertyCheck",function(e){var t=model.property_data[e];if("number"==typeof t.type.funds){var o=t.x,n=t.y;controller.prepareTags(o,n);var a=controller.scriptedValue(t.owner,"funds",t.type.funds);model.player_data[t.owner].gold+=a}}),model.event_on("nextTurn_propertyCheck",function(){var e=model.property_data[i];if(e.type.supply){var t=e.x,o=e.y,n=e.owner,a=model.unit_thereIsAUnit,r=model.MODE_OWN;if(1===controller.configValue("supplyAlliedUnits")&&(r=model.MODE_TEAM),a(t,o,n,r)){var l=model.unit_posData[t][o].type;(-1!==e.type.supply.indexOf(l.ID)||-1!==e.type.supply.indexOf(l.movetype))&&model.events.supply_refillResources(model.unit_posData[t][o])}}}),model.event_on("nextTurn_propertyCheck",function(){var e=model.property_data[i];if(e.type.repairs){var t=e.x,o=e.y,n=e.owner,a=model.unit_thereIsAUnit,r=model.MODE_OWN;if(1===controller.configValue("repairAlliedUnits")&&(r=model.MODE_TEAM),a(t,o,n,r)){var l,d=model.unit_posData[t][o].type;l=e.type.repairs.get(d.ID),l||(l=e.type.repairs.get(d.movetype)),l=controller.scriptedValue(n,"propertyHeal",l),l>0&&model.events.healUnit(model.unit_extractId(model.unit_posData[t][o]),model.unit_convertPointsToHealth(l),!0)}}}),model.event_on("transferMoney_check",function(e,t,o){var n;if(model.player_data[e].gold<model.team_MONEY_TRANSFER_STEPS[0])return!1;if(n=model.unit_posData[t][o],null===n||n.owner===e){if(n=model.property_posMap[t][o],null!==n&&n.owner!==e&&-1!==n.owner)return;return!1}}),model.event_on("transferMoney_addEntries",function(e,t){assert(model.player_isValidPid(e));for(var o=model.player_data[e].gold,n=0,a=model.team_MONEY_TRANSFER_STEPS.length;a>n;n++)o>=model.team_MONEY_TRANSFER_STEPS[n]&&t.addEntry(model.team_MONEY_TRANSFER_STEPS[n])}),model.event_on("transferMoney_invoked",function(e,t,o){var n=model.player_data[e],a=model.player_data[t];n.gold-=o,a.gold+=o,assert(n.gold>=0)}),model.event_on("transferUnit_check",function(e){return model.transport_hasLoads(e)?!1:void 0}),model.event_on("transferUnit_addEntries",function(e,t){for(var o=0,n=4;n>o;o++)o!==e&&-1!==model.player_data[o].team&&t.addEntry(o,!0)}),model.event_on("transferUnit_invoked",function(e,t){var o=model.unit_data[e],n=o.x,a=o.y,r=o.owner;o.owner=-1,model.player_data[t].team!==model.player_data[r].team&&model.events.fog_modifyVisionAt(n,a,o.type.vision,-1);var l=model.unit_getFreeSlot(t);model.events.clearUnitPosition(e),model.events.createUnit(l,t,n,a,o.type.ID);var i=model.unit_data[l];i.hp=o.hp,i.ammo=o.ammo,i.fuel=o.fuel,i.exp=o.exp,i.type=o.type,i.x=n,i.y=a,i.loadedIn=o.loadedIn}),model.event_on("transferProperty_check",function(e){return model.property_data[e].type.notTransferable?!1:void 0}),model.event_on("transferProperty_addEntries",function(e,t){for(var o=0,n=4;n>o;o++)o!==e&&-1!==model.player_data[o].team&&t.addEntry(o,!0)}),model.event_on("transferProperty_invoked",function(e,t){var o=model.property_data[e];o.owner=t;var n,a,r=model.map_width,l=model.map_height;for(n=0;r>n;n++)for(a=0;l>a;a++)model.property_posMap[n][a]===o}),model.event_on("gameround_start",function(){model.timer_turnTimeElapsed=0,model.timer_gameTimeElapsed=0,model.timer_turnTimeLimit=6e4*controller.configValue("model.timer_turnTimeLimit"),model.timer_gameTimeLimit=6e4*controller.configValue("model.timer_gameTimeLimit")}),model.event_on("nextTurn_pidStartsTurn",function(){model.timer_turnTimeElapsed=0}),model.event_on("gameround_update",function(e){model.timer_turnTimeElapsed+=e,model.timer_gameTimeElapsed+=e,model.timer_turnTimeLimit>0&&model.timer_turnTimeElapsed>=model.timer_turnTimeLimit&&controller.commandStack_sharedInvokement("nextTurn_invoked"),model.timer_gameTimeLimit>0&&model.timer_gameTimeElapsed>=model.timer_gameTimeLimit&&controller.update_endGameRound()}),model.event_on("loadUnit_check",function(e,t){return model.transport_isTransportUnit(t)&&model.transport_canLoadUnit(e,t)?void 0:!1}),model.event_on("unloadUnit_check",function(e,t,o){var n,a=model.unit_data[e],r=a.owner;if(!model.transport_isTransportUnit(e)||!model.transport_hasLoads(e))return!1;for(var l=model.unit_firstUnitId(r),i=model.unit_lastUnitId(r);i>=l;l++)if(n=model.unit_data[l],-1!==n.owner&&n.loadedIn===e){var d=model.data_movetypeSheets[n.type.movetype];if(model.move_canTypeMoveTo(d,t-1,o))return;if(model.move_canTypeMoveTo(d,t+1,o))return;if(model.move_canTypeMoveTo(d,t,o-1))return;if(model.move_canTypeMoveTo(d,t,o+1))return}return!1}),model.event_on("loadUnit_invoked",function(e,t){assert(model.transport_canLoadUnit(e,t),"transporter unit",t,"cannot load unit",e),model.unit_data[e].loadedIn=t,model.unit_data[t].loadedIn--}),model.event_on("unloadUnit_addUnloadTargetsToMenu",function(e,t,o,n){for(var a,r=model.unit_data[e],l=r.owner,i=model.unit_firstUnitId(l),d=model.unit_lastUnitId(l);d>=i;i++)if(a=model.unit_data[i],-1!==a.owner&&a.loadedIn===e){var s=model.data_movetypeSheets[a.type.movetype];(model.move_canTypeMoveTo(s,t-1,o)||model.move_canTypeMoveTo(s,t+1,o)||model.move_canTypeMoveTo(s,t,o-1)||model.move_canTypeMoveTo(s,t,o+1))&&n.addEntry(i,!0)}}),model.event_on("unloadUnit_addUnloadTargetsToSelection",function(e,t,o,n,a){model.unit_data[e];var r=model.data_movetypeSheets[model.unit_data[n].type.movetype];model.move_canTypeMoveTo(r,t-1,o)&&a.setValueAt(t-1,o,1),model.move_canTypeMoveTo(r,t+1,o)&&a.setValueAt(t+1,o,1),model.move_canTypeMoveTo(r,t,o-1)&&a.setValueAt(t,o-1,1),model.move_canTypeMoveTo(r,t,o+1)&&a.setValueAt(t,o+1,1)}),model.event_on("unloadUnit_invoked",function(e,t,o,n,a,r){if(assert(model.unit_data[n].loadedIn===e),-1===a||-1===r||model.unit_posData[a][r])return controller.stateMachine.data.breakMultiStep=!0,void 0;model.unit_data[n].loadedIn=-1,model.unit_data[e].loadedIn++;var l;t>a?l=model.move_MOVE_CODES.LEFT:a>t?l=model.move_MOVE_CODES.RIGHT:o>r?l=model.move_MOVE_CODES.UP:r>o&&(l=model.move_MOVE_CODES.DOWN),controller.commandStack_localInvokement("move_clearWayCache"),controller.commandStack_localInvokement("move_appendToWayCache",l),controller.commandStack_localInvokement("move_moveByCache",n,t,o,1),controller.commandStack_localInvokement("wait_invoked",n)}),model.event_on("buildUnit_check",function(e,t){var o=controller.configValue("unitLimit"),n=model.unit_countUnits(t);return o||(o=9999999),n>=o?!1:n>=50?!1:void 0}),model.event_on("damageUnit",function(e,t,o){var n=model.unit_data[e];assert(n),n.hp-=t,o&&n.hp<=o?n.hp=o:n.hp<=0&&model.events.destroyUnit(e)}),model.event_on("healUnit",function(e,t,o){var n=model.unit_data[e];if(assert(n),n.hp+=t,n.hp>99){if(o===!0){var a=n.hp-99;model.player_data[n.owner].gold+=parseInt(n.type.cost*a/100,10)}n.hp=99}}),model.event_firstOn("createUnit",function(e,t,o,n,a){assert(-1===model.unit_data[e].owner);var r=model.data_unitSheets[a],l=model.unit_data[e];l.hp=99,l.owner=t,l.type=r,l.ammo=r.ammo,l.fuel=r.fuel,l.loadedIn=-1}),model.event_firstOn("destroyUnitSilent",function(e){var t=model.unit_data[e];t.owner=-1,1===controller.configValue("noUnitsLeftLoose")&&0===model.unit_countUnits(t.owner)&&controller.update_endGameRound()}),model.event_on("destroyUnit",function(e){model.events.destroyUnitSilent(e)}),model.event_on("weather_calculateNext",function(){var e,t;if(assert(controller.isHost()),null!==model.weather_data&&model.weather_data===model.data_defaultWeatherSheet){var o=model.data_nonDefaultWeatherTypes;e=o[parseInt(Math.random()*o.length,10)].ID,t=1}else e=model.data_defaultWeatherSheet.ID,t=controller.configValue("weatherMinDays")+parseInt(controller.configValue("weatherRandomDays")*Math.random(),10);controller.commandStack_sharedInvokement("weather_change",e),model.events.dayEvent(t,"weather_calculateNext")}),model.event_on("weather_change",function(e){model.weather_data=model.data_weatherSheets[e],model.events.recalculateFogMap()}),model.event_on("prepare_game",function(){for(var e=0,t=model.actions_leftActors.length;t>e;e++)model.actions_leftActors[e]=!1}),model.event_on("load_game",function(e){assert(Array.isArray(e.actr));for(var t=e.actr.length;t--;)assert(util.intRange(e.actr[t],0,50)),model.actions_leftActors[e.actr[t]]=!0}),model.event_on("save_game",function(e){for(var t=[],o=0,n=model.actions_leftActors.length;n>o;o++)model.actions_leftActors[o]&&t.push(o);e.actr=t}),model.event_on("prepare_game",function(){controller.buildRoundConfig(null)}),model.event_on("load_game",function(e){for(var t=Object.keys(e.cfg),o=t.length;o--;)assert(util.isInt(e.cfg[t[o]]));controller.buildRoundConfig(e.cfg)}),model.event_on("save_game",function(e){e.cfg=model.cfg_configuration}),model.event_on("prepare_game",function(){model.client_lastPid=-1}),model.event_on("prepare_game",function(){var e,t,o;for(t=0,o=4;o>t;t++)e=model.co_data[t],e.power=0,e.timesUsed=0,e.level=-1,e.coA=null,e.coB=null}),model.event_on("load_game",function(e){var t,o,n,a;for(assert(Array.isArray(e.co)&&4===e.co.length),n=0,a=4;a>n;n++)t=e.co[n],t>0&&(assert(util.intRange(t[0],0,999999)),assert(util.intRange(t[1],0,999999)),assert(util.intRange(t[2],model.co_MODES.NONE,model.co_MODES.AWDR)),assert(util.isString(t[3])&&model.data_coSheets.hasOwnProperty(t[3])),assert(util.isString(t[4])&&model.data_coSheets.hasOwnProperty(t[4])),o=model.co_data[n],o.power=t[0],o.timesUsed=t[1],o.level=t[2],o.coA=t[3]?model.data_coSheets[t[3]]:null,o.coB=t[4]?model.data_coSheets[t[4]]:null)}),model.event_on("save_game",function(e){for(var t,o=[],n=0,a=4;a>n;n++)t=model.co_data[n],-1===model.player_data[n].team?o.push(0):o.push([t.power,t.timesUsed,t.level,t.coA,t.coB]);e.co=o}),model.event_on("prepare_game",function(){model.dayTick_dataTime.resetValues(),model.dayTick_dataEvent.resetValues(),model.dayTick_dataArgs.resetValues()}),model.event_on("load_game",function(e){var t=0,o=e.dyev.length;for(assert(e.dyea.length===2*o);o>t;t++)assertInt(e.dyev[t]),assertStr(e.dyee[t]),assert(e.dyev[t]>0),model.dayTick_dataTime[t]=e.dyev[t],model.dayTick_dataEvent[t]=e.dyee[t],model.dayTick_dataArgs[2*t]=e.dyea[2*t],model.dayTick_dataArgs[2*t+1]=e.dyea[2*t+1]}),model.event_on("save_game",function(e){e.dyet=[],e.dyee=[],e.dyea=[];for(var t=0,o=model.dayTick_dataTime.length;o>t;t++)-1!==list[t]&&(e.dyet.push(list[t]),e.dyee.push(model.dayTick_dataEvent[t]),e.dyea.push(model.dayTick_dataArgs[2*t],model.dayTick_dataArgs[2*t+1]))}),model.event_on("prepare_game",function(){model.manpower_data.resetValues()}),model.event_on("load_game",function(e){assert(Array.isArray(e.manpower));var t=e.manpower.length-1;do assert(util.isInt(e.manpower[t])&&e.manpower[t]>=0),t--;while(t>=0);model.manpower_data.grabValues(e.manpower)}),model.event_on("save_game",function(e){e.mpw=model.manpower_data.cloneValues([])}),model.event_on("prepare_game",function(e){model.map_width=e.mpw,model.map_height=e.mph;for(var t=0,o=model.map_width;o>t;t++)for(var n=0,a=model.map_height;a>n;n++)model.unit_posData[t][n]=null,model.property_posMap[t][n]=null,model.map_data[t][n]=model.data_tileSheets[e.typeMap[e.map[t][n]]]}),model.event_on("save_game",function(e){e.mpw=model.map_width,e.mph=model.map_height,e.map=[];for(var t={},o=0,n=0,a=model.map_width;a>n;n++){e.map[n]=[];for(var r=0,l=model.map_height;l>r;r++){var i=e.map[n][r].ID;t.hasOwnProperty(i)||(t[i]=o,o++),e.map[n][r]=t[i]}}e.typeMap=[];for(var d=Object.keys(t),s=0,c=d.length;c>s;s++)e.typeMap[t[d[s]]]=d[s]}),model.event_on("prepare_game",function(e){assert(util.intRange(e.player,2,4));var t,o,n;for(o=0,n=4;n>o;o++)t=model.player_data[o],t.name=null,t.gold=0,t.team=o<=e.player-1?o:-2}),model.event_on("load_game",function(e){var t,o,n,a;for(n=0,a=e.players.length;a>n;n++)t=e.players[n],assert(util.intRange(t[0],0,3)),assert(util.isString(t[1])),assert(util.intRange(t[2],0,999999)),assert(util.intRange(t[3],0,3)),o=model.player_data[t[0]],o.name=t[1],o.gold=t[2],o.team=t[3]}),model.event_on("prepare_game",function(e){for(var t,o,n=0,a=model.property_data.length;a>n;n++)model.property_data[n].owner=-1,model.property_data[n].type=null;for(var n=0,a=e.prps.length;a>n;n++)o=e.prps[n],assert(util.intRange(o[0],0,299)),assert(util.intRange(o[1],0,99)),assert(util.intRange(o[2],0,99)),assert(util.isString(o[3])&&!util.isUndefined(model.data_tileSheets[o[3]].capturePoints)||"undefined"!=typeof model.data_tileSheets[o[3]].cannon||"undefined"!=typeof model.data_tileSheets[o[3]].laser||"undefined"!=typeof model.data_tileSheets[o[3]].rocketsilo),assert(util.intRange(o[4],1,model.data_tileSheets[o[3]].capturePoints)||util.intRange(o[4],-99,-1)||"undefined"!=typeof model.data_tileSheets[o[3]].rocketsilo),assert(util.intRange(o[5],-1,3)),t=model.property_data[o[0]],t.type=model.data_tileSheets[o[3]],t.capturePoints=20,t.owner=o[5],t.x=o[1],t.y=o[2],model.property_posMap[o[1]][o[2]]=t}),model.event_on("load_game",function(e){for(var t,o=0,n=e.prps.length;n>o;o++){var a=e.prps[o];t=model.property_data[a[0]],t.capturePoints=a[4]}}),model.event_on("save_game",function(e){var t;e.prps=[];for(var o=0,n=model.property_data.length;n>o;o++)t=model.property_data[o],-1!==t.owner&&e.prps.push([o,t.x,t.y,t.type.ID,t.capturePoints,t.owner])}),model.event_on("prepare_game",function(){model.round_turnOwner=-1,model.round_day=0}),model.event_on("load_game",function(e){assert(util.intRange(e.trOw,0,999999)),assert(util.intRange(e.day,0,999999)),model.round_turnOwner=e.trOw,model.round_day=e.day}),model.event_on("save_game",function(e){e.trOw=model.round_turnOwner,e.day=model.round_day}),model.event_on("prepare_game",function(){model.rule_map.resetValues()}),model.event_on("load_game",function(e){assert(util.isInt(e.gmTm)&&e.gmTm>=0),assert(util.isInt(e.tnTm)&&e.tnTm>=0),model.timer_gameTimeElapsed=e.gmTm,model.timer_turnTimeElapsed=e.tnTm}),model.event_on("save_game",function(e){e.gmTm=model.timer_gameTimeElapsed,e.tnTm=model.timer_turnTimeElapsed}),model.event_on("prepare_game",function(e){for(var t=0,o=model.unit_data.length;o>t;t++)model.unit_data[t].owner=-1;model.unit_posData.resetValues();var n;if(e.units){assert(Array.isArray(e.units));for(var t=0,o=e.units.length;o>t;t++){n=e.units[t],assert(util.isInt(n[0])),assert("string"==typeof n[1]),assert(model.data_unitSheets.hasOwnProperty(n[1]));var a=model.data_unitSheets[n[1]];assert(model.map_isValidPosition(n[2],n[3])),assert(util.intRange(n[4],1,99)),assert(util.intRange(n[5],0,a.ammo)),assert(util.intRange(n[6],0,a.fuel)),assert(util.isInt(n[7])),assert(util.intRange(n[8],-1,3));var r=n[0],l=model.unit_data[r];l.type=a,l.x=n[2],l.y=n[3],l.hp=n[4],l.ammo=n[5],l.fuel=n[6],l.loadedIn=n[7],l.owner=n[8],model.unit_posData[n[2]][n[3]]=l}}}),model.event_on("save_game",function(e){var t;e.units=[];for(var o=0,n=model.unit_data.length;n>o;o++)t=model.unit_data[o],-1!==t.owner&&e.units.push([model.unit_extractId(t),t.type.ID,t.x,t.y,t.hp,t.ammo,t.fuel,t.loadedIn,t.owner])}),model.event_on("prepare_game",function(){model.weather_data=model.data_defaultWeatherSheet}),model.event_on("load_game",function(e){assert(model.data_weatherSheets.hasOwnProperty(e.wth)),model.weather_data=model.data_weatherSheets[e.wth]}),model.event_on("save_game",function(e){e.wth=model.weather_data.ID}),model.event_on("parse_unit",function(e){if(assertIntRange(e.ammo,0,9),e.attack){util.isUndefined(e.attack.minRange)||(assertIntRange(e.attack.minRange,1,14),assertIntRange(e.attack.maxRange,2,15),assert(e.attack.maxRange>e.attack.minRange));for(var t=0,o=model.battle_WEAPON_KEYS.length;o>t;t++);}}),model.event_on("parse_tile",function(e){assertIntRange(e.defense,0,6)}),model.event_on("parse_tile",function(e){if(void 0!==e.suicide&&(assertIntRange(e.suicide.damage,1,9),assertIntRange(e.suicide.range,1,15),e.suicide.noDamage))for(var t=e.suicide.nodamage.length;t--;)assertStr(e.suicide.nodamage[t])}),model.event_on("parse_co",function(e){assertIntRange(e.coStars,-1,10),assertIntRange(e.scoStars,-1,10),assert(0!==e.coStars),assert(0!==e.scoStars),assertList(e.d2d),assertList(e.cop.turn),assertList(e.scop.turn),assert(e.cop.power),assert(e.scop.power),assertStr(e.faction),assertStr(e.music)}),model.event_on("parse_unit",function(e){assertIntRange(e.cost,0,999999)}),model.event_on("parse_tile",function(e){if(e.builds){assertList(e.builds);for(var t=e.builds.length;t--;)assertStr(e.builds[t])}}),model.event_on("parse_unit",function(e){assertIntRange(e.vision,1,15)}),model.event_on("parse_tile",function(e){void 0!==e.vision&&assertIntRange(e.vision,0,15)}),model.event_on("parse_movetype",function(e){var t,o,n,a;for(assert(e.costs),t=Object.keys(e.costs),n=t.length;n--;)o=t[n],assertStr(o),assert("*"===o||model.data_tileSheets.hasOwnProperty(o)),a=e.costs[o],assertIntRange(a,-1,15),assert(0!==a)}),model.event_on("parse_tile",function(e){void 0!==e.points&&assertIntRange(e.points,1,100),void 0!==e.funds&&assertIntRange(e.funds,1,99999)}),model.event_on("parse_unit",function(e){void 0!==e.captures&&assertIntRange(e.captures,1,10)}),model.supply_parseRepair_=function(e){var t,o;if(e.repairs)for(t=Object.keys(e.repairs),o=t.length;o--;)assertIntRange(e.repairs[t[o]],1,9)},model.event_on("parse_unit",function(e){var t;if(e.supply)for(t=e.supply.length;t--;)assertStr(e.supply[t]);model.supply_parseRepair_(e)}),model.event_on("parse_tile",model.supply_parseRepair_),model.event_on("parse_unit",function(e){if(e.canload){assertIntRange(e.maxloads,1,5),assertList(e.canload);for(var t=0,o=e.canload.length;o>t;t++)assertStr(e.canload[t])}}),model.event_on("parse_unit",function(e){assert(model.data_movetypeSheets.hasOwnProperty(e.movetype)),assertIntRange(e.range,0,15),assertIntRange(e.fuel,0,99),void 0!==e.stealth&&assertBool(e.stealth)}),model.event_on("parse_weather",function(e){void 0!==e.defaultWeather&&assertBool(e.defaultWeather)}),-controller.action_mapAction({key:"activatePower",condition:function(){return model.events.activatePower_check(model.round_turnOwner)},hasSubMenu:!0,prepareMenu:function(e){model.co_data[model.round_turnOwner],e.menu.addEntry("cop"),model.co_canActivatePower(model.round_turnOwner,model.co_POWER_LEVEL.SCOP)&&e.menu.addEntry("scop")
},invoke:function(e){var t;switch(e.action.selectedSubEntry){case"cop":t=model.co_POWER_LEVEL.COP;break;case"scop":t=model.co_POWER_LEVEL.SCOP;break;default:assert(!1)}controller.commandStack_sharedInvokement("activatePower_invoked",model.round_turnOwner,t)}}),controller.action_unitAction({key:"attachCommander",condition:function(){return model.events.attachCommander_check(model.round_turnOwner)},invoke:function(e){controller.commandStack_sharedInvokement("co_attachCommander",model.round_turnOwner,e.source.unitId)}}),controller.action_unitAction({key:"attack",relation:["S","T",model.player_RELATION_MODES.NONE,model.player_RELATION_MODES.SAME_OBJECT],targetSelectionType:"A",prepareTargets:function(e){model.battle_calculateTargets(e.source.unitId,e.target.x,e.target.y,e.selection)},condition:function(e){return model.events.attack_check(e.source.unitId,e.target.x,e.target.y,-1!==e.movePath.data[0])},invoke:function(e){-1!==e.targetselection.unitId?controller.commandStack_sharedInvokement("attack_invoked",e.source.unitId,e.targetselection.unitId,Math.round(100*Math.random()),Math.round(100*Math.random()),0):assert(!1,"no valid target")}}),controller.action_propertyAction({key:"buildUnit",condition:function(e){return model.events.buildUnit_check(e.source.propertyId,model.property_data[e.source.propertyId].owner)},hasSubMenu:!0,prepareMenu:function(e){model.factoryGenerateBuildMenu(e.source.propertyId,e.menu,!0)},invoke:function(e){controller.commandStack_sharedInvokement("buildUnit_invoked",e.source.x,e.source.y,e.action.selectedSubEntry)}}),controller.action_unitAction({key:"capture",relation:["S","T",model.player_RELATION_MODES.SAME_OBJECT,model.player_RELATION_MODES.NONE],relationToProp:["S","T",model.player_RELATION_MODES.ENEMY,model.player_RELATION_MODES.NONE],condition:function(e){return model.events.capture_check(e.target.propertyId,e.source.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("capture_invoked",e.target.propertyId,e.source.unitId)}}),controller.action_unitAction({key:"detachCommander",condition:function(){return model.events.detachCommander_check(model.round_turnOwner)},invoke:function(e){controller.commandStack_sharedInvokement("detachCommander_invoked",model.round_turnOwner,e.target.x,e.target.y)}}),controller.action_mapAction({key:"nextTurn",condition:function(){},invoke:function(){controller.commandStack_sharedInvokement("nextTurn_invoked")}}),controller.action_unitAction({key:"fireCannon",relation:["S","T",model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.fireCannon_check(e.source.unitId,e.selection)},targetSelectionType:"A",prepareTargets:function(e){model.events.fireCannon_fillTargets(e.source.unitId,e.selection)},invoke:function(e){controller.commandStack_sharedInvokement("fireCannon_invoked",e.target.x,e.target.y,e.targetselection.x,e.targetselection.y)}}),controller.action_unitAction({key:"fireLaser",relation:["S","T",model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.fireLaser_check(e.target.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("bombs_fireLaser",e.target.x,e.target.y)}}),controller.action_unitAction({key:"unitHide",relation:["S","T",model.player_RELATION_MODES.NONE,model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.unitHide_check(e.source.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("unitHide_invoked",e.source.unitId)}}),controller.action_unitAction({key:"joinUnits",noAutoWait:!0,relation:["S","T",model.player_RELATION_MODES.OWN],condition:function(e){return model.events.joinUnits_check(e.source.unitId,e.target.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("joinUnits_invoked",e.source.unitId,e.target.unitId),controller.commandStack_sharedInvokement("wait_invoked",e.target.unitId)}}),controller.action_unitAction({key:"loadUnit",relation:["S","T",model.player_RELATION_MODES.OWN],condition:function(e){return model.events.loadUnit_check(e.source.unitId,e.target.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("loadUnit_invoked",e.source.unitId,e.target.unitId)}}),controller.action_unitAction({key:"silofire",relation:["S","T",model.player_RELATION_MODES.SAME_OBJECT,model.player_RELATION_MODES.NONE],relationToProp:["S","T",model.player_RELATION_MODES.NONE],prepareSelection:function(e){e.selectionRange=e.target.property.type.rocketsilo.range},isTargetValid:function(e,t,o){return model.events.silofire_validPos(t,o)},condition:function(e){return model.events.silofire_check(e.target.propertyId,e.source.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("silofire_invoked",e.target.x,e.target.y,e.targetselection.x,e.targetselection.y,e.source.unit.owner)}}),controller.action_unitAction({key:"explode",noAutoWait:!0,relation:["S","T",model.player_RELATION_MODES.NONE,model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.explode_check(e.source.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("unit_destroySilently",e.source.unitId),controller.commandStack_sharedInvokement("explode_invoked",e.target.x,e.target.y,e.source.unit.type.suicide.range,model.unit_convertPointsToHealth(e.source.unit.type.suicide.damage),e.source.unit.owner)}}),controller.action_unitAction({key:"supplyUnit",relation:["S","T",model.player_RELATION_MODES.NONE,model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.supplyUnit_check(e.source.unitId,e.target.x,e.target.y)},invoke:function(e){controller.commandStack_sharedInvokement("supplyUnit_invoked",e.source.unitId)}}),controller.action_mapAction({key:"transferMoney",condition:function(e){return model.events.transferMoney_check(model.round_turnOwner,e.target.x,e.target.y)},hasSubMenu:!0,prepareMenu:function(e){model.events.transferMoney_addEntries(model.round_turnOwner,e.menu)},invoke:function(e){controller.commandStack_sharedInvokement("transferMoney_invoked",e.target.x,e.target.y,e.action.selectedSubEntry)}}),controller.action_propertyAction({key:"transferProperty",relationToProp:["S","T",model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.transferProperty_check(e.source.propertyId)},hasSubMenu:!0,prepareMenu:function(e){model.events.transferProperty_addEntries(e.source.property.owner,e.menu)},invoke:function(e){controller.commandStack_sharedInvokement("transferProperty_invoked",e.source.propertyId,e.action.selectedSubEntry)}}),controller.action_unitAction({key:"transferUnit",relation:["S","T",model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.transferUnit_check(e.source.unitId)},hasSubMenu:!0,prepareMenu:function(e){model.events.transferUnit_addEntries(e.source.unit.owner,e.menu)},invoke:function(e){controller.commandStack_sharedInvokement("transferUnit_invoked",e.source.unitId,e.action.selectedSubEntry)}}),controller.action_unitAction({key:"unitUnhide",relation:["S","T",model.player_RELATION_MODES.NONE,model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.unitUnhide_check(e.source.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("unitUnhide_invoked",e.source.unitId)}}),controller.action_unitAction({key:"unloadUnit",multiStepAction:!0,relation:["S","T",model.player_RELATION_MODES.SAME_OBJECT,model.player_RELATION_MODES.NONE],condition:function(e){return model.events.unloadUnit_check(e.source.unitId,e.target.x,e.target.y)},prepareMenu:function(e){model.events.unloadUnit_addUnloadTargetsToMenu(e.source.unitId,e.target.x,e.target.y,e.menu)},targetSelectionType:"B",prepareTargets:function(e){model.events.unloadUnit_addUnloadTargetsToSelection(e.source.unitId,e.target.x,e.target.y,e.action.selectedSubEntry,e.selection)},invoke:function(e){controller.commandStack_sharedInvokement("unloadUnit_invoked",e.source.unitId,e.target.x,e.target.y,e.action.selectedSubEntry,e.targetselection.x,e.targetselection.y)}}),controller.action_unitAction({key:"wait",noAutoWait:!0,relation:["S","T",model.player_RELATION_MODES.NONE,model.player_RELATION_MODES.SAME_OBJECT],condition:function(e){return model.events.wait_check(e.source.unitId)},invoke:function(e){controller.commandStack_sharedInvokement("wait_invoked",e.source.unitId)}}),util.scoped(function(){var e={data:util.list(20,null),size:0,clear:function(){this.size=0},addEntry:function(e){if(20===this.size)throw Error("full");this.data[this.size]=e,this.size++}};controller.ai_defineRoutine({key:"buildUnits",propAction:!0,scoring:function(t){var o=t.source.propertyId;if(t.source.unit)return-1;if(!model.factory_isFactory(o))return-1;if(!model.factory_canProduceSomething(o,model.property_data[o].owner))return-1;if(e.clear(),model.factoryGenerateBuildMenu(o,e),0===e.size)return-1;for(var n=model.player_data[t.source.property.owner].gold,a=parseInt(2*Math.random()*e.size,10),r=a;;){for(var l=0,i=e.size;i>l;l++){var d=model.data_unitSheets[e.data[l]];if(d.cost<=n&&(a--,0>a))return t.action.selectedSubEntry=d.ID,20}if(a===r)return-1}return-1},prepare:function(e){controller.action_objects.buildUnit.invoke(e)}})}),function(){controller.ai_defineRoutine({key:"captureProperties",unitAction:!0,scoring:function(e,t){if(t>=20)return-1;if(!e.source.unit.type.captures)return-1;var o=model.player_data[e.source.unit.owner].team,n=null,a=!1,r=model.property_posMap[e.source.x][e.source.y];if(r&&(-1===r.owner||model.player_data[r.owner].team!==o)&&model.property_isCapturableBy(model.property_extractId(r),e.source.unitId))n=r,e.target.set(e.source.x,e.source.y);else{var l,i,d,s,c=!1,m=e.selection.data;for(a=!0,l=0,s=m.length;s>l;l++){for(i=0,d=m[l].length;d>i;i++)if(m[l][i]>=0){if(model.unit_posData[l][i])continue;if(r=model.property_posMap[l][i],r&&(-1===r.owner||model.player_data[r.owner].team!==o)&&model.property_isCapturableBy(model.property_extractId(r),e.source.unitId)){n=r,e.target.set(l,i),c=!0;break}}if(c)break}if(!c)return-1}return n?(a?model.move_generatePath(e.source.x,e.source.y,e.target.x,e.target.y,e.selection,e.move):e.move.resetValues(-1),20):-1},prepare:function(e){var t=!1;-1!==e.move[0]&&(t=model.move_trapCheck(e.move,e.source,e.target),model.events.move_flushMoveData(e.move,e.source)),t?controller.commandStack_sharedInvokement("trapwait_invoked",e.source.unitId):(controller.commandStack_sharedInvokement("capture_invoked",e.target.propertyId,e.source.unitId),controller.commandStack_sharedInvokement("wait_invoked",e.source.unitId))}})}(),function(){function e(e,t,o){o.targetselection.set(e,t)}controller.ai_defineRoutine({key:"attackDirect",unitAction:!0,scoring:function(t,o){if(o>=5)return-1;if(!t.source.unit.type.attack)return-1;var n,a,r,l,i,d,s=!1,c=t.selection.data;for(n=0,l=c.length;l>n;n++){for(a=0,r=c[n].length;r>a;a++)if(c[n][a]>=0){if(model.unit_posData[n][a])continue;if(model.events.attack_check(t.source.unitId,n,a,!0)){i=n,d=a,s=!0;break}}if(s)break}return s?(model.move_generatePath(t.source.x,t.source.y,i,d,t.selection,t.move),model.battle_calculateTargets(t.source.unitId,i,d,t.selection,!1),t.selection.nextRandomPosition(e,t,1),-1===t.targetselection.unitId?-1:5):-1},prepare:function(e){var t=!1;-1!==e.move[0]&&(t=model.move_trapCheck(e.move,e.source,e.target),model.events.move_flushMoveData(e.move,e.source)),t?controller.commandStack_sharedInvokement("trapwait_invoked",e.source.unitId):(controller.commandStack_sharedInvokement("attack_invoked",e.source.unitId,e.targetselection.unitId,Math.round(100*Math.random()),Math.round(100*Math.random()),0),controller.commandStack_sharedInvokement("wait_invoked",e.source.unitId))}})}(),controller.ai_defineRoutine({key:"endTurn",mapAction:!0,endsAiTurn:!0,scoring:function(){return 1},prepare:function(){}}),function(){function e(e,t,o){o.targetselection.set(e,t)}controller.ai_defineRoutine({key:"attackFromCurrentPos",unitAction:!0,scoring:function(t,o){return o>=10?-1:t.source.unit.type.attack?model.events.attack_check(t.source.unitId,t.source.x,t.source.y,!1)?(model.battle_calculateTargets(t.source.unitId,t.source.x,t.source.y,t.selection,!1),t.selection.nextRandomPosition(e,t,1),-1===t.targetselection.unitId?-1:10):-1:-1},prepare:function(e){controller.commandStack_sharedInvokement("attack_invoked",e.source.unitId,e.targetselection.unitId,Math.round(100*Math.random()),Math.round(100*Math.random()),0),controller.commandStack_sharedInvokement("wait_invoked",e.source.unitId)}})}(),function(){function e(e,t,o){o.target.set(e,t)}controller.ai_defineRoutine({key:"moveRandom",unitAction:!0,scoring:function(t,o){if(o>=1)return-1;for(var n=0;;){if(n>=10)return-1;if(t.selection.nextRandomPosition(e,t,0)){if(!t.target.unit)break;n++}else n++}return model.move_generatePath(t.source.x,t.source.y,t.target.x,t.target.y,t.selection,t.move),model.move_trapCheck(t.move,t.source,t.target),1},prepare:function(e){model.events.move_flushMoveData(e.move,e.source),controller.commandStack_sharedInvokement("wait_invoked",e.source.unitId)}})}();