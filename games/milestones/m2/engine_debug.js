const DEBUG=!0,CWT_INACTIVE_ID=-1;var model={},controller={},view={},util={};util.fill=function(t,e){var o="function"==typeof e;if(t.__matrixArray__===!0)for(var r=0,n=t.length;n>r;r++)for(var i=0,l=t.length;l>i;i++)t[r][i]=o?e(r,i):e;else for(var r=0,n=t.length;n>r;r++)t[r]=o?e(r):e},util.list=function(t,e){void 0===e&&(e=null);for(var o="function"==typeof e,r=[],n=0;t>n;n++)r[n]=o?e(n):e;return r},util.matrix=function(t,e,o){void 0===o&&(o=null);for(var r="function"==typeof o,n=[],i=0;t>i;i++){n[i]=[];for(var l=0;e>l;l++)n[i][l]=r?o(i,l):o}return n.__matrixArray__=!0,n},util.illegalUnitIdError=function(){throw Error("illegal unit id")},util.illegalPropertyIdError=function(){throw Error("illegal unit id")},util.illegalArgumentError=function(){throw Error("illegal argument")},util.typeError=function(){throw Error("type error")},util.unexpectedSituationError=function(){throw Error("unexpected error")},util.illegalPositionError=function(){throw Error("illegal map position")},util.nullPointerError=function(){throw Error("null pointer")},util.isDefined=function(t){return void 0!==t&&null!==t},util.isFn=function(t){return"function"==typeof t},util.isNumber=function(t){return"number"==typeof t},util.isString=function(t){return"string"==typeof t},util.isBool=function(t){return"boolean"==typeof t},util.StringIdMapper=function(){this.map={},this._len=0},util.StringIdMapper.prototype.getIdFromKey=function(t){return this.map[t]},util.StringIdMapper.prototype.getKeyFromId=function(t){for(var e=this.map,o=Object.keys(e),r=0,n=o.length;n>r;r++)if(e[o[r]]===t)return o[r];return null},util.StringIdMapper.prototype.registerKey=function(t){if(this.map.hasOwnProperty(t))throw Error();this.map[t]=this._len,this._len++},util.i18n_data={en:{}},util.i18n_lang=util.i18n_data.en,util.i18n_localized=function(t){var e=this.i18n_lang[t];return void 0===e?t:e},util.i18n_setLanguage=function(t){if(!util.i18n_data.hasOwnProperty(t))throw Error("unknown language");util.i18n_lang=util.i18n_data[t]},util.i18n_appendToLanguage=function(t,e){util.i18n_data.hasOwnProperty(t)||(util.i18n_data[t]={});for(var o=util.i18n_data[t],r=Object.keys(e),n=0,i=r.length;i>n;n++)o[r[n]]=e[r[n]]},util.LOG_INFO=0,util.LOG_WARN=1,util.LOG_ERROR=2,util.logWriter=function(t,e){switch(t){case util.LOG_ERROR:console.error(e);break;case util.LOG_INFO:console.log(e);break;case util.LOG_WARN:console.warn(e);break;default:console.log(e)}},util.logInfo=function(t){arguments.length>1&&(t=Array.prototype.join.call(arguments," ")),util.logWriter(util.LOG_INFO,t)},util.logWarn=function(t){arguments.length>1&&(t=Array.prototype.join.call(arguments," ")),util.logWriter(util.LOG_WARN,t)},util.logError=function(t){arguments.length>1&&(t=Array.prototype.join.call(arguments," ")),util.logWriter(util.LOG_ERROR,t)},util.createRingBuffer=function(t){var e={push:function(t){if(null!==this._data[this._wInd])throw Error("message buffer is full");this._data[this._wInd]=t,this._wInd++,this._wInd===this._size&&(this._wInd=0)},isEmpty:function(){return null===this._data[this._rInd]},pop:function(){if(null===this._data[this._rInd])throw Error("message buffer is empty");var t=this._data[this._rInd];return this._data[this._rInd]=null,this._rInd++,this._rInd===this._size&&(this._rInd=0),t},clear:function(){this._rInd=0,this._wInd=0;for(var e=0;t>e;e++)this._data[e]=null}};return e._rInd=0,e._wInd=0,e._data=util.list(t,null),e._size=t,e},util.createStateMachine=function(t,e){return{state:function(){return t},event:function(o){util.logInfo("got event",o);var r=e[t][o];void 0===r&&util.illegalArgumentError("event "+o+" not defined "),t="function"==typeof r?r.apply(controller.input,arguments):r,util.logInfo("enter new state",t),e.hasOwnProperty(t)||util.illegalArgumentError("state "+t+" is not defined"),r=e[t].onenter,void 0!==r&&r.apply(controller.input,arguments),r=e[t].actionState,void 0!==r&&controller.input.event("actionState")}}},util.FUNCTION_TRUE_RETURNER=function(){return!0},util.FUNCTION_FALSE_RETURNER=function(){return!1},util.objectToJSON=function(t){return JSON.stringify(t)},util.replaceFunction=function(t,e){for(var o=t.split("."),r=window,n=0,i=o.length;i-1>n;n++)if(r=r[o[n]],void 0===r)throw Error("illegal given namespace: does not exists");var l=o[o.length-1],a=r[l];if("function"!=typeof a)throw Error("target object needs to be a function");var u=e(a);if("function"!=typeof u)throw Error("replacer factory needs to return a function");r[l]=u},model.map=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.mapHeight=-1,model.mapWidth=-1,model.distance=function(t,e,o,r){var n=Math.abs(t-o),i=Math.abs(e-r);return n+i},model.moveCodeFromAtoB=function(t,e,o,r){return 1!==model.distance(t,e,o,r)&&util.illegalArgumentError("both positions haven't a distance of 1"),t>o?model.MOVE_CODE_LEFT:o>t?model.MOVE_CODE_RIGHT:e>r?model.MOVE_CODE_UP:r>e?model.MOVE_CODE_DOWN:(util.unexpectedSituationError(),void 0)},model.isValidPosition=function(t,e){return t>=0&&e>=0&&model.mapWidth>t&&model.mapHeight>e},model.thereIsAnOwnUnitAt=function(t,e,o){if(!model.isValidPosition(t,e))return!1;var r=model.unitPosMap[t][e];return null!==r&&o===r.owner},model.thereIsAnAlliedUnitAt=function(t,e,o){if(!model.isValidPosition(t,e))return!1;var r=model.unitPosMap[t][e];return null!==r&&o!==r.owner&&model.players[o].team===model.players[r.owner].team},model.thereIsAnEnemyUnitAt=function(t,e,o){if(!model.isValidPosition(t,e))return!1;var r=model.unitPosMap[t][e];return null!==r&&o!==r.owner&&model.players[o].team!==model.players[r.owner].team},model.MOVE_CODE_UP=0,model.MOVE_CODE_RIGHT=1,model.MOVE_CODE_DOWN=2,model.MOVE_CODE_LEFT=3,model.fillMoveMap=function(t,e){var o=e.getSourceUnit(),r=model.sheets.unitSheets[o.type],n=model.sheets.movetypeSheets[r.moveType],i=model.players[o.owner],l=r.moveRange,a=e.getSourceX(),u=e.getSourceY();l>o.fuel&&(l=o.fuel),t.cleanIt(CWT_INACTIVE_ID,a,u),t.setPositionValue(a,u,l);for(var s=[a,u,l],c=[-1,-1,-1,-1,-1,-1,-1,-1];;){for(var d=-1,m=-1,p=0,g=s.length;g>p;p+=3){var h=s[p+2];void 0!==h&&null!==h&&(-1===d||h>d)&&(d=h,m=p)}if(-1===m)break;var _=s[m],f=s[m+1],E=s[m+2];s[m]=null,s[m+1]=null,s[m+2]=null,_>0?(c[0]=_-1,c[1]=f):(c[0]=-1,c[1]=-1),model.mapWidth-1>_?(c[2]=_+1,c[3]=f):(c[2]=-1,c[3]=-1),f>0?(c[4]=_,c[5]=f-1):(c[4]=-1,c[5]=-1),model.mapHeight-1>f?(c[6]=_,c[7]=f+1):(c[6]=-1,c[7]=-1);for(var A=0;8>A;A+=2)if(-1!==c[A]){var I=c[A],T=c[A+1],S=model.moveCosts(n,model.map[I][T]);if(0!==S){var y=model.unitPosMap[I][T];if(null!==y&&model.players[y.owner].team!==i.team)continue;var O=E-S;if(O>=0&&O>t.getPositionValue(I,T)){t.setPositionValue(I,T,O);for(var p=0,g=s.length;g>=p;p+=3)if(null===s[p]||p===g){s[p]=I,s[p+1]=T,s[p+2]=O;break}}}}}for(var a=0,v=model.mapWidth;v>a;a++)for(var u=0,P=model.mapHeight;P>u;u++)if(-1!==t.getPositionValue(a,u)){var S=model.moveCosts(n,model.map[a][u]);t.setPositionValue(a,u,S)}},model.addCodeToPath=function(t,e,o,r,n){var i=e.getSourceUnit().fuel,l=0,a=e.getMovePath();a.push(n);var u=model.sheets.unitSheets[e.getSourceUnit().type].moveRange;u>i&&(u=i);for(var s=e.getSourceX(),c=e.getSourceY(),d=0,m=a.length;m>d;d++){switch(a[d]){case model.MOVE_CODE_UP:c--;break;case model.MOVE_CODE_DOWN:c++;break;case model.MOVE_CODE_LEFT:s--;break;case model.MOVE_CODE_RIGHT:s++;break;default:util.illegalArgumentError()}l+=t.getPositionValue(s,c)}l>u&&model.setPathByRecalculation(t,e,o,r)},model.setPathByRecalculation=function(t,e,o,r){var n=e.getSourceX(),i=e.getSourceY(),l=e.getMovePath();util.logInfo("searching path from","(",n,",",i,")","to","(",o,",",r,")");var a=new Graph(t.getDataMatrix()),u=n-t.getCenterX(),s=i-t.getCenterY(),c=a.nodes[u][s],d=o-t.getCenterX(),m=r-t.getCenterY(),p=a.nodes[d][m],g=astar.search(a.nodes,c,p);util.logInfo("calculated way is",g);for(var h,_=[],f=n,E=i,A=0,I=g.length;I>A;A++){h=g[A];var T;if(h.x>f&&(T=model.MOVE_CODE_RIGHT),f>h.x&&(T=model.MOVE_CODE_LEFT),h.y>E&&(T=model.MOVE_CODE_DOWN),E>h.y&&(T=model.MOVE_CODE_UP),void 0===T)throw Error();_.push(T),f=h.x,E=h.y}l.splice(0);for(var A=0,I=_.length;I>A;A++)l[A]=_[A]},model.players=util.list(CWT_MAX_PLAYER+1,function(t){var e=t===CWT_MAX_PLAYER;return{gold:0,team:e?9999:CWT_INACTIVE_ID,name:e?"NEUTRAL":null}}),model.isNeutralPlayer=function(t){return model.neutralPlayerId===t},model.neutralPlayerId=model.players.length-1,model.alliedPlayers=function(t,e){return model.players[t].team===model.players[e].team},model.enemyPlayers=function(t,e){return model.players[t].team!==model.players[e].team},model.properties=util.list(CWT_MAX_PROPERTIES+1,function(){return{capturePoints:20,owner:-1}}),model.propertyPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.tileIsProperty=function(t,e){var o=model.propertyPosMap[t][e];return void 0!==o},model.extractPropertyId=function(t){if(null===t)throw Error("property argument cannot be null");for(var e=model.properties,o=0,r=e.length;r>o;o++)if(e[o]===t)return o;throw Error("cannot find property",t)},model.RELATIONSHIP_SAME_OWNER=0,model.RELATIONSHIP_ALLIED=1,model.RELATIONSHIP_ENEMY=2,model.RELATIONSHIP_NONE=3,model.RELATIONSHIP_SAME_OBJECT=4,model.relationshipBetween=function(t,e){if(null===t||null===e)return model.RELATIONSHIP_NONE;if("number"!=typeof t&&"number"!=typeof e&&t===e)return model.RELATIONSHIP_SAME_OBJECT;if("number"!=typeof t&&(t=t.owner),"number"!=typeof e&&(e=e.owner),t===e)return model.RELATIONSHIP_SAME_OWNER;var o=model.players[t],r=model.players[e];return o===r?model.RELATIONSHIP_ALLIED:model.RELATIONSHIP_ENEMY},model.day=0,model.turnOwner=-1,model.leftActors=util.list(CWT_MAX_UNITS_PER_PLAYER,!1),model.canAct=function(t){var e=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;if(t>=e+CWT_MAX_UNITS_PER_PLAYER||e>t)return!1;var o=t-e;return model.leftActors[o]===!0},model.isTurnOwner=function(t){return model.turnOwner===t},model.markAsUnusable=function(t){var t="number"==typeof t?t:model.extractUnitId(t),e=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;(t>=e+CWT_MAX_UNITS_PER_PLAYER||e>t)&&util.logError("unit owner is not the active player"),model.leftActors[t-e]=!1,util.logInfo("unit",t,"going into wait status")},model.sheets={},model.sheets._dbAmanda=amanda("json"),model.sheets.UNIT_TYPE_SHEET=0,model.sheets.TILE_TYPE_SHEET=1,model.sheets.WEAPON_TYPE_SHEET=2,model.sheets.WEATHER_TYPE_SHEET=3,model.sheets.MOVE_TYPE_SHEET=4,model.PRIMARY_WEAPON_TAG="mainWeapon",model.SECONDARY_WEAPON_TAG="subWeapon",model.sheets.unitSheets={},model.sheets.tileSheets={},model.sheets.weaponSheets={},model.sheets.weatherSheets={},model.sheets.movetypeSheets={},model.sheets.typeSheetValidators={unitValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},cost:{type:"integer",minimum:0},fuelConsumption:{type:"integer",minimum:0},maxAmmo:{type:"integer",minimum:0,maximum:99},maxFuel:{type:"integer",minimum:0,maximum:99,required:!0},moveRange:{type:"integer",minimum:0,maximum:15,required:!0},moveType:{type:"string",required:!0},weight:{type:"integer",required:!0}}},tileValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},capturePoints:{type:"integer",minimum:1,maximum:99},defense:{type:"integer",minimum:0,maximum:5}}},weaponValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},noMoveAndFire:{type:"boolean"}}},weatherValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0}}},movetypeValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},costs:{type:"object",patternProperties:{"[.]*":{type:"integer",minimum:0}}}}}},model.sheets.toJSON=function(){return void 0},model.parseSheet=function(t,e){var o,r,n,i=t.ID,l=model.sheets.typeSheetValidators;switch(e){case model.sheets.UNIT_TYPE_SHEET:o=l.unitValidator,r=model.sheets.unitSheets,n=l.unitValidator.properties.ID.except;break;case model.sheets.TILE_TYPE_SHEET:o=l.tileValidator,r=model.sheets.tileSheets,n=l.tileValidator.properties.ID.except;break;case model.sheets.WEAPON_TYPE_SHEET:o=l.weaponValidator,r=model.sheets.weaponSheets,n=l.weaponValidator.properties.ID.except;break;case model.sheets.WEATHER_TYPE_SHEET:o=l.weatherValidator,r=model.sheets.weatherSheets,n=l.weatherValidator.properties.ID.except;break;case model.sheets.MOVE_TYPE_SHEET:o=l.movetypeValidator,r=model.sheets.movetypeSheets,n=l.movetypeValidator.properties.ID.except;break;default:util.logError("unknow type",e)}r.hasOwnProperty(i)&&util.logError(i,"is already registered"),model.sheets._dbAmanda.validate(t,o,function(t){t&&util.logError("failed to parse sheet due",t.getMessages())}),r[i]=t,n.push(i)},model.getListOfUnitTypes=function(){return Object.keys(model.sheets.unitSheets)},model.getListOfPropertyTypes=function(){for(var t=model.sheets.tileSheets,e=Object.keys(t),o=[],r=e.length-1;r>=0;r--)t[e[r]].capturePoints>0&&o.push(e[r]);return o},model.getListOfTileTypes=function(){for(var t=model.sheets.tileSheets,e=Object.keys(t),o=[],r=e.length-1;r>=0;r--)void 0===t[e[r]].capturePoints&&o.push(e[r]);return o},model.primaryWeaponOfUnit=function(t){null===t&&util.illegalArgumentError(),"number"==typeof t&&(t=model.units[t]);var e=model.sheets.unitSheets[t.type][model.PRIMARY_WEAPON_TAG];return void 0!==e?model.sheets.weaponSheets[e]:null},model.secondaryWeaponOfUnit=function(t){null===t&&util.illegalArgumentError(),"number"==typeof t&&(t=model.units[t]);var e=model.sheets.unitSheets[t.type][model.SECONDARY_WEAPON_TAG];return void 0!==e?model.sheets.weaponSheets[e]:null},model.getBaseDamage=function(t,e){null===t&&util.illegalArgumentError(),null===e&&util.illegalArgumentError();var o;return o=t.damages[e],void 0!==o?o:(o=t.damages["*"],void 0!==o?o:0)},model.moveCosts=function(t,e){var o;return o=t.costs[e],void 0===o&&(o=t.costs["*"]),o},model.getLoadedIds=function(t){for(var e=[],o=model.units[t].owner,r=CWT_MAX_UNITS_PER_PLAYER*o,n=r+CWT_MAX_UNITS_PER_PLAYER;n>r;r++)if(r!==t){var i=model.units[r];null!==i&&i.loadedIn===t&&e.push(r)}return e},model.hasLoadedIds=function(t){for(var e=model.units[t].owner,o=CWT_MAX_UNITS_PER_PLAYER*e,r=o+CWT_MAX_UNITS_PER_PLAYER;r>o;o++)if(o!==t){var n=model.units[o];if(null!==n&&n.loadedIn===t)return!0}return!1},model.isLoadedBy=function(t,e){return model.units[t].loadedIn===e},model.loadUnitInto=function(t,e){model.canLoad(t,e)||util.logError("transporter unit",e,"cannot load unit",t),model.units[t].loadedIn=e},model.unloadUnitFrom=function(t){model.units[t].loadedIn=-1},model.canLoad=function(t,e){for(var o=model.units[e],r=model.units[t],n=0,i=CWT_MAX_UNITS_PER_PLAYER*o.owner,l=i+CWT_MAX_UNITS_PER_PLAYER;l>i;i++)if(i!==e){var a=model.units[i];null!==a&&a.loadedIn===e&&(n+=model.sheets.unitSheets[model.units[i].type].weight)}n+=model.sheets.unitSheets[r.type].weight;var u=model.sheets.unitSheets[o.type].transport;if(n>u.maxWeight)return!1;var s=model.sheets.unitSheets[model.units[t].type],c=u.canLoad;return-1!==c.indexOf(model.units[t].type)?!0:-1!==c.indexOf(s.moveType)?!0:-1!==c.indexOf("*")?!0:!1},model.isTransport=function(t){return void 0!==model.sheets.unitSheets[model.units[t].type].transport},model.unitPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.units=util.list(CWT_MAX_PLAYER*CWT_MAX_UNITS_PER_PLAYER,function(){return{x:0,y:0,hp:99,ammo:0,type:null,loadedIn:-1,fuel:0,owner:CWT_INACTIVE_ID,_clientData_:{}}}),model.extractUnitId=function(t){if(null===t)throw Error("unit argument cannot be null");for(var e=model.units,o=0,r=e.length;r>o;o++)if(e[o]===t)return o;throw Error("cannot find unit",JSON.stringify(t))},model.createUnit=function(t,e){for(var o=t*CWT_MAX_UNITS_PER_PLAYER,r=o,n=o+CWT_MAX_UNITS_PER_PLAYER;n>r;r++)if(model.units[r].owner===CWT_INACTIVE_ID){var i=model.sheets.unitSheets[e];return model.units[r].owner=t,model.units[r].hp=99,model.units[r].type=e,model.units[r].ammo=i.maxAmmo,model.units[r].fuel=i.maxFuel,model.units[r].loadedIn=-1,util.DEBUG&&util.logInfo("builded unit for player",t,"in slot",r),r}if(util.DEBUG)throw Error("cannot build unit for player",t,"no slots free");return-1},model.destroyUnit=function(t){model.eraseUnitPosition(t),model.units[t].owner=CWT_INACTIVE_ID},model.hasFreeUnitSlots=function(t){for(var e=t*CWT_MAX_UNITS_PER_PLAYER,o=0,r=e+CWT_MAX_UNITS_PER_PLAYER;r>o;o++)if(model.units[o].owner!==CWT_INACTIVE_ID)return!0;return!1},model.eraseUnitPosition=function(t){model.setUnitPosition(t)},model.setUnitPosition=function(t,e,o){var r=model.units[t],n=r.x,i=r.y;model.unitPosMap[n][i]=null,arguments.length>1&&(r.x=e,r.y=o,model.unitPosMap[e][o]=r)},model.tileOccupiedByUnit=function(t,e){var o=model.unitPosMap[t][e];return null===o?!1:model.extractUnitId(o)},controller._actionDataPool=util.createRingBuffer(50),controller.aquireActionDataObject=function(){var t=controller._actionDataPool;return t.isEmpty()?new controller.ActionData:t.pop()},controller.releaseActionDataObject=function(t){!t instanceof controller.ActionData&&util.illegalArgumentError(),t.cleanIt(),controller._actionDataPool.push(t)},controller.ActionData=function(){this.data=[],this.cleanIt()},controller.ActionData.prototype.cleanIt=function(){this.data[0]=-1,this.data[1]=-1,this.data[2]=-1,this.data[3]=-1,this.data[4]=-1,this.data[5]=-1,this.data[6]=-1,this.data[7]=-1,this.data[8]=-1,this.data[9]=-1,this.data[10]=null,this.data[11]=null,this.data[12]=null},controller.ActionData.prototype.setSource=function(t,e){this.data[0]=t,this.data[1]=e},controller.ActionData.prototype.getSourceX=function(){return this.data[0]},controller.ActionData.prototype.getSourceY=function(){return this.data[1]},controller.ActionData.prototype.setTarget=function(t,e){this.data[2]=t,this.data[3]=e},controller.ActionData.prototype.getTargetX=function(){return this.data[2]},controller.ActionData.prototype.getTargetY=function(){return this.data[3]},controller.ActionData.prototype.setActionTarget=function(t,e){this.data[4]=t,this.data[5]=e},controller.ActionData.prototype.getActionTargetX=function(){return this.data[4]},controller.ActionData.prototype.getActionTargetY=function(){return this.data[5]},controller.ActionData.prototype.setSourceUnit=function(t){this.data[6]=null===t?-1:model.extractUnitId(t)},controller.ActionData.prototype.getSourceUnit=function(){var t=this.data[6];return-1===t?null:model.units[t]},controller.ActionData.prototype.getSourceUnitId=function(){return this.data[6]},controller.ActionData.prototype.setSourceProperty=function(t){this.data[7]=null===t?-1:model.extractPropertyId(t)},controller.ActionData.prototype.getSourceProperty=function(){var t=this.data[7];return-1===t?null:model.properties[t]},controller.ActionData.prototype.getSourcePropertyId=function(){return this.data[7]},controller.ActionData.prototype.setTargetUnit=function(t){this.data[8]=null===t?-1:model.extractUnitId(t)},controller.ActionData.prototype.getTargetUnit=function(){var t=this.data[8];return-1===t?null:model.units[t]},controller.ActionData.prototype.getTargetUnitId=function(){return this.data[8]},controller.ActionData.prototype.setTargetProperty=function(t){this.data[9]=null===t?-1:model.extractPropertyId(t)},controller.ActionData.prototype.getTargetProperty=function(){var t=this.data[9];return-1===t?null:model.properties[t]},controller.ActionData.prototype.getTargetPropertyId=function(){return this.data[9]},controller.ActionData.prototype.setMovePath=function(t){this.data[10]=t},controller.ActionData.prototype.getMovePath=function(){return this.data[10]},controller.ActionData.prototype.setAction=function(t){this.data[11]=t},controller.ActionData.prototype.getAction=function(){return this.data[11]},controller.ActionData.prototype.setSubAction=function(t){this.data[12]=t},controller.ActionData.prototype.getSubAction=function(){return this.data[12]},controller.ActionData.prototype.getCopy=function(){var t=controller.aquireActionDataObject();return t.data[0]=this.data[0],t.data[1]=this.data[1],t.data[2]=this.data[2],t.data[3]=this.data[3],t.data[4]=this.data[4],t.data[5]=this.data[5],t.data[6]=this.data[6],t.data[7]=this.data[7],t.data[8]=this.data[8],t.data[9]=this.data[9],t.data[10]=this.data[10],t.data[11]=this.data[11],t.data[12]=this.data[12],t},controller.commands={},controller.commandBuffer=util.createRingBuffer(200),controller.registerCommand=function(t){util.isString(t.key)||util.illegalArgumentError(),util.isFn(t.action)||util.illegalArgumentError(),util.isFn(t.condition)||util.illegalArgumentError();for(var e={prepareMenu:null,prepareTargets:null,localAction:!1,multiStepAction:!1,condition:util.FUNCTION_TRUE_RETURNER},o=t.key,r=Object.keys(t),n=0,i=r.length;i>n;n++)e[r[n]]=t[r[n]];controller.commands[o]=e},controller.invokeCommand=function(t,e){1===arguments.length&&(e=t.getAction()),util.isString(e)||util.illegalArgumentError(),util.isDefined(t)||util.illegalArgumentError();var o=controller.commands[e];null!==t.getMovePath()&&controller.commands.move.action.apply(o,[t]),o.action.apply(o,[t])},controller.isNetworkGame=function(){return!1},controller._parseNetworkMessage=function(){util.unexpectedSituationError()},controller._sendNetworkMessage=function(){util.unexpectedSituationError()},controller.pushActionDataIntoBuffer=function(t,e){if(util.logInfo("pushing command into buffer...\n","source (",t.getSourceX(),",",t.getSourceY(),")\n","target (",t.getTargetX(),",",t.getTargetY(),")\n","action target (",t.getActionTargetX(),",",t.getActionTargetY(),")\n","selected unit id",t.getSourceUnitId(),"\n","selected property id",t.getSourcePropertyId(),"\n","target unit id",t.getTargetUnitId(),"\n","target property id",t.getTargetPropertyId(),"\n","selected action",t.getAction(),"\n","sub menu action",t.getSubAction(),"\n","move path",t.getMovePath()),controller.commandBuffer.push(t),e!==!0&&this.isNetworkGame()){var o=controller.commands[t.getAction()];o.localAction!==!1&&this._sendNetworkMessage(t)}},controller.getActionObject=function(t){return controller.commands[t]},controller.isBufferEmpty=function(){return controller.commandBuffer.isEmpty()},controller.evalNextMessageFromBuffer=function(){if(controller.commandBuffer.isEmpty())return null;var t=controller.commandBuffer.pop();return util.logInfo("pushing command into buffer...\n","source (",t.getSourceX(),",",t.getSourceY(),")\n","target (",t.getTargetX(),",",t.getTargetY(),")\n","action target (",t.getActionTargetX(),",",t.getActionTargetY(),")\n","selected unit id",t.getSourceUnitId(),"\n","selected property id",t.getSourcePropertyId(),"\n","target unit id",t.getTargetUnitId(),"\n","target property id",t.getTargetPropertyId(),"\n","selected action",t.getAction(),"\n","sub menu action",t.getSubAction(),"\n","move path",t.getMovePath()),controller.invokeCommand(t),t},controller.saveDOM=function(){return JSON.stringify(model)},controller.loadDOM=function(t){if("string"==typeof t){try{t=JSON.parse(t)}catch(e){if(util.DEBUG)throw Error("got invalid json save data")}throw Error("niy")}},controller.loadMod=function(t){var e;e=t.movetypes;for(var o=0,r=e.length;r>o;o++)model.parseSheet(e[o],model.MOVE_TYPE_SHEET);e=t.weapons;for(var o=0,r=e.length;r>o;o++)model.parseSheet(e[o],model.WEAPON_TYPE_SHEET);e=t.tiles;for(var o=0,r=e.length;r>o;o++)model.parseSheet(e[o],model.TILE_TYPE_SHEET);e=t.units;for(var o=0,r=e.length;r>o;o++)model.parseSheet(e[o],model.UNIT_TYPE_SHEET);var n=t.locale;if(void 0!==n)for(var i=Object.keys(n),o=0,r=i.length;r>o;o++)util.i18n_appendToLanguage(i[o],n[i[o]])},controller.idHolder=new util.StringIdMapper,controller.input=util.createStateMachine("NONE",{NONE:{start:function(){return this.menu=util.list(20,null),this.menuSize=0,this.inMultiStep=!1,this.actionData=controller.aquireActionDataObject(),this.selectionData=new controller.SelectionData(CWT_MAX_MOVE_RANGE),"IDLE"}},IDLE:{onenter:function(){this.menuSize=0,this.inMultiStep=!1,this.actionData.cleanIt()},action:function(t,e,o){this._checkClickEventArgs(t,e,o);var r,n=this.actionData;return n.setSource(e,o),null!==(r=model.unitPosMap[e][o])&&n.setSourceUnit(r),null!==(r=model.propertyPosMap[e][o])&&n.setSourceProperty(r),n.getSourceUnitId()!==CWT_INACTIVE_ID&&n.getSourceUnit().owner===model.turnOwner&&model.canAct(n.getSourceUnitId())?(n.setTarget(e,o),n.setMovePath([]),model.fillMoveMap(this.selectionData,n),"MOVEPATH_SELECTION"):(this._prepareMenu(),"ACTION_MENU")},cancel:function(){return"IDLE"}},MOVEPATH_SELECTION:{action:function(t,e,o){if(controller.input._checkClickEventArgs(t,e,o),0>this.selectionData.getPositionValue(e,o))return CLIENT_DEBUG&&util.logInfo("break event because selection is not in the map"),"MOVEPATH_SELECTION";var r=this.actionData,n=r.getTargetX(),i=r.getTargetY(),l=model.distance(n,i,e,o);if(r.setTarget(e,o),0===l){util.fill(this.menu,null),this.menuSize=0;var a;return null!==(a=model.unitPosMap[e][o])&&this.actionData.setTargetUnit(a),null!==(a=model.propertyPosMap[e][o])&&this.actionData.setTargetProperty(a),this._prepareMenu(),"ACTION_MENU"}if(1===l){var u=model.moveCodeFromAtoB(n,i,e,o);return model.addCodeToPath(this.selectionData,r,e,o,u),"MOVEPATH_SELECTION"}return model.setPathByRecalculation(this.selectionData,r,e,o),"MOVEPATH_SELECTION"},cancel:function(){var t=this.actionData;return t.setTarget(-1,-1),t.setTargetProperty(null),t.setTargetUnit(null),"IDLE"}},ACTION_MENU:{action:function(t,e){controller.input._checkMenuEventArgs(t,e);var o=this.menu[e],r=controller.getActionObject(o);return this.actionData.setAction(o),null!==r.prepareMenu?(util.fill(this.menu,null),this.menuSize=0,r.prepareMenu(this.actionData,controller.input._addMenuEntry),"ACTION_SUBMENU"):null!==r.prepareTargets?controller.input._prepareSelection(r,"ACTION_MENU"):"FLUSH_ACTION"},cancel:function(){var t=this.actionData;t.setTarget(-1,-1),t.setTargetProperty(null),t.setTargetUnit(null);var t=this.actionData;return t.getSourceUnitId()!==CWT_INACTIVE_ID&&t.getSourceUnit().owner===model.turnOwner&&model.canAct(t.getSourceUnitId())?"MOVEPATH_SELECTION":"IDLE"}},ACTION_SUBMENU:{action:function(t,e){controller.input._checkMenuEventArgs(t,e);var o=this.menu[e];if("done"===o)return"IDLE";var r=controller.getActionObject(this.actionData.getAction());return this.actionData.setSubAction(o),null!==r.prepareTargets?controller.input._prepareSelection(r,"ACTION_SUBMENU"):"FLUSH_ACTION"},cancel:function(){return this.inMultiStep?"ACTION_SUBMENU":(util.fill(this.menu,null),this.menuSize=0,this._prepareMenu(),"ACTION_MENU")}},ACTION_SELECT_TARGET:{action:function(t,e,o){if(controller.input._checkClickEventArgs(t,e,o),0>this.selectionData.getPositionValue(e,o))return CLIENT_DEBUG&&util.logInfo("break event because selection is not in the map"),"ACTION_SELECT_TARGET";this.actionData.setActionTarget(e,o);var r;return null!==(r=model.unitPosMap[e][o])?this.actionData.setTargetUnit(r):this.actionData.setTargetUnit(null),null!==(r=model.propertyPosMap[e][o])?this.actionData.setTargetProperty(r):this.actionData.setTargetProperty(null),"FLUSH_ACTION"},cancel:function(){return this._last}},FLUSH_ACTION:{actionState:function(){var t=this.actionData.getAction(),e=controller.getActionObject(t);if(controller.pushActionDataIntoBuffer(this.actionData.getCopy()),e.multiStepAction){this.inMultiStep=!0;var o=controller.aquireActionDataObject();return o.setAction("invokeMultiStepAction"),controller.pushActionDataIntoBuffer(o),"MULTISTEP_IDLE"}return"IDLE"}},MULTISTEP_IDLE:{nextStep:function(){var t=this.actionData.getAction(),e=controller.getActionObject(t);return this.menuSize=0,this.actionData.setMovePath(null),util.fill(this.menu,null),e.prepareMenu(this.actionData,controller.input._addMenuEntry),controller.input._addMenuEntry("done"),this.menuSize>1?"ACTION_SUBMENU":"IDLE"}}}),controller.input._addMenuEntry=function(t){controller.input.menuSize===controller.input.menu.length&&util.unexpectedSituationError(),controller.input.menu[controller.input.menuSize]=t,controller.input.menuSize++},controller.input._prepareSelection=function(t,e){var o=this.actionData.getTargetX(),r=this.actionData.getTargetY();return this._last=e,this.selectionData.cleanIt(-1,o,r),t.prepareTargets(this.actionData,this.selectionData),"ACTION_SELECT_TARGET"},controller.input._checkMenuEventArgs=function(t,e){util.isNumber(e)||util.illegalArgumentError(),(0>e||e>=this.menu.length)&&util.illegalArgumentError()},controller.input._checkClickEventArgs=function(t,e,o){util.isNumber(e)&&util.isNumber(o)||util.illegalArgumentError(),model.isValidPosition(e,o)||util.illegalPositionError()},controller.input._prepareMenu=function(){var t=this.actionData,e=controller.input._addMenuEntry,o=Object.keys(controller.commands),r=!0,n=t.getSourceUnit();null===n||n.owner!==model.turnOwner?r=!1:model.canAct(t.getSourceUnitId())||(r=!1);var i=!0,l=t.getSourceProperty();null!==n&&(i=!1),(null===l||l.owner!==model.turnOwner)&&(i=!1);for(var a=0,u=o.length;u>a;a++){var s=controller.getActionObject(o[a]);(s.unitAction!==!0||r)&&(s.propertyAction!==!0||i)&&s.condition(t)&&e(o[a])}},controller.SelectionData=function(t){var e=2*t+1;this.data=[util.matrix(e,e,0),0,0]},controller.SelectionData.prototype.cleanIt=function(t,e,o){for(var r=this.data[0],n=r.length,i=0;n>i;i++)for(var l=0;n>l;l++)r[i][l]=t;this.data[1]=Math.max(0,e-CWT_MAX_SELECTION_RANGE),this.data[2]=Math.max(0,o-CWT_MAX_SELECTION_RANGE)},controller.SelectionData.prototype.setPositionValue=function(t,e,o){var r=this.data[0],n=this.data[1],i=this.data[2];t-=i,e-=n;var l=r.length;0>t||0>e||t>=l||e>=l?util.illegalPositionError():r[t][e]=o},controller.SelectionData.prototype.getPositionValue=function(t,e){var o=this.data[0],r=this.data[1],n=this.data[2];t-=n,e-=r;var i=o.length;return 0>t||0>e||t>=i||e>=i?-1:o[t][e]},controller.SelectionData.prototype.getCenterX=function(){return this.data[1]},controller.SelectionData.prototype.getCenterY=function(){return this.data[1]},controller.SelectionData.prototype.getDataMatrix=function(){return this.data[0]},controller.registerCommand({key:"attack",unitAction:!0,targetSelection:!0,hasSubMenu:!0,hasTargets:function(t,e,o,r){2===arguments.length&&(o=t.x,r=t.y);var n=t.owner,i=model.players[t.owner].team,l=model.sheets.unitSheets[t.type],a=model.sheets.weaponSheets[e===model.PRIMARY_WEAPON_TAG?l[model.PRIMARY_WEAPON_TAG]:l[model.SECONDARY_WEAPON_TAG]];if(void 0===a)return!1;var u,s,c=a.minRange,d=a.maxRange,m=r-d,p=r+d;for(0>m&&(m=0),p>=model.mapHeight&&(p=model.mapHeight-1);p>=m;m++){var g=Math.abs(m-r);for(u=o-d+g,s=o+d-g,0>u&&(u=0),s>=model.mapWidth&&(s=model.mapWidth-1);s>=u;u++)if(model.distance(o,r,u,m)>=c){var h=model.unitPosMap[u][m];if(null!==h&&h.owner!==n&&model.players[h.owner].team!==i){var _=model.getBaseDamage(a,h.type);if(_>0)return!0}}}},prepareMenu:function(t,e){var o=t.getSourceUnit(),r=t.getTargetX(),n=t.getTargetY();this.hasTargets(o,model.PRIMARY_WEAPON_TAG,r,n,!0)&&e("mainWeapon"),this.hasTargets(o,model.SECONDARY_WEAPON_TAG,r,n,!0)&&e("subWeapon")},prepareTargets:function(t,e){var o,r,n=t.getSourceUnit(),i=t.getSubAction(),l=t.getTargetX(),a=t.getTargetY(),u="mainWeapon"===i?model.primaryWeaponOfUnit(n):model.secondaryWeaponOfUnit(n),s=n.owner,c=model.players[n.owner].team,d=u.minRange,m=u.maxRange,p=a-m,g=a+m;for(0>p&&(p=0),g>=model.mapHeight&&(g=model.mapHeight-1);g>=p;p++){var h=Math.abs(p-a);for(o=l-m+h,r=l+m-h,0>o&&(o=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=o;o++)if(model.distance(l,a,o,p)>=d){var _=model.unitPosMap[o][p];if(null!==_&&_.owner!==s&&model.players[_.owner].team!==c){var f=model.getBaseDamage(u,_.type);f>0&&(util.logInfo("found target at (",o,",",p,")"),e.setPositionValue(o,p,1))}}}},condition:function(t){var e=t.getSourceUnit(),o=t.getTargetX(),r=t.getTargetY();return null!==model.primaryWeaponOfUnit(e)&&this.hasTargets(e,model.PRIMARY_WEAPON_TAG,o,r,!0)||null!==model.secondaryWeaponOfUnit(e)&&this.hasTargets(e,model.SECONDARY_WEAPON_TAG,o,r,!0)?!0:!1},action:function(t){var e=t.getSourceUnit(),o=t.getTargetUnit(),r=t.getSubAction(),n="mainWeapon"===r?model.primaryWeaponOfUnit(e):model.secondaryWeaponOfUnit(e),i=null,l=model.getBaseDamage(n,o.type),a=0;o.hp-=l,0!==n.useAmmo&&e.ammo--,0>o.hp?model.destroyUnit(model.extractUnitId(o)):null!==i&&(e.hp-=a,0!==i.useAmmo&&o.ammo--,0>e.hp&&model.destroyUnit(model.extractUnitId(e))),controller.invokeCommand(t,"wait")
}}),controller.registerCommand({key:"buildUnit",propertyAction:!0,hasSubMenu:!0,canPropTypeBuildUnitType:function(t,e){var o=model.sheets.tileSheets[t],r=o.builds;if(void 0===r)return!1;if(-1!==r.indexOf("*"))return!0;if(-1!==r.indexOf(e))return!0;var n=model.sheets.unitSheets[e],i=n.moveType;return-1!==r.indexOf(i)?!0:!1},getBuildList:function(t){var e=[],o=model.getListOfUnitTypes(),r=model.properties[t];model.sheets.tileSheets[r.type];for(var n=model.players[model.turnOwner].gold,i=0,l=o.length;l>i;i++)this.canPropTypeBuildUnitType(r.type,o[i])&&n>=model.sheets.unitSheets[o[i]].cost&&e.push(o[i]);return e},prepareMenu:function(t,e){var o=t.getSourceProperty();null===o&&util.illegalArgumentError();for(var r=this.getBuildList(model.extractPropertyId(o)),n=0,i=r.length;i>n;n++)e(r[n])},condition:function(t){return t.getSourceProperty(),model.hasFreeUnitSlots(model.turnOwner)&&this.getBuildList(model.extractPropertyId(t.getSourceProperty())).length>0},action:function(t){var e=t.getSourceX(),o=t.getSourceY(),r=t.getSubAction(),n=model.createUnit(model.turnOwner,r);model.setUnitPosition(n,e,o);var i=model.players[model.turnOwner];i.gold-=model.sheets.unitSheets[r].cost;var l=controller.aquireActionDataObject();l.setSourceUnit(model.units[n]),l.setAction("wait"),controller.invokeCommand(l)}}),controller.registerCommand({key:"captureProperty",unitAction:!0,condition:function(t){var e=t.getSourceUnit(),o=t.getTargetUnit(),r=t.getTargetProperty();return null!==r&&model.turnOwner!==r.owner&&(null===o||o===e)&&model.sheets.tileSheets[r.type].capturePoints>0&&model.sheets.unitSheets[e.type].captures>0},action:function(t){var e=t.getSourceUnit(),o=t.getTargetProperty(),r=model.sheets.unitSheets[e.type];if(o.capturePoints-=r.captures,0>=o.capturePoints){var n=t.getTargetX(),i=t.getTargetY();if(util.logInfo("property at (",n,",",i,") captured"),"HQTR"===o.type){for(var l=o.owner,a=model.players[l],u=l*CWT_MAX_UNITS_PER_PLAYER,s=u+CWT_MAX_UNITS_PER_PLAYER;s>u;u++)model.units[u].owner=-1,model.eraseUnitPosition(u);for(var u=0,s=model.properties.length;s>u;u++)model.properties[u].owner===l&&(model.properties[u].owner=-1);a.team=-1;for(var c=-1,u=0,s=model.players.length;s>u;u++){var d=model.players[u];if(-1!==d.team)if(-1===c)c=d.team;else if(c!==d.team){c=-1;break}}if(-1!==c){var m=controller.aquireActionDataObject();m.setAction("endGame"),controller.pushActionDataIntoBuffer(m,!0)}}o.capturePoints=20,o.owner=e.owner}controller.invokeCommand(t,"wait")}}),controller.registerCommand({key:"endGame",condition:util.FUNCTION_FALSE_RETURNER,action:function(){util.logInfo("the game ends because no opposite players exists")}}),controller.registerCommand({key:"healUnit",condition:function(){return!1},action:function(t){var e=t.getTargetUnit(),o=20;e.hp+=o,e.hp>99&&(e.hp=99)}}),controller.registerCommand({key:"invokeMultiStepAction",condition:util.FUNCTION_FALSE_RETURNER,action:function(){controller.input.event("nextStep")}}),controller.registerCommand({key:"join",unitAction:!0,condition:function(t){var e=t.getSourceUnit(),o=t.getTargetUnit();return null===o||o.owner!==model.turnOwner||o===e?!1:e.type===o.type&&89>o.hp},action:function(t){var e=t.getSourceUnit(),o=t.getTargetUnit(),r=model.sheets.unitSheets[o.type];o.hp+=e.hp,o.hp>99&&(o.hp=99),o.ammo+=e.ammo,o.ammo>r.maxAmmo&&(o.ammo=r.maxAmmo),o.fuel+=e.fuel,o.fuel>r.maxFuel&&(o.fuel=r.maxFuel),model.destroyUnit(model.extractUnitId(e)),t.setSourceUnit(o),controller.invokeCommand(t,"wait")}}),controller.registerCommand({key:"loadGame",_copyProps:function(t,e){for(var o=Object.keys(t),r=0,n=o.length;n>r;r++)e[o[r]]=t[o[r]]},condition:util.FUNCTION_FALSE_RETURNER,action:function(t){util.DEBUG&&util.logInfo("start loading game instance");var e=this._copyProps,o=t.getSubAction();model.mapHeight=o[controller.SERIALIZATION_MAP_H],model.mapWidth=o[controller.SERIALIZATION_MAP_W];for(var r=0,n=model.mapWidth;n>r;r++)for(var i=0,l=model.mapHeight;l>i;i++)model.map[r][i]=o[controller.SERIALIZATION_MAP][r][i];for(var a=0,u=model.units.length;u>a;a++){var s=model.units[a];o[controller.SERIALIZATION_UNITS].hasOwnProperty(a)?e(o[controller.SERIALIZATION_UNITS][a],s):s.owner=CWT_INACTIVE_ID}for(var r=0,n=model.mapWidth;n>r;r++)for(var i=0,l=model.mapHeight;l>i;i++)model.unitPosMap[r][i]=null;var c;c=Object.keys(o[controller.SERIALIZATION_UNITS_POS]);for(var a=0,u=c.length;u>a;a++){var d=c[a].split(","),r=parseInt(d[0],10),i=parseInt(d[1],10);model.unitPosMap[r][i]=model.units[o[controller.SERIALIZATION_UNITS_POS][c[a]]]}for(var a=0,u=model.properties.length;u>a;a++){var m=model.properties[a];o[controller.SERIALIZATION_PROPS].hasOwnProperty(a)?e(o[controller.SERIALIZATION_PROPS][a],m):m.owner=CWT_INACTIVE_ID}for(var r=0,n=model.mapWidth;n>r;r++)for(var i=0,l=model.mapHeight;l>i;i++)model.propertyPosMap[r][i]=null;c=Object.keys(o[controller.SERIALIZATION_PROPS_POS]);for(var a=0,u=c.length;u>a;a++){var d=c[a].split(","),r=parseInt(d[0],10),i=parseInt(d[1],10);model.propertyPosMap[r][i]=model.properties[o[controller.SERIALIZATION_PROPS_POS][c[a]]]}if(model.day=o[controller.SERIALIZATION_DAY],model.turnOwner=o[controller.SERIALIZATION_TURNOWNER],void 0!==o[controller.SERIALIZATION_LEFTACTORS])for(var a=0,u=o[controller.SERIALIZATION_LEFTACTORS].length;u>a;a++)model.leftActors[a]=o[controller.SERIALIZATION_LEFTACTORS][a];else util.fill(model.leftActors,!0);for(var a=0,u=model.players.length;u>a;a++){var p=model.players[a];o[controller.SERIALIZATION_PLAYERS].hasOwnProperty(a)?e(o[controller.SERIALIZATION_PLAYERS][a],p):p.team=CWT_INACTIVE_ID}util.DEBUG&&util.logInfo("game instance successfully loaded")}}),controller.registerCommand({key:"loadMod",condition:util.FUNCTION_FALSE_RETURNER,action:function(){for(var t=0,e=CWT_MOD_DEFAULT.movetypes.length;e>t;t++)model.parseSheet(CWT_MOD_DEFAULT.movetypes[t],model.sheets.MOVE_TYPE_SHEET);for(var t=0,e=CWT_MOD_DEFAULT.tiles.length;e>t;t++)model.parseSheet(CWT_MOD_DEFAULT.tiles[t],model.sheets.TILE_TYPE_SHEET);for(var t=0,e=CWT_MOD_DEFAULT.units.length;e>t;t++)model.parseSheet(CWT_MOD_DEFAULT.units[t],model.sheets.UNIT_TYPE_SHEET);for(var t=0,e=CWT_MOD_DEFAULT.weapons.length;e>t;t++)model.parseSheet(CWT_MOD_DEFAULT.weapons[t],model.sheets.WEAPON_TYPE_SHEET);for(var o=Object.keys(CWT_MOD_DEFAULT.locale),t=0,e=o.length;e>t;t++)util.i18n_appendToLanguage(o[t],CWT_MOD_DEFAULT.locale[o[t]])}}),controller.registerCommand({key:"loadUnit",unitAction:!0,condition:function(t){var e=t.getSourceUnitId(),o=t.getTargetUnitId();return-1===o||t.getTargetUnit().owner!==model.turnOwner?!1:model.isTransport(o)&&model.canLoad(e,o)},action:function(t){var e=t.getSourceUnitId(),o=t.getTargetUnitId();model.eraseUnitPosition(e),model.loadUnitInto(e,o)}}),controller.registerCommand({key:"move",condition:util.FUNCTION_FALSE_RETURNER,action:function(t){for(var e=t.getMovePath(),o=t.getSourceUnitId(),r=t.getSourceX(),n=t.getSourceY(),i=model.units[o],l=model.sheets.unitSheets[i.type],a=model.sheets.movetypeSheets[l.moveType],u=(e.length-1,0),s=0,c=e.length;c>s;s++){switch(e[s]){case model.MOVE_CODE_UP:0===n&&util.logError("cannot do move command UP because","current position is at the border"),n--;break;case model.MOVE_CODE_RIGHT:r===model.mapWidth-1&&util.logError("cannot do move command RIGHT because","current position is at the border"),r++;break;case model.MOVE_CODE_DOWN:n===model.mapHeight-1&&util.logError("cannot do move command DOWN because","current position is at the border"),n++;break;case model.MOVE_CODE_LEFT:0===r&&util.logError("cannot do move command LEFT because","current position is at the border"),r--;break;default:util.logError("unknown command ",e[s])}u+=model.moveCosts(a,model.map[r][n])}i.fuel-=u,model.eraseUnitPosition(o),null===model.unitPosMap[r][n]&&model.setUnitPosition(o,r,n),util.logInfo("moved unit",o,"from (",t.getSourceX(),",",t.getSourceY(),")","to (",r,",",n,")")}}),controller.registerCommand({key:"nextTurn",condition:function(t){return t.getSourceUnitId()===CWT_INACTIVE_ID?t.getSourcePropertyId()!==CWT_INACTIVE_ID&&t.getSourceProperty().owner===model.turnOwner?!1:!0:t.getSourceUnit().owner===model.turnOwner&&model.canAct(t.getSourceUnitId())?!1:!0},action:function(){var t=model.turnOwner,e=t;for(t++;t!==e&&(t===CWT_MAX_PLAYER&&(t=0,model.day++),model.players[t].team===CWT_INACTIVE_ID);)t++;t===e&&util.unexpectedSituationError(),model.turnOwner=t;for(var o=t*CWT_MAX_UNITS_PER_PLAYER,r=o,n=r+CWT_MAX_UNITS_PER_PLAYER;n>r;r++)model.leftActors[r-o]=null!==model.units[r]}}),controller.SERIALIZATION_MAP="map",controller.SERIALIZATION_MAP_H="mapHeight",controller.SERIALIZATION_MAP_W="mapWidth",controller.SERIALIZATION_UNITS="units",controller.SERIALIZATION_UNITS_POS="unitPosMap",controller.SERIALIZATION_PROPS="properties",controller.SERIALIZATION_PROPS_POS="propertyPosMap",controller.SERIALIZATION_PLAYERS="players",controller.SERIALIZATION_DAY="day",controller.SERIALIZATION_TURNOWNER="turnOwner",controller.SERIALIZATION_LEFTACTORS="leftActors",controller.registerCommand({key:"saveGame",condition:util.FUNCTION_FALSE_RETURNER,action:function(t){util.DEBUG&&util.logInfo("start saving game instance");var e={};e[controller.SERIALIZATION_MAP]=util.matrix(model.mapWidth,model.mapHeight,null);for(var o=0,r=model.mapWidth;r>o;o++)for(var n=0,i=model.mapHeight;i>n;n++)e[controller.SERIALIZATION_MAP][o][n]=model.map[o][n];e[controller.SERIALIZATION_MAP_H]=model.mapHeight,e[controller.SERIALIZATION_MAP_W]=model.mapWidth,e[controller.SERIALIZATION_UNITS]={};for(var l=0,a=model.units.length;a>l;l++){var u=model.units[l];u.owner!==CWT_INACTIVE_ID&&(e[controller.SERIALIZATION_UNITS][l]=u)}e[controller.SERIALIZATION_UNITS_POS]={};for(var o=0,r=model.mapWidth;r>o;o++)for(var n=0,i=model.mapHeight;i>n;n++){var u=model.unitPosMap[o][n];null!==u&&(e[controller.SERIALIZATION_UNITS_POS][o+","+n]=model.extractUnitId(u))}e[controller.SERIALIZATION_PROPS]={};for(var l=0,a=model.properties.length;a>l;l++){var s=model.properties[l];s.owner!==CWT_INACTIVE_ID&&(e[controller.SERIALIZATION_PROPS][l]=s)}e[controller.SERIALIZATION_PROPS_POS]={};for(var o=0,r=model.mapWidth;r>o;o++)for(var n=0,i=model.mapHeight;i>n;n++){var s=model.propertyPosMap[o][n];null!==s&&(e[controller.SERIALIZATION_PROPS_POS][o+","+n]=model.extractPropertyId(s))}e[controller.SERIALIZATION_DAY]=model.day,e[controller.SERIALIZATION_TURNOWNER]=model.turnOwner,e[controller.SERIALIZATION_LEFTACTORS]=model.leftActors,e[controller.SERIALIZATION_PLAYERS]={};for(var l=0,a=model.players.length;a>l;l++){var c=model.players[l];c.team!==CWT_INACTIVE_ID&&(e[controller.SERIALIZATION_PLAYERS][l]=c)}e=JSON.stringify(e,null,"	"),t.setSubAction(e),util.DEBUG&&util.logInfo("game instance successfully saved")}}),controller.registerCommand({key:"silofire",unitAction:!0,_doDamage:function(t,e){if(model.isValidPosition(t,e)){var o=model.unitPosMap[t][e];null!==o&&(o.hp-=20,9>o.hp&&(o.hp=9))}},condition:function(t){var e=t.getSourceUnit(),o=t.getSourceProperty();return null===o||o.owner!==model.turnOwner?!1:"INFT"!==e.type&&"MECH"!==e.type?!1:"SILO"===o.type},targetValid:function(t,e,o){return model.isValidPosition(e,o)},action:function(t){var e=this._doDamage,o=t.getActionTargetX(),r=t.getActionTargetY();e(o,r-2),e(o-1,r-1),e(o,r-1),e(o+1,r-1),e(o-2,r),e(o-1,r),e(o,r),e(o+1,r),e(o+2,r),e(o-1,r+1),e(o,r+1),e(o+1,r+1),e(o,r+2),t.getSourceProperty().type="SILO_EMPTY",controller.invokeCommand(t,"wait")}}),controller.registerCommand({key:"startGame",condition:util.FUNCTION_FALSE_RETURNER,action:function(){}}),controller.registerCommand({key:"supply",unitAction:!0,_resupplyUnitAt:function(t,e){var o=model.unitPosMap[t][e],r=model.sheets.unitSheets[o.type];o.ammo=r.maxAmmo,o.fuel=r.maxFuel},condition:function(t){var e=t.getSourceUnit(),o=model.sheets.unitSheets[e.type];if(void 0===o.supply)return!1;var r=e.owner,n=t.getTargetX(),i=t.getTargetY(),l=model.thereIsAnOwnUnitAt;return l(n-1,i,r)||l(n+1,i,r)||l(n,i-1,r)||l(n,i+1,r)},action:function(t){var e=t.getSourceUnit(),o=e.owner,r=t.getTargetX(),n=t.getTargetY(),i=model.thereIsAnOwnUnitAt,l=this._resupplyUnitAt;i(r-1,n,o)&&l(r-1,n),i(r+1,n,o)&&l(r+1,n),i(r,n-1,o)&&l(r,n-1),i(r,n+1,o)&&l(r,n+1),controller.invokeCommand(t,"wait")}}),controller.registerCommand({key:"unloadUnit",unitAction:!0,multiStepAction:!0,prepareMenu:function(t,e){for(var o=t.getSourceUnitId(),r=model.getLoadedIds(o),n=0,i=r.length;i>n;n++)e(r[n])},prepareTargets:function(t,e){var o=t.getSubAction(),r=t.getTargetX(),n=t.getTargetY(),i=model.units[o],l=model.sheets.unitSheets[i.type],a=model.sheets.movetypeSheets[l.moveType];r>0&&null===model.unitPosMap[r-1][n]&&-1!==model.moveCosts(a,model.map[r-1][n])&&e.setPositionValue(r-1,n,1),n>0&&null===model.unitPosMap[r][n-1]&&-1!==model.moveCosts(a,model.map[r][n-1])&&e.setPositionValue(r,n-1,1),model.mapHeight-1>n&&null===model.unitPosMap[r][n+1]&&-1!==model.moveCosts(a,model.map[r][n+1])&&e.setPositionValue(r,n+1,1),model.mapWidth-1>r&&null===model.unitPosMap[r+1][n]&&-1!==model.moveCosts(a,model.map[r+1][n])&&e.setPositionValue(r+1,n,1)},condition:function(t){if(t.getSourceUnit(),null!==t.getTargetUnit())return!1;var e=t.getSourceUnitId();return model.isTransport(e)&&model.hasLoadedIds(e)},action:function(t){var e=t.getSubAction(),o=t.getSourceUnitId(),r=t.getActionTargetX(),n=t.getActionTargetY(),i=t.getTargetX(),l=t.getTargetY();controller.invokeCommand(t,"wait"),model.unloadUnitFrom(e,o);var a;i>r?a=model.MOVE_CODE_LEFT:r>i?a=model.MOVE_CODE_RIGHT:l>n?a=model.MOVE_CODE_UP:n>l&&(a=model.MOVE_CODE_DOWN);var u=controller.aquireActionDataObject();u.setSourceUnit(model.units[e]),u.setMovePath([a]),u.setAction("wait"),u.setSource(i,l),controller.pushActionDataIntoBuffer(u,!0)}}),controller.registerCommand({key:"wait",unitAction:!0,condition:function(t){var e=t.getSourceUnit(),o=t.getTargetUnit();return null===o||o===e},action:function(t){model.markAsUnusable(t.getSourceUnitId())}});