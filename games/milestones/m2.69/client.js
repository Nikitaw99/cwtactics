createjs.Sound.registerPlugin(createjs.WebAudioPlugin),createjs.Sound.addEventListener("loadComplete",function(){CLIENT_DEBUG&&util.log("finised loading sound")}),createjs.Sound.registerManifest([{src:"../../../sound/ok.wav",id:"ACTION"},{src:"../../../sound/cancel.wav",id:"CANCEL"}]),controller.playSfx=function(e){createjs.Sound.play(e)},controller.mapCursorX=0,controller.mapCursorY=0,controller.menuCursorIndex=-1,controller.resetMenuCursor=function(){controller.menuCursorIndex=0},controller.setMenuIndex=function(e){controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuCursorIndex=e,controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton"},controller.increaseMenuCursor=function(){controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuCursorIndex++,controller.menuCursorIndex===controller.stateMachine.data.menuSize&&controller.menuCursorIndex--,controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton",controller.menuEntryListElement.children[controller.menuCursorIndex].children[0].focus()},controller.decreaseMenuCursor=function(){controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuCursorIndex--,0>controller.menuCursorIndex&&(controller.menuCursorIndex=0),controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton",controller.menuEntryListElement.children[controller.menuCursorIndex].children[0].focus()},controller.resetMapCursor=function(){controller.mapCursorX=0,controller.mapCursorY=0},controller.cursorAction=function(e){if(null===controller.currentAnimatedKey){var t=controller.stateMachine.state,r="MOVEPATH_SELECTION"===t||"IDLE_R"===t||"ACTION_SELECT_TARGET_A"===t||"ACTION_SELECT_TARGET_B"===t;e?controller.stateMachine.event("cancel",controller.mapCursorX,controller.mapCursorY):-1!==controller.menuCursorIndex?controller.stateMachine.event("action",controller.menuCursorIndex):controller.stateMachine.event("action",controller.mapCursorX,controller.mapCursorY);var n=controller.stateMachine.state,o="MOVEPATH_SELECTION"===n||"IDLE_R"===n||"ACTION_SELECT_TARGET_A"===n||"ACTION_SELECT_TARGET_B"===n;if((r&&!o||o)&&view.markSelectionMapForRedraw(controller.stateMachine.data),"ACTION_MENU"===n||"ACTION_SUBMENU"===n){var i=controller.stateMachine.data.menu;controller.showMenu(i,controller.stateMachine.data.menuSize,controller.mapCursorX,controller.mapCursorY)}else("ACTION_MENU"===t||"ACTION_SUBMENU"===t)&&controller.hideMenu()}},controller.cursorActionCancel=function(){controller.cursorAction(!0),controller.playSfx("CANCEL")},controller.cursorActionClick=function(){controller.cursorAction(!1),controller.playSfx("ACTION")},controller.moveCursor=function(e,t){1===arguments.length&&(t=1);var r=controller.mapCursorX,n=controller.mapCursorY;switch(e){case model.MOVE_CODE_UP:n--;break;case model.MOVE_CODE_RIGHT:r++;break;case model.MOVE_CODE_DOWN:n++;break;case model.MOVE_CODE_LEFT:r--}controller.setCursorPosition(r,n)},controller.setCursorPosition=function(e,t,r){if("block"!==controller.menuElement.style.display&&(r&&(e+=controller.screenX,t+=controller.screenY),model.isValidPosition(e,t)&&(e!==controller.mapCursorX||t!==controller.mapCursorY))){view.markForRedraw(controller.mapCursorX,controller.mapCursorY),controller.mapCursorX=e,controller.mapCursorY=t;var n=controller.screenScale;0===n?n=.8:-1===n&&(n=.7);var o=parseInt(parseInt(window.innerWidth/16,10)/n,10),i=parseInt(parseInt(window.innerHeight/16,10)/n,10),a=-1;1>=e-controller.screenX?a=model.MOVE_CODE_LEFT:e-controller.screenX>=o-1?a=model.MOVE_CODE_RIGHT:1>=t-controller.screenY?a=model.MOVE_CODE_UP:t-controller.screenY>=i-1&&(a=model.MOVE_CODE_DOWN),-1!==a&&controller.shiftScreenPosition(a,5),CLIENT_DEBUG&&util.log("set cursor position to",e,t,"screen node is at",controller.screenX,controller.screenY),view.markForRedraw(e,t)}},controller.currentAnimatedKey=null,controller.noRendering=!0,controller.lockCommandEvaluation=!1,controller.gameLoop=function(e){controller.updateTurnTimer(e);var t=0!==controller.moveScreenX||0!==controller.moveScreenY;if(t)controller.solveMapShift();else{if(null===controller.currentAnimatedKey){if(controller.lockCommandEvaluation===!1&&!controller.noNextActions()){var r=controller.doNextAction();if(null!==r){var n=r[r.length-1];view.invokeCommandListener(n,r);var o=view.getCommandHook(n);null!==o&&(o.prepare.apply(o,r),controller.currentAnimatedKey=o,CLIENT_DEBUG&&util.log("preparing command animation for",n))}}}else controller.currentAnimatedKey.update(e);view.updateSpriteAnimations(e)}if(!controller.noRendering&&view.drawScreenChanges>0&&view.renderMap(controller.screenScale),"ACTION_SELECT_TILE"===controller.stateMachine.state){var i,a,l=view.selectionRange,s=controller.mapCursorX,c=controller.mapCursorY,u=c-l,d=c+l;for(0>u&&(u=0),d>=model.mapHeight&&(d=model.mapHeight-1);d>=u;u++){var m=Math.abs(u-c);for(i=s-l+m,a=s+l-m,0>i&&(i=0),a>=model.mapWidth&&(a=model.mapWidth-1);a>=i;i++)view.markForRedraw(i,u)}}controller.noRendering||t||null!==controller.currentAnimatedKey&&(controller.currentAnimatedKey.isDone()?(CLIENT_DEBUG&&util.log("completed command animation for",controller.currentAnimatedKey.key),controller.currentAnimatedKey=null):controller.currentAnimatedKey.render())},controller.enterGameLoop=function(){function e(){requestAnimationFrame(e);var i=(new Date).getTime(),a=i-o;o=i;var l=1e3/((i=new Date)-r);isNaN(l)||(t+=(l-t)/n),r=i,controller.gameLoop(a)}CLIENT_DEBUG&&util.logInfo("enter game loop");var t=0,r=1*new Date-1,n=50,o=(new Date).getTime(),i=document.getElementById("fps");setInterval(function(){i.innerHTML=CWT_VERSION+" "+t.toFixed(1)+"fps"},1e3),controller.stateMachine.event("start"),view.fitScreenToDeviceOrientation(),window.requestAnimationFrame(e)},controller.menuPosX=-1,controller.menuPosY=-1,controller.menuElement=document.getElementById("cwt_menu"),controller.menuHeaderElement=document.getElementById("cwt_menu_header"),controller.menuEntryContentElement=document.getElementById("cwt_menu_content"),controller.menuEntryListElement=document.getElementById("cwt_menu_entries"),controller._connectMenuListener=function(e,t){e.onclick=function(){CLIENT_DEBUG&&util.log("menu action will be triggered"),controller.cursorActionClick()},e.onmouseover=function(){controller.setMenuIndex(t)}},controller.showMenu=function(e,t,r,n){CLIENT_DEBUG&&util.logInfo("opening GUI menu");var o=TILE_LENGTH*controller.screenScale,i=controller.menuRenderer_.__mainMenu__;if("ACTION_SUBMENU"===controller.stateMachine.state){var a=controller.menuRenderer_[controller.stateMachine.data.action];a&&(i=a)}if(1===arguments.length&&(r=controller.menuPosX,n=controller.menuPosY),CLIENT_DEBUG&&!model.isValidPosition(r,n))throw Error("invalid menu position");var l=controller.menuEntryListElement.children;controller.menuRenderer_.__infoPanel__(r,n,controller.menuHeaderElement);for(var s=0,c=l.length;c>s;s++)l[s].style.display="none";for(var s=0,c=t;c>s;s++){var u;if(l.length>s)l[s].className="",u=l[s].children[0];else{u=document.createElement("button"),controller._connectMenuListener(u,s);var d=document.createElement("li");d.appendChild(u),controller.menuEntryListElement.appendChild(d)}i(e[s],u,s),l[s].style.display=""}r-=controller.screenX,n-=controller.screenY;var m=parseInt(150/o,10),p=parseInt(160/o,10);n>controller.screenHeight-m&&(n-=parseInt(160/o,10)),r>controller.screenWidth-p&&(r-=parseInt(150/o,10)),controller.menuPosX=r,controller.menuPosY=n,controller.menuCursorIndex=0,controller.menuEntryListElement.children[controller.menuCursorIndex].className="activeButton",controller.menuEntryListElement.children[controller.menuCursorIndex].children[0].focus();var h=controller.menuElement.style;h.top=n*o+10+"px",h.left=r*o-10+"px",h.zIndex=2e3,h.display="block",controller.setMenuIndex(0)},controller.hideMenu=function(){CLIENT_DEBUG&&util.logInfo("closing GUI menu"),controller.menuEntryListElement.children[controller.menuCursorIndex].className="",controller.menuElement.style.display="none",controller.menuCursorIndex=-1},controller.menuRenderer_={},controller.registerMenuRenderer=function(e,t){controller.menuRenderer_.hasOwnProperty(e)&&util.raiseError("renderer for",e,"is already registered"),controller.menuRenderer_[e]=t},controller.statusMap_=util.list(CWT_MAX_UNITS_PER_PLAYER*CWT_MAX_PLAYER,function(){return{HP_PIC:null,LOW_AMMO:!1,LOW_FUEL:!1,HAS_LOADS:!1,CAPTURES:!1,TURN_OWNER_VISIBLE:!1}}),controller.getUnitStatusForUnit=function(e){var t=model.extractUnitId(e);return controller.statusMap_[t]},controller.inVision_=function(e,t,r,n){if(!model.isValidPosition(e,t))return!1;var o=model.unitPosMap[e][t];return null!==o&&(o.owner===r||model.players[o.owner].team==n)},controller.updateUnitStatus=function(e){var t=model.units[e],r=t.x,n=t.y,o=controller.statusMap_[e],i=model.sheets.unitSheets[t.type],a=t.ammo,l=i.maxAmmo;o.LOW_AMMO=parseInt(.25*l,10)>=a?!0:!1,0===l&&(o.LOW_AMMO=!1);var s=t.fuel,c=i.maxFuel;o.LOW_FUEL=parseInt(.25*c,10)>s?!0:!1;var u=-1;switch(90>=t.hp&&(u=parseInt(t.hp/10,10)+1),u){case 1:o.HP_PIC=view.getInfoImageForType("HP_1");break;case 2:o.HP_PIC=view.getInfoImageForType("HP_2");break;case 3:o.HP_PIC=view.getInfoImageForType("HP_3");break;case 4:o.HP_PIC=view.getInfoImageForType("HP_4");break;case 5:o.HP_PIC=view.getInfoImageForType("HP_5");break;case 6:o.HP_PIC=view.getInfoImageForType("HP_6");break;case 7:o.HP_PIC=view.getInfoImageForType("HP_7");break;case 8:o.HP_PIC=view.getInfoImageForType("HP_8");break;case 9:o.HP_PIC=view.getInfoImageForType("HP_9");break;default:o.HP_PIC=null}if(i.transport&&(o.HAS_LOADS=model.hasLoadedIds(e)?!0:!1),-1!==t.x){var d=model.propertyPosMap[t.x][t.y];o.CAPTURES=null!==d&&20>d.capturePoints?!0:!1}o.TURN_OWNER_VISIBLE=!1;var m=model.turnOwner,p=model.players[m].team,h=controller.inVision_;(h(r-1,n,m,p)||h(r,n-1,m,p)||h(r,n+1,m,p)||h(r+1,n,m,p))&&(o.TURN_OWNER_VISIBLE=!0)},controller.screenElement=document.getElementById("cwt_canvas"),controller.screenX=0,controller.screenY=0,controller.screenWidth=-1,controller.screenHeight=-1,controller.screenScale=1,controller.moveScreenX=0,controller.moveScreenY=0,controller._transEndEventNames={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",msTransition:"MSTransitionEnd",transition:"transitionend"},controller.setScreenScale=function(e){if(!(-1>e||e>3)){controller.screenScale=e,controller.screenElement.className="scale"+e,0===e?e=.8:-1===e&&(e=.7);var t=TILE_LENGTH*e;controller.screenWidth=parseInt(window.innerWidth/t,10),controller.screenHeight=parseInt(window.innerHeight/t,10),controller.setScreenPosition(controller.screenX,controller.screenY,!1)}},controller.setScreenPosition=function(e,t){controller.screenX=e,controller.screenY=t;var r=controller.screenElement.style,n=controller.screenScale,o=-(controller.screenX*TILE_LENGTH*n),i=-(controller.screenY*TILE_LENGTH*n);switch(n){case 2:o+=controller.screenElement.width/2,i+=controller.screenElement.height/2;break;case 3:o+=controller.screenElement.width,i+=controller.screenElement.height}r.position="absolute",r.left=o+"px",r.top=i+"px"},controller.shiftScreenPosition=function(e,t){1===arguments.length&&(t=1);var r=controller.screenX,n=controller.screenY;switch(e){case model.MOVE_CODE_DOWN:n+=t;break;case model.MOVE_CODE_RIGHT:r+=t;break;case model.MOVE_CODE_UP:n-=t;break;case model.MOVE_CODE_LEFT:r-=t}0>r&&(r=0),0>n&&(n=0),r>=model.mapWidth&&(r=model.mapWidth-1),n>=model.mapHeight&&(n=model.mapHeight-1),controller.setScreenPosition(r,n,!1)},controller.storage={get:function(e){var t=localStorage.getItem(e);return null!==t?JSON.parse(t):null},has:function(e){return null!==localStorage.getItem(e)},clear:function(){localStorage.clear()},remove:function(e){localStorage.removeItem(e)},set:function(e,t){localStorage.setItem(e,JSON.stringify(t))}},view._animCommands={},view.registerCommandHook=function(e){view._animCommands[e.key]=e,e.isEnabled=!0},view.getCommandHook=function(e){var t=view._animCommands[e];return void 0!==t?t:null},view._commandListeners={},view.registerCommandListener=function(e,t){view._commandListeners.hasOwnProperty(e)||(view._commandListeners[e]=[]),view._commandListeners[e].push(t)},view.invokeCommandListener=function(e,t){var r=view._commandListeners[e];if(r)for(var n=0,o=r.length;o>n;n++)r[n].apply(null,t)},view.IMAGE_CODE_IDLE="IDLE",view.IMAGE_CODE_IDLE_INVERTED="IDLE_R",view.IMAGE_CODE_RIGHT="RIGHT",view.IMAGE_CODE_LEFT="LEFT",view.IMAGE_CODE_UP="UP",view.IMAGE_CODE_DOWN="DOWN",view.IMAGE_CODE_STATELESS="STATELESS",view.COLOR_RED="RED",view.COLOR_GREEN="GREEN",view.COLOR_BLUE="BLUE",view.COLOR_YELLOW="YELLOW",view.COLOR_BLACK_MASK="BLACK_MASK",view.COLOR_NEUTRAL="GRAY",view.COLOR_NONE="NONE",view.IMG_COLOR_MAP_PROPERTIES_ID="IMG_MAP_PROPERTY",view.IMG_COLOR_MAP_UNITS_ID="IMG_MAP_UNIT",view.CodeStatelessview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{},NONE:{},GRAY:{}},view.CodeIdleview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeIdleInvertedview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeRightview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeLeftview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeUpview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.CodeDownview={RED:{},BLUE:{},YELLOW:{},GREEN:{},BLACK_MASK:{}},view.setImageForType=function(e,t,r,n){switch(CLIENT_DEBUG&&util.logInfo("registering image for type",t,"\n","state",r,"\n","color",n),void 0===r&&(r=view.IMAGE_CODE_STATELESS),void 0===n&&(n=view.COLOR_NONE),r){case view.IMAGE_CODE_IDLE:view.CodeIdleview[n][t]=e;break;case view.IMAGE_CODE_STATELESS:view.CodeStatelessview[n][t]=e;break;case view.IMAGE_CODE_IDLE_INVERTED:view.CodeIdleInvertedview[n][t]=e;break;case view.IMAGE_CODE_LEFT:view.CodeLeftview[n][t]=e;break;case view.IMAGE_CODE_RIGHT:view.CodeRightview[n][t]=e;break;case view.IMAGE_CODE_DOWN:view.CodeDownview[n][t]=e;break;case view.IMAGE_CODE_UP:view.CodeUpview[n][t]=e;break;default:util.raiseError("unknown image state code ",r)}},view.setUnitImageForType=view.setImageForType,view.setPropertyImageForType=function(e,t,r){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,r)},view.setTileImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.setInfoImageForType=function(e,t){view.setImageForType(e,t,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getImageForType=function(e,t,r){switch(t){case view.IMAGE_CODE_IDLE:return view.CodeIdleview[r][e];case view.IMAGE_CODE_IDLE_INVERTED:return view.CodeIdleInvertedview[r][e];case view.IMAGE_CODE_LEFT:return view.CodeLeftview[r][e];case view.IMAGE_CODE_RIGHT:return view.CodeRightview[r][e];case view.IMAGE_CODE_DOWN:return view.CodeDownview[r][e];case view.IMAGE_CODE_UP:return view.CodeUpview[r][e];case view.IMAGE_CODE_STATELESS:return view.CodeStatelessview[r][e];default:util.raiseError("unknown image state code ",t)}},view.getUnitImageForType=view.getImageForType,view.getPropertyImageForType=function(e,t){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,t)},view.getTileImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)},view.getInfoImageForType=function(e){return view.getImageForType(e,view.IMAGE_CODE_STATELESS,view.COLOR_NONE)};var TILE_LENGTH=16;controller.baseSize=CWT_MOD_DEFAULT.graphic.baseSize,view.preventRenderUnit=null,view.canvasCtx=controller.screenElement.getContext("2d"),view.selectionRange=2,view.colorArray=[view.COLOR_RED,view.COLOR_BLUE,view.COLOR_GREEN,view.COLOR_YELLOW],view.renderMap=function(){var e=TILE_LENGTH,t=view.canvasCtx;controller.screenX,controller.screenY;for(var r,n,o,i,a,l,s,c,u,d,m,p=controller.mapCursorX,h=controller.mapCursorY,E=view.getSpriteStep("SELECTION"),_=view.getSpriteStep("UNIT"),f=view.getSpriteStep("PROPERTY"),v=view.getSpriteStep("STATUS"),g=controller.baseSize,T=model.players[model.turnOwner].team,I="MOVEPATH_SELECTION"===controller.stateMachine.state||"IDLE_R"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state,A="ACTION_SELECT_TILE"===controller.stateMachine.state,y=model.mapHeight-1,O=0;y>=O;O++)for(var w=model.mapWidth-1,C=0;w>=C;C++)if(m=0===model.fogData[C][O],view.drawScreen[C][O]===!0){r=model.map[C][O],n=view.getTileImageForType(r),o=0,i=0,a=g,l=2*g,s=C*e,c=O*e-e,u=e,d=2*e,0>c&&(i+=g,l-=g,c+=e,d-=e),void 0!==n?t.drawImage(n,o,i,a,l,s,c,u,d):(t.fillStyle="rgb(0,0,255)",t.fillRect(s,c,e,e));var S=model.propertyPosMap[C][O];if(null!==S){var D;D=-1===S.owner?view.COLOR_NEUTRAL:view.colorArray[S.owner],m&&(D=view.COLOR_NEUTRAL),n=view.getPropertyImageForType(S.type,D),o=0+g*f,i=0,a=g,l=2*g,s=C*e,c=O*e-e,u=e,d=2*e,0>c&&(i+=g,l-=g,c+=e,d-=e),void 0!==n?(t.drawImage(n,o,i,a,l,s,c,u,d),m&&d>16&&null!==S&&(n=view.getPropertyImageForType(S.type,view.COLOR_BLACK_MASK),t.globalAlpha=.35,t.drawImage(n,o,i,a,l/2,s,c,u,d/2),t.globalAlpha=1)):(s=C*e,c=O*e,u=e,d=e,t.fillStyle="rgb(0,255,0)",t.fillRect(s,c,u,d))}if(m&&(s=C*e,c=O*e,u=e,d=e,t.globalAlpha=.2,t.fillStyle="black",t.fillRect(s,c,u,d),t.globalAlpha=1),I){n=view.getInfoImageForType("MOVEPATH_SELECTION"===controller.stateMachine.state?"MOVE_FOC":"ATK_FOC");var M=controller.stateMachine.data.getSelectionValueAt(C,O);M>0&&(o=g*E,i=0,a=g,l=g,s=C*e,c=O*e,u=e,d=e,t.globalAlpha=.65,t.drawImage(n,o,i,a,l,s,c,u,d),t.globalAlpha=1)}if(A){var P=model.distance(p,h,C,O);if(view.selectionRange===P){var n=null;n=0===P?view.getInfoImageForType("SILO_ALL"):p===C?h>O?view.getInfoImageForType("SILO_N"):view.getInfoImageForType("SILO_S"):h===O?p>C?view.getInfoImageForType("SILO_W"):view.getInfoImageForType("SILO_E"):p>C?h>O?view.getInfoImageForType("SILO_NW"):view.getInfoImageForType("SILO_SW"):h>O?view.getInfoImageForType("SILO_NE"):view.getInfoImageForType("SILO_SE"),s=C*e,c=O*e,null!==n&&t.drawImage(n,s,c)}}var R=model.unitPosMap[C][O],L=null!==R?controller.getUnitStatusForUnit(R):null;if(!m&&null!==R&&(!R.hidden||R.owner===model.turnOwner||model.players[R.owner].team==T||L.TURN_OWNER_VISIBLE)&&R!==view.preventRenderUnit){var D;D=-1===R.owner?view.COLOR_NEUTRAL:view.colorArray[R.owner];var N=1===R.owner%2?view.IMAGE_CODE_IDLE:view.IMAGE_CODE_IDLE_INVERTED;if(n=view.getUnitImageForType(R.type,N,D),o=2*g*_,i=0,a=2*g,l=2*g,s=C*e-e/2,c=O*e-e/2,u=e+e,d=e+e,void 0!==n?(t.drawImage(n,o,i,a,l,s,c,u,d),R.owner!==model.turnOwner||model.canAct(model.extractUnitId(R))||(t.globalAlpha=.5,t.drawImage(view.getUnitImageForType(R.type,N,view.COLOR_BLACK_MASK),o,i,a,l,s,c,u,d),t.globalAlpha=1)):(s=C*e,c=O*e,u=e,d=e,t.fillStyle="rgb(255,0,0)",t.fillRect(s,c,u,d)),n=L.HP_PIC,null!==n&&t.drawImage(n,s+e,c+e),0!==v&&1!==v&&4!==v&&5!==v&&8!==v&&9!==v&&12!==v&&13!==v&&16!==v&&17!==v){var U=parseInt(v/4,10);n=null;var b=U;do{if(0===b&&L.LOW_AMMO?n=view.getInfoImageForType("SYM_AMMO"):1===b&&L.CAPTURES?n=view.getInfoImageForType("SYM_CAPTURE"):2===b&&L.LOW_FUEL?n=view.getInfoImageForType("SYM_FUEL"):3===b&&L.HAS_LOADS?n=view.getInfoImageForType("SYM_LOAD"):4===b&&R.hidden&&(n=view.getInfoImageForType("SYM_HIDDEN")),null!==n)break;b++,5===b&&(b=0)}while(b!==U);null!==n&&t.drawImage(n,s+e/2,c+e)}}view.drawScreen[C][O]=!1}if("MOVEPATH_SELECTION"===controller.stateMachine.state)for(var W,k,G,H,V=controller.stateMachine.data,F=V.movePath,x=V.sourceX,B=V.sourceY,Y=0,X=F.length;X>Y&&null!==F[Y];Y++){switch(W=x,k=B,F[Y]){case model.MOVE_CODE_UP:B--;break;case model.MOVE_CODE_RIGHT:x++;break;case model.MOVE_CODE_DOWN:B++;break;case model.MOVE_CODE_LEFT:x--}if(Y===X-1||null===F[Y+1])G=-1,H=-1;else switch(F[Y+1]){case model.MOVE_CODE_UP:G=x,H=B-1;break;case model.MOVE_CODE_RIGHT:G=x+1,H=B;break;case model.MOVE_CODE_DOWN:G=x,H=B+1;break;case model.MOVE_CODE_LEFT:G=x-1,H=B}if(-1==G)switch(F[Y]){case model.MOVE_CODE_UP:n=view.getTileImageForType("ARROW_N");break;case model.MOVE_CODE_RIGHT:n=view.getTileImageForType("ARROW_E");break;case model.MOVE_CODE_DOWN:n=view.getTileImageForType("ARROW_S");break;case model.MOVE_CODE_LEFT:n=view.getTileImageForType("ARROW_W")}else{var j=Math.abs(G-W),K=Math.abs(H-k);if(2===j)n=view.getTileImageForType("ARROW_WE");else if(2===K)n=view.getTileImageForType("ARROW_NS");else if(x>G&&k>B||x>W&&H>B)n=view.getTileImageForType("ARROW_SW");else if(x>G&&B>k||x>W&&B>H)n=view.getTileImageForType("ARROW_WN");else if(G>x&&B>k||W>x&&B>H)n=view.getTileImageForType("ARROW_NE");else{if(!(G>x&&k>B||W>x&&H>B)){util.logError("illegal move arrow state","old (",W,",",k,")","current (",x,",",B,")","next (",G,",",H,")","path (",F,")");continue}n=view.getTileImageForType("ARROW_ES")}}x>=0&&B>=0&&controller.screenWidth>x&&controller.screenHeight>B&&t.drawImage(n,x*e,B*e)}t.lineWidth=2,t.strokeStyle="#f00",t.strokeRect(e*controller.mapCursorX+1,e*controller.mapCursorY+1,e-2,e-2),view.drawScreenChanges=0},view.fitScreenToDeviceOrientation=function(){var e=controller.screenElement;e.width=TILE_LENGTH*model.mapWidth,e.height=TILE_LENGTH*model.mapHeight,controller.screenWidth=parseInt(window.innerWidth/TILE_LENGTH,10),controller.screenHeight=parseInt(window.innerHeight/TILE_LENGTH,10)},view.ID_DIV_CWTWC_MSG_PANEL="cwt_info_box",view.ID_DIV_CWTWC_MSG_PANEL_CONTENT="cwt_info_box_content",view.DEFAULT_MESSAGE_TIME=1e3,view._hideInfoMessage=function(){var e=document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL);e.className="tooltip out"},view.hasInfoMessage=function(){return"tooltip out"!==document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL).className},view.showInfoMessage=function(e,t){1===arguments.length&&(t=view.DEFAULT_MESSAGE_TIME);var r=document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL);document.getElementById(view.ID_DIV_CWTWC_MSG_PANEL_CONTENT).innerHTML=e,r.className="tooltip active",r.style.position="absolute",r.style.left=parseInt(window.innerWidth/2-r.offsetWidth/2,10)+"px",r.style.top=parseInt(window.innerHeight/2-r.offsetHeight/2,10)+"px",setTimeout(view._hideInfoMessage,t)},view.OVERLAYER={MNTN:!0,FRST:!0},view.drawScreenChanges=0,view.drawScreen=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,!1),view.markForRedraw=function(e,t){if(e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t){if(view.drawScreen[e][t]===!0)return;view.drawScreen[e][t]=!0,view.drawScreenChanges++,t++,model.mapHeight>t&&(null!==model.propertyPosMap[e][t]?view.markForRedraw(e,t):view.OVERLAYER[model.map[e][t]]===!0&&view.markForRedraw(e,t))}else util.logError("illegal arguments ",e,",",t," -> out of view bounds")},view.markForRedrawRange=function(e,t,r){var n,o,i=t-r,a=t+r;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-r+l,o=e+r-l,0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=n;n++)view.markForRedraw(n,i)}},view.markForRedrawWithNeighbours=function(e,t){t>0&&view.markForRedraw(e,t-1),e>0&&view.markForRedraw(e-1,t),view.markForRedraw(e,t),model.mapHeight-1>t&&view.markForRedraw(e,t+1),model.mapWidth-1>e&&view.markForRedraw(e+1,t)},view.markForRedrawWithNeighboursRing=function(e,t){var r=model.mapWidth,n=model.mapHeight;e>0&&(t>0&&view.markForRedraw(e-1,t-1),view.markForRedraw(e-1,t),n-1>t&&view.markForRedraw(e-1,t+1)),t>0&&view.markForRedraw(e,t-1),view.markForRedraw(e,t),n-1>t&&view.markForRedraw(e,t+1),r-1>e&&(t>0&&view.markForRedraw(e+1,t-1),view.markForRedraw(e+1,t),n-1>t&&view.markForRedraw(e+1,t+1))},view.completeRedraw=function(){view.drawScreenChanges=1;for(var e=0,t=model.mapWidth;t>e;e++)for(var r=0,n=model.mapHeight;n>r;r++)view.drawScreen[e][r]=!0},view.markSelectionMapForRedraw=function(e){for(var t=e.selectionCX,r=e.selectionCY,n=e.selectionData,o=0;n.length>o;o++)for(var i=n[o],a=0;i.length>a;a++)-1!==i[a]&&view.markForRedraw(t+o,r+a)},view.spriteAnimation={},view._spriteAnimators=[],view.registerSpriteAnimator=function(e,t,r,n){var o={};o._stps=t,o._tps=r,o._upt=n,o.step=0,o.time=0,view.spriteAnimation[e]=o,view._spriteAnimators.push(o)},view.getSpriteStep=function(e){return view.spriteAnimation[e].step},view.updateSpriteAnimations=function(e){for(var t=view._spriteAnimators,r=0,n=t.length;n>r;r++){var o=t[r];o.time+=e,o.time>=o._tps&&(o.time=0,o.step++,o.step>=o._stps&&(o.step=0),o._upt())}},view.registerSpriteAnimator("SELECTION",7,150,function(){if("MOVEPATH_SELECTION"===controller.stateMachine.state||"IDLE_R"===controller.stateMachine.state||"ACTION_SELECT_TARGET_A"===controller.stateMachine.state||"ACTION_SELECT_TARGET_B"===controller.stateMachine.state)for(var e=0,t=0,r=model.mapWidth,n=model.mapHeight;r>e;e++)for(var o=t;n>o;o++)controller.stateMachine.data.getSelectionValueAt(e,o)>-1&&view.markForRedraw(e,o)}),view.registerSpriteAnimator("STATUS",20,375,function(){}),view.registerSpriteAnimator("UNIT",3,250,function(){for(var e=0,t=0,r=model.mapWidth,n=model.mapHeight;r>e;e++)for(var o=t;n>o;o++)null!==model.unitPosMap[e][o]&&view.markForRedrawWithNeighbours(e,o)}),view.registerSpriteAnimator("PROPERTY",4,400,function(){for(var e=0,t=0,r=model.mapWidth,n=model.mapHeight;r>e;e++)for(var o=t;n>o;o++)null!==model.propertyPosMap[e][o]&&view.markForRedrawWithNeighbours(e,o)}),view.registerCommandHook({key:"AVIS",prepare:function(e,t,r){var n,o,i=t-r,a=t+r;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-r+l,o=e+r-l,0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=n;n++)view.markForRedraw(n,i)}},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"BDUN",prepare:function(){view.completeRedraw()},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"CTPR",prepare:function(e,t){var r=model.properties[t];20===r.capturePoints?view.showInfoMessage(util.i18n_localized("propertyCaptured")):view.showInfoMessage(util.i18n_localized("propertyPointsLeft")+" "+r.capturePoints)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerCommandHook({key:"CWTH",prepare:function(e){view.showInfoMessage(util.i18n_localized("weatherChange")+" "+util.i18n_localized(e))},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerCommandHook({key:"DEUN",prepare:function(e){var t=model.units[e];this.step=0,this.time=0,this.x=t.x,this.y=t.y},render:function(){var e=this.step,t=view.getInfoImageForType("EXPLOSION_GROUND"),r=this.x,n=this.y,o=TILE_LENGTH,i=48*e,a=0,l=48,s=48,c=r*o,u=n*o,d=o,m=o;view.canvasCtx.drawImage(t,i,a,l,s,c,u,d,m),view.markForRedraw(r,n)},update:function(e){this.time+=e,this.time>50&&(this.step++,this.time=0)},isDone:function(){return 10===this.step}}),view.registerCommandHook({key:"EDGM",prepare:function(){view.showInfoMessage(util.i18n_localized("gameHasEnded"),36e5)},render:function(){},update:function(){},isDone:function(){return!1}}),view.registerCommandHook({key:"IVMS",prepare:function(){var e=controller.stateMachine.state,t=controller.stateMachine.data;("ACTION_MENU"===e||"ACTION_SUBMENU"===e)&&controller.showMenu(t.menu,t.menuSize,controller.mapCursorX,controller.mapCursorY)},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"MOVE",prepare:function(e,t,r,n){this.moveAnimationX=r,this.moveAnimationY=n,this.moveAnimationIndex=0,this.moveAnimationPath=e,this.moveAnimationUid=t,this.moveAnimationShift=0,this.moveAnimationDustX=-1,this.moveAnimationDustY=-1,this.moveAnimationDustTime=-1,this.moveAnimationDustStep=-1,this.moveAnimationDustPic=null,view.preventRenderUnit=model.units[t],CLIENT_DEBUG&&util.logInfo("drawing move from","(",this.moveAnimationX,",",this.moveAnimationY,")","with path","(",this.moveAnimationPath,")")},update:function(e){var t=TILE_LENGTH;if(this.moveAnimationShift+=e/1e3*8*t,view.markForRedrawWithNeighboursRing(this.moveAnimationX,this.moveAnimationY),-1!==this.moveAnimationDustStep&&(this.moveAnimationDustTime+=e,this.moveAnimationDustTime>30&&(this.moveAnimationDustStep++,this.moveAnimationDustTime=0,3===this.moveAnimationDustStep&&(this.moveAnimationDustStep=-1))),this.moveAnimationShift>t){switch(this.moveAnimationDustX=this.moveAnimationX,this.moveAnimationDustY=this.moveAnimationY,this.moveAnimationDustTime=0,this.moveAnimationDustStep=0,this.moveAnimationPath[this.moveAnimationIndex]){case model.MOVE_CODE_UP:this.moveAnimationY--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_U");break;case model.MOVE_CODE_RIGHT:this.moveAnimationX++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_R");break;case model.MOVE_CODE_DOWN:this.moveAnimationY++,this.moveAnimationDustPic=view.getInfoImageForType("DUST_D");break;case model.MOVE_CODE_LEFT:this.moveAnimationX--,this.moveAnimationDustPic=view.getInfoImageForType("DUST_L")}this.moveAnimationIndex++,this.moveAnimationShift-=t,this.moveAnimationIndex===this.moveAnimationPath.length&&(this.moveAnimationX=0,this.moveAnimationY=0,this.moveAnimationIndex=0,this.moveAnimationPath=null,this.moveAnimationUid=-1,this.moveAnimationShift=0,view.preventRenderUnit=null)}},render:function(){var e,t=this.moveAnimationUid,r=this.moveAnimationX,n=this.moveAnimationY,o=this.moveAnimationShift,i=this.moveAnimationPath[this.moveAnimationIndex],a=model.units[t],l=view.colorArray[a.owner],s=a.type;switch(i){case model.MOVE_CODE_UP:e=view.IMAGE_CODE_UP;break;case model.MOVE_CODE_RIGHT:e=view.IMAGE_CODE_RIGHT;break;case model.MOVE_CODE_DOWN:e=view.IMAGE_CODE_DOWN;break;case model.MOVE_CODE_LEFT:e=view.IMAGE_CODE_LEFT}var c=view.getUnitImageForType(s,e,l),u=TILE_LENGTH,d=controller.baseSize,m=2*d*view.getSpriteStep("UNIT"),p=0,h=2*d,E=2*d,_=r*u-u/2,f=n*u-u/2,v=u+u,g=u+u;switch(i){case model.MOVE_CODE_UP:f-=o;break;case model.MOVE_CODE_LEFT:_-=o;break;case model.MOVE_CODE_RIGHT:_+=o;break;case model.MOVE_CODE_DOWN:f+=o}if(void 0!==c)view.canvasCtx.drawImage(c,m,p,h,E,_,f,v,v);else{switch(_=r*u,f=n*u,v=u,g=u,i){case model.MOVE_CODE_UP:f-=o;break;case model.MOVE_CODE_LEFT:_-=o;break;case model.MOVE_CODE_RIGHT:_+=o;break;case model.MOVE_CODE_DOWN:f+=o}view.canvasCtx.fillStyle="rgb(255,0,0)",view.canvasCtx.fillRect(_,f,v,g)}if(-1!==this.moveAnimationDustStep){var u=TILE_LENGTH;m=2*d*this.moveAnimationDustStep,p=0,h=2*d,E=2*d,_=this.moveAnimationDustX*u-u/2,f=this.moveAnimationDustY*u-u/2,v=u+u,g=u+u,view.canvasCtx.drawImage(this.moveAnimationDustPic,m,p,h,E,_,f,v,g)}},isDone:function(){return-1===this.moveAnimationUid}}),view.registerCommandHook({key:"NXTR",prepare:function(){model.rules.fogEnabled&&view.completeRedraw(),view.showInfoMessage(util.i18n_localized("day")+": "+model.day)},render:function(){},update:function(){},isDone:function(){return!view.hasInfoMessage()}}),view.registerCommandHook({key:"RVIS",prepare:function(e,t,r){var n,o,i=t-r,a=t+r;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-r+l,o=e+r-l,0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=n;n++)view.markForRedraw(n,i)}},render:function(){},update:function(){},isDone:function(){return!0}}),view.registerCommandHook({key:"SLFR",_check:function(){},_render:function(e,t,r,n){if(!(0>r||r>=10)){var o=TILE_LENGTH,i=48*r,a=0,l=48,s=48,c=e*o,u=t*o,d=o,m=o;view.canvasCtx.drawImage(n,i,a,l,s,c,u,d,m),view.markForRedraw(e,t)}},prepare:function(e,t,r,n,o,i){var a=o,l=i;this.x=a,this.y=l;var s=this._check;s(a,l-2),s(a-1,l-1),s(a,l-1),s(a+1,l-1),s(a-2,l),s(a-1,l),s(a,l),s(a+1,l),s(a+2,l),s(a-1,l+1),s(a,l+1),s(a+1,l+1),s(a,l+2),this.step=0,this.time=0},render:function(){var e=view.getInfoImageForType("EXPLOSION_GROUND"),t=this.step,r=this._render,n=this.x,o=this.y;r(n,o,t,e),t-=1,r(n,o-1,t,e),r(n-1,o,t,e),r(n+1,o,t,e),r(n,o+1,t,e),t-=3,r(n-1,o+1,t,e),r(n+1,o+1,t,e),r(n-1,o-1,t,e),r(n+1,o-1,t,e),r(n,o-2,t,e),r(n,o+2,t,e),r(n-2,o,t,e),r(n+2,o,t,e)},update:function(e){this.time+=e,this.time>50&&(this.step++,this.time=0)},isDone:function(){return 13===this.step}}),view.registerCommandHook({key:"TRWT",prepare:function(e){var t=model.units[e];this.time=0,this.xp=t.x+1,this.yp=t.y,this.x=(t.x+1)*TILE_LENGTH,this.y=t.y*TILE_LENGTH
},render:function(){var e=view.getInfoImageForType("TRAPPED");view.canvasCtx.drawImage(e,this.x,this.y)},update:function(e){this.time+=e},isDone:function(){var e=this.time>1e3;if(e)for(var t=view.getInfoImageForType("TRAPPED"),r=this.yp,n=this.xp,o=n+parseInt(t.width/TILE_LENGTH,10);o>=n;n++)view.markForRedraw(n,r);return e}}),view.registerCommandListener("ATUN",function(e,t,r,n){controller.updateUnitStatus(e),controller.updateUnitStatus(n)}),view.registerCommandListener("CTPR",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("CRUN",function(e,t){controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[e][t]))}),view.registerCommandListener("DMUN",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("HEUN",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("GUTP",function(e){var t=model.units[e];controller.updateUnitStatus(model.extractUnitId(model.unitPosMap[t.x][t.y]))}),view.registerCommandListener("LODU",function(e,t){controller.updateUnitStatus(t)}),view.registerCommandListener("JNUN",function(e,t){controller.updateUnitStatus(t)}),view.registerCommandListener("MOVE",function(e,t){controller.updateUnitStatus(t)}),view.registerCommandListener("RFRS",function(e){controller.updateUnitStatus(e)}),function(){function e(e,t){if(model.isValidPosition(e,t)){var r=model.unitPosMap[e][t];null!==r&&controller.updateUnitStatus(model.extractUnitId(r))}}view.registerCommandListener("SLFR",function(t,r,n,o,i,a){var l=i,s=a;e(l,s-2),e(l-1,s-1),e(l,s-1),e(l+1,s-1),e(l-2,s),e(l-1,s),e(l,s),e(l+1,s),e(l+2,s),e(l-1,s+1),e(l,s+1),e(l+1,s+1),e(l,s+2)}),view.registerCommandListener("SPPL",function(t,r,n){e(r,n-1),e(r-1,n),e(r,n),e(r+1,n),e(r,n+1)})}(),view.registerCommandListener("UNUN",function(e){controller.updateUnitStatus(e)}),view.registerCommandListener("LDGM",function(){for(var e=0,t=model.units.length;t>e;e++)model.units[e].owner!==CWT_INACTIVE_ID&&controller.updateUnitStatus(e)}),function(){var e=function(e,t,r){view.markForRedrawRange(e,t,r);var n,o,i=r,a=t-i,l=t+i;for(0>a&&(a=0),l>=model.mapHeight&&(l=model.mapHeight-1);l>=a;a++){var s=Math.abs(a-t);for(n=e-i+s,o=e+i-s,0>n&&(n=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=n;n++){var c=model.unitPosMap[n][a];null!==c&&c.hidden&&controller.updateUnitStatus(model.extractUnitId(c))}}};view.registerCommandListener("AVIS",e),view.registerCommandListener("RVIS",e)}(),controller.registerMenuRenderer("BDUN",function(e,t){var r=model.sheets.unitSheets[e].cost;t.innerHTML=util.i18n_localized(e)+" ("+r+"$)"}),controller.infoPanelRender_={tile:function(e,t,r,n,o,i){i.innerHTML=util.i18n_localized(model.map[e][t])},defense:function(e,t,r,n,o,i,a){i.innerHTML=util.i18n_localized("defense"),a.innerHTML=model.sheets.tileSheets[model.map[e][t]].defense},property:function(e,t,r,n,o,i){model.fogData[e][t]||(n=null),o.style.display=null!==n?"table-row":"none",null!==n&&(i.innerHTML=util.i18n_localized(n.type))},capturePoints:function(e,t,r,n,o,i,a){model.fogData[e][t]||(n=null),o.style.display=null!==n?"table-row":"none",null!==n&&(i.innerHTML=util.i18n_localized("capturePoints"),a.innerHTML=n.capturePoints)},unit:function(e,t,r,n,o,i){model.fogData[e][t]||(r=null),o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized(r.type))},hp:function(e,t,r,n,o,i,a){model.fogData[e][t]||(r=null),o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized("health"),a.innerHTML=parseInt(r.hp/10,10)+1)},ammo:function(e,t,r,n,o,i,a){model.fogData[e][t]||(r=null),o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized("ammo"),a.innerHTML=r.ammo)},fuel:function(e,t,r,n,o,i,a){model.fogData[e][t]||(r=null),o.style.display=null!==r?"table-row":"none",null!==r&&(i.innerHTML=util.i18n_localized("fuel"),a.innerHTML=r.fuel)}},controller.infoPanelRenderComponents_={empty:!0},controller.registerMenuRenderer("__infoPanel__",function(e,t){if(controller.infoPanelRenderComponents_.empty){for(var r=document.getElementsByName("cwt_menu_header_table")[0],n=r.children[0].children,o=0,i=n.length;i>o;o++){var a=n[o],l=a.cells;2!==l.length&&util.raiseError(),controller.infoPanelRenderComponents_[a.attributes.name.value]=[a,l[0],l[1]]}delete controller.infoPanelRenderComponents_.empty}for(var s=Object.keys(controller.infoPanelRenderComponents_),o=0,i=s.length;i>o;o++){var c=s[o],u=controller.infoPanelRender_[c],d=controller.infoPanelRenderComponents_[c],m=model.unitPosMap[e][t],p=model.propertyPosMap[e][t];void 0!==u&&u(e,t,m,p,d[0],d[1],d[2])}}),controller.registerMenuRenderer("__mainMenu__",function(e,t){t.innerHTML=util.i18n_localized(e)}),controller.registerMenuRenderer("GMTP",function(e,t){t.innerHTML=e+"$"}),function(){var e=function(e,t){t.innerHTML=model.players[e].name};controller.registerMenuRenderer("GPTP",e),controller.registerMenuRenderer("GUTP",e)}(),controller.registerMenuRenderer("UNUN",function(e,t){t.innerHTML="done"===e?util.i18n_localized("done"):util.i18n_localized(model.units[e].type)}),controller.engineAction({name:"colorizeImages",key:"COLI",UNIT_INDEXES:{BLACK_MASK:8,RED:0,BLUE:3,GREEN:4,colors:6},PROPERTY_INDEXES:{RED:0,GRAY:1,BLUE:3,GREEN:4,YELLOW:5,BLACK_MASK:8,colors:4},action:function(){function e(e){var t=document.createElement("canvas"),r=t.getContext("2d"),n=e.width,o=e.height;return t.width=n,t.height=o,r.drawImage(e,0,0),r.getImageData(0,0,n,o).data}function t(e,t,r,n,o,i){var a=document.createElement("canvas"),l=a.getContext("2d"),s=e.width,c=e.height;a.width=s,a.height=c,l.drawImage(e,0,0);for(var u=l.getImageData(0,0,s,c),d=4*n*r,m=4*o*r,p=0,h=0;u.height>h;h++)for(var E=0;u.width>E;E++)for(var _=4*h*u.width+4*E,f=u.data[_],v=u.data[_+1],g=u.data[_+2],T=0,I=4*r;I>T;T+=4){var A=t[d+T],y=t[d+T+1],O=t[d+T+2];if(A===f&&y===v&&O===g){var w=m+T,C=t[w],S=t[w+1],D=t[w+2];u.data[_]=C,u.data[_+1]=S,u.data[_+2]=D,p++}}return util.logInfo("replaced",p,"pixels for the type",i),l.putImageData(u,0,0),a}for(var r=[view.IMAGE_CODE_IDLE,view.IMAGE_CODE_IDLE_INVERTED,view.IMAGE_CODE_DOWN,view.IMAGE_CODE_UP,view.IMAGE_CODE_RIGHT,view.IMAGE_CODE_LEFT],n=e(view.getInfoImageForType(view.IMG_COLOR_MAP_PROPERTIES_ID)),o=e(view.getInfoImageForType(view.IMG_COLOR_MAP_UNITS_ID)),i=CWT_MOD_DEFAULT.graphic.units,a=0,l=i.length;l>a;a++)for(var s=i[a][0],c=0,u=r.length;u>c;c++){var d=r[c],m=view.getUnitImageForType(s,d,view.COLOR_RED);view.setUnitImageForType(t(m,o,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.BLUE,s),s,d,view.COLOR_BLUE),view.setUnitImageForType(t(m,o,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.GREEN,s),s,d,view.COLOR_GREEN),view.setUnitImageForType(t(m,o,this.UNIT_INDEXES.colors,this.UNIT_INDEXES.RED,this.UNIT_INDEXES.BLACK_MASK,s),s,d,view.COLOR_BLACK_MASK)}for(var p=CWT_MOD_DEFAULT.graphic.properties,a=0,l=p.length;l>a;a++){var s=p[a][0],m=view.getPropertyImageForType(s,view.COLOR_RED);view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.BLUE),s,view.COLOR_BLUE),view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.GREEN),s,view.COLOR_GREEN),view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.GRAY),s,view.COLOR_NEUTRAL),view.setPropertyImageForType(t(m,n,this.PROPERTY_INDEXES.colors,this.PROPERTY_INDEXES.RED,this.PROPERTY_INDEXES.BLACK_MASK),s,view.COLOR_BLACK_MASK)}}}),controller.engineAction({name:"cutImages",key:"CUTI",action:function(){function e(e,t,r){var n=t?-1:1,o=r?-1:1,i=t?-1*e.width:0,a=r?-1*e.height:0,l=document.createElement("canvas");l.height=e.height,l.width=e.width;var s=l.getContext("2d");return s.save(),s.scale(n,o),s.drawImage(e,i,a,e.width,e.height),s.restore(),l}CWT_MOD_DEFAULT.graphic.baseSize,DEBUG&&util.logInfo("cutting unit commands into single types");for(var t=CWT_MOD_DEFAULT.graphic.units,r=0,n=t.length;n>r;r++){var o,i,a=view.COLOR_RED,l=t[r][0],s=view.getUnitImageForType(l,view.IMAGE_CODE_IDLE,a);o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,0,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_IDLE,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,0,0,96,32,0,0,96,32),view.setUnitImageForType(e(o,!0,!1),l,view.IMAGE_CODE_IDLE_INVERTED,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,288,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_LEFT,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,288,0,96,32,0,0,96,32),view.setUnitImageForType(e(o,!0,!1),l,view.IMAGE_CODE_RIGHT,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,96,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_UP,a),o=document.createElement("canvas"),o.height=32,o.width=96,i=o.getContext("2d"),i.drawImage(s,192,0,96,32,0,0,96,32),view.setUnitImageForType(o,l,view.IMAGE_CODE_DOWN,a)}DEBUG&&util.logInfo("cutting unit commands into single types done"),DEBUG&&util.logInfo("cutting misc into single types");for(var c=CWT_MOD_DEFAULT.graphic.misc,r=0,n=c.length;n>r;r++){var u=c[r];if(u.length>2){var s=view.getInfoImageForType(u[0]);o=document.createElement("canvas"),i=o.getContext("2d"),u.length>6?u[6]===!0?(o.height=32,o.width=96,o=e(o,!0,!1),i=o.getContext("2d")):(o.height=16,o.width=16,i.save(),i.translate(8,8),i.rotate(u[6]*Math.PI/180),i.translate(-8,-8)):(o.height=16,o.width=16),u.length>6&&u[6]===!0?i.drawImage(s,u[2],u[3],u[4],u[5],0,0,96,32):i.drawImage(s,u[2],u[3],u[4],u[5],0,0,16,16),u.length>6&&i.restore(),view.setInfoImageForType(o,u[0])}}DEBUG&&util.logInfo("cutting misc into single types done")}}),controller.engineAction({name:"loadConfig",key:"LCFG",action:function(){var e=controller.storage.get("CWT_CONFIG");null===e&&(CLIENT_DEBUG&&util.logInfo("creating fresh configuration object"),e={lastUpdate:new Date},controller.storage.set("CWT_CONFIG",e)),CLIENT_DEBUG&&util.logInfo("loaded configuration object (timestamp:",e.lastUpdate,")")}}),controller.engineAction({name:"loadImages",key:"LOIM",action:function(){CLIENT_DEBUG&&util.log("loading images... place lock"),controller.lockCommandEvaluation=!0;var e="../../../image/",t=function(e){for(var t=0,r=e.length;r>t;t++)if(e[t].complete!==!0)return!1;return!0},r=function(r,n){for(var o,i=[],a=[],l=0,s=r.length;s>l;l++)o=new Image,o.src=e+r[l][1],i[l]=o,a[l]=r[l][0];var c=function(){t(i)?n(a,i):setTimeout(c,250)};c()},n=4;CLIENT_DEBUG&&util.logInfo("loading unit commands"),r(CWT_MOD_DEFAULT.graphic.units,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setUnitImageForType(t[r],e[r],view.IMAGE_CODE_IDLE,view.COLOR_RED);CLIENT_DEBUG&&util.logInfo("unit commands loaded"),n--}),CLIENT_DEBUG&&util.logInfo("loading property commands"),r(CWT_MOD_DEFAULT.graphic.properties,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setPropertyImageForType(t[r],e[r],view.COLOR_RED);CLIENT_DEBUG&&util.logInfo("property commands loaded"),n--}),CLIENT_DEBUG&&util.logInfo("loading tile commands"),r(CWT_MOD_DEFAULT.graphic.tiles,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setTileImageForType(t[r],e[r]);CLIENT_DEBUG&&util.logInfo("tile commands loaded"),n--}),CLIENT_DEBUG&&util.logInfo("loading other commands"),r(CWT_MOD_DEFAULT.graphic.misc,function(e,t){for(var r=0,o=e.length;o>r;r++)view.setInfoImageForType(t[r],e[r]);CLIENT_DEBUG&&util.logInfo("other commands loaded"),n--}),CLIENT_DEBUG&&util.logInfo("waiting for commands");var o=function(){0===n?(CLIENT_DEBUG&&util.logInfo("all images are loaded.. releasing lock"),controller.lockCommandEvaluation=!1):setTimeout(o,250)};o()}}),controller.INPUT_KEYBOARD_CODE_LEFT=37,controller.INPUT_KEYBOARD_CODE_UP=38,controller.INPUT_KEYBOARD_CODE_RIGHT=39,controller.INPUT_KEYBOARD_CODE_DOWN=40,controller.INPUT_KEYBOARD_CODE_BACKSPACE=8,controller.INPUT_KEYBOARD_CODE_ENTER=13,controller.INPUT_KEYBOARD_CODE_M=77,controller.INPUT_KEYBOARD_CODE_N=78,controller.engineAction({name:"loadInputDevices",key:"LOID",action:function(){function e(e){var t=Math.max(-1,Math.min(1,e.wheelDelta||-e.detail));t>0?controller.setScreenScale(controller.screenScale+1):controller.setScreenScale(controller.screenScale-1)}var t=new DeviceDetection(navigator.userAgent);if(t.isDesktop()&&(document.onkeyup=function(e){if("IDLE_R"===controller.stateMachine.state){var t=e.keyCode;switch(t){case controller.INPUT_KEYBOARD_CODE_LEFT:case controller.INPUT_KEYBOARD_CODE_UP:case controller.INPUT_KEYBOARD_CODE_RIGHT:case controller.INPUT_KEYBOARD_CODE_DOWN:case controller.INPUT_KEYBOARD_CODE_BACKSPACE:case controller.INPUT_KEYBOARD_CODE_ENTER:return controller.cursorActionCancel(),!1}}},document.onkeydown=function(e){CLIENT_DEBUG&&util.logInfo("got key code",e.keyCode);var t=controller.stateMachine.state,r="ACTION_MENU"===t||"ACTION_SUBMENU"===t,n=e.keyCode;switch(n){case controller.INPUT_KEYBOARD_CODE_LEFT:controller.moveCursor(model.MOVE_CODE_LEFT,1);break;case controller.INPUT_KEYBOARD_CODE_UP:r?controller.decreaseMenuCursor():controller.moveCursor(model.MOVE_CODE_UP,1);break;case controller.INPUT_KEYBOARD_CODE_RIGHT:controller.moveCursor(model.MOVE_CODE_RIGHT,1);break;case controller.INPUT_KEYBOARD_CODE_DOWN:r?controller.increaseMenuCursor():controller.moveCursor(model.MOVE_CODE_DOWN,1);break;case controller.INPUT_KEYBOARD_CODE_BACKSPACE:controller.cursorActionCancel();break;case controller.INPUT_KEYBOARD_CODE_ENTER:controller.cursorActionClick();break;case controller.INPUT_KEYBOARD_CODE_M:controller.setScreenScale(controller.screenScale+1);break;case controller.INPUT_KEYBOARD_CODE_N:controller.setScreenScale(controller.screenScale-1)}switch(n){case controller.INPUT_KEYBOARD_CODE_LEFT:case controller.INPUT_KEYBOARD_CODE_UP:case controller.INPUT_KEYBOARD_CODE_RIGHT:case controller.INPUT_KEYBOARD_CODE_DOWN:case controller.INPUT_KEYBOARD_CODE_BACKSPACE:case controller.INPUT_KEYBOARD_CODE_ENTER:case controller.INPUT_KEYBOARD_CODE_M:case controller.INPUT_KEYBOARD_CODE_N:return!1}}),head.desktop){var r=document.getElementById("cwt_canvas"),n=document.getElementById("cwt_menu"),o=!1;n.onmouseout=function(){o=!1},n.onmouseover=function(){o=!0},r.addEventListener?(r.addEventListener("mousewheel",e,!1),r.addEventListener("DOMMouseScroll",e,!1)):r.attachEvent("onmousewheel",e),r.onmousemove=function(e){var t,r;"number"==typeof e.offsetX?(t=e.offsetX,r=e.offsetY):(t=e.layerX,r=e.layerY);var t=parseInt(t/16,10),r=parseInt(r/16,10);controller.setCursorPosition(t,r)},r.onmousedown=function(e){var t=controller.stateMachine.state;if("ACTION_MENU"!==t&&"ACTION_SUBMENU"!==t||o)switch(e.which){case 1:controller.cursorActionClick();break;case 2:break;case 3:controller.cursorActionCancel()}else controller.cursorActionCancel()},r.onmouseup=function(e){if("IDLE_R"===controller.stateMachine.state)switch(e.which){case 3:controller.cursorActionCancel()}}}if(head.mobile){var i=document.getElementById("cwt_canvas"),a=new Hammer(i,{prevent_default:!0}),l=head.browser.ios,s=0,c=0;a.ontap=function(e){var t=e.position[0].x,r=e.position[0].y,n=controller.screenScale*TILE_LENGTH,t=parseInt(t/n,10),r=parseInt(r/n,10);t+=controller.screenX,r+=controller.screenY,controller.setCursorPosition(t,r),controller.cursorActionClick()},a.onhold=function(){controller.cursorActionCancel()},a.onrelease=function(){"IDLE_R"===controller.stateMachine.state&&controller.cursorActionCancel()},a.ondrag=function(e){var t=controller.stateMachine.state;if("ACTION_MENU"===t||"ACTION_SUBMENU"===t){var r=e.distanceY;s>r?(controller.decreaseMenuCursor(),c=s,s-=50):r>c&&(controller.increaseMenuCursor(),s=c,c+=50)}},a.ondragend=function(e){var t=controller.stateMachine.state;if("ACTION_MENU"===t||"ACTION_SUBMENU"===t)s=-50,c=50;else{var r=TILE_LENGTH*controller.screenScale,n=e.angle,o=0;l?n>=-135&&-45>n?o=model.MOVE_CODE_DOWN:n>=-45&&45>n?o=model.MOVE_CODE_LEFT:n>=45&&135>n?o=model.MOVE_CODE_UP:(n>=135||-135>n)&&(o=model.MOVE_CODE_RIGHT):n>=-135&&-45>n?o=model.MOVE_CODE_UP:n>=-45&&45>n?o=model.MOVE_CODE_RIGHT:n>=45&&135>n?o=model.MOVE_CODE_DOWN:(n>=135||-135>n)&&(o=model.MOVE_CODE_LEFT);var i=parseInt(e.distance/r,10);0===i&&(i=1),controller.shiftScreenPosition(o,i)}},a.ontransformend=function(e){return e.scale>1?controller.setScreenScale(controller.screenScale+1):controller.setScreenScale(controller.screenScale-1),!1}}}}),controller.engineAction({name:"loadSounds",key:"LOSO",action:function(){}}),controller.engineAction({name:"startRendering",key:"STRE",action:function(){controller.noRendering=!1,view.fitScreenToDeviceOrientation(),view.completeRedraw()}}),function(){var e=!0,t=head.browser;head.mobile?(t.ios&&t.version>=6&&(e=!1),t.android&&t.webkit&&t.version>=20&&(e=!1)):(t.ie&&t.version>=9&&(e=!1),t.safari&&t.version>=6&&(e=!1),t.chrome&&t.version>=20&&(e=!1),t.ff&&t.version>=17&&(e=!1)),e&&alert("Attention!\nYour browser is not supported!"),util.injectMod=function(e){var t=document.createElement("script");t.setAttribute("type","text/javascript"),t.setAttribute("src",e+".js"),document.getElementsByTagName("head")[0].appendChild(t)},controller.storage.has("mod")?util.injectMod(controller.storage.get("mod")):util.injectMod("mod"),util.i18n_setLanguage("en"),controller.pushSharedAction("LDMD"),controller.pushSharedAction("LOIM"),controller.pushSharedAction("CUTI"),controller.pushSharedAction("COLI"),controller.pushSharedAction("LOID"),controller.pushSharedAction("LOSO"),controller.pushSharedAction(testMapNew,"LDGM"),controller.pushSharedAction("LCFG"),controller.pushSharedAction("STRE")}();