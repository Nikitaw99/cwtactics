var CLIENT_DEBUG=!0,DEBUG=!0,CWT_ACTIONS_BUFFER_SIZE=200,CWT_MAX_MAP_WIDTH=100,CWT_MAX_MAP_HEIGHT=100,CWT_MAX_PLAYER=5,CWT_MAX_UNITS_PER_PLAYER=50,CWT_MAX_PROPERTIES=200,CWT_MAX_SELECTION_RANGE=15,CWT_MAX_MOVE_RANGE=15,CWT_MAX_BUFFER_SIZE=200,CWT_INACTIVE_ID=-1,CWT_VERSION="Milestone 2.68",model={},controller={},view={},util={};util.injectMod=function(){util.raiseError("inject mod function is not re-defined in the client")},util.fill=function(e,t){var o="function"==typeof t;if(e.__matrixArray__===!0)for(var n=0,r=e.length;r>n;n++)for(var i=0,a=e.length;a>i;i++)e[n][i]=o?t(n,i):t;else for(var n=0,r=e.length;r>n;n++)e[n]=o?t(n):t},util.list=function(e,t){void 0===t&&(t=null);for(var o="function"==typeof t,n=[],r=0;e>r;r++)n[r]=o?t(r):t;return n},util.matrix=function(e,t,o){void 0===o&&(o=null);for(var n="function"==typeof o,r=[],i=0;e>i;i++){r[i]=[];for(var a=0;t>a;a++)r[i][a]=n?o(i,a):o}return r.__matrixArray__=!0,r},util.i18n_data={en:{}},util.i18n_lang=util.i18n_data.en,util.i18n_localized=function(e){var t=this.i18n_lang[e];return void 0===t?e:t},util.i18n_setLanguage=function(e){if(!util.i18n_data.hasOwnProperty(e))throw Error("unknown language");util.i18n_lang=util.i18n_data[e]},util.i18n_appendToLanguage=function(e,t){util.i18n_data.hasOwnProperty(e)||(util.i18n_data[e]={});for(var o=util.i18n_data[e],n=Object.keys(t),r=0,i=n.length;i>r;r++)o[n[r]]=t[n[r]]},util.raiseError=function(e){throw 0===arguments.length?e="CustomWars Debug:: An error was raised":arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),Error(e)},util.log=function(e){arguments.length>1&&(e=Array.prototype.join.call(arguments," ")),console.log(e)},util.logInfo=function(){util.log.apply(this,arguments)},util.createRingBuffer=function(e){var t={push:function(e){if(null!==this._data[this._wInd])throw Error("message buffer is full");this._data[this._wInd]=e,this._wInd++,this._wInd===this._size&&(this._wInd=0)},isEmpty:function(){return null===this._data[this._rInd]},pop:function(){if(null===this._data[this._rInd])throw Error("message buffer is empty");var e=this._data[this._rInd];return this._data[this._rInd]=null,this._rInd++,this._rInd===this._size&&(this._rInd=0),e},clear:function(){this._rInd=0,this._wInd=0;for(var t=0;e>t;t++)this._data[t]=null}};return t._rInd=0,t._wInd=0,t._data=util.list(e,null),t._size=e,t},util.FUNCTION_TRUE_RETURNER=function(){return!0},util.FUNCTION_FALSE_RETURNER=function(){return!1},model.fogData=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,0),model.ruleTable={},model.ruleTable.dataLevel={funds:1e3,noUnitsLeftLoose:!1,autoSupplyAtTurnStart:!0,cityRepair:20,captureWinLimit:0,turnTimeLimit:3e6,dayLimit:0,daysOfPeace:0,unitLimit:50,blockedUnits:[],att:100,def:100,cAtt:100,funds:1e3,vision:0,moveRange:0,siloRegeneration:-1,fogEnabled:!0,usableSilo:!0,resupplyUnitOnAlliedProperties:!0,healUnitsOnProperties:!0,healUnitsOnAlliedProperties:!0},model.ruleTable.mapLevel=Object.create(model.ruleTable.dataLevel),model.ruleTable.roundLevel=Object.create(model.ruleTable.mapLevel),model.ruleTable.playerLevel=Object.create(model.ruleTable.roundLevel),model.rules=model.ruleTable.playerLevel,model.setRulesByOption=function(e){for(var t=model.sheets.defaultRules,o=model.rules,n=Object.keys(t),r=0,i=n.length;i>r;r++){var a=n[r];o[a]=e.hasOwnProperty(a)?e[a]:t[a]}},model.setRule=function(e){var t=e.split(" "),o=t[0],n=t[1];switch(o){case"siloRegenerationDays":model.rules.siloRegeneration=model.daysToTurns(n);break;case"siloRegenerationTurns":model.rules.siloRegeneration=n;break;default:util.raiseError("unknown gamerule",o)}},model.map=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.mapHeight=-1,model.mapWidth=-1,model.distance=function(e,t,o,n){var r=Math.abs(e-o),i=Math.abs(t-n);return r+i},model.moveCodeFromAtoB=function(e,t,o,n){return 1!==model.distance(e,t,o,n)&&util.raiseError("both positions haven't a distance of 1"),e>o?model.MOVE_CODE_LEFT:o>e?model.MOVE_CODE_RIGHT:t>n?model.MOVE_CODE_UP:n>t?model.MOVE_CODE_DOWN:(util.unexpectedSituationError(),void 0)},model.isValidPosition=function(e,t){return e>=0&&t>=0&&model.mapWidth>e&&model.mapHeight>t},model.thereIsAnOwnUnitAt=function(e,t,o){if(!model.isValidPosition(e,t))return!1;var n=model.unitPosMap[e][t];return null!==n&&o===n.owner},model.thereIsAnAlliedUnitAt=function(e,t,o){if(!model.isValidPosition(e,t))return!1;var n=model.unitPosMap[e][t];return null!==n&&o!==n.owner&&model.players[o].team===model.players[n.owner].team},model.thereIsAnEnemyUnitAt=function(e,t,o){if(!model.isValidPosition(e,t))return!1;var n=model.unitPosMap[e][t];return null!==n&&o!==n.owner&&model.players[o].team!==model.players[n.owner].team},model.MOVE_CODE_UP=0,model.MOVE_CODE_RIGHT=1,model.MOVE_CODE_DOWN=2,model.MOVE_CODE_LEFT=3,model.fillMoveMap=function(e){var t=e.sourceUnit,o=model.sheets.unitSheets[t.type],n=model.sheets.movetypeSheets[o.moveType],r=model.players[t.owner],i=o.moveRange,a=e.sourceX,l=e.sourceY,s=model.weather.ID;i>t.fuel&&(i=t.fuel),e.setSelectionCenter(a,l,CWT_INACTIVE_ID),e.setSelectionValueAt(a,l,i);for(var u=[a,l,i],d=[-1,-1,-1,-1,-1,-1,-1,-1];;){for(var c=-1,m=-1,p=0,h=u.length;h>p;p+=3){var _=u[p+2];void 0!==_&&null!==_&&(-1===c||_>c)&&(c=_,m=p)}if(-1===m)break;var E=u[m],f=u[m+1],T=u[m+2];u[m]=null,u[m+1]=null,u[m+2]=null,E>0?(d[0]=E-1,d[1]=f):(d[0]=-1,d[1]=-1),model.mapWidth-1>E?(d[2]=E+1,d[3]=f):(d[2]=-1,d[3]=-1),f>0?(d[4]=E,d[5]=f-1):(d[4]=-1,d[5]=-1),model.mapHeight-1>f?(d[6]=E,d[7]=f+1):(d[6]=-1,d[7]=-1);for(var A=0;8>A;A+=2)if(-1!==d[A]){var y=d[A],g=d[A+1],I=model.moveCosts(n,model.map[y][g],s);if(0!==I){var v=model.unitPosMap[y][g];if(null!==v&&model.fogData[y][g]>0&&!v.hidden&&model.players[v.owner].team!==r.team)continue;var S=T-I;if(S>=0&&S>e.getSelectionValueAt(y,g)){e.setSelectionValueAt(y,g,S);for(var p=0,h=u.length;h>=p;p+=3)if(null===u[p]||p===h){u[p]=y,u[p+1]=g,u[p+2]=S;break}}}}}for(var a=0,O=model.mapWidth;O>a;a++)for(var l=0,P=model.mapHeight;P>l;l++)if(-1!==e.getSelectionValueAt(a,l)){var I=model.moveCosts(n,model.map[a][l],s);e.setSelectionValueAt(a,l,I)}},model.addCodeToPath=function(e,t,o,n){var r=e.sourceUnit.fuel,i=0,a=e.movePath;a.push(n);var l=model.sheets.unitSheets[e.sourceUnit.type].moveRange;l>r&&(l=r);for(var s=e.sourceX,u=e.sourceY,d=0,c=a.length;c>d;d++){switch(a[d]){case model.MOVE_CODE_UP:u--;break;case model.MOVE_CODE_DOWN:u++;break;case model.MOVE_CODE_LEFT:s--;break;case model.MOVE_CODE_RIGHT:s++;break;default:util.raiseError()}i+=e.getSelectionValueAt(s,u)}i>l&&model.setPathByRecalculation(e,t,o)},model.setPathByRecalculation=function(e,t,o){var n=e.sourceX,r=e.sourceY,i=e.movePath;DEBUG&&util.log("searching path from (",n,",",r,") to (",t,",",o,")");var a=new Graph(e.selectionData),l=n-e.selectionCX,s=r-e.selectionCY,u=a.nodes[l][s],d=t-e.selectionCX,c=o-e.selectionCY,m=a.nodes[d][c],p=astar.search(a.nodes,u,m);DEBUG&&util.log("calculated way is",p);for(var h,_=[],E=n,f=r,T=0,A=p.length;A>T;T++){h=p[T];var y;h.x>E?y=model.MOVE_CODE_RIGHT:E>h.x?y=model.MOVE_CODE_LEFT:h.y>f?y=model.MOVE_CODE_DOWN:f>h.y?y=model.MOVE_CODE_UP:util.raiseError(),_.push(y),E=h.x,f=h.y}i.splice(0);for(var T=0,A=_.length;A>T;T++)i[T]=_[T]},model.players=util.list(CWT_MAX_PLAYER+1,function(e){var t=e===CWT_MAX_PLAYER;return{gold:0,team:t?9999:CWT_INACTIVE_ID,name:t?"NEUTRAL":null,mainCo:null,sideCo:null,power:0}}),model.isNeutralPlayer=function(e){return model.neutralPlayerId===e},model.extractPlayerId=function(e){null===e&&util.raiseError("player argument cannot be null");for(var t=model.players,o=0,n=t.length;n>o;o++)if(t[o]===e)return o;util.raiseError("cannot find player",t)},model.neutralPlayerId=model.players.length-1,model.alliedPlayers=function(e,t){return model.players[e].team===model.players[t].team},model.enemyPlayers=function(e,t){return model.players[e].team!==model.players[t].team},model.properties=util.list(CWT_MAX_PROPERTIES+1,function(){return{capturePoints:20,owner:-1,type:null}}),model.propertyPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.tileIsProperty=function(e,t){var o=model.propertyPosMap[e][t];return void 0!==o},model.extractPropertyId=function(e){null===e&&util.raiseError("property argument cannot be null");for(var t=model.properties,o=0,n=t.length;n>o;o++)if(t[o]===e)return o;util.raiseError("cannot find property",e)},model.countProperties=function(e){for(var t=0,o=model.properties,n=0,r=o.length;r>n;n++)o[n].owner===e&&t++;return t},model.RELATIONSHIP_SAME_OWNER=0,model.RELATIONSHIP_ALLIED=1,model.RELATIONSHIP_ENEMY=2,model.RELATIONSHIP_NONE=3,model.RELATIONSHIP_SAME_OBJECT=4,model.relationshipBetween=function(e,t){if(null===e||null===t)return model.RELATIONSHIP_NONE;if("number"!=typeof e&&"number"!=typeof t&&e===t)return model.RELATIONSHIP_SAME_OBJECT;if("number"!=typeof e&&(e=e.owner),"number"!=typeof t&&(t=t.owner),e===t)return model.RELATIONSHIP_SAME_OWNER;var o=model.players[e],n=model.players[t];return o===n?model.RELATIONSHIP_ALLIED:model.RELATIONSHIP_ENEMY},model.day=0,model.turnOwner=-1,model.leftActors=util.list(CWT_MAX_UNITS_PER_PLAYER,!1),model.canAct=function(e){var t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;if(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)return!1;var o=e-t;return model.leftActors[o]===!0},model.isTurnOwner=function(e){return model.turnOwner===e},model.daysToTurns=function(e){return model.players.length*e},model.weather=null,model.weatherDays=0,model.sheets={},model.sheets._dbAmanda=amanda("json"),model.sheets.UNIT_TYPE_SHEET=0,model.sheets.TILE_TYPE_SHEET=1,model.sheets.WEAPON_TYPE_SHEET=2,model.sheets.WEATHER_TYPE_SHEET=3,model.sheets.MOVE_TYPE_SHEET=4,model.sheets.RULESET=5,model.PRIMARY_WEAPON_TAG="mainWeapon",model.SECONDARY_WEAPON_TAG="subWeapon",model.sheets.unitSheets={},model.sheets.tileSheets={},model.sheets.weaponSheets={},model.sheets.weatherSheets={},model.sheets.movetypeSheets={},model.sheets.defaultRules=null,model.sheets.typeSheetValidators={rulesValidator:{type:"object",properties:{funds:{type:"integer",minimum:0,maximum:99999},noUnitsLeftLoose:{type:"boolean"},captureWinLimit:{type:"integer",minimum:0,maximum:99999},turnTimeLimit:{type:"integer",minimum:0,maximum:36e5},dayLimit:{type:"integer",minimum:0,maximum:99999},unitLimit:{type:"integer",minimum:1,maximum:50},blockedUnits:{type:"array"}}},unitValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},cost:{type:"integer",minimum:0},fuelConsumption:{type:"integer",minimum:0},maxAmmo:{type:"integer",minimum:0,maximum:99},maxFuel:{type:"integer",minimum:0,maximum:99,required:!0},moveRange:{type:"integer",minimum:0,maximum:15,required:!0},moveType:{type:"string",required:!0},weight:{type:"integer",required:!0}}},tileValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},capturePoints:{type:"integer",minimum:1,maximum:99},defense:{type:"integer",minimum:0,maximum:5}}},weaponValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},noMoveAndFire:{type:"boolean"}}},weatherValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},visionChange:{type:"integer"}}},movetypeValidator:{type:"object",properties:{ID:{type:"string",except:[],required:!0},costs:{type:"object",properties:{type:"object",patternProperties:{"[.]*":{type:"integer",minimum:0}}}}}}},model.sheets.toJSON=function(){return void 0},model.parseSheet=function(e,t){var o,n,r,i=e.ID,a=model.sheets.typeSheetValidators;switch(t){case model.sheets.UNIT_TYPE_SHEET:o=a.unitValidator,n=model.sheets.unitSheets,r=a.unitValidator.properties.ID.except;break;case model.sheets.TILE_TYPE_SHEET:o=a.tileValidator,n=model.sheets.tileSheets,r=a.tileValidator.properties.ID.except;break;case model.sheets.WEAPON_TYPE_SHEET:o=a.weaponValidator,n=model.sheets.weaponSheets,r=a.weaponValidator.properties.ID.except;break;case model.sheets.WEATHER_TYPE_SHEET:o=a.weatherValidator,n=model.sheets.weatherSheets,r=a.weatherValidator.properties.ID.except;break;case model.sheets.MOVE_TYPE_SHEET:o=a.movetypeValidator,n=model.sheets.movetypeSheets,r=a.movetypeValidator.properties.ID.except;break;case model.sheets.RULESET:o=a.rulesValidator;break;default:util.raiseError("unknow type",t)}t!==model.sheets.RULESET&&n.hasOwnProperty(i)&&util.raiseError(i,"is already registered"),model.sheets._dbAmanda.validate(e,o,function(e){e&&util.raiseError("failed to parse sheet due",e.getMessages())}),t===model.sheets.RULESET?model.sheets.defaultRules=e:(n[i]=e,r.push(i))},model.getListOfUnitTypes=function(){return Object.keys(model.sheets.unitSheets)},model.getListOfPropertyTypes=function(){for(var e=model.sheets.tileSheets,t=Object.keys(e),o=[],n=t.length-1;n>=0;n--)e[t[n]].capturePoints>0&&o.push(t[n]);return o},model.getListOfTileTypes=function(){for(var e=model.sheets.tileSheets,t=Object.keys(e),o=[],n=t.length-1;n>=0;n--)void 0===e[t[n]].capturePoints&&o.push(t[n]);return o},model.primaryWeaponOfUnit=function(e){DEBUG&&null===e&&util.raiseError(),"number"==typeof e&&(e=model.units[e]);var t=model.sheets.unitSheets[e.type][model.PRIMARY_WEAPON_TAG];return void 0!==t?model.sheets.weaponSheets[t]:null},model.secondaryWeaponOfUnit=function(e){DEBUG&&null===e&&util.raiseError(),"number"==typeof e&&(e=model.units[e]);var t=model.sheets.unitSheets[e.type][model.SECONDARY_WEAPON_TAG];return void 0!==t?model.sheets.weaponSheets[t]:null},model.getBaseDamage=function(e,t){DEBUG&&null===e&&util.raiseError(),DEBUG&&null===t&&util.raiseError();var o;return o=e.damages[t],void 0!==o?o:(o=e.damages["*"],void 0!==o?o:0)},model.moveCosts=function(e,t,o){var n,r=e.costs[o];return n=r[t],void 0===n&&(n=r["*"]),n},model.regeneratingSilos={},model.getLoadedIds=function(e){for(var t=[],o=model.units[e].owner,n=CWT_MAX_UNITS_PER_PLAYER*o,r=n+CWT_MAX_UNITS_PER_PLAYER;r>n;n++)if(n!==e){var i=model.units[n];null!==i&&i.loadedIn===e&&t.push(n)}return t},model.hasLoadedIds=function(e){for(var t=model.units[e].owner,o=CWT_MAX_UNITS_PER_PLAYER*t,n=o+CWT_MAX_UNITS_PER_PLAYER;n>o;o++)if(o!==e){var r=model.units[o];if(null!==r&&r.loadedIn===e)return!0}return!1},model.isLoadedBy=function(e,t){return model.units[e].loadedIn===t},model.loadUnitInto=function(e,t){model.canLoad(e,t)||util.logError("transporter unit",t,"cannot load unit",e),model.units[e].loadedIn=t},model.unloadUnitFrom=function(e){model.units[e].loadedIn=-1},model.canLoad=function(e,t){for(var o=model.units[t],n=model.units[e],r=0,i=CWT_MAX_UNITS_PER_PLAYER*o.owner,a=i+CWT_MAX_UNITS_PER_PLAYER;a>i;i++)if(i!==t){var l=model.units[i];null!==l&&l.loadedIn===t&&(r+=model.sheets.unitSheets[model.units[i].type].weight)}r+=model.sheets.unitSheets[n.type].weight;var s=model.sheets.unitSheets[o.type].transport;if(r>s.maxWeight)return!1;var u=model.sheets.unitSheets[model.units[e].type],d=s.canLoad;return-1!==d.indexOf(model.units[e].type)?!0:-1!==d.indexOf(u.moveType)?!0:-1!==d.indexOf("*")?!0:!1},model.isTransport=function(e){return void 0!==model.sheets.unitSheets[model.units[e].type].transport},model.unitPosMap=util.matrix(CWT_MAX_MAP_WIDTH,CWT_MAX_MAP_HEIGHT,null),model.units=util.list(CWT_MAX_PLAYER*CWT_MAX_UNITS_PER_PLAYER,function(){return{x:0,y:0,hp:99,ammo:0,fuel:0,type:null,loadedIn:-1,hidden:!1,owner:CWT_INACTIVE_ID}}),model.extractUnitId=function(e){null===e&&util.raiseError("unit argument cannot be null");for(var t=model.units,o=0,n=t.length;n>o;o++)if(t[o]===e)return o;util.raiseError("cannot find unit",e)},model.hasFreeUnitSlots=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,o=0,n=t+CWT_MAX_UNITS_PER_PLAYER;n>o;o++)if(model.units[o].owner!==CWT_INACTIVE_ID)return!0;return!1},model.tileOccupiedByUnit=function(e,t){var o=model.unitPosMap[e][t];return null===o?!1:model.extractUnitId(o)},model.countUnits=function(e){for(var t=e*CWT_MAX_UNITS_PER_PLAYER,o=0,n=t,r=t+CWT_MAX_UNITS_PER_PLAYER;r>n;n++)model.units[n].owner!==CWT_INACTIVE_ID&&o++;return o},model.unitHpPt=function(e){return parseInt(e.hp/10)+1},model.unitHpPtRest=function(e){var t=parseInt(e.hp/10)+1;return e.hp-t},model.ptToHp=function(e){return 10*e},controller.actions={},controller.actionObjects_={},controller.engineAction=function(e){e.hasOwnProperty("key")||util.raiseError("action key isn't defined"),controller.actionObjects_.hasOwnProperty(e.key)&&util.raiseError("action key is already registered"),e.hasOwnProperty("name")||util.raiseError("action name isn't defined"),e.hasOwnProperty("action")||util.raiseError("action implementation isn't defined"),e.hasOwnProperty("condition")||(e.condition=!1),e.hasOwnProperty("shared")||(e.shared=!1);var t=e.key;controller.actions[e.name]=function(){var e=controller.actionObjects_[t];e.action.apply(e,arguments)},controller.actionObjects_[t]=e},controller.userAction=function(e){e.hasOwnProperty("condition")||(e.condition=util.FUNCTION_TRUE_RETURNER),e.hasOwnProperty("prepareMenu")||(e.prepareMenu=null),e.hasOwnProperty("prepareTargets")||(e.prepareTargets=null),e.hasOwnProperty("isTargetValid")||(e.isTargetValid=null),e.hasOwnProperty("multiStepAction")||(e.multiStepAction=!1),e.hasOwnProperty("shared")||(e.shared=!0),null===e.prepareTargets||e.hasOwnProperty("targetSelectionType")||(e.targetSelectionType="A"),e.hasOwnProperty("createDataSet")||util.raiseError("action data set creation handler isn't defined"),null!==e.prepareTargets&&null!==e.isTargetValid&&util.raiseError("only one selection type can be used in an action"),controller.engineAction(e)},controller.clientAction=function(e){e.shared=!1,controller.userAction(e)},controller.getActionObject=function(e){return controller.actionObjects_[e]},controller.actionBuffer_=util.createRingBuffer(CWT_ACTIONS_BUFFER_SIZE),controller.pushSharedAction=function(){var e=controller.actionObjects_[arguments[arguments.length-1]];e.shared&&controller.isNetworkGame()&&this.sendNetworkMessage_(arguments),controller.pushAction.apply(this,arguments)},controller.pushAction=function(){DEBUG&&util.log("push action",JSON.stringify(arguments),"into action stack"),controller.actionBuffer_.push(arguments)},controller.noNextActions=function(){return controller.actionBuffer_.isEmpty()},controller.doNextAction=function(){if(controller.actionBuffer_.isEmpty())return null;var e=controller.actionBuffer_.pop();DEBUG&&util.log("evaluate action",JSON.stringify(e));var t=controller.actionObjects_[e[e.length-1]];return t.action.apply(t,e),e},controller.serializationHandler={"interface":{save:null,load:null,serializeUnit:null,deserializeUnit:null,serializePlayer:null,deserializePlayer:null,serializeProperty:null,deserializeProperty:null},2.6:{save:function(){var e={};e.day=model.day,e.turnOwner=model.turnOwner,e.mapWidth=model.mapWidth,e.mapHeight=model.mapHeight,e.map=[];for(var t={},o=0,n=0,r=model.mapWidth;r>n;n++){e.map[n]=[];for(var i=0,a=model.mapHeight;a>i;i++){var l=e.map[n][i];t.hasOwnProperty(l)||(t[l]=o,o++),e.map[n][i]=t[l]}}e.typeMap=[];for(var s=Object.keys(t),u=0,d=s.length;d>u;u++)e.typeMap[t[s[u]]]=s[u];e.units=[];for(var u=0,d=model.units.length;d>u;u++)model.units[u].owner!==CWT_INACTIVE_ID&&e.units.push(this.serializeUnit(model.units[u]));e.properties=[];for(var u=0,d=model.properties.length;d>u;u++)model.properties[u].owner!==CWT_INACTIVE_ID&&e.properties.push(this.serializeProperty(model.properties[u]));e.players=[];for(var u=0,d=model.players.length;d>u;u++)model.players[u].team!==CWT_INACTIVE_ID&&e.players.push(this.serializePlayer(model.players[u]));e.actors=[];for(var u=0,d=model.leftActors.length;d>u;u++)model.leftActors[u]&&e.actors.push(u);e.rules={};for(var c=Object.keys(model.rules),u=0,d=c.length;d>u;u++){var m=c[u];e.rules[m]=model.rules[m]}return e},load:function(e){model.day=e.day,model.turnOwner=e.turnOwner,model.mapWidth=e.mapWidth,model.mapHeight=e.mapHeight;for(var t=0,o=model.mapWidth;o>t;t++)for(var n=0,r=model.mapHeight;r>n;n++)model.unitPosMap[t][n]=null,model.propertyPosMap[t][n]=null,model.map[t][n]=e.typeMap[e.map[t][n]];for(var i=0,a=model.units.length;a>i;i++)model.units[i].owner=CWT_INACTIVE_ID;for(var i=0,a=e.units.length;a>i;i++)this.deserializeUnit(e.units[i]);for(var i=0,a=model.properties.length;a>i;i++)model.properties[i].owner=CWT_INACTIVE_ID;for(var i=0,a=e.properties.length;a>i;i++)this.deserializeProperty(e.properties[i]);for(var i=0,a=model.players.length;a>i;i++)model.players[i].team=CWT_INACTIVE_ID;for(var i=0,a=e.players.length;a>i;i++)this.deserializePlayer(e.players[i]);for(var i=0,a=model.leftActors.length;a>i;i++)model.leftActors[i]=!1;for(var i=0,a=e.leftActors.length;a>i;i++)model.leftActors[e.leftActors[i]]=!0;model.setRulesByOption(e.rules)},serializeUnit:function(e){return[model.extractUnitId(e),e.type,e.x,e.y,e.hp,e.ammo,e.fuel,e.loadedIn,e.owner]},deserializeUnit:function(e){var t=e[0],o=model.units[t];o.type=e[1],o.x=e[2],o.y=e[3],o.hp=e[4],o.ammo=e[5],o.fuel=e[6],o.loadedIn=e[7],o.owner=e[8],model.unitPosMap[e[2]][e[3]]=o},serializePlayer:function(e){return[e.extractPlayerId(e),e.name,e.gold,e.team]},deserializePlayer:function(e){var t=e[0],o=model.players[t];o.name=e[1],o.gold=e[2],o.team=e[3]},serializeProperty:function(e){for(var t,o,n=!1,r=0;model.mapWidth>r&&!n;r++)for(var i=0;model.mapHeight>i&&!n;i++)model.propertyPosMap[r][i]===e&&(t=r,o=i,n=!0);return[model.extractPropertyId(e),t,o,e.type,e.capturePoints,e.owner]},deserializeProperty:function(e){var t=e[0],o=model.properties[t];o.type=e[3],o.capturePoints=e[4],o.owner=e[5],model.propertyPosMap[e[1]][e[2]]=o}}},controller.CURRENT_SERIALIZATION_HANDLER="2.6",controller.getActiveSerializationHandler=function(e){return 1===arguments.length?(DEBUG&&!controller.serializationHandler.hasOwnProperty(e)&&util.raiseError("unknown map format"),controller.serializationHandler[e]):controller.serializationHandler[controller.CURRENT_SERIALIZATION_HANDLER]},controller.isNetworkGame=function(){return!1},controller._parseNetworkMessage=function(){util.unexpectedSituationError()},controller.sendNetworkMessage_=function(){util.unexpectedSituationError()},controller.eventScripts_={},controller.scripts_={},controller.SCRIPT_TRIGGER={MOVE_ON_TILE:0,MOVE_OFF_TILE:1,UNIT_ATTACKED:2},controller.SCRIPT_ACTIONS={LOG:0},controller.addScriptEvent=function(e,t,o){controller.eventScripts_[t]=[],controller.eventScripts_[t].push(o)},controller.triggerScriptEvent=function(){},controller.ruleInterpreter=function(e,t){for(var o=0,n=t.length;n>o;o++){var r=t[o],i=r[0];switch(i){case 0:e+=r[1];break;case 1:e*=r[1];break;case 2:e=r[1]}}return e},controller.stateMachine={BREAK_TRANSITION:"__BREAK_TRS__",state:"NONE",history:[],lastState:"__LAST_STATE_TRS__",structure:{},event:function(e){DEBUG&&util.log("got event",e);var t=this.structure[this.state][e];void 0===t&&util.raiseError("missing event",e,"in state",this.state);var o=t.apply(this,arguments);if(void 0!==o)if(o!==this.BREAK_TRANSITION){var n=o===this.lastState;n&&(o=1===this.history.length?"IDLE":this.history.pop());var r=this.structure[o];if(void 0===r&&util.raiseError("state",o,"is not defined"),void 0!==r.onenter){var i=r.onenter.apply(this,arguments);if(i===this.BREAK_TRANSITION)return}n||this.history.push(this.state),this.state=o,DEBUG&&util.log("changed state to",o),void 0!==r.actionState&&this.event.call(this,"actionState")}else"actionState"===e&&util.raiseError("an action state cannot return a break transition");else util.raiseError("an event must return a transition command")}},controller.stateMachine.data={setPosition_:function(e,t,o){var n;this[e[0]]=t,this[e[1]]=o;var r=-1!==t&&-1!==o,i=r?0===model.fogData[t][o]:!1;n=r?model.unitPosMap[t][o]:null,!r||i||null===n||n.hidden&&n.owner!==model.turnOwner&&model.players[n.owner].team!=model.players[model.turnOwner].team?(this[e[2]]=null,this[e[3]]=-1):(this[e[2]]=n,this[e[3]]=model.extractUnitId(n)),n=r?model.propertyPosMap[t][o]:null,r&&!i&&null!==n?(this[e[4]]=n,this[e[5]]=model.extractPropertyId(n)):(this[e[4]]=null,this[e[5]]=-1)},sourceX:0,sourceY:0,sourceUnit:null,sourceUnitId:-1,sourceProperty:null,sourcePropertyId:-1,sourceTags_:["sourceX","sourceY","sourceUnit","sourceUnitId","sourceProperty","sourcePropertyId"],setSource:function(e,t){this.setPosition_(this.sourceTags_,e,t)},targetX:0,targetY:0,targetUnit:null,targetUnitId:-1,targetProperty:null,targetPropertyId:-1,targetTags_:["targetX","targetY","targetUnit","targetUnitId","targetProperty","targetPropertyId"],setTarget:function(e,t){this.setPosition_(this.targetTags_,e,t)},selectionX:0,selectionY:0,selectionUnit:null,selectionUnitId:-1,selectionProperty:null,selectionPropertyId:-1,selectionTags_:["selectionX","selectionY","selectionUnit","selectionUnitId","selectionProperty","selectionPropertyId"],setSelectionTarget:function(e,t){this.setPosition_(this.selectionTags_,e,t)},movePath:[],cleanMovepath:function(){this.movePath.splice(0)},cloneMovepath:function(){for(var e=[],t=0,o=this.movePath.length;o>t;t++)e[t]=this.movePath[t];return e},action:null,subaction:null,actionObject:null,selectionCX:0,selectionCY:0,selectionData:util.matrix(4*CWT_MAX_SELECTION_RANGE+1,4*CWT_MAX_SELECTION_RANGE+1,0),setSelectionCenter:function(e,t,o){for(var n=this.selectionData,r=n.length,i=e,a=t,e=0;r>e;e++)for(var t=0;r>t;t++)n[e][t]=o;this.selectionCX=Math.max(0,i-2*CWT_MAX_SELECTION_RANGE),this.selectionCY=Math.max(0,a-2*CWT_MAX_SELECTION_RANGE)},getSelectionValueAt:function(e,t){var o=this.selectionData,n=this.selectionCY,r=this.selectionCX;e-=r,t-=n;var i=o.length;return 0>e||0>t||e>=i||t>=i?-1:o[e][t]},setSelectionValueAt:function(e,t,o){var n=this.selectionData,r=this.selectionCY,i=this.selectionCX;e-=i,t-=r;var a=n.length;0>e||0>t||e>=a||t>=a?util.raiseError():n[e][t]=o},prepareSelection:function(){var e=this.targetX,t=this.targetY;return this.setSelectionCenter(e,t,-1),this.actionObject.prepareTargets(this),"A"===this.actionObject.targetSelectionType?"ACTION_SELECT_TARGET_A":"ACTION_SELECT_TARGET_B"},menu:util.list(20,null),menuSize:0,addEntry:function(e){this.menuSize===this.menu.length&&util.raiseError(),this.menu[this.menuSize]=e,this.menuSize++},cleanMenu:function(){this.menuSize=0},prepareMenu:function(){var e=Object.keys(controller.actionObjects_),t=!0,o=this.sourceUnit;null===o||o.owner!==model.turnOwner?t=!1:model.canAct(this.sourceUnitId)||(t=!1);var n=!0,r=this.sourceProperty;null!==o&&(n=!1),(null===r||r.owner!==model.turnOwner)&&(n=!1);for(var i=0,a=e.length;a>i;i++){var l=controller.getActionObject(e[i]);l.condition&&(l.unitAction!==!0||t)&&(l.propertyAction!==!0||n)&&l.condition(this)&&this.addEntry(e[i])}},inMultiStep:!1},controller._turnTimerTime=0,controller.resetTurnTimer=function(){controller._turnTimerTime=0},controller.updateTurnTimer=function(e){controller._turnTimerTime>=0&&model.rules.turnTimeLimit>0&&(controller._turnTimerTime+=e,controller._turnTimerTime>model.rules.turnTimeLimit&&(controller._turnTimerTime=-1,controller.pushSharedAction("NXTR")))},controller.stateMachine.structure.ACTION_MENU={onenter:function(){return this.data.cleanMenu(),this.data.prepareMenu(),0===this.data.menuSize?(this.data.setTarget(-1,-1),this.BREAK_TRANSITION):void 0},action:function(e,t){var o=this.data.menu[t],n=controller.getActionObject(o);return this.data.action=o,this.data.actionObject=n,null!==n.prepareMenu?"ACTION_SUBMENU":null!==n.isTargetValid?"ACTION_SELECT_TILE":null!==n.prepareTargets&&"A"===n.targetSelectionType?this.data.prepareSelection():"FLUSH_ACTION"},cancel:function(){return this.data.setTarget(-1,-1),this.lastState}},controller.stateMachine.structure.ACTION_SUBMENU={onenter:function(){this.data.inMultiStep||(this.data.cleanMenu(),controller.getActionObject(this.data.action).prepareMenu(this.data),0===this.data.menuSize&&util.raiseError("sub menu cannot be empty"))},action:function(e,t){var o=this.data.menu[t];return"done"===o?"IDLE":(this.data.subAction=o,null!==this.data.actionObject.prepareTargets&&"B"===this.data.actionObject.targetSelectionType?this.data.prepareSelection():"FLUSH_ACTION")},cancel:function(){return this.data.inMultiStep?this.lastState:(this.data.cleanMenu(),this.data.prepareMenu(),this.lastState)}},controller.stateMachine.structure.FLUSH_ACTION={actionState:function(){var e=!1;if(null!==this.data.movePath)for(var t=this.data.movePath,o=this.data.sourceX,n=this.data.sourceY,r=0,i=t.length;i>r;r++){switch(t[r]){case model.MOVE_CODE_DOWN:n++;break;case model.MOVE_CODE_UP:n--;break;case model.MOVE_CODE_LEFT:o--;break;case model.MOVE_CODE_RIGHT:o++}var a=model.unitPosMap[o][n];null!==a&&model.players[model.turnOwner].team!==model.players[a.owner].team&&(this.data.action="TRWT",this.data.setTarget(o,n),t.splice(r),e=!0)}var l,s,u;return this.data.movePath.length>0&&(l="MOVE",s=controller.getActionObject(l),u=s.createDataSet(this.data),u.push(l),controller.pushSharedAction.apply(null,u)),l=this.data.action,s=this.data.actionObject,u=s.createDataSet(this.data),u.push(l),controller.pushSharedAction.apply(null,u),!e&&s.multiStepAction?(this.data.inMultiStep=!0,controller.pushSharedAction.apply(null,["IVMS"]),"MULTISTEP_IDLE"):"IDLE"}},controller.stateMachine.structure.IDLE={onenter:function(){this.data.cleanMenu(),this.data.cleanMovepath(),this.data.menuSize=0,this.data.inMultiStep=!1,this.data.action=null,this.data.subAction=null,this.data.setTarget(-1,-1),this.data.setSource(-1,-1),this.data.setSelectionTarget(-1,-1),this.history.splice(0),this.data.inMultiStep=!1},action:function(e,t,o){var n=this.data;return n.setSource(t,o),n.sourceUnitId!==CWT_INACTIVE_ID&&n.sourceUnit.owner===model.turnOwner&&model.canAct(n.sourceUnitId)?(this.data.setTarget(t,o),this.data.cleanMovepath(),model.fillMoveMap(this.data),"MOVEPATH_SELECTION"):(this.data.setTarget(t,o),"ACTION_MENU")},cancel:function(){return"IDLE_R"}},controller.stateMachine.structure.IDLE_R={onenter:function(e,t,o){return this.data.setSource(t,o),null===this.data.sourceUnit?this.BREAK_TRANSITION:(controller.getActionObject("ATUN").fillAttackableTiles(this.data),void 0)},cancel:function(){return"IDLE"}},controller.stateMachine.structure.MOVEPATH_SELECTION={onenter:function(){},action:function(e,t,o){if(0>this.data.getSelectionValueAt(t,o))return CLIENT_DEBUG&&util.log("break event because selection is not in the map"),this.BREAK_TRANSITION;var n=this.data.targetX,r=this.data.targetY,i=model.distance(n,r,t,o);if(this.data.setTarget(t,o),0===i)return"ACTION_MENU";if(1===i){var a=model.moveCodeFromAtoB(n,r,t,o);return model.addCodeToPath(this.data,t,o,a),this.BREAK_TRANSITION}return model.setPathByRecalculation(this.data,t,o),this.BREAK_TRANSITION},cancel:function(){return this.data.setTarget(-1,-1),this.lastState}},controller.stateMachine.structure.MULTISTEP_IDLE={nextStep:function(){this.data.action;var e=this.data.actionObject;return this.data.cleanMenu(),this.data.cleanMovepath(),e.prepareMenu(this.data),this.data.addEntry("done"),this.data.inMultiStep=!0,this.data.menuSize>1?"ACTION_SUBMENU":"IDLE"}},controller.stateMachine.structure.NONE={start:function(){return"IDLE"}},controller.stateMachine.structure.ACTION_SELECT_TARGET_A={action:function(e,t,o){return 0>this.data.getSelectionValueAt(t,o)?(CLIENT_DEBUG&&util.log("break event because selection is not in the map"),this.BREAK_TRANSITION):(this.data.setSelectionTarget(t,o),"FLUSH_ACTION")},cancel:function(){return this.lastState}},controller.stateMachine.structure.ACTION_SELECT_TARGET_B=controller.stateMachine.structure.ACTION_SELECT_TARGET_A,controller.stateMachine.structure.ACTION_SELECT_TILE={action:function(e,t,o){return this.data.actionObject.isTargetValid(this.data,t,o)?(this.data.setSelectionTarget(t,o),"FLUSH_ACTION"):this.BREAK_TRANSITION},cancel:function(){return this.data.setSelectionTarget(-1,-1),this.lastState}},controller.engineAction({name:"addVision",key:"AVIS",action:function(e,t,o){if(model.rules.fogEnabled!==!1){var n,r,i=t-o,a=t+o;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-o+l,r=e+o-l,0>n&&(n=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=n;n++)model.fogData[n][i]++}}}}),controller.userAction({name:"attackUnit",key:"ATUN",unitAction:!0,hasSubMenu:!0,MOVABLE_CODE:1,MOVABLE_ATTACKABLE_CODE:2,ATTACKABLE_CODE:3,fillAttackableTiles:function(e){e.sourceX,e.sourceY;
var t=e.sourceUnit;model.fillMoveMap(e);var o=e.selectionData,n=o.length;e.selectionCX,e.selectionCY;for(var r=0;n>r;r++)for(var i=0;n>i;i++)o[r][i]>=0&&(o[r][i]=this.MOVABLE_CODE);for(var r=0;n>r;r++)for(var i=0;n>i;i++)(o[r][i]===this.MOVABLE_CODE||o[r][i]===this.MOVABLE_ATTACKABLE_CODE)&&(this.markTargets(e,t,r,i,model.PRIMARY_WEAPON_TAG),this.markTargets(e,t,r,i,model.SECONDARY_WEAPON_TAG),o[r][i]===this.ATTACKABLE_CODE)},counterWeapon:function(e,t,o,n){var r=Math.abs(e-o)+Math.abs(t-n);if(r>1)return null;var i=model.unitPosMap[e][t];model.unitPosMap[o][n];var a=model.sheets.unitSheets[i.type],l=a[model.PRIMARY_WEAPON_TAG],s=a[model.SECONDARY_WEAPON_TAG];if(void 0!==l&&(l=model.sheets.weaponSheets[l],0===l.usesAmmo||i.ammo>0)){var u=l.minRange,d=l.maxRange;if(1===u&&1===d&&1===r)return l}if(void 0!==s&&(s=model.sheets.weaponSheets[s],0===s.usesAmmo||i.ammo>0)){var u=s.minRange,d=s.maxRange;if(1===u&&1===d&&1===r)return s}return null},markTargets:function(e,t,o,n,r){2===arguments.length&&(o=t.x,n=t.y),t.owner,model.players[t.owner].team;var i=model.sheets.unitSheets[t.type],a=model.sheets.weaponSheets[r===model.PRIMARY_WEAPON_TAG?i[model.PRIMARY_WEAPON_TAG]:i[model.SECONDARY_WEAPON_TAG]];if(void 0!==a){var l,s,u=a.minRange,d=a.maxRange,c=n-d,m=n+d;for(0>c&&(c=0),m>=model.mapHeight&&(m=model.mapHeight-1);m>=c;c++){var p=Math.abs(c-n);for(l=o-d+p,s=o+d-p,0>l&&(l=0),s>=model.mapWidth&&(s=model.mapWidth-1);s>=l;l++)if(model.distance(o,n,l,c)>=u){var h=e.getSelectionValueAt(l,c),_=this.ATTACKABLE_CODE;h===this.MOVABLE_CODE&&(_=this.MOVABLE_ATTACKABLE_CODE),e.setSelectionValueAt(l,c,_)}}}},hasTargets:function(e,t,o,n,r){2===arguments.length&&(o=e.x,n=e.y);var i=e.owner,a=model.players[e.owner].team,l=model.sheets.unitSheets[e.type],s=model.sheets.weaponSheets[t===model.PRIMARY_WEAPON_TAG?l[model.PRIMARY_WEAPON_TAG]:l[model.SECONDARY_WEAPON_TAG]];if(void 0===s)return!1;if(1===s.usesAmmo&&0===e.ammo)return!1;if(r&&"INDIRECT"===s.fireType)return!1;var u,d,c=s.minRange,m=s.maxRange,p=n-m,h=n+m;for(0>p&&(p=0),h>=model.mapHeight&&(h=model.mapHeight-1);h>=p;p++){var _=Math.abs(p-n);for(u=o-m+_,d=o+m-_,0>u&&(u=0),d>=model.mapWidth&&(d=model.mapWidth-1);d>=u;u++)if(model.distance(o,n,u,p)>=c){var E=model.unitPosMap[u][p];if(null!==E&&E.owner!==i&&model.players[E.owner].team!==a){if(0===model.fogData[u][p])continue;var f=model.getBaseDamage(s,E.type);if(f>0)return!0}}}},prepareMenu:function(e){var t=e.sourceUnit,o=e.targetX,n=e.targetY;this.hasTargets(t,model.PRIMARY_WEAPON_TAG,o,n,!0)&&e.addEntry("mainWeapon"),this.hasTargets(t,model.SECONDARY_WEAPON_TAG,o,n,!0)&&e.addEntry("subWeapon")},targetSelectionType:"B",prepareTargets:function(e){var t,o,n=e.sourceUnit,r=e.subAction,i=e.targetX,a=e.targetY,l="mainWeapon"===r?model.primaryWeaponOfUnit(n):model.secondaryWeaponOfUnit(n),s=n.owner,u=model.players[n.owner].team,d=l.minRange,c=l.maxRange,m=a-c,p=a+c;for(0>m&&(m=0),p>=model.mapHeight&&(p=model.mapHeight-1);p>=m;m++){var h=Math.abs(m-a);for(t=i-c+h,o=i+c-h,0>t&&(t=0),o>=model.mapWidth&&(o=model.mapWidth-1);o>=t;t++)if(model.distance(i,a,t,m)>=d){var _=model.unitPosMap[t][m];if(null!==_&&_.owner!==s&&model.players[_.owner].team!==u){if(0===model.fogData[t][m])continue;var E=model.getBaseDamage(l,_.type);E>0&&(DEBUG&&util.logInfo("found target at (",t,",",m,")"),e.setSelectionValueAt(t,m,1))}}}},condition:function(e){var t=model.rules.daysOfPeace;if(t>model.day-1)return!1;if(e.targetUnitId!==CWT_INACTIVE_ID&&e.targetUnitId!==e.sourceUnitId)return!1;var o=e.sourceUnit,n=!1;e.movePath.length>0&&(n=!0);var r=e.targetX,i=e.targetY;return null!==model.primaryWeaponOfUnit(o)&&this.hasTargets(o,model.PRIMARY_WEAPON_TAG,r,i,n)||null!==model.secondaryWeaponOfUnit(o)&&this.hasTargets(o,model.SECONDARY_WEAPON_TAG,r,i,n)?!0:!1},getEndDamage:function(e,t,o){var n,r=model.getBaseDamage(t,o.type),i=model.unitHpPt(e),a=100,l=parseInt(10*Math.random(),10),s=100;n=null!==model.propertyPosMap[o.x][o.y]?model.propertyPosMap[o.x][o.y].type:model.map[o.x][o.y];var u=model.sheets.tileSheets[n].defense,d=model.unitHpPt(o),c=(r*a/100+l)*(i/10)*((200-(s+u*d))/100);return c=parseInt(c,10),DEBUG&&util.log("attacker: ",model.extractUnitId(e),"[",r,"*",a,"/100+",l,"]*(",i,"/10)*[(200-(",s,"+",u,"*",d,"))/100]","=",c),c},createDataSet:function(e){var t="mainWeapon"===e.subAction?model.primaryWeaponOfUnit(e.sourceUnit):model.secondaryWeaponOfUnit(e.sourceUnit),o=this.getEndDamage(e.sourceUnit,t,e.selectionUnit),n=0,r=this.counterWeapon(e.selectionX,e.selectionY,e.targetX,e.targetY);return null!==r&&(n=this.getEndDamage(e.selectionUnit,r,e.sourceUnit)),[e.sourceUnitId,o,0!==t.usesAmmo,e.selectionUnitId,n,null!==r&&0!==r.usesAmmo]},action:function(e,t,o,n,r,i){controller.actions.damageUnit(n,t),controller.actions.wait(e),o&&model.units[e].ammo--;var a=model.sheets.unitSheets[model.units[n].type];controller.actions.givePower(model.units[e].owner,.5*parseInt(t/10,10)*a.cost),model.units[n].owner!==CWT_INACTIVE_ID&&(controller.actions.damageUnit(e,r),i&&model.units[n].ammo--,model.sheets.unitSheets[model.units[e].type],controller.actions.givePower(model.units[n].owner,parseInt(t/10,10)*a.cost))}}),controller.userAction({name:"buildUnit",key:"BDUN",propertyAction:!0,hasSubMenu:!0,canPropTypeBuildUnitType:function(e,t){var o=model.sheets.tileSheets[e],n=o.builds;if(void 0===n)return!1;if(-1!==model.rules.blockedUnits.indexOf(t))return!1;if(-1!==n.indexOf("*"))return!0;if(-1!==n.indexOf(t))return!0;var r=model.sheets.unitSheets[t],i=r.moveType;return-1!==n.indexOf(i)?!0:!1},getBuildList:function(e){var t=[],o=model.getListOfUnitTypes(),n=model.properties[e];model.sheets.tileSheets[n.type];for(var r=model.players[model.turnOwner].gold,i=0,a=o.length;a>i;i++)this.canPropTypeBuildUnitType(n.type,o[i])&&r>=model.sheets.unitSheets[o[i]].cost&&t.push(o[i]);return t},condition:function(e){var t=e.sourceProperty;return model.countUnits(model.turnOwner)>=model.rules.unitLimit?!1:model.hasFreeUnitSlots(model.turnOwner)&&this.getBuildList(model.extractPropertyId(t)).length>0},prepareMenu:function(e){var t=e.sourceProperty;DEBUG&&null===t&&util.raiseError();for(var o=this.getBuildList(e.sourcePropertyId),n=0,r=o.length;r>n;n++)e.addEntry(o[n])},createDataSet:function(e){return[e.sourceX,e.sourceY,e.subAction]},action:function(e,t,o){controller.actions.createUnit(e,t,model.turnOwner,o);var n=model.extractUnitId(model.unitPosMap[e][t]),r=model.players[model.turnOwner];r.gold-=model.sheets.unitSheets[o].cost,controller.actions.wait(n)}}),controller.engineAction({name:"calculateFog",key:"CCFO",action:function(e,t){var o,n,r=model.mapWidth,i=model.mapHeight,a=model.players[e].team,l=model.rules.fogEnabled;void 0===t&&(t=model.weather.ID);var s=model.sheets.weatherSheets[t].visionChange;for(void 0===s&&(s=0),o=0;r>o;o++)for(n=0;i>n;n++)model.fogData[o][n]=l?0:1;if(l)for(o=0;r>o;o++)for(n=0;i>n;n++){var u=model.unitPosMap[o][n];if(null!==u){var d=u.owner;if(e===d||model.players[d].team===a){var c=model.sheets.unitSheets[u.type].vision+s;0>c&&(c=0),controller.actions.addVision(o,n,c)}}var m=model.propertyPosMap[o][n];if(null!==m){var d=m.owner;if(e===d||model.players[d].team===a){var c=model.sheets.tileSheets[m.type].vision+s;0>c&&(c=0),controller.actions.addVision(o,n,c)}}}}}),controller.userAction({name:"captureProperty",key:"CTPR",unitAction:!0,condition:function(e){return null!==e.targetProperty&&model.turnOwner!==e.targetProperty.owner&&(null===e.targetUnit||e.targetUnit===e.sourceUnit)&&model.sheets.tileSheets[e.targetProperty.type].capturePoints>0&&model.sheets.unitSheets[e.sourceUnit.type].captures>0},createDataSet:function(e){var t=parseInt(e.sourceUnit.hp/10,10)+1;return[e.sourceUnitId,e.targetPropertyId,e.targetX,e.targetY,t]},action:function(e,t,o,n,r){var i=model.units[e],a=model.properties[t];if(model.sheets.unitSheets[i.type],i.ST_CAPTURES=!0,a.capturePoints-=r,0>=a.capturePoints){var l=o,s=n;if(DEBUG&&util.logInfo("property at (",l,",",s,") captured"),controller.actions.addVision(l,s,model.sheets.tileSheets[a.type].vision),"HQTR"===a.type){for(var u=a.owner,d=model.players[u],c=u*CWT_MAX_UNITS_PER_PLAYER,m=c+CWT_MAX_UNITS_PER_PLAYER;m>c;c++)model.units[c].owner!==CWT_INACTIVE_ID&&controller.pushAction(c,"DEUN");for(var c=0,m=model.properties.length;m>c;c++)model.properties[c].owner===u&&(model.properties[c].owner=-1);d.team=-1,a.type="CITY";for(var p=-1,c=0,m=model.players.length;m>c;c++){var h=model.players[c];if(-1!==h.team)if(-1===p)p=h.team;else if(p!==h.team){p=-1;break}}-1!==p&&controller.pushAction("EDGM")}a.capturePoints=20,a.owner=i.owner;var _=model.rules.captureWinLimit;0!==_&&model.countProperties()>=_&&controller.pushAction("EDGM")}controller.actions.wait(e)}}),controller.engineAction({name:"changeWeather",key:"CWTH",action:function(e,t){DEBUG&&util.log("changing weather to",e,"for",t,"days"),model.weatherDays=t,model.weather=model.sheets.weatherSheets[e]}}),controller.engineAction({name:"createUnit",key:"CRUN",action:function(e,t,o,n){for(var r=o*CWT_MAX_UNITS_PER_PLAYER,i=r,a=r+CWT_MAX_UNITS_PER_PLAYER;a>i;i++)if(model.units[i].owner===CWT_INACTIVE_ID){var l=model.sheets.unitSheets[n],s=model.units[i];return s.owner=o,s.hp=99,s.type=n,s.ammo=l.maxAmmo,s.fuel=l.maxFuel,s.loadedIn=-1,s.x=e,s.y=t,model.unitPosMap[e][t]=s,o===model.turnOwner&&controller.pushAction(s.x,s.y,model.sheets.unitSheets[s.type].vision,"AVIS"),DEBUG&&util.log("build unit for player",o,"in slot",i),void 0}DEBUG&&util.raiseError("cannot build unit for player",o,"no slots free")}}),controller.engineAction({name:"damageUnit",key:"DMUN",action:function(e,t){var o=model.units[e];o.hp-=t,0>=o.hp&&controller.pushAction(e,"DEUN")}}),controller.engineAction({name:"destroyUnit",key:"DEUN",action:function(e){var t=model.units[e];t.owner===model.turnOwner&&controller.pushAction(t.x,t.y,model.sheets.unitSheets[t.type].vision,"RVIS");var o=t.owner;t.owner=CWT_INACTIVE_ID,-1!==t.x&&(model.unitPosMap[t.x][t.y]=null),model.rules.noUnitsLeftLoose&&0===model.countUnits(o)&&controller.pushAction("EDGM")}}),controller.engineAction({name:"endGame",key:"EDGM",action:function(){DEBUG&&util.log("the game ends because no opposite players exists")}}),controller.userAction({name:"giveMoneyToPlayer",key:"GMTP",hasSubMenu:!0,condition:function(e){if(500>model.players[model.turnOwner].gold)return!1;var t=e.targetProperty;return null===t?!1:t.owner===model.turnOwner?!1:!0},prepareMenu:function(e){var t=model.players[model.turnOwner].gold;t>=500&&e.addEntry(500),t>=1e3&&e.addEntry(1e3),t>=2500&&e.addEntry(2500),t>=5e3&&e.addEntry(5e3),t>=1e4&&e.addEntry(1e4),t>=25e3&&e.addEntry(25e3),t>=5e4&&e.addEntry(5e4)},createDataSet:function(e){var t=e.targetUnit;return null===t&&(t=e.targetProperty),[t.owner,e.subAction]},action:function(e,t){var o=model.players[model.turnOwner],n=model.players[e];t>o.gold&&(t=o.gold),o.gold-=t,n.gold+=t}}),controller.engineAction({name:"givePower",key:"GIPO",action:function(e,t){model.players[e].power+=t}}),controller.userAction({name:"givePropertyToPlayer",key:"GPTP",propertyAction:!0,hasSubMenu:!0,condition:function(e){var t=e.sourceProperty;return null===t?!1:"HQTR"===t.type?!1:!0},prepareMenu:function(e){for(var t=0,o=CWT_MAX_PLAYER;o>t;t++)t!==model.turnOwner&&model.players[t].team!==CWT_INACTIVE_ID&&e.addEntry(t)},createDataSet:function(e){return[e.sourcePropertyId,e.subAction]},action:function(e,t){var o=model.properties[e];o.owner=t;var n,r,i=model.mapWidth,a=model.mapHeight;for(n=0;i>n;n++)for(r=0;a>r;r++)if(model.propertyPosMap[n][r]===o)return controller.pushAction(n,r,model.sheets.tileSheets[o.type].vision,"RVIS"),void 0}}),controller.userAction({name:"giveUnitToPlayer",key:"GUTP",unitAction:!0,hasSubMenu:!0,condition:function(e){var t=e.sourceUnit;if(null===t)return!1;if(null!==e.targetUnit)return!1;if(model.hasLoadedIds(e.sourceUnitId))return!1;var o=e.targetUnit;return o!==t},prepareMenu:function(e){for(var t=0,o=CWT_MAX_PLAYER;o>t;t++)t!==model.turnOwner&&model.players[t].team!==CWT_INACTIVE_ID&&e.addEntry(t)},createDataSet:function(e){return[e.sourceUnitId,e.subAction]},action:function(e,t){var o=model.units[e],n=o.x,r=o.y,i=o.owner;o.owner=CWT_INACTIVE_ID,model.players[t].team!==model.players[i].team&&controller.pushAction(o.x,o.y,model.sheets.unitSheets[o.type].vision,"RVIS"),model.unitPosMap[o.x][o.y]=null,controller.actions.createUnit(o.x,o.y,t,o.type);var a=model.unitPosMap[o.x][o.y];a.hp=o.hp,a.ammo=o.ammo,a.fuel=o.fuel,a.exp=o.exp,a.type=o.type,a.x=n,a.y=r,a.loadedIn=o.loadedIn}}),controller.engineAction({name:"healUnit",key:"HEUN",action:function(e,t){var o=model.units[e];o.hp+=t,o.hp>99&&(o.hp=99);var n=-1;90>=o.hp&&(n=parseInt(o.hp/10,10)+1),o.ST_HP_NUM=n}}),controller.userAction({name:"hideUnit",key:"HIUN",unitAction:!0,condition:function(e){if(null!==e.targetUnit)return!1;var t=e.sourceUnit;if(null===t)return!1;if(t.hidden)return!1;var o=model.sheets.unitSheets[t.type];return o.canHide},createDataSet:function(e){return[e.sourceUnitId]},action:function(e){model.units[e].hidden=!0}}),controller.engineAction({name:"invokeMultiStepAction",key:"IVMS",action:function(){controller.stateMachine.event("nextStep")}}),controller.userAction({name:"join",key:"JNUN",unitAction:!0,condition:function(e){var t=e.sourceUnit,o=e.targetUnit;return null===t||null===o||o.owner!==model.turnOwner||o===t?!1:model.hasLoadedIds(e.sourceUnitId)||model.hasLoadedIds(e.targetUnitId)?!1:t.type===o.type&&89>o.hp},createDataSet:function(e){return[e.sourceUnitId,e.targetUnitId]},action:function(e,t){var o=model.units[e],n=model.units[t],r=model.sheets.unitSheets[n.type],i=model.unitHpPt(o);model.unitHpPt(o),controller.actions.healUnit(t,model.ptToHp(i)),n.ammo+=o.ammo,n.ammo>r.maxAmmo&&(n.ammo=r.maxAmmo),n.fuel+=o.fuel,n.fuel>r.maxFuel&&(n.fuel=r.maxFuel),controller.actions.destroyUnit(e),controller.actions.wait(t)}}),controller.engineAction({name:"loadGame",key:"LDGM",action:function(e){DEBUG&&util.log("start loading game instance");var t=controller.getActiveSerializationHandler(e.format);t.load(e),model.setRulesByOption({}),controller.actions.changeWeather("SUN",4+parseInt(6*Math.random(),10)),controller.actions.calculateFog(model.turnOwner),DEBUG&&util.log("game instance successfully loaded")}}),controller.engineAction({name:"loadMod",key:"LDMD",action:function(){for(var e=0,t=CWT_MOD_DEFAULT.movetypes.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.movetypes[e],model.sheets.MOVE_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.tiles.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.tiles[e],model.sheets.TILE_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.units.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.units[e],model.sheets.UNIT_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.weapons.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.weapons[e],model.sheets.WEAPON_TYPE_SHEET);for(var e=0,t=CWT_MOD_DEFAULT.weathers.length;t>e;e++)model.parseSheet(CWT_MOD_DEFAULT.weathers[e],model.sheets.WEATHER_TYPE_SHEET);for(var o=Object.keys(CWT_MOD_DEFAULT.locale),e=0,t=o.length;t>e;e++)util.i18n_appendToLanguage(o[e],CWT_MOD_DEFAULT.locale[o[e]]);model.parseSheet(CWT_MOD_DEFAULT.rules,model.sheets.RULESET)}}),controller.userAction({name:"loadUnit",key:"LODU",unitAction:!0,condition:function(e){var t=e.sourceUnitId,o=e.targetUnitId;return-1===o||e.targetUnit.owner!==model.turnOwner?!1:model.isTransport(o)&&model.canLoad(t,o)},createDataSet:function(e){return[e.sourceUnitId,e.targetUnitId]},action:function(e,t){model.loadUnitInto(e,t)}}),controller.engineAction({name:"makeActable",key:"MKAC",action:function(e){var e="number"==typeof e?e:model.extractUnitId(e),t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)&&util.raiseError("unit owner is not the active player"),model.leftActors[e-t]=!0,DEBUG&&util.log("unit",e,"going into wait status")}}),controller.engineAction({name:"moveUnit",key:"MOVE",shared:!0,createDataSet:function(e){return[e.cloneMovepath(),e.sourceUnitId,e.sourceX,e.sourceY]},action:function(e,t,o,n){for(var r=o,i=n,a=model.units[t],l=model.sheets.unitSheets[a.type],s=model.sheets.movetypeSheets[l.moveType],u=(e.length-1,0),d=0,c=e.length;c>d;d++){switch(e[d]){case model.MOVE_CODE_UP:0===i&&util.logError("cannot do move command UP because","current position is at the border"),i--;break;case model.MOVE_CODE_RIGHT:r===model.mapWidth-1&&util.logError("cannot do move command RIGHT because","current position is at the border"),r++;break;case model.MOVE_CODE_DOWN:i===model.mapHeight-1&&util.logError("cannot do move command DOWN because","current position is at the border"),i++;break;case model.MOVE_CODE_LEFT:0===r&&util.logError("cannot do move command LEFT because","current position is at the border"),r--;break;default:util.logError("unknown command ",e[d])}u+=model.moveCosts(s,model.map[r][i],model.weather.ID)}a.fuel-=u,-1!==a.x&&-1!==a.y&&(model.unitPosMap[a.x][a.y]=null,controller.pushAction(a.x,a.y,model.sheets.unitSheets[a.type].vision,"RVIS"),a.x=-1,a.y=-1),null===model.unitPosMap[r][i]&&(a.x=r,a.y=i,model.unitPosMap[r][i]=a,controller.pushAction(r,i,model.sheets.unitSheets[a.type].vision,"AVIS")),DEBUG&&util.log("moved unit",t,"from (",o,",",n,") to (",r,",",i,")")}}),controller.engineAction({name:"moveVision",key:"MVIS",action:function(e,t,o,n,r){controller.actions.removeVision(e,t,r),controller.actions.addVision(o,n,r)}}),controller.userAction({name:"nextTurn",key:"NXTR",condition:function(e){return null===e.sourceUnit?!0:e.sourceUnit.owner===model.turnOwner?!model.canAct(e.sourceUnitId):!0},createDataSet:function(){return[]},action:function(){var e,t=model.turnOwner,o=t;t++;for(var n=1;t!==o;){if(t===CWT_MAX_PLAYER){if(t=0,model.day++,model.weatherDays--,0>=model.weatherDays){var r,i=model.weather.ID;if("SUN"!==i)r=4+parseInt(6*Math.random(),10),e="SUN";else{r=1;var a=Object.keys(model.sheets.weatherSheets),l=a.indexOf(i);-1===l&&util.raiseError(),a.splice(l,1);var s=parseInt(Math.random()*a.length,10);e=a[s]}controller.pushSharedAction(e,r,"CWTH")}var u=model.rules.dayLimit;0!==u&&model.day===u&&controller.pushSharedAction("EDGM")}if(model.players[t].team!==CWT_INACTIVE_ID)break;t++,n++}t===o&&util.raiseError(),model.turnOwner=t;var d=model.players[t];model.rules.cityRepair;for(var c=model.rules.funds,m=model.rules.autoSupplyAtTurnStart,p=model.rules.resupplyUnitOnAlliedProperties,h=model.rules.healUnitsOnProperties,_=model.rules.healUnitsOnAlliedProperties,E=t*CWT_MAX_UNITS_PER_PLAYER,f=E,T=f+CWT_MAX_UNITS_PER_PLAYER;T>f;f++){var A=model.units[f];if(model.leftActors[f-E]=null!==A,null!==A&&-1!==A.x&&A.owner!==CWT_INACTIVE_ID){m&&model.sheets.unitSheets[A.type].hasOwnProperty("supply")&&controller.pushAction(f,A.x,A.y,"TSSP");var y=model.propertyPosMap[A.x][A.y];if(null!==y&&y.owner!==CWT_INACTIVE_ID){var g=model.players[y.owner].team===d.team;(y.owner===t||p&&g)&&controller.pushAction(f,"RFRS"),h&&99>A.hp&&(y.owner===t||_&&g)&&controller.pushAction(f,20,"HEUN")}}}for(var f=0,T=CWT_MAX_PROPERTIES;T>f;f++)"SILO_EMPTY"===model.properties[f].type&&controller.actions.siloRegeneration(f,n),model.properties[f].owner===t&&(d.gold+=c);controller.actions.calculateFog(t,e),controller.resetTurnTimer()}}),controller.engineAction({name:"refillRessources",key:"RFRS",action:function(e){var t=model.units[e],o=model.sheets.unitSheets[t.type];t.ammo=o.maxAmmo,t.fuel=o.maxFuel}}),controller.engineAction({name:"removeVision",key:"RVIS",action:function(e,t,o){if(model.rules.fogEnabled!==!1){var n,r,i=t-o,a=t+o;for(0>i&&(i=0),a>=model.mapHeight&&(a=model.mapHeight-1);a>=i;i++){var l=Math.abs(i-t);for(n=e-o+l,r=e+o-l,0>n&&(n=0),r>=model.mapWidth&&(r=model.mapWidth-1);r>=n;n++)model.fogData[n][i]--}}}}),controller.engineAction({name:"saveGame",key:"SAGA",action:function(){DEBUG&&util.log("start saving game instance");var e=controller.getActiveSerializationHandler(),t=e.save();t=JSON.stringify(t,null,"	"),DEBUG&&util.log("game instance successfully saved")}}),controller.userAction({name:"silofire",key:"SLFR",unitAction:!0,_doDamage:function(e,t){if(model.isValidPosition(e,t)){var o=model.unitPosMap[e][t];null!==o&&(o.hp-=20,9>o.hp&&(o.hp=9))}},isTargetValid:function(e,t,o){return model.isValidPosition(t,o)},condition:function(e){var t=e.sourceUnit,o=e.targetProperty;return null===o||o.owner!==model.turnOwner?!1:null!==e.targetUnit?!1:"INFT"!==t.type&&"MECH"!==t.type?!1:"SILO"===o.type},createDataSet:function(e){return[e.sourceUnitId,e.targetX,e.targetY,e.targetPropertyId,e.selectionX,e.selectionY]},action:function(e,t,o,n,r,i){var a=this._doDamage,l=r,s=i;a(l,s-2),a(l-1,s-1),a(l,s-1),a(l+1,s-1),a(l-2,s),a(l-1,s),a(l,s),a(l+1,s),a(l+2,s),a(l-1,s+1),a(l,s+1),a(l+1,s+1),a(l,s+2);var u=t,d=o;model.propertyPosMap[u][d].type="SILO_EMPTY",controller.actions.wait(e)}}),controller.engineAction({name:"siloRegeneration",key:"SIRE",action:function(e,t){var o=model.rules.siloRegeneration;-1!==o&&(model.regeneratingSilos.hasOwnProperty(e)?model.regeneratingSilos[e]+=t:model.regeneratingSilos[e]=t,model.regeneratingSilos[e]>=o&&(delete model.regeneratingSilos[e],model.properties[e].type="SILO"))}}),controller.engineAction({name:"startGame",key:"STGM",action:function(){}}),controller.userAction({name:"supply",key:"SPPL",unitAction:!0,_resupplyUnitAt:function(e,t){controller.pushAction(model.extractUnitId(model.unitPosMap[e][t]),"RFRS")},condition:function(e){var t=e.sourceUnit,o=model.sheets.unitSheets[t.type];if(void 0===o.supply)return!1;var n=t.owner,r=e.targetX,i=e.targetY,a=model.thereIsAnOwnUnitAt;return a(r-1,i,n)||a(r+1,i,n)||a(r,i-1,n)||a(r,i+1,n)},createDataSet:function(e){return[e.sourceUnitId,e.targetX,e.targetY]},action:function(e,t,o){var n=model.units[e],r=n.owner,i=model.thereIsAnOwnUnitAt,a=this._resupplyUnitAt;i(t-1,o,r)&&a(t-1,o),i(t+1,o,r)&&a(t+1,o),i(t,o-1,r)&&a(t,o-1),i(t,o+1,r)&&a(t,o+1),controller.actions.wait(e)}}),controller.engineAction({name:"trapWait",key:"TRWT",createDataSet:function(e){return[e.selectionUnitId]},action:function(e){controller.actions.wait(e)}}),controller.engineAction({name:"supplyTurnStart",key:"TSSP",action:function(e,t,o){controller.actions.supply(e,t,o),controller.actions.makeActable(e)}}),controller.userAction({name:"unhideUnit",key:"UHUN",unitAction:!0,condition:function(e){if(null!==e.targetUnit)return!1;var t=e.sourceUnit;return null===t?!1:t.hidden},createDataSet:function(e){return[e.sourceUnitId]},action:function(e){model.units[e].hidden=!1}}),controller.userAction({name:"unloadUnit",key:"UNUN",unitAction:!0,multiStepAction:!0,condition:function(e){if(e.sourceUnit,null!==e.targetUnit)return!1;var t=e.sourceUnitId;return model.isTransport(t)&&model.hasLoadedIds(t)},prepareMenu:function(e){for(var t=e.sourceUnitId,o=model.getLoadedIds(t),n=0,r=o.length;r>n;n++)e.addEntry(o[n])},targetSelectionType:"B",prepareTargets:function(e){var t=e.subAction,o=e.targetX,n=e.targetY,r=model.units[t],i=model.sheets.unitSheets[r.type],a=model.sheets.movetypeSheets[i.moveType];o>0&&null===model.unitPosMap[o-1][n]&&-1!==model.moveCosts(a,model.map[o-1][n])&&e.setSelectionValueAt(o-1,n,1),n>0&&null===model.unitPosMap[o][n-1]&&-1!==model.moveCosts(a,model.map[o][n-1])&&e.setSelectionValueAt(o,n-1,1),model.mapHeight-1>n&&null===model.unitPosMap[o][n+1]&&-1!==model.moveCosts(a,model.map[o][n+1])&&e.setSelectionValueAt(o,n+1,1),model.mapWidth-1>o&&null===model.unitPosMap[o+1][n]&&-1!==model.moveCosts(a,model.map[o+1][n])&&e.setSelectionValueAt(o+1,n,1)},createDataSet:function(e){return[e.sourceUnitId,e.targetX,e.targetY,e.subAction,e.selectionX,e.selectionY]},action:function(e,t,o,n,r,i){controller.actions.wait(e),model.unloadUnitFrom(n,e);var a;t>r?a=model.MOVE_CODE_LEFT:r>t?a=model.MOVE_CODE_RIGHT:o>i?a=model.MOVE_CODE_UP:i>o&&(a=model.MOVE_CODE_DOWN),controller.pushAction([a],n,t,o,"MOVE"),controller.pushAction(n,"WTUN")}}),controller.userAction({name:"wait",key:"WTUN",unitAction:!0,condition:function(e){return null===e.targetUnit||e.targetUnit===e.sourceUnit},createDataSet:function(e){return[e.sourceUnitId]},action:function(e){var e="number"==typeof e?e:model.extractUnitId(e),t=model.turnOwner*CWT_MAX_UNITS_PER_PLAYER;(e>=t+CWT_MAX_UNITS_PER_PLAYER||t>e)&&util.raiseError("unit owner is not the active player"),model.leftActors[e-t]=!1,DEBUG&&util.log("unit",e,"going into wait status")}});