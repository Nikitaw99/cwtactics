<!DOCTYPE html>

<html>
<head>
  <title>cwScript.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="actions.html">
                actions.js
              </a>
            
              
              <a class="source" href="ai.html">
                ai.js
              </a>
            
              
              <a class="source" href="async.html">
                async.js
              </a>
            
              
              <a class="source" href="audio.html">
                audio.js
              </a>
            
              
              <a class="source" href="circularBuffer.html">
                circularBuffer.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="constants.html">
                constants.js
              </a>
            
              
              <a class="source" href="cwScript.html">
                cwScript.js
              </a>
            
              
              <a class="source" href="error.html">
                error.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="functions.html">
                functions.js
              </a>
            
              
              <a class="source" href="image.html">
                image.js
              </a>
            
              
              <a class="source" href="input.html">
                input.js
              </a>
            
              
              <a class="source" href="loading.html">
                loading.js
              </a>
            
              
              <a class="source" href="localization.html">
                localization.js
              </a>
            
              
              <a class="source" href="main.html">
                main.js
              </a>
            
              
              <a class="source" href="matrix.html">
                matrix.js
              </a>
            
              
              <a class="source" href="model.html">
                model.js
              </a>
            
              
              <a class="source" href="network.html">
                network.js
              </a>
            
              
              <a class="source" href="renderer.html">
                renderer.js
              </a>
            
              
              <a class="source" href="sheets.html">
                sheets.js
              </a>
            
              
              <a class="source" href="statemachine.html">
                statemachine.js
              </a>
            
              
              <a class="source" href="storage.html">
                storage.js
              </a>
            
              
              <a class="source" href="systemFeatures.html">
                systemFeatures.js
              </a>
            
              
              <a class="source" href="tileVariants.html">
                tileVariants.js
              </a>
            
              
              <a class="source" href="uiWidgets.html">
                uiWidgets.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>cwScript.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>cwScript is a simple script engine which allows to code events in the modification file without shipping 
real javaScript code. This is safer and we can control the event flow. The performance overall will be slower,
but normally the events should not be very heavy. So this can be ignored.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">
"use strict"</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseExpression</span><span class="hljs-params">(program)</span> </span>{
  program = skipSpace(program);
  <span class="hljs-keyword">var</span> match, expr;
  <span class="hljs-keyword">if</span> (match = <span class="hljs-regexp">/^"([^"]*)"/</span>.exec(program))
    expr = {type: <span class="hljs-string">"value"</span>, value: match[<span class="hljs-number">1</span>]};
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (match = <span class="hljs-regexp">/^\d+\b/</span>.exec(program))
    expr = {type: <span class="hljs-string">"value"</span>, value: <span class="hljs-built_in">Number</span>(match[<span class="hljs-number">0</span>])};
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (match = <span class="hljs-regexp">/^[^\s(),"]+/</span>.exec(program))
    expr = {type: <span class="hljs-string">"word"</span>, name: match[<span class="hljs-number">0</span>]};
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Unexpected syntax: "</span> + program);

  <span class="hljs-keyword">return</span> parseApply(expr, program.slice(match[<span class="hljs-number">0</span>].length));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseApply</span><span class="hljs-params">(expr, program)</span> </span>{
  program = skipSpace(program);
  <span class="hljs-keyword">if</span> (program[<span class="hljs-number">0</span>] != <span class="hljs-string">"("</span>)
    <span class="hljs-keyword">return</span> {expr: expr, rest: program};

  program = skipSpace(program.slice(<span class="hljs-number">1</span>));
  expr = {type: <span class="hljs-string">"apply"</span>, operator: expr, args: []};
  <span class="hljs-keyword">while</span> (program[<span class="hljs-number">0</span>] != <span class="hljs-string">")"</span>) {
    <span class="hljs-keyword">var</span> arg = parseExpression(program);
    expr.args.push(arg.expr);
    program = skipSpace(arg.rest);
    <span class="hljs-keyword">if</span> (program[<span class="hljs-number">0</span>] == <span class="hljs-string">","</span>)
      program = skipSpace(program.slice(<span class="hljs-number">1</span>));
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (program[<span class="hljs-number">0</span>] != <span class="hljs-string">")"</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Expected ',' or ')'"</span>);
  }
  <span class="hljs-keyword">return</span> parseApply(expr, program.slice(<span class="hljs-number">1</span>));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">skipSpace</span><span class="hljs-params">(string)</span> </span>{
  <span class="hljs-keyword">var</span> first = string.search(<span class="hljs-regexp">/\S/</span>);
  <span class="hljs-keyword">if</span> (first == -<span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
  <span class="hljs-keyword">return</span> string.slice(first);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parse</span><span class="hljs-params">(program)</span> </span>{
  <span class="hljs-keyword">var</span> result = parseExpression(program);
  <span class="hljs-keyword">if</span> (skipSpace(result.rest).length &gt; <span class="hljs-number">0</span>)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Unexpected text after program"</span>);
  <span class="hljs-keyword">return</span> result.expr;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">evaluate</span><span class="hljs-params">(expr, env)</span> </span>{
  <span class="hljs-keyword">switch</span>(expr.type) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"value"</span>:
      <span class="hljs-keyword">return</span> expr.value;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"word"</span>:
      <span class="hljs-keyword">if</span> (expr.name <span class="hljs-keyword">in</span> env)
        <span class="hljs-keyword">return</span> env[expr.name];
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ReferenceError</span>(<span class="hljs-string">"Undefined variable: "</span> + expr.name);
		
    <span class="hljs-keyword">case</span> <span class="hljs-string">"apply"</span>:
      <span class="hljs-keyword">if</span> (expr.operator.type == <span class="hljs-string">"word"</span> &amp;&amp;
          expr.operator.name <span class="hljs-keyword">in</span> specialForms)
        <span class="hljs-keyword">return</span> specialForms[expr.operator.name](expr.args,
                                                env);
      <span class="hljs-keyword">var</span> op = evaluate(expr.operator, env);
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> op != <span class="hljs-string">"function"</span>)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"Applying a non-function."</span>);
      <span class="hljs-keyword">return</span> op.apply(<span class="hljs-literal">null</span>, expr.args.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg)</span> </span>{
        <span class="hljs-keyword">return</span> evaluate(arg, env);
      }));
  }
}

<span class="hljs-keyword">var</span> specialForms = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);
<span class="hljs-keyword">var</span> topEnv = <span class="hljs-built_in">Object</span>.create(<span class="hljs-literal">null</span>);

specialForms[<span class="hljs-string">"if"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, env)</span> </span>{
  <span class="hljs-keyword">if</span> (args.length != <span class="hljs-number">3</span>)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Bad number of args to if"</span>);

  <span class="hljs-keyword">if</span> (evaluate(args[<span class="hljs-number">0</span>], env) !== <span class="hljs-literal">false</span>)
    <span class="hljs-keyword">return</span> evaluate(args[<span class="hljs-number">1</span>], env);
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> evaluate(args[<span class="hljs-number">2</span>], env);
};

specialForms[<span class="hljs-string">"while"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, env)</span> </span>{
  <span class="hljs-keyword">if</span> (args.length != <span class="hljs-number">2</span>)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Bad number of args to while"</span>);

  <span class="hljs-keyword">while</span> (evaluate(args[<span class="hljs-number">0</span>], env) !== <span class="hljs-literal">false</span>) {
    evaluate(args[<span class="hljs-number">1</span>], env);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Since undefined does not exist in Egg, we return false,
for lack of a meaningful result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

specialForms[<span class="hljs-string">"for"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, env)</span> </span>{
  <span class="hljs-keyword">if</span> (args.length != <span class="hljs-number">4</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Bad number of args to while"</span>);
	
  <span class="hljs-keyword">var</span> inc = <span class="hljs-built_in">parseInt</span>(evaluate(args[<span class="hljs-number">2</span>], env),<span class="hljs-number">10</span>);
  <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = evaluate(args[<span class="hljs-number">0</span>], env), e = evaluate(args[<span class="hljs-number">1</span>], env); i&lt;e; i += inc ) {
    evaluate(args[<span class="hljs-number">3</span>], env);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Since undefined does not exist in Egg, we return false,
for lack of a meaningful result.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};

specialForms[<span class="hljs-string">"do"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, env)</span> </span>{
  <span class="hljs-keyword">var</span> value = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = args.length; i&lt;e; i++ ){
	value = evaluate(args[i], env);
  }
  <span class="hljs-keyword">return</span> value;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
specialForms[<span class="hljs-string">"+="</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg, env)</span> </span>{
  env[arg[<span class="hljs-number">0</span>].name] += arg[<span class="hljs-number">1</span>].value;
  <span class="hljs-keyword">return</span> env[arg[<span class="hljs-number">0</span>].name];
};

specialForms[<span class="hljs-string">"-="</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg, env)</span> </span>{
  env[arg[<span class="hljs-number">0</span>].name] -= arg[<span class="hljs-number">1</span>].value;
  <span class="hljs-keyword">return</span> env[arg[<span class="hljs-number">0</span>].name];
};

specialForms[<span class="hljs-string">"*="</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg, env)</span> </span>{
  env[arg[<span class="hljs-number">0</span>].name] *= arg[<span class="hljs-number">1</span>].value;
  <span class="hljs-keyword">return</span> env[arg[<span class="hljs-number">0</span>].name];
};

specialForms[<span class="hljs-string">"/="</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(arg, env)</span> </span>{
  env[arg[<span class="hljs-number">0</span>].name] /= arg[<span class="hljs-number">1</span>].value;
  <span class="hljs-keyword">return</span> env[arg[<span class="hljs-number">0</span>].name];
};

[<span class="hljs-string">"+"</span>, <span class="hljs-string">"-"</span>, <span class="hljs-string">"*"</span>, <span class="hljs-string">"/"</span>, <span class="hljs-string">"=="</span>, <span class="hljs-string">"&lt;"</span>, <span class="hljs-string">"&gt;"</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(op)</span> </span>{
  topEnv[op] = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(<span class="hljs-string">"a, b"</span>, <span class="hljs-string">"return a "</span> + op + <span class="hljs-string">" b;"</span>);
});</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
specialForms[<span class="hljs-string">"define"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, env)</span> </span>{
  <span class="hljs-keyword">if</span> (args.length != <span class="hljs-number">2</span> || args[<span class="hljs-number">0</span>].type != <span class="hljs-string">"word"</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Bad use of define"</span>);
  }
  
  <span class="hljs-keyword">var</span> value = evaluate(args[<span class="hljs-number">1</span>], env);
  env[args[<span class="hljs-number">0</span>].name] = value;
  <span class="hljs-keyword">return</span> value;
};

specialForms[<span class="hljs-string">"fun"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, env)</span> </span>{
  <span class="hljs-keyword">if</span> (!args.length)
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Functions need a body"</span>);
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">name</span><span class="hljs-params">(expr)</span> </span>{
    <span class="hljs-keyword">if</span> (expr.type != <span class="hljs-string">"word"</span>)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">SyntaxError</span>(<span class="hljs-string">"Arg names must be words"</span>);
    <span class="hljs-keyword">return</span> expr.name;
  }
  <span class="hljs-keyword">var</span> argNames = args.slice(<span class="hljs-number">0</span>, args.length - <span class="hljs-number">1</span>).map(name);
  <span class="hljs-keyword">var</span> body = args[args.length - <span class="hljs-number">1</span>];

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length != argNames.length)
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"Wrong number of arguments"</span>);
    <span class="hljs-keyword">var</span> localEnv = <span class="hljs-built_in">Object</span>.create(env);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">arguments</span>.length; i++)
      localEnv[argNames[i]] = <span class="hljs-built_in">arguments</span>[i];
    <span class="hljs-keyword">return</span> evaluate(body, localEnv);
  };
};

specialForms[<span class="hljs-string">"set"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(args, env)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Your code here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>};

topEnv[<span class="hljs-string">"print"</span>] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> </span>{
  <span class="hljs-built_in">console</span>.log(value);
  <span class="hljs-keyword">return</span> value;
};

topEnv[<span class="hljs-string">"true"</span>] = <span class="hljs-literal">true</span>;
topEnv[<span class="hljs-string">"false"</span>] = <span class="hljs-literal">false</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> env = <span class="hljs-built_in">Object</span>.create(topEnv);
  <span class="hljs-keyword">var</span> program = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>).join(<span class="hljs-string">"\n"</span>);
  <span class="hljs-keyword">return</span> evaluate(parse(program), env);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
exports.parse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code)</span> </span>{

};

exports.run = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ast)</span> </span>{

};

exports.evaluate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code)</span> </span>{
  <span class="hljs-keyword">return</span> exports.run(exports.parse(code));
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
