<!DOCTYPE html>

<html>
<head>
  <title>states.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="audio.html">
                audio.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="image.html">
                image.js
              </a>
            
              
              <a class="source" href="keyMapping.html">
                keyMapping.js
              </a>
            
              
              <a class="source" href="maps.html">
                maps.js
              </a>
            
              
              <a class="source" href="mod.html">
                mod.js
              </a>
            
              
              <a class="source" href="roundSetup.html">
                roundSetup.js
              </a>
            
              
              <a class="source" href="savegame.html">
                savegame.js
              </a>
            
              
              <a class="source" href="states.html">
                states.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>states.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Shared data that will be used between the states.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> model = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../model"</span>);
<span class="hljs-keyword">var</span> actions = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../actions"</span>);
<span class="hljs-keyword">var</span> renderer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../renderer"</span>);
<span class="hljs-keyword">var</span> constants = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../constants"</span>);
<span class="hljs-keyword">var</span> stateMachine = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../statemachine"</span>);
<span class="hljs-keyword">var</span> circularBuffer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../circularBuffer"</span>);

<span class="hljs-keyword">var</span> relationship = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../logic/relationship"</span>);
<span class="hljs-keyword">var</span> explode = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../logic/exploder"</span>);
<span class="hljs-keyword">var</span> move = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../logic/move"</span>);
<span class="hljs-keyword">var</span> co = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../logic/co"</span>);

<span class="hljs-keyword">var</span> invokeActionByData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> p1 = constants.INACTIVE;
  <span class="hljs-keyword">var</span> p2 = constants.INACTIVE;
  <span class="hljs-keyword">var</span> p3 = constants.INACTIVE;
  <span class="hljs-keyword">var</span> p4 = constants.INACTIVE;
  <span class="hljs-keyword">var</span> p5 = constants.INACTIVE;
  <span class="hljs-keyword">var</span> action = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">switch</span> (action) {

    <span class="hljs-keyword">case</span> <span class="hljs-string">"wait"</span>:
      p1 = exports.source.unitId;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"joinUnits"</span>:
      p1 = exports.source.unitId;
      p2 = exports.target.x;
      p3 = exports.target.y;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"supply"</span>:
      p1 = exports.target.x;
      p2 = exports.target.y;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"buildUnit"</span>:
      p1 = exports.target.propertyId;
      p2 = exports.action.selectedSubEntry;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"explode"</span>:
      p1 = exports.source.x;
      p2 = exports.source.y;
      p3 = explode.getSuicideRange(exports.source.unit);
      p4 = explode.getExplosionDamage(exports.source.unit);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"capture"</span>:
      p1 = exports.target.propertyId;
      p2 = exports.source.unitId;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"unloadUnit"</span>:
      p1 = exports.source.unitId;
      p2 = exports.target.x;
      p3 = exports.target.y;
      p4 = exports.action.selectedSubEntry;
      p5 = exports.targetselection.x;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>data.targetselection.y</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"loadUnit"</span>:
      p1 = exports.target.unitId;
      p2 = exports.source.unitId;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferUnit"</span>:
      p1 = exports.source.unitId;
      p2 = exports.selectedSubEntry;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferProperty"</span>:
      p1 = exports.source.propertyId;
      p2 = exports.selectedSubEntry;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferMoney"</span>:
      p1 = model.turnOwner.id;
      p2 = exports.target.property.owner.id;
      p3 = exports.selectedSubEntry;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"unitUnhide"</span>:
      p1 = exports.source.unitId;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"unitHide"</span>:
      p1 = exports.source.unitId;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"attack"</span>:
      p1 = exports.source.unitId;
      p2 = exports.targetselection.unitId;
      p3 = <span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>);
      p4 = <span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"activatePower"</span>:
      p1 = (data.action.selectedSubEntry === <span class="hljs-string">"cop"</span> ? co.POWER_LEVEL_COP :
        (data.action.selectedSubEntry === <span class="hljs-string">"scop"</span> ? co.POWER_LEVEL_SCOP : -<span class="hljs-number">1</span>));
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">default</span>:
      <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"unknown action"</span>);
  }

  actions.sharedAction(action, p1, p2, p3, p4, p5);
};

<span class="hljs-keyword">var</span> checkConditionByData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(action)</span> </span>{
  <span class="hljs-keyword">var</span> conditionResult = <span class="hljs-literal">true</span>;

  <span class="hljs-keyword">switch</span> (action.key) {

    <span class="hljs-keyword">case</span> <span class="hljs-string">"wait"</span>:
      conditionResult = action.condition(exports.source.unit);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"explode"</span>:
      conditionResult = action.condition(exports.source.unit);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"joinUnits"</span>:
      conditionResult = action.condition(exports.source.unit, exports.target.unit);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"supply"</span>:
      conditionResult = action.condition(exports.target.unit, exports.target.x, exports.target.y);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"buildUnit"</span>:
      conditionResult = action.condition(exports.source.property);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"capture"</span>:
      conditionResult = action.condition(exports.source.unit, exports.target.property);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"unloadUnit"</span>:
      conditionResult = action.condition(exports.source.unit, exports.target.x, exports.target.y);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"loadUnit"</span>:
      conditionResult = action.condition(exports.target.unit, exports.source.unit);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferUnit"</span>:
      conditionResult = action.condition(exports.source.unit);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferProperty"</span>:
      conditionResult = action.condition(exports.source.property);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferMoney"</span>:
      conditionResult = action.condition(model.turnOwner, exports.target.x, exports.target.y);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"unitUnhide"</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">"unitHide"</span>:
      conditionResult = action.condition(exports.source.unit);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"attack"</span>:
      conditionResult = action.condition(
        exports.source.unit,
        exports.target.x, exports.target.y,
        exports.movePath.data[<span class="hljs-number">0</span>] !== constants.INACTIVE
      );
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"activatePower"</span>:
      conditionResult = action.condition(model.turnOwner);
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">return</span> conditionResult;
};

<span class="hljs-keyword">var</span> prepareTargetsByData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(action)</span> </span>{
  <span class="hljs-keyword">switch</span> (action.key) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"unloadUnit"</span>:
      action.prepareTargets(
        exports.source.unitId,
        exports.target.x, exports.target.y,
        exports.action.selectedSubEntry,
        exports.selection
      );
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"attack"</span>:
      action.prepareTargets(exports.source.unit, exports.target.x, exports.target.y, exports.selection);
      <span class="hljs-keyword">break</span>;
  }
};

<span class="hljs-keyword">var</span> prepareMenuByData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(action)</span> </span>{
  <span class="hljs-keyword">switch</span> (action.key) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"buildUnit"</span>:
      action.prepareMenu(exports.source.property, exports.menu);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"unloadUnit"</span>:
      action.prepareMenu(exports.source.unit, exports.target.x, exports.target.y, exports.menu);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferUnit"</span>:
      action.prepareMenu(exports.source.unit.owner, exports.menu);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferProperty"</span>:
      action.prepareMenu(exports.source.property.owner, exports.menu);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"transferMoney"</span>:
      action.prepareMenu(model.turnOwner, exports.menu);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">"activatePower"</span>:
      action.prepareMenu(model.turnOwner, exports.menu);
      <span class="hljs-keyword">break</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>X coordinate of the cursor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.cursorX = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Y coordinate of the cursor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.cursorY = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.resetCursor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  exports.cursorX = <span class="hljs-number">0</span>;
  exports.cursorY = <span class="hljs-number">0</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Moves the cursor into a given direction.</p>
<p>@param {number} dir</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.moveCursor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(dir)</span> </span>{
  <span class="hljs-keyword">var</span> len = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">var</span> x = exports.cursorX;
  <span class="hljs-keyword">var</span> y = exports.cursorY;

  <span class="hljs-keyword">switch</span> (dir) {

    <span class="hljs-keyword">case</span> move.MOVE_CODES_UP :
      y -= len;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> move.MOVE_CODES_RIGHT :
      x += len;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> move.MOVE_CODES_DOWN  :
      y += len;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> move.MOVE_CODES_LEFT  :
      x -= len;
      <span class="hljs-keyword">break</span>;
  }

  exports.setCursorPosition(x, y);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Moves the cursor to a given position. The view will be moved as well with
this function to make sure that the cursor is on the visible view.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.setCursorPosition = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, relativeToScreen)</span> </span>{
  <span class="hljs-keyword">if</span> (relativeToScreen) {
    x = x + renderer.screenOffsetX;
    y = y + renderer.screenOffsetY;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>change illegal positions to prevent out of bounds</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) x = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (y &lt; <span class="hljs-number">0</span>) y = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (x &gt;= model.mapWidth) x = model.mapWidth - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> (y &gt;= model.mapHeight) y = model.mapHeight - <span class="hljs-number">1</span>;

  <span class="hljs-keyword">if</span> (x === <span class="hljs-keyword">this</span>.x &amp;&amp; y === <span class="hljs-keyword">this</span>.y) {
    <span class="hljs-keyword">return</span>;
  }

  renderer.eraseCursor();

  <span class="hljs-keyword">this</span>.x = x;
  <span class="hljs-keyword">this</span>.y = y;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>convert to screen relative pos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  x = x - renderer.screenOffsetX;
  y = y - renderer.screenOffsetY;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> moveCode = constants.INACTIVE;
  <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">3</span>) {
    moveCode = move.MOVE_CODES_RIGHT;
    <span class="hljs-keyword">if</span> (renderer.shiftScreen(moveCode)) {
      renderer.shiftMap(moveCode);
    }

  }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (x &gt;= constants.SCREEN_WIDTH - <span class="hljs-number">3</span>) {
    moveCode = move.MOVE_CODES_LEFT;
    <span class="hljs-keyword">if</span> (renderer.shiftScreen(moveCode)) {
      renderer.shiftMap(moveCode);
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (y &lt;= <span class="hljs-number">3</span>) {
    moveCode = move.MOVE_CODES_DOWN;
    <span class="hljs-keyword">if</span> (renderer.shiftScreen(moveCode)) {
      renderer.shiftMap(moveCode);
    }

  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>do possible screen shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (y &gt;= constants.SCREEN_HEIGHT - <span class="hljs-number">3</span>) {
    moveCode = move.MOVE_CODES_UP;
    <span class="hljs-keyword">if</span> (renderer.shiftScreen(moveCode)) {
      renderer.shiftMap(moveCode);
    }
  }

  renderer.renderCursor();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.fromIngameToOptions = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.inGameRound = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.multiStepActive = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Builds several commands from collected action data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.buildFromData = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  <span class="hljs-keyword">var</span> trapped = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (exports.movePath.data[<span class="hljs-number">0</span>] !== -<span class="hljs-number">1</span>) {
    trapped = move.trapCheck(exports.movePath, exports.source, exports.target);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>TODO</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!trapped) {
    invokeActionByData();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>all unit actions invokes automatically waiting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (trapped || exports.action.object.type === actions.UNIT_ACTION &amp;&amp; !exports.action.object.noAutoWait) {
    actions.sharedAction(<span class="hljs-string">"wait"</span>, exports.source.unitId);
  }

  <span class="hljs-keyword">return</span> trapped;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Position object with rich information about the selected position by an action and some relations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.source = <span class="hljs-keyword">new</span> model.PositionData();</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Position object with rich information about the selected position by an action and some relations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.target = <span class="hljs-keyword">new</span> model.PositionData();</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Position object with rich information about the selected position by an action and some relations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.targetselection = <span class="hljs-keyword">new</span> model.PositionData();</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.selection = {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>@private */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  len_: constants.MAX_MOVE_LENGTH * <span class="hljs-number">4</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>@private */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  data_: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>@private */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  centerX_: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>@private */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  centerY_: <span class="hljs-number">0</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>@override */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getData: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data_;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>@override */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getCenterX: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.centerX_;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>@override */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getCenterY: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.centerY_;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>@override */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setCenter: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, defValue)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>lazy initialization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.data_) {
      <span class="hljs-keyword">this</span>.data_ = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-keyword">this</span>.len_; i++) {
        <span class="hljs-keyword">this</span>.data_[i] = [];
      }
    }

    <span class="hljs-keyword">this</span>.centerX_ = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, x - (<span class="hljs-keyword">this</span>.len_ - <span class="hljs-number">1</span>));
    <span class="hljs-keyword">this</span>.centerY_ = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, y - (<span class="hljs-keyword">this</span>.len_ - <span class="hljs-number">1</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>clean data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> rx = <span class="hljs-number">0</span>; rx &lt; <span class="hljs-keyword">this</span>.len_; rx++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> ry = <span class="hljs-number">0</span>; ry &lt; <span class="hljs-keyword">this</span>.len_; ry++) {
        <span class="hljs-keyword">this</span>.data_[rx][ry] = defValue;
      }
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>@override */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  getValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> </span>{
    x = x - <span class="hljs-keyword">this</span>.centerX_;
    y = y - <span class="hljs-keyword">this</span>.centerY_;

    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span> || y &lt; <span class="hljs-number">0</span> || x &gt;= <span class="hljs-keyword">this</span>.len_ || y &gt;= <span class="hljs-keyword">this</span>.len_) {
      <span class="hljs-keyword">return</span> constants.INACTIVE;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.data_[x][y];
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>@override */</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setValue: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, value)</span> </span>{
    x = x - <span class="hljs-keyword">this</span>.centerX_;
    y = y - <span class="hljs-keyword">this</span>.centerY_;

    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span> || y &lt; <span class="hljs-number">0</span> || x &gt;= <span class="hljs-keyword">this</span>.len_ || y &gt;= <span class="hljs-keyword">this</span>.len_) {
      <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Out of Bounds"</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.data_[x][y] = value;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>@param {number} x
@param {number} y
@return {boolean}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  hasActiveNeighbour: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> </span>{
    x = x - <span class="hljs-keyword">this</span>.centerX_;
    y = y - <span class="hljs-keyword">this</span>.centerY_;

    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span> || y &lt; <span class="hljs-number">0</span> || x &gt;= <span class="hljs-keyword">this</span>.len_ || y &gt;= <span class="hljs-keyword">this</span>.len_) {
      <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Out of Bounds"</span>);
    }

    <span class="hljs-keyword">return</span> ((x &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.len_[x - <span class="hljs-number">1</span>][y] &gt; <span class="hljs-number">0</span>) ||
      (y &gt; <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.len_[x][y - <span class="hljs-number">1</span>] &gt; <span class="hljs-number">0</span>) ||
      (x &lt; <span class="hljs-keyword">this</span>.data_ - <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">this</span>.data_[x + <span class="hljs-number">1</span>][y] &gt; <span class="hljs-number">0</span>) ||
      (y &lt; <span class="hljs-keyword">this</span>.data_ - <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">this</span>.data_[x][y + <span class="hljs-number">1</span>] &gt; <span class="hljs-number">0</span>));
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>@param {number} x
@param {number} y
@param {number} minValue
@param {boolean} walkLeft
@param {Function} cb
@param {*?} arg</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nextValidPosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, minValue, walkLeft, cb, arg)</span> </span>{
    x = x - <span class="hljs-keyword">this</span>.centerX_;
    y = y - <span class="hljs-keyword">this</span>.centerY_;

    <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span> || y &lt; <span class="hljs-number">0</span> || x &gt;= <span class="hljs-keyword">this</span>.len_ || y &gt;= <span class="hljs-keyword">this</span>.len_) {
      <span class="hljs-keyword">if</span> (walkLeft) {</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>start bottom right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        x = <span class="hljs-keyword">this</span>.len_ - <span class="hljs-number">1</span>;
        y = <span class="hljs-keyword">this</span>.len_ - <span class="hljs-number">1</span>;

      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>start top left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        x = <span class="hljs-number">0</span>;
        y = <span class="hljs-number">0</span>;

      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>walk to the next position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> mod = (walkLeft) ? -<span class="hljs-number">1</span> : +<span class="hljs-number">1</span>;
    y += mod;
    <span class="hljs-keyword">for</span> (; (walkLeft) ? x &gt;= <span class="hljs-number">0</span> : x &lt; <span class="hljs-keyword">this</span>.len_; x += mod) {
      <span class="hljs-keyword">for</span> (; (walkLeft) ? y &gt;= <span class="hljs-number">0</span> : y &lt; <span class="hljs-keyword">this</span>.len_; y += mod) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data_[x][y] &gt;= minValue) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>valid position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          cb(x, y, arg);
          <span class="hljs-keyword">return</span>;

        }
      }

      y = (walkLeft) ? <span class="hljs-keyword">this</span>.len_ - <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
    }
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>@param {Function} cb
@param {*} arg
@param {number} minValue
@return {boolean}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  nextRandomPosition: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb, arg, minValue)</span> </span>{
    <span class="hljs-keyword">if</span> (minValue === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) {
      minValue = <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">var</span> n = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-keyword">this</span>.len_, <span class="hljs-number">10</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; <span class="hljs-keyword">this</span>.len_; x++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-keyword">this</span>.len_; y++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data_[x][y] &gt;= minValue) {
          n--;

          <span class="hljs-keyword">if</span> (n &lt; <span class="hljs-number">0</span>) {
            cb(x, y, arg);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
          }
        }
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Selected game action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.action = {</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Selected sub action object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  selectedEntry: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Selected sub action object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  selectedSubEntry: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Action object that represents the selected action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  object: <span class="hljs-literal">null</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Game menu.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.menu = {

  getSelectedIndex: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.selectedIndex;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>@type {cwt.CircularBuffer.<String>}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  entries_: <span class="hljs-keyword">new</span> circularBuffer.CircularBuffer(),</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>@type {cwt.CircularBuffer.<boolean>}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  enabled_: <span class="hljs-keyword">new</span> circularBuffer.CircularBuffer(),

  selectedIndex: <span class="hljs-number">0</span>,

  getContent: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(index)</span> </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">0</span>) {
      index = <span class="hljs-keyword">this</span>.selectedIndex;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.entries_.get(index);
  },

  getSize: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.enabled_.size;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>@return {boolean}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  isEnabled: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.enabled_.get(<span class="hljs-keyword">this</span>.selectedIndex) === <span class="hljs-literal">true</span>;
  },

  clean: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">this</span>.enabled_.clear();
    <span class="hljs-keyword">this</span>.entries_.clear();
    <span class="hljs-keyword">this</span>.selectedIndex = <span class="hljs-number">0</span>;
  },

  addEntry: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(content, enabled)</span> </span>{
    <span class="hljs-keyword">this</span>.entries_.push(content);
    <span class="hljs-keyword">this</span>.enabled_.push(enabled);
  },

  commandKeys_: <span class="hljs-literal">null</span>,

  checkRelation_: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(action, relationList, sMode, stMode)</span> </span>{
    <span class="hljs-keyword">var</span> checkMode;

    <span class="hljs-keyword">switch</span> (relationList[<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"T"</span> :
        checkMode = sMode;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">case</span> <span class="hljs-string">"ST"</span> :
        checkMode = stMode;
        <span class="hljs-keyword">break</span>;

      <span class="hljs-keyword">default</span> :
        checkMode = <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> si = <span class="hljs-number">2</span>, se = action.relationToProp.length; si &lt; se; si++) {
      <span class="hljs-keyword">if</span> (action.relationToProp[si] === checkMode) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Generates the action menu based on the given position data.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  generate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">var</span> st_mode;
    <span class="hljs-keyword">var</span> sst_mode;
    <span class="hljs-keyword">var</span> pr_st_mode;
    <span class="hljs-keyword">var</span> pr_sst_mode;
    <span class="hljs-keyword">var</span> sPos = exports.source;
    <span class="hljs-keyword">var</span> tPos = exports.target;
    <span class="hljs-keyword">var</span> tsPos = exports.targetselection;
    <span class="hljs-keyword">var</span> ChkU = relationship.CHECK_UNIT;
    <span class="hljs-keyword">var</span> ChkP = relationship.CHECK_PROPERTY;
    <span class="hljs-keyword">var</span> sProp = sPos.property;
    <span class="hljs-keyword">var</span> sUnit = sPos.unit;
    <span class="hljs-keyword">var</span> unitActable = (!(!sUnit || sUnit.owner !== model.turnOwner || !sUnit.canAct));
    <span class="hljs-keyword">var</span> propertyActable = (!(sUnit || !sProp || sProp.owner !== model.turnOwner || sProp.type.blocker));
    <span class="hljs-keyword">var</span> mapActable = (!unitActable &amp;&amp; !propertyActable);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>check_ all game action objects and fill menu</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> actions = actions.getActions();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = actions.length; i &lt; e; i++) {
      <span class="hljs-keyword">var</span> action = actions[i];

      <span class="hljs-keyword">switch</span> (action.type) {

        <span class="hljs-keyword">case</span> actions.CLIENT_ACTION:</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>TODO: ai check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (!mapActable || cwt.Player.activeClientPlayer !== cwt.Gameround.turnOwner) {
            <span class="hljs-keyword">continue</span>;
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> actions.PROPERTY_ACTION:
          <span class="hljs-keyword">if</span> (!propertyActable) {
            <span class="hljs-keyword">continue</span>;
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> actions.MAP_ACTION:
          <span class="hljs-keyword">if</span> (!mapActable) {
            <span class="hljs-keyword">continue</span>;
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> actions.UNIT_ACTION:
          <span class="hljs-keyword">if</span> (!unitActable) {
            <span class="hljs-keyword">continue</span>;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>extract relationships</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (st_mode === <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>) {
            st_mode = relationship.getRelationShipTo(sPos, tPos, ChkU, ChkU);
            sst_mode = relationship.getRelationShipTo(sPos, tsPos, ChkU, ChkU);
            pr_st_mode = relationship.getRelationShipTo(sPos, tPos, ChkU, ChkP);
            pr_sst_mode = relationship.getRelationShipTo(sPos, tsPos, ChkU, ChkP);
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>relation to unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (action.relation) {
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.checkRelation_(action, action.relation, st_mode, sst_mode)) {
              <span class="hljs-keyword">continue</span>;
            }
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>relation to property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (action.relationToProp) {
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.checkRelation_(action, action.relationToProp, pr_st_mode, pr_sst_mode)) {
              <span class="hljs-keyword">continue</span>;
            }
          }
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> actions.ENGINE_ACTION:
          <span class="hljs-keyword">continue</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>if condition matches then add the entry to the menu list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (checkConditionByData(action)) {
        exports.menu.addEntry(<span class="hljs-keyword">this</span>.commandKeys[i], <span class="hljs-literal">true</span>)
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>exports.movePath = <span class="hljs-keyword">new</span> circularBuffer.CircularBuffer(constants.MAX_MOVE_LENGTH);</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>@type {boolean}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.preventMovePathGeneration = <span class="hljs-literal">false</span>;

exports.inMultiStep = <span class="hljs-literal">false</span>;

exports.nextStep = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  exports.movePath.clean();
  exports.menu.clean();
  exports.action.object.prepareMenu(<span class="hljs-keyword">this</span>.data);

  <span class="hljs-keyword">if</span> (!exports.menu.getSize()) {
    stateMachine.changeState(<span class="hljs-string">"INGAME_IDLE"</span>);
  }

  exports.menu.addEntry(<span class="hljs-string">"done"</span>, <span class="hljs-literal">true</span>);
  exports.inMultiStep = <span class="hljs-literal">true</span>;

  stateMachine.changeState(<span class="hljs-string">"INGAME_SUBMENU"</span>);
};

exports.nextStepBreak = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
  stateMachine.changeState(<span class="hljs-string">"INGAME_IDLE"</span>);
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
