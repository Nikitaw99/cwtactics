<!DOCTYPE html>

<html>
<head>
  <title>image.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="audio.html">
                audio.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="image.html">
                image.js
              </a>
            
              
              <a class="source" href="keyMapping.html">
                keyMapping.js
              </a>
            
              
              <a class="source" href="maps.html">
                maps.js
              </a>
            
              
              <a class="source" href="mod.html">
                mod.js
              </a>
            
              
              <a class="source" href="roundSetup.html">
                roundSetup.js
              </a>
            
              
              <a class="source" href="savegame.html">
                savegame.js
              </a>
            
              
              <a class="source" href="states.html">
                states.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>image.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> constants = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../constants"</span>);
<span class="hljs-keyword">var</span> variants = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../tileVariants"</span>);
<span class="hljs-keyword">var</span> storage = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../storage"</span>);
<span class="hljs-keyword">var</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../functions"</span>).assert;
<span class="hljs-keyword">var</span> image = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../image"</span>);
<span class="hljs-keyword">var</span> async = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../async"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> IMAGE_KEY = <span class="hljs-string">"GFX_"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>@param type
@param sprite
@param callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.transferToStorage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, sprite, callback)</span> </span>{
  <span class="hljs-keyword">if</span> (constants.DEBUG) assert(sprite <span class="hljs-keyword">instanceof</span> image.Sprite);

  <span class="hljs-keyword">var</span> data = image.Sprite.toJSON(sprite);
  storage.set(type, data, callback);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>@param callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.transferAllToStorage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> </span>{
  <span class="hljs-keyword">if</span> (constants.DEBUG) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"persist all images in the cache"</span>);

  <span class="hljs-keyword">var</span> stuff = [];

  <span class="hljs-built_in">Object</span>.keys(image.sprites).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
      storage.set(IMAGE_KEY + key, image.Sprite.toJSON(image.sprites[key]), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        next();
      });
    });
  });

  async.sequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">if</span> (constants.DEBUG) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"completed image persist process"</span>);
    callback();
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>@param type
@param path
@param callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.transferFromCache = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, path, imgType, callback)</span> </span>{
  storage.get(type, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> </span>{
    <span class="hljs-keyword">if</span> (obj.value) {</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>is in the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      image.sprites[type] = <span class="hljs-keyword">this</span>.jSONtoColoredSprite_(obj.value);
      callback();

    } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>not in the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">new</span> Image();
      img.src = path;

      img.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> sprite;

        <span class="hljs-keyword">switch</span> (imgType) {
          <span class="hljs-keyword">case</span> image.TYPE_UNIT:
            sprite = cwt.Image.createUnitSprites();
            <span class="hljs-keyword">break</span>;

          <span class="hljs-keyword">case</span> image.TYPE_PROPERTY:
            sprite = cwt.Image.createPropertySprites();
            <span class="hljs-keyword">break</span>;

          <span class="hljs-keyword">case</span> image.TYPE_TILE:
            sprite = cwt.Image.createTileSprites();
            <span class="hljs-keyword">break</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>save image in the cache</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        exports.transferToStorage(type, sprite, callback);
      };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>failed to load the image data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      img.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">require</span>(<span class="hljs-string">"../error"</span>).raiseError(<span class="hljs-string">"could not load image for "</span> + type + <span class="hljs-string">" at location "</span> + path, <span class="hljs-string">""</span>);
      };
    }
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>@param {Function} callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.transferAllFromRemote = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getImageDataArray</span><span class="hljs-params">(image)</span> </span>{
    <span class="hljs-keyword">var</span> canvas = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">var</span> canvasContext = canvas.getContext(<span class="hljs-string">"2d"</span>);

    <span class="hljs-keyword">var</span> imgW = image.width;
    <span class="hljs-keyword">var</span> imgH = image.height;
    canvas.width = imgW;
    canvas.height = imgH;
    canvasContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> canvasContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH).data;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Changes colors in an assets object by given replacement color maps and returns a new assets
object (html5 canvas).</p>
<p>@inner
@param image
@param colorData
@param numColors
@param oriIndex
@param replaceIndex
@return {HTMLCanvasElement}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replaceColors</span><span class="hljs-params">(image, colorData, numColors, oriIndex, replaceIndex)</span> </span>{
    <span class="hljs-keyword">var</span> canvas = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">var</span> canvasContext = canvas.getContext(<span class="hljs-string">"2d"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> imgW = image.width;
    <span class="hljs-keyword">var</span> imgH = image.height;
    canvas.width = imgW;
    canvas.height = imgH;
    canvasContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">var</span> imgPixels = canvasContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH);

    <span class="hljs-keyword">var</span> oriStart = (oriIndex * <span class="hljs-number">4</span>) * numColors;
    <span class="hljs-keyword">var</span> replStart = (replaceIndex * <span class="hljs-number">4</span>) * numColors;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; imgPixels.height; y++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; imgPixels.width; x++) {
        <span class="hljs-keyword">var</span> xi = (y * <span class="hljs-number">4</span>) * imgPixels.width + x * <span class="hljs-number">4</span>;

        <span class="hljs-keyword">var</span> oR = imgPixels.data[xi  ];
        <span class="hljs-keyword">var</span> oG = imgPixels.data[xi + <span class="hljs-number">1</span>];
        <span class="hljs-keyword">var</span> oB = imgPixels.data[xi + <span class="hljs-number">2</span>];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>, ne = (numColors * <span class="hljs-number">4</span>); n &lt; ne; n += <span class="hljs-number">4</span>) {

          <span class="hljs-keyword">var</span> sR = colorData[oriStart + n  ];
          <span class="hljs-keyword">var</span> sG = colorData[oriStart + n + <span class="hljs-number">1</span>];
          <span class="hljs-keyword">var</span> sB = colorData[oriStart + n + <span class="hljs-number">2</span>];

          <span class="hljs-keyword">if</span> (sR === oR &amp;&amp; sG === oG &amp;&amp; sB === oB) {

            <span class="hljs-keyword">var</span> r = replStart + n;
            <span class="hljs-keyword">var</span> rR = colorData[r  ];
            <span class="hljs-keyword">var</span> rG = colorData[r + <span class="hljs-number">1</span>];
            <span class="hljs-keyword">var</span> rB = colorData[r + <span class="hljs-number">2</span>];
            imgPixels.data[xi  ] = rR;
            imgPixels.data[xi + <span class="hljs-number">1</span>] = rG;
            imgPixels.data[xi + <span class="hljs-number">2</span>] = rB;
          }
        }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>write changes back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    canvasContext.putImageData(imgPixels, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> canvas;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>@inner
@param {HTMLImageElement|HTMLCanvasElement} image
@return {HTMLCanvasElement}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createBlackMask</span><span class="hljs-params">(image)</span> </span>{
    <span class="hljs-keyword">var</span> canvas = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">var</span> canvasContext = canvas.getContext(<span class="hljs-string">"2d"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> imgW = image.width;
    <span class="hljs-keyword">var</span> imgH = image.height;
    canvas.width = imgW;
    canvas.height = imgH;
    canvasContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">var</span> imgPixels = canvasContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; imgPixels.height; y++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; imgPixels.width; x++) {
        <span class="hljs-keyword">var</span> xi = (y * <span class="hljs-number">4</span>) * imgPixels.width + x * <span class="hljs-number">4</span>;
        <span class="hljs-keyword">var</span> oA = imgPixels.data[xi + <span class="hljs-number">3</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if pixel is not transparent, then fill it with black</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (oA &gt; <span class="hljs-number">0</span>) {
          imgPixels.data[xi  ] = <span class="hljs-number">0</span>;
          imgPixels.data[xi + <span class="hljs-number">1</span>] = <span class="hljs-number">0</span>;
          imgPixels.data[xi + <span class="hljs-number">2</span>] = <span class="hljs-number">0</span>;
        }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>write changes back</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    canvasContext.putImageData(imgPixels, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    <span class="hljs-keyword">return</span> canvas;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Draws a part of an image to a new canvas.</p>
<p>@inner
@param {HTMLImageElement|HTMLCanvasElement} image image object
@param {number} sx source x coordinate
@param {number} sy source y coordinate
@param {number} w width
@param {number} h height
@return {HTMLCanvasElement}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropImage</span><span class="hljs-params">(image, sx, sy, w, h)</span> </span>{
    <span class="hljs-keyword">var</span> nCanvas = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'canvas'</span>);
    <span class="hljs-keyword">var</span> nContext = nCanvas.getContext(<span class="hljs-string">'2d'</span>);

    nCanvas.width = w;
    nCanvas.height = h;

    nContext.drawImage(image, sx, sy, w, h, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, h);

    <span class="hljs-keyword">return</span> nCanvas;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Flips an image.</p>
<p>BASED ON <a href="http://jsfiddle.net/pankajparashar/KwDhX/">http://jsfiddle.net/pankajparashar/KwDhX/</a></p>
<p>@inner
@param {Image|HTMLCanvasElement} image
@param {boolean} flipH
@param {boolean} flipV
@return {HTMLCanvasElement}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flipImage</span><span class="hljs-params">(image, flipH, flipV)</span> </span>{
    <span class="hljs-keyword">var</span> scaleH = flipH ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> scaleV = flipV ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>;
    <span class="hljs-keyword">var</span> posX = flipH ? image.width * -<span class="hljs-number">1</span> : <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> posY = flipV ? image.height * -<span class="hljs-number">1</span> : <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> nCanvas = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'canvas'</span>);
    <span class="hljs-keyword">var</span> nContext = nCanvas.getContext(<span class="hljs-string">'2d'</span>);

    nCanvas.height = image.height;
    nCanvas.width = image.width;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>transform it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    nContext.save();
    nContext.scale(scaleH, scaleV);
    nContext.drawImage(image, posX, posY, image.width, image.height);
    nContext.restore();

    <span class="hljs-keyword">return</span> nCanvas;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Doubles the size of an assets by using the scale2x algorithm.</p>
<p>@inner
@param image
@return {HTMLElement}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scale2x</span><span class="hljs-params">(image)</span> </span>{
    <span class="hljs-keyword">var</span> imgW = image.width;
    <span class="hljs-keyword">var</span> imgH = image.height;
    <span class="hljs-keyword">var</span> oR, oG, oB;
    <span class="hljs-keyword">var</span> uR, uG, uB;
    <span class="hljs-keyword">var</span> dR, dG, dB;
    <span class="hljs-keyword">var</span> rR, rG, rB;
    <span class="hljs-keyword">var</span> lR, lG, lB;
    <span class="hljs-keyword">var</span> xi;
    <span class="hljs-keyword">var</span> t0R, t0G, t0B;
    <span class="hljs-keyword">var</span> t1R, t1G, t1B;
    <span class="hljs-keyword">var</span> t2R, t2G, t2B;
    <span class="hljs-keyword">var</span> t3R, t3G, t3B;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> canvasS = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">var</span> canvasSContext = canvasS.getContext(<span class="hljs-string">"2d"</span>);
    canvasS.width = imgW;
    canvasS.height = imgH;
    canvasSContext.drawImage(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">var</span> imgPixelsS = canvasSContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW, imgH);</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>create target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> canvasT = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">var</span> canvasTContext = canvasT.getContext(<span class="hljs-string">"2d"</span>);
    canvasT.width = imgW * <span class="hljs-number">2</span>;
    canvasT.height = imgH * <span class="hljs-number">2</span>;
    <span class="hljs-keyword">var</span> imgPixelsT = canvasTContext.getImageData(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, imgW * <span class="hljs-number">2</span>, imgH * <span class="hljs-number">2</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>scale it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; imgPixelsS.height; y++) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; imgPixelsS.width; x++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
grab source pixels</p>

            </div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>grab center</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        xi = (y * <span class="hljs-number">4</span>) * imgPixelsS.width + x * <span class="hljs-number">4</span>;
        oR = imgPixelsS.data[xi ];
        oG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
        oB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>grab left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span>) {
          xi = (y * <span class="hljs-number">4</span>) * imgPixelsS.width + (x - <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>;
          lR = imgPixelsS.data[xi ];
          lG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
          lB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
        }
        <span class="hljs-keyword">else</span> {
          lR = oR;
          lG = oG;
          lB = oB;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>grab up</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (y &gt; <span class="hljs-number">0</span>) {
          xi = ((y - <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>) * imgPixelsS.width + (x) * <span class="hljs-number">4</span>;
          uR = imgPixelsS.data[xi ];
          uG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
          uB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
        }
        <span class="hljs-keyword">else</span> {
          uR = oR;
          uG = oG;
          uB = oB;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>grab down</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (x &lt; imgPixelsS.height - <span class="hljs-number">1</span>) {
          xi = ((y + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>) * imgPixelsS.width + (x) * <span class="hljs-number">4</span>;
          dR = imgPixelsS.data[xi ];
          dG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
          dB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
        }
        <span class="hljs-keyword">else</span> {
          dR = oR;
          dG = oG;
          dB = oB;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>grab right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (x &lt; imgPixelsS.width - <span class="hljs-number">1</span>) {
          xi = (y * <span class="hljs-number">4</span>) * imgPixelsS.width + (x + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>;
          rR = imgPixelsS.data[xi ];
          rG = imgPixelsS.data[xi + <span class="hljs-number">1</span>];
          rB = imgPixelsS.data[xi + <span class="hljs-number">2</span>];
        }
        <span class="hljs-keyword">else</span> {
          rR = oR;
          rG = oG;
          rB = oB;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
calculates target pixels</p>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>E0 = E; E1 = E; E2 = E; E3 = E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        t0R = oR;
        t0G = oG;
        t0B = oB;
        t1R = oR;
        t1G = oG;
        t1B = oB;
        t2R = oR;
        t2G = oG;
        t2B = oB;
        t3R = oR;
        t3G = oG;
        t3B = oB;</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>if (B != H &amp;&amp; D != F)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (( uR !== dR || uG !== dG || uB !== dB ) &amp;&amp; ( lR !== rR || lG !== rG || lB !== rB )) {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>E0 = D == B ? D : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (uR === lR &amp;&amp; uG === lG &amp;&amp; uB === lB) {
            t0R = lR;
            t0G = lG;
            t0B = lB;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>E1 = B == F ? F : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (uR === rR &amp;&amp; uG === rG &amp;&amp; uB === rB) {
            t1R = rR;
            t1G = rG;
            t1B = rB;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>E2 = D == H ? D : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (lR === dR &amp;&amp; lG === dG &amp;&amp; lB === dB) {
            t2R = lR;
            t2G = lG;
            t2B = lB;
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>E3 = H == F ? F : E;</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span> (dR === rR &amp;&amp; dG === rG &amp;&amp; dB === rB) {
            t3R = rR;
            t3G = rG;
            t3B = rB;
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
write pixels to target canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
        xi = ((y * <span class="hljs-number">2</span>) * <span class="hljs-number">4</span>) * imgPixelsT.width + (x * <span class="hljs-number">2</span>) * <span class="hljs-number">4</span>;
        imgPixelsT.data[xi + <span class="hljs-number">0</span>] = t0R;
        imgPixelsT.data[xi + <span class="hljs-number">1</span>] = t0G;
        imgPixelsT.data[xi + <span class="hljs-number">2</span>] = t0B;
        imgPixelsT.data[xi + <span class="hljs-number">4</span>] = t1R;
        imgPixelsT.data[xi + <span class="hljs-number">5</span>] = t1G;
        imgPixelsT.data[xi + <span class="hljs-number">6</span>] = t1B;

        xi = ((y * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>) * imgPixelsT.width + (x * <span class="hljs-number">2</span>) * <span class="hljs-number">4</span>;
        imgPixelsT.data[xi + <span class="hljs-number">0</span>] = t2R;
        imgPixelsT.data[xi + <span class="hljs-number">1</span>] = t2G;
        imgPixelsT.data[xi + <span class="hljs-number">2</span>] = t2B;
        imgPixelsT.data[xi + <span class="hljs-number">4</span>] = t3R;
        imgPixelsT.data[xi + <span class="hljs-number">5</span>] = t3G;
        imgPixelsT.data[xi + <span class="hljs-number">6</span>] = t3B;
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>write changes back to the canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    canvasTContext.putImageData(imgPixelsT, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    canvasS = <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">return</span> canvasT;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>@inner
@param sprite
@param state
@param rImg
@param bImg
@param gImg
@param yImg
@param startX</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropUnitState</span><span class="hljs-params">(sprite, state, rImg, bImg, gImg, yImg, startX)</span> </span>{
    sprite.setImage(image.Sprite.UNIT_RED + state, cropImage(rImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
    sprite.setImage(image.Sprite.UNIT_BLUE + state, cropImage(bImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
    sprite.setImage(image.Sprite.UNIT_GREEN + state, cropImage(gImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
    sprite.setImage(image.Sprite.UNIT_YELLOW + state, cropImage(yImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
    sprite.setImage(image.Sprite.UNIT_SHADOW_MASK + state,
      createBlackMask(sprite.getImage(image.Sprite.UNIT_RED + state)));
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>@inner
@param sprite
@param state
@param rImg
@param bImg
@param gImg
@param yImg
@param startX</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropUnitStateInverted</span><span class="hljs-params">(sprite, state, rImg, bImg, gImg, yImg, startX)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>TODO: bug flips whole image, but it would be correct to flip every state</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    sprite.setImage(image.Sprite.UNIT_RED + state, flipImage(cropImage(rImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
    sprite.setImage(image.Sprite.UNIT_BLUE + state, flipImage(cropImage(bImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
    sprite.setImage(image.Sprite.UNIT_GREEN + state, flipImage(cropImage(gImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
    sprite.setImage(image.Sprite.UNIT_YELLOW + state, flipImage(cropImage(yImg, startX, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>), <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>));
    sprite.setImage(image.Sprite.UNIT_SHADOW_MASK + state,
      createBlackMask(sprite.getImage(image.Sprite.UNIT_RED + state)));
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cropAndRotate</span><span class="hljs-params">(image, sx, sy, w, rotation)</span> </span>{
    <span class="hljs-keyword">var</span> canvas = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'canvas'</span>);
    <span class="hljs-keyword">var</span> context = canvas.getContext(<span class="hljs-string">'2d'</span>);
    <span class="hljs-keyword">var</span> hw = w / <span class="hljs-number">2</span>;

    <span class="hljs-keyword">if</span> (constants.DEBUG) assert(hw % <span class="hljs-number">1</span> === <span class="hljs-number">0</span>);

    canvas.height = w;
    canvas.width = w;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>transform</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    context.save();
    context.translate(hw, hw);
    context.rotate(rotation * <span class="hljs-built_in">Math</span>.PI / <span class="hljs-number">180</span>);
    context.translate(-hw, -hw);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>draw</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    context.drawImage(image, sx, sy, w, w, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, w, w);

    context.restore();

    <span class="hljs-keyword">return</span> canvas;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">grabImage</span><span class="hljs-params">(path, key, callback)</span> </span>{
    <span class="hljs-keyword">if</span> (constants.DEBUG) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"going to load image "</span> + path + <span class="hljs-string">" for key "</span> + key);

    <span class="hljs-keyword">var</span> image = <span class="hljs-keyword">new</span> Image();

    <span class="hljs-keyword">if</span> (constants.DEBUG) {
      image.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"successfully loaded image "</span> + path + <span class="hljs-string">" for key "</span> + key);
        callback.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      };
    } <span class="hljs-keyword">else</span> {
      image.onload = callback;
    }


    image.src = constants.MOD_PATH + path;
    image.key = key;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> unitColorData;
  <span class="hljs-keyword">var</span> propertyColorData;
  <span class="hljs-keyword">var</span> unitColStat = image.UNIT_INDEXES;
  <span class="hljs-keyword">var</span> propColStat = image.PROPERTY_INDEXES;

  <span class="hljs-keyword">var</span> graphics = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../dataTransfer/mod"</span>).getMod().graphics;

  <span class="hljs-keyword">var</span> stuff = [];

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addToPushLoop</span><span class="hljs-params">(path, key, callback)</span> </span>{
    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
      grabImage(path, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        callback(<span class="hljs-keyword">this</span>, next);
      });
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>grab color map images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stuff.push(
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
      grabImage(graphics.COLOR_MAP[<span class="hljs-number">0</span>], <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        propertyColorData = getImageDataArray(<span class="hljs-keyword">this</span>);
        next();
      });
    },
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
      grabImage(graphics.COLOR_MAP[<span class="hljs-number">1</span>], <span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        unitColorData = getImageDataArray(<span class="hljs-keyword">this</span>);
        next();
      });
    }
  );</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>grab unit images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Object</span>.keys(graphics.UNITS).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
      <span class="hljs-keyword">var</span> path = graphics.UNITS[key];
      grabImage(path, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> image.Sprite(image.Sprite.UNIT_STATES);

        <span class="hljs-keyword">var</span> red = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">var</span> blue;
        <span class="hljs-keyword">var</span> green;
        <span class="hljs-keyword">var</span> yellow;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>create colored sprite maps</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        blue = replaceColors(red, unitColorData, unitColStat.colors, unitColStat.RED, unitColStat.BLUE);
        green = replaceColors(red, unitColorData, unitColStat.colors, unitColStat.RED, unitColStat.GREEN);
        yellow = replaceColors(red, unitColorData, unitColStat.colors, unitColStat.RED, unitColStat.YELLOW);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>crop out target states as single images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        cropUnitState(sprite, image.Sprite.UNIT_STATE_IDLE, red, blue, green, yellow, <span class="hljs-number">0</span>);
        cropUnitState(sprite, image.Sprite.UNIT_STATE_UP, red, blue, green, yellow, <span class="hljs-number">96</span>);
        cropUnitState(sprite, image.Sprite.UNIT_STATE_DOWN, red, blue, green, yellow, <span class="hljs-number">192</span>);
        cropUnitState(sprite, image.Sprite.UNIT_STATE_LEFT, red, blue, green, yellow, <span class="hljs-number">288</span>);
        cropUnitStateInverted(sprite, image.Sprite.UNIT_STATE_IDLE_INVERTED, red, blue, green, yellow, <span class="hljs-number">0</span>);
        cropUnitStateInverted(sprite, image.Sprite.UNIT_STATE_RIGHT, red, blue, green, yellow, <span class="hljs-number">288</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
        next();
      });
    });
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>grab tile images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Object</span>.keys(graphics.TILES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">var</span> value = graphics.TILES[key];
    <span class="hljs-keyword">var</span> sprite;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>special graphic data for tiles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">2</span>] === <span class="hljs-literal">true</span>) {
      image.longAnimatedTiles[key] = <span class="hljs-literal">true</span>;
    }
    <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">1</span>] === <span class="hljs-literal">true</span>) {
      image.overlayTiles[key] = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-keyword">if</span> (value.length === <span class="hljs-number">3</span>) { <span class="hljs-comment">// single variant tile</span>
      sprite = <span class="hljs-keyword">new</span> image.Sprite(image.Sprite.TILE_STATES);
      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
        grabImage(value[<span class="hljs-number">0</span>], key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          sprite.setImage(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>);
          sprite.setImage(<span class="hljs-number">1</span>, createBlackMask(<span class="hljs-keyword">this</span>));
          next();
        });
      });

    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// multi variant tile</span>
      sprite = <span class="hljs-keyword">new</span> image.Sprite(value[<span class="hljs-number">2</span>].length * image.Sprite.TILE_STATES);

      variants.registerVariantInfo(key, value[<span class="hljs-number">0</span>], value[<span class="hljs-number">1</span>]);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = value[<span class="hljs-number">2</span>].length; i &lt; e; i++) {
        addToPushLoop(value[<span class="hljs-number">2</span>][i], i * <span class="hljs-number">2</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(img, next)</span> </span>{
          sprite.setImage(img.key, img);
          sprite.setImage(img.key + <span class="hljs-number">1</span>, createBlackMask(img));
          next();
        });
      }
    }

    image.sprites[key] = sprite;
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>grab property images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Object</span>.keys(graphics.PROPERTIES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
      <span class="hljs-keyword">var</span> path = graphics.PROPERTIES[key];
      grabImage(path, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> image.Sprite(image.Sprite.PROPERTY_STATES);

        <span class="hljs-keyword">var</span> red = <span class="hljs-keyword">this</span>;
        <span class="hljs-keyword">var</span> blue;
        <span class="hljs-keyword">var</span> green;
        <span class="hljs-keyword">var</span> yellow;
        <span class="hljs-keyword">var</span> neutral;
        <span class="hljs-keyword">var</span> shadow;

        blue = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.BLUE);
        green = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.GREEN);
        yellow = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.YELLOW);
        neutral = replaceColors(red, propertyColorData, propColStat.colors, propColStat.RED, propColStat.GRAY);
        shadow = createBlackMask(red);

        sprite.setImage(image.Sprite.PROPERTY_RED, red);
        sprite.setImage(image.Sprite.PROPERTY_BLUE, blue);
        sprite.setImage(image.Sprite.PROPERTY_GREEN, green);
        sprite.setImage(image.Sprite.PROPERTY_YELLOW, yellow);
        sprite.setImage(image.Sprite.PROPERTY_NEUTRAL, neutral);
        sprite.setImage(image.Sprite.PROPERTY_SHADOW_MASK, shadow);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
        next();
      });
    });
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>grab arrow images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
    <span class="hljs-keyword">var</span> path = graphics.ARROW;
    grabImage(path, <span class="hljs-string">"ARROW"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> image.Sprite(<span class="hljs-number">10</span>);

      <span class="hljs-keyword">var</span> arrowMap = <span class="hljs-keyword">this</span>;

      sprite.setImage(image.Sprite.DIRECTION_N, cropImage(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>));
      sprite.setImage(image.Sprite.DIRECTION_S, cropAndRotate(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">180</span>));
      sprite.setImage(image.Sprite.DIRECTION_W, cropAndRotate(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">270</span>));
      sprite.setImage(image.Sprite.DIRECTION_E, cropAndRotate(arrowMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">90</span>));
      sprite.setImage(image.Sprite.DIRECTION_SW, cropAndRotate(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">90</span>));
      sprite.setImage(image.Sprite.DIRECTION_SE, cropImage(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>));
      sprite.setImage(image.Sprite.DIRECTION_NW, cropAndRotate(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">180</span>));
      sprite.setImage(image.Sprite.DIRECTION_NE, cropAndRotate(arrowMap, <span class="hljs-number">32</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">270</span>));
      sprite.setImage(image.Sprite.DIRECTION_NS, cropImage(arrowMap, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">16</span>));
      sprite.setImage(image.Sprite.DIRECTION_WE, cropAndRotate(arrowMap, <span class="hljs-number">16</span>, <span class="hljs-number">0</span>, <span class="hljs-number">16</span>, <span class="hljs-number">90</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
      next();
    });
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>grab dust images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
    <span class="hljs-keyword">var</span> path = graphics.DUST;
    grabImage(path, <span class="hljs-string">"DUST"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> image.Sprite(<span class="hljs-number">4</span>);

      <span class="hljs-keyword">var</span> imgMap = <span class="hljs-keyword">this</span>;

      sprite.setImage(image.Sprite.DIRECTION_LEFT, cropImage(imgMap, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
      sprite.setImage(image.Sprite.DIRECTION_UP, cropImage(imgMap, <span class="hljs-number">96</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
      sprite.setImage(image.Sprite.DIRECTION_DOWN, cropImage(imgMap, <span class="hljs-number">192</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));
      sprite.setImage(image.Sprite.DIRECTION_RIGHT, cropImage(imgMap, <span class="hljs-number">288</span>, <span class="hljs-number">0</span>, <span class="hljs-number">96</span>, <span class="hljs-number">32</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
      next();
    });
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>grab rocket fly images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
    <span class="hljs-keyword">var</span> path = graphics.ROCKET_FLY;
    grabImage(path, <span class="hljs-string">"ROCKET_FLY"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">var</span> sprite = <span class="hljs-keyword">new</span> image.Sprite(<span class="hljs-number">2</span>);

      sprite.setImage(image.Sprite.DIRECTION_UP, <span class="hljs-keyword">this</span>);
      sprite.setImage(image.Sprite.DIRECTION_DOWN, cropAndRotate(<span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">24</span>, <span class="hljs-number">180</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>register sprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
      next();
    });
  });</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>grab other images</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-built_in">Object</span>.keys(graphics.OTHERS).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">var</span> value = graphics.OTHERS[key];
    <span class="hljs-keyword">var</span> sprite;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>) {
      sprite = <span class="hljs-keyword">new</span> image.Sprite(<span class="hljs-number">1</span>);

      stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{      <span class="hljs-comment">// single image sprite</span>
        grabImage(value, key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
          sprite.setImage(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>);
          image.sprites[<span class="hljs-keyword">this</span>.key] = sprite;
          next();
        });
      });
    } <span class="hljs-keyword">else</span> {                            <span class="hljs-comment">// multi image sprite</span>
      sprite = <span class="hljs-keyword">new</span> image.Sprite(value.length);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = value.length; i &lt; e; i++) {
        addToPushLoop(value[i], i, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(img, next)</span> </span>{
          sprite.setImage(img.key, img);
          next();
        });
      }
    }

    image.sprites[key] = sprite;
  });

  async.sequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
    callback();
  });
};</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>@param {Function} callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.transferAllFromStorage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> </span>{
  <span class="hljs-keyword">var</span> graphics = <span class="hljs-built_in">require</span>(<span class="hljs-string">"../dataTransfer/mod"</span>).getMod().graphics;

  <span class="hljs-keyword">var</span> stuff = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>@inner
@param key</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadKey</span><span class="hljs-params">(key)</span> </span>{
    <span class="hljs-keyword">var</span> realKey = key.slice(IMAGE_KEY.length);
    stuff.push(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(next)</span> </span>{
      <span class="hljs-keyword">if</span> (constants.DEBUG) <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"grab sprite "</span> + key + <span class="hljs-string">" from cache"</span>);

      storage.get(key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> </span>{
        <span class="hljs-keyword">if</span> (constants.DEBUG) assert(value);

        image.sprites[realKey] = image.Sprite.fromJSON(value);
        next();
      });
    })
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>load all possible audio (except music) keys from the storage into the RAM</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  storage.keys(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(keys)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, e = keys.length; i &lt; e; i++) {
      <span class="hljs-keyword">var</span> key = keys[i];
      <span class="hljs-keyword">if</span> (key.indexOf(IMAGE_KEY) === <span class="hljs-number">0</span>) {
        loadKey(key);
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>grab tile variant information</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-built_in">Object</span>.keys(graphics.TILES).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> </span>{
      <span class="hljs-keyword">var</span> value = graphics.TILES[key];</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>special graphic data for tiles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">2</span>] === <span class="hljs-literal">true</span>) {
        image.longAnimatedTiles[key] = <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">if</span> (value[value.length - <span class="hljs-number">1</span>] === <span class="hljs-literal">true</span>) {
        image.overlayTiles[key] = <span class="hljs-literal">true</span>;
      }

      <span class="hljs-keyword">if</span> (value.length !== <span class="hljs-number">3</span>) { <span class="hljs-comment">// multi variant tile</span>
        variants.registerVariantInfo(key, value[<span class="hljs-number">0</span>], value[<span class="hljs-number">1</span>]);
      }
    });

    async.sequence(stuff, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
      callback();
    });
  });
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
