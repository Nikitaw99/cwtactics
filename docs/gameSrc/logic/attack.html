<!DOCTYPE html>

<html>
<head>
  <title>attack.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="attack.html">
                attack.js
              </a>
            
              
              <a class="source" href="cannon.html">
                cannon.js
              </a>
            
              
              <a class="source" href="capture.html">
                capture.js
              </a>
            
              
              <a class="source" href="co.html">
                co.js
              </a>
            
              
              <a class="source" href="exploder.html">
                exploder.js
              </a>
            
              
              <a class="source" href="factory.html">
                factory.js
              </a>
            
              
              <a class="source" href="fog.html">
                fog.js
              </a>
            
              
              <a class="source" href="join.html">
                join.js
              </a>
            
              
              <a class="source" href="laser.html">
                laser.js
              </a>
            
              
              <a class="source" href="lifecycle.html">
                lifecycle.js
              </a>
            
              
              <a class="source" href="move.html">
                move.js
              </a>
            
              
              <a class="source" href="relationship.html">
                relationship.js
              </a>
            
              
              <a class="source" href="silo.html">
                silo.js
              </a>
            
              
              <a class="source" href="supply.html">
                supply.js
              </a>
            
              
              <a class="source" href="team.html">
                team.js
              </a>
            
              
              <a class="source" href="transport.html">
                transport.js
              </a>
            
              
              <a class="source" href="turn.html">
                turn.js
              </a>
            
              
              <a class="source" href="weather.html">
                weather.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>attack.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Signal for units that cannot attack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.FIRETYPE_NONE = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Indirect fire type that can fire from range 2 to x.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.FIRETYPE_INDIRECT = <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Direct fire type that can fire from range 1 to 1.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.FIRETYPE_DIRECT = <span class="hljs-number">2</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Ballistic fire type that can fire from range 1 to x.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.FIRETYPE_BALLISTIC = <span class="hljs-number">3</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Returns true if the <strong>unit</strong> has a main weapon, else false.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.hasMainWeapon = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> </span>{
  <span class="hljs-keyword">var</span> attack = unit.type.attack;
  <span class="hljs-keyword">return</span> (attack &amp;&amp; attack.main_wp);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Returns true if the <strong>unit</strong> has a secondary weapon, else false.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.hasSecondaryWeapon = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> </span>{
  <span class="hljs-keyword">var</span> attack = unit.type.attack;
  <span class="hljs-keyword">return</span> (attack &amp;&amp; attack.sec_wp);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Returns <strong>true</strong> if a given <strong>unit</strong> is an indirect unit ( <em>e.g. artillery</em> ) else <strong>false</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.isIndirect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getFireType(unit) === <span class="hljs-keyword">this</span>.FIRETYPE_INDIRECT;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Returns <strong>true</strong> if a given <strong>unit</strong> is an ballistic unit ( <em>e.g. anti-tank-gun</em> ) else <strong>false</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.isBallistic = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getFireType(unit) === <span class="hljs-keyword">this</span>.FIRETYPE_BALLISTIC;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Returns the fire type of a given <strong>unit</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.getFireType = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit)</span> </span>{
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasMainWeapon(unit) &amp;&amp; !<span class="hljs-keyword">this</span>.hasSecondaryWeapon(unit)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.FIRETYPE_NONE;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The fire type will be determined by the following situations. All other situations (which aren’t in the
following table) aren’t allowed due the game rules.</p>
<p>Min-Range === 1 —&gt; Ballistic
Min-Range   &gt; 1 —&gt; Indirect
No Min-Range    —&gt; Direct
Only Secondary  —&gt; Direct</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  <span class="hljs-keyword">var</span> fireType = cwt.INACTIVE;
  <span class="hljs-keyword">var</span> min = unit.type.attack.minrange;
  <span class="hljs-keyword">if</span> (!min) {
    fireType = <span class="hljs-keyword">this</span>.FIRETYPE_DIRECT;
  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>non-direct units aren’t allowed to obtain secondary weapons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(!<span class="hljs-keyword">this</span>.hasMainWeapon(unit), <span class="hljs-string">"found non-direct unit with secondary weapon"</span>);

    <span class="hljs-keyword">if</span> (min &gt; <span class="hljs-number">1</span>) {
      fireType = <span class="hljs-keyword">this</span>.FIRETYPE_INDIRECT;
    } <span class="hljs-keyword">else</span> {
      fireType = <span class="hljs-keyword">this</span>.FIRETYPE_BALLISTIC;
    }
  }

  <span class="hljs-keyword">if</span> (cwt.DEBUG) cwt.assert(fireType != cwt.INACTIVE);
  <span class="hljs-keyword">return</span> fireType;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Returns <strong>true</strong> if an <strong>attacker</strong> can use it’s main weapon against a <strong>defender</strong>. The distance will not
checked in case of an indirect attacker.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.canUseMainWeapon = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender)</span> </span>{
  <span class="hljs-keyword">var</span> attack = attacker.type.attack;
  <span class="hljs-keyword">if</span> (attack.main_wp &amp;&amp; <span class="hljs-keyword">this</span>.ammo &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">var</span> v = attack.main_wp[defender.type.ID];

    <span class="hljs-keyword">if</span> (v &amp;&amp; v &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Returns <strong>true</strong> if an <strong>unit</strong> has targets in sight from a given position (<strong>x</strong>,<strong>y</strong>), else <strong>false</strong>. If
<strong>moved</strong> is true, then the given <strong>unit</strong> will move before attack. In case of indirect units this method will
return <strong>false</strong> then because indirect units aren’t allowed to move and attack in the same turn.
The method will return <strong>true</strong> when at least one target is in range, else <strong>false</strong>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.hasTargets = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit, x, y, moved)</span> </span>{
  <span class="hljs-keyword">if</span> (moved &amp;&amp; <span class="hljs-keyword">this</span>.isIndirect(unit)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.calculateTargets(unit, x, y);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Calculates the targets of a <strong>unit</strong>. If selection <strong>data</strong> is given, then the attack targets will be marked. If
<strong>markTiles</strong> is true, then <strong>data</strong> has to be given too. Furthermore when <strong>markTiles</strong> is true, then every tile
in range will be marked. The method will return <strong>true</strong> when at least one target is in range, else <strong>false</strong> or
<strong>false</strong> in every case when <strong>markTiles</strong> is true.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.calculateTargets = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(unit, x, y, data, markTiles)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) {
    cwt.assert(unit <span class="hljs-keyword">instanceof</span> cwt.UnitClass);
    cwt.assert(cwt.Model.isValidPosition(x, y));
  }

  <span class="hljs-keyword">var</span> markInData = (<span class="hljs-keyword">typeof</span> data !== <span class="hljs-string">"undefined"</span>);
  <span class="hljs-keyword">var</span> teamId = unit.owner.team;
  <span class="hljs-keyword">var</span> attackSheet = unit.type.attack;
  <span class="hljs-keyword">var</span> targetInRange = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">if</span> (markInData) {
    data.setCenter(x, y, cwt.INACTIVE);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>no battle unit ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> attackSheet === <span class="hljs-string">"undefined"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>a unit may does not have ammo but a weapon that needs ammo to fire</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasMainWeapon(unit) &amp;&amp; !<span class="hljs-keyword">this</span>.hasSecondaryWeapon(unit) &amp;&amp; unit.type.ammo &gt; <span class="hljs-number">0</span> &amp;&amp; unit.ammo === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>extract range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> minR = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">var</span> maxR = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">if</span> (unit.type.attack.minrange) {
    minR = unit.type.attack.minrange;
    maxR = unit.type.attack.maxrange;
  }

  <span class="hljs-keyword">var</span> lX;
  <span class="hljs-keyword">var</span> hX;
  <span class="hljs-keyword">var</span> lY = y - maxR;
  <span class="hljs-keyword">var</span> hY = y + maxR;

  <span class="hljs-keyword">if</span> (lY &lt; <span class="hljs-number">0</span>) lY = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (hY &gt;= cwt.Model.mapHeight) hY = cwt.Model.mapHeight - <span class="hljs-number">1</span>;

  <span class="hljs-keyword">for</span> (; lY &lt;= hY; lY++) {

    <span class="hljs-keyword">var</span> disY = <span class="hljs-built_in">Math</span>.abs(lY - y);
    lX = x - maxR + disY;
    hX = x + maxR - disY;

    <span class="hljs-keyword">if</span> (lX &lt; <span class="hljs-number">0</span>) lX = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (hX &gt;= cwt.Model.mapWidth) hX = cwt.Model.mapWidth - <span class="hljs-number">1</span>;

    <span class="hljs-keyword">for</span> (; lX &lt;= hX; lX++) {
      <span class="hljs-keyword">var</span> tile = cwt.Model.mapData[lX][lY];
      <span class="hljs-keyword">var</span> dis = cwt.Model.getDistance(x, y, lX, lY);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>if markTiles is true, then mark all tiles in range</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (markTiles &amp;&amp; dis &gt;= minR) {
        data.setValue(lX, lY, <span class="hljs-number">1</span>);
        <span class="hljs-keyword">continue</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>drop tile when hidden in fog</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (tile.visionTurnOwner === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">continue</span>;
      }

      <span class="hljs-keyword">if</span> (dis &gt;= minR) {
        <span class="hljs-keyword">var</span> dmg = cwt.INACTIVE;

        <span class="hljs-keyword">var</span> tUnit = tile.unit;
        <span class="hljs-keyword">if</span> (tUnit &amp;&amp; tUnit.owner.team !== teamId) {

          dmg = <span class="hljs-keyword">this</span>.getBaseDamageAgainst(unit, tUnit);
          <span class="hljs-keyword">if</span> (dmg &gt; <span class="hljs-number">0</span>) {
            targetInRange = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>if mark tile is true, then mark them in the selection map else return true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (markInData) {
              data.setValue(lX, lY, dmg);
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
          }
        }
      }
    }
  }

  <span class="hljs-keyword">return</span> targetInRange;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Returns the <strong>base damage value as integer</strong> of an <strong>attacker</strong> against a <strong>defender</strong>. If the attacker cannot
attack the defender then <strong>cwt.INACTIVE</strong> will be returned. This function recognizes the ammo usage of main
weapons. If the attacker cannot attack with his main weapon due low ammo then only the secondary weapon will
be checked. If <strong>withMainWp</strong> is false (default = true) then the main weapon check will be skipped.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.getBaseDamageAgainst = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender, withMainWp)</span> </span>{
  <span class="hljs-keyword">var</span> attack = attacker.type.attack;

  <span class="hljs-keyword">if</span> (!attack) {
    <span class="hljs-keyword">return</span> cwt.INACTIVE;
  }

  <span class="hljs-keyword">var</span> tType = defender.type.ID;
  <span class="hljs-keyword">var</span> v;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> withMainWp === <span class="hljs-string">"undefined"</span>) {
    withMainWp = <span class="hljs-literal">true</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>check main weapon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (withMainWp &amp;&amp; <span class="hljs-keyword">typeof</span> attack.main_wp !== <span class="hljs-string">"undefined"</span> &amp;&amp; attacker.ammo &gt; <span class="hljs-number">0</span>) {
    v = attack.main_wp[tType];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">"undefined"</span>) {
      <span class="hljs-keyword">return</span> v;
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>check secondary weapon</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> attack.sec_wp !== <span class="hljs-string">"undefined"</span>) {
    v = attack.sec_wp[tType];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">"undefined"</span>) {
      <span class="hljs-keyword">return</span> v;
    }
  }

  <span class="hljs-keyword">return</span> cwt.INACTIVE;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Returns the <strong>battle damage as integer</strong> of an <strong>attacker</strong> against an <strong>defender</strong> with a given amount of
<strong>luck</strong> as integer. If <strong>withMainWp</strong> is false (default = true) then the main weapon usage will be skipped.
If <strong>isCounter</strong> is true (default = false), then the attack will be interpreted as counter attack.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.getBattleDamageAgainst = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender, luck, withMainWp, isCounter)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> isCounter === <span class="hljs-string">"undefined"</span>) {
    isCounter = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">var</span> BASE = <span class="hljs-keyword">this</span>.getBaseDamageAgainst(attacker, defender, withMainWp);
  <span class="hljs-keyword">if</span> (BASE === cwt.INACTIVE) {
    <span class="hljs-keyword">return</span> cwt.INACTIVE;
  }

  <span class="hljs-keyword">var</span> AHP = cwt.UnitClass.healthToPoints(attacker);
  <span class="hljs-keyword">var</span> LUCK = <span class="hljs-built_in">parseInt</span>((luck / <span class="hljs-number">100</span>) * <span class="hljs-number">10</span>, <span class="hljs-number">10</span>);
  <span class="hljs-keyword">var</span> ACO = <span class="hljs-number">100</span>;
  <span class="hljs-keyword">if</span> (isCounter) ACO += <span class="hljs-number">0</span>;

  <span class="hljs-keyword">var</span> def = cwt.Model.grabTileByUnit(defender).type.defense;
  <span class="hljs-keyword">var</span> DCO = <span class="hljs-number">100</span>;
  <span class="hljs-keyword">var</span> DHP = cwt.UnitClass.healthToPoints(defender);
  <span class="hljs-keyword">var</span> DTR = <span class="hljs-built_in">parseInt</span>(def * <span class="hljs-number">100</span> / <span class="hljs-number">100</span>, <span class="hljs-number">10</span>);

  <span class="hljs-keyword">var</span> damage;
  <span class="hljs-keyword">if</span> (cwt.Model.gameMode &lt;= cwt.Model.GAME_MODE_AW2) {
    damage = BASE * (ACO / <span class="hljs-number">100</span> - (ACO / <span class="hljs-number">100</span> * (DCO - <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>)) * (AHP / <span class="hljs-number">10</span>);
  } <span class="hljs-keyword">else</span> {
    damage = BASE * (ACO / <span class="hljs-number">100</span> * DCO / <span class="hljs-number">100</span>) * (AHP / <span class="hljs-number">10</span>);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(damage, <span class="hljs-number">10</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Declines when the attacker does not have targets in range.</p>
<p>@param attId
@param defId
@param attLuckRatio
@param defLuckRatio</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>exports.attack = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(attacker, defender, attLuckRatio, defLuckRatio)</span> </span>{
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.DEBUG) {
    cwt.assert(attacker <span class="hljs-keyword">instanceof</span> cwt.UnitClass);
    cwt.assert(defender <span class="hljs-keyword">instanceof</span> cwt.UnitClass);
    cwt.assert(attLuckRatio &gt;= <span class="hljs-number">0</span> &amp;&amp; attLuckRatio &lt;= <span class="hljs-number">100</span>);
    cwt.assert(defLuckRatio &gt;= <span class="hljs-number">0</span> &amp;&amp; defLuckRatio &lt;= <span class="hljs-number">100</span>);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>TODO
<strong>check_ firstCounter:</strong> if first counter is active then the defender
attacks first. In this case swap attacker and defender.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-comment">/*
   if (!indirectAttack &amp;&amp; controller.scriptedValue(defender.owner, "firstCounter", 0) === 1) {
   if (!model.battle_isIndirectUnit(defId)) {
   var tmp_ = defender;
   defender = attacker;
   attacker = tmp_;
   }
   }
   */</span>

  <span class="hljs-keyword">var</span> indirectAttack = <span class="hljs-keyword">this</span>.isIndirect(attacker);
  <span class="hljs-keyword">var</span> aSheets = attacker.type;
  <span class="hljs-keyword">var</span> dSheets = defender.type;
  <span class="hljs-keyword">var</span> attOwner = attacker.owner;
  <span class="hljs-keyword">var</span> defOwner = defender.owner;
  <span class="hljs-keyword">var</span> powerAtt = cwt.UnitClass.healthToPoints(defender);
  <span class="hljs-keyword">var</span> powerCounterAtt = cwt.UnitClass.healthToPoints(attacker);
  <span class="hljs-keyword">var</span> mainWpAttack = <span class="hljs-keyword">this</span>.canUseMainWeapon(attacker, defender);
  <span class="hljs-keyword">var</span> damage = <span class="hljs-keyword">this</span>.getBattleDamageAgainst(attacker, defender, attLuckRatio, mainWpAttack, <span class="hljs-literal">false</span>);

  <span class="hljs-keyword">if</span> (damage !== cwt.INACTIVE) {
    defender.takeDamage(damage);
    <span class="hljs-keyword">if</span> (defender.hp &lt;= <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>TODO destroy unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }

    powerAtt -= cwt.UnitClass.healthToPoints(defender);

    <span class="hljs-keyword">if</span> (mainWpAttack) {
      attacker.ammo--;
    }

    powerAtt = ( <span class="hljs-built_in">parseInt</span>(powerAtt * <span class="hljs-number">0.1</span> * dSheets.cost, <span class="hljs-number">10</span>) );
    cwt.CO.modifyStarPower(attOwner, <span class="hljs-built_in">parseInt</span>(<span class="hljs-number">0.5</span> * powerAtt, <span class="hljs-number">10</span>));
    cwt.CO.modifyStarPower(defOwner, powerAtt);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>counter attack when defender survives and defender is an indirect attacking unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (defender.hp &gt; <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-keyword">this</span>.isIndirect(defender)) {
    mainWpAttack = <span class="hljs-keyword">this</span>.canUseMainWeapon(defender, attacker);

    damage = <span class="hljs-keyword">this</span>.getBattleDamageAgainst(defender, attacker, defLuckRatio, mainWpAttack, <span class="hljs-literal">true</span>);

    <span class="hljs-keyword">if</span> (damage !== -<span class="hljs-number">1</span>) {
      attacker.takeDamage(damage);
      <span class="hljs-keyword">if</span> (attacker.hp &lt;= <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>TODO destroy unit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      }

      powerCounterAtt -= cwt.UnitClass.healthToPoints(attacker);

      <span class="hljs-keyword">if</span> (mainWpAttack) {
        defender.ammo--;
      }

      powerCounterAtt = ( <span class="hljs-built_in">parseInt</span>(powerCounterAtt * <span class="hljs-number">0.1</span> * aSheets.cost, <span class="hljs-number">10</span>) );
      cwt.CO.modifyStarPower(defOwner, <span class="hljs-built_in">parseInt</span>(<span class="hljs-number">0.5</span> * powerCounterAtt, <span class="hljs-number">10</span>));
      cwt.CO.modifyStarPower(attOwner, powerCounterAtt);
    }
  }
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
