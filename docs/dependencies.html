<!DOCTYPE html>

<html>
<head>
  <title>dependencies.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="doc.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ai.html">
                  ai.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="commands.html">
                  commands.js
                </a>
              
                
                <a class="source" href="controller.html">
                  controller.js
                </a>
              
                
                <a class="source" href="datatypes.html">
                  datatypes.js
                </a>
              
                
                <a class="source" href="dependencies.html">
                  dependencies.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="input.html">
                  input.js
                </a>
              
                
                <a class="source" href="loading.html">
                  loading.js
                </a>
              
                
                <a class="source" href="logic.html">
                  logic.js
                </a>
              
                
                <a class="source" href="model.html">
                  model.js
                </a>
              
                
                <a class="source" href="modification.html">
                  modification.js
                </a>
              
                
                <a class="source" href="renderer.html">
                  renderer.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>dependencies.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> lastTime = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> vendors = [<span class="hljs-string">'ms'</span>, <span class="hljs-string">'moz'</span>, <span class="hljs-string">'webkit'</span>, <span class="hljs-string">'o'</span>];
  <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; vendors.length &amp;&amp; !window.requestAnimationFrame; ++x) {
    window.requestAnimationFrame = window[vendors[x]+<span class="hljs-string">'RequestAnimationFrame'</span>];
    window.cancelAnimationFrame =
      window[vendors[x]+<span class="hljs-string">'CancelAnimationFrame'</span>] || window[vendors[x]+<span class="hljs-string">'CancelRequestAnimationFrame'</span>];
  }

  <span class="hljs-keyword">if</span> (!window.requestAnimationFrame)
    window.requestAnimationFrame = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback, element)</span> {</span>
      <span class="hljs-keyword">var</span> currTime = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime();
      <span class="hljs-keyword">var</span> timeToCall = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, <span class="hljs-number">16</span> - (currTime - lastTime));
      <span class="hljs-keyword">var</span> id = window.setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> callback(currTime + timeToCall); },
        timeToCall);
      lastTime = currTime + timeToCall;
      <span class="hljs-keyword">return</span> id;
    };

  <span class="hljs-keyword">if</span> (!window.cancelAnimationFrame)
    window.cancelAnimationFrame = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(id)</span> {</span>
      clearTimeout(id);
    };
}());</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>javascript-astar
<a href="http://github.com/bgrins/javascript-astar">http://github.com/bgrins/javascript-astar</a>
Freely distributable under the MIT License.
Includes Binary Heap (with modifications) from Marijn Haverbeke.
<a href="http://eloquentjavascript.net/appendix2.dom">http://eloquentjavascript.net/appendix2.dom</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> GraphNodeType = {
  OPEN: <span class="hljs-number">1</span>,
  WALL: -<span class="hljs-number">1</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Creates a Graph class used in the astar search algorithm.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Graph</span><span class="hljs-params">(grid)</span> {</span>
  <span class="hljs-keyword">var</span> nodes = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; grid.length; x++) {
    nodes[x] = [];

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>, row = grid[x]; y &lt; row.length; y++) {
      nodes[x][y] = <span class="hljs-keyword">new</span> GraphNode(x, y, row[y]);
    }
  }

  <span class="hljs-keyword">this</span>.input = grid;
  <span class="hljs-keyword">this</span>.nodes = nodes;
}

Graph.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> graphString = <span class="hljs-string">"\n"</span>;
  <span class="hljs-keyword">var</span> nodes = <span class="hljs-keyword">this</span>.nodes;
  <span class="hljs-keyword">var</span> rowDebug, row, y, l;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>, len = nodes.length; x &lt; len; x++) {
    rowDebug = <span class="hljs-string">""</span>;
    row = nodes[x];
    <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>, l = row.length; y &lt; l; y++) {
      rowDebug += row[y].type + <span class="hljs-string">" "</span>;
    }
    graphString = graphString + rowDebug + <span class="hljs-string">"\n"</span>;
  }
  <span class="hljs-keyword">return</span> graphString;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">GraphNode</span><span class="hljs-params">(x,y,type)</span> {</span>
  <span class="hljs-keyword">this</span>.data = { };
  <span class="hljs-keyword">this</span>.x = x;
  <span class="hljs-keyword">this</span>.y = y;
  <span class="hljs-keyword">this</span>.pos = {
    x: x,
    y: y
  };
  <span class="hljs-keyword">this</span>.type = type;
}

GraphNode.prototype.toString = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"["</span> + <span class="hljs-keyword">this</span>.x + <span class="hljs-string">" "</span> + <span class="hljs-keyword">this</span>.y + <span class="hljs-string">"]"</span>;
};

GraphNode.prototype.isWall = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.type == GraphNodeType.WALL;
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">BinaryHeap</span><span class="hljs-params">(scoreFunction)</span>{</span>
  <span class="hljs-keyword">this</span>.content = [];
  <span class="hljs-keyword">this</span>.scoreFunction = scoreFunction;
}

BinaryHeap.prototype = {
  push: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(element)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Add the new element to the end of the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.content.push(element);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Allow it to sink down.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.sinkDown(<span class="hljs-keyword">this</span>.content.length - <span class="hljs-number">1</span>);
  },
  pop: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Store the first element so we can return it later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">this</span>.content[<span class="hljs-number">0</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Get the element at the end of the array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> end = <span class="hljs-keyword">this</span>.content.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>If there are any elements left, put the end element at the
start, and let it bubble up.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.content.length &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>.content[<span class="hljs-number">0</span>] = end;
      <span class="hljs-keyword">this</span>.bubbleUp(<span class="hljs-number">0</span>);
    }
    <span class="hljs-keyword">return</span> result;
  },
  remove: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(node)</span> {</span>
    <span class="hljs-keyword">var</span> i = <span class="hljs-keyword">this</span>.content.indexOf(node);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>When it is found, the process seen in ‘pop’ is repeated
to fill up the hole.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> end = <span class="hljs-keyword">this</span>.content.pop();

    <span class="hljs-keyword">if</span> (i !== <span class="hljs-keyword">this</span>.content.length - <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">this</span>.content[i] = end;

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scoreFunction(end) &lt; <span class="hljs-keyword">this</span>.scoreFunction(node)) {
        <span class="hljs-keyword">this</span>.sinkDown(i);
      }
      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.bubbleUp(i);
      }
    }
  },
  size: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.content.length;
  },
  rescoreElement: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(node)</span> {</span>
    <span class="hljs-keyword">this</span>.sinkDown(<span class="hljs-keyword">this</span>.content.indexOf(node));
  },
  sinkDown: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Fetch the element that has to be sunk.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> element = <span class="hljs-keyword">this</span>.content[n];</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>When at 0, an element can not sink any further.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">while</span> (n &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Compute the parent element’s index, and fetch it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> parentN = ((n + <span class="hljs-number">1</span>) &gt;&gt; <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>,
        parent = <span class="hljs-keyword">this</span>.content[parentN];</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Swap the elements if the parent is greater.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scoreFunction(element) &lt; <span class="hljs-keyword">this</span>.scoreFunction(parent)) {
        <span class="hljs-keyword">this</span>.content[parentN] = element;
        <span class="hljs-keyword">this</span>.content[n] = parent;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Update ‘n’ to continue at the new position.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        n = parentN;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Found a parent that is less, no need to sink any further.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">break</span>;
      }
    }
  },
  bubbleUp: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Look up the target element and its score.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> length = <span class="hljs-keyword">this</span>.content.length,
      element = <span class="hljs-keyword">this</span>.content[n],
      elemScore = <span class="hljs-keyword">this</span>.scoreFunction(element);

    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Compute the indices of the child elements.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> child2N = (n + <span class="hljs-number">1</span>) &lt;&lt; <span class="hljs-number">1</span>, child1N = child2N - <span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>This is used to store the new position of the element,
if any.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> swap = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>If the first child exists (is inside the array)…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (child1N &lt; length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Look it up and compute its score.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> child1 = <span class="hljs-keyword">this</span>.content[child1N],
          child1Score = <span class="hljs-keyword">this</span>.scoreFunction(child1);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>If the score is less than our element’s, we need to swap.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (child1Score &lt; elemScore)
          swap = child1N;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Do the same checks for the other child.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (child2N &lt; length) {
        <span class="hljs-keyword">var</span> child2 = <span class="hljs-keyword">this</span>.content[child2N],
          child2Score = <span class="hljs-keyword">this</span>.scoreFunction(child2);
        <span class="hljs-keyword">if</span> (child2Score &lt; (swap === <span class="hljs-literal">null</span> ? elemScore : child1Score)) {
          swap = child2N;
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>If the element needs to be moved, swap it, and continue.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (swap !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">this</span>.content[n] = <span class="hljs-keyword">this</span>.content[swap];
        <span class="hljs-keyword">this</span>.content[swap] = element;
        n = swap;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Otherwise, we are done.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">break</span>;
      }
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>javascript-astar
<a href="http://github.com/bgrins/javascript-astar">http://github.com/bgrins/javascript-astar</a>
Freely distributable under the MIT License.
Implements the astar search algorithm in javascript using a binary heap.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> astar = {
  init: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(grid)</span> {</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>, xl = grid.length; x &lt; xl; x++) {
      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>, yl = grid[x].length; y &lt; yl; y++) {
        <span class="hljs-keyword">var</span> node = grid[x][y];
        node.f = <span class="hljs-number">0</span>;
        node.g = <span class="hljs-number">0</span>;
        node.h = <span class="hljs-number">0</span>;
        node.cost = node.type;
        node.visited = <span class="hljs-literal">false</span>;
        node.closed = <span class="hljs-literal">false</span>;
        node.parent = <span class="hljs-literal">null</span>;
      }
    }
  },
  heap: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BinaryHeap(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(node)</span> {</span>
      <span class="hljs-keyword">return</span> node.f;
    });
  },
  search: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(grid, start, end, diagonal, heuristic)</span> {</span>
    astar.init(grid);
    heuristic = heuristic || astar.manhattan;
    diagonal = !!diagonal;

    <span class="hljs-keyword">var</span> openHeap = astar.heap();

    openHeap.push(start);

    <span class="hljs-keyword">while</span>(openHeap.size() &gt; <span class="hljs-number">0</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Grab the lowest f(x) to process next.  Heap keeps this sorted for us.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> currentNode = openHeap.pop();</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>End case — result has been found, return the traced path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(currentNode === end) {
        <span class="hljs-keyword">var</span> curr = currentNode;
        <span class="hljs-keyword">var</span> ret = [];
        <span class="hljs-keyword">while</span>(curr.parent) {
          ret.push(curr);
          curr = curr.parent;
        }
        <span class="hljs-keyword">return</span> ret.reverse();
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Normal case — move currentNode from open to closed, process each of its neighbors.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      currentNode.closed = <span class="hljs-literal">true</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Find all neighbors for the current node. Optionally find diagonal neighbors as well (false by default).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> neighbors = astar.neighbors(grid, currentNode, diagonal);

      <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>, il = neighbors.length; i &lt; il; i++) {
        <span class="hljs-keyword">var</span> neighbor = neighbors[i];

        <span class="hljs-keyword">if</span>(neighbor.closed || neighbor.isWall()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Not a valid node to process, skip to next neighbor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">continue</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>The g score is the shortest distance from start to current node.
We need to check if the path we have arrived at this neighbor is the shortest one we have seen yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> gScore = currentNode.g + neighbor.cost;
        <span class="hljs-keyword">var</span> beenVisited = neighbor.visited;

        <span class="hljs-keyword">if</span>(!beenVisited || gScore &lt; neighbor.g) {</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Found an optimal (so far) path to this node.  Take score for node to see how good it is.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          neighbor.visited = <span class="hljs-literal">true</span>;
          neighbor.parent = currentNode;
          neighbor.h = neighbor.h || heuristic(neighbor.pos, end.pos);
          neighbor.g = gScore;
          neighbor.f = neighbor.g + neighbor.h;

          <span class="hljs-keyword">if</span> (!beenVisited) {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Pushing to heap will put it in proper place based on the ‘f’ value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            openHeap.push(neighbor);
          }
          <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Already seen the node, but since it has been rescored we need to reorder it in the heap</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            openHeap.rescoreElement(neighbor);
          }
        }
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>No result was found - empty array signifies failure to find path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> [];
  },
  manhattan: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pos0, pos1)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>See list of heuristics: <a href="http://theory.stanford.edu/~amitp/GameProgramming/Heuristics.dom">http://theory.stanford.edu/~amitp/GameProgramming/Heuristics.dom</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
    <span class="hljs-keyword">var</span> d1 = <span class="hljs-built_in">Math</span>.abs (pos1.x - pos0.x);
    <span class="hljs-keyword">var</span> d2 = <span class="hljs-built_in">Math</span>.abs (pos1.y - pos0.y);
    <span class="hljs-keyword">return</span> d1 + d2;
  },
  neighbors: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(grid, node, diagonals)</span> {</span>
    <span class="hljs-keyword">var</span> ret = [];
    <span class="hljs-keyword">var</span> x = node.x;
    <span class="hljs-keyword">var</span> y = node.y;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>West</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(grid[x-<span class="hljs-number">1</span>] &amp;&amp; grid[x-<span class="hljs-number">1</span>][y]) {
      ret.push(grid[x-<span class="hljs-number">1</span>][y]);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>East</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(grid[x+<span class="hljs-number">1</span>] &amp;&amp; grid[x+<span class="hljs-number">1</span>][y]) {
      ret.push(grid[x+<span class="hljs-number">1</span>][y]);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>South</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(grid[x] &amp;&amp; grid[x][y-<span class="hljs-number">1</span>]) {
      ret.push(grid[x][y-<span class="hljs-number">1</span>]);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>North</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(grid[x] &amp;&amp; grid[x][y+<span class="hljs-number">1</span>]) {
      ret.push(grid[x][y+<span class="hljs-number">1</span>]);
    }

    <span class="hljs-keyword">if</span> (diagonals) {</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Southwest</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(grid[x-<span class="hljs-number">1</span>] &amp;&amp; grid[x-<span class="hljs-number">1</span>][y-<span class="hljs-number">1</span>]) {
        ret.push(grid[x-<span class="hljs-number">1</span>][y-<span class="hljs-number">1</span>]);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Southeast</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(grid[x+<span class="hljs-number">1</span>] &amp;&amp; grid[x+<span class="hljs-number">1</span>][y-<span class="hljs-number">1</span>]) {
        ret.push(grid[x+<span class="hljs-number">1</span>][y-<span class="hljs-number">1</span>]);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Northwest</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(grid[x-<span class="hljs-number">1</span>] &amp;&amp; grid[x-<span class="hljs-number">1</span>][y+<span class="hljs-number">1</span>]) {
        ret.push(grid[x-<span class="hljs-number">1</span>][y+<span class="hljs-number">1</span>]);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Northeast</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>(grid[x+<span class="hljs-number">1</span>] &amp;&amp; grid[x+<span class="hljs-number">1</span>][y+<span class="hljs-number">1</span>]) {
        ret.push(grid[x+<span class="hljs-number">1</span>][y+<span class="hljs-number">1</span>]);
      }

    }

    <span class="hljs-keyword">return</span> ret;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * @namespace
 */</span>
<span class="hljs-keyword">var</span> Base64Helper = {};

<span class="hljs-comment">/**
 *
 * @param {String} data
 */</span>
Base64Helper.base64ToImage = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
  <span class="hljs-keyword">var</span> img = <span class="hljs-keyword">new</span> Image();
  img.src = <span class="hljs-string">"data:image/png;base64,"</span>+data;
  <span class="hljs-keyword">return</span> img;
};

<span class="hljs-comment">/**
 *
 * @param {Image} img
 */</span>
Base64Helper.canvasToBase64 = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(img)</span> {</span>
  <span class="hljs-keyword">var</span> dataURL;

  <span class="hljs-keyword">if</span> (img <span class="hljs-keyword">instanceof</span> Image) {</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Create an empty canvas element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> canvas = document.createElement(<span class="hljs-string">"canvas"</span>);
    canvas.width = img.width;
    canvas.height = img.height;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Copy the assets contents to the canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ctx = canvas.getContext(<span class="hljs-string">"2d"</span>);
    ctx.drawImage(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Get the aw2-URL formatted assets
Firefox supports PNG and JPEG. You could check img.src to
guess the original format, but be aware the using “assets/jpg”
will re-encode the assets.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    dataURL = canvas.toDataURL(<span class="hljs-string">"assets/png"</span>);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (img <span class="hljs-keyword">instanceof</span> HTMLCanvasElement) {
    dataURL = (<span class="hljs-comment">/** @type {HTMLCanvasElement}*/</span> img).toDataURL(<span class="hljs-string">"assets/png"</span>);
  }

  <span class="hljs-keyword">return</span> dataURL.replace(<span class="hljs-regexp">/^data:image\/(png|jpg);base64,/</span>, <span class="hljs-string">""</span>);
};

<span class="hljs-comment">/*
 * Based on base64-arraybuffer
 * https://github.com/niklasvh/base64-arraybuffer
 *
 * Copyright (c) 2012 Niklas von Hertzen
 * Licensed under the MIT license.
 */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chars)</span> {</span>
  <span class="hljs-keyword">var</span> encodings = chars;

  Base64Helper.encodeBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(arrayBuffer)</span> {</span>
    <span class="hljs-keyword">var</span> base64 = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">var</span> bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(arrayBuffer);
    <span class="hljs-keyword">var</span> byteLength = bytes.byteLength;
    <span class="hljs-keyword">var</span> byteRemainder = byteLength % <span class="hljs-number">3</span>;
    <span class="hljs-keyword">var</span> mainLength = byteLength - byteRemainder;

    <span class="hljs-keyword">var</span> a, b, c, d;
    <span class="hljs-keyword">var</span> chunk;</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Main loop deals with bytes in chunks of 3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; mainLength; i = i + <span class="hljs-number">3</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Combine the three bytes into a single integer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      chunk = (bytes[i] &lt;&lt; <span class="hljs-number">16</span>) | (bytes[i + <span class="hljs-number">1</span>] &lt;&lt; <span class="hljs-number">8</span>) | bytes[i + <span class="hljs-number">2</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Use bitmasks to extract 6-bit segments from the triplet</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      a = (chunk &amp; <span class="hljs-number">16515072</span>) &gt;&gt; <span class="hljs-number">18</span>; <span class="hljs-comment">// 16515072 = (2^6 - 1) &lt;&lt; 18</span>
      b = (chunk &amp; <span class="hljs-number">258048</span>) &gt;&gt; <span class="hljs-number">12</span>; <span class="hljs-comment">// 258048   = (2^6 - 1) &lt;&lt; 12</span>
      c = (chunk &amp; <span class="hljs-number">4032</span>) &gt;&gt; <span class="hljs-number">6</span>; <span class="hljs-comment">// 4032     = (2^6 - 1) &lt;&lt; 6</span>
      d = chunk &amp; <span class="hljs-number">63</span>;               <span class="hljs-comment">// 63       = 2^6 - 1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Convert the raw binary segments to the appropriate ASCII encoding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      base64 += encodings[a] + encodings[b] + encodings[c] + encodings[d];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Deal with the remaining bytes and padding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (byteRemainder == <span class="hljs-number">1</span>) {
      chunk = bytes[mainLength];

      a = (chunk &amp; <span class="hljs-number">252</span>) &gt;&gt; <span class="hljs-number">2</span>; <span class="hljs-comment">// 252 = (2^6 - 1) &lt;&lt; 2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Set the 4 least significant bits to zero</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      b = (chunk &amp; <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">4</span>; <span class="hljs-comment">// 3   = 2^2 - 1</span>

      base64 += encodings[a] + encodings[b] + <span class="hljs-string">'=='</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (byteRemainder == <span class="hljs-number">2</span>) {
      chunk = (bytes[mainLength] &lt;&lt; <span class="hljs-number">8</span>) | bytes[mainLength + <span class="hljs-number">1</span>];

      a = (chunk &amp; <span class="hljs-number">64512</span>) &gt;&gt; <span class="hljs-number">10</span>; <span class="hljs-comment">// 64512 = (2^6 - 1) &lt;&lt; 10</span>
      b = (chunk &amp; <span class="hljs-number">1008</span>) &gt;&gt; <span class="hljs-number">4</span>; <span class="hljs-comment">// 1008  = (2^6 - 1) &lt;&lt; 4</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Set the 2 least significant bits to zero</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      c = (chunk &amp; <span class="hljs-number">15</span>) &lt;&lt; <span class="hljs-number">2</span>; <span class="hljs-comment">// 15    = 2^4 - 1</span>

      base64 += encodings[a] + encodings[b] + encodings[c] + <span class="hljs-string">'='</span>;
    }

    <span class="hljs-keyword">return</span> base64;
  };

  Base64Helper.decodeBuffer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(base64)</span> {</span>
    <span class="hljs-keyword">var</span> bufferLength = base64.length * <span class="hljs-number">0.75</span>,
      len = base64.length, i, p = <span class="hljs-number">0</span>,
      encoded1, encoded2, encoded3, encoded4;

    <span class="hljs-keyword">if</span> (base64[base64.length - <span class="hljs-number">1</span>] === <span class="hljs-string">"="</span>) {
      bufferLength--;
      <span class="hljs-keyword">if</span> (base64[base64.length - <span class="hljs-number">2</span>] === <span class="hljs-string">"="</span>) {
        bufferLength--;
      }
    }

    <span class="hljs-keyword">var</span> arraybuffer = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayBuffer</span>(bufferLength),
      bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(arraybuffer);

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; len; i += <span class="hljs-number">4</span>) {
      encoded1 = chars.indexOf(base64[i]);
      encoded2 = chars.indexOf(base64[i + <span class="hljs-number">1</span>]);
      encoded3 = chars.indexOf(base64[i + <span class="hljs-number">2</span>]);
      encoded4 = chars.indexOf(base64[i + <span class="hljs-number">3</span>]);

      bytes[p++] = (encoded1 &lt;&lt; <span class="hljs-number">2</span>) | (encoded2 &gt;&gt; <span class="hljs-number">4</span>);
      bytes[p++] = ((encoded2 &amp; <span class="hljs-number">15</span>) &lt;&lt; <span class="hljs-number">4</span>) | (encoded3 &gt;&gt; <span class="hljs-number">2</span>);
      bytes[p++] = ((encoded3 &amp; <span class="hljs-number">3</span>) &lt;&lt; <span class="hljs-number">6</span>) | (encoded4 &amp; <span class="hljs-number">63</span>);
    }

    <span class="hljs-keyword">return</span> arraybuffer;
  };
})(<span class="hljs-string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function/bind</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Function</span>.prototype.bind) {
  <span class="hljs-built_in">Function</span>.prototype.bind = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(oThis)</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-keyword">this</span> !== <span class="hljs-string">"function"</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>closest thing possible to the ECMAScript 5 internal IsCallable function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">TypeError</span>(<span class="hljs-string">"Function.prototype.bind - what is trying to be bound is not callable"</span>);
    }

    <span class="hljs-keyword">var</span> aArgs = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>),
      fToBind = <span class="hljs-keyword">this</span>,
      fNOP = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>},
      fBound = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">return</span> fToBind.apply(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> fNOP &amp;&amp; oThis
          ? <span class="hljs-keyword">this</span>
          : oThis,
          aArgs.concat(<span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>)));
      };

    fNOP.prototype = <span class="hljs-keyword">this</span>.prototype;
    fBound.prototype = <span class="hljs-keyword">new</span> fNOP();

    <span class="hljs-keyword">return</span> fBound;
  };
}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/* Browser Detection, taken from HeadJS. */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
<span class="hljs-pi">  "use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>browser type &amp; version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> ua     = window.navigator.userAgent.toLowerCase(),
      mobile = <span class="hljs-regexp">/mobile|android|kindle|silk|midp|(windows nt 6\.2.+arm|touch)/</span>.test(ua);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p><a href="http://www.zytrax.com/tech/web/browser_ids.htm">http://www.zytrax.com/tech/web/browser_ids.htm</a>
<a href="http://www.zytrax.com/tech/web/mobile_ids.dom">http://www.zytrax.com/tech/web/mobile_ids.dom</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ua = <span class="hljs-regexp">/(chrome|firefox)[ \/]([\w.]+)/</span>.exec(ua) ||               <span class="hljs-comment">// Chrome &amp; Firefox</span>
    /(iphone|ipad|ipod)(?:.*version)?[ \/]([\w.]+)/.exec(ua) ||  <span class="hljs-comment">// Mobile IOS</span>
    /(android)(?:.*version)?[ \/]([\w.]+)/.exec(ua) ||           <span class="hljs-comment">// Mobile Webkit</span>
    /(webkit|opera)(?:.*version)?[ \/]([\w.]+)/.exec(ua) ||      <span class="hljs-comment">// Safari &amp; Opera</span>
    /(msie) ([\w.]+)/.exec(ua) || [];                            <span class="hljs-comment">// Internet Explorer</span>
  
  <span class="hljs-keyword">var</span> browser = ua[<span class="hljs-number">1</span>],
      version = <span class="hljs-built_in">parseFloat</span>(ua[<span class="hljs-number">2</span>]);    
  
  <span class="hljs-keyword">switch</span> (browser) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'msie'</span>:
      browser = <span class="hljs-string">'ie'</span>;
      version = doc.documentMode || version;
      <span class="hljs-keyword">break</span>;
      
    <span class="hljs-keyword">case</span> <span class="hljs-string">'firefox'</span>:
      browser = <span class="hljs-string">'ff'</span>;
      <span class="hljs-keyword">break</span>;
      
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ipod'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'ipad'</span>:
    <span class="hljs-keyword">case</span> <span class="hljs-string">'iphone'</span>:
      browser = <span class="hljs-string">'ios'</span>;
      <span class="hljs-keyword">break</span>;
      
    <span class="hljs-keyword">case</span> <span class="hljs-string">'webkit'</span>:
      browser = <span class="hljs-string">'safari'</span>;
      <span class="hljs-keyword">break</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Browser vendor and version</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  window.Browser = {
    name   : browser,
    mobile : mobile,
    version: version
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Shortcut</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Browser[browser] = <span class="hljs-literal">true</span>;
  
})();</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/*globals define:true, window:true, module:true*/</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Namespace object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> my = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Return as AMD module or attach to head object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define !== <span class="hljs-string">'undefined'</span>)
    define([], <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">return</span> my;
    });
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> window !== <span class="hljs-string">'undefined'</span>)
    window.my = my;
  <span class="hljs-keyword">else</span>
    module.exports = my;</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>============================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>@method my.Class
@params body:Object
@params SuperClass:function, ImplementClasses:function…, body:Object
@return function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  my.Class = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

    <span class="hljs-keyword">var</span> len = <span class="hljs-built_in">arguments</span>.length;
    <span class="hljs-keyword">var</span> body = <span class="hljs-built_in">arguments</span>[len - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">var</span> SuperClass = len &gt; <span class="hljs-number">1</span> ? <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] : <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">var</span> hasImplementClasses = len &gt; <span class="hljs-number">2</span>;
    <span class="hljs-keyword">var</span> Class, SuperClassEmpty;

    <span class="hljs-keyword">if</span> (body.constructor === <span class="hljs-built_in">Object</span>) {
      Class = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>};
    } <span class="hljs-keyword">else</span> {
      Class = body.constructor;
      <span class="hljs-keyword">delete</span> body.constructor;
    }

    <span class="hljs-keyword">if</span> (SuperClass) {
      SuperClassEmpty = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>};
      SuperClassEmpty.prototype = SuperClass.prototype;
      Class.prototype = <span class="hljs-keyword">new</span> SuperClassEmpty();
      Class.prototype.constructor = Class;
      Class.Super = SuperClass;
      extend(Class, SuperClass, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-keyword">if</span> (hasImplementClasses)
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt; len - <span class="hljs-number">1</span>; i++)
        extend(Class.prototype, <span class="hljs-built_in">arguments</span>[i].prototype, <span class="hljs-literal">false</span>);

    extendClass(Class, body);

    <span class="hljs-keyword">return</span> Class;

  };</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>============================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>@method my.extendClass
@params Class:function, extension:Object, ?override:boolean=true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> extendClass = my.extendClass = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(Class, extension, override)</span> {</span>
    <span class="hljs-keyword">if</span> (extension.STATIC) {
      extend(Class, extension.STATIC, override);
      <span class="hljs-keyword">delete</span> extension.STATIC;
    }
    extend(Class.prototype, extension, override);
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>============================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> extend = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, extension, override)</span> {</span>
    <span class="hljs-keyword">var</span> prop;
    <span class="hljs-keyword">if</span> (override === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">for</span> (prop <span class="hljs-keyword">in</span> extension)
        <span class="hljs-keyword">if</span> (!(prop <span class="hljs-keyword">in</span> obj))
          obj[prop] = extension[prop];
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">for</span> (prop <span class="hljs-keyword">in</span> extension)
        obj[prop] = extension[prop];
      <span class="hljs-keyword">if</span> (extension.toString !== <span class="hljs-built_in">Object</span>.prototype.toString)
        obj.toString = extension.toString;
    }
  };

})();</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">if</span> (window.console) window.console = {};
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(console)</span> {</span>
  <span class="hljs-keyword">var</span> container = document.createElement(<span class="hljs-string">"div"</span>);

  container.id = <span class="hljs-string">"customLogPanel"</span>;

  container.style.position = <span class="hljs-string">"absolute"</span>;
  container.style.display = <span class="hljs-string">"block"</span>;
  container.style.left = <span class="hljs-string">"5px"</span>;
  container.style.top = <span class="hljs-string">"5px"</span>;
  container.style.width = <span class="hljs-string">"50%"</span>;
  container.style.height = <span class="hljs-string">"50%"</span>;
  container.style.overflow = <span class="hljs-string">"hidden"</span>;
  container.style.color = <span class="hljs-string">"white"</span>;
  container.style.fontWeight = <span class="hljs-string">"bold"</span>;
  container.style.backgroundColor = <span class="hljs-string">"rgba(0,0,0,0.3)"</span>;
  container.style.border = <span class="hljs-string">"1px solid black"</span>;
  container.style.padding = <span class="hljs-string">"2px"</span>;
  container.style.pointerEvents = <span class="hljs-string">"none"</span>;
  container.style.zIndex = <span class="hljs-string">"9999"</span>;

  document.getElementsByTagName(<span class="hljs-string">"body"</span>)[<span class="hljs-number">0</span>].appendChild(container);

  window.console.toggle = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    container.style.display = (container.style.display === <span class="hljs-string">"block"</span>)? <span class="hljs-string">"none"</span> : <span class="hljs-string">"block"</span>;
  };

  window.console.log = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg)</span> {</span>
    <span class="hljs-keyword">var</span> el = document.createElement(<span class="hljs-string">"p"</span>);
    el.innerHTML = <span class="hljs-string">" INFO:: "</span>+msg;

    el.style.margin = <span class="hljs-string">"0"</span>;

    container.insertBefore(el,container.children[<span class="hljs-number">0</span>]);

  };

  window.console.error = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(msg, where)</span> {</span>
    <span class="hljs-keyword">var</span> el = document.createElement(<span class="hljs-string">"p"</span>);
    el.innerHTML = <span class="hljs-string">"ERROR:: "</span>+msg+((where)? <span class="hljs-string">"&lt;br/&gt;[at: "</span>+where+<span class="hljs-string">"]"</span> : <span class="hljs-string">""</span>);

    el.style.color = <span class="hljs-string">"red"</span>;
    el.style.margin = <span class="hljs-string">"2"</span>;

    container.insertBefore(el,container.children[<span class="hljs-number">0</span>]);
  };

})(window.console);<span class="hljs-comment">/* jshint proto: true */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * jjv.js -- A javascript library to validate json input through a json-schema.
 *
 * Copyright (c) 2013 Alex Cornejo.
 *
 * Redistributable under a MIT-style open source license.
 */</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> clone = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Handle the 3 simple types (string, number, function), and null or undefined</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">'object'</span>) <span class="hljs-keyword">return</span> obj;
    <span class="hljs-keyword">var</span> copy;</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Handle Date</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>) {
      copy = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
      copy.setTime(obj.getTime());
      <span class="hljs-keyword">return</span> copy;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>handle RegExp</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">RegExp</span>) {
      copy = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(obj);
      <span class="hljs-keyword">return</span> copy;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>Handle Array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Array</span>) {
      copy = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = obj.length; i &lt; len; i++)
        copy[i] = clone(obj[i]);
      <span class="hljs-keyword">return</span> copy;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>Handle Object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Object</span>) {
      copy = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <pre><code>      copy = <span class="hljs-built_in">Object</span>.create(<span class="hljs-built_in">Object</span>.getPrototypeOf(obj));
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (obj.hasOwnProperty(attr))
          copy[attr] = clone(obj[attr]);
      }
      <span class="hljs-keyword">return</span> copy;
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"Unable to clone object!"</span>);
  };

  <span class="hljs-keyword">var</span> clone_stack = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(stack)</span> {</span>
    <span class="hljs-keyword">var</span> stack_last = stack.length-<span class="hljs-number">1</span>, key = stack[stack_last].key;
    <span class="hljs-keyword">var</span> new_stack = stack.slice(<span class="hljs-number">0</span>);
    new_stack[stack_last].object[key] = clone(new_stack[stack_last].object[key]);
    <span class="hljs-keyword">return</span> new_stack;
  };

  <span class="hljs-keyword">var</span> copy_stack = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(new_stack, old_stack)</span> {</span>
    <span class="hljs-keyword">var</span> stack_last = new_stack.length-<span class="hljs-number">1</span>, key = new_stack[stack_last].key;
    old_stack[stack_last].object[key] = new_stack[stack_last].object[key];
  };

  <span class="hljs-keyword">var</span> handled = {
    <span class="hljs-string">'type'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'not'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'anyOf'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'allOf'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'oneOf'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'$ref'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'$schema'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'id'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'exclusiveMaximum'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'exclusiveMininum'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'properties'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'patternProperties'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'additionalProperties'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'items'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'additionalItems'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'default'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'title'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'description'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'definitions'</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-string">'dependencies'</span>: <span class="hljs-literal">true</span>
  };

  <span class="hljs-keyword">var</span> fieldType = {
    <span class="hljs-string">'null'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span>
      <span class="hljs-keyword">return</span> x === <span class="hljs-literal">null</span>;
    },
    <span class="hljs-string">'string'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'string'</span>;
    },
    <span class="hljs-string">'boolean'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'boolean'</span>;
    },
    <span class="hljs-string">'number'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Use x === x instead of !isNaN(x) for speed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'number'</span> &amp;&amp; x === x;
    },
    <span class="hljs-string">'integer'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'number'</span> &amp;&amp; x%<span class="hljs-number">1</span> === <span class="hljs-number">0</span>;
    },
    <span class="hljs-string">'object'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span>
      <span class="hljs-keyword">return</span> x &amp;&amp; <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'object'</span> &amp;&amp; !<span class="hljs-built_in">Array</span>.isArray(x);
    },
    <span class="hljs-string">'array'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Array</span>.isArray(x);
    },
    <span class="hljs-string">'date'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x)</span> {</span>
      <span class="hljs-keyword">return</span> x <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Date</span>;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>missing: uri, date-time, ipv4, ipv6</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> fieldFormat = {
    <span class="hljs-string">'alpha'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^[a-zA-Z]+$/</span>).test(v);
    },
    <span class="hljs-string">'alphanumeric'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^[a-zA-Z0-9]+$/</span>).test(v);
    },
    <span class="hljs-string">'identifier'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^[-_a-zA-Z0-9]+$/</span>).test(v);
    },
    <span class="hljs-string">'hexadecimal'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^[a-fA-F0-9]+$/</span>).test(v);
    },
    <span class="hljs-string">'numeric'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^[0-9]+$/</span>).test(v);
    },
    <span class="hljs-string">'date-time'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> !<span class="hljs-built_in">isNaN</span>(<span class="hljs-built_in">Date</span>.parse(v)) &amp;&amp; v.indexOf(<span class="hljs-string">'/'</span>) === -<span class="hljs-number">1</span>;
    },
    <span class="hljs-string">'uppercase'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> v === v.toUpperCase();
    },
    <span class="hljs-string">'lowercase'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> v === v.toLowerCase();
    },
    <span class="hljs-string">'hostname'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> v.length &lt; <span class="hljs-number">256</span> &amp;&amp; (<span class="hljs-regexp">/^([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])(\.([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]{0,61}[a-zA-Z0-9]))*$/</span>).test(v);
    },
    <span class="hljs-string">'uri'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/[-a-zA-Z0-9@:%_\+.~#?&amp;//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&amp;//=]*)?/</span>).test(v);
    },
    <span class="hljs-string">'email'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span> <span class="hljs-comment">// email, ipv4 and ipv6 adapted from node-validator_</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^(?:[\w\!\#\$\%\&amp;\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&amp;\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/</span>).test(v);
    },
    <span class="hljs-string">'ipv4'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">if</span> ((<span class="hljs-regexp">/^(\d?\d?\d)\.(\d?\d?\d)\.(\d?\d?\d)\.(\d?\d?\d)$/</span>).test(v)) {
        <span class="hljs-keyword">var</span> parts = v.split(<span class="hljs-string">'.'</span>).sort();
        <span class="hljs-keyword">if</span> (parts[<span class="hljs-number">3</span>] &lt;= <span class="hljs-number">255</span>)
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },
    <span class="hljs-string">'ipv6'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> {</span>
      <span class="hljs-keyword">return</span> (<span class="hljs-regexp">/^((?=.*::)(?!.*::.+::)(::)?([\dA-F]{1,4}:(:|\b)|){5}|([\dA-F]{1,4}:){6})((([\dA-F]{1,4}((?!\3)::|:\b|$))|(?!\2\3)){2}|(((2[0-4]|1\d|[1-9])?\d|25[0-5])\.?\b){4})$/</span>).test(v);
      <span class="hljs-comment">/*  return (/^::|^::1|^([a-fA-F0-9]{1,4}::?){1,7}([a-fA-F0-9]{1,4})$/).test(v); */</span>
    }
  };

  <span class="hljs-keyword">var</span> fieldValidate = {
    <span class="hljs-string">'readOnly'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p><strong>**</strong> numeric validation <strong><em>**</em></strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">'minimum'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p, schema)</span> {</span>
      <span class="hljs-keyword">return</span> !(v &lt; p || schema.exclusiveMinimum &amp;&amp; v &lt;= p);
    },
    <span class="hljs-string">'maximum'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p, schema)</span> {</span>
      <span class="hljs-keyword">return</span> !(v &gt; p || schema.exclusiveMaximum &amp;&amp; v &gt;= p);
    },
    <span class="hljs-string">'multipleOf'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">return</span> (v/p)%<span class="hljs-number">1</span> === <span class="hljs-number">0</span> || <span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">'number'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p><strong>**</strong> string validation <strong>**</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">'pattern'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">'string'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> pattern, modifiers;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> p === <span class="hljs-string">'string'</span>)
        pattern=p;
      <span class="hljs-keyword">else</span> {
        pattern=p[<span class="hljs-number">0</span>];
        modifiers=p[<span class="hljs-number">1</span>];
      }
      <span class="hljs-keyword">var</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-built_in">RegExp</span>(pattern, modifiers);
      <span class="hljs-keyword">return</span> regex.test(v);
    },
    <span class="hljs-string">'minLength'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">return</span> v.length &gt;= p || <span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">'string'</span>;
    },
    <span class="hljs-string">'maxLength'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">return</span> v.length &lt;= p || <span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">'string'</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p><strong>*</strong> array validation <strong>*</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">'minItems'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">return</span> v.length &gt;= p || !<span class="hljs-built_in">Array</span>.isArray(v);
    },
    <span class="hljs-string">'maxItems'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">return</span> v.length &lt;= p || !<span class="hljs-built_in">Array</span>.isArray(v);
    },
    <span class="hljs-string">'uniqueItems'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">var</span> hash = {}, key;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, len = v.length; i &lt; len; i++) {
        key = <span class="hljs-built_in">JSON</span>.stringify(v[i]);
        <span class="hljs-keyword">if</span> (hash.hasOwnProperty(key))
          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">else</span>
          hash[key] = <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p><strong>*</strong> object validation <em>**</em></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">'minProperties'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">'object'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> v) <span class="hljs-keyword">if</span> (v.hasOwnProperty(attr)) count = count + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> count &gt;= p;
    },
    <span class="hljs-string">'maxProperties'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v !== <span class="hljs-string">'object'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> v) <span class="hljs-keyword">if</span> (v.hasOwnProperty(attr)) count = count + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">return</span> count &lt;= p;
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <p><strong>**</strong> all <strong>*</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-string">'enum'</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(v, p)</span> {</span>
      <span class="hljs-keyword">var</span> i, len, vs;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> v === <span class="hljs-string">'object'</span>) {
        vs = <span class="hljs-built_in">JSON</span>.stringify(v);
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = p.length; i &lt; len; i++)
          <span class="hljs-keyword">if</span> (vs === <span class="hljs-built_in">JSON</span>.stringify(p[i]))
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = p.length; i &lt; len; i++)
          <span class="hljs-keyword">if</span> (v === p[i])
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  };

  <span class="hljs-keyword">var</span> normalizeID = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> {</span>
    <span class="hljs-keyword">return</span> id.indexOf(<span class="hljs-string">"://"</span>) === -<span class="hljs-number">1</span> ? id : id.split(<span class="hljs-string">"#"</span>)[<span class="hljs-number">0</span>];
  };

  <span class="hljs-keyword">var</span> resolveURI = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(env, schema_stack, uri)</span> {</span>
    <span class="hljs-keyword">var</span> curschema, components, hash_idx, name;

    hash_idx = uri.indexOf(<span class="hljs-string">'#'</span>);

    <span class="hljs-keyword">if</span> (hash_idx === -<span class="hljs-number">1</span>) {
      <span class="hljs-keyword">if</span> (!env.schema.hasOwnProperty(uri))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">return</span> [env.schema[uri]];
    }

    <span class="hljs-keyword">if</span> (hash_idx &gt; <span class="hljs-number">0</span>) {
      name = uri.substr(<span class="hljs-number">0</span>, hash_idx);
      uri = uri.substr(hash_idx+<span class="hljs-number">1</span>);
      <span class="hljs-keyword">if</span> (!env.schema.hasOwnProperty(name)) {
        <span class="hljs-keyword">if</span> (schema_stack &amp;&amp; schema_stack[<span class="hljs-number">0</span>].id === name)
          schema_stack = [schema_stack[<span class="hljs-number">0</span>]];
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      } <span class="hljs-keyword">else</span>
        schema_stack = [env.schema[name]];
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!schema_stack)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
      uri = uri.substr(<span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">if</span> (uri === <span class="hljs-string">''</span>)
      <span class="hljs-keyword">return</span> [schema_stack[<span class="hljs-number">0</span>]];

    <span class="hljs-keyword">if</span> (uri.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'/'</span>) {
      uri = uri.substr(<span class="hljs-number">1</span>);
      curschema = schema_stack[<span class="hljs-number">0</span>];
      components = uri.split(<span class="hljs-string">'/'</span>);
      <span class="hljs-keyword">while</span> (components.length &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (!curschema.hasOwnProperty(components[<span class="hljs-number">0</span>]))
          <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        curschema = curschema[components[<span class="hljs-number">0</span>]];
        schema_stack.push(curschema);
        components.shift();
      }
      <span class="hljs-keyword">return</span> schema_stack;
    } <span class="hljs-keyword">else</span> <span class="hljs-comment">// FIX: should look for subschemas whose id matches uri</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };

  <span class="hljs-keyword">var</span> resolveObjectRef = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(object_stack, uri)</span> {</span>
    <span class="hljs-keyword">var</span> components, object, last_frame = object_stack.length-<span class="hljs-number">1</span>, skip_frames, frame, m = <span class="hljs-regexp">/^(\d+)/</span>.exec(uri);

    <span class="hljs-keyword">if</span> (m) {
      uri = uri.substr(m[<span class="hljs-number">0</span>].length);
      skip_frames = <span class="hljs-built_in">parseInt</span>(m[<span class="hljs-number">1</span>], <span class="hljs-number">10</span>);
      <span class="hljs-keyword">if</span> (skip_frames &lt; <span class="hljs-number">0</span> || skip_frames &gt; last_frame)
        <span class="hljs-keyword">return</span>;
      frame = object_stack[last_frame-skip_frames];
      <span class="hljs-keyword">if</span> (uri === <span class="hljs-string">'#'</span>)
        <span class="hljs-keyword">return</span> frame.key;
    } <span class="hljs-keyword">else</span>
      frame = object_stack[<span class="hljs-number">0</span>];

    object = frame.object[frame.key];

    <span class="hljs-keyword">if</span> (uri === <span class="hljs-string">''</span>)
      <span class="hljs-keyword">return</span> object;

    <span class="hljs-keyword">if</span> (uri.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'/'</span>) {
      uri = uri.substr(<span class="hljs-number">1</span>);
      components = uri.split(<span class="hljs-string">'/'</span>);
      <span class="hljs-keyword">while</span> (components.length &gt; <span class="hljs-number">0</span>) {
        components[<span class="hljs-number">0</span>] = components[<span class="hljs-number">0</span>].replace(<span class="hljs-regexp">/~1/g</span>, <span class="hljs-string">'/'</span>).replace(<span class="hljs-regexp">/~0/g</span>, <span class="hljs-string">'~'</span>);
        <span class="hljs-keyword">if</span> (!object.hasOwnProperty(components[<span class="hljs-number">0</span>]))
          <span class="hljs-keyword">return</span>;
        object = object[components[<span class="hljs-number">0</span>]];
        components.shift();
      }
      <span class="hljs-keyword">return</span> object;
    } <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span>;
  };

  <span class="hljs-keyword">var</span> checkValidity = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(env, schema_stack, object_stack, options)</span> {</span>
    <span class="hljs-keyword">var</span> i, len, count, hasProp, hasPattern;
    <span class="hljs-keyword">var</span> p, v, malformed = <span class="hljs-literal">false</span>, objerrs = {}, objerr, props, matched;
    <span class="hljs-keyword">var</span> sl = schema_stack.length-<span class="hljs-number">1</span>, schema = schema_stack[sl], new_stack;
    <span class="hljs-keyword">var</span> ol = object_stack.length-<span class="hljs-number">1</span>, object = object_stack[ol].object, name = object_stack[ol].key, prop = object[name];

    <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'$ref'</span>)) {
      schema_stack= resolveURI(env, schema_stack, schema.$ref);
      <span class="hljs-keyword">if</span> (!schema_stack)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'$ref'</span>: schema.$ref};
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> checkValidity(env, schema_stack, object_stack, options);
    }

    <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'type'</span>)) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.type === <span class="hljs-string">'string'</span>) {
        <span class="hljs-keyword">if</span> (options.useCoerce &amp;&amp; env.coerceType.hasOwnProperty(schema.type))
          prop = object[name] = env.coerceType[schema.type](prop);
        <span class="hljs-keyword">if</span> (!env.fieldType[schema.type](prop))
          <span class="hljs-keyword">return</span> {<span class="hljs-string">'type'</span>: schema.type};
      } <span class="hljs-keyword">else</span> {
        malformed = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.type.length; i &lt; len &amp;&amp; malformed; i++)
          <span class="hljs-keyword">if</span> (env.fieldType[schema.type[i]](prop))
            malformed = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (malformed)
          <span class="hljs-keyword">return</span> {<span class="hljs-string">'type'</span>: schema.type};
      }
    }

    <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'allOf'</span>)) {
      <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.allOf.length; i &lt; len; i++) {
        objerr = checkValidity(env, schema_stack.concat(schema.allOf[i]), object_stack, options);
        <span class="hljs-keyword">if</span> (objerr)
          <span class="hljs-keyword">return</span> objerr;
      }
    }

    <span class="hljs-keyword">if</span> (!options.useCoerce &amp;&amp; !options.useDefault &amp;&amp; !options.removeAdditional) {
      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'oneOf'</span>)) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.oneOf.length, count = <span class="hljs-number">0</span>; i &lt; len; i++) {
          objerr = checkValidity(env, schema_stack.concat(schema.oneOf[i]), object_stack, options);
          <span class="hljs-keyword">if</span> (!objerr) {
            count = count + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1</span>)
              <span class="hljs-keyword">break</span>;
          } <span class="hljs-keyword">else</span> {
            objerrs = objerr;
          }
        }
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1</span>)
          <span class="hljs-keyword">return</span> {<span class="hljs-string">'oneOf'</span>: <span class="hljs-literal">true</span>};
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">1</span>)
          <span class="hljs-keyword">return</span> objerrs;
        objerrs = {};
      }

      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'anyOf'</span>)) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.anyOf.length; i &lt; len; i++) {
          objerr = checkValidity(env, schema_stack.concat(schema.anyOf[i]), object_stack, options);
          <span class="hljs-keyword">if</span> (!objerr)
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">if</span> (objerr)
          <span class="hljs-keyword">return</span> objerr;
      }

      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'not'</span>)) {
        objerr = checkValidity(env, schema_stack.concat(schema.not), object_stack, options);
        <span class="hljs-keyword">if</span> (!objerr)
          <span class="hljs-keyword">return</span> {<span class="hljs-string">'not'</span>: <span class="hljs-literal">true</span>};
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'oneOf'</span>)) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.oneOf.length, count = <span class="hljs-number">0</span>; i &lt; len; i++) {
          new_stack = clone_stack(object_stack);
          objerr = checkValidity(env, schema_stack.concat(schema.oneOf[i]), new_stack, options);
          <span class="hljs-keyword">if</span> (!objerr) {
            count = count + <span class="hljs-number">1</span>;
            <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1</span>)
              <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">else</span>
              copy_stack(new_stack, object_stack);
          } <span class="hljs-keyword">else</span> {
            objerrs = objerr;
          }
        }
        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">1</span>)
          <span class="hljs-keyword">return</span> {<span class="hljs-string">'oneOf'</span>: <span class="hljs-literal">true</span>};
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (count &lt; <span class="hljs-number">1</span>)
          <span class="hljs-keyword">return</span> objerrs;
        objerrs = {};
      }

      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'anyOf'</span>)) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.anyOf.length; i &lt; len; i++) {
          new_stack = clone_stack(object_stack);
          objerr = checkValidity(env, schema_stack.concat(schema.anyOf[i]), new_stack, options);
          <span class="hljs-keyword">if</span> (!objerr) {
            copy_stack(new_stack, object_stack);
            <span class="hljs-keyword">break</span>;
          }
        }
        <span class="hljs-keyword">if</span> (objerr)
          <span class="hljs-keyword">return</span> objerr;
      }

      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'not'</span>)) {
        objerr = checkValidity(env, schema_stack.concat(schema.not), clone_stack(object_stack), options);
        <span class="hljs-keyword">if</span> (!objerr)
          <span class="hljs-keyword">return</span> {<span class="hljs-string">'not'</span>: <span class="hljs-literal">true</span>};
      }
    }

    <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'dependencies'</span>)) {
      <span class="hljs-keyword">for</span> (p <span class="hljs-keyword">in</span> schema.dependencies)
        <span class="hljs-keyword">if</span> (schema.dependencies.hasOwnProperty(p) &amp;&amp; prop.hasOwnProperty(p)) {
          <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(schema.dependencies[p])) {
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.dependencies[p].length; i &lt; len; i++)
              <span class="hljs-keyword">if</span> (!prop.hasOwnProperty(schema.dependencies[p][i])) {
                <span class="hljs-keyword">return</span> {<span class="hljs-string">'dependencies'</span>: <span class="hljs-literal">true</span>};
              }
          } <span class="hljs-keyword">else</span> {
            objerr = checkValidity(env, schema_stack.concat(schema.dependencies[p]), object_stack, options);
            <span class="hljs-keyword">if</span> (objerr)
              <span class="hljs-keyword">return</span> objerr;
          }
        }
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(prop)) {
      props = [];
      objerrs = {};
      <span class="hljs-keyword">for</span> (p <span class="hljs-keyword">in</span> prop)
        <span class="hljs-keyword">if</span> (prop.hasOwnProperty(p))
          props.push(p);

      <span class="hljs-keyword">if</span> (options.checkRequired &amp;&amp; schema.required) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.required.length; i &lt; len; i++)
          <span class="hljs-keyword">if</span> (!prop.hasOwnProperty(schema.required[i])) {
            objerrs[schema.required[i]] = {<span class="hljs-string">'required'</span>: <span class="hljs-literal">true</span>};
            malformed = <span class="hljs-literal">true</span>;
          }
      }

      hasProp = schema.hasOwnProperty(<span class="hljs-string">'properties'</span>);
      hasPattern = schema.hasOwnProperty(<span class="hljs-string">'patternProperties'</span>);
      <span class="hljs-keyword">if</span> (hasProp || hasPattern) {
        i = props.length;
        <span class="hljs-keyword">while</span> (i--) {
          matched = <span class="hljs-literal">false</span>;
          <span class="hljs-keyword">if</span> (hasProp &amp;&amp; schema.properties.hasOwnProperty(props[i])) {
            matched = <span class="hljs-literal">true</span>;
            objerr = checkValidity(env, schema_stack.concat(schema.properties[props[i]]), object_stack.concat({object: prop, key: props[i]}), options);
            <span class="hljs-keyword">if</span> (objerr !== <span class="hljs-literal">null</span>) {
              objerrs[props[i]] = objerr;
              malformed = <span class="hljs-literal">true</span>;
            }
          }
          <span class="hljs-keyword">if</span> (hasPattern) {
            <span class="hljs-keyword">for</span> (p <span class="hljs-keyword">in</span> schema.patternProperties)
              <span class="hljs-keyword">if</span> (schema.patternProperties.hasOwnProperty(p) &amp;&amp; props[i].match(p)) {
                matched = <span class="hljs-literal">true</span>;
                objerr = checkValidity(env, schema_stack.concat(schema.patternProperties[p]), object_stack.concat({object: prop, key: props[i]}), options);
                <span class="hljs-keyword">if</span> (objerr !== <span class="hljs-literal">null</span>) {
                  objerrs[props[i]] = objerr;
                  malformed = <span class="hljs-literal">true</span>;
                }
              }
          }
          <span class="hljs-keyword">if</span> (matched)
            props.splice(i, <span class="hljs-number">1</span>);
        }
      }

      <span class="hljs-keyword">if</span> (options.useDefault &amp;&amp; hasProp &amp;&amp; !malformed) {
        <span class="hljs-keyword">for</span> (p <span class="hljs-keyword">in</span> schema.properties)
          <span class="hljs-keyword">if</span> (schema.properties.hasOwnProperty(p) &amp;&amp; !prop.hasOwnProperty(p) &amp;&amp; schema.properties[p].hasOwnProperty(<span class="hljs-string">'default'</span>))
            prop[p] = schema.properties[p][<span class="hljs-string">'default'</span>];
      }

      <span class="hljs-keyword">if</span> (options.removeAdditional &amp;&amp; hasProp &amp;&amp; schema.additionalProperties !== <span class="hljs-literal">true</span> &amp;&amp; <span class="hljs-keyword">typeof</span> schema.additionalProperties !== <span class="hljs-string">'object'</span>) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = props.length; i &lt; len; i++)
          <span class="hljs-keyword">delete</span> prop[props[i]];
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'additionalProperties'</span>)) {
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.additionalProperties === <span class="hljs-string">'boolean'</span>) {
            <span class="hljs-keyword">if</span> (!schema.additionalProperties) {
              <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = props.length; i &lt; len; i++) {
                objerrs[props[i]] = {<span class="hljs-string">'additional'</span>: <span class="hljs-literal">true</span>};
                malformed = <span class="hljs-literal">true</span>;
              }
            }
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = props.length; i &lt; len; i++) {
              objerr = checkValidity(env, schema_stack.concat(schema.additionalProperties), object_stack.concat({object: prop, key: props[i]}), options);
              <span class="hljs-keyword">if</span> (objerr !== <span class="hljs-literal">null</span>) {
                objerrs[props[i]] = objerr;
                malformed = <span class="hljs-literal">true</span>;
              }
            }
          }
        }
      }
      <span class="hljs-keyword">if</span> (malformed)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'schema'</span>: objerrs};
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'items'</span>)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(schema.items)) {
          <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = schema.items.length; i &lt; len; i++) {
            objerr = checkValidity(env, schema_stack.concat(schema.items[i]), object_stack.concat({object: prop, key: i}), options);
            <span class="hljs-keyword">if</span> (objerr !== <span class="hljs-literal">null</span>) {
              objerrs[i] = objerr;
              malformed = <span class="hljs-literal">true</span>;
            }
          }
          <span class="hljs-keyword">if</span> (prop.length &gt; len &amp;&amp; schema.hasOwnProperty(<span class="hljs-string">'additionalItems'</span>)) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.additionalItems === <span class="hljs-string">'boolean'</span>) {
              <span class="hljs-keyword">if</span> (!schema.additionalItems)
                <span class="hljs-keyword">return</span> {<span class="hljs-string">'additionalItems'</span>: <span class="hljs-literal">true</span>};
            } <span class="hljs-keyword">else</span> {
              <span class="hljs-keyword">for</span> (i = len, len = prop.length; i &lt; len; i++) {
                objerr = checkValidity(env, schema_stack.concat(schema.additionalItems), object_stack.concat({object: prop, key: i}), options);
                <span class="hljs-keyword">if</span> (objerr !== <span class="hljs-literal">null</span>) {
                  objerrs[i] = objerr;
                  malformed = <span class="hljs-literal">true</span>;
                }
              }
            }
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = prop.length; i &lt; len; i++) {
            objerr = checkValidity(env, schema_stack.concat(schema.items), object_stack.concat({object: prop, key: i}), options);
            <span class="hljs-keyword">if</span> (objerr !== <span class="hljs-literal">null</span>) {
              objerrs[i] = objerr;
              malformed = <span class="hljs-literal">true</span>;
            }
          }
        }
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'additionalItems'</span>)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> schema.additionalItems !== <span class="hljs-string">'boolean'</span>) {
          <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, len = prop.length; i &lt; len; i++) {
            objerr = checkValidity(env, schema_stack.concat(schema.additionalItems), object_stack.concat({object: prop, key: i}), options);
            <span class="hljs-keyword">if</span> (objerr !== <span class="hljs-literal">null</span>) {
              objerrs[i] = objerr;
              malformed = <span class="hljs-literal">true</span>;
            }
          }
        }
      }
      <span class="hljs-keyword">if</span> (malformed)
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'schema'</span>: objerrs};
    }

    <span class="hljs-keyword">for</span> (v <span class="hljs-keyword">in</span> schema) {
      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(v) &amp;&amp; !handled.hasOwnProperty(v)) {
        <span class="hljs-keyword">if</span> (v === <span class="hljs-string">'format'</span>) {
          <span class="hljs-keyword">if</span> (env.fieldFormat.hasOwnProperty(schema[v]) &amp;&amp; !env.fieldFormat[schema[v]](prop, schema, object_stack, options)) {
            objerrs[v] = <span class="hljs-literal">true</span>;
            malformed = <span class="hljs-literal">true</span>;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (env.fieldValidate.hasOwnProperty(v) &amp;&amp; !env.fieldValidate[v](prop, schema[v].hasOwnProperty(<span class="hljs-string">'$data'</span>) ? resolveObjectRef(object_stack, schema[v].$data) : schema[v], schema, object_stack, options)) {
            objerrs[v] = <span class="hljs-literal">true</span>;
            malformed = <span class="hljs-literal">true</span>;
          }
        }
      }
    }

    <span class="hljs-keyword">if</span> (malformed)
      <span class="hljs-keyword">return</span> objerrs;
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  };

  <span class="hljs-keyword">var</span> defaultOptions = {
    useDefault: <span class="hljs-literal">false</span>,
    useCoerce: <span class="hljs-literal">false</span>,
    checkRequired: <span class="hljs-literal">true</span>,
    removeAdditional: <span class="hljs-literal">false</span>
  };

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Environment</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Environment))
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Environment();

    <span class="hljs-keyword">this</span>.coerceType = {};
    <span class="hljs-keyword">this</span>.fieldType = clone(fieldType);
    <span class="hljs-keyword">this</span>.fieldValidate = clone(fieldValidate);
    <span class="hljs-keyword">this</span>.fieldFormat = clone(fieldFormat);
    <span class="hljs-keyword">this</span>.defaultOptions = clone(defaultOptions);
    <span class="hljs-keyword">this</span>.schema = {};
  }

  Environment.prototype = {
    validate: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, object, options)</span> {</span>
      <span class="hljs-keyword">var</span> schema_stack = [name], errors = <span class="hljs-literal">null</span>, object_stack = [{object: {<span class="hljs-string">'__root__'</span>: object}, key: <span class="hljs-string">'__root__'</span>}];

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> name === <span class="hljs-string">'string'</span>) {
        schema_stack = resolveURI(<span class="hljs-keyword">this</span>, <span class="hljs-literal">null</span>, name);
        <span class="hljs-keyword">if</span> (!schema_stack)
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'jjv: could not find schema \''</span> + name + <span class="hljs-string">'\'.'</span>);
      }

      <span class="hljs-keyword">if</span> (!options) {
        options = <span class="hljs-keyword">this</span>.defaultOptions;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.defaultOptions)
          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaultOptions.hasOwnProperty(p) &amp;&amp; !options.hasOwnProperty(p))
            options[p] = <span class="hljs-keyword">this</span>.defaultOptions[p];
      }

      errors = checkValidity(<span class="hljs-keyword">this</span>, schema_stack, object_stack, options);

      <span class="hljs-keyword">if</span> (errors)
        <span class="hljs-keyword">return</span> {validation: errors.hasOwnProperty(<span class="hljs-string">'schema'</span>) ? errors.schema : errors};
      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    },

    resolveRef: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(schema_stack, $ref)</span> {</span>
      <span class="hljs-keyword">return</span> resolveURI(<span class="hljs-keyword">this</span>, schema_stack, $ref);
    },

    addType: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, func)</span> {</span>
      <span class="hljs-keyword">this</span>.fieldType[name] = func;
    },

    addTypeCoercion: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(type, func)</span> {</span>
      <span class="hljs-keyword">this</span>.coerceType[type] = func;
    },

    addCheck: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, func)</span> {</span>
      <span class="hljs-keyword">this</span>.fieldValidate[name] = func;
    },

    addFormat: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, func)</span> {</span>
      <span class="hljs-keyword">this</span>.fieldFormat[name] = func;
    },

    addSchema: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, schema)</span> {</span>
      <span class="hljs-keyword">if</span> (!schema &amp;&amp; name) {
        schema = name;
        name = <span class="hljs-literal">undefined</span>;
      }
      <span class="hljs-keyword">if</span> (schema.hasOwnProperty(<span class="hljs-string">'id'</span>) &amp;&amp; <span class="hljs-keyword">typeof</span> schema.id === <span class="hljs-string">'string'</span> &amp;&amp; schema.id !== name) {
        <span class="hljs-keyword">if</span> (schema.id.charAt(<span class="hljs-number">0</span>) === <span class="hljs-string">'/'</span>)
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'jjv: schema id\'s starting with / are invalid.'</span>);
        <span class="hljs-keyword">this</span>.schema[normalizeID(schema.id)] = schema;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!name) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'jjv: schema needs either a name or id attribute.'</span>);
      }
      <span class="hljs-keyword">if</span> (name)
        <span class="hljs-keyword">this</span>.schema[normalizeID(name)] = schema;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-96">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-96">&#182;</a>
              </div>
              <p>Export for use in server and client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> module !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> module.exports !== <span class="hljs-string">'undefined'</span>)
    module.exports = Environment;
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">'function'</span> &amp;&amp; define.amd)
    define(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span><span class="hljs-keyword">return</span> Environment;});
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">this</span>.jjv = Environment;
}).call(<span class="hljs-keyword">this</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-97">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-97">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-98">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-98">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-comment">/**
 * Lawnchair!
 * ---
 * clientside json store
 *
 */</span>
<span class="hljs-keyword">var</span> Lawnchair = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options, callback)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-99">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-99">&#182;</a>
              </div>
              <p>ensure Lawnchair was called as a constructor</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> Lawnchair)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Lawnchair(options, callback);</pre></div></div>
            
        </li>
        
        
        <li id="section-100">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-100">&#182;</a>
              </div>
              <p>lawnchair requires json</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">JSON</span>) <span class="hljs-keyword">throw</span> <span class="hljs-string">'JSON unavailable! Include http://www.json.org/json2.js to fix.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-101">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-101">&#182;</a>
              </div>
              <p>options are optional; callback is not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt;= <span class="hljs-number">2</span>) {
    callback = (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] === <span class="hljs-string">'function'</span>) ? <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] : <span class="hljs-built_in">arguments</span>[<span class="hljs-number">1</span>];
    options  = (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] === <span class="hljs-string">'function'</span>) ? {} : <span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>] || {};
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">throw</span> <span class="hljs-string">'Incorrect # of ctor args!'</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-102">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-102">&#182;</a>
              </div>
              <p>default configuration</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.record = options.record || <span class="hljs-string">'record'</span>  <span class="hljs-comment">// default for records</span>
  <span class="hljs-keyword">this</span>.name   = options.name   || <span class="hljs-string">'records'</span> <span class="hljs-comment">// default name for underlying store</span></pre></div></div>
            
        </li>
        
        
        <li id="section-103">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-103">&#182;</a>
              </div>
              <p>mixin first valid  adapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> adapter</pre></div></div>
            
        </li>
        
        
        <li id="section-104">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-104">&#182;</a>
              </div>
              <p>if the adapter is passed in we try to load that only</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (options.adapter) {</pre></div></div>
            
        </li>
        
        
        <li id="section-105">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-105">&#182;</a>
              </div>
              <p>the argument passed should be an array of prefered adapters
if it is not, we convert it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span>(options.adapter) === <span class="hljs-string">'string'</span>){
      options.adapter = [options.adapter];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-106">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-106">&#182;</a>
              </div>
              <p>iterates over the array of passed adapters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>, k = options.adapter.length; j &lt; k; j++){</pre></div></div>
            
        </li>
        
        
        <li id="section-107">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-107">&#182;</a>
              </div>
              <p>itirates over the array of available adapters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = Lawnchair.adapters.length-<span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
        <span class="hljs-keyword">if</span> (Lawnchair.adapters[i].adapter === options.adapter[j]) {
          adapter = Lawnchair.adapters[i].valid() ? Lawnchair.adapters[i] : <span class="hljs-literal">undefined</span>;
          <span class="hljs-keyword">if</span> (adapter) <span class="hljs-keyword">break</span>
        }
      }
      <span class="hljs-keyword">if</span> (adapter) <span class="hljs-keyword">break</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-108">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-108">&#182;</a>
              </div>
              <p>otherwise find the first valid adapter for this env</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
  <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = Lawnchair.adapters.length; i &lt; l; i++) {
      adapter = Lawnchair.adapters[i].valid() ? Lawnchair.adapters[i] : <span class="hljs-literal">undefined</span>
      <span class="hljs-keyword">if</span> (adapter) <span class="hljs-keyword">break</span>
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-109">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-109">&#182;</a>
              </div>
              <p>we have failed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!adapter) <span class="hljs-keyword">throw</span> <span class="hljs-string">'No valid adapter.'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-110">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-110">&#182;</a>
              </div>
              <p>yay! mixin the adapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j <span class="hljs-keyword">in</span> adapter)
    <span class="hljs-keyword">this</span>[j] = adapter[j]</pre></div></div>
            
        </li>
        
        
        <li id="section-111">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-111">&#182;</a>
              </div>
              <p>call init for each mixed in plugin</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = Lawnchair.plugins.length; i &lt; l; i++)
    Lawnchair.plugins[i].call(<span class="hljs-keyword">this</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-112">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-112">&#182;</a>
              </div>
              <p>init the adapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.init(options, callback)
}

Lawnchair.adapters = []

<span class="hljs-comment">/**
 * queues an adapter for mixin
 * ===
 * - ensures an adapter conforms to a specific interface
 *
 */</span>
Lawnchair.adapter = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id, obj)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-113">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-113">&#182;</a>
              </div>
              <p>add the adapter id to the adapter obj
ugly here for a  cleaner dsl for implementing adapters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  obj[<span class="hljs-string">'adapter'</span>] = id</pre></div></div>
            
        </li>
        
        
        <li id="section-114">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-114">&#182;</a>
              </div>
              <p>methods required to implement a lawnchair adapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> implementing = <span class="hljs-string">'adapter valid init keys save batch get exists all remove nuke'</span>.split(<span class="hljs-string">' '</span>)
    ,   indexOf = <span class="hljs-keyword">this</span>.prototype.indexOf</pre></div></div>
            
        </li>
        
        
        <li id="section-115">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-115">&#182;</a>
              </div>
              <p>mix in the adapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> obj) {
    <span class="hljs-keyword">if</span> (indexOf(implementing, i) === -<span class="hljs-number">1</span>) <span class="hljs-keyword">throw</span> <span class="hljs-string">'Invalid adapter! Nonstandard method: '</span> + i
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-116">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-116">&#182;</a>
              </div>
              <p>if we made it this far the adapter interface is valid
insert the new adapter as the preferred adapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  Lawnchair.adapters.splice(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,obj)
}

Lawnchair.plugins = []

<span class="hljs-comment">/**
 * generic shallow extension for plugins
 * ===
 * - if an init method is found it registers it to be called when the lawnchair is inited
 * - yes we could use hasOwnProp but nobody here is an asshole
 */</span>
Lawnchair.plugin = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj)</span> {</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> obj)
    i === <span class="hljs-string">'init'</span> ? Lawnchair.plugins.push(obj[i]) : <span class="hljs-keyword">this</span>.prototype[i] = obj[i]
}

<span class="hljs-comment">/**
 * helpers
 *
 */</span>
Lawnchair.prototype = {

  isArray: <span class="hljs-built_in">Array</span>.isArray || <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span> {</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.toString.call(o) === <span class="hljs-string">'[object Array]'</span> },

  <span class="hljs-comment">/**
   * this code exists for ie8... for more background see:
   * http://www.flickr.com/photos/westcoastlogic/5955365742/in/photostream
   */</span>
  indexOf: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ary, item, i, l)</span> {</span>
    <span class="hljs-keyword">if</span> (ary.indexOf) <span class="hljs-keyword">return</span> ary.indexOf(item)
    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = ary.length; i &lt; l; i++) <span class="hljs-keyword">if</span> (ary[i] === item) <span class="hljs-keyword">return</span> i
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-117">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-117">&#182;</a>
              </div>
              <p>awesome shorthand callbacks as strings. this is shameless theft from dojo.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  lambda: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.fn(<span class="hljs-keyword">this</span>.record, callback)
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-118">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-118">&#182;</a>
              </div>
              <p>first stab at named parameters for terse callbacks; dojo: first != best // ;D</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  fn: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, callback)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> callback == <span class="hljs-string">'string'</span> ? <span class="hljs-keyword">new</span> <span class="hljs-built_in">Function</span>(name, callback) : callback
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-119">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-119">&#182;</a>
              </div>
              <p>returns a unique identifier (by way of Backbone.localStorage.js)
TODO investigate smaller UUIDs to cut on storage cost</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  uuid: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> S4 = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">return</span> (((<span class="hljs-number">1</span>+<span class="hljs-built_in">Math</span>.random())*<span class="hljs-number">0x10000</span>)|<span class="hljs-number">0</span>).toString(<span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>);
    }
    <span class="hljs-keyword">return</span> (S4()+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+<span class="hljs-string">"-"</span>+S4()+S4()+S4());
  },</pre></div></div>
            
        </li>
        
        
        <li id="section-120">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-120">&#182;</a>
              </div>
              <p>a classic iterator</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  each: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">var</span> cb = <span class="hljs-keyword">this</span>.lambda(callback)</pre></div></div>
            
        </li>
        
        
        <li id="section-121">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-121">&#182;</a>
              </div>
              <p>iterate from chain</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.__results) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">this</span>.__results.length; i &lt; l; i++) cb.call(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.__results[i], i)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-122">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-122">&#182;</a>
              </div>
              <p>otherwise iterate the entire collection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">this</span>.all(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r)</span> {</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = r.length; i &lt; l; i++) cb.call(<span class="hljs-keyword">this</span>, r[i], i)
      })
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-123">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-123">&#182;</a>
              </div>
              <p>—</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>};

<span class="hljs-comment">/**
 * Expose nodeJS module
 */</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> module !== <span class="hljs-string">'undefined'</span> &amp;&amp; module.exports) {
  module.exports = Lawnchair;
}

<span class="hljs-comment">/**
 * indexed db adapter
 * ===
 * - originally authored by Vivian Li
 *
 */</span>
Lawnchair.adapter(<span class="hljs-string">'indexed-db'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fail</span><span class="hljs-params">(e, i)</span> {</span> console.error(<span class="hljs-string">'error in indexed-db adapter!'</span>, e, i); }</pre></div></div>
            
        </li>
        
        
        <li id="section-124">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-124">&#182;</a>
              </div>
              <p>update the STORE_VERSION when the schema used by this adapter changes
(for example, if you change the STORE_NAME above)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> STORE_VERSION = <span class="hljs-number">3</span>;

  <span class="hljs-keyword">var</span> getIDB = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> window.indexedDB || window.webkitIndexedDB || window.mozIndexedDB || window.oIndexedDB || window.msIndexedDB;
  };
  <span class="hljs-keyword">var</span> getIDBTransaction = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> window.IDBTransaction || window.webkitIDBTransaction ||
      window.mozIDBTransaction || window.oIDBTransaction ||
      window.msIDBTransaction;
  };
  <span class="hljs-keyword">var</span> getIDBKeyRange = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> window.IDBKeyRange || window.webkitIDBKeyRange ||
      window.mozIDBKeyRange || window.oIDBKeyRange ||
      window.msIDBKeyRange;
  };
  <span class="hljs-keyword">var</span> getIDBDatabaseException = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">return</span> window.IDBDatabaseException || window.webkitIDBDatabaseException ||
      window.mozIDBDatabaseException || window.oIDBDatabaseException ||
      window.msIDBDatabaseException;
  };
  <span class="hljs-keyword">var</span> useAutoIncrement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-125">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-125">&#182;</a>
              </div>
              <p>using preliminary mozilla implementation which doesn’t support
auto-generated keys.  Neither do some webkit implementations.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> !!window.indexedDB;
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-126">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-126">&#182;</a>
              </div>
              <p>see <a href="https://groups.google.com/a/chromium.org/forum/?fromgroups#!topic/chromium-html5/OhsoAQLj7kc">https://groups.google.com/a/chromium.org/forum/?fromgroups#!topic/chromium-html5/OhsoAQLj7kc</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> READ_WRITE = (getIDBTransaction() &amp;&amp;
    <span class="hljs-string">'READ_WRITE'</span> <span class="hljs-keyword">in</span> getIDBTransaction()) ?
    getIDBTransaction().READ_WRITE : <span class="hljs-string">'readwrite'</span>;

  <span class="hljs-keyword">return</span> {

    valid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> !!getIDB(); },

    init:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(options, callback)</span> {</span>
      <span class="hljs-keyword">this</span>.idb = getIDB();
      <span class="hljs-keyword">this</span>.waiting = [];
      <span class="hljs-keyword">this</span>.useAutoIncrement = useAutoIncrement();
      <span class="hljs-keyword">var</span> request = <span class="hljs-keyword">this</span>.idb.open(<span class="hljs-keyword">this</span>.name, STORE_VERSION);
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> cb = self.fn(self.name, callback);
      <span class="hljs-keyword">if</span> (cb &amp;&amp; <span class="hljs-keyword">typeof</span> cb != <span class="hljs-string">'function'</span>) <span class="hljs-keyword">throw</span> <span class="hljs-string">'callback not valid'</span>;
      <span class="hljs-keyword">var</span> win = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-127">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-127">&#182;</a>
              </div>
              <p>manually clean up event handlers on request; this helps on chrome</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        request.onupgradeneeded = request.onsuccess = request.error = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span>(cb) <span class="hljs-keyword">return</span> cb.call(self, self);
      };

      <span class="hljs-keyword">var</span> upgrade = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(from, to)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-128">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-128">&#182;</a>
              </div>
              <p>don’t try to migrate dbs, just recreate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">try</span> {
          self.db.deleteObjectStore(<span class="hljs-string">'teststore'</span>); <span class="hljs-comment">// old adapter</span>
        } <span class="hljs-keyword">catch</span> (e1) { <span class="hljs-comment">/* ignore */</span> }
        <span class="hljs-keyword">try</span> {
          self.db.deleteObjectStore(self.record);
        } <span class="hljs-keyword">catch</span> (e2) { <span class="hljs-comment">/* ignore */</span> }</pre></div></div>
            
        </li>
        
        
        <li id="section-129">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-129">&#182;</a>
              </div>
              <p>ok, create object store.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> params = {};
        <span class="hljs-keyword">if</span> (self.useAutoIncrement) { params.autoIncrement = <span class="hljs-literal">true</span>; }
        self.db.createObjectStore(self.record, params);
        self.store = <span class="hljs-literal">true</span>;
      };
      request.onupgradeneeded = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        self.db = request.result;
        self.transaction = request.transaction;
        upgrade(event.oldVersion, event.newVersion);</pre></div></div>
            
        </li>
        
        
        <li id="section-130">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-130">&#182;</a>
              </div>
              <p>will end up in onsuccess callback</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      };
      request.onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        self.db = event.target.result;

        <span class="hljs-keyword">if</span>(self.db.version != (<span class="hljs-string">''</span>+STORE_VERSION)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-131">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-131">&#182;</a>
              </div>
              <p>DEPRECATED API: modern implementations will fire the
upgradeneeded event instead.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> oldVersion = self.db.version;
          <span class="hljs-keyword">var</span> setVrequest = self.db.setVersion(<span class="hljs-string">''</span>+STORE_VERSION);</pre></div></div>
            
        </li>
        
        
        <li id="section-132">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-132">&#182;</a>
              </div>
              <p>onsuccess is the only place we can create Object Stores</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          setVrequest.onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
            <span class="hljs-keyword">var</span> transaction = setVrequest.result;
            setVrequest.onsuccess = setVrequest.onerror = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-133">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-133">&#182;</a>
              </div>
              <p>can’t upgrade w/o versionchange transaction.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            upgrade(oldVersion, STORE_VERSION);
            transaction.oncomplete = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; self.waiting.length; i++) {
                self.waiting[i].call(self);
              }
              self.waiting = [];
              win();
            };
          };
          setVrequest.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span> {</span>
            setVrequest.onsuccess = setVrequest.onerror = <span class="hljs-literal">null</span>;
            console.error(<span class="hljs-string">"Failed to create objectstore "</span> + e);
            fail(e);
          };
        } <span class="hljs-keyword">else</span> {
          self.store = <span class="hljs-literal">true</span>;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; self.waiting.length; i++) {
            self.waiting[i].call(self);
          }
          self.waiting = [];
          win();
        }
      }
      request.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(ev)</span> {</span>
        <span class="hljs-keyword">if</span> ( getIDBDatabaseException() &amp;&amp; 
          request.errorCode === getIDBDatabaseException().VERSION_ERR) {</pre></div></div>
            
        </li>
        
        
        <li id="section-134">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-134">&#182;</a>
              </div>
              <p>xxx blow it away</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          self.idb.deleteDatabase(self.name);</pre></div></div>
            
        </li>
        
        
        <li id="section-135">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-135">&#182;</a>
              </div>
              <p>try it again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">return</span> self.init(options, callback);
        }
        console.error(<span class="hljs-string">'Failed to open database'</span>);
      };
    },

    save:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj, callback)</span> {</span>
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.store) {
        <span class="hljs-keyword">this</span>.waiting.push(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.save(obj, callback);
        });
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">var</span> objs = (<span class="hljs-keyword">this</span>.isArray(obj) ? obj : [obj]).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span>{</span><span class="hljs-keyword">if</span>(!o.key) { o.key = self.uuid()} <span class="hljs-keyword">return</span> o})

      <span class="hljs-keyword">var</span> win  = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
        <span class="hljs-keyword">if</span> (callback) { self.lambda(callback).call(self, self.isArray(obj) ? objs : objs[<span class="hljs-number">0</span>] ) }
      };

      <span class="hljs-keyword">var</span> trans = <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-keyword">this</span>.record, READ_WRITE);
      <span class="hljs-keyword">var</span> store = trans.objectStore(<span class="hljs-keyword">this</span>.record);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; objs.length; i++) {
        <span class="hljs-keyword">var</span> o = objs[i];
        store.put(o, o.key);
      }
      store.transaction.oncomplete = win;
      store.transaction.onabort = fail;

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    batch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(objs, callback)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save(objs, callback);
    },


    get:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, callback)</span> {</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.store) {
        <span class="hljs-keyword">this</span>.waiting.push(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.get(key, callback);
        });
        <span class="hljs-keyword">return</span>;
      }


      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> win  = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
        <span class="hljs-keyword">var</span> r = e.target.result;
        <span class="hljs-keyword">if</span> (callback) {
          <span class="hljs-keyword">if</span> (r) { r.key = key; }
          self.lambda(callback).call(self, r);
        }
      };

      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isArray(key)){
        <span class="hljs-keyword">var</span> req = <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-keyword">this</span>.record).objectStore(<span class="hljs-keyword">this</span>.record).get(key);

        req.onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
          req.onsuccess = req.onerror = <span class="hljs-literal">null</span>;
          win(event);
        };
        req.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
          req.onsuccess = req.onerror = <span class="hljs-literal">null</span>;
          fail(event);
        };

      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-136">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-136">&#182;</a>
              </div>
              <p>note: these are hosted.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> results = []
          ,   done = key.length
          ,   keys = key

        <span class="hljs-keyword">var</span> getOne = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(i)</span> {</span>
          self.get(keys[i], <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
            results[i] = obj;
            <span class="hljs-keyword">if</span> ((--done) &gt; <span class="hljs-number">0</span>) { <span class="hljs-keyword">return</span>; }
            <span class="hljs-keyword">if</span> (callback) {
              self.lambda(callback).call(self, results);
            }
          });
        };
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = keys.length; i &lt; l; i++)
          getOne(i);
      }

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    exists:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key, callback)</span> {</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.store) {
        <span class="hljs-keyword">this</span>.waiting.push(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.exists(key, callback);
        });
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

      <span class="hljs-keyword">var</span> req = <span class="hljs-keyword">this</span>.db.transaction(self.record).objectStore(<span class="hljs-keyword">this</span>.record).openCursor(getIDBKeyRange().only(key));

      req.onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        req.onsuccess = req.onerror = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-137">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-137">&#182;</a>
              </div>
              <p>exists iff req.result is not null
XXX but firefox returns undefined instead, sigh XXX</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> undef;
        self.lambda(callback).call(self, event.target.result !== <span class="hljs-literal">null</span> &amp;&amp;
          event.target.result !== undef);
      };
      req.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        req.onsuccess = req.onerror = <span class="hljs-literal">null</span>;
        fail(event);
      };

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    all:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.store) {
        <span class="hljs-keyword">this</span>.waiting.push(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.all(callback);
        });
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">var</span> cb = <span class="hljs-keyword">this</span>.fn(<span class="hljs-keyword">this</span>.name, callback) || <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> objectStore = <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-keyword">this</span>.record).objectStore(<span class="hljs-keyword">this</span>.record);
      <span class="hljs-keyword">var</span> toReturn = [];
      objectStore.openCursor().onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        <span class="hljs-keyword">var</span> cursor = event.target.result;
        <span class="hljs-keyword">if</span> (cursor) {
          toReturn.push(cursor.value);
          cursor[<span class="hljs-string">'continue'</span>]();
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (cb) cb.call(self, toReturn);
        }
      };
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    keys:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.store) {
        <span class="hljs-keyword">this</span>.waiting.push(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.keys(callback);
        });
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">var</span> cb = <span class="hljs-keyword">this</span>.fn(<span class="hljs-keyword">this</span>.name, callback) || <span class="hljs-literal">undefined</span>;
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
      <span class="hljs-keyword">var</span> objectStore = <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-keyword">this</span>.record).objectStore(<span class="hljs-keyword">this</span>.record);
      <span class="hljs-keyword">var</span> toReturn = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-138">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-138">&#182;</a>
              </div>
              <p>in theory we could use openKeyCursor() here, but no one actually
supports it yet.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      objectStore.openCursor().onsuccess = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        <span class="hljs-keyword">var</span> cursor = event.target.result;
        <span class="hljs-keyword">if</span> (cursor) {
          toReturn.push(cursor.key);
          cursor[<span class="hljs-string">'continue'</span>]();
        }
        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">if</span> (cb) cb.call(self, toReturn);
        }
      };
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    remove:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(keyOrArray, callback)</span> {</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.store) {
        <span class="hljs-keyword">this</span>.waiting.push(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.remove(keyOrArray, callback);
        });
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;

      <span class="hljs-keyword">var</span> toDelete = keyOrArray;
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isArray(keyOrArray)) {
        toDelete=[keyOrArray];
      }


      <span class="hljs-keyword">var</span> win = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        <span class="hljs-keyword">if</span> (callback) self.lambda(callback).call(self)
      };

      <span class="hljs-keyword">var</span> os = <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-keyword">this</span>.record, READ_WRITE).objectStore(<span class="hljs-keyword">this</span>.record);

      <span class="hljs-keyword">var</span> key = keyOrArray.key ? keyOrArray.key : keyOrArray;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; toDelete.length; i++) {
        <span class="hljs-keyword">var</span> key = toDelete[i].key ? toDelete[i].key : toDelete[i];
        os[<span class="hljs-string">'delete'</span>](key);
      };

      os.transaction.oncomplete = win;
      os.transaction.onabort = fail;

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    nuke:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> {</span>
      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.store) {
        <span class="hljs-keyword">this</span>.waiting.push(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">this</span>.nuke(callback);
        });
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>
        ,   win  = callback ? <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> self.lambda(callback).call(self) } : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>};

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> os = <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-keyword">this</span>.record, READ_WRITE).objectStore(<span class="hljs-keyword">this</span>.record);
        os.clear();
        os.transaction.oncomplete = win;
        os.transaction.onabort = fail;
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-keyword">if</span> (e.name==<span class="hljs-string">'NotFoundError'</span>)
          win()
        <span class="hljs-keyword">else</span>
          fail(e);
      }
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

  };

})());
Lawnchair.adapter(<span class="hljs-string">'webkit-sqlite'</span>, (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-139">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-139">&#182;</a>
              </div>
              <p>private methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> fail = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e, i)</span> {</span> console.error(<span class="hljs-string">'error in sqlite adaptor!'</span>, e, i) }
    ,   now  = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() } <span class="hljs-comment">// FIXME need to use better date fn</span></pre></div></div>
            
        </li>
        
        
        <li id="section-140">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-140">&#182;</a>
              </div>
              <p>not entirely sure if this is needed…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Function</span>.prototype.bind) {
    <span class="hljs-built_in">Function</span>.prototype.bind = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( obj )</span> {</span>
      <span class="hljs-keyword">var</span> slice = [].slice
        ,   args  = slice.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)
        ,   self  = <span class="hljs-keyword">this</span>
        ,   nop   = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>}
        ,   bound = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
          <span class="hljs-keyword">return</span> self.apply(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> nop ? <span class="hljs-keyword">this</span> : (obj || {}), args.concat(slice.call(<span class="hljs-built_in">arguments</span>)))
        }
      nop.prototype   = self.prototype
      bound.prototype = <span class="hljs-keyword">new</span> nop()
      <span class="hljs-keyword">return</span> bound
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-141">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-141">&#182;</a>
              </div>
              <p>public methods</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> {

    valid: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> <span class="hljs-keyword">return</span> !!(window.openDatabase) },

    init: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options, callback)</span> {</span>
      <span class="hljs-keyword">var</span> that   = <span class="hljs-keyword">this</span>
        ,   cb     = that.fn(that.name, callback)
        ,   create = <span class="hljs-string">"CREATE TABLE IF NOT EXISTS "</span> + <span class="hljs-keyword">this</span>.record + <span class="hljs-string">" (id NVARCHAR(32) UNIQUE PRIMARY KEY, value TEXT, timestamp REAL)"</span>
        ,   win    = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span> <span class="hljs-keyword">if</span>(cb) <span class="hljs-keyword">return</span> cb.call(that, that); }

      <span class="hljs-keyword">if</span> (cb &amp;&amp; <span class="hljs-keyword">typeof</span> cb != <span class="hljs-string">'function'</span>) <span class="hljs-keyword">throw</span> <span class="hljs-string">'callback not valid'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-142">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-142">&#182;</a>
              </div>
              <p>open a connection and create the db if it doesn’t exist</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.db = openDatabase(<span class="hljs-keyword">this</span>.name, <span class="hljs-string">'1.0.0'</span>, <span class="hljs-keyword">this</span>.name, options.maxSize || <span class="hljs-number">65536</span> )
      <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> {</span>
        t.executeSql(create, [])
      }, fail, win)
    },

    keys:  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
      <span class="hljs-keyword">var</span> cb   = <span class="hljs-keyword">this</span>.lambda(callback)
        ,   that = <span class="hljs-keyword">this</span>
        ,   keys = <span class="hljs-string">"SELECT id FROM "</span> + <span class="hljs-keyword">this</span>.record + <span class="hljs-string">" ORDER BY timestamp DESC"</span>

      <span class="hljs-keyword">this</span>.db.readTransaction(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> {</span>
        <span class="hljs-keyword">var</span> win = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(xxx, results)</span> {</span>
          <span class="hljs-keyword">if</span> (results.rows.length == <span class="hljs-number">0</span> ) {
            cb.call(that, [])
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">var</span> r = [];
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = results.rows.length; i &lt; l; i++) {
              r.push(results.rows.item(i).id);
            }
            cb.call(that, r)
          }
        }
        t.executeSql(keys, [], win, fail)
      })
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    },</pre></div></div>
            
        </li>
        
        
        <li id="section-143">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-143">&#182;</a>
              </div>
              <p>you think thats air you’re breathing now?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    save: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(obj, callback, error)</span> {</span>
      <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>
        ,   objs = (<span class="hljs-keyword">this</span>.isArray(obj) ? obj : [obj]).map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(o)</span>{</span><span class="hljs-keyword">if</span>(!o.key) { o.key = that.uuid()} <span class="hljs-keyword">return</span> o})
        ,   ins  = <span class="hljs-string">"INSERT OR REPLACE INTO "</span> + <span class="hljs-keyword">this</span>.record + <span class="hljs-string">" (value, timestamp, id) VALUES (?,?,?)"</span>
        ,   win  = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span> <span class="hljs-keyword">if</span> (callback) { that.lambda(callback).call(that, that.isArray(obj)?objs:objs[<span class="hljs-number">0</span>]) }}
        ,   error= error || <span class="hljs-literal">null</span>
        ,   insvals = []
        ,   ts = now()

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = objs.length; i &lt; l; i++) {
          insvals[i] = [<span class="hljs-built_in">JSON</span>.stringify(objs[i]), ts, objs[i].key];
        }
      } <span class="hljs-keyword">catch</span> (e) {
        (error)? error(e) : fail(e);
        <span class="hljs-keyword">throw</span> e;
      }

      that.db.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span> {</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = objs.length; i &lt; l; i++)
          t.executeSql(ins, insvals[i])
      }, (error)? error : fail, win)

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    },


    batch: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(objs, callback)</span> {</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.save(objs, callback)
    },

    get: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(keyOrArray, cb)</span> {</span>
      <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>
        ,   sql  = <span class="hljs-string">''</span>
        ,   args = <span class="hljs-keyword">this</span>.isArray(keyOrArray) ? keyOrArray : [keyOrArray];</pre></div></div>
            
        </li>
        
        
        <li id="section-144">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-144">&#182;</a>
              </div>
              <p>batch selects support</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      sql = <span class="hljs-string">'SELECT id, value FROM '</span> + <span class="hljs-keyword">this</span>.record + <span class="hljs-string">" WHERE id IN ("</span> +
        args.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span><span class="hljs-keyword">return</span> <span class="hljs-string">'?'</span>}).join(<span class="hljs-string">","</span>) + <span class="hljs-string">")"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-145">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-145">&#182;</a>
              </div>
              <p>FIXME
will always loop the results but cleans it up if not a batch return at the end..
in other words, this could be faster</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> win = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(xxx, results)</span> {</span>
        <span class="hljs-keyword">var</span> o
          ,   r
          ,   lookup = {}</pre></div></div>
            
        </li>
        
        
        <li id="section-146">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-146">&#182;</a>
              </div>
              <p>map from results to keys</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = results.rows.length; i &lt; l; i++) {
          o = <span class="hljs-built_in">JSON</span>.parse(results.rows.item(i).value)
          o.key = results.rows.item(i).id
          lookup[o.key] = o;
        }
        r = args.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span> {</span> <span class="hljs-keyword">return</span> lookup[key]; });
        <span class="hljs-keyword">if</span> (!that.isArray(keyOrArray)) r = r.length ? r[<span class="hljs-number">0</span>] : <span class="hljs-literal">null</span>
        <span class="hljs-keyword">if</span> (cb) that.lambda(cb).call(that, r)
      }
      <span class="hljs-keyword">this</span>.db.readTransaction(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span>{</span> t.executeSql(sql, args, win, fail) })
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    },

    exists: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, cb)</span> {</span>
      <span class="hljs-keyword">var</span> is = <span class="hljs-string">"SELECT * FROM "</span> + <span class="hljs-keyword">this</span>.record + <span class="hljs-string">" WHERE id = ?"</span>
        ,   that = <span class="hljs-keyword">this</span>
        ,   win = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(xxx, results)</span> {</span> <span class="hljs-keyword">if</span> (cb) that.fn(<span class="hljs-string">'exists'</span>, cb).call(that, (results.rows.length &gt; <span class="hljs-number">0</span>)) }
      <span class="hljs-keyword">this</span>.db.readTransaction(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(t)</span>{</span> t.executeSql(is, [key], win, fail) })
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    },

    all: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
      <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>
        ,   all  = <span class="hljs-string">"SELECT * FROM "</span> + <span class="hljs-keyword">this</span>.record
        ,   r    = []
        ,   cb   = <span class="hljs-keyword">this</span>.fn(<span class="hljs-keyword">this</span>.name, callback) || <span class="hljs-literal">undefined</span>
        ,   win  = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(xxx, results)</span> {</span>
          <span class="hljs-keyword">if</span> (results.rows.length != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = results.rows.length; i &lt; l; i++) {
              <span class="hljs-keyword">var</span> obj = <span class="hljs-built_in">JSON</span>.parse(results.rows.item(i).value)
              obj.key = results.rows.item(i).id
              r.push(obj)
            }
          }
          <span class="hljs-keyword">if</span> (cb) cb.call(that, r)
        }

      <span class="hljs-keyword">this</span>.db.readTransaction(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> {</span>
        t.executeSql(all, [], win, fail)
      })
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    },

    remove: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(keyOrArray, cb)</span> {</span>
      <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>
        ,   args
        ,   sql  = <span class="hljs-string">"DELETE FROM "</span> + <span class="hljs-keyword">this</span>.record + <span class="hljs-string">" WHERE id "</span>
        ,   win  = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span> <span class="hljs-keyword">if</span> (cb) that.lambda(cb).call(that) }
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isArray(keyOrArray)) {
        sql += <span class="hljs-string">'= ?'</span>;
        args = [keyOrArray];
      } <span class="hljs-keyword">else</span> {
        args = keyOrArray;
        sql += <span class="hljs-string">"IN ("</span> +
          args.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span><span class="hljs-keyword">return</span> <span class="hljs-string">'?'</span>}).join(<span class="hljs-string">','</span>) +
          <span class="hljs-string">")"</span>;
      }
      args = args.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> {</span>
        <span class="hljs-keyword">return</span> obj.key ? obj.key : obj;
      });

      <span class="hljs-keyword">this</span>.db.transaction( <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> {</span>
        t.executeSql(sql, args, win, fail);
      });

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    },

    nuke: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cb)</span> {</span>
      <span class="hljs-keyword">var</span> nuke = <span class="hljs-string">"DELETE FROM "</span> + <span class="hljs-keyword">this</span>.record
        ,   that = <span class="hljs-keyword">this</span>
        ,   win  = cb ? <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span> that.lambda(cb).call(that) } : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>}
      <span class="hljs-keyword">this</span>.db.transaction(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(t)</span> {</span>
        t.executeSql(nuke, [], win, fail)
      })
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-147">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-147">&#182;</a>
              </div>
              <p>////</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }})());</pre></div></div>
            
        </li>
        
        
        <li id="section-148">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-148">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-149">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-149">&#182;</a>
              </div>
              
            </div>
            
        </li>
        
        
        <li id="section-150">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-150">&#182;</a>
              </div>
              <p>FROM: <a href="http://stackoverflow.com/questions/979975/how-to-get-the-value-from-url-parameter">http://stackoverflow.com/questions/979975/how-to-get-the-value-from-url-parameter</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> getQueryParams = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( qs )</span>{</span>
  qs = qs.split( <span class="hljs-string">"+"</span> ).join( <span class="hljs-string">" "</span> );

  <span class="hljs-keyword">var</span> params = {}, tokens,
    re = <span class="hljs-regexp">/[?&amp;]?([^=]+)=([^&amp;]*)/g</span>;

  <span class="hljs-keyword">while</span>(tokens = re.exec( qs )) {
    params[<span class="hljs-built_in">decodeURIComponent</span>( tokens[<span class="hljs-number">1</span>] )]
      = <span class="hljs-built_in">decodeURIComponent</span>( tokens[<span class="hljs-number">2</span>] );
  }

  <span class="hljs-keyword">return</span> params;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-151">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-151">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-152">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-152">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> callAsSequence = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(fns, callback)</span> {</span>
  <span class="hljs-keyword">if</span> (fns.length === <span class="hljs-number">0</span>){
    <span class="hljs-keyword">if</span>( callback ) <span class="hljs-keyword">return</span> callback();
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">var</span> completed = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> cbFn = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(results)</span> {</span>
    <span class="hljs-keyword">if</span> (++completed == fns.length) {
      <span class="hljs-keyword">if</span> (callback) {
        callback();
      }
    } <span class="hljs-keyword">else</span> {
      iterate();
    }
  };

  <span class="hljs-keyword">var</span> iterate = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
    fns[completed](cbFn);
  };

  iterate();
};</pre></div></div>
            
        </li>
        
        
        <li id="section-153">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-153">&#182;</a>
              </div>
              <p>===================================================================================================</p>

            </div>
            
        </li>
        
        
        <li id="section-154">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-154">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

  <span class="hljs-keyword">var</span> xmlHttpReq;
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">new</span> XMLHttpRequest();
    xmlHttpReq = <span class="hljs-literal">true</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-155">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-155">&#182;</a>
              </div>
              <p>FALL BACK</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">catch</span> (ex) {
    xmlHttpReq = <span class="hljs-literal">false</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reqListener</span><span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.readyState == <span class="hljs-number">4</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-156">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-156">&#182;</a>
              </div>
              <p>FINE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.readyState == <span class="hljs-number">4</span> &amp;&amp; <span class="hljs-keyword">this</span>.status == <span class="hljs-number">200</span>) {
        console.log(<span class="hljs-string">"grabbed file successfully"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-157">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-157">&#182;</a>
              </div>
              <p>JSON OBJECT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.asJSON) {
          <span class="hljs-keyword">var</span> arg;
          <span class="hljs-keyword">try</span> {
            arg = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-keyword">this</span>.responseText);
          }</pre></div></div>
            
        </li>
        
        
        <li id="section-158">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-158">&#182;</a>
              </div>
              <p>FAILED TO CONVERT JSON TEXT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-keyword">this</span>.failCallback(e);
          }
          <span class="hljs-keyword">this</span>.winCallback(arg);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-159">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-159">&#182;</a>
              </div>
              <p>PLAIN TEXT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">this</span>.winCallback(<span class="hljs-keyword">this</span>.responseText);
        }
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-160">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-160">&#182;</a>
              </div>
              <p>ERROR</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">else</span> {
        console.log(<span class="hljs-string">"could not grab file"</span>);
        <span class="hljs-keyword">this</span>.failCallback(<span class="hljs-keyword">this</span>.statusText);
      }
    }
  }

  window.grabRemoteFile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(options)</span> {</span>
    <span class="hljs-keyword">var</span> oReq;

    console.log(<span class="hljs-string">"try to grab file "</span>+options.path);</pre></div></div>
            
        </li>
        
        
        <li id="section-161">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-161">&#182;</a>
              </div>
              <p>GENERATE REQUEST OBJECT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (xmlHttpReq) oReq = <span class="hljs-keyword">new</span> XMLHttpRequest();
    <span class="hljs-keyword">else</span> oReq = <span class="hljs-keyword">new</span> ActiveXObject(<span class="hljs-string">"Microsoft.XMLHTTP"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-162">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-162">&#182;</a>
              </div>
              <p>WIN / FAIL CALLBACK</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    oReq.asJSON = options.json;
    oReq.winCallback = options.success;
    oReq.failCallback = options.error;</pre></div></div>
            
        </li>
        
        
        <li id="section-163">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-163">&#182;</a>
              </div>
              <p>META DATA</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    oReq.onreadystatechange = reqListener;
    oReq.open(<span class="hljs-string">"get"</span>, options.path+<span class="hljs-string">"?_cwtR="</span>+<span class="hljs-built_in">parseInt</span>(<span class="hljs-number">10000</span>*<span class="hljs-built_in">Math</span>.random(),<span class="hljs-number">10</span>), <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-164">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-164">&#182;</a>
              </div>
              <p>SEND IT</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    oReq.send();
  }
})();</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>