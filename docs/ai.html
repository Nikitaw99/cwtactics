<!DOCTYPE html>

<html>
<head>
  <title>ai.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="doc.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ai.html">
                  ai.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="commands.html">
                  commands.js
                </a>
              
                
                <a class="source" href="controller.html">
                  controller.js
                </a>
              
                
                <a class="source" href="datatypes.html">
                  datatypes.js
                </a>
              
                
                <a class="source" href="dependencies.html">
                  dependencies.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="input.html">
                  input.js
                </a>
              
                
                <a class="source" href="language.html">
                  language.js
                </a>
              
                
                <a class="source" href="loading.html">
                  loading.js
                </a>
              
                
                <a class="source" href="logic.html">
                  logic.js
                </a>
              
                
                <a class="source" href="model.html">
                  model.js
                </a>
              
                
                <a class="source" href="modification.html">
                  modification.js
                </a>
              
                
                <a class="source" href="renderer.html">
                  renderer.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>ai.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>DumbBoy (DB) is the old forgotten AI from MiniWars. We will resurrected him for Custom Wars: Tactics.
Our target is to build a first version of a dynamic AI that can change it’s tasks at runtime
in relation to the situation on the battlefield. DumbBoy won’t be a next super gen AI. This
is not our task ( we wouldn’t have enough time to do this… to be true :P ). It should be more
a concept of a clean designed AI that can be extended by different people. That’s why DumbBoy gets
a clean design instead of hacky code.</p>
<p><strong>TASKS 0.10: DO SOMETHING ON THE BATTLEFIELD (v. 0.3.5)</strong></p>
<ul>
<li>DB builds objects on his properties</li>
<li>Capturers try to capture properties or move near to them</li>
<li>DB attacks with units in range</li>
</ul>
<p><strong>TASKS 0.25: DO SOMETHING MORE (v. 0.3.6)</strong></p>
<ul>
<li>DB builds objects on his properties</li>
<li>When neutral properties are left on the map then DB will
build at least one capturer unit</li>
<li>DB tries to fulfill a percentage (AIR,VS,TANKS etc.)</li>
<li>Damaged units (&lt;=5HP) may move back to properties for repair</li>
<li>Units move to the enemy players</li>
<li>Capturers try to capture properties or move near to them</li>
<li>DB attacks with units in range</li>
<li>DB tries to position indirect units</li>
<li><em>Actions:</em> Wait,Move,Capture,End_Turn,Build_Unit,Attack,Join</li>
</ul>
<p><strong>TASKS 0.5: BEING DYNAMIC AND LESS CALCULATE ABLE (v. 0.4)</strong></p>
<ul>
<li>DB should define long term tasks for himself to organize his actions
to fulfill this tasks (AGGRESIVE,DEFENSIVE,MONEY,PRESSING,SPAMMING)</li>
<li>DB can ignore long term tasks to handle difficult situations dynamical</li>
<li>Long term tasks changes during game play (maybe re-analyse it every 5 days)</li>
<li>DB should analyse the objects that a player owns and uses to
counter play it (without cheating through the fog)</li>
<li>DB uses CO powers and mechanic</li>
<li><em>Actions:</em> Activate_Power,Fire_Cannon,Fire_Laser,At/Detach Commander,Transfer XYZ,</li>
</ul>
<p><strong>TASKS 0.75: ANALYSE YOUR ENEMIES (v. 0.5)</strong></p>
<ul>
<li>DB should use transports to reach far away properties</li>
<li><em>Actions:</em> Hide/Unhide,Supply,Load/Unload,Suicide_Bomb</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/*

controller.ai_spec = AI_VERSION;

</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Some base scores.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_SCORE = {
  LOW      : <span class="hljs-number">100</span>,
  NORMAL   : <span class="hljs-number">200</span>,
  HIGH     : <span class="hljs-number">300</span>,
  CRITICAL : <span class="hljs-number">999</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Contains all check_/action logics for the DumbBoy ai.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_CHECKS = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The memory of the ai. Holds different aw2 of the game state for all ai controlled
player instances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_data = util.list( MAX_PLAYER, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
  <span class="hljs-keyword">return</span> {
    pid: cwt.INACTIVE
  };
});</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_loopHolder_ = {
  i    : -<span class="hljs-number">1</span>,
  e    : -<span class="hljs-number">1</span>,
  prop : -<span class="hljs-number">1</span>,
  score : -<span class="hljs-number">1</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_scoreDataHolder_ = {
  source          : <span class="hljs-built_in">Object</span>.create( controller.TaggedPosition ),
  target          : <span class="hljs-built_in">Object</span>.create( controller.TaggedPosition ),
  targetselection : <span class="hljs-built_in">Object</span>.create( controller.TaggedPosition ),
  selection       : util.selectionMap( MAX_SELECTION_RANGE * <span class="hljs-number">4</span> + <span class="hljs-number">1</span> ),
  move            : util.list(MAX_SELECTION_RANGE, cwt.INACTIVE),
  action          : {
    selectedSubEntry: <span class="hljs-string">""</span>
  },
  cacheInt        : <span class="hljs-number">0</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_actionDataHolder_ = {
  source          : <span class="hljs-built_in">Object</span>.create( controller.TaggedPosition ),
  target          : <span class="hljs-built_in">Object</span>.create( controller.TaggedPosition ),
  targetselection : <span class="hljs-built_in">Object</span>.create( controller.TaggedPosition ),
  selection       : util.selectionMap( MAX_SELECTION_RANGE * <span class="hljs-number">4</span> + <span class="hljs-number">1</span> ),
  used            : <span class="hljs-literal">false</span>,
  move            : util.list(MAX_SELECTION_RANGE, cwt.INACTIVE),
  check_index     : -<span class="hljs-number">1</span>,
  endsAiTurn      : <span class="hljs-literal">false</span>,
  action          : {
    selectedSubEntry: <span class="hljs-string">""</span>
  },
  cacheInt        : <span class="hljs-number">0</span>
};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_reset = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
  <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i= <span class="hljs-number">0</span>, e=MAX_PLAYER; i&lt;e; i++ ){
    controller.ai_data[i].pid = cwt.INACTIVE;
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_active = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Registers a AI action.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_defineRoutine = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(impl)</span>{</span>
  cwt.assert( util.isString(impl.key) );
  cwt.assert( !controller.ai_CHECKS.hasOwnProperty(impl.key) );
  cwt.assert( util.isFunction(impl.scoring) );
  cwt.assert( util.isFunction(impl.prepare) );

  controller.ai_CHECKS.push(impl);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Returns a AI action object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_getRoutine = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(key)</span>{</span>
  cwt.assert( util.isString(key) );

  <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> e = controller.ai_CHECKS.length;
  <span class="hljs-keyword">while</span>( i&lt;e ){
    <span class="hljs-keyword">if</span>( controller.ai_CHECKS[i].key === key ) <span class="hljs-keyword">return</span> controller.ai_CHECKS[i];
    i++;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Registers a player id as ai controlled instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_register = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pid)</span>{</span>
  cwt.assert( model.player_isValidPid(pid) );

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; controller.ai_data.length; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>if the slot is empty then occupy it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( controller.ai_data[i].pid === cwt.INACTIVE ){
        controller.ai_data[i].pid = pid;
        <span class="hljs-keyword">return</span>;
    }
  }
};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Registers a player id as ai controlled instance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_deregister = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pid)</span>{</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; controller.ai_data.length; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if the slot is empty then occupy it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>( controller.ai_data[i].pid === pid ){
        controller.ai_data[i].pid = cwt.INACTIVE;
        <span class="hljs-keyword">return</span>;
    }

  }

  cwt.assert(<span class="hljs-literal">false</span>,<span class="hljs-string">"player isn't ai controlled"</span>);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Returns <code>true</code> when the given player id is not controlled by the AI, else <code>false</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_isHuman = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(pid)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>search in all slots</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i=controller.ai_data.length-<span class="hljs-number">1</span>; i&gt;=<span class="hljs-number">0</span>; i-- ){
    <span class="hljs-keyword">if</span>( controller.ai_data[i].pid === pid ) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>no slot is used by the pid -&gt; human</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>The state machine of the ai, contains the whole decision making process.</p>
<p>   NONE                             =&gt; IDLE</p>
<p>   IDLE                             =&gt; SET_UP_AI_TURN</p>
<p>   SET_UP_AI_TURN                   =&gt; PHASE_PREPARE_SEARCH_TASKS</p>
<p>   PHASE_PREPARE_SEARCH_TASKS       =&gt; PHASE_SEARCH_TASKS</p>
<p>   PHASE_SEARCH_TASK                =&gt; PHASE_SEARCH_TASK              (when    actors left)
                                    =&gt; PHASE_FLUSH_TASK               (when no actors left)</p>
<p>   PHASE_FLUSH_TASK                 =&gt; PHASE_PREPARE_SEARCH_TASKS     (when normal action)
                                    =&gt; TEAR_DOWN_AI_TURN              (when endTurn action)</p>
<p>   TEAR_DOWN_AI_TURN                =&gt; IDLE</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>controller.ai_machine = util.stateMachine({</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>++++++++++++++++++++++++++++++++++++++++
This state must be active at the start
of a AI turn. If not then something gone
wrong. At least no logic will be done
here. It only symbolizes a meta state to
say “Hey I’m ready for a new AI turn”.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  IDLE:{ tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    util.log(controller.ai_spec,<span class="hljs-string">"- doing step in idle state"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>no ai is selected now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.assert( !controller.ai_active );</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>select ai</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i=controller.ai_data.length-<span class="hljs-number">1</span>; i&gt;=<span class="hljs-number">0</span>; i-- ){
      <span class="hljs-keyword">if</span>( controller.ai_data[i].pid === model.round_turnOwner ){
        controller.ai_active = controller.ai_data[i];
      }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>ai is selected now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.assert( controller.ai_active );

    <span class="hljs-keyword">return</span> <span class="hljs-string">"SET_UP_AI_TURN"</span>;
  }},</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>++++++++++++++++++++++++++++++++++++++++
Start turn actions. At the moment
nothing will be done here too. Later
this could be the place to make a first
analyse of the battlefield and the enemy
players. I think this will be a good
place to define the long term task of
the AI player based on the situation
on the battlefield.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  SET_UP_AI_TURN:{ tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    util.log(controller.ai_spec,<span class="hljs-string">"- setup turn"</span>);

    <span class="hljs-keyword">return</span> <span class="hljs-string">"PHASE_PREPARE_SEARCH_TASKS"</span>;
  }},</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>++++++++++++++++++++++++++++++++++++++++
Prepares the search tasks for units step.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  PHASE_PREPARE_SEARCH_TASKS: { tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    util.log(controller.ai_spec,<span class="hljs-string">"- prepare search unit tasks"</span>);

    <span class="hljs-keyword">var</span> data  = controller.ai_loopHolder_;
    data.i    = model.unit_firstUnitId( model.round_turnOwner );
    data.e    = model.unit_lastUnitId(  model.round_turnOwner )+MAX_PROPERTIES+<span class="hljs-number">1</span>; <span class="hljs-comment">// units+properties</span>
    data.prop = data.i+MAX_UNITS_PER_PLAYER;                                      <span class="hljs-comment">// position of the first prop</span>
    data.score = -<span class="hljs-number">1</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-string">"PHASE_SEARCH_TASK"</span>;
  }},</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>++++++++++++++++++++++++++++++++++++++++
Searches proper tasks for every unit
of the ai player.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  PHASE_SEARCH_TASK: { tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    util.log(controller.ai_spec,<span class="hljs-string">"- search task"</span>);

    <span class="hljs-keyword">var</span> loopData   = controller.ai_loopHolder_;
    <span class="hljs-keyword">var</span> scoreData  = controller.ai_scoreDataHolder_;
    <span class="hljs-keyword">var</span> actionData = controller.ai_actionDataHolder_;

    <span class="hljs-keyword">while</span>( <span class="hljs-literal">true</span> ){</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>clean score aw2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      scoreData.source.set(-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>);
      scoreData.target.set(-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>);
      scoreData.targetselection.set(-<span class="hljs-number">1</span>,-<span class="hljs-number">1</span>);
      scoreData.selection.setCenter(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>);
      scoreData.used = <span class="hljs-literal">false</span>;
      scoreData.selectedSubEntry = <span class="hljs-string">""</span>;
      scoreData.cacheInt         = -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>prepare aw2 object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> dataTp = -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span>( loopData.i &lt; loopData.e ){
        <span class="hljs-keyword">if</span>( loopData.i &lt; loopData.prop ){</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>unit check_</p>

            </div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>util.log(controller.ai_spec,”- ..for unit”,loopData.i);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
          <span class="hljs-keyword">var</span> unit = model.unit_data[loopData.i];
          <span class="hljs-keyword">if</span>( unit.owner !== cwt.INACTIVE &amp;&amp; unit.loadedIn === cwt.INACTIVE &amp;&amp; 
              model.actions_canAct(loopData.i)){
            dataTp = <span class="hljs-number">0</span>;
            scoreData.source.set( unit.x, unit.y );
            model.move_fillMoveMap( scoreData.source, scoreData.selection );
          }


        } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>property check_</p>

            </div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>util.log(controller.ai_spec,”- ..for property”,loopData.i);</p>

            </div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>grab property; convert relative id to absolute id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">var</span> prop = model.property_data[loopData.i-loopData.prop];
          <span class="hljs-keyword">if</span>( prop.owner === controller.ai_active.pid ){
            dataTp = <span class="hljs-number">1</span>;
            scoreData.source.set( prop.x, prop.y );
          }
        }

      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>map check_</p>

            </div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>util.log(controller.ai_spec,”- ..for map”);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        dataTp = <span class="hljs-number">2</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>do all checks</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> cScore  = -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> nScore  = -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">var</span> i       = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">var</span> e       = controller.ai_CHECKS.length;
      <span class="hljs-keyword">if</span>( dataTp !== -<span class="hljs-number">1</span> ){
        <span class="hljs-keyword">while</span>( i&lt;e ){
          <span class="hljs-keyword">var</span> check_ = controller.ai_CHECKS[i];
          i++;</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>meta check_</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>( dataTp !== <span class="hljs-number">0</span> &amp;&amp; check_.unitAction ) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">if</span>( dataTp !== <span class="hljs-number">1</span> &amp;&amp; check_.propAction ) <span class="hljs-keyword">continue</span>;
          <span class="hljs-keyword">if</span>( dataTp !== <span class="hljs-number">2</span> &amp;&amp; check_.mapAction ) <span class="hljs-keyword">continue</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>call scoring</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          nScore = check_.scoring(scoreData,loopData.score);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>new object got better scores -&gt; select it’s action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          <span class="hljs-keyword">if</span>( nScore &gt; loopData.score ){
            actionData.source.grab(          scoreData.source)
            actionData.target.grab(          scoreData.target)
            actionData.targetselection.grab( scoreData.targetselection)
            actionData.selection.grab(       scoreData.selection);
            actionData.used             = <span class="hljs-literal">true</span>;
            actionData.check_index      = i-<span class="hljs-number">1</span>;
            actionData.endsAiTurn       = (check_.endsAiTurn === <span class="hljs-literal">true</span>);
            actionData.cacheInt         = scoreData.cacheInt;
            actionData.move.grabValues(scoreData.move);
            loopData.score              = nScore;
            actionData.action.selectedSubEntry = scoreData.action.selectedSubEntry;
          }
        }
      }

      loopData.i++;</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>jump out of the loop when
 a) you find a valid action to do
 b) no object can handle ( just to be safe, should not happen )</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( ( dataTp !== -<span class="hljs-number">1</span> &amp;&amp; nScore !== -<span class="hljs-number">1</span> ) || (loopData.i &gt; loopData.e) ) <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">return</span> ( loopData.i &lt;= loopData.e )? <span class="hljs-string">"PHASE_SEARCH_TASK"</span> : <span class="hljs-string">"PHASE_FLUSH_TASK"</span>;
  }},</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>++++++++++++++++++++++++++++++++++++++++
Flushes the current selected task, which
is the action with the highest priority.
The ai machine moves into the tear down
state when the flush state calls an
endAiTurn action or no valid action
could be found.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  PHASE_FLUSH_TASK: { tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    util.log(controller.ai_spec,<span class="hljs-string">"- flush most important command"</span>);

    <span class="hljs-keyword">var</span> actionData = controller.ai_actionDataHolder_;
    <span class="hljs-keyword">if</span>( actionData.used ){

      <span class="hljs-keyword">var</span> action = controller.ai_CHECKS[ actionData.check_index ];
      <span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.DEBUG ) util.log(<span class="hljs-string">"invoke action"</span>,action.key);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>do actions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      action.prepare( actionData );</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>end turn with an end turn action</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> (actionData.endsAiTurn === <span class="hljs-literal">true</span>)? <span class="hljs-string">"TEAR_DOWN_AI_TURN"</span> : <span class="hljs-string">"PHASE_PREPARE_SEARCH_TASKS"</span>;
    }

    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"at least one action must explicit ending AI turn"</span>);
  }},</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>++++++++++++++++++++++++++++++++++++++++
The ai turn ends here.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  TEAR_DOWN_AI_TURN:{ tick: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
    util.log(controller.ai_spec,<span class="hljs-string">"- tear down turn"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>release reference</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    controller.ai_active = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>end turn now</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    controller.action_objects.nextTurn.invoke();

    <span class="hljs-keyword">return</span> <span class="hljs-string">"IDLE"</span>;
  }}</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>++++++++++++++++++++++++++++++++++++++++</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
});
controller.ai_machine.state = <span class="hljs-string">"IDLE"</span>;

  *<span class="hljs-comment">//*</span>
util.scoped(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

  <span class="hljs-keyword">var</span> menu = {
    data:util.list(<span class="hljs-number">20</span>,<span class="hljs-literal">null</span>),

    size:<span class="hljs-number">0</span>,

    clear:<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
      <span class="hljs-keyword">this</span>.size = <span class="hljs-number">0</span>;
    },

    addEntry: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( el )</span>{</span>
      <span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.size === <span class="hljs-number">20</span> ) <span class="hljs-keyword">throw</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"full"</span>);
      <span class="hljs-keyword">this</span>.data[<span class="hljs-keyword">this</span>.size] = el;
      <span class="hljs-keyword">this</span>.size++;
    }
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  controller.ai_defineRoutine({
    key        : <span class="hljs-string">"buildUnits"</span>,
    propAction : <span class="hljs-literal">true</span>,

    scoring : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span>{</span>
      <span class="hljs-keyword">var</span> prid = data.source.propertyId;

      <span class="hljs-keyword">if</span>( data.source.unit ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>isn’t a factory</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( !model.factory_isFactory(prid)) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>there aren’t any unit slots left or the man power is zero</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( !model.factory_canProduceSomething(prid,model.property_data[prid].owner) ){
        <span class="hljs-keyword">if</span>( <span class="hljs-keyword">this</span>.DEBUG ) util.log(<span class="hljs-string">"cannot build capturers because no slots left or no man power left"</span>);
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      }

      menu.clear();
      model.factoryGenerateBuildMenu(prid, menu);</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>stuff buildable ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span>( menu.size === <span class="hljs-number">0</span> ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>search capturers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> gold = model.player_data[data.source.property.owner].gold;
      <span class="hljs-keyword">var</span> rand = <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">Math</span>.random()*menu.size*<span class="hljs-number">2</span>,<span class="hljs-number">10</span>);
      <span class="hljs-keyword">var</span> oldRand = rand;
      <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>, e=menu.size; i&lt;e; i++ ){
          <span class="hljs-keyword">var</span> type = model.data_unitSheets[menu.data[i]];
          <span class="hljs-keyword">if</span>( type.cost &lt;= gold ){
            rand--;
            <span class="hljs-keyword">if</span>( rand &lt; <span class="hljs-number">0</span> ){
              data.action.selectedSubEntry = type.ID;
              <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;
            }
          }
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>not enough money for something…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>( rand === oldRand ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      }

      <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    },

    prepare : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span>{</span>
      controller.action_objects.buildUnit.invoke(data);
    }
  });

});

  *<span class="hljs-comment">//*</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTarget</span><span class="hljs-params">(x, y, data)</span> {</span>
    data.target.set(x, y);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  controller.ai_defineRoutine({
    key: <span class="hljs-string">"captureProperties"</span>,
    unitAction: <span class="hljs-literal">true</span>,

    scoring: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data, cScore)</span> {</span>
      <span class="hljs-keyword">if</span> (cScore &gt;= <span class="hljs-number">20</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span> (!data.source.unit.type.captures) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      <span class="hljs-keyword">var</span> tid = model.player_data[data.source.unit.owner].team;
      <span class="hljs-keyword">var</span> prop = <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">var</span> move = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> cprop = model.property_posMap[data.source.x][data.source.y];
      <span class="hljs-keyword">if</span> ( cprop &amp;&amp; ( cprop.owner === cwt.INACTIVE || 
        model.player_data[cprop.owner].team !== tid ) &amp;&amp;
        model.property_isCapturableBy(model.property_extractId(cprop), data.source.unitId)) {

        prop = cprop;
        data.target.set(data.source.x,data.source.y);

      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> x, y, ye, xe;
        <span class="hljs-keyword">var</span> tx, ty;
        <span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">var</span> dataL = data.selection.data;
        move = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>, xe = dataL.length; x &lt; xe; x++) {
          <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>, ye = dataL[x].length; y &lt; ye; y++) {
            <span class="hljs-keyword">if</span> (dataL[x][y] &gt;= <span class="hljs-number">0</span>) {

              <span class="hljs-keyword">if</span>( model.unit_posData[x][y] ) <span class="hljs-keyword">continue</span>;

              cprop = model.property_posMap[x][y];
              <span class="hljs-keyword">if</span> (cprop &amp;&amp; ( cprop.owner === cwt.INACTIVE || 
                model.player_data[cprop.owner].team !== tid ) &amp;&amp;
                model.property_isCapturableBy(
                  model.property_extractId(cprop), data.source.unitId)) {

                prop = cprop;
                data.target.set(x,y);
                found = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">break</span>;
              }
            }
          }
          <span class="hljs-keyword">if</span> (found) <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">if</span> (!found) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      }

      <span class="hljs-keyword">if</span> (!prop) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span>( move ){
        model.move_generatePath(
          data.source.x, data.source.y,
          data.target.x, data.target.y,
          data.selection,
          data.move
        );
      } <span class="hljs-keyword">else</span> data.move.resetValues(cwt.INACTIVE);

      <span class="hljs-keyword">return</span> <span class="hljs-number">20</span>;
    },

    prepare: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>

      <span class="hljs-keyword">var</span> trapped = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (data.move[<span class="hljs-number">0</span>] !== -<span class="hljs-number">1</span>) {
        trapped = model.move_trapCheck(data.move, data.source, data.target);
        model.events.move_flushMoveData(data.move, data.source);
      }

      <span class="hljs-keyword">if</span> (!trapped) {
        controller.commandStack_sharedInvokement(
          <span class="hljs-string">"capture_invoked"</span>,
          data.target.propertyId,
          data.source.unitId
        );
        controller.commandStack_sharedInvokement(
          <span class="hljs-string">"wait_invoked"</span>,
          data.source.unitId
        );
      } <span class="hljs-keyword">else</span> {
        controller.commandStack_sharedInvokement(
          <span class="hljs-string">"trapwait_invoked"</span>,
          data.source.unitId
        );
      }
    }
  });
})();
 *<span class="hljs-comment">//*</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTarget</span><span class="hljs-params">( x,y, data )</span>{</span>
    data.targetselection.set(x,y);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  controller.ai_defineRoutine({
    key        : <span class="hljs-string">"attackDirect"</span>,
    unitAction : <span class="hljs-literal">true</span>,

    scoring : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data , cScore )</span>{</span>
      <span class="hljs-keyword">if</span>( cScore &gt;= <span class="hljs-number">5</span> ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span>( !data.source.unit.type.attack ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
      
      <span class="hljs-keyword">var</span> x,y,ye,xe;
      <span class="hljs-keyword">var</span> tx,ty;
      <span class="hljs-keyword">var</span> found = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">var</span> dataL = data.selection.data;
      <span class="hljs-keyword">for</span> (x = <span class="hljs-number">0</span>, xe = dataL.length; x&lt;xe; x++ ) {
        <span class="hljs-keyword">for</span> (y = <span class="hljs-number">0</span>, ye = dataL[x].length; y&lt;ye; y++ ) {
          <span class="hljs-keyword">if</span>( dataL[x][y] &gt;= <span class="hljs-number">0</span> ){

            <span class="hljs-keyword">if</span>( model.unit_posData[x][y]) <span class="hljs-keyword">continue</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span>( model.events.attack_check( data.source.unitId, x,y, <span class="hljs-literal">true</span>) ){
              tx = x;
              ty = y;
              found = <span class="hljs-literal">true</span>;
              <span class="hljs-keyword">break</span>;
            }

          }
        };
        <span class="hljs-keyword">if</span>( found ) <span class="hljs-keyword">break</span>;
      };

      <span class="hljs-keyword">if</span>(!found) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>grab path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      model.move_generatePath( 
        data.source.x, data.source.y, 
        tx, ty, 
        data.selection, 
        data.move 
      );</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>attack map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      model.battle_calculateTargets( data.source.unitId, tx, ty, data.selection, false );
      data.selection.nextRandomPosition( setTarget, data, 1 );

      if( data.targetselection.unitId === -1 ) return -1;

      return 5;
    },

    prepare : function( data ){

      var trapped = false;
      if (data.move[0] !== -1) {
        trapped = model.move_trapCheck(data.move, data.source, data.target);
        model.events.move_flushMoveData(data.move, data.source);
      }

      if (!trapped){
        controller.commandStack_sharedInvokement(
          "attack_invoked",
          data.source.unitId,
          data.targetselection.unitId,
          Math.round(Math.random() * 100),
          Math.round(Math.random() * 100),
          0
        );
        controller.commandStack_sharedInvokement(
          "wait_invoked",
          data.source.unitId
        );
      } else {
        controller.commandStack_sharedInvokement(
          "trapwait_invoked",
          data.source.unitId
        );
      }
    }
  });
})();
  */
/*
controller.ai_defineRoutine({
  key        : "endTurn",
  mapAction  : true,
  endsAiTurn : true,</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>1 as low score to be sure that end turn will be used at last by the AI</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  scoring : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span>{</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  },

  prepare : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>end turn will be done by machine</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  }
});
*<span class="hljs-comment">//*</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTarget</span><span class="hljs-params">( x,y, data )</span>{</span>
    data.targetselection.set(x,y);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  controller.ai_defineRoutine({
    key        : <span class="hljs-string">"attackFromCurrentPos"</span>,
    unitAction : <span class="hljs-literal">true</span>,

    scoring : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data , cScore )</span>{</span>
      <span class="hljs-keyword">if</span>( cScore &gt;= <span class="hljs-number">10</span> ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span>( !data.source.unit.type.attack ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      <span class="hljs-keyword">if</span>( !model.events.attack_check( 
        data.source.unitId, 
        data.source.x,
        data.source.y, 
        <span class="hljs-literal">false</span>
      )) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>attack map</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      model.battle_calculateTargets( 
        data.source.unitId, 
        data.source.x,
        data.source.y, 
        data.selection, 
        <span class="hljs-literal">false</span> 
      );

      data.selection.nextRandomPosition( setTarget, data, <span class="hljs-number">1</span> );

      <span class="hljs-keyword">if</span>( data.targetselection.unitId === -<span class="hljs-number">1</span> ) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

      <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;
    },

    prepare : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">( data )</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>attack</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      controller.commandStack_sharedInvokement(
        <span class="hljs-string">"attack_invoked"</span>,
        data.source.unitId, 
        data.targetselection.unitId, 
        <span class="hljs-built_in">Math</span>.round( <span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">100</span> ),
        <span class="hljs-built_in">Math</span>.round( <span class="hljs-built_in">Math</span>.random()*<span class="hljs-number">100</span> ),
        <span class="hljs-number">0</span>
      );

      controller.commandStack_sharedInvokement(
        <span class="hljs-string">"wait_invoked"</span>,
        data.source.unitId
      );
    }
  });
})();
*<span class="hljs-comment">//*</span>
(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setTarget</span><span class="hljs-params">( x,y, data )</span>{</span>
    data.target.set(x,y);
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>  controller.ai_defineRoutine({
    key        : "moveRandom",
    unitAction : true,

    scoring : function( data , cScore ){
      if( cScore &gt;= 1 ) return -1;

      var n = 0;
      while( true ){
        if( n &gt;= 10 ) return -1;

        if( !data.selection.nextRandomPosition( setTarget, data, 0 ) ){
          n++;
          continue;  
        }

        if( !data.target.unit ) break;
        else n++;
      }
            
      model.move_generatePath( 
        data.source.x, data.source.y, 
        data.target.x, data.target.y, 
        data.selection, 
        data.move 
      );

      model.move_trapCheck(data.move,data.source,data.target);

      return 1;
    },

    prepare : function( data ){

      model.events.move_flushMoveData( 
        data.move, 
        data.source 
      );
      
      controller.commandStack_sharedInvokement(
        "wait_invoked",
        data.source.unitId
      );
    }
  });
})();
  */</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>