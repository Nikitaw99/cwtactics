<!DOCTYPE html>

<html>
<head>
  <title>renderer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="doc.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="ai.html">
                  ai.js
                </a>
              
                
                <a class="source" href="base.html">
                  base.js
                </a>
              
                
                <a class="source" href="commands.html">
                  commands.js
                </a>
              
                
                <a class="source" href="controller.html">
                  controller.js
                </a>
              
                
                <a class="source" href="datatypes.html">
                  datatypes.js
                </a>
              
                
                <a class="source" href="dependencies.html">
                  dependencies.js
                </a>
              
                
                <a class="source" href="flow.html">
                  flow.js
                </a>
              
                
                <a class="source" href="input.html">
                  input.js
                </a>
              
                
                <a class="source" href="loading.html">
                  loading.js
                </a>
              
                
                <a class="source" href="logic.html">
                  logic.js
                </a>
              
                
                <a class="source" href="model.html">
                  model.js
                </a>
              
                
                <a class="source" href="modification.html">
                  modification.js
                </a>
              
                
                <a class="source" href="renderer.html">
                  renderer.js
                </a>
              
                
                <a class="source" href="test.html">
                  test.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>renderer.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">"use strict"</span>;

<span class="hljs-comment">/**
 * Renders the cursor to the UI layer.
 */</span>
cwt.MapRenderer.eraseCursor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> ctx = cwt.Screen.layerUI.getContext();
  <span class="hljs-keyword">var</span> x = (cwt.Cursor.x - cwt.Screen.offsetX) * cwt.TILE_BASE;
  <span class="hljs-keyword">var</span> y = (cwt.Cursor.y - cwt.Screen.offsetY) * cwt.TILE_BASE;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>clear cursor at old position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ctx.clearRect(
    x - cwt.TILE_BASE,
    y - cwt.TILE_BASE,
    cwt.TILE_BASE * <span class="hljs-number">3</span>,
    cwt.TILE_BASE * <span class="hljs-number">3</span>
  );
};

<span class="hljs-comment">/**
 * Renders the cursor to the UI layer.
 */</span>
cwt.MapRenderer.renderCursor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> ctx = cwt.Screen.layerUI.getContext();
  <span class="hljs-keyword">var</span> cursorImg = cwt.Image.sprites.CURSOR.getImage(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">var</span> h = cwt.TILE_BASE / <span class="hljs-number">2</span>;
  <span class="hljs-keyword">var</span> x = (cwt.Cursor.x - cwt.Screen.offsetX) * cwt.TILE_BASE;
  <span class="hljs-keyword">var</span> y = (cwt.Cursor.y - cwt.Screen.offsetY) * cwt.TILE_BASE;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>render cursor at new position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ctx.drawImage(cursorImg, x - h, y - h);
  ctx.drawImage(cursorImg, x + h + h, y + h + h);
  ctx.drawImage(cursorImg, x + h + h, y - h);
  ctx.drawImage(cursorImg, x - h, y + h + h);
};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><strong>unitAnimationHalfStep_ (private)</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cwt.MapRenderer.unitAnimationHalfStep_ = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><strong>curTime_ (private)</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cwt.MapRenderer.curTime_ = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><strong>indexUnitAnimation (readOnly)</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cwt.MapRenderer.indexUnitAnimation = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><strong>indexMapAnimation (readOnly)</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cwt.MapRenderer.indexMapAnimation = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><strong>indexFocus (readOnly)</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cwt.MapRenderer.indexFocus = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><strong>indexFocusTime (readOnly)</strong></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>cwt.MapRenderer.indexFocusTime = <span class="hljs-number">0</span>;

<span class="hljs-comment">/**
 *
 * @param {number} delta
 */</span>
cwt.MapRenderer.evaluateCycle = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(delta, focusActive)</span> {</span>
  <span class="hljs-keyword">var</span> index;

  <span class="hljs-keyword">if</span> (focusActive) {
    <span class="hljs-keyword">this</span>.indexFocusTime += delta;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.indexFocusTime &gt;= <span class="hljs-number">120</span>) {
      <span class="hljs-keyword">this</span>.indexFocusTime = <span class="hljs-number">0</span>;

      <span class="hljs-keyword">this</span>.indexFocus++;
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.indexFocus &gt;= <span class="hljs-number">7</span>) {
        <span class="hljs-keyword">this</span>.indexFocus = <span class="hljs-number">0</span>;
      }

      cwt.Screen.layerFocus.renderLayer(<span class="hljs-keyword">this</span>.indexFocus);
    }
  }

  <span class="hljs-keyword">this</span>.curTime_ += delta;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.curTime_ &gt; <span class="hljs-number">150</span>) {
    <span class="hljs-keyword">this</span>.curTime_ = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>calc unit animation layer step</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">this</span>.unitAnimationHalfStep_ = !<span class="hljs-keyword">this</span>.unitAnimationHalfStep_;
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.unitAnimationHalfStep_) {

      index = <span class="hljs-keyword">this</span>.indexUnitAnimation + <span class="hljs-number">1</span>;
      <span class="hljs-keyword">if</span> (index === <span class="hljs-number">3</span>) {
        index = <span class="hljs-number">0</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>render unit animation layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cwt.Screen.layerUnit.renderLayer(index);
      <span class="hljs-keyword">this</span>.indexUnitAnimation = index;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>map animation layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    index = <span class="hljs-keyword">this</span>.indexMapAnimation + <span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span> (index === <span class="hljs-number">8</span>) {
      index = <span class="hljs-number">0</span>;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>render map animation layer</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cwt.Screen.layerMap.renderLayer(index);
    <span class="hljs-keyword">this</span>.indexMapAnimation = index;
  }
};
cwt.MapRenderer.renderFocusOnScreen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(selection)</span> {</span>
  <span class="hljs-keyword">var</span> x = cwt.Screen.offsetX;
  <span class="hljs-keyword">var</span> y = cwt.Screen.offsetY;
  <span class="hljs-keyword">var</span> w = (cwt.Map.width &lt; cwt.SCREEN_WIDTH) ? cwt.Map.width : cwt.SCREEN_WIDTH;
  <span class="hljs-keyword">var</span> h = (cwt.Map.height &lt; cwt.SCREEN_HEIGHT) ? cwt.Map.height : cwt.SCREEN_HEIGHT;

  <span class="hljs-keyword">this</span>.renderFocus(x, y, w, h, selection);
};

cwt.MapRenderer.renderFocus = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ox, oy, w, h, selection)</span> {</span>
  <span class="hljs-keyword">var</span> sprite = cwt.Image.sprites.FOCUS.getImage(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (n &lt; <span class="hljs-number">7</span>) {
    <span class="hljs-keyword">var</span> effects = cwt.Screen.layerFocus;

    effects.clear(n);
    <span class="hljs-keyword">var</span> ctx = effects.getContext(n);

    ctx.globalAlpha = <span class="hljs-number">0.6</span>;

    <span class="hljs-keyword">var</span> x = ox;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xe = x + w; x &lt; xe; x++) {
      <span class="hljs-keyword">var</span> y = oy;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> ye = y + h; y &lt; ye; y++) {

        <span class="hljs-keyword">if</span> (selection.getValue(x, y) &gt;= <span class="hljs-number">0</span>) {

          <span class="hljs-keyword">var</span> scx = cwt.TILE_BASE * n;
          <span class="hljs-keyword">var</span> scy = <span class="hljs-number">0</span>;
          <span class="hljs-keyword">var</span> scw = cwt.TILE_BASE;
          <span class="hljs-keyword">var</span> sch = cwt.TILE_BASE;
          <span class="hljs-keyword">var</span> tcx = (x - cwt.Screen.offsetX) * cwt.TILE_BASE;
          <span class="hljs-keyword">var</span> tcy = (y - cwt.Screen.offsetY) * cwt.TILE_BASE;
          <span class="hljs-keyword">var</span> tcw = cwt.TILE_BASE;
          <span class="hljs-keyword">var</span> tch = cwt.TILE_BASE;

          ctx.drawImage(
            sprite,
            scx, scy,
            scw, sch,
            tcx, tcy,
            tcw, tch
          );
        }
      }
    }

    ctx.globalAlpha = <span class="hljs-number">1</span>;

    n++;
  }
};

cwt.MapRenderer.shiftFocus = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code)</span> {</span>
  cwt.MapRenderer.shiftLayer(code, cwt.Screen.layerFocus, <span class="hljs-number">7</span>, <span class="hljs-literal">false</span>);
};<span class="hljs-comment">/**
 *
 * @namespace
 */</span>
cwt.MapRenderer = {};

cwt.MapRenderer.shiftLayer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code, layer, steps, selfDraw)</span> {</span>
  <span class="hljs-keyword">var</span> tmpCanvas = <span class="hljs-keyword">this</span>.getTempCanvas();
  <span class="hljs-keyword">var</span> tmpContext = tmpCanvas.getContext(<span class="hljs-string">"2d"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>calculate meta data for shift</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> sx = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> sy = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> scx = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> scy = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">var</span> w = layer.w;
  <span class="hljs-keyword">var</span> h = layer.h;
  <span class="hljs-keyword">switch</span> (code) {
    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_LEFT:
      scx += cwt.TILE_BASE;
      w -= cwt.TILE_BASE;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_RIGHT:
      sx += cwt.TILE_BASE;
      w -= cwt.TILE_BASE;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_UP:
      scy += cwt.TILE_BASE;
      h -= cwt.TILE_BASE;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_DOWN:
      sy += cwt.TILE_BASE;
      h -= cwt.TILE_BASE;
      <span class="hljs-keyword">break</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>update background layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (n &lt; steps) {

    <span class="hljs-keyword">if</span> (selfDraw === <span class="hljs-literal">true</span>) {
      layer.getContext(n).drawImage(
        layer.getLayer(n),
        scx, scy,
        w, h,
        sx, sy,
        w, h
      );

    } <span class="hljs-keyword">else</span> {
      tmpContext.clearRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, layer.w, layer.h);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>copy visible content to temp canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      tmpContext.drawImage(
        layer.getLayer(n),
        scx, scy,
        w, h,
        sx, sy,
        w, h
      )</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>clear original canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      layer.clear(n);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>copy visible content back to the original canvas</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      layer.getContext(n).drawImage(tmpCanvas, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);

    }

    n++;
  }
};<span class="hljs-comment">/**
 *
 * NOTE: clears the area before update
 *
 * @param x
 * @param y
 * @param range
 */</span>
cwt.MapRenderer.renderFogCircle = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, range)</span> {</span>
  <span class="hljs-keyword">this</span>.renderFogRect(x, y, range, range, <span class="hljs-literal">true</span>);
};

<span class="hljs-comment">/**
 *
 * NOTE: clears the area before update
 *
 * @param x
 * @param y
 * @param w
 * @param h
 * @param {boolean?} circle
 */</span>
cwt.MapRenderer.renderFogRect = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, w, h, circle)</span> {</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">4</span>) circle = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> data = cwt.Map.data;
  <span class="hljs-keyword">var</span> layer = cwt.Screen.layerFog.getContext(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">var</span> cx, cy, range;

  <span class="hljs-keyword">if</span> (circle) {</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>prepare meta data for the circle center and the pseudo-circle search field</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    cx = x;
    cy = y;
    x -= w;
    y -= h;
    range = w;
    w += w;
    h += w;

  } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>clear area in background layer as rectangle only in rectangle mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    layer.clearRect(
      (x - cwt.Screen.offsetX) * cwt.TILE_BASE,
      (y - cwt.Screen.offsetY) * cwt.TILE_BASE,
      w * cwt.TILE_BASE,
      h * cwt.TILE_BASE
    );
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>render</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> oy = y;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xe = x + w; x &lt; xe; x++) {
    y = oy;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> ye = y + h; y &lt; ye; y++) {
      <span class="hljs-keyword">var</span> distance;

      <span class="hljs-keyword">if</span> (circle) {
        distance = cwt.Map.getDistance(x, y, cx, cy);
        <span class="hljs-keyword">if</span> (!cwt.Map.isValidPosition(x, y) || distance) {
          <span class="hljs-keyword">continue</span>;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>clear position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        layer.clearRect(
          (x - cwt.Screen.offsetX) * cwt.TILE_BASE,
          (y - cwt.Screen.offsetY) * cwt.TILE_BASE,
          cwt.TILE_BASE,
          cwt.TILE_BASE
        );
      }

      <span class="hljs-keyword">var</span> tile = data[x][y];
      <span class="hljs-keyword">if</span> (tile.visionClient === <span class="hljs-number">0</span>) {

        <span class="hljs-keyword">var</span> sprite = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">if</span> (tile.property) {
          sprite = cwt.Image.sprites[tile.property.type.ID].getImage(
            cwt.Sprite.PROPERTY_SHADOW_MASK
          );
        } <span class="hljs-keyword">else</span> {
          sprite = cwt.Image.sprites[tile.type.ID].getImage(
            tile.variant * cwt.Sprite.TILE_STATES + cwt.Sprite.TILE_SHADOW
          );
        }

        <span class="hljs-keyword">var</span> scx = (cwt.Image.longAnimatedTiles[tile.type.ID]) ? cwt.TILE_BASE * n : <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> scy = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> scw = cwt.TILE_BASE;
        <span class="hljs-keyword">var</span> sch = cwt.TILE_BASE * <span class="hljs-number">2</span>;
        <span class="hljs-keyword">var</span> tcx = (x - cwt.Screen.offsetX) * cwt.TILE_BASE;
        <span class="hljs-keyword">var</span> tcy = (y - cwt.Screen.offsetY) * cwt.TILE_BASE - cwt.TILE_BASE;
        <span class="hljs-keyword">var</span> tcw = cwt.TILE_BASE;
        <span class="hljs-keyword">var</span> tch = cwt.TILE_BASE * <span class="hljs-number">2</span>;

        <span class="hljs-keyword">if</span> (tcy &lt; <span class="hljs-number">0</span>) {
          scy = scy + cwt.TILE_BASE;
          sch = sch - cwt.TILE_BASE;
          tcy = tcy + cwt.TILE_BASE;
          tch = tch - cwt.TILE_BASE;
        }

        layer.drawImage(
          sprite,
          scx, scy,
          scw, sch,
          tcx, tcy,
          tcw, tch
        );
      } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>fix overlays on all tiles that are at the max range in the circle mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (circle) {
          <span class="hljs-keyword">if</span> (distance === range) {</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>top check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (y &lt;= cy) {
              <span class="hljs-keyword">this</span>.fixOverlayFog_(x, y, <span class="hljs-literal">true</span>);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>bottom check</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">if</span> (y &gt;= cy) {
              <span class="hljs-keyword">this</span>.fixOverlayFog_(x, y, <span class="hljs-literal">false</span>);
            }
          }
        }
      }
    }
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>fix overlay top and bottom in the rectangle mode</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (!circle) {

  }

  <span class="hljs-keyword">this</span>.renderFogBackgroundLayer();
};

cwt.MapRenderer.fixOverlayFog_ = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y, isTop)</span> {</span>
  <span class="hljs-keyword">if</span> (isTop) {

  } <span class="hljs-keyword">else</span> {

  }
};

<span class="hljs-comment">/**
 *
 */</span>
cwt.MapRenderer.renderFogBackgroundLayer = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  cwt.Screen.layerFog.getContext().globalAlpha = <span class="hljs-number">0.35</span>;
  cwt.Screen.layerFog.renderLayer(<span class="hljs-number">0</span>);
  cwt.Screen.layerFog.getContext().globalAlpha = <span class="hljs-number">1</span>;
};

<span class="hljs-comment">/**
 *
 * Note: this one clears the layer before action
 *
 * @param {number} code
 */</span>
cwt.MapRenderer.shiftFog = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code)</span> {</span>
  cwt.MapRenderer.shiftLayer(code, cwt.Screen.layerFog, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>);
  <span class="hljs-keyword">this</span>.renderFogBackgroundLayer();
};<span class="hljs-comment">/**
 *
 * @param {number} x
 * @param {number} y
 */</span>
cwt.MapRenderer.renderTile = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, y)</span> {</span>
  <span class="hljs-keyword">this</span>.renderTiles(x,y,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-literal">false</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>draw overlay of the bottom tile</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (y &lt; cwt.Map.height-<span class="hljs-number">1</span>) {
    <span class="hljs-keyword">this</span>.renderTiles(x,y+<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-literal">true</span>);
  }
};

cwt.MapRenderer.renderTileOverlayRow = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  cwt.MapRenderer.renderTiles(
    cwt.Screen.offsetX,
    cwt.Screen.offsetY+<span class="hljs-number">1</span>,
    (cwt.Map.width &lt; cwt.SCREEN_WIDTH) ? cwt.Map.width : cwt.SCREEN_WIDTH,
    <span class="hljs-number">1</span>,
    <span class="hljs-literal">true</span>
  );
};

cwt.MapRenderer.renderTiles = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, oy, w, h, overlayDraw)</span> {</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length === <span class="hljs-number">4</span>) overlayDraw = <span class="hljs-literal">false</span>;
  <span class="hljs-keyword">var</span> mapData = cwt.Map.data;
  <span class="hljs-keyword">var</span> mapLayer = cwt.Screen.layerMap;
  <span class="hljs-keyword">var</span> ctx;
  <span class="hljs-keyword">var</span> scx;
  <span class="hljs-keyword">var</span> scy;
  <span class="hljs-keyword">var</span> scw;
  <span class="hljs-keyword">var</span> sch;
  <span class="hljs-keyword">var</span> tcx;
  <span class="hljs-keyword">var</span> tcy;
  <span class="hljs-keyword">var</span> tcw;
  <span class="hljs-keyword">var</span> tch;
  <span class="hljs-keyword">var</span> tile;
  <span class="hljs-keyword">var</span> sprite, propSprite;
  <span class="hljs-keyword">var</span> state;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xe = x + w; x &lt; xe; x++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = oy, ye = y + h; y &lt; ye; y++) {
      tile = mapData[x][y];
      sprite = cwt.Image.sprites[tile.type.ID].getImage(tile.variant * cwt.Sprite.TILE_STATES);</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>grab property status before loop (calc it one instead of eight times)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (tile.property) {
        <span class="hljs-keyword">if</span> (tile.property.owner) {
          <span class="hljs-keyword">switch</span> (tile.property.owner.id) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
              state = cwt.Sprite.PROPERTY_RED;
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
              state = cwt.Sprite.PROPERTY_BLUE;
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
              state = cwt.Sprite.PROPERTY_GREEN;
              <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
              state = cwt.Sprite.PROPERTY_YELLOW;
              <span class="hljs-keyword">break</span>;
          }
        } <span class="hljs-keyword">else</span> {
          state = cwt.Sprite.PROPERTY_NEUTRAL;
        }

        propSprite = cwt.Image.sprites[tile.property.type.ID].getImage(state);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>render all phases</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (n &lt; <span class="hljs-number">8</span>) {
        ctx = mapLayer.getContext(n);

        scx = (cwt.Image.longAnimatedTiles[tile.type.ID]) ? cwt.TILE_BASE * n : <span class="hljs-number">0</span>;
        scy = <span class="hljs-number">0</span>;
        scw = cwt.TILE_BASE;
        sch = cwt.TILE_BASE * <span class="hljs-number">2</span>;
        tcx = (x - cwt.Screen.offsetX) * cwt.TILE_BASE;
        tcy = (y - cwt.Screen.offsetY) * cwt.TILE_BASE - cwt.TILE_BASE;
        tcw = cwt.TILE_BASE;
        tch = cwt.TILE_BASE * <span class="hljs-number">2</span>;

        <span class="hljs-keyword">if</span> (tcy &lt; <span class="hljs-number">0</span>) {
          scy = scy + cwt.TILE_BASE;
          sch = sch - cwt.TILE_BASE;
          tcy = tcy + cwt.TILE_BASE;
          tch = tch - cwt.TILE_BASE;
        }

        <span class="hljs-keyword">if</span> (overlayDraw) {
          sch = sch - cwt.TILE_BASE;
          tch = tch - cwt.TILE_BASE;
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>render tile</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ctx.drawImage(
          sprite,
          scx, scy,
          scw, sch,
          tcx, tcy,
          tcw, tch
        );</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>render property</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (tile.property) {
          scx = cwt.TILE_BASE * (<span class="hljs-built_in">parseInt</span>(n / <span class="hljs-number">2</span>, <span class="hljs-number">10</span>));

          ctx.drawImage(
            propSprite,
            scx, scy,
            scw, sch,
            tcx, tcy,
            tcw, tch
          );
        }

        n++;
      }
    }
  }
};

<span class="hljs-comment">/**
 *
 * Note: this one does not clear the layer before action
 *
 * @param {number} code
 */</span>
cwt.MapRenderer.shiftTiles = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code)</span> {</span>
  cwt.MapRenderer.shiftLayer(code, cwt.Screen.layerMap, <span class="hljs-number">8</span>, <span class="hljs-literal">true</span>);
};<span class="hljs-comment">/**
 *
 * NOTE: does not clear the area before update
 *
 * @param {number} x
 * @param {number} y
 * @param {number} w
 * @param {number} h
 */</span>
cwt.MapRenderer.renderUnits = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(x, oy, w, h)</span> {</span>
  <span class="hljs-keyword">var</span> mapData = cwt.Map.data;
  <span class="hljs-keyword">var</span> layer = cwt.Screen.layerUnit;
  <span class="hljs-keyword">var</span> halfTileBase = <span class="hljs-built_in">parseInt</span>(cwt.TILE_BASE / <span class="hljs-number">2</span>,<span class="hljs-number">10</span>);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> xe = x + w; x &lt; xe; x++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = oy, ye = y + h; y &lt; ye; y++) {
      <span class="hljs-keyword">var</span> tile = mapData[x][y];
      <span class="hljs-keyword">if</span> (tile.visionClient === <span class="hljs-number">0</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">var</span> unit = tile.unit;
      <span class="hljs-keyword">if</span> (!unit) <span class="hljs-keyword">continue</span>;

      <span class="hljs-keyword">var</span> state;
      <span class="hljs-keyword">switch</span> (unit.owner.id) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
          state = cwt.Sprite.UNIT_RED;
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
          state = cwt.Sprite.UNIT_BLUE;
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
          state = cwt.Sprite.UNIT_GREEN;
          <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
          state = cwt.Sprite.UNIT_YELLOW;
          <span class="hljs-keyword">break</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>inverted ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (unit.owner.id % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {
        state += cwt.Sprite.UNIT_STATE_IDLE_INVERTED;
      }

      <span class="hljs-keyword">var</span> sprite = cwt.Image.sprites[unit.type.ID].getImage(state);
      <span class="hljs-keyword">var</span> n = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">while</span> (n &lt; <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">var</span> ctx = layer.getContext(n);

        <span class="hljs-keyword">var</span> scx = (cwt.TILE_BASE * <span class="hljs-number">2</span>) * n;
        <span class="hljs-keyword">var</span> scy = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> scw = cwt.TILE_BASE * <span class="hljs-number">2</span>;
        <span class="hljs-keyword">var</span> sch = cwt.TILE_BASE * <span class="hljs-number">2</span>;
        <span class="hljs-keyword">var</span> tcx = (x-cwt.Screen.offsetX) * cwt.TILE_BASE - halfTileBase;
        <span class="hljs-keyword">var</span> tcy = (y-cwt.Screen.offsetY) * cwt.TILE_BASE - halfTileBase;
        <span class="hljs-keyword">var</span> tcw = cwt.TILE_BASE + cwt.TILE_BASE;
        <span class="hljs-keyword">var</span> tch = cwt.TILE_BASE + cwt.TILE_BASE;

        ctx.drawImage(
          sprite,
          scx, scy,
          scw, sch,
          tcx, tcy,
          tcw, tch
        );

        n++;
      }

    }
  }
};

<span class="hljs-comment">/**
 *
 * Note: this one clears the layer before action
 *
 * @param {number} code
 */</span>
cwt.MapRenderer.shiftUnits = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code)</span> {</span>
  cwt.MapRenderer.shiftLayer(code, cwt.Screen.layerUnit, <span class="hljs-number">3</span>, <span class="hljs-literal">false</span>);
};cwt.MapRenderer.MENU_ELEMENTS_MAX = <span class="hljs-number">10</span>;

<span class="hljs-comment">/**
 * @constant
 * @type {number}
 */</span>
cwt.MapRenderer.MENU_ENTRY_WIDTH = <span class="hljs-number">10</span> * cwt.TILE_BASE;
<span class="hljs-comment">/**
 * @constant
 * @type {number}
 */</span>
cwt.MapRenderer.MENU_ENTRY_HEIGHT = <span class="hljs-number">2</span> * cwt.TILE_BASE;

cwt.MapRenderer.layoutGenericMenu_ = <span class="hljs-keyword">new</span> cwt.UIPositionableButtonGroup();

cwt.MapRenderer.$afterLoad = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>generate elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cwt.repeat(cwt.MapRenderer.MENU_ELEMENTS_MAX, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(i)</span> {</span>
    cwt.MapRenderer.layoutGenericMenu_.addElement(<span class="hljs-keyword">new</span> cwt.UIField(
      <span class="hljs-number">0</span>,
      i * <span class="hljs-number">32</span>,
      cwt.MapRenderer.MENU_ENTRY_WIDTH,
      cwt.MapRenderer.MENU_ENTRY_HEIGHT,
      <span class="hljs-string">"KEY_"</span> + i,
      <span class="hljs-number">8</span>,
      cwt.UIField.STYLE_NORMAL,</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>logic will be handled by the state machine</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      cwt.emptyFunction
    ))
  });
};

<span class="hljs-comment">/**
 * Renders the menu to the background layer of the UI canvas.
 *
 * @param {cwt.InterfaceMenu} menu
 */</span>
cwt.MapRenderer.prepareMenu = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(menu)</span> {</span>
  <span class="hljs-keyword">var</span> gfxMenu = cwt.MapRenderer.layoutGenericMenu_;
  <span class="hljs-keyword">var</span> select = menu.getSelectedIndex();
  <span class="hljs-keyword">var</span> numElements = menu.getSize();

  gfxMenu.setMenuPosition(
    <span class="hljs-built_in">parseInt</span>((cwt.Screen.width / <span class="hljs-number">2</span>) - cwt.MapRenderer.MENU_ENTRY_WIDTH / <span class="hljs-number">2</span>, <span class="hljs-number">10</span>),
    <span class="hljs-built_in">parseInt</span>((cwt.Screen.height / <span class="hljs-number">2</span>) - ((numElements * cwt.MapRenderer.MENU_ENTRY_HEIGHT) / <span class="hljs-number">2</span>), <span class="hljs-number">10</span>)
  );

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i &lt; cwt.MapRenderer.MENU_ELEMENTS_MAX; i++) {
    <span class="hljs-keyword">if</span> (i &lt; numElements) {
      gfxMenu.elements[i].inactive = <span class="hljs-literal">false</span>;
      gfxMenu.elements[i].text = cwt.Localization.forKey(menu.getContent(i));</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>set style</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      gfxMenu.elements[i].style = (
        (numElements === <span class="hljs-number">1</span> ? cwt.UIField.STYLE_NORMAL :
        (i === <span class="hljs-number">0</span> ? cwt.UIField.STYLE_NEW :
        (i === numElements-<span class="hljs-number">1</span> ? cwt.UIField.STYLE_ESW : cwt.UIField.STYLE_EW)))
      );

    } <span class="hljs-keyword">else</span> {
      gfxMenu.elements[i].inactive = <span class="hljs-literal">true</span>;
    }
  }

  <span class="hljs-keyword">this</span>.renderMenu(menu);
};

cwt.MapRenderer.renderMenu = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(menu)</span> {</span>
  cwt.MapRenderer.layoutGenericMenu_.draw(cwt.Screen.layerUI.getContext(<span class="hljs-number">0</span>));
};<span class="hljs-comment">/**
 *
 */</span>
cwt.MapRenderer.renderScreen = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">var</span> time;

  <span class="hljs-keyword">if</span> (cwt.DEBUG) time = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime();

  <span class="hljs-keyword">var</span> x = cwt.Screen.offsetX;
  <span class="hljs-keyword">var</span> y = cwt.Screen.offsetY;
  <span class="hljs-keyword">var</span> w = (cwt.Map.width &lt; cwt.SCREEN_WIDTH)? cwt.Map.width : cwt.SCREEN_WIDTH;
  <span class="hljs-keyword">var</span> h = (cwt.Map.height &lt; cwt.SCREEN_HEIGHT)? cwt.Map.height : cwt.SCREEN_HEIGHT;

  <span class="hljs-keyword">this</span>.renderTiles(x, y, w, h);
  <span class="hljs-keyword">this</span>.renderUnits(x, y, w, h);</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>directly update all layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cwt.Screen.layerMap.renderLayer(<span class="hljs-keyword">this</span>.indexMapAnimation);
  cwt.Screen.layerUnit.renderLayer(<span class="hljs-keyword">this</span>.indexUnitAnimation);

  <span class="hljs-keyword">this</span>.renderFogRect(x, y, w, h);

  <span class="hljs-keyword">if</span> (cwt.DEBUG) console.log(<span class="hljs-string">"rendered the complete screen ("</span> + ((<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime() - time) + <span class="hljs-string">"ms)"</span>);
};

<span class="hljs-comment">/**
 *
 * @param {number} code
 */</span>
cwt.MapRenderer.shiftMap = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(code, selection)</span> {</span>
  <span class="hljs-keyword">var</span> time;

  <span class="hljs-keyword">if</span> (cwt.DEBUG) time = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime();

  <span class="hljs-keyword">var</span> fx = cwt.Screen.offsetX;
  <span class="hljs-keyword">var</span> fy = cwt.Screen.offsetY;
  <span class="hljs-keyword">var</span> fw = cwt.SCREEN_WIDTH;
  <span class="hljs-keyword">var</span> fh = cwt.SCREEN_HEIGHT;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>extract needed data for the shift process</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">switch</span> (code) {
    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_LEFT:
      fx += cwt.SCREEN_WIDTH - <span class="hljs-number">1</span>;
      fw = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_RIGHT:
      fw = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_UP:
      fy += cwt.SCREEN_HEIGHT - <span class="hljs-number">1</span>;
      fh = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> cwt.Move.MOVE_CODES_DOWN:
      fh = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>shift screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.shiftTiles(code);
  <span class="hljs-keyword">this</span>.shiftUnits(code);
  <span class="hljs-keyword">this</span>.shiftFog(code);
  <span class="hljs-keyword">if</span> (cwt.Gameflow.globalData.focusActive) <span class="hljs-keyword">this</span>.shiftFocus(code);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>fill created hole</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">this</span>.renderTiles(fx, fy, fw, fh);
  <span class="hljs-keyword">this</span>.renderUnits(fx, fy, fw, fh);
  <span class="hljs-keyword">this</span>.renderFogRect(fx, fy, fw, fh);
  <span class="hljs-keyword">if</span> (cwt.Gameflow.globalData.focusActive) <span class="hljs-keyword">this</span>.renderFocus(fx, fy, fw, fh, selection);</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>fix overlay when screen moves down</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (code === cwt.Move.MOVE_CODES_DOWN) {
    <span class="hljs-keyword">this</span>.renderTileOverlayRow();
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>directly update all layers</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cwt.Screen.layerMap.renderLayer(<span class="hljs-keyword">this</span>.indexMapAnimation);
  cwt.Screen.layerUnit.renderLayer(<span class="hljs-keyword">this</span>.indexUnitAnimation);
  <span class="hljs-keyword">if</span> (cwt.Gameflow.globalData.focusActive) cwt.Screen.layerFocus.renderLayer(<span class="hljs-keyword">this</span>.indexFocus);

  <span class="hljs-keyword">if</span> (cwt.DEBUG) console.log(<span class="hljs-string">"shifted the screen ("</span> + ((<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime() - time) + <span class="hljs-string">"ms)"</span>);
};<span class="hljs-comment">/**
 * @type {null|HTMLCanvasElement}
 * @private
 */</span>
cwt.MapRenderer.tmpCanv_ = <span class="hljs-literal">null</span>;

<span class="hljs-comment">/**
 * Returns a temporary canvas (singleton)
 *
 * @return {HTMLCanvasElement}
 */</span>
cwt.MapRenderer.getTempCanvas = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.tmpCanv_) {
    <span class="hljs-keyword">this</span>.tmpCanv_ = document.createElement(<span class="hljs-string">"canvas"</span>);
    <span class="hljs-keyword">this</span>.tmpCanv_.width = cwt.Screen.width;
    <span class="hljs-keyword">this</span>.tmpCanv_.height = cwt.Screen.height;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.tmpCanv_;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>