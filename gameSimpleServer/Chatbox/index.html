<!-- This the the client side HTML code sent to all clients in the chat service -->

<html>
	<head>
		<title>Chat with socket.io and node.js</title>
		<!-- Gives a height to the chat window (should be in own CSS file) -->
		
		<!-- To capture span . -->
		<!-- To capture tags # -->
		<style>
			
			#chat{
				height:500px;
			}
			
			#contentWrap{
				display: none;
			}
			
			#chatWrap{
				float: left;
				border: 1px #000 solid;
			}
			
			.error{
				color: red;
			}
			
			.whisper{
				color: gray;
				font-style: italic;
			}
		</style>
	</head>
	<body>
	
		<!-- This is the code to create a user nickname -->
		<div id="nickWrap">
			<!-- Used in case of duplicate user names -->
			<!-- Useful for producing different types of errors -->
			<p id="nickError"></p>
			<!-- A form for submitting a username -->
			<p>Enter a User Name:</p>
			<form id="setNick">
				<input size="35" id="nickname"></input>
				<input type="submit"></input>
			</form>
		</div>
		
		<!-- This wraps all the chat in a div where it can be hidden from view if needed -->
		<div id="contentWrap">
		
			<!-- Wraps the chat in a div where it can be hidden from view if needed -->
			<div id="chatWrap">
				<!-- This is where all the chat messages will go (Blank to start) -->
				<div id="chat"></div>
				
				<!-- Simple form used to send messages -->
				<form id="send-message">
					<input size="35" id="message"></input>
					<input type="submit"></input>
				</form>
			</div>
			
			<!-- This holds all the users that are in the chat room currently -->
			<div id="users"></div>
		</div>
		
		<!-- JQuery makes everything easier to create, latest version here -->
		<script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<!-- Auto generated file from socket.io when activated -->
		<script src="/socket.io/socket.io.js"></script>
		
		<!-- This contains the scripts that send the messages to the server -->
		<script>
			<!-- shorthand for document.ready - Runs when everything finishes loading -->
			<!-- Everything regarding the server has to be written in here -->
			jQuery(function($){
				<!-- Connects to the socket --> 
				var socket = io.connect();
				
				<!-- Grabs the entire Send Message form -->
				var $messageForm = $('#send-message');
				<!-- Grabs the Message Box of the Send Message Form -->
				var $messageBox = $('#message');
				<!-- Grabs the Chat Box -->
				<!-- It is usually customary to not cache this variable, but it is -->
				<!-- less weight on server if this variable is cached (faster) -->
				var $chat = $('#chat');
				
				<!-- Each time a message is submitted, use jQuery to send to server -->
				$messageForm.submit(function(e){
					<!-- jQuery prevents the submit from default action -->
					<!-- Default for submit: submitting and refreshing page -->
					e.preventDefault();
					<!-- This sends the actual message code to the server using "new message" command -->
					<!-- The first parameter is the command, the second is the message -->
					<!-- The second message can have an object like {name:"ctomni", msg:"hello"} -->
					<!-- socket.emit('send message', $messageBox.val()); update below -->
					socket.emit('send message', $messageBox.val(), function(data){
						//Holds an error message for the Message Box
						//The span allows for injection of CSS data
						$chat.append('<span class="error"><b>' + data + '</b></span><br/>' );
					});
					<!-- Clears the message box -->
					$messageBox.val('');
				});
				
				<!-- Grabs the entire nickname Form -->
				var $nickForm = $('#setNick');
				<!-- Grabs the error handler of the nickname -->
				var $nickError = $('#nickError');
				<!-- Grabs the user name -->
				var $nickBox = $('#nickname');
				
				<!--When the user name is submitted, use jQuery to change display -->
				$nickForm.submit(function(e){
					<!-- jQuery prevents the submit from default action -->
					<!-- Default for submit: submitting and refreshing page -->
					e.preventDefault();
					
					<!-- A little different from sending a message as it has call back functionality -->
					<!-- The callback is used to check for wrong user names and generate an error -->
					socket.emit('new user', $nickBox.val(), function(data){
						<!-- Grabs the callback from server 'new user' -->
						<!-- If true: hide the nickname and show the chat box -->
						if(data){
							$('#nickWrap').hide();
							$('#contentWrap').show();
						} 
						<!-- If false: Show an error message -->
						else {
							<!-- html: Used to replace whatever is there already -->
							$nickError.html('That user name is already taken: Try Again.');
						}
					});
					<!-- Clears the value for the nickBox whether it is valid or not -->
					$nickBox.val('');
				});
				
				var $users = $('#users');
				
				<!-- Used to display all the users on this particular chat -->
				socket.on('usernames', function(data){
					<!-- This holds an empty String representing the users -->
					var html = '';
					<!-- This generates the list of users -->
					for(i = 0; i < data.length; i++){
						html += data[i] + '<br />'
					}
					<!-- This finalizes the list and sends it to be displayed -->
					$users.html(html);
				});
				
				<!-- This grabs the 'new message' command from the server side for display -->
				<!-- This will be used to display new messages -->
				socket.on('new message', function(data){
					//This appends new data onto the chat message using jQuery and inserts a newline
					//$chat.append(data + "<br />");
					//Updated to include a nickname and message data
					//$chat.append( '<b>' + data.nick + ': </b>' + data.msg + '<br/>' ); no span
					//The span allows for injection of CSS data
					$chat.append('<span class="msg"><b>' + data.nick + ': </b>' 
													+ data.msg + '</span><br/>' );
				});
				
				<!-- This grabs the 'whisper' command from the server side for display -->
				<!-- This will be used to display a whisper message -->
				socket.on('whisper', function(data){
					//This includes all functionality to display a whisper
					//span allows you to inject CSS into it
					$chat.append('<span class="whisper"><b>' + data.nick + ': </b>' 
													+ data.msg + '</span><br/>' );
				});
			});
		</script>
	</body>
</html>