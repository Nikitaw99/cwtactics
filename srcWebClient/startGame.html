<!DOCTYPE HTML>
<html manifest="cache.manifest" >

  <!-- ##################################################################################### -->

  <head>
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, , maximum-scale=1, user-scalable=no" />
  </head>

  <!-- ##################################################################################### -->

  <!-- PART OF THE PROGRAM LOADER -->
  <script>

    // jWorkflow.js
// (c) 2010 tinyHippos inc.
// jWorkflow is freely distributable under the terms of the MIT license.
// Portions of jWorkflow are inspired by Underscore.js
    var jWorkflow = (function(){
      function _valid( func ){
        if( typeof(func) !== 'function' ) {
          throw "expected function but was " + typeof(func);
        }
      }

      function _isWorkflow( func ){
        return typeof func.andThen === 'function' &&
          typeof func.start === 'function' &&
          typeof func.chill === 'function';
      }

      function _isArray( func ){
        return !!func.map && !!func.reduce;
      }

      var transfunctioner = {
        order: function( func, context ){
          var _workflow = [ ],
            _tasks,
            _callback = null,
            _baton = (function(){
            var _taken = false;
            return {
              take: function(){
                _taken = true;
              },
              pass: function( result ){
                var task;
                _taken = false;

                if( _tasks.length ) {
                  task = _tasks.shift();
                  result = task.func.apply( task.context, [ result, _baton ] );

                  if( !_taken ) {
                    _baton.pass( result );
                  }
                }
                else {
                  if( _callback.func ) {
                    _callback.func.apply( _callback.context, [ result ] );
                  }
                }
              },
              drop: function( result ){
                _taken = true;
                _tasks = [ ];
                setTimeout( function(){
                  _baton.pass( result );
                }, 1 );
              }
            };
          }()),
            _self = {
            andThen: function( func, context ){
              if( _isWorkflow( func ) ) {
                var f = function( prev, baton ){
                  baton.take();
                  func.start( {
                    callback: function( result ){
                      baton.pass( result );
                    },
                    context: context,
                    initialValue: prev
                  } );
                };
                _workflow.push( {func: f,
                  context: context} );
              }
              else if( _isArray( func ) ) {
                var orch = function( prev, baton ){
                  baton.take();

                  var l = func.length,
                    join = function(){
                    return --l || baton.pass();
                  };

                  func.forEach( function( f ){
                    jWorkflow.order( f ).start( join );
                  } );
                };
                _workflow.push( {func: orch,
                  context: context} );
              }
              else {
                _valid( func );
                _workflow.push( {func: func,
                  context: context} );
              }
              return _self;
            },
            chill: function( time ){
              return _self.andThen( function( prev, baton ){
                baton.take();
                setTimeout( function(){
                  baton.pass( prev );
                }, time );
              } );
            },
            start: function(){
              var callback,
                context,
                initialValue;

              if( arguments[0] && typeof arguments[0] === 'object' ) {
                callback = arguments[0].callback;
                context = arguments[0].context;
                initialValue = arguments[0].initialValue;
              }
              else {
                callback = arguments[0];
                context = arguments[1];
              }

              _callback = {func: callback,
                context: context};
              _tasks = _workflow.slice();
              _baton.pass( initialValue );
            }
          };

          return func ? _self.andThen( func, context ) : _self;
        }
      };

      return transfunctioner;
    }());

    if( typeof module === "object" && typeof require === "function" ) {
      module.exports = jWorkflow;
    }

    (function(){

      var xmlHttpReq;
      try {
        new XMLHttpRequest();
        xmlHttpReq = true;
      } catch(ex) {
        xmlHttpReq = false;
      }

      // Check if a new cache is available on page load.
      window.addEventListener( 'load', function( e ){

        window.applicationCache.addEventListener( 'updateready', function( e ){
          if( window.applicationCache.status == window.applicationCache.UPDATEREADY ) {

            // Browser downloaded a new app cache.
            // Swap it in and reload the page to get the new hotness.
            window.applicationCache.swapCache();
            if( confirm( 'A new version of this site is available. Load it?' ) ) {
              window.location.reload();
            }
          } else {
            // Manifest didn't changed. Nothing new to server.
          }
        }, false );

      }, false );

      // The manifest returns 404 or 410, the download failed,
      // or the manifest changed while the download was in progress.
      window.applicationCache.addEventListener( 'error', function(){
        alert( "could not download the game data into the offline storage" );
      }, false );

      // FROM http://stackoverflow.com/questions/979975/how-to-get-the-value-from-url-parameter
      function getQueryParams( qs ){
        qs = qs.split( "+" ).join( " " );

        var params = {}, tokens, re = /[?&]?([^=]+)=([^&]*)/g;

        while(tokens = re.exec( qs )) {
          params[decodeURIComponent( tokens[1] )] = decodeURIComponent( tokens[2] );
        }

        return params;
      }

      function reqListener(){
        if( this.readyState == 4 ) {
          // FINE
          if( this.readyState == 4 && this.status == 200 ) {

            // JSON OBJECT
            if( this.asJSON ) {

              try {
                this.winCallback( JSON.parse( this.responseText ) );
              }
              // FAILED TO CONVERT JSON TEXT
              catch(e) {
                this.failCallback( e );
              }
            }
            // PLAIN TEXT
            else {
              this.winCallback( this.responseText );
            }
          }
          // ERROR
          else {
            this.failCallback( this.statusText );
          }
        }
      }

      function grabRemoteFile( options ){
        var oReq;

        // GENERATE REQUEST OBJECT
        if( xmlHttpReq ) oReq = new XMLHttpRequest();
        else oReq = new ActiveXObject( "Microsoft.XMLHTTP" );

        // WIN / FAIL CALLBACK
        oReq.asJSON = options.json;
        oReq.winCallback = options.success;
        oReq.failCallback = options.error;

        // META DATA
        oReq.onreadystatechange = reqListener;
        oReq.open( "get", options.path, true );

        // SEND IT
        oReq.send();
      }

      var parameters = getQueryParams( document.location.search );

      // Define some basic global stuff
      CWT_DEBUG = (parameters.debugMode === "true");

      CWT_IS_UP_TO_DATE = function(){

      };

      CWT_UPDATE_PROGRAM_FILES = function(){
        var server = (CWT_DEBUG) ? "localhost:8000" : "ctomni231.github.io/cwtactics";

        var engineDeps = server + "/dist/normal/engineDeps.js";
        var clientDeps = server + "/dist/normal/clientDeps.js";
        var engine = server + "/dist/normal/engine.js";
        var client = server + "/dist/normal/client.js";
        var body = server + "/dist/normal/body.html";
        var style = server + "/dist/normal/style.css";

        function error(){
          alert( "could not grab program files!" );
        }

        // --- GRAB ENGINE DEPS ---
        grabRemoteFile( {
          path: engineDeps,
          failCallback: error,
          winCallback: function( text ){
            localStorage.cwt_prog_eng_deps = text;
            eval( text );

            // --- GRAB CLIENT DEPS ---
            grabRemoteFile( {
              path: clientDeps,
              failCallback: error,
              winCallback: function( text ){
                localStorage.cwt_prog_clt_deps = text;
                eval( text );

                // --- GRAB ENGINE ---
                grabRemoteFile( {
                  path: engine,
                  failCallback: error,
                  winCallback: function( text ){
                    localStorage.cwt_prog_eng = text;
                    eval( text );

                    // --- GRAB CLIENT ---
                    grabRemoteFile( {
                      path: client,
                      failCallback: error,
                      winCallback: function( text ){
                        localStorage.cwt_prog_clt = text;
                        eval( text );

                        // --- GRAB BODY ---
                        grabRemoteFile( {
                          path: body,
                          failCallback: error,
                          winCallback: function( text ){
                            localStorage.cwt_body = text;

                            document.getElementsByTagName( "body" )[0].innerHTML = text;

                            // --- GRAB STYLE ---
                            grabRemoteFile( {
                              path: body,
                              failCallback: error,
                              winCallback: function( text ){
                                localStorage.cwt_style = text;

                                var el = document.createElement( "style" );
                                el.innerHTML = text;

                                document.getElementsByTagName( "html" )[0].appendChild( el );
                              }} )
                          }} )
                      }} )
                  }} )
              }} )
          }} );
      };

    })();

  </script>

  <!-- ##################################################################################### -->

  <body onLoad="controller.screenStateMachine.event( 'start' );" oncontextmenu="return false;" >



  </body>  

</html>