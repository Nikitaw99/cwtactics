<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: flow/ingame_menu.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: flow/ingame_menu.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>cwt.Gameflow.addInGameState({
  id: "INGAME_MENU",

  // create game round data in global data scope
  init: function () {
    var gameData = this.globalData;

    /**
     * Selected game action.
     *
     * @memberOf cwt.Gameflow.globalData
     */
    gameData.action = {

      /**
       * Selected sub action object.
       */
      selectedEntry: null,

      /**
       * Selected sub action object.
       */
      selectedSubEntry: null,

      /**
       * Action object that represents the selected action.
       */
      object: null
    };

    /**
     * Game menu.
     *
     * @memberOf cwt.Gameflow.globalData
     * @implements {cwt.InterfaceMenu.&lt;String>}
     */
    gameData.menu = {

      getSelectedIndex: function () {
        return this.selectedIndex;
      },

      /**
       * @type {cwt.CircularBuffer.&lt;String>}
       */
      entries_: new cwt.CircularBuffer(),

      /**
       * @type {cwt.CircularBuffer.&lt;boolean>}
       */
      enabled_: new cwt.CircularBuffer(),

      selectedIndex: 0,

      getContent: function (index) {
        if (arguments.length === 0) {
          index = this.selectedIndex;
        }
        return this.entries_.get(index);
      },

      getSize: function () {
        return this.enabled_.size;
      },

      /**
       *
       * @return {boolean}
       */
      isEnabled: function () {
        return this.enabled_.get(this.selectedIndex) === true;
      },

      clean: function () {
        this.enabled_.clear();
        this.entries_.clear();
        this.selectedIndex = 0;
      },

      addEntry: function (content, enabled) {
        this.entries_.push(content);
        this.enabled_.push(enabled);
      },

      commandKeys_: null,

      checkRelation_: function (action,relationList,sMode,stMode) {
        var checkMode;

        switch (relationList[1]) {
          case "T" :
            checkMode = sMode;
            break;

          case "ST" :
            checkMode = stMode;
            break;

          default :
            checkMode = null;
        }

        for (var si = 2, se = action.relationToProp.length; si &lt; se; si++) {
          if (action.relationToProp[si] === checkMode) {
            return true;
          }
        }

        return false;
      },

      /**
       * Generates the action menu based on the given position data.
       */
      generate: function () {
        if (!this.commandKeys) {
          this.commandKeys = cwt.Action.getRegisteredNames();
        }

        var st_mode;
        var sst_mode;
        var pr_st_mode;
        var pr_sst_mode;
        var sPos = gameData.source;
        var tPos = gameData.target;
        var tsPos = gameData.targetselection;
        var ChkU = cwt.Relationship.CHECK_UNIT;
        var ChkP = cwt.Relationship.CHECK_PROPERTY;
        var sProp = sPos.property;
        var sUnit = sPos.unit;
        var unitActable = (!(!sUnit || sUnit.owner !== cwt.Gameround.turnOwner || !sUnit.canAct));
        var propertyActable = (!(sUnit || !sProp || sProp.owner !== cwt.Gameround.turnOwner || sProp.type.blocker));
        var mapActable = (!unitActable &amp;&amp; !propertyActable);

        // check_ all game action objects and fill menu
        for (var i = 0, e = this.commandKeys.length; i &lt; e; i++) {
          var action = cwt.Action.getActionObject(this.commandKeys[i]);

          switch (action.type) {

            case cwt.Action.CLIENT_ACTION:
              // TODO: ai check
              if (!mapActable || cwt.Player.activeClientPlayer !== cwt.Gameround.turnOwner) {
                continue;
              }
              break;

            case cwt.Action.PROPERTY_ACTION:
              if (!propertyActable) {
                continue;
              }
              break;

            case cwt.Action.MAP_ACTION:
              if (!mapActable) {
                continue;
              }
              break;

            case cwt.Action.UNIT_ACTION:
              if (!unitActable) {
                continue;
              }

              // extract relationships
              if (st_mode === void 0) {
                st_mode = cwt.Relationship.getRelationShipTo(sPos, tPos, ChkU, ChkU);
                sst_mode = cwt.Relationship.getRelationShipTo(sPos, tsPos, ChkU, ChkU);
                pr_st_mode = cwt.Relationship.getRelationShipTo(sPos, tPos, ChkU, ChkP);
                pr_sst_mode = cwt.Relationship.getRelationShipTo(sPos, tsPos, ChkU, ChkP);
              }

              // relation to unit
              if (action.relation) {
                if (!this.checkRelation_(action,action.relation,st_mode,sst_mode)) {
                  continue;
                }
              }

              // relation to property
              if (action.relationToProp) {
                if (!this.checkRelation_(action,action.relationToProp,pr_st_mode,pr_sst_mode)) {
                  continue;
                }
              }
              break;
          }

          // if condition matches then add the entry to the menu list
          if (action.condition &amp;&amp; action.condition(gameData) !== false) {
            gameData.menu.addEntry(this.commandKeys[i], true)
          }
        }
      }
    };
  },

  enter: function (gameData) {
    gameData.menu.clean();
    gameData.menu.generate();

    // go back when no entries exists
    if (!gameData.menu.getSize()) {
      cwt.Gameflow.changeState("INGAME_IDLE");
    }
  },

  UP: function (gameData) {
    if (gameData.menu.selectedIndex > 0) {
      gameData.menu.selectedIndex--;
    }
  },

  DOWN: function (gameData) {
    if (gameData.menu.selectedIndex &lt; gameData.menu.getSize() - 1) {
      gameData.menu.selectedIndex++;
    }
  },

  ACTION: function (gameData) {
    var actName = gameData.menu.getContent();
    var actObj = cwt.Action.getActionObject(actName);

    // select action in data
    gameData.action.selectedEntry = actName;
    gameData.action.object = actObj;

    // calculate next state from the given action object
    var next = null;
    if (actObj.prepareMenu !== null) {
      next = "INGAME_SUBMENU";
    } else if (actObj.isTargetValid !== null) {
      next = "INGAME_SELECT_TILE";
    } else if (actObj.prepareTargets !== null &amp;&amp; actObj.targetSelectionType === "A") {
      next = "INGAME_SELECT_TILE_TYPE_A";
    } else {
      next = "INGAME_FLUSH_ACTION";
    }

    if (cwt.DEBUG) cwt.assert(next);
    cwt.Gameflow.changeState(next);
  },

  CANCEL: function (gameData) {
    var unit = gameData.source.unit;
    var next = null;

    if (unit &amp;&amp; unit.owner.activeClientPlayer) {
      // unit was selected and it is controlled by the active player, so it means that this unit
      // is the acting unit -> go back to INGAME_MOVEPATH state without erasing the existing move data

      gameData.preventMovePathGeneration = true;
      next = "INGAME_MOVEPATH";

    } else {
      next = "INGAME_IDLE";
    }

    if (cwt.DEBUG) cwt.assert(next);
    cwt.Gameflow.changeState(next);
  }
});</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="$base.html">base/$base</a></li></ul><h3>Classes</h3><ul><li><a href="cwt.Action.html">Action</a></li><li><a href="cwt.ActionData.html">ActionData</a></li><li><a href="cwt.CircularBuffer.html">CircularBuffer</a></li><li><a href="cwt.Config.html">Config</a></li><li><a href="cwt.GameState.html">GameState</a></li><li><a href="cwt.Input.html">Input</a></li><li><a href="cwt.InputData.html">InputData</a></li><li><a href="cwt.Layer.html">Layer</a></li><li><a href="cwt.LayeredCanvas.html">LayeredCanvas</a></li><li><a href="cwt.Matrix.html">Matrix</a></li><li><a href="cwt.MovetypeSheet.html">MovetypeSheet</a></li><li><a href="cwt.Pagination.html">Pagination</a></li><li><a href="cwt.Player.html">Player</a></li><li><a href="cwt.Position.html">Position</a></li><li><a href="cwt.Property.html">Property</a></li><li><a href="cwt.html#Sprite">Sprite</a></li><li><a href="cwt.Storage.html">Storage</a></li><li><a href="cwt.Tile.html">Tile</a></li><li><a href="cwt.TileVariantInfo.html">TileVariantInfo</a></li><li><a href="cwt.UIButtonGroup.html">UIButtonGroup</a></li><li><a href="cwt.UICheckboxField.html">UICheckboxField</a></li><li><a href="cwt.UICustomField.html">UICustomField</a></li><li><a href="cwt.UIField.html">UIField</a></li><li><a href="cwt.UIScreenLayout.html">UIScreenLayout</a></li><li><a href="cwt.Unit.html">Unit</a></li></ul><h3>Namespaces</h3><ul><li><a href="cwt.ActionStack.html">ActionStack</a></li><li><a href="cwt.Attack.html">Attack</a></li><li><a href="cwt.Cannon.html">Cannon</a></li><li><a href="cwt.Capture.html">Capture</a></li><li><a href="cwt.ClientEvents.html">ClientEvents</a></li><li><a href="cwt.CO.html">CO</a></li><li><a href="cwt.Cursor.html">Cursor</a></li><li><a href="cwt.Explode.html">Explode</a></li><li><a href="cwt.Factory.html">Factory</a></li><li><a href="cwt.FlowData.menu.html">menu</a></li><li><a href="cwt.Fog.html">Fog</a></li><li><a href="cwt.GameData.html">GameData</a></li><li><a href="cwt.Gameflow.html">Gameflow</a></li><li><a href="cwt.Gameround.html">Gameround</a></li><li><a href="cwt.Image.html">Image</a></li><li><a href="cwt.Join.html">Join</a></li><li><a href="cwt.Laser.html">Laser</a></li><li><a href="cwt.Lifecycle.html">Lifecycle</a></li><li><a href="cwt.Loading.html">Loading</a></li><li><a href="cwt.Localization.html">Localization</a></li><li><a href="cwt.Map.html">Map</a></li><li><a href="cwt.MapRenderer.html">MapRenderer</a></li><li><a href="cwt.Maps.html">Maps</a></li><li><a href="cwt.Move.html">Move</a></li><li><a href="cwt.Network.html">Network</a></li><li><a href="cwt.Options.html">Options</a></li><li><a href="cwt.Relationship.html">Relationship</a></li><li><a href="cwt.Screen.html">Screen</a></li><li><a href="cwt.Silo.html">Silo</a></li><li><a href="cwt.Supply.html">Supply</a></li><li><a href="cwt.Team.html">Team</a></li><li><a href="cwt.Transport.html">Transport</a></li><li><a href="cwt.Turn.html">Turn</a></li><li><a href="cwt.Weather.html">Weather</a></li></ul><h3>Global</h3><ul><li><a href="global.html#background">background</a></li><li><a href="global.html#check_">check_</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#getContext">getContext</a></li><li><a href="global.html#getLayer">getLayer</a></li><li><a href="global.html#isValidSheet">isValidSheet</a></li><li><a href="global.html#registerSheet">registerSheet</a></li><li><a href="global.html#renderLayer">renderLayer</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#resetValues">resetValues</a></li><li><a href="global.html#sheets">sheets</a></li><li><a href="global.html#types">types</a></li><li><a href="global.html#validator_">validator_</a></li><li><a href="global.html#value[2]">value[2]</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a> on Fri May 16 2014 19:01:55 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
