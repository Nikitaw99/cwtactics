<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controller/audio.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: controller/audio.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>cwt.Audio = {

  /**
   * Storage parameter for sfx volume.
   */
  SFX_STORAGE_PARAMETER: "volume_sfx",

  /**
   * Storage parameter for music volume.
   */
  MUSIC_STORAGE_PARAMETER: "music_sfx",

  /**
   * Initializes the audio context.
   */
  initialize: function (p, b) {

    // if audio sfx and music is deactivated then do not initialize the audio context
    if (!controller.features_client.audioSFX &amp;&amp; !controller.features_client.audioMusic) {
      return;
    }

    try {

      // construct new context
      if (window.AudioContext) {
        this.context_ = new window.AudioContext();
      } else if (window.webkitAudioContext) {
        this.context_ = new window.webkitAudioContext();
      } else throw Error("no AudioContext constructor found");

      // construct audio nodes
      this.gainNode_sfx_ = this.context_.createGainNode();
      this.gainNode_sfx_.gain.value = 1;
      this.gainNode_sfx_.connect(this.context_.destination);
      this.gainNode_music_ = this.context_.createGainNode();
      this.gainNode_music_.gain.value = 0.5;
      this.gainNode_music_.connect(this.context_.destination);

      // load volume from config
      controller.storage_general.get(this.SFX_STORAGE_PARAMETER, function (obj) {
        if (obj) this.gainNode_sfx_.gain.value = obj.value;
      });
      controller.storage_general.get(this.MUSIC_STORAGE_PARAMETER, function (obj) {
        if (obj) this.gainNode_music_.gain.value = obj.value;
      });
    }
    catch (e) {
      if (DEBUG) console.error("could not grab audio context (Error:", e, ")");
    }

    // remove initializer
    cwt.Audio.initialize = null;
  },

  /**
   * WebAudio context object.
   */
  context_: null,

  /**
   * Music audio node.
   */
  gainNode_music_: null,

  /**
   * SFX audio node.
   */
  gainNode_sfx_: null,

  /**
   * Returns a web audio context. If no context is initialized then it will be created first.
   */
  grabContext: function () {
    return controller.audio_ctx_;
  },

  buffer_: {},

  currentMusic_: null,

  currentMusicId_: null,

  registerAudioBuffer: function (id, buff) {
    if (DEBUG) util.log("register", id, "in the audio cache");

    controller.audio_buffer_[id] = buff;
  },

  /**
   * Loads a sound into the audio system
   */
  loadByArrayBuffer: function (id, audioData, callback) {
    assert(util.isString(id));

    if (DEBUG) util.log("decode audio data of", id);

    controller.audio_grabContext().decodeAudioData(audioData,

      // success handling
      function (buffer) {
        controller.audio_registerAudioBuffer(id, buffer);
        if (callback) callback(true, id);
      },

      // error handling
      function (e) {
        if (callback) callback(false, id);
      }
    );
  },

  /**
   * Removes a buffer from the cache.
   */
  unloadBuffer: function (id) {
    assert(util.isString(id));

    if (DEBUG) util.log("de-register", id, "from the audio cache");

    delete controller.audio_buffer_[id];
  },

  isBuffered: function (id) {
    return controller.audio_buffer_.hasOwnProperty(id);
  },

  /**
   * Returns the value of the sfx audio node.
   */
  getSfxVolume: function () {
    if (!controller.audio_ctx_) return;

    return controller.audio_gainNode_sfx_.gain.value;
  },

  /**
   * Returns the value of the music audio node.
   */
  getMusicVolume: function () {
    if (!controller.audio_ctx_) return;

    return controller.audio_gainNode_music_.gain.value;
  },

  /**
   * Sets the value of the sfx audio node.
   */
  setSfxVolume: function (vol) {
    if (!controller.audio_ctx_) return;

    if (vol &lt; 0) vol = 0;
    else if (vol > 1) vol = 1;

    controller.audio_gainNode_sfx_.gain.value = vol;
  },

  /**
   * Sets the value of the music audio node.
   */
  setMusicVolume: function (vol) {
    if (!controller.audio_ctx_) return;

    if (vol &lt; 0) vol = 0;
    else if (vol > 1) vol = 1;

    controller.audio_gainNode_music_.gain.value = vol;
  },

  /**
   * Saves the configurations for the audio output.
   */
  saveConfigs: function () {

    // sfx
    if (controller.audio_gainNode_sfx_) {
      controller.storage_general.set(
        controller.audio_SFX_STORAGE_PARAMETER,
        controller.audio_gainNode_sfx_.gain.value
      );
    }

    // music
    if (controller.audio_gainNode_music_) {
      controller.storage_general.set(
        controller.audio_MUSIC_STORAGE_PARAMETER,
        controller.audio_gainNode_music_.gain.value
      );
    }
  },

  /**
   * Plays a sound effect.
   */
  playSound: function (id, loop, isMusic) {
    if (!this.context_) return;

    // buffered ?
    if (!this.buffer_[id]) return;

    var gainNode = (isMusic) ? this.gainNode_music_ : this.gainNode_sfx_;
    var source = this.context_.createBufferSource();

    if (loop) source.loop = true;
    source.buffer = this.buffer_[id];
    source.connect(gainNode);
    source.noteOn(0);

    return source;
  },

  /**
   * Plays an empty sound buffer. Useful to
   * initialize the audio system.
   */
  playNullSound: function () {
    if (!this.context_) return;

    var buffer = this.context_.createBuffer(1, 1, 22050);
    var source = this.context_.createBufferSource();

    source.buffer = buffer;
    source.connect(this.context_.destination);
    source.noteOn(0);
  },

  /**
   * Plays a background music.
   */
  playMusic: function (id) {
    if (!this.context_) return;

    // already playing this music ?
    if (this.currentMusicId_ === id) return;

    // buffered ?
    if (!this.buffer_[id]) return;

    this.stopMusic();

    this.currentMusic_ = this.playSound(id, true, true);
    this.currentMusicId_ = id;
  },

  /**
   * Stop existing background music.
   */
  stopMusic: function () {

    // disable current music
    if (this.currentMusic_) {
      this.currentMusic_.noteOff(0);
      this.currentMusic_.disconnect(0);
    }

    this.currentMusic_ = null;
    this.currentMusicId_ = null;
  },

  playLoadedMusic_: function (_, id) {
    controller.audio_playMusic(id);
    if (view.hasInfoMessage()) view.message_closePanel(1000);
  },

  storeAudio_: function (obj) {
    var audioData = Base64Helper.decodeBuffer(obj.value);
    controller.audio_loadByArrayBuffer(
      obj.key,
      audioData,
      this.playLoadedMusic_
    );
  },

  loadAudio_: function (key) {
    controller.storage_assets.get(
      key,
      this.storeAudio_
    );
  },

  playCoMusic: function (id) {
    if (!id) {
      if (view.hasInfoMessage()) view.message_closePanel(1000);
      return;
    }

    if (!this.isBuffered(id)) {
      this.loadAudio_(id);
    } else {
      this.playLoadedMusic_(false, id);
    }
  }
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="cwt.Action.html">Action</a></li><li><a href="cwt.Config.html">Config</a></li><li><a href="cwt.FogMap.html">FogMap</a></li><li><a href="cwt.Map.html">Map</a></li><li><a href="cwt.Multiton.html">Multiton</a></li><li><a href="cwt.Player.html">Player</a></li><li><a href="cwt.Position.html">Position</a></li><li><a href="cwt.Property.html">Property</a></li><li><a href="cwt.screeFlowState.html">screeFlowState</a></li><li><a href="cwt.Storage.html">Storage</a></li><li><a href="cwt.Tile.html">Tile</a></li><li><a href="cwt.Unit.html">Unit</a></li></ul><h3>Namespaces</h3><ul><li><a href="Base64Helper.html">Base64Helper</a></li><li><a href="cwt.html">cwt</a></li><li><a href="cwt.Attack.html">Attack</a></li><li><a href="cwt.Cannon.html">Cannon</a></li><li><a href="cwt.Client.html">Client</a></li><li><a href="cwt.ClientEvents.html">ClientEvents</a></li><li><a href="cwt.CO.html">CO</a></li><li><a href="cwt.Cursor.html">Cursor</a></li><li><a href="cwt.Factory.html">Factory</a></li><li><a href="cwt.Fog.html">Fog</a></li><li><a href="cwt.Gameround.html">Gameround</a></li><li><a href="cwt.Join.html">Join</a></li><li><a href="cwt.Laser.html">Laser</a></li><li><a href="cwt.MoveTrait.html">MoveTrait</a></li><li><a href="cwt.Silo.html">Silo</a></li><li><a href="cwt.Suicide.html">Suicide</a></li><li><a href="cwt.Supply.html">Supply</a></li><li><a href="cwt.Team.html">Team</a></li><li><a href="cwt.Transport.html">Transport</a></li><li><a href="cwt.Update.html">Update</a></li><li><a href="cwt.Weather.html">Weather</a></li></ul><h3>Global</h3><ul><li><a href="global.html#action">action</a></li><li><a href="global.html#assert">assert</a></li><li><a href="global.html#canBeCapturedBy">canBeCapturedBy</a></li><li><a href="global.html#captureProperty">captureProperty</a></li><li><a href="global.html#clean">clean</a></li><li><a href="global.html#condition">condition</a></li><li><a href="global.html#constructor">constructor</a></li><li><a href="global.html#data">data</a></li><li><a href="global.html#deactivate">deactivate</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#drainFuel">drainFuel</a></li><li><a href="global.html#fireLaser">fireLaser</a></li><li><a href="global.html#getFreeUnitSlot">getFreeUnitSlot</a></li><li><a href="global.html#getRelationship">getRelationship</a></li><li><a href="global.html#getRelationshipUnitNeighbours">getRelationshipUnitNeighbours</a></li><li><a href="global.html#giveUp">giveUp</a></li><li><a href="global.html#grab">grab</a></li><li><a href="global.html#hasFreeUnitSlot">hasFreeUnitSlot</a></li><li><a href="global.html#heal">heal</a></li><li><a href="global.html#isLaser">isLaser</a></li><li><a href="global.html#isNeutral">isNeutral</a></li><li><a href="global.html#isPowerActive">isPowerActive</a></li><li><a href="global.html#isTargetValid">isTargetValid</a></li><li><a href="global.html#Lawnchair">Lawnchair</a></li><li><a href="global.html#mapAction">mapAction</a></li><li><a href="global.html#marshall">marshall</a></li><li><a href="global.html#multiStepAction">multiStepAction</a></li><li><a href="global.html#noAutoWait">noAutoWait</a></li><li><a href="global.html#noTeamsAreLeft">noTeamsAreLeft</a></li><li><a href="global.html#owner">owner</a></li><li><a href="global.html#pids">pids</a></li><li><a href="global.html#prepareMenu">prepareMenu</a></li><li><a href="global.html#prepareSelection">prepareSelection</a></li><li><a href="global.html#prepareTargets">prepareTargets</a></li><li><a href="global.html#property">property</a></li><li><a href="global.html#propertyAction">propertyAction</a></li><li><a href="global.html#raiseFunds">raiseFunds</a></li><li><a href="global.html#resetValue">resetValue</a></li><li><a href="global.html#set">set</a></li><li><a href="global.html#setValue">setValue</a></li><li><a href="global.html#takeDamage">takeDamage</a></li><li><a href="global.html#targetSelectionType">targetSelectionType</a></li><li><a href="global.html#unit">unit</a></li><li><a href="global.html#unitAction">unitAction</a></li><li><a href="global.html#visionClient">visionClient</a></li><li><a href="global.html#visionTurnOwner">visionTurnOwner</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha4</a> on Thu Feb 13 2014 21:07:27 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
